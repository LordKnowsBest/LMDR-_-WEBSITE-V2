<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Driver Portal — Service, Bridge &amp; LLM Map</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{display:flex;flex-direction:column;height:100vh;background:#0d1117;color:#e6edf3;font-family:system-ui,sans-serif;overflow:hidden}
    header{display:flex;align-items:center;gap:8px;padding:9px 14px;background:#161b22;border-bottom:1px solid #30363d;flex-shrink:0;flex-wrap:wrap}
    header h1{font-size:14px;font-weight:600;color:#f0f6fc}
    .badge{font-size:10px;padding:2px 8px;border-radius:10px;color:#fff}
    .hint{font-size:10px;color:#6e7681;margin-left:auto}
    .main{display:flex;flex:1;overflow:hidden}
    .sidebar{width:220px;flex-shrink:0;background:#161b22;border-right:1px solid #30363d;display:flex;flex-direction:column;overflow-y:auto;padding:10px}
    .sb-h{font-size:10px;text-transform:uppercase;color:#6e7681;letter-spacing:.06em;margin:10px 0 6px;padding-bottom:3px;border-bottom:1px solid #21262d}
    .sb-h:first-child{margin-top:0}
    .preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
    .preset-btn{padding:5px 4px;border-radius:5px;border:1px solid #30363d;background:#21262d;color:#c9d1d9;cursor:pointer;font-size:10px;text-align:center;transition:all .15s;line-height:1.3}
    .preset-btn:hover{background:#30363d;border-color:#60a5fa;color:#f0f6fc}
    .preset-btn.active{background:#0c1a2e;border-color:#2563eb;color:#60a5fa}
    .check-row{display:flex;align-items:center;gap:7px;padding:3px 0;cursor:pointer;user-select:none}
    .check-row input{accent-color:#2563eb;cursor:pointer;flex-shrink:0}
    .layer-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
    .conn-dash{width:18px;height:0;flex-shrink:0}
    .row-label{font-size:11px;color:#c9d1d9;line-height:1.3}
    .comment-card{background:#21262d;border:1px solid #30363d;border-radius:5px;padding:7px;margin-bottom:5px}
    .cc-title{font-size:10px;font-weight:700;color:#60a5fa;margin-bottom:2px;display:flex;justify-content:space-between;align-items:flex-start}
    .cc-del{background:none;border:none;color:#6e7681;cursor:pointer;font-size:14px;line-height:1;padding:0 1px;flex-shrink:0}
    .cc-del:hover{color:#f85149}
    .cc-text{font-size:10px;color:#8b949e;line-height:1.45}
    .no-cmt{font-size:10px;color:#484f58;font-style:italic}
    .canvas-area{flex:1;position:relative;overflow:hidden;background:#0d1117}
    .zoom-ctrl{position:absolute;top:8px;right:8px;z-index:10;display:flex;gap:3px}
    .zbtn{width:26px;height:26px;border-radius:5px;background:#21262d;border:1px solid #30363d;color:#c9d1d9;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
    .zbtn:hover{background:#30363d}
    svg#cvs{width:100%;height:100%;cursor:grab}
    svg#cvs.panning{cursor:grabbing}
    .legend{position:absolute;bottom:8px;left:8px;z-index:10;background:#161b22cc;border:1px solid #30363d;border-radius:6px;padding:7px 10px}
    .lg-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:9px;color:#8b949e}
    .lg-row:last-child{margin-bottom:0}
    .lg-line{width:18px;height:2px;border-radius:1px}
    .prompt-bar{background:#161b22;border-top:1px solid #30363d;padding:8px 14px;display:flex;align-items:flex-start;gap:10px;flex-shrink:0;max-height:100px}
    .prompt-txt{flex:1;font-size:11px;color:#8b949e;line-height:1.5;font-family:Consolas,monospace;overflow-y:auto;max-height:80px;white-space:pre-wrap}
    .copy-btn{padding:4px 12px;background:#21262d;border:1px solid #30363d;border-radius:5px;color:#c9d1d9;cursor:pointer;font-size:11px;white-space:nowrap;flex-shrink:0}
    .copy-btn:hover{background:#30363d}
    .copy-btn.done{color:#3fb950;border-color:#3fb950}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center}
    .overlay.hidden{display:none}
    .modal{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:18px;width:340px;max-width:90vw}
    .modal-title{font-size:13px;font-weight:600;color:#f0f6fc;margin-bottom:2px}
    .modal-sub{font-size:10px;color:#8b949e;margin-bottom:10px;font-family:Consolas,monospace}
    .modal-ta{width:100%;height:80px;background:#0d1117;border:1px solid #30363d;border-radius:5px;color:#e6edf3;padding:8px;font-size:11px;resize:none;outline:none;font-family:system-ui}
    .modal-ta:focus{border-color:#2563eb}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .modal-btns button{padding:4px 12px;border-radius:5px;cursor:pointer;font-size:11px}
    .m-cancel{background:#21262d;border:1px solid #30363d;color:#c9d1d9}
    .m-save{background:#2563eb;border:1px solid #2563eb;color:#fff}
    .tip{position:fixed;background:#1c2128;border:1px solid #30363d;border-radius:5px;padding:6px 9px;font-size:10px;color:#c9d1d9;pointer-events:none;z-index:100;max-width:215px;line-height:1.5}
    .tip.hidden{display:none}
  </style>
</head>
<body>

<header>
  <h1>Driver Portal — Service, Bridge &amp; LLM Map</h1>
  <span class="badge" style="background:#2563eb">51 nodes</span>
  <span class="badge" style="background:#7c3aed">agent orchestration</span>
  <span class="badge" style="background:#dc2626">action/payload + type/data</span>
  <span class="hint">Click any node to annotate · Scroll/drag to navigate</span>
</header>

<div class="main">
  <div class="sidebar">
    <div class="sb-h">Presets</div>
    <div class="preset-grid" id="preset-grid"></div>
    <div class="sb-h">Layers</div>
    <div id="layer-list"></div>
    <div class="sb-h">Connection Types</div>
    <div id="conn-list"></div>
    <div class="sb-h">Comments (<span id="cmt-count">0</span>)</div>
    <div id="cmt-list"></div>
  </div>

  <div class="canvas-area">
    <div class="zoom-ctrl">
      <button class="zbtn" id="z-in">+</button>
      <button class="zbtn" id="z-out">−</button>
      <button class="zbtn" id="z-reset">⊙</button>
    </div>
    <svg id="cvs"></svg>
    <div class="legend">
      <div class="lg-row"><div class="lg-line" style="border-top:2px dotted #6b7280;height:0;margin-top:1px"></div><span>CDN Load</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #10b981;height:0;margin-top:1px"></div><span>postMessage</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#3b82f6"></div><span>Service Call</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #e879f9;height:0;margin-top:1px"></div><span>LLM / AI Call</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#f472b6"></div><span>Data Access</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #f97316;height:0;margin-top:1px"></div><span>External API</span></div>
    </div>
  </div>
</div>

<div class="prompt-bar">
  <div class="prompt-txt" id="prompt-txt"></div>
  <button class="copy-btn" id="copy-btn">Copy Prompt</button>
</div>

<div class="overlay hidden" id="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="m-title"></div>
    <div class="modal-sub" id="m-sub"></div>
    <textarea class="modal-ta" id="m-ta" placeholder="Add feedback or notes about this component…"></textarea>
    <div class="modal-btns">
      <button class="m-cancel" id="m-cancel">Cancel</button>
      <button class="m-save" id="m-save">Save</button>
    </div>
  </div>
</div>

<div class="tip hidden" id="tip"></div>

<script>
function el(tag,attrs,...children){
  const e=document.createElement(tag);
  if(attrs){for(const[k,v] of Object.entries(attrs)){if(k==='class')e.className=v;else if(k==='style')e.style.cssText=v;else if(k==='text')e.textContent=v;else if(k==='for')e.setAttribute('for',v);else e.setAttribute(k,v);}}
  for(const c of children){if(typeof c==='string')e.appendChild(document.createTextNode(c));else if(c instanceof Node)e.appendChild(c);}
  return e;
}

// ═══════════════════════════════════════
// LAYERS
// ═══════════════════════════════════════
const LAYERS=[
  {id:'shell',  label:'HTML Pages',          dot:'#60a5fa',bg:'rgba(30,58,95,.22)'},
  {id:'cdn',    label:'CDN JS Modules',      dot:'#4ade80',bg:'rgba(20,50,30,.22)'},
  {id:'page',   label:'Wix Page Code',       dot:'#fbbf24',bg:'rgba(58,46,0,.28)'},
  {id:'svc',    label:'Backend Services',    dot:'#34d399',bg:'rgba(20,50,35,.22)'},
  {id:'llm',    label:'LLM / Agent Layer',   dot:'#e879f9',bg:'rgba(88,28,135,.25)'},
  {id:'data',   label:'Data Layer',          dot:'#f472b6',bg:'rgba(58,20,45,.22)'},
  {id:'ext',    label:'External APIs',       dot:'#f87171',bg:'rgba(50,20,20,.22)'},
];

const CTYPES=[
  {id:'load',    label:'CDN Load',     color:'#6b7280',dash:'4,3'},
  {id:'msg',     label:'postMessage',  color:'#10b981',dash:'6,3'},
  {id:'call',    label:'Service Call', color:'#3b82f6',dash:''},
  {id:'ai',      label:'LLM / AI',    color:'#e879f9',dash:'5,2'},
  {id:'data',    label:'Data Access',  color:'#f472b6',dash:''},
  {id:'ext',     label:'External API', color:'#f97316',dash:'8,3'},
];

// ═══════════════════════════════════════
// NODES
// ═══════════════════════════════════════
const NODES=[
  // ── HTML PAGES (y=25) ──────────────────────────────────────────
  {id:'html-match',  label:'AI_MATCHING.html',       sub:'~800 lines · main carrier-match SPA', layer:'shell',x:18, y:25,w:188,h:46,
   info:'Main driver SPA. Carrier cards, scoring breakdowns, application modal, match explanation, agent chat FAB + voice orb. Loads 7 CDN modules. Component: #html4.'},
  {id:'html-dash',   label:'DRIVER_DASHBOARD.html',  sub:'330 lines · application tracker',    layer:'shell',x:222,y:25,w:175,h:46,
   info:'Application history, profile strength meter, "Who Viewed Me" panel. Sends: dashboardReady, withdrawApplication, navigateToMyCareer. 19 inbound actions.'},
  {id:'html-career', label:'DRIVER_MY_CAREER.html',  sub:'120 lines · career timeline',        layer:'shell',x:413,y:25,w:162,h:46,
   info:'Career timeline visualization, resignation workflow modal, survey triggers. type/data protocol.'},
  {id:'html-docs',   label:'DRIVER_DOCUMENT_UPLOAD', sub:'document collection + OCR',          layer:'shell',x:591,y:25,w:180,h:46,
   info:'CDL upload, medical card, resume. Triggers OCR via ocrService (Gemini 2.5-pro). type/data protocol. 3 inbound: documentUploadReady, requestDocumentList, uploadDocument.'},
  {id:'html-road',   label:'DRIVER_ROAD_UTILITIES',  sub:'6 utilities · parking, fuel, roads', layer:'shell',x:787,y:25,w:178,h:46,
   info:'Truck parking finder, fuel prices (EIA), weigh station status, rest stops, weather alerts, road conditions. action/payload protocol. 17+ inbound actions.'},
  {id:'html-engage', label:'Engagement Pages',        sub:'Announcements · Policies · Surveys · Health', layer:'shell',x:981,y:25,w:183,h:46,
   info:'4 pages: DRIVER_ANNOUNCEMENTS.html, DRIVER_POLICIES.html, DRIVER_SURVEYS.html, HEALTH_WELLNESS.html, PET_FRIENDLY.html. Mixed protocols.'},
  {id:'html-game',   label:'Gamification Pages',      sub:'Badges · Challenges · Gamification', layer:'shell',x:1180,y:25,w:175,h:46,
   info:'DRIVER_GAMIFICATION.html (#gamificationHtml), DRIVER_BADGES.html, CHALLENGES.html. XP, streaks, leaderboard, badge unlock conditions.'},
  {id:'html-comm',   label:'Community Pages',         sub:'Forums · Mentor Program',            layer:'shell',x:1371,y:25,w:165,h:46,
   info:'DRIVER_FORUMS.html (threads, voting, moderation) + MENTOR_PROGRAM.html + MENTOR_PROFILE.html. Planned/in-progress pages.'},

  // ── CDN JS MODULES (y=138) ────────────────────────────────────
  {id:'mod-match',  label:'AI Matching Suite',  sub:'7 modules: bridge·helpers·renderers·results·accordion·modals·agent', layer:'cdn',x:18, y:138,w:188,h:46,
   info:'ai-matching-{bridge,helpers,renderers,results,accordion,modals,agent}.js. agent.js renders LMDR-branded floating chat FAB + sliding panel. Bridge sends: findMatches, applyToCarrier, saveCarrier, agentMessage, getMatchExplanation, getVoiceConfig.'},
  {id:'mod-dash',   label:'Dashboard Suite',    sub:'4 modules: config·bridge·render·logic',              layer:'cdn',x:222,y:138,w:175,h:46,
   info:'driver-dashboard-{config,bridge,render,logic}.js. Bridge handles: dashboardReady, withdrawApplication, updateAvailability, rateCarrier, getWhoViewedMe. 15+ registered actions.'},
  {id:'mod-career', label:'My Career Suite',    sub:'2 modules: bridge·logic',                            layer:'cdn',x:413,y:138,w:162,h:46,
   info:'driver-my-career-{bridge,logic}.js. Career timeline rendering, resignation form (collects reasons), survey triggers.'},
  {id:'mod-docs',   label:'Document Upload',    sub:'4 modules: config·bridge·render·logic',              layer:'cdn',x:591,y:138,w:180,h:46,
   info:'document-upload-{config,bridge,render,logic}.js. Drag-drop upload zone, progress bars, OCR trigger, document type validation. type/data protocol.'},
  {id:'mod-road',   label:'Road Utilities Suite',sub:'4 modules: config·bridge·render·logic',             layer:'cdn',x:787,y:138,w:178,h:46,
   info:'road-utilities-{config,bridge,render,logic}.js. Tab switching (6 utilities), map card rendering, favorites, search handlers. action/payload protocol.'},
  {id:'mod-engage', label:'Engagement Modules', sub:'surveys·announcements·policies·retention (8 files)', layer:'cdn',x:981,y:138,w:183,h:46,
   info:'surveys-{config,bridge,render,logic}.js + driver-announcements-{bridge,logic}.js + driver-policies-{bridge,logic}.js + retention-{bridge,logic}.js.'},
  {id:'mod-voice',  label:'Voice Agent UI',     sub:'voice-agent-ui.js · voice-agent-bridge.js (shared)', layer:'cdn',x:1180,y:138,w:175,h:46,
   info:'Shared module from src/public/js/. Floating voice orb + transcript panel, VAPI Web SDK integration. Used by AI_MATCHING and potentially other driver pages.'},

  // ── WIX PAGE CODE (y=255) ────────────────────────────────────
  {id:'page-match',  label:'AI - MATCHING.rof4w.js',        sub:'main SPA bridge · action/payload · 30+ actions',layer:'page',x:18, y:255,w:188,h:46,
   info:'Imports: carrierMatching, asyncSearchService, mutualInterestService, aiEnrichment, driverProfiles, applicationService, ocrService, matchExplanationService, featureAdoptionService, agentService, voiceService. 30+ inbound, 15+ outbound.'},
  {id:'page-dash',   label:'Driver Dashboard.ctupv.js',      sub:'auto-discover · 19 inbound actions',            layer:'page',x:222,y:255,w:175,h:46,
   info:'Auto-discovers #driverDashboardHtml, #html4, #html1-5. Imports: applicationService, driverProfiles, driverInsightsService, featureAdoptionService, gamificationPageHandlers. 11 outbound responses.'},
  {id:'page-career', label:'DRIVER_MY_CAREER.q178n.js',      sub:'lifecycle + resignation · type/data',           layer:'page',x:413,y:255,w:162,h:46,
   info:'Minimal bridge. Handles resignation submission, disposition updates. Calls driverLifecycleService.'},
  {id:'page-docs',   label:'DRIVER_DOCUMENT_UPLOAD.r5jyr.js',sub:'doc collection + OCR · type/data',             layer:'page',x:591,y:255,w:180,h:46,
   info:'Imports: onboardingWorkflowService, documentCollectionService. 3 inbound: documentUploadReady, requestDocumentList, uploadDocument. 4 outbound: initDocumentUpload, documentList, uploadResult.'},
  {id:'page-road',   label:'ROAD_UTILITIES.xzvqe.js',        sub:'#html4 · action/payload · 17+ actions',        layer:'page',x:787,y:255,w:178,h:46,
   info:'Imports: parkingService, fuelService, weighStationService, restStopService, weatherAlertService, roadConditionService, featureAdoptionService. 14+ outbound results.'},
  {id:'page-engage', label:'Engagement Page Code',           sub:'5 pages · mixed protocols',                    layer:'page',x:981,y:255,w:183,h:46,
   info:'DRIVER_ANNOUNCEMENTS.jgkc4.js, DRIVER_POLICIES.mbmmh.js, DRIVER_SURVEYS.iu06pk.js, HEALTH_WELLNESS.jho72.js, PET_FRIENDLY.s8s8a.js.'},
  {id:'page-game',   label:'Gamification Page Code',         sub:'DRIVER_GAMIFICATION + BADGES + CHALLENGES',    layer:'page',x:1180,y:255,w:175,h:46,
   info:'DRIVER_GAMIFICATION.ik6n7.js (#gamificationHtml), DRIVER_BADGES.jlfgc.js, CHALLENGES.upscp.js. Imports: gamificationService, leaderboardService.'},
  {id:'page-comm',   label:'Community Page Code',            sub:'DRIVER_FORUMS + MENTOR',                       layer:'page',x:1371,y:255,w:165,h:46,
   info:'DRIVER_FORUMS.vzg3s.js (threads, votes, moderation) + mentor page code. Planned/in-progress.'},

  // ── BACKEND SERVICES row 1 (y=372) ───────────────────────────
  {id:'svc-match',   label:'Carrier Matching',   sub:'carrierMatching · driverMatching · driverScoring',         layer:'svc',x:18, y:372,w:195,h:46,
   info:'findMatchingCarriers(), findMatchingDrivers(), detectMutualMatch(). driverScoring.js: calculateDriverMatchScore(), blendSemanticScore(), generateDriverMatchRationale(), applyFeedbackAdjustments(). Uses Pinecone vector search + Voyage AI embeddings.'},
  {id:'svc-profiles',label:'Driver Profiles',    sub:'driverProfiles · driverProfileService · driverInsights',   layer:'svc',x:228,y:372,w:195,h:46,
   info:'getOrCreateDriverProfile, updateDriverDocuments, setDiscoverability, logCarrierInterest, getCarrierInterestStats, getDriverProfileViews. getWhoViewedMe, getDriverStats, getProfileStrengthScore.'},
  {id:'svc-apps',    label:'Applications',       sub:'driverCockpitService · applicationService',                layer:'svc',x:438,y:372,w:180,h:46,
   info:'submitApplication, getApplicationStatus, withdrawApplication, getApplicationHistory, getSavedJobs, getDashboardSummary. Core driver job application lifecycle.'},
  {id:'svc-explain', label:'Match Explanation',  sub:'matchExplanationService → Groq LLM',                      layer:'svc',x:633,y:372,w:185,h:46,
   info:'getMatchExplanationForDriver(driverId, carrierDot). Calls Groq API DIRECTLY (not through aiRouter). Uses carrierEnrichments + driverProfile context to generate "Why You Matched" narrative.'},
  {id:'svc-outreach',label:'Driver Outreach',    sub:'driverOutreach · quota management',                       layer:'svc',x:833,y:372,w:175,h:46,
   info:'saveDriverToPipeline, sendMessageToDriver, getOutreachHistory, getQuotaStatus. Enforces recruiter daily outreach quotas (calls, messages, saves).'},
  {id:'svc-docs',    label:'Document Services',  sub:'documentCollectionService · ocrService',                  layer:'svc',x:1023,y:372,w:178,h:46,
   info:'requestDocuments, uploadDocument, getDocumentStatus. ocrService: extractDocumentData (Gemini 2.5-pro OCR — extracts DOT#, exp date, CDL class from uploaded images).'},
  {id:'svc-lifecycle',label:'Lifecycle & Scoring',sub:'driverLifecycleService · driverScorecardService · driverFinancialService',layer:'svc',x:1217,y:372,w:215,h:46,
   info:'getDriverTimeline, updateDisposition, submitMatchFeedback. getDriverScorecard, getFleetScoreboardSummary, getPerformanceRankings. logExpense, getExpenses, calculateTripCost.'},

  // ── BACKEND SERVICES row 2 (y=455) ───────────────────────────
  {id:'svc-road',    label:'Road Utilities',     sub:'parking · fuel · weigh stations · rest · weather · road conditions (6 services)', layer:'svc',x:18, y:455,w:250,h:46,
   info:'parkingService: searchParking, getParkingDetails, saveFavoriteParking. fuelService: searchFuelPrices (EIA DataLake), linkFuelCard. weighStationService: searchWeighStations, getStationStatus, reportStationStatus. weatherAlertService: getAlertsAtLocation, getRouteWeather.'},
  {id:'svc-engage',  label:'Engagement Services',sub:'gamification · leaderboard · survey · health · petFriendly · announcements', layer:'svc',x:285,y:455,w:255,h:46,
   info:'gamificationService: initializeProgression, awardXP, checkBadgeUnlocks. leaderboardService: getLeaderboard. surveyService: submitSurveyResponse. healthService: getResourcesByCategory, submitTip. petFriendlyService: searchLocations, submitReview.'},
  {id:'svc-enrich',  label:'AI Enrichment',      sub:'aiEnrichment · asyncSearchService · mutualInterestService', layer:'svc',x:555,y:455,w:210,h:46,
   info:'aiEnrichment: getEnrichedCarrierData (AI-synthesized carrier intelligence). asyncSearchService: non-blocking search with polling. mutualInterestService: detectMutualMatch — triggers when both driver + recruiter show interest.'},

  // ── LLM / AGENT LAYER (y=560) ────────────────────────────────
  {id:'llm-agent',   label:'agentService.jsw',   sub:'handleAgentTurn(role, userId, msg, ctx) · 5-turn loop',   layer:'llm',x:18, y:560,w:195,h:46,
   info:'Central orchestration. Builds driver-scoped tool definitions → calls Claude via aiRouter → executes tool_use blocks → loops up to 5 times → returns final text. Cost limits: 10K tokens/turn, 100 turns/day, 30s timeout.'},
  {id:'llm-conv',    label:'agentConversationService', sub:'createConversation · addTurn · getRecentContext',    layer:'llm',x:228,y:560,w:195,h:46,
   info:'Persists all agent sessions to Airtable (v2_Agent Conversations + v2_Agent Turns). getRecentContext() provides rolling memory for multi-turn conversations.'},
  {id:'llm-router',  label:'aiRouterService.jsw',sub:'routeAIRequest · cost optimizer · fallback queue',        layer:'llm',x:438,y:560,w:190,h:46,
   info:'FUNCTION_REGISTRY lookup → cost optimizer → provider selection → fallback queue. Logs every call to v2_AI Usage Log with tokens, latency, cost savings.'},
  {id:'llm-tools',   label:'Driver Tool Registry',sub:'6 tools: find_matches · get_carrier_details · explain_match · fmcsa · road · parking',layer:'llm',x:643,y:560,w:200,h:46,
   info:'find_matches (zip, maxDist, minCPM, opType → carrierMatching), get_carrier_details (dotNumber → aiEnrichment), explain_match (driverId+carrierDot → matchExplanation), get_fmcsa_data (dotNumber → FMCSA), road_conditions (lat/lon/zip → roadConditionService), find_parking (lat/lon/radius → parkingService). All READ/SUGGEST, no approval required.'},
  {id:'llm-voice',   label:'Voice Integration',  sub:'voiceService.jsw · VAPI Web SDK · voice-agent-bridge.js', layer:'llm',x:858,y:560,w:185,h:46,
   info:'voiceService: getVoiceConfig(), initiateOutboundCall(), getCallTranscript(). VAPI webhook at /api/vapi-webhook: end-of-call-report → voiceCallLogs, tool-calls → execute backend function. Driver speaks → VAPI → Claude → tool execution → response.'},
  {id:'llm-claude',  label:'Anthropic (Claude)', sub:'claude-sonnet-4 · PINNED for agent_orchestration',        layer:'llm',x:1058,y:560,w:190,h:46,
   info:'PINNED for agent_orchestration — requires tool_use contentBlocks format. claude-sonnet-4-20250514 (standard), claude-3-haiku (fast tier). Key: CLAUDE_API_KEY. Also handles admin_assistant, carrier_synthesis.'},
  {id:'llm-groq',    label:'Groq (LLaMA)',       sub:'match explanations · quick classification · driver chat',  layer:'llm',x:1263,y:560,w:185,h:46,
   info:'matchExplanationService calls Groq DIRECTLY (not through router). Groq compound/compound-mini for web_research, social_scanning. llama-3.1-8b-instant for quick_classification. Unlimited daily tokens. Key: GROQ_API_KEY.'},
  {id:'llm-gemini',  label:'Google (Gemini)',    sub:'gemini-2.5-pro · document OCR · image gen',               layer:'llm',x:1463,y:560,w:175,h:46,
   info:'ocrService uses gemini-2.5-pro for CDL/med-card OCR (extracts DOT#, expiry, CDL class). imagenService uses gemini-2.0-flash-preview-image-generation for social images. Key: GEMINI_API_KEY.'},

  // ── DATA LAYER (y=670) ────────────────────────────────────────
  {id:'data-access', label:'dataAccess.jsw',     sub:'dual-source router',                                      layer:'data',x:540, y:670,w:165,h:46,
   info:'Routes: usesAirtable()→Airtable REST, else→wixData. All driver collections→Airtable. suppressAuth:true for backend ops. Date fields: .toISOString().slice(0,10) — MANDATORY.'},
  {id:'db-airtable', label:'Airtable',           sub:'50+ driver v2_* tables · 200K+ match events',             layer:'data',x:810, y:670,w:188,h:46,
   info:'driverProfiles, driverApplications, driverCarrierInterests, carrierDriverViews (~200K+ rows), matchEvents (~500K), driverJobs, driverLifecycleEvents, matchFeedback, surveyResponses, driverExpenses, parkingLocations, weighStations, roadConditions, weatherAlerts, agentConversations, agentTurns, voiceCallLogs.'},
  {id:'db-wix',      label:'Wix Data',           sub:'AdminUsers · MemberNotifications only',                   layer:'data',x:1105,y:670,w:170,h:46,
   info:'Only 2 collections in Wix. All driver business data → Airtable.'},
  {id:'wix-media',   label:'Wix Media Manager',  sub:'CDL · med card · resume uploads',                         layer:'data',x:1285,y:670,w:168,h:46,
   info:'documentCollectionService uploads driver documents here. OCR triggered post-upload. Files stored in Wix Media, URLs saved to Airtable documentCollections.'},

  // ── EXTERNAL APIs (y=762) ─────────────────────────────────────
  {id:'ext-fmcsa',   label:'FMCSA API',          sub:'safety ratings · DOT lookup · violations',                layer:'ext',x:425, y:762,w:155,h:46,
   info:'get_fmcsa_data agent tool + svc-match carrier context + svc-road weigh station data. FMCSA_WEB_KEY. Used in agent tool execution loop.'},
  {id:'ext-vapi',    label:'VAPI Voice API',      sub:'REST + Web SDK · /api/vapi-webhook',                     layer:'ext',x:598, y:762,w:155,h:46,
   info:'Outbound voice calls, real-time VAPI Web SDK in browser. Webhook: end-of-call-report→voiceCallLogs, tool-calls→backend execution, assistant-request→dynamic config. VAPI_PRIVATE_KEY.'},
  {id:'ext-pinecone',label:'Pinecone Vector DB',  sub:'semantic carrier search · dot:{dotNumber} vectors',      layer:'ext',x:771, y:762,w:168,h:46,
   info:'Tier 1: ~600K FMCSA carriers as vectors (id=dot:{dotNumber}). Semantic search by driver preference embedding. Tier 2: Platform carriers (id=Airtable recXXX). Used by driverScoring.blendSemanticScore().'},
  {id:'ext-voyage',  label:'Voyage AI',           sub:'text-embedding · driver preference → vector',            layer:'ext',x:952, y:762,w:155,h:46,
   info:'Generates embeddings from driver preference text/profile data. Vectors queried against Pinecone for semantic carrier matching. VOYAGE_API_KEY. Replaces OpenAI embeddings for cost efficiency.'},
  {id:'ext-eia',     label:'EIA Fuel Prices',     sub:'diesel price feed · DataLake base',                      layer:'ext',x:1122,y:762,w:155,h:46,
   info:'EIA API (product EPD2D, duoarea NUS) → RAW_Diesel_Prices in DataLake (appt00rHHBOiKx9xl). Weekly sync job. Driver fuel service reads from DataLake, not EIA directly. EIA_API_KEY.'},
];

// ═══════════════════════════════════════
// CONNECTIONS
// ═══════════════════════════════════════
const CONNS=[
  // HTML → CDN modules
  {f:'html-match', t:'mod-match', tp:'load'},{f:'html-dash',   t:'mod-dash',   tp:'load'},
  {f:'html-career',t:'mod-career',tp:'load'},{f:'html-docs',   t:'mod-docs',   tp:'load'},
  {f:'html-road',  t:'mod-road',  tp:'load'},{f:'html-engage', t:'mod-engage', tp:'load'},
  {f:'html-match', t:'mod-voice', tp:'load'},

  // CDN → Page code (postMessage bridge)
  {f:'mod-match',  t:'page-match', tp:'msg'},{f:'mod-dash',   t:'page-dash',   tp:'msg'},
  {f:'mod-career', t:'page-career',tp:'msg'},{f:'mod-docs',   t:'page-docs',   tp:'msg'},
  {f:'mod-road',   t:'page-road',  tp:'msg'},{f:'mod-engage', t:'page-engage', tp:'msg'},
  {f:'mod-voice',  t:'page-match', tp:'msg'},

  // HTML → Page code (direct, no CDN module)
  {f:'html-game',t:'page-game',tp:'msg'},{f:'html-comm',t:'page-comm',tp:'msg'},

  // Page code → Backend services
  {f:'page-match', t:'svc-match',  tp:'call'},{f:'page-match',  t:'svc-profiles',tp:'call'},
  {f:'page-match', t:'svc-apps',   tp:'call'},{f:'page-match',  t:'svc-explain', tp:'call'},
  {f:'page-match', t:'svc-outreach',tp:'call'},{f:'page-match', t:'svc-enrich',  tp:'call'},
  {f:'page-dash',  t:'svc-apps',   tp:'call'},{f:'page-dash',   t:'svc-profiles',tp:'call'},
  {f:'page-career',t:'svc-lifecycle',tp:'call'},{f:'page-docs', t:'svc-docs',    tp:'call'},
  {f:'page-road',  t:'svc-road',   tp:'call'},{f:'page-engage', t:'svc-engage',  tp:'call'},
  {f:'page-game',  t:'svc-engage', tp:'call'},{f:'page-comm',   t:'svc-engage',  tp:'call'},

  // Page code → LLM layer (direct agent/voice calls)
  {f:'page-match',t:'llm-agent',tp:'ai'},{f:'page-match',t:'llm-voice',tp:'ai'},
  {f:'page-dash', t:'llm-agent',tp:'ai'},

  // Service → LLM (matchExplanation calls Groq directly)
  {f:'svc-explain',t:'llm-groq',  tp:'ai'},
  {f:'svc-docs',   t:'llm-gemini',tp:'ai'},

  // LLM agent internal wiring
  {f:'llm-agent',t:'llm-router',  tp:'ai'},{f:'llm-agent',t:'llm-conv',    tp:'ai'},
  {f:'llm-agent',t:'llm-tools',   tp:'ai'},{f:'llm-agent',t:'llm-claude',  tp:'ai'},
  {f:'llm-router',t:'llm-claude', tp:'ai'},{f:'llm-router',t:'llm-groq',   tp:'ai'},
  {f:'llm-router',t:'llm-gemini', tp:'ai'},
  {f:'llm-voice', t:'ext-vapi',   tp:'ext'},
  {f:'llm-tools', t:'svc-match',  tp:'call'},{f:'llm-tools',t:'svc-explain',tp:'call'},
  {f:'llm-tools', t:'svc-road',   tp:'call'},

  // Services → dataAccess
  {f:'svc-match',   t:'data-access',tp:'data'},{f:'svc-profiles',t:'data-access',tp:'data'},
  {f:'svc-apps',    t:'data-access',tp:'data'},{f:'svc-outreach', t:'data-access',tp:'data'},
  {f:'svc-docs',    t:'data-access',tp:'data'},{f:'svc-lifecycle', t:'data-access',tp:'data'},
  {f:'svc-road',    t:'data-access',tp:'data'},{f:'svc-engage',   t:'data-access',tp:'data'},
  {f:'svc-enrich',  t:'data-access',tp:'data'},
  {f:'llm-conv',    t:'data-access',tp:'data'},

  // dataAccess → stores
  {f:'data-access',t:'db-airtable',tp:'data'},{f:'data-access',t:'db-wix',tp:'data'},
  {f:'svc-docs',   t:'wix-media',  tp:'data'},

  // External APIs
  {f:'svc-match',  t:'ext-pinecone',tp:'ext'},{f:'svc-match',  t:'ext-voyage', tp:'ext'},
  {f:'llm-tools',  t:'ext-fmcsa',  tp:'ext'},{f:'svc-road',   t:'ext-fmcsa',  tp:'ext'},
  {f:'svc-road',   t:'ext-eia',    tp:'ext'},
];

// ═══════════════════════════════════════
// PRESETS
// ═══════════════════════════════════════
const PRESETS=[
  {id:'full',   label:'Full System',    layers:null,ctypes:null,hi:null},
  {id:'ai-flow',label:'AI Match Flow',  layers:['shell','cdn','page','svc','llm','data','ext'],ctypes:['load','msg','call','ai','data','ext'],
   hi:['html-match','mod-match','mod-voice','page-match','svc-match','svc-explain','svc-enrich','llm-agent','llm-tools','llm-router','llm-claude','llm-groq','llm-conv','data-access','db-airtable','ext-fmcsa','ext-pinecone','ext-voyage']},
  {id:'agent',  label:'Agent & Voice',  layers:['page','svc','llm','data','ext'],ctypes:['call','ai','data','ext'],
   hi:['page-match','page-dash','llm-agent','llm-conv','llm-router','llm-tools','llm-voice','llm-claude','llm-groq','llm-gemini','svc-match','svc-explain','svc-road','data-access','db-airtable','ext-vapi','ext-fmcsa']},
  {id:'road',   label:'Road Utilities', layers:['shell','cdn','page','svc','data','ext'],ctypes:['load','msg','call','data','ext'],
   hi:['html-road','mod-road','page-road','svc-road','data-access','db-airtable','ext-fmcsa','ext-eia']},
  {id:'dash',   label:'Dashboard & Docs',layers:['shell','cdn','page','svc','data'],ctypes:['load','msg','call','data'],
   hi:['html-dash','html-docs','html-career','mod-dash','mod-docs','mod-career','page-dash','page-docs','page-career','svc-apps','svc-profiles','svc-docs','svc-lifecycle','data-access','db-airtable','wix-media']},
];

// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
const state={
  layers:Object.fromEntries(LAYERS.map(l=>[l.id,true])),
  ctypes:Object.fromEntries(CTYPES.map(c=>[c.id,true])),
  comments:[],preset:'full',hi:null,
  tx:-12,ty:-12,scale:0.58,commentTarget:null,
};

// ═══════════════════════════════════════
// SVG HELPERS
// ═══════════════════════════════════════
const NS='http://www.w3.org/2000/svg';
const mkS=tag=>document.createElementNS(NS,tag);
function sA(e,a){for(const[k,v]of Object.entries(a))e.setAttribute(k,v);return e;}

// ═══════════════════════════════════════
// RENDER
// ═══════════════════════════════════════
const cvs=document.getElementById('cvs');
const CW=1700,CH=880;

function nById(id){return NODES.find(n=>n.id===id);}
function lById(id){return LAYERS.find(l=>l.id===id);}
function cById(id){return CTYPES.find(c=>c.id===id);}
function nVis(n){return !!state.layers[n.layer];}
function cVis(c){const fn=nById(c.f),tn=nById(c.t);return !!state.ctypes[c.tp]&&fn&&tn&&nVis(fn)&&nVis(tn);}
function edgePt(n,d){return d==='b'?{x:n.x+n.w/2,y:n.y+n.h}:{x:n.x+n.w/2,y:n.y};}

function renderDiagram(){
  cvs.textContent='';
  sA(cvs,{viewBox:`0 0 ${CW} ${CH}`});
  const root=mkS('g');
  sA(root,{transform:`translate(${state.tx},${state.ty}) scale(${state.scale})`});
  cvs.appendChild(root);

  // Arrowheads
  const defs=mkS('defs');
  CTYPES.forEach(ct=>{
    const m=mkS('marker');sA(m,{id:`ah-${ct.id}`,markerWidth:'7',markerHeight:'5',refX:'6',refY:'2.5',orient:'auto'});
    const p=mkS('polygon');sA(p,{points:'0 0,7 2.5,0 5',fill:ct.color});m.appendChild(p);defs.appendChild(m);
  });
  root.appendChild(defs);

  // Layer bands
  const bands={};
  NODES.forEach(n=>{if(!nVis(n))return;if(!bands[n.layer])bands[n.layer]={min:n.y,max:n.y+n.h};else{bands[n.layer].min=Math.min(bands[n.layer].min,n.y);bands[n.layer].max=Math.max(bands[n.layer].max,n.y+n.h);}});
  LAYERS.forEach(l=>{
    if(!state.layers[l.id]||!bands[l.id])return;
    const b=bands[l.id];
    const r=mkS('rect');sA(r,{x:'-10',y:String(b.min-12),width:String(CW+20),height:String(b.max-b.min+24),rx:'8',fill:l.bg});root.appendChild(r);
    const t=mkS('text');sA(t,{x:String(CW-14),y:String(b.min+4),fill:l.dot,'font-size':'9','text-anchor':'end',opacity:'0.55','font-family':'system-ui'});
    t.textContent=l.label.toUpperCase();root.appendChild(t);
  });

  // Connections
  CONNS.filter(cVis).forEach(c=>{
    const fn=nById(c.f),tn=nById(c.t);if(!fn||!tn)return;
    const ct=cById(c.tp);
    const down=fn.y+fn.h/2<tn.y+tn.h/2;
    const fp=down?edgePt(fn,'b'):edgePt(fn,'t'),tp=down?edgePt(tn,'t'):edgePt(tn,'b');
    const ctrl=Math.abs(tp.y-fp.y)*0.5;
    const d=`M${fp.x},${fp.y} C${fp.x},${fp.y+(down?ctrl:-ctrl)} ${tp.x},${tp.y+(down?-ctrl:ctrl)} ${tp.x},${tp.y}`;
    const faded=state.hi&&(!state.hi.includes(c.f)||!state.hi.includes(c.t));
    const path=mkS('path');
    sA(path,{d,fill:'none',stroke:ct.color,'stroke-width':'1.5',opacity:faded?'0.07':'0.45','marker-end':`url(#ah-${c.tp})`});
    if(ct.dash)sA(path,{'stroke-dasharray':ct.dash});
    root.appendChild(path);
  });

  // Nodes
  NODES.filter(nVis).forEach(n=>{
    const layer=lById(n.layer),comment=state.comments.find(c=>c.target===n.id);
    const faded=state.hi&&!state.hi.includes(n.id);
    const g=mkS('g');sA(g,{cursor:'pointer',opacity:faded?'0.08':'1'});
    const sh=mkS('rect');sA(sh,{x:String(n.x+3),y:String(n.y+3),width:String(n.w),height:String(n.h),rx:'7',fill:'rgba(0,0,0,0.5)'});g.appendChild(sh);
    const box=mkS('rect');sA(box,{x:String(n.x),y:String(n.y),width:String(n.w),height:String(n.h),rx:'7',fill:'#1c2128',stroke:comment?'#f59e0b':layer.dot,'stroke-width':comment?'2':'1'});g.appendChild(box);
    const lbl=mkS('text');sA(lbl,{x:String(n.x+n.w/2),y:String(n.y+18),'text-anchor':'middle',fill:layer.dot,'font-size':'10.5','font-weight':'600','font-family':'system-ui'});lbl.textContent=n.label;g.appendChild(lbl);
    const sub=mkS('text');sA(sub,{x:String(n.x+n.w/2),y:String(n.y+32),'text-anchor':'middle',fill:'#8b949e','font-size':'8','font-family':'system-ui'});sub.textContent=n.sub.length>38?n.sub.slice(0,37)+'…':n.sub;g.appendChild(sub);
    if(comment){const cd=mkS('circle');sA(cd,{cx:String(n.x+n.w-7),cy:String(n.y+7),r:'5',fill:'#f59e0b'});g.appendChild(cd);}
    g.addEventListener('click',ev=>{ev.stopPropagation();openModal(n);});
    g.addEventListener('mouseenter',ev=>showTip(ev,n));
    g.addEventListener('mouseleave',hideTip);
    root.appendChild(g);
  });
}

// Tooltip
const tipEl=document.getElementById('tip');
function showTip(e,n){tipEl.textContent=n.info||'';tipEl.classList.remove('hidden');mvTip(e);}
function hideTip(){tipEl.classList.add('hidden');}
function mvTip(e){tipEl.style.left=(e.clientX+14)+'px';tipEl.style.top=(e.clientY+12)+'px';}
cvs.addEventListener('mousemove',e=>{if(!tipEl.classList.contains('hidden'))mvTip(e);});

// Zoom / pan
function zoom(f){state.scale=Math.max(0.1,Math.min(3,state.scale*f));renderDiagram();}
function resetView(){state.tx=-12;state.ty=-12;state.scale=0.58;renderDiagram();}
document.getElementById('z-in').onclick=()=>zoom(1.18);
document.getElementById('z-out').onclick=()=>zoom(0.85);
document.getElementById('z-reset').onclick=()=>resetView();
let pan={on:false,sx:0,sy:0,ox:0,oy:0};
cvs.addEventListener('mousedown',e=>{if(e.target===cvs||e.target.nodeName==='svg'){pan={on:true,sx:e.clientX,sy:e.clientY,ox:state.tx,oy:state.ty};cvs.classList.add('panning');}});
window.addEventListener('mousemove',e=>{if(!pan.on)return;state.tx=pan.ox+(e.clientX-pan.sx);state.ty=pan.oy+(e.clientY-pan.sy);renderDiagram();});
window.addEventListener('mouseup',()=>{pan.on=false;cvs.classList.remove('panning');});
cvs.addEventListener('wheel',e=>{e.preventDefault();zoom(e.deltaY<0?1.1:0.9);},{passive:false});

// Modal
const overlay=document.getElementById('modal-overlay');
function openModal(n){state.commentTarget=n;document.getElementById('m-title').textContent=n.label;document.getElementById('m-sub').textContent=n.sub;const ex=state.comments.find(c=>c.target===n.id);document.getElementById('m-ta').value=ex?ex.text:'';overlay.classList.remove('hidden');setTimeout(()=>document.getElementById('m-ta').focus(),40);}
function closeModal(){overlay.classList.add('hidden');state.commentTarget=null;}
function saveComment(){const txt=document.getElementById('m-ta').value.trim(),n=state.commentTarget;if(txt){const idx=state.comments.findIndex(c=>c.target===n.id),entry={id:Date.now(),target:n.id,label:n.label,file:n.sub,text:txt};if(idx>=0)state.comments[idx]=entry;else state.comments.push(entry);}else{state.comments=state.comments.filter(c=>c.target!==n.id);}closeModal();updateAll();}
document.getElementById('m-cancel').onclick=closeModal;
document.getElementById('m-save').onclick=saveComment;
overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal();});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

// Sidebar
function buildSidebar(){
  const pg=document.getElementById('preset-grid');
  PRESETS.forEach(p=>{const b=el('button',{class:'preset-btn'+(state.preset===p.id?' active':''),'data-id':p.id,text:p.label});b.onclick=()=>applyPreset(p.id);pg.appendChild(b);});
  const ll=document.getElementById('layer-list');
  LAYERS.forEach(l=>{const chk=el('input',{type:'checkbox',id:'ly-'+l.id});chk.checked=true;const dot=el('div',{class:'layer-dot',style:'background:'+l.dot});const lbl=el('label',{class:'row-label','for':'ly-'+l.id},l.label);const row=el('div',{class:'check-row'},chk,dot,lbl);chk.onchange=ev=>{state.layers[l.id]=ev.target.checked;state.preset=null;state.hi=null;updateAll();};ll.appendChild(row);});
  const cl=document.getElementById('conn-list');
  CTYPES.forEach(c=>{const chk=el('input',{type:'checkbox',id:'ct-'+c.id});chk.checked=true;const ls=c.dash?`border-top:2px dashed ${c.color};height:0;margin-top:2px`:`background:${c.color}`;const line=el('div',{class:'conn-dash',style:ls});const lbl=el('label',{class:'row-label','for':'ct-'+c.id},c.label);const row=el('div',{class:'check-row'},chk,line,lbl);chk.onchange=ev=>{state.ctypes[c.id]=ev.target.checked;state.preset=null;updateAll();};cl.appendChild(row);});
}

function refreshSidebar(){
  document.querySelectorAll('.preset-btn').forEach(b=>{b.classList.toggle('active',b.dataset.id===state.preset);});
  LAYERS.forEach(l=>{const e=document.getElementById('ly-'+l.id);if(e)e.checked=!!state.layers[l.id];});
  CTYPES.forEach(c=>{const e=document.getElementById('ct-'+c.id);if(e)e.checked=!!state.ctypes[c.id];});
  document.getElementById('cmt-count').textContent=String(state.comments.length);
  const cl=document.getElementById('cmt-list');cl.textContent='';
  if(!state.comments.length){cl.appendChild(el('div',{class:'no-cmt'},'Click any node to annotate'));return;}
  state.comments.forEach(c=>{const delBtn=el('button',{class:'cc-del','data-id':String(c.id)},'×');delBtn.onclick=()=>{state.comments=state.comments.filter(x=>x.id!==c.id);updateAll();};const titleDiv=el('div',{class:'cc-title'});titleDiv.appendChild(document.createTextNode(c.label));titleDiv.appendChild(delBtn);const textDiv=el('div',{class:'cc-text'});textDiv.textContent=c.text;cl.appendChild(el('div',{class:'comment-card'},titleDiv,textDiv));});
}

function applyPreset(id){const p=PRESETS.find(x=>x.id===id);if(!p)return;state.preset=id;state.hi=p.hi||null;LAYERS.forEach(l=>{state.layers[l.id]=!p.layers||p.layers.includes(l.id);});CTYPES.forEach(c=>{state.ctypes[c.id]=!p.ctypes||p.ctypes.includes(c.id);});updateAll();}

// Prompt
function updatePrompt(){
  const el2=document.getElementById('prompt-txt');
  const vis=LAYERS.filter(l=>state.layers[l.id]).map(l=>l.label);
  const hid=LAYERS.filter(l=>!state.layers[l.id]);
  let t='Driver Portal architecture map';
  if(hid.length)t+=` — showing: ${vis.join(', ')}`;else t+=' — all 7 layers visible';
  t+='. 51 nodes: 8 HTML page groups (19 total files), 7 CDN module groups (31 total JS files), 8 Wix Page Code files (action/payload for AI Matching + Road Utilities; type/data for Document Upload), 11 Backend Service clusters, 8 LLM/Agent nodes (agentService orchestrator with 5-turn tool loop, agentConversationService persistence, aiRouter, Driver Tool Registry with 6 tools, Voice integration, Claude PINNED for orchestration, Groq for match explanations + speed, Gemini for OCR), 4 Data nodes, 5 External APIs (FMCSA, VAPI Voice, Pinecone vector DB, Voyage AI embeddings, EIA fuel prices).';
  if(state.comments.length){t+='\n\nAnnotations:\n';state.comments.forEach(c=>{t+=`\n**${c.label}** (${c.file}):\n${c.text}\n`;});}
  el2.textContent=t;
}

document.getElementById('copy-btn').onclick=()=>{navigator.clipboard.writeText(document.getElementById('prompt-txt').textContent).then(()=>{const b=document.getElementById('copy-btn');b.textContent='Copied!';b.classList.add('done');setTimeout(()=>{b.textContent='Copy Prompt';b.classList.remove('done');},1600);});};

function updateAll(){renderDiagram();refreshSidebar();updatePrompt();}
buildSidebar();
updateAll();
</script>
</body>
</html>
