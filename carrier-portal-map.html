<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Carrier Portal — Service &amp; Bridge Map</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{display:flex;flex-direction:column;height:100vh;background:#0d1117;color:#e6edf3;font-family:system-ui,sans-serif;overflow:hidden}
    header{display:flex;align-items:center;gap:10px;padding:9px 14px;background:#161b22;border-bottom:1px solid #30363d;flex-shrink:0}
    header h1{font-size:14px;font-weight:600;color:#f0f6fc}
    .badge{font-size:10px;padding:2px 8px;border-radius:10px;background:#059669;color:#fff}
    .badge2{font-size:10px;padding:2px 8px;border-radius:10px;background:#7c3aed;color:#fff}
    .hint{font-size:10px;color:#6e7681;margin-left:auto}
    .main{display:flex;flex:1;overflow:hidden}
    .sidebar{width:220px;flex-shrink:0;background:#161b22;border-right:1px solid #30363d;display:flex;flex-direction:column;overflow-y:auto;padding:10px}
    .sb-h{font-size:10px;text-transform:uppercase;color:#6e7681;letter-spacing:.06em;margin:10px 0 6px;padding-bottom:3px;border-bottom:1px solid #21262d}
    .sb-h:first-child{margin-top:0}
    .preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
    .preset-btn{padding:5px 4px;border-radius:5px;border:1px solid #30363d;background:#21262d;color:#c9d1d9;cursor:pointer;font-size:10px;text-align:center;transition:all .15s;line-height:1.3}
    .preset-btn:hover{background:#30363d;border-color:#34d399;color:#f0f6fc}
    .preset-btn.active{background:#052e16;border-color:#059669;color:#34d399}
    .check-row{display:flex;align-items:center;gap:7px;padding:3px 0;cursor:pointer;user-select:none}
    .check-row input{accent-color:#059669;cursor:pointer;flex-shrink:0}
    .layer-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
    .conn-dash{width:18px;height:0;flex-shrink:0}
    .row-label{font-size:11px;color:#c9d1d9;line-height:1.3}
    .comment-card{background:#21262d;border:1px solid #30363d;border-radius:5px;padding:7px;margin-bottom:5px}
    .cc-title{font-size:10px;font-weight:700;color:#34d399;margin-bottom:2px;display:flex;justify-content:space-between;align-items:flex-start}
    .cc-del{background:none;border:none;color:#6e7681;cursor:pointer;font-size:14px;line-height:1;padding:0 1px;flex-shrink:0}
    .cc-del:hover{color:#f85149}
    .cc-text{font-size:10px;color:#8b949e;line-height:1.45}
    .no-cmt{font-size:10px;color:#484f58;font-style:italic}
    .canvas-area{flex:1;position:relative;overflow:hidden;background:#0d1117}
    .zoom-ctrl{position:absolute;top:8px;right:8px;z-index:10;display:flex;gap:3px}
    .zbtn{width:26px;height:26px;border-radius:5px;background:#21262d;border:1px solid #30363d;color:#c9d1d9;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
    .zbtn:hover{background:#30363d}
    svg#cvs{width:100%;height:100%;cursor:grab}
    svg#cvs.panning{cursor:grabbing}
    .legend{position:absolute;bottom:8px;left:8px;z-index:10;background:#161b22cc;border:1px solid #30363d;border-radius:6px;padding:7px 10px}
    .lg-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:9px;color:#8b949e}
    .lg-row:last-child{margin-bottom:0}
    .lg-line{width:18px;height:2px;border-radius:1px}
    .prompt-bar{background:#161b22;border-top:1px solid #30363d;padding:8px 14px;display:flex;align-items:flex-start;gap:10px;flex-shrink:0;max-height:100px}
    .prompt-txt{flex:1;font-size:11px;color:#8b949e;line-height:1.5;font-family:Consolas,monospace;overflow-y:auto;max-height:80px;white-space:pre-wrap}
    .copy-btn{padding:4px 12px;background:#21262d;border:1px solid #30363d;border-radius:5px;color:#c9d1d9;cursor:pointer;font-size:11px;white-space:nowrap;flex-shrink:0}
    .copy-btn:hover{background:#30363d}
    .copy-btn.done{color:#3fb950;border-color:#3fb950}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center}
    .overlay.hidden{display:none}
    .modal{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:18px;width:340px;max-width:90vw}
    .modal-title{font-size:13px;font-weight:600;color:#f0f6fc;margin-bottom:2px}
    .modal-sub{font-size:10px;color:#8b949e;margin-bottom:10px;font-family:Consolas,monospace}
    .modal-ta{width:100%;height:80px;background:#0d1117;border:1px solid #30363d;border-radius:5px;color:#e6edf3;padding:8px;font-size:11px;resize:none;outline:none;font-family:system-ui}
    .modal-ta:focus{border-color:#059669}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .modal-btns button{padding:4px 12px;border-radius:5px;cursor:pointer;font-size:11px}
    .m-cancel{background:#21262d;border:1px solid #30363d;color:#c9d1d9}
    .m-save{background:#059669;border:1px solid #059669;color:#fff}
    .tip{position:fixed;background:#1c2128;border:1px solid #30363d;border-radius:5px;padding:6px 9px;font-size:10px;color:#c9d1d9;pointer-events:none;z-index:100;max-width:210px;line-height:1.5}
    .tip.hidden{display:none}
  </style>
</head>
<body>

<header>
  <h1>Carrier Portal — Service &amp; Bridge Map</h1>
  <span class="badge">40 nodes</span>
  <span class="badge2">type/data protocol</span>
  <span class="hint">Click any node to annotate · Scroll/drag to navigate</span>
</header>

<div class="main">
  <div class="sidebar">
    <div class="sb-h">Presets</div>
    <div class="preset-grid" id="preset-grid"></div>
    <div class="sb-h">Layers</div>
    <div id="layer-list"></div>
    <div class="sb-h">Connection Types</div>
    <div id="conn-list"></div>
    <div class="sb-h">Comments (<span id="cmt-count">0</span>)</div>
    <div id="cmt-list"></div>
  </div>

  <div class="canvas-area">
    <div class="zoom-ctrl">
      <button class="zbtn" id="z-in">+</button>
      <button class="zbtn" id="z-out">−</button>
      <button class="zbtn" id="z-reset">⊙</button>
    </div>
    <svg id="cvs"></svg>
    <div class="legend">
      <div class="lg-row"><div class="lg-line" style="border-top:2px dotted #6b7280;height:0;margin-top:1px"></div><span>CDN Load</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #10b981;height:0;margin-top:1px"></div><span>postMessage (type/data)</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#3b82f6"></div><span>Service Call</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#f472b6"></div><span>Data Access</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #f97316;height:0;margin-top:1px"></div><span>External API</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#a78bfa"></div><span>Media / Storage</span></div>
    </div>
  </div>
</div>

<div class="prompt-bar">
  <div class="prompt-txt" id="prompt-txt"></div>
  <button class="copy-btn" id="copy-btn">Copy Prompt</button>
</div>

<div class="overlay hidden" id="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="m-title"></div>
    <div class="modal-sub" id="m-sub"></div>
    <textarea class="modal-ta" id="m-ta" placeholder="Add feedback or notes about this component…"></textarea>
    <div class="modal-btns">
      <button class="m-cancel" id="m-cancel">Cancel</button>
      <button class="m-save" id="m-save">Save</button>
    </div>
  </div>
</div>

<div class="tip hidden" id="tip"></div>

<script>
// Safe DOM builder — no innerHTML used for dynamic content
function el(tag, attrs, ...children) {
  const e = document.createElement(tag);
  if (attrs) {
    for (const [k, v] of Object.entries(attrs)) {
      if (k === 'class') { e.className = v; }
      else if (k === 'style') { e.style.cssText = v; }
      else if (k === 'text') { e.textContent = v; }
      else if (k === 'for') { e.setAttribute('for', v); }
      else { e.setAttribute(k, v); }
    }
  }
  for (const c of children) {
    if (typeof c === 'string') { e.appendChild(document.createTextNode(c)); }
    else if (c instanceof Node) { e.appendChild(c); }
  }
  return e;
}

// ═══════════════════════════════════════
// LAYER & CONN-TYPE DEFINITIONS
// ═══════════════════════════════════════
const LAYERS = [
  { id:'shell',    label:'HTML Pages',        dot:'#60a5fa', bg:'rgba(30,58,95,.22)' },
  { id:'cdn',      label:'CDN JS Modules',    dot:'#4ade80', bg:'rgba(20,50,30,.22)' },
  { id:'page',     label:'Wix Page Code',     dot:'#fbbf24', bg:'rgba(58,46,0,.28)' },
  { id:'services', label:'Backend Services',  dot:'#34d399', bg:'rgba(20,50,35,.22)' },
  { id:'agents',   label:'Agent Services',    dot:'#a78bfa', bg:'rgba(45,30,95,.22)' },
  { id:'data',     label:'Data Layer',        dot:'#f472b6', bg:'rgba(58,20,45,.22)' },
  { id:'external', label:'External APIs',     dot:'#f87171', bg:'rgba(50,20,20,.22)' },
];

const CTYPES = [
  { id:'load',     label:'CDN Load',          color:'#6b7280', dash:'4,3' },
  { id:'message',  label:'postMessage',       color:'#10b981', dash:'6,3' },
  { id:'call',     label:'Service Call',      color:'#3b82f6', dash:'' },
  { id:'data',     label:'Data Access',       color:'#f472b6', dash:'' },
  { id:'media',    label:'Media / Storage',   color:'#a78bfa', dash:'3,2' },
  { id:'external', label:'External API',      color:'#f97316', dash:'8,3' },
];

// ═══════════════════════════════════════
// NODE DEFINITIONS
// ═══════════════════════════════════════
const NODES = [
  // ── HTML PAGES (y=28) ─────────────────────────────────────────────
  { id:'html-ann',    label:'CARRIER_ANNOUNCEMENTS', sub:'919 lines · announcements dashboard', layer:'shell', x:20,  y:28, w:180,h:46,
    info:'Dashboard for creating, scheduling, publishing announcements. Comment moderation, read receipts, attachment uploads, reminder sending.' },
  { id:'html-pol',    label:'CARRIER_POLICIES',      sub:'463 lines · policy repository',       layer:'shell', x:215, y:28, w:165,h:46,
    info:'Policy CRUD, version publishing, driver acknowledgment tracking, compliance status reporting.' },
  { id:'html-wel',    label:'Carrier_Welcome',        sub:'729 lines · onboarding welcome',      layer:'shell', x:395, y:28, w:160,h:46,
    info:'Onboarding flow, setup checklist, quick wins. Multi-step navigation: profile → branding → jobs → payment → intake → preferences.' },
  { id:'html-csa',    label:'CARRIER_CSA_MONITOR',    sub:'524 lines · CSA scores + alerts',     layer:'shell', x:570, y:28, w:170,h:46,
    info:'FMCSA safety scores, violation alerts, inspection history. Routes through complianceBridge.jsw.' },
  { id:'html-dq',     label:'CARRIER_DQ_TRACKER',     sub:'522 lines · driver qualification',    layer:'shell', x:755, y:28, w:165,h:46,
    info:'Driver Qualification file tracking: CDL, med card, MVR, drug test gaps. Routes through complianceBridge.jsw.' },
  { id:'html-inc',    label:'CARRIER_INCIDENT',        sub:'578 lines · incident reporting',      layer:'shell', x:935, y:28, w:165,h:46,
    info:'Safety incident logging: accident reports, near-misses, injury tracking. Routes through complianceBridge.jsw.' },
  { id:'html-vault',  label:'CARRIER_DOCUMENT_VAULT',  sub:'608 lines · document management',    layer:'shell', x:1115,y:28, w:185,h:46,
    info:'Document upload/versioning/expiration tracking. Supports DOT-required docs. Uploads via Wix Media Manager.' },
  { id:'html-cal',    label:'CARRIER_COMPLIANCE_CAL',  sub:'204 lines · compliance calendar',    layer:'shell', x:1315,y:28, w:185,h:46,
    info:'Compliance deadlines, recurring events, driver assignment. Processes reminders via scheduled job.' },
  { id:'html-wt',     label:'CARRIER_WEIGHT_PREFS',    sub:'846 lines · hiring weight sliders',  layer:'shell', x:1515,y:28, w:175,h:46,
    info:'Weight preference UI: sliders for experience, endorsements, location, pay. Named presets (OTR, Regional, Local).' },
  { id:'html-misc',   label:'Standalone Pages',         sub:'Trucking Co · Equipment · Fleet · Roster', layer:'shell', x:1705,y:28, w:175,h:46,
    info:'No Velo bridge: Trucking Companies intake form, Equipment Manager, Fleet Dashboard, Driver Roster, Fleet Map, Capacity Planner, Retention coaching, Status Tracker.' },

  // ── CDN JS MODULES (y=140) ────────────────────────────────────────
  { id:'mod-ann',   label:'Announcements Module',  sub:'bridge · config · logic · render (4 files)', layer:'cdn', x:20,  y:140, w:180,h:46,
    info:'carrier-announcements-{bridge,config,logic,render}.js. Bridge sends: getCarrierAnnouncements, createAnnouncement, publishAnnouncement, uploadAttachment, setCommentVisibility, sendAnnouncementReminder.' },
  { id:'mod-pol',   label:'Policies Module',        sub:'bridge · logic (2 files)',                  layer:'cdn', x:215, y:140, w:165,h:46,
    info:'carrier-policies-{bridge,logic}.js. Sends: getCarrierPolicies, createPolicy, publishPolicyVersion, uploadPolicyFile, getComplianceStatus.' },
  { id:'mod-cal',   label:'Compliance Cal Module',  sub:'bridge · logic (2 files)',                  layer:'cdn', x:1315,y:140, w:185,h:46,
    info:'carrier-compliance-calendar-{bridge,logic}.js. Sends: getComplianceData, createComplianceEvent, navigateTo.' },
  { id:'mod-misc',  label:'Trucking Companies Mod', sub:'bridge · config · logic · render (4 files)', layer:'cdn', x:1705,y:140, w:175,h:46,
    info:'trucking-companies-{bridge,config,logic,render}.js. Multi-step intake form for carrier leads. Sends: submitCarrierStaffingRequest.' },

  // ── WIX PAGE CODE (y=258) ────────────────────────────────────────
  { id:'page-ann',   label:'CARRIER_ANNOUNCEMENTS', sub:'.zmhem.js · type/data protocol',  layer:'page', x:20,  y:258, w:180,h:46,
    info:'Auto-discovers #html1–#html5, #htmlEmbed1. 12 inbound actions: carrierAnnouncementsReady, getCarrierAnnouncements, createAnnouncement, publishAnnouncement, scheduleAnnouncement, archiveAnnouncement, previewRecipients, uploadAnnouncementAttachment, sendAnnouncementReminder, getAnnouncementDetail, setAnnouncementCommentVisibility.' },
  { id:'page-pol',   label:'CARRIER_POLICIES',       sub:'.m76is.js · type/data protocol', layer:'page', x:215, y:258, w:165,h:46,
    info:'8 inbound: carrierPoliciesReady, getCarrierPolicies, createPolicy, updatePolicy, publishPolicyVersion, archivePolicy, uploadPolicyFile, getComplianceStatus.' },
  { id:'page-wel',   label:'CARRIER_WELCOME',         sub:'.gnhma.js · broadcast pattern', layer:'page', x:395, y:258, w:160,h:46,
    info:'Broadcasts to all components (#html1-5, #htmlEmbed1). Inbound: navigateToIntake, navigateToPreferences, getCarrierWelcomeData, navigateOnboarding. Outbound: carrierWelcomeData { plan, dotNumber, memberName, companyName, city, state, fleetSize }.' },
  { id:'page-csa',   label:'CARRIER_CSA_MONITOR',     sub:'.bov8u.js · complianceBridge',  layer:'page', x:570, y:258, w:160,h:46,
    info:'Routes all messages via complianceBridge.handleComplianceMessage(). Sends initial carrierContext { carrierDot, companyName } on ready. Also calls recruiter_service for carrier identity.' },
  { id:'page-dq',    label:'DQ Tracker + Incident',   sub:'.sb2ig.js + .dfobc.js',         layer:'page', x:745, y:258, w:160,h:46,
    info:'Both pages route through complianceBridge.jsw. complianceBridge.getCompliancePageData() serves DQ gaps, qualification files. Incident page logs safety events.' },
  { id:'page-vault', label:'CARRIER_DOCUMENT_VAULT',  sub:'.yl5oe.js · type/data',          layer:'page', x:1115,y:258, w:165,h:46,
    info:'Inbound: vaultReady, getDocuments, uploadDocument, navigateTo. Outbound: setDocuments { data: docs[] }, init. Uses documentVaultService for version control + expiration.' },
  { id:'page-cal',   label:'CARRIER_COMPLIANCE_CAL',  sub:'.ww0h3.js · type/data',          layer:'page', x:1315,y:258, w:175,h:46,
    info:'Inbound: calendarReady, getComplianceData, createComplianceEvent, navigateTo. Outbound: setComplianceData { events[] }, eventCreated, init.' },
  { id:'page-wt',    label:'CARRIER_WEIGHT_PREFS',    sub:'.kvkff.js · type/data',           layer:'page', x:1505,y:258, w:175,h:46,
    info:'Inbound: weightPreferencesReady, saveWeightPreferences, applyPreset. Outbound: loadPreferences, loadPresets { data: presets[] }, savePreferencesResult, init.' },
  { id:'page-car',   label:'CARRIERS (B2B page)',      sub:'.o5c9o.js · lead capture + pricing', layer:'page', x:1705,y:258, w:175,h:46,
    info:'Pricing page with ROI calculator. Repeater + HTML components. Uses contentService, publicStatsService, carrierLeadsService, subscriptionService.' },

  // ── BACKEND SERVICES (y=375) ─────────────────────────────────────
  { id:'svc-ann',    label:'carrierAnnouncementsService', sub:'20 methods · announcements + engagement', layer:'services', x:20,  y:375, w:210,h:46,
    info:'createAnnouncement, publishAnnouncement, scheduleAnnouncement, archiveAnnouncement, markAnnouncementRead, getAnnouncementStats, getReadReceipts, getUnreadDrivers, addComment, setCommentVisibility, sendReminderToUnreadDrivers, uploadAttachment, processAnnouncementDigests.' },
  { id:'svc-pol',    label:'carrierPolicyService',         sub:'11 methods · policies + acknowledgments', layer:'services', x:245, y:375, w:200,h:46,
    info:'createPolicy, getPolicies, getPolicy, updatePolicy, acknowledgePolicy, getPoliciesForDriver, getComplianceStatus, getPolicyAcknowledgments, getDriverPolicyStatus, exportComplianceReport, sendReminders.' },
  { id:'svc-status', label:'carrierStatusService',         sub:'getCarrierOnboardingStatus · getMatchCount', layer:'services', x:460, y:375, w:195,h:46,
    info:'getCarrierOnboardingStatus() — returns checklist completion (profile, branding, jobs, payment, preferences). getMatchCount() — active driver matches.' },
  { id:'svc-comp',   label:'complianceBridge',             sub:'unified bridge · CSA + DQ + Incident', layer:'services', x:670, y:375, w:195,h:46,
    info:'SPECIAL: Unified backend bridge serving 3 pages (CSA Monitor, DQ Tracker, Incident Reporting). getCompliancePageData(), handleComplianceMessage(). Calls FMCSA API for live safety data.' },
  { id:'svc-vault',  label:'documentVaultService',         sub:'11 methods · upload + versioning + expiry', layer:'services', x:880, y:375, w:200,h:46,
    info:'uploadDocument, getDocuments, uploadNewVersion, getDocumentVersionHistory, archiveDocument, getExpiringDocuments, getExpiredDocuments, verifyDocument, updateDocumentExpirations.' },
  { id:'svc-cal',    label:'complianceCalendarService',    sub:'9 methods · events + reminders',        layer:'services', x:1095,y:375, w:200,h:46,
    info:'getComplianceEvents, createComplianceEvent, updateComplianceEvent, completeComplianceEvent, deleteComplianceEvent, getCalendarView, getComplianceDashboard, processComplianceReminders, getDriverComplianceItems.' },
  { id:'svc-prefs',  label:'carrierPreferences',           sub:'9 methods · hiring weights + presets',  layer:'services', x:1310,y:375, w:195,h:46,
    info:'getCarrierPreferences, saveCarrierPreferences, applyPreset, getPresetTemplates, validatePreferencesData, createHiringPreferences, updateHiringPreferences, getWeightPreferences.' },
  { id:'svc-leads',  label:'carrierLeadsService',          sub:'8 methods · intake + staffing requests', layer:'services', x:1520,y:375, w:192,h:46,
    info:'submitCarrierStaffingRequest, getLeadStatus, getCarrierLeads, submitCarrierIntakePreferences, updateLeadStatus, ensureCarrierRecord, getMatchPreview, getLeadDetails.' },
  { id:'svc-jrn',    label:'carrierJourneyService',        sub:'8 methods · onboarding + payments',     layer:'services', x:1727,y:375, w:190,h:46,
    info:'getOnboardingFlow, updateCarrierIdentity, getCarrierNavigation, initiateDeposit, getPaymentHistory, getSubscriptionStatus, upgradeCarrierPlan, getCheckoutSession.' },
  { id:'svc-rec',    label:'recruiter_service',            sub:'shared · carrier identity + DOT lookup', layer:'services', x:1932,y:375, w:185,h:46,
    info:'SHARED across surfaces. validateCarrierDOT, getCarrierByDOT, getCarrierIdentity, getOrCreateRecruiterProfile used by CSA Monitor and Welcome pages.' },

  // ── AGENT SERVICES (y=458) ────────────────────────────────────────
  { id:'agt-comms',  label:'carrierCommunicationAgent', sub:'createAnnouncement · createPolicyUpdate · createRecognition', layer:'agents', x:20,  y:458, w:220,h:46,
    info:'Agent tool wrapper for communication actions. createAnnouncement, getAnnouncements, createPolicyUpdate, getPolicies, createRecognition, getRecognitions, createFeedbackRequest, getFeedbackResponses.' },
  { id:'agt-comp',   label:'carrierComplianceAgent',   sub:'CSA · DQ · Incidents · Audit Readiness',                     layer:'agents', x:255, y:458, w:200,h:46,
    info:'Agent tool wrapper for compliance. getCSAScores, getCSAAlerts, getDQTracker, getDQGaps, uploadCarrierDocument, logIncident, getIncidentHistory, getAuditReadiness.' },
  { id:'agt-fleet',  label:'carrierFleetAgent',         sub:'Roster · Scorecard · Equipment · ELD',                       layer:'agents', x:470, y:458, w:195,h:46,
    info:'Agent tool wrapper for fleet ops. getFleetRoster, getDriverScorecard, getEquipmentList, getEquipmentStatus, getFleetCapacity, getELDFleetSummary, assignDriverToUnit, getFleetCosts.' },
  { id:'svc-coach',  label:'carrierCoachingService',    sub:'retention clusters · coaching insights · at-risk drivers',   layer:'agents', x:680, y:458, w:195,h:46,
    info:'getRetentionCluster, getCoachingInsights, getRetentionRiskDrivers, getCarrierRetentionReport. Uses driver scoring + market signals.' },

  // ── DATA LAYER (y=555) ────────────────────────────────────────────
  { id:'data-access',label:'dataAccess.jsw',  sub:'dual-source router',                       layer:'data', x:680, y:555, w:165,h:46,
    info:'Routes: usesAirtable()→Airtable REST, else→wixData. All 12+ carrier collections route to Airtable. suppressAuth:true for backend operations.' },
  { id:'db-airtable',label:'Airtable',         sub:'12+ carrier v2_* tables',                 layer:'data', x:940, y:555, w:175,h:46,
    info:'v2_Carrier Announcements, v2_Announcement Read Receipts, v2_Announcement Comments, v2_Carrier Policies, v2_Policy Acknowledgments, v2_Carrier Documents, v2_Document Versions, v2_Carrier Compliance Events, v2_Carrier Hiring Preferences, v2_Driver Weight Preferences, v2_Carrier Notification Settings, v2_Driver Notification Preferences.' },
  { id:'db-wix',     label:'Wix Data',         sub:'AdminUsers · MemberNotifications only',   layer:'data', x:1190,y:555, w:170,h:46,
    info:'Only 2 collections remain in Wix: AdminUsers (auth/permissions), MemberNotifications (Wix member system). Carrier data → Airtable.' },
  { id:'wix-media',  label:'Wix Media Manager', sub:'document + attachment uploads',           layer:'data', x:1440,y:555, w:175,h:46,
    info:'Used by carrierAnnouncementsService (uploadAttachment) and documentVaultService (uploadDocument). Files stored in Wix Media. URLs saved to Airtable.' },

  // ── EXTERNAL APIs (y=650) ─────────────────────────────────────────
  { id:'ext-fmcsa',  label:'FMCSA API',         sub:'CSA scores · DOT lookup · safety data',  layer:'external', x:600, y:650, w:175,h:46,
    info:'Called by complianceBridge.jsw for live CSA score data, violation history, inspection counts. FMCSA_WEB_KEY env var. Also used by admin enrichment pipeline.' },
];

// ═══════════════════════════════════════
// CONNECTIONS
// ═══════════════════════════════════════
const CONNS = [
  // HTML → CDN modules (load)
  {f:'html-ann',  t:'mod-ann',  tp:'load'},{f:'html-pol', t:'mod-pol',  tp:'load'},
  {f:'html-cal',  t:'mod-cal',  tp:'load'},{f:'html-misc',t:'mod-misc', tp:'load'},

  // CDN modules → Page Code (postMessage bridge)
  {f:'mod-ann',  t:'page-ann', tp:'message'},{f:'mod-pol', t:'page-pol', tp:'message'},
  {f:'mod-cal',  t:'page-cal', tp:'message'},{f:'mod-misc',t:'page-car', tp:'message'},

  // HTML → Page Code (direct, no CDN module)
  {f:'html-wel', t:'page-wel', tp:'message'},
  {f:'html-csa', t:'page-csa', tp:'message'},
  {f:'html-dq',  t:'page-dq',  tp:'message'},
  {f:'html-inc', t:'page-dq',  tp:'message'},
  {f:'html-vault',t:'page-vault',tp:'message'},
  {f:'html-wt',  t:'page-wt',  tp:'message'},

  // Page Code → Backend Services
  {f:'page-ann',  t:'svc-ann',  tp:'call'},
  {f:'page-pol',  t:'svc-pol',  tp:'call'},
  {f:'page-pol',  t:'svc-ann',  tp:'call'},
  {f:'page-wel',  t:'svc-status',tp:'call'},
  {f:'page-wel',  t:'svc-rec',  tp:'call'},
  {f:'page-wel',  t:'svc-jrn',  tp:'call'},
  {f:'page-csa',  t:'svc-comp', tp:'call'},
  {f:'page-csa',  t:'svc-rec',  tp:'call'},
  {f:'page-dq',   t:'svc-comp', tp:'call'},
  {f:'page-vault',t:'svc-vault',tp:'call'},
  {f:'page-cal',  t:'svc-cal',  tp:'call'},
  {f:'page-wt',   t:'svc-prefs',tp:'call'},
  {f:'page-car',  t:'svc-leads',tp:'call'},
  {f:'page-car',  t:'svc-jrn',  tp:'call'},

  // Services → dataAccess
  {f:'svc-ann',  t:'data-access',tp:'data'},{f:'svc-pol',  t:'data-access',tp:'data'},
  {f:'svc-status',t:'data-access',tp:'data'},{f:'svc-comp', t:'data-access',tp:'data'},
  {f:'svc-vault',t:'data-access',tp:'data'},{f:'svc-cal',  t:'data-access',tp:'data'},
  {f:'svc-prefs',t:'data-access',tp:'data'},{f:'svc-leads',t:'data-access',tp:'data'},
  {f:'svc-jrn',  t:'data-access',tp:'data'},{f:'svc-rec',  t:'data-access',tp:'data'},
  {f:'svc-coach',t:'data-access',tp:'data'},

  // Agent services → dataAccess
  {f:'agt-comms',t:'data-access',tp:'data'},{f:'agt-comp',t:'data-access',tp:'data'},
  {f:'agt-fleet',t:'data-access',tp:'data'},

  // dataAccess → stores
  {f:'data-access',t:'db-airtable',tp:'data'},{f:'data-access',t:'db-wix',tp:'data'},

  // Media uploads
  {f:'svc-ann',  t:'wix-media',tp:'media'},
  {f:'svc-vault',t:'wix-media',tp:'media'},

  // External
  {f:'svc-comp',t:'ext-fmcsa',tp:'external'},
];

// ═══════════════════════════════════════
// PRESETS
// ═══════════════════════════════════════
const PRESETS = [
  { id:'full',       label:'Full System',      layers:null, ctypes:null, hi:null },
  { id:'ann-flow',   label:'Announcements',    layers:['shell','cdn','page','services','data'], ctypes:['load','message','call','data','media'],
    hi:['html-ann','mod-ann','page-ann','svc-ann','data-access','db-airtable','wix-media'] },
  { id:'compliance', label:'Compliance Suite', layers:['shell','page','services','data','external'], ctypes:['message','call','data','external'],
    hi:['html-csa','html-dq','html-inc','page-csa','page-dq','svc-comp','svc-cal','svc-vault','data-access','db-airtable','ext-fmcsa'] },
  { id:'onboarding', label:'Carrier Journey',  layers:['shell','cdn','page','services','data'], ctypes:['message','call','data'],
    hi:['html-wel','html-misc','mod-misc','page-wel','page-car','svc-status','svc-jrn','svc-leads','svc-rec','data-access','db-airtable'] },
  { id:'agents',     label:'Agent Layer',      layers:['services','agents','data'], ctypes:['call','data'],
    hi:['agt-comms','agt-comp','agt-fleet','svc-coach','data-access','db-airtable'] },
];

// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
const state = {
  layers:  Object.fromEntries(LAYERS.map(l=>[l.id,true])),
  ctypes:  Object.fromEntries(CTYPES.map(c=>[c.id,true])),
  comments:[],
  preset:  'full',
  hi:      null,
  tx:-15, ty:-15, scale:0.62,
  commentTarget:null,
};

// ═══════════════════════════════════════
// SVG HELPERS
// ═══════════════════════════════════════
const NS='http://www.w3.org/2000/svg';
const mkS=tag=>document.createElementNS(NS,tag);
function sA(e,attrs){ for(const[k,v] of Object.entries(attrs)) e.setAttribute(k,v); return e; }

// ═══════════════════════════════════════
// RENDER
// ═══════════════════════════════════════
const cvs=document.getElementById('cvs');
const CW=2155,CH=770;

function nById(id){ return NODES.find(n=>n.id===id); }
function lById(id){ return LAYERS.find(l=>l.id===id); }
function cById(id){ return CTYPES.find(c=>c.id===id); }
function nVis(n){ return !!state.layers[n.layer]; }
function cVis(c){
  const fn=nById(c.f); const tn=nById(c.t);
  return !!state.ctypes[c.tp] && fn && tn && nVis(fn) && nVis(tn);
}

function edgePt(n,dir){
  return dir==='b'?{x:n.x+n.w/2,y:n.y+n.h}:{x:n.x+n.w/2,y:n.y};
}

function renderDiagram(){
  cvs.textContent='';
  sA(cvs,{viewBox:`0 0 ${CW} ${CH}`});
  const root=mkS('g');
  sA(root,{transform:`translate(${state.tx},${state.ty}) scale(${state.scale})`});
  cvs.appendChild(root);

  // Arrowheads
  const defs=mkS('defs');
  CTYPES.forEach(ct=>{
    const m=mkS('marker');
    sA(m,{id:`ah-${ct.id}`,markerWidth:'7',markerHeight:'5',refX:'6',refY:'2.5',orient:'auto'});
    const p=mkS('polygon'); sA(p,{points:'0 0,7 2.5,0 5',fill:ct.color}); m.appendChild(p); defs.appendChild(m);
  });
  root.appendChild(defs);

  // Layer bands
  const bands={};
  NODES.forEach(n=>{
    if(!nVis(n)) return;
    if(!bands[n.layer]) bands[n.layer]={min:n.y,max:n.y+n.h};
    else{ bands[n.layer].min=Math.min(bands[n.layer].min,n.y); bands[n.layer].max=Math.max(bands[n.layer].max,n.y+n.h); }
  });
  LAYERS.forEach(l=>{
    if(!state.layers[l.id]||!bands[l.id]) return;
    const b=bands[l.id];
    const r=mkS('rect'); sA(r,{x:'-10',y:String(b.min-12),width:String(CW+20),height:String(b.max-b.min+24),rx:'8',fill:l.bg}); root.appendChild(r);
    const t=mkS('text'); sA(t,{x:String(CW-14),y:String(b.min+4),fill:l.dot,'font-size':'9','text-anchor':'end',opacity:'0.55','font-family':'system-ui'});
    t.textContent=l.label.toUpperCase(); root.appendChild(t);
  });

  // Connections
  CONNS.filter(cVis).forEach(c=>{
    const fn=nById(c.f); const tn=nById(c.t); if(!fn||!tn) return;
    const ct=cById(c.tp);
    const goDown=fn.y+fn.h/2 < tn.y+tn.h/2;
    const fp=goDown?edgePt(fn,'b'):edgePt(fn,'t');
    const tp=goDown?edgePt(tn,'t'):edgePt(tn,'b');
    const ctrl=Math.abs(tp.y-fp.y)*0.5;
    const d=`M${fp.x},${fp.y} C${fp.x},${fp.y+(goDown?ctrl:-ctrl)} ${tp.x},${tp.y+(goDown?-ctrl:ctrl)} ${tp.x},${tp.y}`;
    const faded=state.hi&&(!state.hi.includes(c.f)||!state.hi.includes(c.t));
    const path=mkS('path');
    sA(path,{d,fill:'none',stroke:ct.color,'stroke-width':'1.5',opacity:faded?'0.08':'0.45','marker-end':`url(#ah-${c.tp})`});
    if(ct.dash) sA(path,{'stroke-dasharray':ct.dash});
    root.appendChild(path);
  });

  // Nodes
  NODES.filter(nVis).forEach(n=>{
    const layer=lById(n.layer);
    const comment=state.comments.find(c=>c.target===n.id);
    const faded=state.hi&&!state.hi.includes(n.id);
    const g=mkS('g'); sA(g,{cursor:'pointer',opacity:faded?'0.1':'1'});
    const sh=mkS('rect'); sA(sh,{x:String(n.x+3),y:String(n.y+3),width:String(n.w),height:String(n.h),rx:'7',fill:'rgba(0,0,0,0.5)'}); g.appendChild(sh);
    const box=mkS('rect'); sA(box,{x:String(n.x),y:String(n.y),width:String(n.w),height:String(n.h),rx:'7',fill:'#1c2128',stroke:comment?'#f59e0b':layer.dot,'stroke-width':comment?'2':'1'}); g.appendChild(box);
    const lbl=mkS('text'); sA(lbl,{x:String(n.x+n.w/2),y:String(n.y+18),'text-anchor':'middle',fill:layer.dot,'font-size':'11','font-weight':'600','font-family':'system-ui'});
    lbl.textContent=n.label; g.appendChild(lbl);
    const sub=mkS('text'); sA(sub,{x:String(n.x+n.w/2),y:String(n.y+32),'text-anchor':'middle',fill:'#8b949e','font-size':'8.5','font-family':'system-ui'});
    sub.textContent=n.sub.length>34?n.sub.slice(0,33)+'…':n.sub; g.appendChild(sub);
    if(comment){ const cd=mkS('circle'); sA(cd,{cx:String(n.x+n.w-7),cy:String(n.y+7),r:'5',fill:'#f59e0b'}); g.appendChild(cd); }
    g.addEventListener('click',ev=>{ ev.stopPropagation(); openModal(n); });
    g.addEventListener('mouseenter',ev=>showTip(ev,n));
    g.addEventListener('mouseleave',hideTip);
    root.appendChild(g);
  });
}

// ═══════════════════════════════════════
// TOOLTIP
// ═══════════════════════════════════════
const tipEl=document.getElementById('tip');
function showTip(e,n){ tipEl.textContent=n.info||''; tipEl.classList.remove('hidden'); mvTip(e); }
function hideTip(){ tipEl.classList.add('hidden'); }
function mvTip(e){ tipEl.style.left=(e.clientX+14)+'px'; tipEl.style.top=(e.clientY+12)+'px'; }
cvs.addEventListener('mousemove',e=>{ if(!tipEl.classList.contains('hidden')) mvTip(e); });

// ═══════════════════════════════════════
// ZOOM / PAN
// ═══════════════════════════════════════
function zoom(f){ state.scale=Math.max(0.12,Math.min(3,state.scale*f)); renderDiagram(); }
function resetView(){ state.tx=-15; state.ty=-15; state.scale=0.62; renderDiagram(); }
document.getElementById('z-in').onclick=()=>zoom(1.18);
document.getElementById('z-out').onclick=()=>zoom(0.85);
document.getElementById('z-reset').onclick=()=>resetView();

let pan={on:false,sx:0,sy:0,ox:0,oy:0};
cvs.addEventListener('mousedown',e=>{ if(e.target===cvs||e.target.nodeName==='svg'){ pan={on:true,sx:e.clientX,sy:e.clientY,ox:state.tx,oy:state.ty}; cvs.classList.add('panning'); } });
window.addEventListener('mousemove',e=>{ if(!pan.on) return; state.tx=pan.ox+(e.clientX-pan.sx); state.ty=pan.oy+(e.clientY-pan.sy); renderDiagram(); });
window.addEventListener('mouseup',()=>{ pan.on=false; cvs.classList.remove('panning'); });
cvs.addEventListener('wheel',e=>{ e.preventDefault(); zoom(e.deltaY<0?1.1:0.9); },{passive:false});

// ═══════════════════════════════════════
// MODAL
// ═══════════════════════════════════════
const overlay=document.getElementById('modal-overlay');
function openModal(n){
  state.commentTarget=n;
  document.getElementById('m-title').textContent=n.label;
  document.getElementById('m-sub').textContent=n.sub;
  const ex=state.comments.find(c=>c.target===n.id);
  document.getElementById('m-ta').value=ex?ex.text:'';
  overlay.classList.remove('hidden');
  setTimeout(()=>document.getElementById('m-ta').focus(),40);
}
function closeModal(){ overlay.classList.add('hidden'); state.commentTarget=null; }
function saveComment(){
  const txt=document.getElementById('m-ta').value.trim();
  const n=state.commentTarget;
  if(txt){
    const idx=state.comments.findIndex(c=>c.target===n.id);
    const entry={id:Date.now(),target:n.id,label:n.label,file:n.sub,text:txt};
    if(idx>=0) state.comments[idx]=entry; else state.comments.push(entry);
  } else {
    state.comments=state.comments.filter(c=>c.target!==n.id);
  }
  closeModal(); updateAll();
}
document.getElementById('m-cancel').onclick=closeModal;
document.getElementById('m-save').onclick=saveComment;
overlay.addEventListener('click',e=>{ if(e.target===overlay) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

// ═══════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════
function buildSidebar(){
  const pg=document.getElementById('preset-grid');
  PRESETS.forEach(p=>{
    const b=el('button',{class:'preset-btn'+(state.preset===p.id?' active':''),'data-id':p.id,text:p.label});
    b.onclick=()=>applyPreset(p.id);
    pg.appendChild(b);
  });
  const ll=document.getElementById('layer-list');
  LAYERS.forEach(l=>{
    const chk=el('input',{type:'checkbox',id:'ly-'+l.id}); chk.checked=true;
    const dot=el('div',{class:'layer-dot',style:'background:'+l.dot});
    const lbl=el('label',{class:'row-label','for':'ly-'+l.id},l.label);
    const row=el('div',{class:'check-row'},chk,dot,lbl);
    chk.onchange=ev=>{ state.layers[l.id]=ev.target.checked; state.preset=null; state.hi=null; updateAll(); };
    ll.appendChild(row);
  });
  const cl=document.getElementById('conn-list');
  CTYPES.forEach(c=>{
    const chk=el('input',{type:'checkbox',id:'ct-'+c.id}); chk.checked=true;
    const ls=c.dash?`border-top:2px dashed ${c.color};height:0;margin-top:2px`:`background:${c.color}`;
    const line=el('div',{class:'conn-dash',style:ls});
    const lbl=el('label',{class:'row-label','for':'ct-'+c.id},c.label);
    const row=el('div',{class:'check-row'},chk,line,lbl);
    chk.onchange=ev=>{ state.ctypes[c.id]=ev.target.checked; state.preset=null; updateAll(); };
    cl.appendChild(row);
  });
}

function refreshSidebar(){
  document.querySelectorAll('.preset-btn').forEach(b=>{ b.classList.toggle('active',b.dataset.id===state.preset); });
  LAYERS.forEach(l=>{ const e=document.getElementById('ly-'+l.id); if(e) e.checked=!!state.layers[l.id]; });
  CTYPES.forEach(c=>{ const e=document.getElementById('ct-'+c.id); if(e) e.checked=!!state.ctypes[c.id]; });
  document.getElementById('cmt-count').textContent=String(state.comments.length);
  const cl=document.getElementById('cmt-list');
  cl.textContent='';
  if(!state.comments.length){ cl.appendChild(el('div',{class:'no-cmt'},'Click any node to annotate')); return; }
  state.comments.forEach(c=>{
    const delBtn=el('button',{class:'cc-del','data-id':String(c.id)},'×');
    delBtn.onclick=()=>{ state.comments=state.comments.filter(x=>x.id!==c.id); updateAll(); };
    const titleDiv=el('div',{class:'cc-title'});
    titleDiv.appendChild(document.createTextNode(c.label));
    titleDiv.appendChild(delBtn);
    const textDiv=el('div',{class:'cc-text'}); textDiv.textContent=c.text;
    cl.appendChild(el('div',{class:'comment-card'},titleDiv,textDiv));
  });
}

function applyPreset(id){
  const p=PRESETS.find(x=>x.id===id); if(!p) return;
  state.preset=id; state.hi=p.hi||null;
  LAYERS.forEach(l=>{ state.layers[l.id]=!p.layers||p.layers.includes(l.id); });
  CTYPES.forEach(c=>{ state.ctypes[c.id]=!p.ctypes||p.ctypes.includes(c.id); });
  updateAll();
}

// ═══════════════════════════════════════
// PROMPT
// ═══════════════════════════════════════
function updatePrompt(){
  const el2=document.getElementById('prompt-txt');
  const vis=LAYERS.filter(l=>state.layers[l.id]).map(l=>l.label);
  const hid=LAYERS.filter(l=>!state.layers[l.id]);
  let t='Carrier Portal architecture map';
  if(hid.length) t+=` — showing: ${vis.join(', ')}`;
  else t+=' — all 7 layers visible';
  t+='. 40 nodes: 10 HTML pages (Announcements, Policies, Welcome, CSA Monitor, DQ Tracker, Incident Reporting, Document Vault, Compliance Calendar, Weight Preferences, Standalone group), 4 CDN module groups, 9 Wix Page Code files, 10 Backend Services (complianceBridge.jsw serves CSA+DQ+Incident as a unified backend), 4 Agent Services (Communication/Compliance/Fleet agents + coaching), 4 Data nodes (dataAccess.jsw, Airtable 12+ tables, Wix Data, Wix Media Manager), FMCSA API. All pages use type/data message protocol exclusively.';
  if(state.comments.length){
    t+='\n\nAnnotations:\n';
    state.comments.forEach(c=>{ t+=`\n**${c.label}** (${c.file}):\n${c.text}\n`; });
  }
  el2.textContent=t;
}

document.getElementById('copy-btn').onclick=()=>{
  const txt=document.getElementById('prompt-txt').textContent;
  navigator.clipboard.writeText(txt).then(()=>{
    const b=document.getElementById('copy-btn'); b.textContent='Copied!'; b.classList.add('done');
    setTimeout(()=>{ b.textContent='Copy Prompt'; b.classList.remove('done'); },1600);
  });
};

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
function updateAll(){ renderDiagram(); refreshSidebar(); updatePrompt(); }
buildSidebar();
updateAll();
</script>
</body>
</html>
