<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RecruiterOS â€” Service, Bridge &amp; LLM Map</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{display:flex;flex-direction:column;height:100vh;background:#0d1117;color:#e6edf3;font-family:system-ui,sans-serif;overflow:hidden}
    header{display:flex;align-items:center;gap:10px;padding:9px 14px;background:#161b22;border-bottom:1px solid #30363d;flex-shrink:0}
    header h1{font-size:14px;font-weight:600;color:#f0f6fc}
    .badge{font-size:10px;padding:2px 8px;border-radius:10px;background:#1f6feb;color:#fff}
    .hint{font-size:10px;color:#6e7681;margin-left:auto}
    .main{display:flex;flex:1;overflow:hidden}
    .sidebar{width:220px;flex-shrink:0;background:#161b22;border-right:1px solid #30363d;display:flex;flex-direction:column;overflow-y:auto;padding:10px}
    .sb-h{font-size:10px;text-transform:uppercase;color:#6e7681;letter-spacing:.06em;margin:10px 0 6px;padding-bottom:3px;border-bottom:1px solid #21262d}
    .sb-h:first-child{margin-top:0}
    .preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
    .preset-btn{padding:5px 4px;border-radius:5px;border:1px solid #30363d;background:#21262d;color:#c9d1d9;cursor:pointer;font-size:10px;text-align:center;transition:all .15s;line-height:1.3}
    .preset-btn:hover{background:#30363d;border-color:#58a6ff;color:#f0f6fc}
    .preset-btn.active{background:#1f2d4e;border-color:#1f6feb;color:#79c0ff}
    .check-row{display:flex;align-items:center;gap:7px;padding:3px 0;cursor:pointer;user-select:none}
    .check-row input{accent-color:#1f6feb;cursor:pointer;flex-shrink:0}
    .layer-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
    .conn-dash{width:18px;height:0;flex-shrink:0}
    .row-label{font-size:11px;color:#c9d1d9;line-height:1.3}
    .comment-card{background:#21262d;border:1px solid #30363d;border-radius:5px;padding:7px;margin-bottom:5px}
    .cc-title{font-size:10px;font-weight:700;color:#79c0ff;margin-bottom:2px;display:flex;justify-content:space-between;align-items:flex-start}
    .cc-del{background:none;border:none;color:#6e7681;cursor:pointer;font-size:14px;line-height:1;padding:0 1px;flex-shrink:0}
    .cc-del:hover{color:#f85149}
    .cc-text{font-size:10px;color:#8b949e;line-height:1.45}
    .no-cmt{font-size:10px;color:#484f58;font-style:italic}
    .canvas-area{flex:1;position:relative;overflow:hidden;background:#0d1117}
    .zoom-ctrl{position:absolute;top:8px;right:8px;z-index:10;display:flex;gap:3px}
    .zbtn{width:26px;height:26px;border-radius:5px;background:#21262d;border:1px solid #30363d;color:#c9d1d9;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
    .zbtn:hover{background:#30363d}
    svg#cvs{width:100%;height:100%;cursor:grab}
    svg#cvs.panning{cursor:grabbing}
    .legend{position:absolute;bottom:8px;left:8px;z-index:10;background:#161b22cc;border:1px solid #30363d;border-radius:6px;padding:7px 10px}
    .lg-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:9px;color:#8b949e}
    .lg-row:last-child{margin-bottom:0}
    .lg-line{width:18px;height:2px;border-radius:1px}
    .prompt-bar{background:#161b22;border-top:1px solid #30363d;padding:8px 14px;display:flex;align-items:flex-start;gap:10px;flex-shrink:0;max-height:100px}
    .prompt-txt{flex:1;font-size:11px;color:#8b949e;line-height:1.5;font-family:Consolas,monospace;overflow-y:auto;max-height:80px;white-space:pre-wrap}
    .copy-btn{padding:4px 12px;background:#21262d;border:1px solid #30363d;border-radius:5px;color:#c9d1d9;cursor:pointer;font-size:11px;white-space:nowrap;flex-shrink:0}
    .copy-btn:hover{background:#30363d}
    .copy-btn.done{color:#3fb950;border-color:#3fb950}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center}
    .overlay.hidden{display:none}
    .modal{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:18px;width:340px;max-width:90vw}
    .modal-title{font-size:13px;font-weight:600;color:#f0f6fc;margin-bottom:2px}
    .modal-sub{font-size:10px;color:#8b949e;margin-bottom:10px;font-family:Consolas,monospace}
    .modal-ta{width:100%;height:80px;background:#0d1117;border:1px solid #30363d;border-radius:5px;color:#e6edf3;padding:8px;font-size:11px;resize:none;outline:none;font-family:system-ui}
    .modal-ta:focus{border-color:#1f6feb}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .modal-btns button{padding:4px 12px;border-radius:5px;cursor:pointer;font-size:11px}
    .m-cancel{background:#21262d;border:1px solid #30363d;color:#c9d1d9}
    .m-save{background:#1f6feb;border:1px solid #1f6feb;color:#fff}
    .tip{position:fixed;background:#1c2128;border:1px solid #30363d;border-radius:5px;padding:6px 9px;font-size:10px;color:#c9d1d9;pointer-events:none;z-index:100;max-width:200px;line-height:1.5}
    .tip.hidden{display:none}
  </style>
</head>
<body>

<header>
  <h1>RecruiterOS â€” Service, Bridge &amp; LLM Map</h1>
  <span class="badge">43 nodes Â· 68 connections</span>
  <span class="hint">Click any node to annotate Â· Scroll/drag to navigate</span>
</header>

<div class="main">
  <div class="sidebar">
    <div class="sb-h">Presets</div>
    <div class="preset-grid" id="preset-grid"></div>
    <div class="sb-h">Layers</div>
    <div id="layer-list"></div>
    <div class="sb-h">Connection Types</div>
    <div id="conn-list"></div>
    <div class="sb-h">Comments (<span id="cmt-count">0</span>)</div>
    <div id="cmt-list"></div>
  </div>

  <div class="canvas-area">
    <div class="zoom-ctrl">
      <button class="zbtn" id="z-in">+</button>
      <button class="zbtn" id="z-out">âˆ’</button>
      <button class="zbtn" id="z-reset">âŠ™</button>
    </div>
    <svg id="cvs"></svg>
    <div class="legend">
      <div class="lg-row"><div class="lg-line" style="border-top:2px dotted #6b7280;height:0;margin-top:1px"></div><span>CDN Load</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #10b981;height:0;margin-top:1px"></div><span>postMessage</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#3b82f6"></div><span>Service Call</span></div>
      <div class="lg-row"><div class="lg-line" style="background:#f472b6"></div><span>Data Access</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #e879f9;height:0;margin-top:1px"></div><span>LLM API Call</span></div>
      <div class="lg-row"><div class="lg-line" style="border-top:2px dashed #f97316;height:0;margin-top:1px"></div><span>External API</span></div>
    </div>
  </div>
</div>

<div class="prompt-bar">
  <div class="prompt-txt" id="prompt-txt"></div>
  <button class="copy-btn" id="copy-btn">Copy Prompt</button>
</div>

<div class="overlay hidden" id="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="m-title"></div>
    <div class="modal-sub" id="m-sub"></div>
    <textarea class="modal-ta" id="m-ta" placeholder="Add feedback or notes about this componentâ€¦"></textarea>
    <div class="modal-btns">
      <button class="m-cancel" id="m-cancel">Cancel</button>
      <button class="m-save" id="m-save">Save</button>
    </div>
  </div>
</div>

<div class="tip hidden" id="tip"></div>

<script>
// Safe DOM element builder â€” no innerHTML used for dynamic content
function el(tag, attrs, ...children) {
  const e = document.createElement(tag);
  if (attrs) {
    for (const [k, v] of Object.entries(attrs)) {
      if (k === 'class') { e.className = v; }
      else if (k === 'style') { e.style.cssText = v; }
      else if (k === 'text') { e.textContent = v; }
      else if (k === 'for') { e.setAttribute('for', v); }
      else { e.setAttribute(k, v); }
    }
  }
  for (const c of children) {
    if (typeof c === 'string') { e.appendChild(document.createTextNode(c)); }
    else if (c instanceof Node) { e.appendChild(c); }
  }
  return e;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LAYERS = [
  { id:'shell',    label:'HTML Shell',       dot:'#60a5fa', bg:'rgba(30,58,95,.22)' },
  { id:'cdn',      label:'CDN Core Modules', dot:'#4ade80', bg:'rgba(20,50,30,.22)' },
  { id:'views',    label:'CDN View Groups',  dot:'#a78bfa', bg:'rgba(45,30,95,.22)' },
  { id:'page',     label:'Wix Page Code',    dot:'#fbbf24', bg:'rgba(58,46,0,.28)' },
  { id:'services', label:'Backend Services', dot:'#34d399', bg:'rgba(20,50,35,.22)' },
  { id:'llm',      label:'LLM Providers',    dot:'#e879f9', bg:'rgba(88,28,135,.22)' },
  { id:'data',     label:'Data Layer',       dot:'#f472b6', bg:'rgba(58,20,45,.22)' },
  { id:'external', label:'External APIs',    dot:'#f87171', bg:'rgba(50,20,20,.22)' },
];

const CTYPES = [
  { id:'load',     label:'CDN Load',      color:'#6b7280', dash:'4,3' },
  { id:'message',  label:'postMessage',   color:'#10b981', dash:'6,3' },
  { id:'call',     label:'Service Call',  color:'#3b82f6', dash:'' },
  { id:'ai-call',  label:'LLM API Call',  color:'#e879f9', dash:'5,2' },
  { id:'data',     label:'Data Access',   color:'#f472b6', dash:'' },
  { id:'external', label:'External API',  color:'#f97316', dash:'8,3' },
];

const NODES = [
  // HTML Shell
  { id:'html-shell', label:'RecruiterOS.html', sub:'HTML Shell Â· 189 lines', layer:'shell',
    x:985, y:28, w:185, h:46,
    info:'CDN bootloader. Inline Tailwind config. Loads 35+ JS/CSS modules via jsDelivr @main. Never changes after setup.' },
  // CDN Core
  { id:'ros-config',    label:'ros-config.js',    sub:'Config & feature flags',  layer:'cdn', x:48,  y:140, w:148,h:46,
    info:'Brand tokens, color palette, 29 view definitions. Flags: NLU_ENABLED, VOICE_ENABLED, NBA_ENABLED, DARK_MODE_ENABLED.' },
  { id:'ros-bridge',    label:'ros-bridge.js',    sub:'postMessage bridge',      layer:'cdn', x:248, y:140, w:148,h:46,
    info:'Buffers ready callbacks. Routes Veloâ†’HTML messages. Validates 119 inbound / 105 outbound actions in MESSAGE_REGISTRY.' },
  { id:'ros-views',     label:'ros-views.js',     sub:'View lifecycle manager',  layer:'cdn', x:448, y:140, w:148,h:46,
    info:'registerView(), showView(), routeMessage(). Manages lifecycle of 29 view modules across 8 functional groups.' },
  { id:'ros-shell',     label:'ros-shell.js',     sub:'Dock nav + mobile rail',  layer:'cdn', x:648, y:140, w:148,h:46,
    info:'Main UI chrome: dock navigation, mobile rail, footer, drawer menu. Syncs active tool state across views.' },
  { id:'ros-chat',      label:'ros-chat.js',      sub:'Agent chat overlay',      layer:'cdn', x:848, y:140, w:148,h:46,
    info:'Floating chat FAB + sliding panel. Sends agentMessage. Receives agentResponse / agentApprovalRequired / agentTyping.' },
  { id:'ros-spotlight', label:'ros-spotlight.js', sub:'Command palette',         layer:'cdn', x:1048,y:140, w:148,h:46,
    info:'Fast view navigation. Fuzzy search across all 29 view IDs and labels.' },
  { id:'ros-settings',  label:'ros-settings.js',  sub:'Settings panel',          layer:'cdn', x:1248,y:140, w:148,h:46,
    info:'Account settings: recruiter profile, carrier management, theme toggle (light / solar / dark).' },
  { id:'ros-voice',     label:'ros-voice.js',     sub:'VAPI voice wrapper',      layer:'cdn', x:1448,y:140, w:148,h:46,
    info:'Bridges VAPI Web SDK events to postMessage. Initiates outbound calls, streams transcripts, manages VAPI session state.' },
  // View Groups
  { id:'vg-search',     label:'Search & Match',        sub:'search Â· ai-match Â· alerts (3 views)',          layer:'views', x:28,  y:263, w:162,h:46,
    info:'Driver search with AI scoring, saved searches, quota management. Sends: searchDrivers, getAIMatches, regenerateAIMatches, updateAlertPrefs.' },
  { id:'vg-pipeline',   label:'Pipeline & Automation', sub:'pipeline Â· automate Â· predict (3 views)',       layer:'views', x:248, y:263, w:172,h:46,
    info:'Candidate funnel, automation rules engine, hiring forecasts. Sends: getPipeline, updateCandidateStatus, createAutomationRule, getPredictionsData.' },
  { id:'vg-messaging',  label:'Messaging',             sub:'messages Â· carriers Â· home (3 views)',          layer:'views', x:478, y:263, w:152,h:46,
    info:'Driver conversations, carrier management, home dashboard. Sends: sendMessage, getConversation, markAsRead, addCarrier, switchCarrier.' },
  { id:'vg-campaigns',  label:'Campaigns',             sub:'campaigns Â· sms Â· email (3 views)',             layer:'views', x:688, y:263, w:148,h:46,
    info:'Voice / SMS / Email campaign builders. Sends: getCampaigns, createCampaign, startCampaign, sendEmailCampaign, sendSmsCampaign.' },
  { id:'vg-social',     label:'Social & Paid Media',   sub:'social Â· social-settings Â· job-boards (3)',     layer:'views', x:895, y:263, w:185,h:46,
    info:'Social posting (Twitter/LinkedIn/FB), Meta Ads (12 actions), job board integrations. Sends: publishSocialPost, getPaidMediaInsights.' },
  { id:'vg-compliance', label:'Compliance & Docs',     sub:'comply Â· docs Â· bg-check Â· drug-test Â· orient', layer:'views', x:1140,y:263, w:185,h:46,
    info:'FMCSA compliance, document collection, background checks, drug tests, orientation scheduling.' },
  { id:'vg-analytics',  label:'Analytics & Reporting', sub:'funnel Â· retention Â· cost-analysis Â· leaderboard (4)', layer:'views', x:1385,y:263, w:185,h:46,
    info:'Funnel metrics, driver retention, cost-per-hire ROI, recruiter leaderboard. Sends: getFunnelData, getRetentionData, getCostData.' },
  { id:'vg-other',      label:'Other Views',           sub:'intel Â· lifecycle Â· gamification Â· telemetry (4)',   layer:'views', x:1630,y:263, w:170,h:46,
    info:'Competitor intel, driver lifecycle/termination, gamification/XP/badges, system telemetry.' },
  // Page code
  { id:'page-code', label:'Recruiter Console', sub:'Recruiter Console.zriuj.js Â· 2,705 lines', layer:'page',
    x:845, y:388, w:242, h:46,
    info:'Wix Velo bridge. 119 inbound actions. 105+ outbound responses. type+data envelope protocol. MESSAGE_REGISTRY validation. Debug: ğŸ“¥ğŸ“¤ logging.' },
  // Backend services (row 1)
  { id:'svc-recruiter',  label:'Recruiter Core',         sub:'recruiter_service Â· savedSearch Â· callOutcome',    layer:'services', x:18,  y:508, w:210,h:46,
    info:'getOrCreateRecruiterProfile, getPipelineCandidates, updateCandidateStatus, addRecruiterNotes. Saved searches CRUD, call outcome logging.' },
  { id:'svc-matching',   label:'Driver Matching',        sub:'driverMatching Â· driverOutreach Â· carrierPrefs',   layer:'services', x:285, y:508, w:205,h:46,
    info:'findMatchingDrivers, getDriverProfile, saveToRecruiterPipeline, sendMessageToDriver, getQuotaStatus, getCarrierPreferences.' },
  { id:'svc-messaging',  label:'Messaging & Scheduling', sub:'messaging Â· interviewScheduler',                   layer:'services', x:550, y:508, w:188,h:46,
    info:'sendMessage, getConversation, markAsRead, getUnreadCount, getRecruiterConversations, requestAvailability, confirmTimeSlot.' },
  { id:'svc-analytics',  label:'Analytics & Forecasting',sub:'recruiterAnalyticsService Â· leaderboardService',   layer:'services', x:798, y:508, w:205,h:46,
    info:'getFunnelMetrics, getBottleneckAnalysis, calculateCostPerHire, generateHiringForecast, getTurnoverRiskAnalysis, getPayBenchmarks.' },
  { id:'svc-agent',      label:'Agent Orchestration',    sub:'agentService Â· agentConversationService',          layer:'services', x:1063,y:508, w:200,h:46,
    info:'handleAgentTurn(role="recruiter"), resumeAfterApproval, executeTool. Conversations + turns persisted to v2_Agent Conversations.' },
  { id:'svc-voice',      label:'Voice & Campaigns',      sub:'voiceService Â· voiceCampaignService',              layer:'services', x:1323,y:508, w:188,h:46,
    info:'getVoiceConfig, createCampaign, startCampaign, getCampaignStatus. VAPI_PRIVATE_KEY. Logs â†’ v2_Voice Call Logs.' },
  { id:'svc-social',     label:'Social & Job Boards',    sub:'socialPostingService Â· socialCopyService Â· jobBoard', layer:'services', x:1565,y:508, w:215,h:46,
    info:'getSocialPosts, publishSocialPost, connectSocialAccount, generatePlatformCopy (AI), getJobPostings, connectJobBoard.' },
  { id:'svc-meta',       label:'Meta Ads Suite',         sub:'metaAdsAuth Â· metaCampaign Â· metaAdSet Â· metaInsights', layer:'services', x:1842,y:508, w:195,h:46,
    info:'Full Meta Ads stack: auth, campaign creation, ad-set management, creative upload, insights, optimization suggestions, frequency alerts.' },
  // Backend services (row 2)
  { id:'svc-compliance', label:'Compliance & Docs',      sub:'complianceService Â· documentCollection Â· recruiterOnboarding', layer:'services', x:18,  y:595, w:240,h:46,
    info:'getFMCSAAlerts, requestDocuments, getBGCStatus, getDrugTestStatus, getOrientationSlots.' },
  { id:'svc-automation', label:'Pipeline Automation',    sub:'pipelineAutomation Â· interventionService Â· retentionService', layer:'services', x:325, y:595, w:225,h:46,
    info:'getAutomationRules, createAutomationRule, toggleRuleStatus, getAutomationLog, sendIntervention, getCarrierRetentionDashboard.' },
  { id:'svc-ai',         label:'AI Router & Alerts',     sub:'aiRouterService Â· imagenService Â· recruiterAlerts',           layer:'services', x:618, y:595, w:200,h:46,
    info:'routeAIRequest (optimal AI provider selection), generateSocialImage (Imagen), getAIMatchCandidates, getRecruiterAlerts.' },
  // LLM Providers
  { id:'llm-router',    label:'AI Router',           sub:'routeAIRequest Â· cost optimizer Â· fallback queue', layer:'llm', x:18,  y:700, w:200,h:46,
    info:'aiRouterService.jsw core. Looks up FUNCTION_REGISTRY (20+ fns), runs cost optimizer, executes fallback queue on failure. Logs every call to v2_AI Usage Log.' },
  { id:'llm-anthropic', label:'Anthropic (Claude)',  sub:'claude-sonnet-4 Â· haiku Â· opus Â· PINNED for agents', layer:'llm', x:278, y:700, w:200,h:46,
    info:'PINNED for agent_orchestration (requires tool_use contentBlocks). Also: carrier_synthesis, admin_assistant, data_extraction. Key: CLAUDE_API_KEY.' },
  { id:'llm-groq',      label:'Groq (LLaMA)',        sub:'compound Â· llama-4-maverick Â· llama-3.3-70b',      layer:'llm', x:538, y:700, w:195,h:46,
    info:'Preferred for speed & unlimited tokens. web_research, social_scanning, driver_chat, sentiment_analysis, quick_classification, match_explanation. Key: GROQ_API_KEY.' },
  { id:'llm-google',    label:'Google (Gemini)',     sub:'gemini-2.5-pro Â· 2.5-flash Â· image-gen',           layer:'llm', x:793, y:700, w:190,h:46,
    info:'document_ocr, translation, social_copy_generation, image generation (gemini-2.0-flash-preview-image-generation â†’ Wix Media Manager). Key: GEMINI_API_KEY.' },
  { id:'llm-openai',    label:'OpenAI (GPT)',        sub:'gpt-4o Â· gpt-4o-mini Â· text-embedding-3-small',    layer:'llm', x:1043,y:700, w:195,h:46,
    info:'embeddings (text-embedding-3-small), general tasks. OpenAI-compatible endpoint also used by Groq + Mistral (same JSON protocol). Key: OPENAI_API_KEY.' },
  { id:'llm-mistral',   label:'Mistral AI',         sub:'mistral-large Â· codestral Â· mistral-small',        layer:'llm', x:1298,y:700, w:180,h:46,
    info:'European GDPR-compliant alternative. codestral-latest for code generation tasks. OpenAI-compatible endpoint. Key: MISTRAL_API_KEY.' },
  { id:'llm-cohere',    label:'Cohere (Command R)',  sub:'command-r-plus Â· command-r Â· RAG specialist',      layer:'llm', x:1538,y:700, w:185,h:46,
    info:'RAG + retrieval-augmented generation tasks. command-r-plus for premium, command-light for economy. Cohere-specific endpoint. Key: COHERE_API_KEY.' },
  { id:'llm-safety',    label:'Safety Models',       sub:'Llama Guard 4 Â· Prompt Guard 2 (via Groq)',        layer:'llm', x:1783,y:700, w:180,h:46,
    info:'Input safety filtering. Llama Guard 4 12B, Prompt Guard 2 series. role="guard" in router. Runs before agent tool execution.' },

  // Data layer (shifted down +120)
  { id:'data-access', label:'dataAccess.jsw', sub:'Dual-source router',                     layer:'data', x:675, y:838, w:165,h:46,
    info:'Routes: usesAirtable()â†’Airtable REST, elseâ†’wixData. queryRecords, insertRecord, updateRecord. configData.js maps 160+ keys.' },
  { id:'db-airtable', label:'Airtable',       sub:'app9N1YCJ3gdhExA0 Â· 160+ v2_* tables',  layer:'data', x:940, y:838, w:190,h:46,
    info:'Primary store for all business data. Rate limit: chunk 10/call, 200ms between chunks. Date fields MUST use YYYY-MM-DD.' },
  { id:'db-wix',      label:'Wix Data',       sub:'AdminUsers Â· MemberNotifications only',  layer:'data', x:1200,y:838, w:175,h:46,
    info:'Only 2 collections stay in Wix: AdminUsers (auth/permissions), MemberNotifications (Wix member system).' },
  // External
  { id:'ext-vapi',   label:'VAPI Voice API',    sub:'REST + Web SDK',              layer:'external', x:490, y:960, w:155,h:46,
    info:'Outbound calling, real-time transcripts. VAPI_PRIVATE_KEY. Webhooks at /api/vapi-webhook in http-functions.js.' },
  { id:'ext-meta',   label:'Meta Ads API',      sub:'Graph API v17+',              layer:'external', x:740, y:960, w:150,h:46,
    info:'Campaign management, ad insights, creative upload, audience management.' },
  { id:'ext-fmcsa',  label:'FMCSA API',         sub:'DOT lookup Â· safety data',    layer:'external', x:985, y:960, w:155,h:46,
    info:'Carrier safety ratings, violation history, inspection records. FMCSA_WEB_KEY env var.' },
  { id:'ext-social', label:'Social Media APIs', sub:'Twitter Â· LinkedIn Â· Facebook',layer:'external', x:1240,y:960, w:165,h:46,
    info:'Platform publishing, account auth via socialSecretService + socialTokenService.' },
];

const CONNS = [
  // Shell â†’ CDN modules
  {f:'html-shell',t:'ros-config',   tp:'load'},{f:'html-shell',t:'ros-bridge',   tp:'load'},
  {f:'html-shell',t:'ros-views',    tp:'load'},{f:'html-shell',t:'ros-shell',    tp:'load'},
  {f:'html-shell',t:'ros-chat',     tp:'load'},{f:'html-shell',t:'ros-spotlight',tp:'load'},
  {f:'html-shell',t:'ros-settings', tp:'load'},{f:'html-shell',t:'ros-voice',    tp:'load'},
  // Bridge â†’ View groups
  {f:'ros-bridge',t:'vg-search',    tp:'load'},{f:'ros-bridge',t:'vg-pipeline',  tp:'load'},
  {f:'ros-bridge',t:'vg-messaging', tp:'load'},{f:'ros-bridge',t:'vg-campaigns', tp:'load'},
  {f:'ros-bridge',t:'vg-social',    tp:'load'},{f:'ros-bridge',t:'vg-compliance',tp:'load'},
  {f:'ros-bridge',t:'vg-analytics', tp:'load'},{f:'ros-bridge',t:'vg-other',     tp:'load'},
  // Views â†’ Page code (postMessage)
  {f:'vg-search',    t:'page-code',tp:'message'},{f:'vg-pipeline',  t:'page-code',tp:'message'},
  {f:'vg-messaging', t:'page-code',tp:'message'},{f:'vg-campaigns', t:'page-code',tp:'message'},
  {f:'vg-social',    t:'page-code',tp:'message'},{f:'vg-compliance',t:'page-code',tp:'message'},
  {f:'vg-analytics', t:'page-code',tp:'message'},{f:'vg-other',     t:'page-code',tp:'message'},
  {f:'ros-chat',     t:'page-code',tp:'message'},{f:'ros-voice',    t:'page-code',tp:'message'},
  // Page code â†’ services
  {f:'page-code',t:'svc-recruiter', tp:'call'},{f:'page-code',t:'svc-matching',  tp:'call'},
  {f:'page-code',t:'svc-messaging', tp:'call'},{f:'page-code',t:'svc-analytics', tp:'call'},
  {f:'page-code',t:'svc-agent',     tp:'call'},{f:'page-code',t:'svc-voice',     tp:'call'},
  {f:'page-code',t:'svc-social',    tp:'call'},{f:'page-code',t:'svc-meta',      tp:'call'},
  {f:'page-code',t:'svc-compliance',tp:'call'},{f:'page-code',t:'svc-automation',tp:'call'},
  {f:'page-code',t:'svc-ai',        tp:'call'},
  // Services â†’ dataAccess
  {f:'svc-recruiter', t:'data-access',tp:'data'},{f:'svc-matching',  t:'data-access',tp:'data'},
  {f:'svc-messaging', t:'data-access',tp:'data'},{f:'svc-analytics', t:'data-access',tp:'data'},
  {f:'svc-agent',     t:'data-access',tp:'data'},{f:'svc-compliance',t:'data-access',tp:'data'},
  {f:'svc-automation',t:'data-access',tp:'data'},{f:'svc-ai',        t:'data-access',tp:'data'},
  // dataAccess â†’ stores
  {f:'data-access',t:'db-airtable',tp:'data'},{f:'data-access',t:'db-wix',tp:'data'},
  // Services â†’ external
  {f:'svc-voice',     t:'ext-vapi',  tp:'external'},
  {f:'svc-meta',      t:'ext-meta',  tp:'external'},
  {f:'svc-compliance',t:'ext-fmcsa', tp:'external'},
  {f:'svc-social',    t:'ext-social',tp:'external'},

  // AI Router â†’ LLM providers (via aiRouterService function registry)
  {f:'svc-ai',t:'llm-router',   tp:'ai-call'},
  {f:'llm-router',t:'llm-anthropic',tp:'ai-call'},
  {f:'llm-router',t:'llm-groq',     tp:'ai-call'},
  {f:'llm-router',t:'llm-google',   tp:'ai-call'},
  {f:'llm-router',t:'llm-openai',   tp:'ai-call'},
  {f:'llm-router',t:'llm-mistral',  tp:'ai-call'},
  {f:'llm-router',t:'llm-cohere',   tp:'ai-call'},
  {f:'llm-router',t:'llm-safety',   tp:'ai-call'},
  // Agent service is PINNED directly to Anthropic (tool_use loop)
  {f:'svc-agent',t:'llm-anthropic',tp:'ai-call'},
  // imagenService calls Gemini directly (not through router)
  {f:'svc-social',t:'llm-google',   tp:'ai-call'},
  // matchExplanationService calls Groq directly
  {f:'svc-matching',t:'llm-groq',   tp:'ai-call'},
];

const PRESETS = [
  { id:'full',      label:'Full System',  layers:null, ctypes:null, hi:null },
  { id:'bridge',    label:'Bridge Flow',  layers:['shell','cdn','views','page'], ctypes:['load','message'], hi:null },
  { id:'data-flow', label:'Data Flow',    layers:['page','services','data','external'], ctypes:['call','data','external'], hi:null },
  { id:'agent',     label:'Agent+Voice',  layers:['page','services','data','external'], ctypes:['call','data','external'],
    hi:['page-code','svc-agent','svc-voice','svc-ai','data-access','db-airtable','ext-vapi'] },
  { id:'campaigns', label:'Campaigns',    layers:['views','page','services','external'], ctypes:['message','call','external'],
    hi:['vg-campaigns','vg-social','page-code','svc-voice','svc-social','svc-meta','ext-vapi','ext-social','ext-meta'] },
  { id:'llm-layer', label:'LLM Layer',   layers:['services','llm'], ctypes:['call','ai-call'],
    hi:['svc-ai','svc-agent','svc-social','svc-matching','llm-router','llm-anthropic','llm-groq','llm-google','llm-openai','llm-mistral','llm-cohere','llm-safety'] },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  layers:  Object.fromEntries(LAYERS.map(l=>[l.id,true])),
  ctypes:  Object.fromEntries(CTYPES.map(c=>[c.id,true])),
  comments:[],
  preset:  'full',
  hi:      null,
  tx:-10, ty:-10, scale:0.62,
  commentTarget:null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NS='http://www.w3.org/2000/svg';
const mkS=tag=>document.createElementNS(NS,tag);
function sA(e,attrs){ for(const[k,v] of Object.entries(attrs)) e.setAttribute(k,v); return e; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cvs=document.getElementById('cvs');
const CW=2060,CH=1075;

function nById(id){ return NODES.find(n=>n.id===id); }
function lById(id){ return LAYERS.find(l=>l.id===id); }
function cById(id){ return CTYPES.find(c=>c.id===id); }
function nVis(n){ return !!state.layers[n.layer]; }
function cVis(c){ return !!state.ctypes[c.tp] && nVis(nById(c.f)) && nVis(nById(c.t)); }

function edgePt(n,dir){
  return dir==='b'?{x:n.x+n.w/2,y:n.y+n.h}:{x:n.x+n.w/2,y:n.y};
}

function renderDiagram(){
  cvs.textContent=''; // safe clear
  sA(cvs,{viewBox:`0 0 ${CW} ${CH}`});

  const root=mkS('g');
  sA(root,{transform:`translate(${state.tx},${state.ty}) scale(${state.scale})`});
  cvs.appendChild(root);

  // Arrowhead markers
  const defs=mkS('defs');
  CTYPES.forEach(ct=>{
    const m=mkS('marker');
    sA(m,{id:`ah-${ct.id}`,markerWidth:'7',markerHeight:'5',refX:'6',refY:'2.5',orient:'auto'});
    const p=mkS('polygon'); sA(p,{points:'0 0,7 2.5,0 5',fill:ct.color}); m.appendChild(p); defs.appendChild(m);
  });
  root.appendChild(defs);

  // Layer band backgrounds
  const bands={};
  NODES.forEach(n=>{
    if(!nVis(n)) return;
    if(!bands[n.layer]) bands[n.layer]={min:n.y,max:n.y+n.h};
    else{ bands[n.layer].min=Math.min(bands[n.layer].min,n.y); bands[n.layer].max=Math.max(bands[n.layer].max,n.y+n.h); }
  });
  LAYERS.forEach(l=>{
    if(!state.layers[l.id]||!bands[l.id]) return;
    const b=bands[l.id];
    const r=mkS('rect'); sA(r,{x:'-10',y:String(b.min-12),width:String(CW+20),height:String(b.max-b.min+24),rx:'8',fill:l.bg}); root.appendChild(r);
    const t=mkS('text'); sA(t,{x:String(CW-14),y:String(b.min+4),fill:l.dot,'font-size':'9','text-anchor':'end',opacity:'0.55','font-family':'system-ui'});
    t.textContent=l.label.toUpperCase(); root.appendChild(t);
  });

  // Connections
  CONNS.filter(cVis).forEach(c=>{
    const fn=nById(c.f); const tn=nById(c.t); if(!fn||!tn) return;
    const ct=cById(c.tp);
    const goDown=fn.y+fn.h/2 < tn.y+tn.h/2;
    const fp=goDown?edgePt(fn,'b'):edgePt(fn,'t');
    const tp=goDown?edgePt(tn,'t'):edgePt(tn,'b');
    const ctrl=Math.abs(tp.y-fp.y)*0.5;
    const d=`M${fp.x},${fp.y} C${fp.x},${fp.y+(goDown?ctrl:-ctrl)} ${tp.x},${tp.y+(goDown?-ctrl:ctrl)} ${tp.x},${tp.y}`;
    const faded=state.hi&&(!state.hi.includes(c.f)||!state.hi.includes(c.t));
    const path=mkS('path');
    sA(path,{d,fill:'none',stroke:ct.color,'stroke-width':'1.5',opacity:faded?'0.1':'0.48','marker-end':`url(#ah-${c.tp})`});
    if(ct.dash) sA(path,{'stroke-dasharray':ct.dash});
    root.appendChild(path);
  });

  // Nodes
  NODES.filter(nVis).forEach(n=>{
    const layer=lById(n.layer);
    const comment=state.comments.find(c=>c.target===n.id);
    const faded=state.hi&&!state.hi.includes(n.id);
    const g=mkS('g'); sA(g,{cursor:'pointer',opacity:faded?'0.15':'1'});
    // Shadow
    const sh=mkS('rect'); sA(sh,{x:String(n.x+3),y:String(n.y+3),width:String(n.w),height:String(n.h),rx:'7',fill:'rgba(0,0,0,0.5)'}); g.appendChild(sh);
    // Box
    const box=mkS('rect'); sA(box,{x:String(n.x),y:String(n.y),width:String(n.w),height:String(n.h),rx:'7',fill:'#1c2128',stroke:comment?'#f59e0b':layer.dot,'stroke-width':comment?'2':'1'}); g.appendChild(box);
    // Label text
    const lbl=mkS('text'); sA(lbl,{x:String(n.x+n.w/2),y:String(n.y+18),'text-anchor':'middle',fill:layer.dot,'font-size':'11.5','font-weight':'600','font-family':'system-ui'});
    lbl.textContent=n.label; g.appendChild(lbl);
    // Subtitle text
    const sub=mkS('text'); sA(sub,{x:String(n.x+n.w/2),y:String(n.y+32),'text-anchor':'middle',fill:'#8b949e','font-size':'8.5','font-family':'system-ui'});
    sub.textContent=n.sub.length>33?n.sub.slice(0,32)+'â€¦':n.sub; g.appendChild(sub);
    // Comment indicator
    if(comment){ const cd=mkS('circle'); sA(cd,{cx:String(n.x+n.w-7),cy:String(n.y+7),r:'5',fill:'#f59e0b'}); g.appendChild(cd); }
    // Events
    g.addEventListener('click',ev=>{ ev.stopPropagation(); openModal(n); });
    g.addEventListener('mouseenter',ev=>showTip(ev,n));
    g.addEventListener('mouseleave',hideTip);
    root.appendChild(g);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLTIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tipEl=document.getElementById('tip');
function showTip(e,n){ tipEl.textContent=n.info||''; tipEl.classList.remove('hidden'); mvTip(e); }
function hideTip(){ tipEl.classList.add('hidden'); }
function mvTip(e){ tipEl.style.left=(e.clientX+14)+'px'; tipEl.style.top=(e.clientY+12)+'px'; }
cvs.addEventListener('mousemove',e=>{ if(!tipEl.classList.contains('hidden')) mvTip(e); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZOOM / PAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function zoom(f){ state.scale=Math.max(0.12,Math.min(2.8,state.scale*f)); renderDiagram(); }
function resetView(){ state.tx=-10; state.ty=-10; state.scale=0.62; renderDiagram(); }
document.getElementById('z-in').onclick=()=>zoom(1.18);
document.getElementById('z-out').onclick=()=>zoom(0.85);
document.getElementById('z-reset').onclick=()=>resetView();

let pan={on:false,sx:0,sy:0,ox:0,oy:0};
cvs.addEventListener('mousedown',e=>{
  if(!e.target.closest || e.target===cvs || e.target.nodeName==='svg'){
    pan={on:true,sx:e.clientX,sy:e.clientY,ox:state.tx,oy:state.ty};
    cvs.classList.add('panning');
  }
});
window.addEventListener('mousemove',e=>{ if(!pan.on) return; state.tx=pan.ox+(e.clientX-pan.sx); state.ty=pan.oy+(e.clientY-pan.sy); renderDiagram(); });
window.addEventListener('mouseup',()=>{ pan.on=false; cvs.classList.remove('panning'); });
cvs.addEventListener('wheel',e=>{ e.preventDefault(); zoom(e.deltaY<0?1.1:0.9); },{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const overlay=document.getElementById('modal-overlay');
function openModal(n){
  state.commentTarget=n;
  document.getElementById('m-title').textContent=n.label;
  document.getElementById('m-sub').textContent=n.sub;
  const ex=state.comments.find(c=>c.target===n.id);
  document.getElementById('m-ta').value=ex?ex.text:'';
  overlay.classList.remove('hidden');
  setTimeout(()=>document.getElementById('m-ta').focus(),40);
}
function closeModal(){ overlay.classList.add('hidden'); state.commentTarget=null; }
function saveComment(){
  const txt=document.getElementById('m-ta').value.trim();
  const n=state.commentTarget;
  if(txt){
    const idx=state.comments.findIndex(c=>c.target===n.id);
    const entry={id:Date.now(),target:n.id,label:n.label,file:n.sub,text:txt};
    if(idx>=0) state.comments[idx]=entry; else state.comments.push(entry);
  } else {
    state.comments=state.comments.filter(c=>c.target!==n.id);
  }
  closeModal(); updateAll();
}
document.getElementById('m-cancel').onclick=closeModal;
document.getElementById('m-save').onclick=saveComment;
overlay.addEventListener('click',e=>{ if(e.target===overlay) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR â€” built with safe DOM methods
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSidebar(){
  // Presets
  const pg=document.getElementById('preset-grid');
  PRESETS.forEach(p=>{
    const b=el('button',{class:'preset-btn'+(state.preset===p.id?' active':''),'data-id':p.id,text:p.label});
    b.onclick=()=>applyPreset(p.id);
    pg.appendChild(b);
  });

  // Layers
  const ll=document.getElementById('layer-list');
  LAYERS.forEach(l=>{
    const chk=el('input',{type:'checkbox',id:'ly-'+l.id}); chk.checked=!!state.layers[l.id];
    const dot=el('div',{class:'layer-dot',style:'background:'+l.dot});
    const lbl=el('label',{class:'row-label','for':'ly-'+l.id},l.label);
    const row=el('div',{class:'check-row'},chk,dot,lbl);
    chk.onchange=ev=>{ state.layers[l.id]=ev.target.checked; state.preset=null; state.hi=null; updateAll(); };
    ll.appendChild(row);
  });

  // Conn types
  const cl=document.getElementById('conn-list');
  CTYPES.forEach(c=>{
    const chk=el('input',{type:'checkbox',id:'ct-'+c.id}); chk.checked=!!state.ctypes[c.id];
    const lineStyle=c.dash
      ? `border-top:2px dashed ${c.color};height:0;margin-top:2px`
      : `background:${c.color}`;
    const line=el('div',{class:'conn-dash',style:lineStyle});
    const lbl=el('label',{class:'row-label','for':'ct-'+c.id},c.label);
    const row=el('div',{class:'check-row'},chk,line,lbl);
    chk.onchange=ev=>{ state.ctypes[c.id]=ev.target.checked; state.preset=null; updateAll(); };
    cl.appendChild(row);
  });
}

function refreshSidebar(){
  // Preset buttons
  document.querySelectorAll('.preset-btn').forEach(b=>{ b.classList.toggle('active',b.dataset.id===state.preset); });
  // Layer checkboxes
  LAYERS.forEach(l=>{ const e=document.getElementById('ly-'+l.id); if(e) e.checked=!!state.layers[l.id]; });
  // Conn checkboxes
  CTYPES.forEach(c=>{ const e=document.getElementById('ct-'+c.id); if(e) e.checked=!!state.ctypes[c.id]; });
  // Comment count
  document.getElementById('cmt-count').textContent=String(state.comments.length);
  // Comment list â€” built with safe DOM methods
  const cl=document.getElementById('cmt-list');
  cl.textContent=''; // safe clear
  if(!state.comments.length){
    cl.appendChild(el('div',{class:'no-cmt'},'Click any node to annotate'));
    return;
  }
  state.comments.forEach(c=>{
    const delBtn=el('button',{class:'cc-del','data-id':String(c.id)},'Ã—');
    delBtn.onclick=()=>{ state.comments=state.comments.filter(x=>x.id!==c.id); updateAll(); };
    const titleDiv=el('div',{class:'cc-title'});
    titleDiv.appendChild(document.createTextNode(c.label));
    titleDiv.appendChild(delBtn);
    const textDiv=el('div',{class:'cc-text'}); textDiv.textContent=c.text;
    const card=el('div',{class:'comment-card'},titleDiv,textDiv);
    cl.appendChild(card);
  });
}

function applyPreset(id){
  const p=PRESETS.find(x=>x.id===id); if(!p) return;
  state.preset=id; state.hi=p.hi||null;
  LAYERS.forEach(l=>{ state.layers[l.id]=!p.layers||p.layers.includes(l.id); });
  CTYPES.forEach(c=>{ state.ctypes[c.id]=!p.ctypes||p.ctypes.includes(c.id); });
  updateAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePrompt(){
  const el2=document.getElementById('prompt-txt');
  const vis=LAYERS.filter(l=>state.layers[l.id]).map(l=>l.label);
  const hid=LAYERS.filter(l=>!state.layers[l.id]);
  let t='RecruiterOS architecture map';
  if(hid.length) t+=` â€” showing: ${vis.join(', ')}`;
  else t+=' â€” all 7 layers visible';
  t+='. 43 nodes across 8 layers: HTML Shell, 8 CDN Core Modules, 8 CDN View Groups (29 views), Wix Page Code (2705 lines, 119 inbound actions), 11 Backend Service clusters, 8 LLM Provider nodes (Anthropic/Claude PINNED for agents, Groq/LLaMA for speed, Google/Gemini for OCR+image, OpenAI, Mistral, Cohere, Safety), dataAccess.jsw dual-source router, Airtable (160+ tables), 4 External APIs (VAPI, Meta, FMCSA, Social).';
  if(state.comments.length){
    t+='\n\nAnnotations:\n';
    state.comments.forEach(c=>{ t+=`\n**${c.label}** (${c.file}):\n${c.text}\n`; });
  }
  el2.textContent=t;
}

document.getElementById('copy-btn').onclick=()=>{
  const txt=document.getElementById('prompt-txt').textContent;
  navigator.clipboard.writeText(txt).then(()=>{
    const b=document.getElementById('copy-btn'); b.textContent='Copied!'; b.classList.add('done');
    setTimeout(()=>{ b.textContent='Copy Prompt'; b.classList.remove('done'); },1600);
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateAll(){ renderDiagram(); refreshSidebar(); updatePrompt(); }
buildSidebar();
updateAll();
</script>
</body>
</html>
