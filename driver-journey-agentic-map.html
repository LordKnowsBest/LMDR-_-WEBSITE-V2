<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Driver Journey → Agentic Router Map</title>
<style>
:root{--bg:#0f1117;--s1:#1a1d27;--s2:#242836;--bd:#2e3348;--tx:#e2e8f0;--dm:#8892b0;
--green:#34d399;--blue:#60a5fa;--purple:#a78bfa;--yellow:#fbbf24;--red:#f87171;--cyan:#22d3ee;--orange:#fb923c;--pink:#f472b6;--lime:#a3e635;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--tx);font-family:'Inter',system-ui,sans-serif;height:100vh;overflow:hidden;}
.app{display:grid;grid-template-rows:52px 1fr 160px;height:100vh;}
.hdr{background:var(--s1);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 20px;gap:14px;}
.hdr h1{font-size:14px;font-weight:700;white-space:nowrap;} .hdr h1 span{color:var(--green);}
.hdr .tag{font-size:9px;padding:2px 7px;border-radius:4px;background:var(--purple);color:#fff;font-weight:700;letter-spacing:.5px;}
.hdr .view-btns{display:flex;gap:4px;margin-left:auto;}
.vb{padding:5px 12px;background:var(--s2);border:1px solid var(--bd);border-radius:5px;color:var(--dm);font-size:11px;cursor:pointer;transition:.15s;}
.vb:hover,.vb.active{border-color:var(--blue);color:var(--tx);background:#1e2640;}

.main{display:grid;grid-template-columns:1fr 340px;overflow:hidden;}
.canvas-area{overflow:auto;padding:24px;position:relative;}
.detail-panel{background:var(--s1);border-left:1px solid var(--bd);overflow-y:auto;padding:16px;}

.prompt-bar{background:var(--s1);border-top:1px solid var(--bd);padding:10px 20px;display:flex;flex-direction:column;gap:6px;}
.prompt-bar label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dm);}
.prompt-out{flex:1;background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;font-size:11px;line-height:1.6;color:var(--tx);overflow-y:auto;font-family:monospace;}
.copy-btn{align-self:flex-end;padding:4px 14px;background:var(--blue);border:none;border-radius:5px;color:#fff;font-size:11px;font-weight:600;cursor:pointer;}

/* Timeline */
.timeline{display:flex;gap:0;min-width:max-content;padding-bottom:20px;}
.phase-col{width:200px;flex-shrink:0;display:flex;flex-direction:column;position:relative;}
.phase-header{padding:10px 12px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;position:relative;z-index:2;}
.phase-header:hover{filter:brightness(1.2);}
.phase-header.active{box-shadow:0 0 0 2px var(--tx);}
.phase-num{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.7;}
.phase-name{font-size:12px;font-weight:700;margin-top:2px;line-height:1.3;}
.phase-xp{font-size:10px;margin-top:4px;opacity:.6;}
/* Connector arrow */
.phase-col:not(:last-child) .phase-header::after{content:'→';position:absolute;right:-14px;top:50%;transform:translateY(-50%);color:var(--dm);font-size:16px;z-index:3;}

.phase-body{border:1px solid var(--bd);border-top:none;border-radius:0 0 8px 8px;padding:8px;flex:1;background:var(--s1);min-height:200px;}

/* Router cards inside phase */
.router-card{background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:6px 8px;margin-bottom:4px;cursor:pointer;transition:.15s;font-size:10px;}
.router-card:hover{border-color:var(--blue);transform:translateY(-1px);}
.router-card.active{border-color:var(--green);box-shadow:0 0 0 1px var(--green);}
.rc-name{font-weight:700;font-family:monospace;font-size:10px;}
.rc-actions{color:var(--dm);font-size:9px;margin-top:2px;line-height:1.4;}
.rc-badge{display:inline-block;font-size:8px;padding:1px 5px;border-radius:3px;margin-left:4px;font-weight:600;}

/* Data pill */
.data-section{margin-top:8px;padding-top:6px;border-top:1px solid var(--bd);}
.data-pill{display:inline-block;font-size:8px;padding:2px 6px;border-radius:3px;background:var(--cyan);color:#000;margin:1px;font-weight:500;opacity:.8;}

/* Service pill */
.svc-pill{display:inline-block;font-size:8px;padding:2px 6px;border-radius:3px;background:var(--s2);border:1px solid var(--bd);color:var(--dm);margin:1px;}

/* Detail panel */
.dp-title{font-size:14px;font-weight:700;margin-bottom:4px;}
.dp-sub{font-size:10px;color:var(--dm);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;}
.dp-desc{font-size:11px;color:var(--dm);line-height:1.6;margin-bottom:12px;}
.dp-section{margin-bottom:14px;}
.dp-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dm);margin-bottom:6px;}
.action-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;font-family:monospace;border-bottom:1px solid #1e2030;}
.action-row:last-child{border:none;}
.risk-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.ap-tag{font-size:7px;padding:1px 4px;border-radius:3px;background:var(--red);color:#fff;font-weight:700;margin-left:auto;}
.phase-tag{font-size:7px;padding:1px 4px;border-radius:3px;background:var(--purple);color:#fff;margin-left:4px;}

/* Gamification bar */
.gam-bar{display:flex;align-items:center;gap:6px;margin-top:4px;}
.gam-xp{font-size:9px;color:var(--yellow);font-weight:700;}

/* Journey view - swimlane */
.swimlane-view{display:none;}
.swimlane-view.active{display:block;}
.timeline-view{display:block;}
.timeline-view.active{display:block;}
.swimlane-view .swim-row{display:flex;border-bottom:1px solid var(--bd);min-height:50px;}
.swim-label{width:160px;flex-shrink:0;padding:8px 10px;font-size:10px;font-weight:700;font-family:monospace;border-right:1px solid var(--bd);display:flex;align-items:center;gap:6px;}
.swim-cells{display:flex;flex:1;}
.swim-cell{width:120px;flex-shrink:0;padding:4px;border-right:1px solid #1a1d27;display:flex;flex-wrap:wrap;gap:2px;align-items:flex-start;align-content:flex-start;}
.swim-dot{width:8px;height:8px;border-radius:2px;cursor:pointer;transition:.15s;}
.swim-dot:hover{transform:scale(1.5);}
.swim-dot.approval{box-shadow:0 0 0 1px var(--red);}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px;}
</style>
</head>
<body>
<div class="app">
<div class="hdr">
  <h1><span>LMDR</span> Driver Journey → Agentic Router Map</h1>
  <span class="tag">9 PHASES · 7 ROUTERS · 83 ACTIONS</span>
  <div class="view-btns">
    <button class="vb active" data-view="timeline">Timeline</button>
    <button class="vb" data-view="swimlane">Swimlane</button>
  </div>
</div>

<div class="main">
  <div class="canvas-area" id="canvasArea"></div>
  <div class="detail-panel" id="detailPanel">
    <div class="dp-title">Driver Journey Map</div>
    <div class="dp-sub">Discovery → First Dispatch</div>
    <div class="dp-desc">Click a phase or router to see which agentic actions map to each journey stage. The 7 driver routers (83 actions) cover the full lifecycle from landing page to first dispatch.</div>
    <div class="dp-section">
      <div class="dp-section-title">Router Coverage</div>
      <div id="routerSummary"></div>
    </div>
  </div>
</div>

<div class="prompt-bar">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <label>Architecture Prompt</label>
    <button class="copy-btn" id="copyBtn">Copy</button>
  </div>
  <div class="prompt-out" id="promptOut"></div>
</div>
</div>

<script>
const RC={read:'#34d399',suggest:'#fbbf24',execute_low:'#fb923c',execute_high:'#f87171'};
const PHASE_COLORS=['#6366f1','#8b5cf6','#a78bfa','#60a5fa','#34d399','#22d3ee','#fbbf24','#fb923c','#f87171'];

// ═══════════════════════ JOURNEY DATA ═══════════════════════
const PHASES = [
  { id:1, name:'Discovery & Landing', short:'Discovery', xp:0,
    desc:'Driver finds platform via search/social/referral. Lands on SEO-optimized pages. Abandonment tracking begins.',
    pages:['landing/Homepage.HTML','CDL Class A page','OTR page'],
    services:['referralService','abandonmentEmailService'],
    data:['driverReferrals','abandonment events'],
    routers:{}, // no agent access yet
  },
  { id:2, name:'Signup & Profile', short:'Signup', xp:50,
    desc:'Account creation via Wix auth. Auto-creates driver profile (INCOMPLETE). Profile builder with completeness scoring. Welcome notification.',
    pages:['Wix signup flow'],
    services:['driverProfiles','gamificationService','featureAdoptionService','memberService'],
    data:['driverProfiles','driverProgression','gamificationEvents','referral conversion'],
    routers:{
      driver_cockpit:['update_profile','get_profile_strength','get_profile_suggestions','get_dashboard_summary','get_notifications'],
      driver_utility:['get_profile_strength_score'],
    },
  },
  { id:3, name:'Document Upload', short:'Documents', xp:50,
    desc:'CDL, MVR, Medical Card uploads with OCR extraction. Status flow: REQUESTED → UPLOADED → VERIFIED. 48hr reminder emails.',
    pages:['driver/DRIVER_DOCUMENT_UPLOAD.html'],
    services:['documentCollectionService','ocrService','emailService','emailTemplateService'],
    data:['documentRequests','OCR results','profile completeness','driverAchievements'],
    routers:{
      driver_cockpit:['upload_document'],
      driver_compliance:['upload_compliance_doc','get_compliance_docs','check_doc_expiry','get_expiring_docs'],
    },
  },
  { id:4, name:'AI Carrier Matching', short:'Matching', xp:150,
    desc:'Core value prop. Filter-based search with composite scoring (location 25%, pay 20%, ops 15%, turnover 12%, safety 10%). AI-enriched carrier cards. "Why You Matched" explanations.',
    pages:['driver/AI_MATCHING.html'],
    services:['carrierMatching','matchingService','matchExplanationService','aiEnrichment','mutualInterestService'],
    data:['driverMatches','enrichment cache','feature adoption','gamification events'],
    routers:{
      driver_cockpit:['search_jobs','get_job_details','get_matches','get_match_details','express_interest','dismiss_match','save_job','get_saved_jobs'],
      driver_road:['get_road_conditions','get_weather_forecast','get_weather_alerts'],
      driver_utility:['get_market_insights'],
    },
  },
  { id:5, name:'Application', short:'Apply', xp:50,
    desc:'Express interest / apply to carriers. Application pipeline: interested → applied → in_review → contacted → offer → hired. Confirmation emails, recruiter notifications.',
    pages:['driver/AI_MATCHING.html (apply action)'],
    services:['applicationService','driverLifecycleService','emailService','notificationDispatcher'],
    data:['driverCarrierInterests','driverLifecycleEvents','notifications','emails'],
    routers:{
      driver_cockpit:['quick_apply','withdraw_application','check_application_status','get_application_history'],
      driver_lifecycle:['get_driver_timeline','update_disposition'],
    },
  },
  { id:6, name:'Recruiter Contact', short:'Contact', xp:75,
    desc:'Driver Dashboard: applications list, activity timeline, chat with recruiters, availability picker for interviews, "Who Viewed Me", insights panel.',
    pages:['driver/DRIVER_DASHBOARD.html'],
    services:['messagingService','messaging','driverInsightsService','interviewScheduler'],
    data:['driverMessages','driverConversations','read receipts','orientationSlots','carrierDriverViews'],
    routers:{
      driver_cockpit:['send_message','get_messages','get_conversation','mark_read','get_unread_count','get_notifications'],
      driver_utility:['send_quick_response','set_reverse_alert'],
      driver_lifecycle:['get_driver_timeline'],
    },
  },
  { id:7, name:'Screening & BGC', short:'Screening', xp:75,
    desc:'Document verification, background check (ordered → processing → passed/failed), drug test (scheduled → completed → passed/failed). Workflow state machine. XP: +25 BGC consent submitted, +25 drug test completed, +25 verification passed.',
    pages:['driver/DRIVER_DASHBOARD.html (status view)'],
    services:['onboardingWorkflowService','documentCollectionService','emailService','notificationDispatcher'],
    data:['onboardingWorkflows','backgroundChecks','drugTests','documentRequests','auditLog'],
    routers:{
      driver_compliance:['get_compliance_docs','check_doc_expiry','get_hos_summary','get_training_courses'],
      driver_cockpit:['get_notifications','check_application_status'],
    },
  },
  { id:8, name:'Offer & Onboarding', short:'Onboarding', xp:700,
    desc:'Offer extended/accepted (+200 XP), remaining docs collected, compliance verified, orientation scheduled/completed, hired (+500 XP). Full workflow state: offer → compliance_verified → ready_to_start → completed.',
    pages:['driver/DRIVER_DASHBOARD.html','recruiter/RECRUITER_ONBOARDING_DASHBOARD.html'],
    services:['onboardingWorkflowService','documentCollectionService','emailService','driverLifecycleService','gamificationService','achievementService'],
    data:['onboardingWorkflows','orientationSlots','driverAchievements','driverProgression','driverLifecycleEvents'],
    routers:{
      driver_cockpit:['get_notifications','check_application_status','upload_document'],
      driver_compliance:['upload_compliance_doc','get_compliance_docs','get_certifications','get_training_courses','start_training','get_training_progress'],
      driver_lifecycle:['get_driver_timeline','update_disposition','get_pending_surveys','submit_survey_response'],
    },
  },
  { id:9, name:'Hire → First Dispatch', short:'Dispatch', xp:500,
    desc:'Active job header on dashboard. Career timeline. 30-day satisfaction survey. First dispatch logged. Post-hire: community, road utilities, health, future surveys. XP: +250 first dispatch milestone, +100 30-day survey completed, +150 community onboarding bonus.',
    pages:['driver/DRIVER_MY_CAREER.html'],
    services:['driverLifecycleService','surveyService','retentionService'],
    data:['driverLifecycleEvents','surveys','driverMatchFeedback','driverPerformance'],
    routers:{
      driver_lifecycle:['get_driver_timeline','get_pending_surveys','submit_survey_response','submit_match_feedback','update_disposition'],
      driver_cockpit:['get_dashboard_summary','get_notifications','search_jobs','get_matches'],
      driver_road:['find_parking','find_fuel_prices','get_weather_forecast','get_weather_alerts','get_road_conditions','get_weigh_station_status','find_rest_stops'],
      driver_community:['get_forum_posts','create_forum_post','reply_to_post','find_mentors','request_mentorship','search_pet_friendly_locations','get_health_resources','submit_health_tip'],
      driver_financial:['log_expense','get_expenses','get_expense_summary','get_settlement_history','calculate_trip_cost','get_tax_summary','get_per_diem_rates'],
      driver_utility:['get_profile_strength_score','get_market_insights'],
    },
  },
];

const ROUTERS = {
  driver_cockpit:{color:'#34d399',actions:23,desc:'Jobs, apps, messaging, profile, matches, dashboard, notifications'},
  driver_road:{color:'#22d3ee',actions:15,desc:'Parking, fuel, weigh stations, rest stops, weather, road conditions'},
  driver_community:{color:'#a78bfa',actions:14,desc:'Forums, mentorship, pet-friendly, health resources'},
  driver_compliance:{color:'#fbbf24',actions:12,desc:'Doc wallet, HOS, ELD, training, certifications'},
  driver_financial:{color:'#fb923c',actions:10,desc:'Expenses, settlements, trip costs, tax, per diem'},
  driver_lifecycle:{color:'#f472b6',actions:5,desc:'Timeline, disposition, surveys, feedback'},
  driver_utility:{color:'#60a5fa',actions:4,desc:'Profile strength, quick responses, reverse alerts, market insights'},
};

const ALL_ACTIONS = {
  driver_cockpit:[
    {n:'search_jobs',r:'read'},{n:'get_job_details',r:'read'},{n:'quick_apply',r:'execute_high',ap:1},{n:'save_job',r:'execute_low'},{n:'get_saved_jobs',r:'read'},
    {n:'withdraw_application',r:'execute_high',ap:1},{n:'check_application_status',r:'read'},{n:'get_application_history',r:'read'},
    {n:'send_message',r:'execute_low'},{n:'get_messages',r:'read'},{n:'get_conversation',r:'read'},{n:'mark_read',r:'execute_low'},{n:'get_unread_count',r:'read'},
    {n:'update_profile',r:'execute_low'},{n:'get_profile_strength',r:'read'},{n:'get_profile_suggestions',r:'suggest'},{n:'upload_document',r:'execute_high',ap:1},
    {n:'get_matches',r:'read'},{n:'get_match_details',r:'read'},{n:'express_interest',r:'execute_low'},{n:'dismiss_match',r:'execute_low'},
    {n:'get_dashboard_summary',r:'read'},{n:'get_notifications',r:'read'}],
  driver_road:[
    {n:'find_parking',r:'read'},{n:'get_parking_details',r:'read'},{n:'report_parking_availability',r:'execute_low'},{n:'save_favorite_parking',r:'execute_low'},
    {n:'find_fuel_prices',r:'read'},{n:'get_fuel_price_trends',r:'read'},{n:'calculate_fuel_cost',r:'suggest'},
    {n:'get_weigh_station_status',r:'read'},{n:'get_weigh_stations_on_route',r:'read'},{n:'find_rest_stops',r:'read'},{n:'rate_rest_stop',r:'execute_low'},
    {n:'get_weather_forecast',r:'read'},{n:'get_weather_alerts',r:'read'},{n:'get_road_conditions',r:'read'},{n:'report_road_hazard',r:'execute_low'}],
  driver_community:[
    {n:'get_forum_posts',r:'read'},{n:'create_forum_post',r:'execute_low'},{n:'reply_to_post',r:'execute_low'},{n:'like_post',r:'execute_low'},{n:'report_post',r:'execute_low'},{n:'search_forums',r:'read'},
    {n:'find_mentors',r:'read'},{n:'request_mentorship',r:'execute_low'},{n:'get_mentorship_status',r:'read'},{n:'rate_mentor',r:'execute_low'},
    {n:'search_pet_friendly_locations',r:'read'},{n:'submit_pet_friendly_location',r:'execute_low'},{n:'get_health_resources',r:'read'},{n:'submit_health_tip',r:'execute_low'}],
  driver_compliance:[
    {n:'upload_compliance_doc',r:'execute_high',ap:1},{n:'get_compliance_docs',r:'read'},{n:'check_doc_expiry',r:'read'},{n:'get_expiring_docs',r:'read'},
    {n:'get_hos_summary',r:'read'},{n:'log_hos_entry',r:'execute_low'},{n:'get_hos_violations',r:'read'},{n:'sync_eld_data',r:'execute_low'},
    {n:'get_training_courses',r:'read'},{n:'start_training',r:'execute_low'},{n:'get_training_progress',r:'read'},{n:'get_certifications',r:'read'}],
  driver_financial:[
    {n:'log_expense',r:'execute_low'},{n:'get_expenses',r:'read'},{n:'get_expense_summary',r:'read'},{n:'export_expenses',r:'read'},
    {n:'get_settlement_history',r:'read'},{n:'dispute_settlement',r:'execute_high',ap:1},{n:'calculate_trip_cost',r:'suggest'},
    {n:'get_tax_summary',r:'read'},{n:'get_deduction_suggestions',r:'suggest'},{n:'get_per_diem_rates',r:'read'}],
  driver_lifecycle:[
    {n:'get_driver_timeline',r:'read'},{n:'update_disposition',r:'execute_low'},{n:'get_pending_surveys',r:'read'},{n:'submit_survey_response',r:'execute_low'},{n:'submit_match_feedback',r:'execute_low'}],
  driver_utility:[
    {n:'get_profile_strength_score',r:'read'},{n:'send_quick_response',r:'execute_low'},{n:'set_reverse_alert',r:'execute_low'},{n:'get_market_insights',r:'read'}],
};

// ═══════════════════════ STATE ═══════════════════════
let selectedPhase = null, selectedRouter = null, currentView = 'timeline';

// ═══════════════════════ RENDER TIMELINE ═══════════════════════
function renderTimeline(){
  const area = document.getElementById('canvasArea');
  let html = '<div class="timeline" id="timelineView">';
  PHASES.forEach((p,i) => {
    const col = PHASE_COLORS[i];
    const routerKeys = Object.keys(p.routers);
    const actionCount = Object.values(p.routers).reduce((s,a)=>s+a.length,0);
    const isActive = selectedPhase === p.id;
    html += `<div class="phase-col">`;
    html += `<div class="phase-header ${isActive?'active':''}" style="background:${col}20;border:1px solid ${col}40" data-phase="${p.id}">`;
    html += `<div class="phase-num" style="color:${col}">Phase ${p.id}</div>`;
    html += `<div class="phase-name">${p.short}</div>`;
    if(p.xp) html += `<div class="phase-xp" style="color:var(--yellow);font-weight:700;">⚡ +${p.xp} XP</div>`;
    else html += `<div class="phase-xp" style="color:var(--red);font-weight:700;">⚠ 0 XP — Gap!</div>`;
    if(routerKeys.length===0) html += `<div class="phase-xp" style="color:var(--dm)">No agent access</div>`;
    else html += `<div class="phase-xp">${routerKeys.length} router${routerKeys.length>1?'s':''} · ${actionCount} actions</div>`;
    html += `</div>`;

    html += `<div class="phase-body">`;
    // Router cards
    routerKeys.forEach(rk => {
      const rdef = ROUTERS[rk];
      const actions = p.routers[rk];
      const isRActive = selectedRouter === rk;
      html += `<div class="router-card ${isRActive?'active':''}" data-router="${rk}" data-phase="${p.id}">`;
      html += `<div class="rc-name" style="color:${rdef.color}">${rk.replace('driver_','')}</div>`;
      html += `<div class="rc-actions">${actions.length}/${rdef.actions} actions active`;
      const approvals = actions.filter(a => {
        const def = ALL_ACTIONS[rk]?.find(d=>d.n===a);
        return def?.ap;
      });
      if(approvals.length) html += ` <span class="rc-badge" style="background:var(--red);color:#fff">${approvals.length} approval</span>`;
      html += `</div></div>`;
    });
    if(routerKeys.length===0){
      html += `<div style="font-size:10px;color:var(--dm);padding:8px;text-align:center;opacity:.6">Pre-platform<br/>No agent tools</div>`;
    }

    // Services
    if(p.services.length){
      html += `<div class="data-section"><div style="font-size:8px;color:var(--dm);margin-bottom:3px;font-weight:600">SERVICES</div>`;
      p.services.forEach(s => html += `<span class="svc-pill">${s}</span>`);
      html += `</div>`;
    }
    // Data
    if(p.data.length){
      html += `<div class="data-section"><div style="font-size:8px;color:var(--dm);margin-bottom:3px;font-weight:600">DATA</div>`;
      p.data.forEach(d => html += `<span class="data-pill">${d}</span>`);
      html += `</div>`;
    }
    html += `</div></div>`;
  });
  html += '</div>';
  area.innerHTML = html;
  bindTimeline();
}

// ═══════════════════════ RENDER SWIMLANE ═══════════════════════
function renderSwimlane(){
  const area = document.getElementById('canvasArea');
  let html = '<div style="min-width:max-content">';
  // Header row
  html += '<div style="display:flex;border-bottom:2px solid var(--bd);">';
  html += '<div style="width:160px;flex-shrink:0;padding:6px 10px;font-size:9px;font-weight:700;color:var(--dm);border-right:1px solid var(--bd);">ROUTER</div>';
  PHASES.forEach((p,i) => {
    html += `<div style="width:120px;flex-shrink:0;padding:6px 4px;font-size:8px;font-weight:700;text-align:center;color:${PHASE_COLORS[i]};border-right:1px solid #1a1d27;">P${p.id}: ${p.short}</div>`;
  });
  html += '</div>';

  // Router rows
  Object.entries(ROUTERS).forEach(([rk,rdef]) => {
    html += '<div class="swim-row">';
    html += `<div class="swim-label"><span class="risk-dot" style="background:${rdef.color}"></span>${rk.replace('driver_','')}<span style="color:var(--dm);font-size:8px;margin-left:auto;">${rdef.actions}</span></div>`;
    html += '<div class="swim-cells">';
    PHASES.forEach(p => {
      html += '<div class="swim-cell">';
      const actions = p.routers[rk] || [];
      actions.forEach(aName => {
        const aDef = ALL_ACTIONS[rk]?.find(d=>d.n===aName);
        const col = aDef ? RC[aDef.r] : '#475569';
        html += `<div class="swim-dot ${aDef?.ap?'approval':''}" style="background:${col}" title="${aName} (${aDef?.r||'?'})" data-action="${aName}" data-router="${rk}" data-phase="${p.id}"></div>`;
      });
      html += '</div>';
    });
    html += '</div></div>';
  });

  // Cross-cutting row
  html += '<div class="swim-row" style="background:var(--s2);">';
  html += '<div class="swim-label" style="color:var(--cyan);">AI Agent</div>';
  html += '<div class="swim-cells">';
  PHASES.forEach(p => {
    html += '<div class="swim-cell">';
    if(p.id >= 2) html += '<div style="font-size:7px;color:var(--cyan);padding:2px;">Available</div>';
    else html += '<div style="font-size:7px;color:var(--dm);padding:2px;">—</div>';
    html += '</div>';
  });
  html += '</div></div>';

  // Voice row
  html += '<div class="swim-row" style="background:var(--s2);">';
  html += '<div class="swim-label" style="color:var(--pink);">Voice Agent</div>';
  html += '<div class="swim-cells">';
  PHASES.forEach(p => {
    html += '<div class="swim-cell">';
    if(p.id >= 4) html += '<div style="font-size:7px;color:var(--pink);padding:2px;">Available</div>';
    else html += '<div style="font-size:7px;color:var(--dm);padding:2px;">—</div>';
    html += '</div>';
  });
  html += '</div></div>';

  // Gamification row
  html += '<div class="swim-row" style="background:var(--s2);">';
  let cumXP2 = 0;
  html += '<div class="swim-label" style="color:var(--yellow);">Gamification</div>';
  html += '<div class="swim-cells">';
  PHASES.forEach(p => {
    cumXP2 += p.xp;
    html += '<div class="swim-cell" style="flex-direction:column;justify-content:center;">';
    if(p.xp) html += `<div style="font-size:9px;color:var(--yellow);padding:1px 2px;font-weight:700;">+${p.xp}</div><div style="font-size:7px;color:var(--dm);padding:0 2px;">Σ${cumXP2}</div>`;
    else html += `<div style="font-size:7px;color:var(--red);padding:2px;">0 XP</div>`;
    html += '</div>';
  });
  html += '</div></div>';

  html += '</div>';
  area.innerHTML = html;
  bindSwimlane();
}

// ═══════════════════════ DETAIL PANEL ═══════════════════════
function showPhaseDetail(phaseId){
  selectedPhase = phaseId; selectedRouter = null;
  const p = PHASES.find(ph=>ph.id===phaseId);
  const dp = document.getElementById('detailPanel');
  const col = PHASE_COLORS[phaseId-1];
  let html = `<div class="dp-title" style="color:${col}">Phase ${p.id}: ${p.name}</div>`;
  html += `<div class="dp-sub">${Object.keys(p.routers).length} routers · ${Object.values(p.routers).reduce((s,a)=>s+a.length,0)} actions</div>`;
  html += `<div class="dp-desc">${p.desc}</div>`;

  if(p.xp){
    html += `<div class="gam-bar"><span class="gam-xp">+${p.xp} XP</span><span style="font-size:9px;color:var(--dm)">earned this phase</span></div>`;
  }

  Object.entries(p.routers).forEach(([rk, actions]) => {
    const rdef = ROUTERS[rk];
    html += `<div class="dp-section"><div class="dp-section-title" style="color:${rdef.color}">${rk} (${actions.length}/${rdef.actions})</div>`;
    actions.forEach(aName => {
      const aDef = ALL_ACTIONS[rk]?.find(d=>d.n===aName);
      html += `<div class="action-row"><span class="risk-dot" style="background:${aDef?RC[aDef.r]:'#475569'}"></span>${aName}`;
      if(aDef?.ap) html += `<span class="ap-tag">APPROVAL</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  });

  html += `<div class="dp-section"><div class="dp-section-title">Pages</div>`;
  p.pages.forEach(pg => html += `<div style="font-size:10px;font-family:monospace;color:var(--cyan);padding:2px 0;">${pg}</div>`);
  html += `</div>`;

  dp.innerHTML = html;
  render();updatePrompt();
}

function showRouterDetail(routerKey){
  selectedRouter = routerKey; selectedPhase = null;
  const rdef = ROUTERS[routerKey];
  const dp = document.getElementById('detailPanel');
  // Find which phases use this router
  const phasesUsing = PHASES.filter(p => p.routers[routerKey]);

  let html = `<div class="dp-title" style="color:${rdef.color}">${routerKey}</div>`;
  html += `<div class="dp-sub">driver router · ${rdef.actions} total actions</div>`;
  html += `<div class="dp-desc">${rdef.desc}</div>`;

  html += `<div class="dp-section"><div class="dp-section-title">Active in Phases</div>`;
  phasesUsing.forEach(p => {
    const actions = p.routers[routerKey];
    html += `<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;border-bottom:1px solid #1e2030;">`;
    html += `<span style="color:${PHASE_COLORS[p.id-1]};font-weight:700;">P${p.id}</span>${p.short} — ${actions.length} actions`;
    html += `</div>`;
  });
  html += `</div>`;

  html += `<div class="dp-section"><div class="dp-section-title">All ${rdef.actions} Actions</div>`;
  ALL_ACTIONS[routerKey].forEach(a => {
    // Find which phases use this action
    const inPhases = PHASES.filter(p => (p.routers[routerKey]||[]).includes(a.n));
    html += `<div class="action-row"><span class="risk-dot" style="background:${RC[a.r]}"></span>${a.n}`;
    if(a.ap) html += `<span class="ap-tag">APPROVAL</span>`;
    inPhases.forEach(p => html += `<span class="phase-tag" style="background:${PHASE_COLORS[p.id-1]}">P${p.id}</span>`);
    if(inPhases.length===0) html += `<span style="font-size:7px;color:var(--dm);margin-left:auto;">post-hire only</span>`;
    html += `</div>`;
  });
  html += `</div>`;

  dp.innerHTML = html;
  render();updatePrompt();
}

function showDefaultDetail(){
  selectedPhase=null;selectedRouter=null;
  const dp=document.getElementById('detailPanel');
  let html=`<div class="dp-title">Driver Journey Map</div><div class="dp-sub">Discovery → First Dispatch</div>`;
  html+=`<div class="dp-desc">Click a phase or router to see which agentic actions map to each journey stage. The 7 driver routers (83 actions) cover the full lifecycle.</div>`;
  html+=`<div class="dp-section"><div class="dp-section-title">Router Coverage by Phase</div>`;
  Object.entries(ROUTERS).forEach(([rk,rdef])=>{
    const phasesUsing=PHASES.filter(p=>p.routers[rk]);
    const totalMapped=phasesUsing.reduce((s,p)=>s+(p.routers[rk]||[]).length,0);
    html+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 0;font-size:10px;border-bottom:1px solid #1e2030;cursor:pointer;" data-router-link="${rk}">`;
    html+=`<span class="risk-dot" style="background:${rdef.color}"></span><span style="font-family:monospace;font-weight:600;">${rk.replace('driver_','')}</span>`;
    html+=`<span style="color:var(--dm);margin-left:auto;">${totalMapped}/${rdef.actions} mapped · P${phasesUsing.map(p=>p.id).join(',P')}</span>`;
    html+=`</div>`;
  });
  html+=`</div>`;
  html+=`<div class="dp-section"><div class="dp-section-title">Gamification XP Progression</div>`;
  let cumXP=0;
  PHASES.forEach(p=>{
    cumXP+=p.xp;
    if(p.xp){
      html+=`<div style="font-size:10px;padding:3px 0;display:flex;align-items:center;gap:6px;border-bottom:1px solid #1e2030;"><span style="color:${PHASE_COLORS[p.id-1]};font-weight:700;width:24px;">P${p.id}</span><span style="color:var(--yellow);font-weight:700;width:60px;">+${p.xp} XP</span><span style="color:var(--dm);font-size:9px;">${p.short}</span><span style="color:var(--dm);margin-left:auto;font-size:9px;">Σ ${cumXP}</span></div>`;
    } else {
      html+=`<div style="font-size:10px;padding:3px 0;display:flex;align-items:center;gap:6px;border-bottom:1px solid #1e2030;opacity:.5;"><span style="color:${PHASE_COLORS[p.id-1]};font-weight:700;width:24px;">P${p.id}</span><span style="color:var(--dm);width:60px;">0 XP</span><span style="color:var(--dm);font-size:9px;">${p.short} (pre-platform)</span><span style="color:var(--dm);margin-left:auto;font-size:9px;">Σ ${cumXP}</span></div>`;
    }
  });
  const totalXP = PHASES.reduce((s,p)=>s+p.xp,0);
  html+=`<div style="font-size:11px;padding:6px 0;font-weight:700;color:var(--yellow);display:flex;justify-content:space-between;">
    <span>Total Journey XP</span><span>${totalXP} XP</span></div>`;
  html+=`</div>`;
  dp.innerHTML=html;
  dp.querySelectorAll('[data-router-link]').forEach(el=>el.addEventListener('click',()=>showRouterDetail(el.dataset.routerLink)));
  updatePrompt();
}

// ═══════════════════════ BINDINGS ═══════════════════════
function bindTimeline(){
  document.querySelectorAll('.phase-header[data-phase]').forEach(el=>el.addEventListener('click',()=>showPhaseDetail(+el.dataset.phase)));
  document.querySelectorAll('.router-card[data-router]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();showRouterDetail(el.dataset.router);}));
}
function bindSwimlane(){
  document.querySelectorAll('.swim-dot').forEach(el=>el.addEventListener('click',()=>{
    const rk=el.dataset.router;if(rk)showRouterDetail(rk);
  }));
}

function render(){
  if(currentView==='timeline')renderTimeline();
  else renderSwimlane();
}

// ═══════════════════════ VIEWS ═══════════════════════
document.querySelectorAll('.vb').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.vb').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
    currentView=btn.dataset.view;render();
  });
});

// ═══════════════════════ PROMPT ═══════════════════════
function updatePrompt(){
  const el=document.getElementById('promptOut');
  if(selectedPhase){
    const p=PHASES.find(ph=>ph.id===selectedPhase);
    const rks=Object.keys(p.routers);
    const acts=Object.values(p.routers).flat();
    let t=`Phase ${p.id}: ${p.name}\n${p.desc}\n\n`;
    t+=`Agentic coverage: ${rks.length} router(s), ${acts.length} actions available\n`;
    rks.forEach(rk=>{t+=`  ${rk}: ${p.routers[rk].join(', ')}\n`;});
    t+=`\nData flow: User interacts via ${p.pages[0]||'HTML page'} → postMessage → Page Code → agentService.handleAgentTurn('driver', userId, msg)\n`;
    t+=`  → AI sees ${rks.length} router tool(s): ${rks.join(', ')}\n`;
    t+=`  → AI picks router + action → ACTION_REGISTRY dispatch → service call → response\n`;
    if(p.xp)t+=`\nGamification: +${p.xp} XP earned this phase`;
    el.textContent=t;
  } else if(selectedRouter){
    const rdef=ROUTERS[selectedRouter];
    const phasesUsing=PHASES.filter(p=>p.routers[selectedRouter]);
    let t=`Router: ${selectedRouter}\n${rdef.desc}\n\n`;
    t+=`${rdef.actions} total actions · Active in ${phasesUsing.length} of 9 phases\n`;
    t+=`Phases: ${phasesUsing.map(p=>`P${p.id}(${p.short})`).join(', ')}\n\n`;
    t+=`AI tool definition:\n  { name: '${selectedRouter}', input: { action: '<enum of ${rdef.actions}>', params: {...} } }\n\n`;
    t+=`Dispatch: executeTool('${selectedRouter}', {action, params}) → ACTION_REGISTRY['${selectedRouter}'][action] → serviceModule.fn(...args)`;
    el.textContent=t;
  } else {
    let t=`LMDR Driver Journey → Agentic Router Map\n`;
    t+=`9 phases · 7 domain routers · 83 actions\n\n`;
    t+=`Journey: Discovery → Signup → Documents → AI Matching → Application → Recruiter Contact → Screening → Onboarding → First Dispatch\n\n`;
    t+=`Router dispatch pattern: AI sees 7 router tools (not 83 flat schemas)\n`;
    t+=`  Each router has action enum → ACTION_REGISTRY resolves to service call\n`;
    t+=`  Token savings: ~83% vs flat tool definitions\n\n`;
    t+=`Click a phase to see active routers/actions. Click a router to see which phases it spans.`;
    el.textContent=t;
  }
}

document.getElementById('copyBtn').addEventListener('click',()=>{
  navigator.clipboard.writeText(document.getElementById('promptOut').textContent).then(()=>{
    const b=document.getElementById('copyBtn');b.textContent='Copied!';setTimeout(()=>b.textContent='Copy',1500);
  });
});

// ═══════════════════════ INIT ═══════════════════════
renderTimeline();showDefaultDetail();updatePrompt();
</script>
</body>
</html>
