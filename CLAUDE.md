# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Critical Workflow Rule: Sync = Commit + Push

**IMPORTANT:** When the user says "sync" (in any form - "sync", "sync it", "sync to wix", etc.), you MUST:
1. Stage all changes: `git add -A`
2. Commit with a descriptive message: `git commit -m "description"`
3. Push to remote: `git push`

This is required because Wix syncs from the GitHub repository. Without pushing, changes won't appear in Wix.

## Production Website URL

**Base URL:** `https://www.lastmiledr.app`

When writing redirects or links in HTML components (especially within Wix iframes), always use the full absolute URL:

```javascript
// CORRECT - Full URL required for iframe context
const baseUrl = 'https://www.lastmiledr.app';
window.top.location.href = baseUrl + '/pricing';

// WRONG - Relative paths don't resolve correctly in Wix iframes
window.top.location.href = '/pricing';
```

## Project Overview

LMDR (Last Mile Driver Recruiting) is a Wix Velo site for matching CDL truck drivers with carriers. The site uses AI-powered enrichment to provide drivers with detailed carrier intelligence including FMCSA safety data, pay information, driver sentiment, and social media analysis.

## Development Commands

```bash
npm install          # Install dependencies (runs wix sync-types via postinstall)
npm run dev          # Start Local Editor for real-time testing (wix dev)
npm run lint         # Run ESLint
```

The Wix CLI must be installed globally: `npm install -g @wix/cli`

## Critical Data Routing: Dual-Source Pattern (Wix + Airtable)

**CRITICAL RULE:** This project uses a dual-source data architecture where most data routes to **Airtable** for visibility, while auth-related data stays in **Wix**.

**NEVER call `wixData.*` directly in business logic functions.** Always use the dual-source helper functions.

### Collections That Stay in Wix (ONLY THESE TWO)

| Collection | Reason |
|------------|--------|
| `AdminUsers` | Auth/permissions - must stay in Wix |
| `MemberNotifications` | Wix member system integration |

**Everything else (~65+ collections) routes to Airtable.**

### Config File Reference

Routing is controlled by `backend/config.jsw`:
- `usesAirtable(collectionKey)` - Returns `true` if collection routes to Airtable
- `getAirtableTableName(collectionKey)` - Returns the Airtable table name

### Airtable Base Reference

| Base | ID | Purpose |
|------|-----|---------|
| Last Mile Driver recruiting | `app9N1YCJ3gdhExA0` | All application data (v2_* tables) |
| VelocityMatch DataLake | `appt00rHHBOiKx9xl` | External data feeds (fuel, weather, traffic) |

**New feature tables go in `Last Mile Driver recruiting` base.**

> **Full details:** Helper implementations, audit checklists, field mapping tables, and step-by-step workflows are in `.claude/docs/airtable-routing.md` (auto-injected when editing backend files).

## Import Conventions

Wix Velo requires specific import syntax:
```javascript
import { fn } from 'backend/fileName';   // Backend modules
import { fn } from 'public/fileName';    // Public modules
```
Do NOT use relative paths like `./fileName` - they don't work in Wix.

## Page Code (src/pages/*.js)

Page code files are auto-generated by Wix and named `PageName.xxxxx.js`. Do not rename these files. The `masterPage.js` file contains global site code.

## Scheduled Jobs

Configured in `src/backend/jobs.config`:
- `runEnrichmentBatch` runs hourly (`0 * * * *`) - Pre-enriches high-priority carriers with AI data
- `runBackfillMigration` runs every 30 min (`30 * * * *`) - Ensures submitted drivers are searchable
- `processAbandonmentEmails` runs every 15 min (`15 * * * *`) - Checkout abandonment email sequences

## Web Module Permissions

Permissions are defined in `src/backend/permissions.json`. Current config allows all users (anonymous, member, owner) to invoke all web methods.

## File Organization Standards

### Surface Branding (Enforced by Hook)

**Non-driver surfaces use VelocityMatch branding. Driver surfaces keep LMDR.**

| Surface | Brand | Logo Icon |
|---------|-------|-----------|
| `driver/` | LMDR | LM |
| Everything else | VelocityMatch | VM |

A PostToolUse hook (`enforce-surface-branding.ps1`) blocks any Write/Edit that introduces LMDR branding into non-driver HTML files.

### HTML Files

**All HTML files are organized in `src/public/` subfolders by role:**

**Standard:** See `docs/MOBILE_OPTIMIZATION_GUIDE.md` for mandatory mobile responsiveness rules (iPhone 12/13 target).

```
src/public/
├── admin/      # Admin portal (ADMIN_*.html)
├── recruiter/  # Recruiter portal (Recruiter*.html)
├── driver/     # Driver portal (DRIVER_*.html, AI_MATCHING.html)
├── carrier/    # Carrier portal (Carrier*.html)
├── landing/    # Landing & marketing pages
├── utility/    # System components, templates, emails
├── _archive/   # Deprecated files (do not use)
├── js/         # JavaScript modules
├── __tests__/  # Test files
└── [root]      # Shared config (lmdr-config.js, theme-*.js/css)
```

**DO NOT place HTML files in:** `docs/`, root directory, `src/backend/`, or `src/pages/`.

### Tailwind Config in Wix Iframes (Critical)

**Do NOT rely on external `lmdr-config.js` in HTML files loaded inside Wix iframes.**
The external config does not load reliably in Wix HTML components.

**Required pattern: Inline Tailwind config immediately after the Tailwind CDN script.**
Use the same inline config as `src/public/landing/Homepage.HTML` and remove:
`<script src="../lmdr-config.js"></script>`.

### Test Files

**All test files MUST be placed in `src/public/__tests__/`**
- Naming convention: `*.test.js` or `*.spec.js`

## Wix MCP Configuration

**IMPORTANT: When using any Wix MCP tools in this project, ALWAYS use this site:**

| Property | Value |
|----------|-------|
| **Site Name** | Last Mile CDL Driver Recruiting |
| **Site ID** | `13e6ba60-5a5d-4a4a-8adc-5948ff78d4ef` |

Always use this site ID. Never prompt the user to select a site.

## UI Safety Pattern

When interacting with UI elements in Velo, always check for existence:

```javascript
const element = $w('#optionalElement');
if (element.rendered) {
    element.text = "Value";
}
```

## Context Documents

Supplementary docs are auto-injected by hooks when editing relevant files. They can also be referenced manually with `@.claude/docs/<filename>`.

| Document | Auto-injected when | Contents |
|----------|-------------------|----------|
| `airtable-routing.md` | Editing `src/backend/*.jsw` | Helper implementations, checklists, field mappings |
| `architecture-reference.md` | Manual reference only | All backend services, collections, API keys |
| `carrier-staffing-forms.md` | Editing carrier/staffing HTML | Form template, PostMessage bridge |
| `wix-record-linking.md` | Editing record-linking services | Type mismatch gotcha, linking pattern |
| `gamification-integration.md` | Editing gamification services | Integration hooks table, lazy-load pattern |
| `pricing-and-tiers.md` | Editing Stripe/subscription files | Tiers, VelocityMatch pricing, Stripe IDs |
| `surface-branding.md` | Editing non-driver HTML files | Brand-per-surface table, prohibited patterns |
