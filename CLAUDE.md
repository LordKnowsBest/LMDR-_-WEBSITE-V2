# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Critical Workflow Rule: Sync = Commit + Push

**IMPORTANT:** When the user says "sync" (in any form - "sync", "sync it", "sync to wix", etc.), you MUST:
1. Stage all changes: `git add -A`
2. Commit with a descriptive message: `git commit -m "description"`
3. Push to remote: `git push`

This is required because Wix syncs from the GitHub repository. Without pushing, changes won't appear in Wix.

## Production Website URL

**Base URL:** `https://www.lastmiledr.app`

When writing redirects or links in HTML components (especially within Wix iframes), always use the full absolute URL:

```javascript
// CORRECT - Full URL required for iframe context
const baseUrl = 'https://www.lastmiledr.app';
window.top.location.href = baseUrl + '/pricing';

// WRONG - Relative paths don't resolve correctly in Wix iframes
window.top.location.href = '/pricing';
```

## Project Overview

LMDR (Last Mile Driver Recruiting) is a Wix Velo site for matching CDL truck drivers with carriers. The site uses AI-powered enrichment to provide drivers with detailed carrier intelligence including FMCSA safety data, pay information, driver sentiment, and social media analysis.

## Development Commands

```bash
npm install          # Install dependencies (runs wix sync-types via postinstall)
npm run dev          # Start Local Editor for real-time testing (wix dev)
npm run lint         # Run ESLint
```

The Wix CLI must be installed globally: `npm install -g @wix/cli`

## Critical Data Routing: Dual-Source Pattern (Wix + Airtable)

**CRITICAL RULE:** This project uses a dual-source data architecture where most data routes to **Airtable** for visibility, while auth-related data stays in **Wix**.

**NEVER call `wixData.*` directly in business logic functions.** Always use the dual-source helper functions.

### Collections That Stay in Wix (ONLY THESE TWO)

| Collection | Reason |
|------------|--------|
| `AdminUsers` | Auth/permissions - must stay in Wix |
| `MemberNotifications` | Wix member system integration |

**Everything else (~65+ collections) routes to Airtable.**

### Config File Reference

Routing is controlled by `backend/config.jsw`:
- `usesAirtable(collectionKey)` - Returns `true` if collection routes to Airtable
- `getAirtableTableName(collectionKey)` - Returns the Airtable table name

### Airtable Base Reference

| Base | ID | Purpose |
|------|-----|---------|
| Last Mile Driver recruiting | `app9N1YCJ3gdhExA0` | All application data (v2_* tables) |
| VelocityMatch DataLake | `appt00rHHBOiKx9xl` | External data feeds (fuel, weather, traffic) |

**New feature tables go in `Last Mile Driver recruiting` base.**

> **Full details:** Helper implementations, audit checklists, field mapping tables, and step-by-step workflows are in `.claude/docs/airtable-routing.md` (auto-injected when editing backend files).

## Import Conventions

Wix Velo requires specific import syntax:
```javascript
import { fn } from 'backend/fileName';   // Backend modules
import { fn } from 'public/fileName';    // Public modules
```
Do NOT use relative paths like `./fileName` - they don't work in Wix.

## Page Code (src/pages/*.js)

Page code files are auto-generated by Wix and named `PageName.xxxxx.js`. Do not rename these files. The `masterPage.js` file contains global site code.

## Scheduled Jobs

Configured in `src/backend/jobs.config`:
- `runEnrichmentBatch` runs hourly (`0 * * * *`) - Pre-enriches high-priority carriers with AI data
- `runBackfillMigration` runs every 30 min (`30 * * * *`) - Ensures submitted drivers are searchable
- `processAbandonmentEmails` runs every 15 min (`15 * * * *`) - Checkout abandonment email sequences

## Web Module Permissions

Permissions are defined in `src/backend/permissions.json`. Current config allows all users (anonymous, member, owner) to invoke all web methods.

## File Organization Standards

### Surface Branding (Enforced by Hook)

**Non-driver surfaces use VelocityMatch branding. Driver surfaces keep LMDR.**

| Surface | Brand | Logo Icon |
|---------|-------|-----------|
| `driver/` | LMDR | LM |
| Everything else | VelocityMatch | VM |

A PostToolUse hook (`enforce-surface-branding.ps1`) blocks any Write/Edit that introduces LMDR branding into non-driver HTML files.

### HTML Files

**All HTML files are organized in `src/public/` subfolders by role:**

**Standard:** See `docs/MOBILE_OPTIMIZATION_GUIDE.md` for mandatory mobile responsiveness rules (iPhone 12/13 target).

```
src/public/
├── admin/      # Admin portal (ADMIN_*.html)
├── recruiter/  # Recruiter portal (Recruiter*.html)
├── driver/     # Driver portal (DRIVER_*.html, AI_MATCHING.html)
├── carrier/    # Carrier portal (Carrier*.html)
├── landing/    # Landing & marketing pages
├── utility/    # System components, templates, emails
├── _archive/   # Deprecated files (do not use)
├── js/         # JavaScript modules
├── __tests__/  # Test files
└── [root]      # Shared config (lmdr-config.js, theme-*.js/css)
```

**DO NOT place HTML files in:** `docs/`, root directory, `src/backend/`, or `src/pages/`.

### Tailwind Config in Wix Iframes (Critical)

**Do NOT rely on external `lmdr-config.js` in HTML files loaded inside Wix iframes.**
The external config does not load reliably in Wix HTML components.

**Required pattern: Inline Tailwind config immediately after the Tailwind CDN script.**
Use the same inline config as `src/public/landing/Homepage.HTML` and remove:
`<script src="../lmdr-config.js"></script>`.

### Test Files

**All test files MUST be placed in `src/public/__tests__/`**
- Naming convention: `*.test.js` or `*.spec.js`

## Wix MCP Configuration

**IMPORTANT: When using any Wix MCP tools in this project, ALWAYS use this site:**

| Property | Value |
|----------|-------|
| **Site Name** | Last Mile CDL Driver Recruiting |
| **Site ID** | `13e6ba60-5a5d-4a4a-8adc-5948ff78d4ef` |

Always use this site ID. Never prompt the user to select a site.

## Batch Processing Pattern (Required)

**CRITICAL:** All batch operations must use chunked parallel processing to prevent timeouts.

**Import:** `import { chunkArray } from 'backend/utils/arrayUtils';`

**Pattern:**
```javascript
import { chunkArray } from 'backend/utils/arrayUtils';

// 1. Cache table name ONCE before loop
const tableName = await getAirtableTableName(COLLECTION_KEY);

// 2. Filter valid items
const validItems = items.filter(item => item.requiredField);

// 3. Chunk and process in parallel
const chunks = chunkArray(validItems, 10);

for (const chunk of chunks) {
  const results = await Promise.all(
    chunk.map(async (item) => {
      try {
        await airtable.updateRecord(tableName, item.id, { /* fields */ });
        return { success: true };
      } catch (error) {
        return { success: false, id: item.id, error: error.message };
      }
    })
  );

  // 4. Rate limit between chunks (200ms = 5 req/sec)
  await new Promise(r => setTimeout(r, 200));
}
```

| Operation | Chunk Size | Rationale |
|-----------|------------|-----------|
| Airtable CRUD | 10 | API rate limit |
| Notifications | 10 | Rate balance |
| Email sending | 5 | Provider limits |
| Simple updates | 50 | High volume, low complexity |

## UI Safety Pattern (Enforced by Hook)

When interacting with UI elements in Velo, always check for existence before accessing properties or methods.

A PostToolUse hook (`enforce-selector-safety.ps1`) blocks any Write/Edit to page code (`src/pages/*.js`) that uses `$w('#elementId')` without a safety check.

**Accepted patterns:**

```javascript
// Option 1: Use .rendered check (preferred)
const element = $w('#optionalElement');
if (element.rendered) {
    element.text = "Value";
}

// Option 2: Check element && property exists
const el = $w('#myButton');
if (el && el.onClick) {
    el.onClick(() => { /* handler */ });
}

// Option 3: Wrap in try-catch
try {
    $w('#optionalElement').postMessage(data);
} catch (e) {
    // Element may not exist on page
}
```

**Blocked patterns:**

```javascript
// WRONG - No existence check
$w('#submitButton').onClick(() => { });
$w('#statusText').text = "Loading...";
$w('#html1').postMessage({ type: 'init' });
```

## Context Documents

Supplementary docs are auto-injected by hooks when editing relevant files. They can also be referenced manually with `@.claude/docs/<filename>`.

| Document | Auto-injected when | Contents |
|----------|-------------------|----------|
| `airtable-routing.md` | Editing `src/backend/*.jsw` | Helper implementations, checklists, field mappings |
| `architecture-reference.md` | Manual reference only | All backend services, collections, API keys |
| `carrier-staffing-forms.md` | Editing carrier/staffing HTML | Form template, PostMessage bridge |
| `wix-record-linking.md` | Editing record-linking services | Type mismatch gotcha, linking pattern |
| `gamification-integration.md` | Editing gamification services | Integration hooks table, lazy-load pattern |

## New Services (2026-02-01)

### Match Explanation Service
**File:** `src/backend/matchExplanationService.jsw`
- **Purpose:** Generates driver-facing "Why You Matched" rationale.
- **Key Method:** `getMatchExplanationForDriver(driverId, carrierDot)`
- **Dependencies:** `driverScoring.js`, `carrierPreferences.jsw`

### Recruiter Health Service
**File:** `src/backend/recruiterHealthService.jsw`
- **Purpose:** Monitors system health (Database, AI, Enrichment, FMCSA) for recruiters.
- **Key Method:** `getRecruiterHealthStatus(carrierDot)`
- **Features:** 30s Caching, Aggregated Status ('operational'|'degraded'|'outage').

### Pet Friendly Service
**File:** `src/backend/petFriendlyService.jsw`
- **Purpose:** Manages crowdsourced pet-friendly locations and reviews.
- **Key Methods:** `searchLocations(filters)`, `submitLocation(data)`, `submitReview(locationId, reviewData)`
- **Features:** Proximity search, amenity filtering, automatic rating aggregation.

### Health Service
**File:** `src/backend/healthService.jsw`
- **Purpose:** Manages trucker health content and community tips.
- **Key Methods:** `getResourcesByCategory(cat)`, `submitTip(data)`, `getApprovedTips(cat)`
- **Features:** Content categorization, community submission moderation, helpfulness tracking.

## Page Code Wiring (Priority 1)

All 9 Priority 1 pages follow a shared wiring pattern connecting Wix page code to HTML iframe components via `postMessage`.

### Page Reference Table

| Page File | Backend Service(s) | HTML File | Notes |
|-----------|-------------------|-----------|-------|
| `ADMIN_DASHBOARD.svo6l.js` | `admin_dashboard_service`, `featureAdoptionService` | `admin/ADMIN_DASHBOARD.html` | Multi-component (all 6 IDs), navigation via `wixLocation` |
| `ADMIN_DRIVERS.uo7vb.js` | `admin_service` | `admin/ADMIN_DRIVERS.html` | Single-component (first found), bulk ops, CSV export |
| `ADMIN_CARRIERS.qa2w1.js` | `carrierAdminService` | `admin/ADMIN_CARRIERS.html` | Multi-component, FMCSA external link, enrichment refresh |
| `ADMIN_OBSERVABILITY.c8pf9.js` | `observabilityService` | `admin/ADMIN_OBSERVABILITY.html` | Single-component, sends initial data bundle on ready |
| `ADMIN_MATCHES.gqhdo.js` | `admin_match_service` | `admin/ADMIN_MATCHES.html` | Single-component, interest tracking, trend analytics |
| `ADMIN_AI_ROUTER.cqkgi.js` | `aiRouterService` | `admin/ADMIN_AI_ROUTER.html` | Multi-component, provider testing, config CRUD |
| `RECRUITER_ONBOARDING_DASHBOARD.gebww.js` | `onboardingWorkflowService`, `documentCollectionService`, `recruiter_service` | `recruiter/RECRUITER_ONBOARDING_DASHBOARD.html` | Uses `type` key (not `action`), auth check via `wix-users`, message registry validation |
| `B2B_DASHBOARD.i5csc.js` | `b2bBridgeService` | `admin/B2B_DASHBOARD.html` | Unified bridge pattern (`handleB2BAction`), navigation to account detail |
| `B2B_ACCOUNT_DETAIL.f31mi.js` | `b2bAccountService`, `b2bMatchSignalService`, `b2bPipelineService`, `b2bActivityService`, `b2bResearchAgentService` | `admin/B2B_ACCOUNT_DETAIL.html` | Reads `accountId` from URL query, auto-refreshes timeline after actions |

### Common Wiring Pattern

All pages follow this structure:

1. **Component Discovery** -- Iterate `HTML_COMPONENT_IDS` (`#html1`..`#html5`, `#htmlEmbed1`) inside try-catch, check `typeof el.onMessage === 'function'`.
2. **Message Listener** -- Call `component.onMessage(async (event) => routeMessage(component, event?.data))`.
3. **Init Signal** -- Send `{ action: 'init' }` to tell the HTML the bridge is ready.
4. **Message Router** -- A `switch` on `message.action` dispatches to async handler functions.
5. **Safe Send** -- A `safeSend` / `sendMessage` / `postToComponent` helper wraps `postMessage` in try-catch to guard against detached elements.

### Message Type Conventions

All pages (except Recruiter Onboarding) use an **action-based protocol**:

| Direction | Shape | Example |
|-----------|-------|---------|
| Velo -> HTML | `{ action: '<verb>', payload }` | `{ action: 'driversLoaded', payload: { drivers, totalCount } }` |
| HTML -> Velo | `{ action: '<verb>', ...params }` | `{ action: 'getDrivers', filters, page, pageSize }` |
| Error (any) | `{ action: 'actionError', message }` | `{ action: 'actionError', message: 'Failed to load' }` |
| Success (any) | `{ action: 'actionSuccess', message }` | `{ action: 'actionSuccess', message: 'Driver verified' }` |

**Exception:** `RECRUITER_ONBOARDING_DASHBOARD` uses `{ type, data, timestamp }` envelope instead of `{ action, payload }`, and validates messages against a `MESSAGE_REGISTRY` object.

