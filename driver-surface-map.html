<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Surface Architecture Map</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0f1117; color: #e2e8f0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 13px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}
#app { display: flex; flex: 1; overflow: hidden; }
#sidebar {
  width: 232px; background: #161b27; border-right: 1px solid #2d3748;
  display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;
}
.ss { padding: 11px 13px; border-bottom: 1px solid #2d3748; }
.stitle { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #4a5568; margin-bottom: 7px; }
.preset-btn {
  display: block; width: 100%; padding: 6px 9px; margin-bottom: 3px;
  background: #1e2535; border: 1px solid #2d3748; border-radius: 5px;
  color: #a0aec0; text-align: left; cursor: pointer; font-size: 12px; transition: all 0.12s;
}
.preset-btn:hover { background: #2d3748; color: #e2e8f0; }
.preset-btn.active { background: #1a4a2e; border-color: #22c55e; color: #86efac; font-weight: 600; }
.trow { display: flex; align-items: center; gap: 7px; margin-bottom: 5px; cursor: pointer; }
.trow input[type="checkbox"] { accent-color: #22c55e; cursor: pointer; }
.ldot { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
.zoom-controls { display: flex; gap: 4px; }
.zbtn { flex: 1; padding: 5px 4px; background: #1e2535; border: 1px solid #2d3748; border-radius: 4px; color: #a0aec0; cursor: pointer; font-size: 13px; font-weight: bold; }
.zbtn:hover { background: #2d3748; color: #e2e8f0; }
.citem { background: #1e2535; border: 1px solid #2d3748; border-radius: 5px; padding: 7px 28px 7px 8px; margin-bottom: 5px; font-size: 11px; position: relative; }
.ctarget { font-weight: 600; color: #86efac; margin-bottom: 2px; }
.ctext { color: #a0aec0; line-height: 1.4; }
.cdel { position: absolute; top: 4px; right: 6px; background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px; }
#canvas-wrap {
  flex: 1; overflow: hidden; position: relative; background: #090d18;
  background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.04) 1px, transparent 0);
  background-size: 22px 22px;
}
#canvas { width: 100%; height: 100%; cursor: grab; display: block; }
#canvas:active { cursor: grabbing; }
#zoom-ind { position: absolute; top: 8px; right: 8px; background: rgba(22,27,39,0.85); border: 1px solid #2d3748; border-radius: 4px; padding: 3px 8px; font-size: 11px; color: #718096; pointer-events: none; }
#legend { position: absolute; bottom: 8px; left: 8px; background: rgba(10,14,26,0.92); border: 1px solid #2d3748; border-radius: 6px; padding: 8px 11px; font-size: 10px; }
.lgrow { display: flex; align-items: center; gap: 7px; margin-bottom: 3px; color: #718096; }
.lgline { width: 22px; height: 2px; border-radius: 1px; flex-shrink: 0; }
#prompt-area { background: #161b27; border-top: 1px solid #2d3748; padding: 10px 14px; display: flex; gap: 10px; align-items: flex-start; flex-shrink: 0; }
#prompt-output { flex: 1; background: #0f1117; border: 1px solid #2d3748; border-radius: 5px; color: #718096; font-size: 11px; font-family: 'Menlo','Monaco','Courier New',monospace; padding: 7px 10px; resize: none; height: 72px; line-height: 1.5; }
#copy-btn { padding: 7px 14px; background: #16a34a; border: none; border-radius: 5px; color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
#copy-btn:hover { background: #15803d; }
#copy-btn.copied { background: #059669; }
.plabel { font-size: 10px; color: #4a5568; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
#modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 100; align-items: center; justify-content: center; }
#modal-overlay.open { display: flex; }
#modal { background: #161b27; border: 1px solid #2d3748; border-radius: 9px; padding: 18px 20px; width: 370px; max-width: 92vw; }
#modal-title { font-weight: 700; color: #e2e8f0; margin-bottom: 3px; font-size: 14px; }
#modal-sub { font-size: 10px; color: #4a5568; font-family: 'Menlo','Monaco',monospace; margin-bottom: 11px; }
#modal-ta { width: 100%; background: #0f1117; border: 1px solid #2d3748; border-radius: 5px; color: #e2e8f0; font-size: 12px; padding: 8px 10px; resize: none; height: 76px; font-family: inherit; line-height: 1.5; }
#modal-ta:focus { outline: none; border-color: #22c55e; }
.mactions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 11px; }
.mbtn { padding: 7px 13px; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; }
.mbtn-c { background: #2d3748; color: #a0aec0; }
.mbtn-s { background: #16a34a; color: #fff; }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="ss" style="padding-bottom:10px">
      <div style="font-weight:800;font-size:13px;color:#e2e8f0;margin-bottom:1px">Driver Surface Map</div>
      <div style="font-size:10px;color:#4a5568">Services &amp; Bridge Architecture · LMDR</div>
    </div>
    <div class="ss">
      <div class="stitle">Preset Views</div>
      <button class="preset-btn active" data-preset="full">Full Driver OS</button>
      <button class="preset-btn" data-preset="matching">AI Matching Hub</button>
      <button class="preset-btn" data-preset="bridge">Bridge Pattern</button>
      <button class="preset-btn" data-preset="gamification">Gamification Stack</button>
      <button class="preset-btn" data-preset="messaging">Messaging &amp; Docs</button>
    </div>
    <div class="ss">
      <div class="stitle">Layers</div>
      <label class="trow"><input type="checkbox" data-layer="html" checked><span class="ldot" style="background:#bfdbfe"></span><span>HTML Modules</span></label>
      <label class="trow"><input type="checkbox" data-layer="page" checked><span class="ldot" style="background:#fde68a"></span><span>Page Code (Bridge)</span></label>
      <label class="trow"><input type="checkbox" data-layer="driver" checked><span class="ldot" style="background:#bbf7d0"></span><span>Driver Services</span></label>
      <label class="trow"><input type="checkbox" data-layer="shared" checked><span class="ldot" style="background:#e9d5ff"></span><span>Shared Services</span></label>
      <label class="trow"><input type="checkbox" data-layer="data" checked><span class="ldot" style="background:#fce7f3"></span><span>Data Layer</span></label>
    </div>
    <div class="ss">
      <div class="stitle">Connections</div>
      <label class="trow"><input type="checkbox" data-conn="postmessage" checked><span class="lgline" style="border-top:2px dashed #a78bfa"></span><span>postMessage</span></label>
      <label class="trow"><input type="checkbox" data-conn="service-call" checked><span class="lgline" style="background:#34d399"></span><span>Service Calls</span></label>
      <label class="trow"><input type="checkbox" data-conn="data-flow" checked><span class="lgline" style="background:#60a5fa"></span><span>Data Access</span></label>
    </div>
    <div class="ss">
      <div class="stitle">Zoom</div>
      <div class="zoom-controls">
        <button class="zbtn" id="zoom-in">+</button>
        <button class="zbtn" id="zoom-reset" title="Reset view">⟳</button>
        <button class="zbtn" id="zoom-out">−</button>
      </div>
    </div>
    <div class="ss" style="flex:1;min-height:0">
      <div class="stitle" id="ctitle">Comments (0)</div>
      <div id="clist"></div>
    </div>
  </div>

  <div id="canvas-wrap">
    <svg id="canvas" xmlns="http://www.w3.org/2000/svg">
      <defs id="defs-el"></defs>
      <g id="cg"></g>
    </svg>
    <div id="zoom-ind">100%</div>
    <div id="legend">
      <div class="lgrow"><div class="lgline" style="border-top:2px dashed #a78bfa"></div>postMessage (HTML ↔ Page)</div>
      <div class="lgrow"><div class="lgline" style="background:#34d399"></div>Service call (Page → Backend)</div>
      <div class="lgrow"><div class="lgline" style="background:#60a5fa"></div>Data access (Service → Store)</div>
      <div class="lgrow"><div class="lgline" style="border-top:2px dotted #4a5568"></div>Module dependency</div>
      <div style="margin-top:5px;padding-top:5px;border-top:1px solid #2d3748;color:#4a5568;font-size:9px">Click node to comment · Drag to pan · Scroll to zoom</div>
    </div>
  </div>
</div>

<div id="prompt-area">
  <div style="flex:1">
    <div class="plabel">Generated Prompt</div>
    <textarea id="prompt-output" readonly></textarea>
  </div>
  <button id="copy-btn">Copy Prompt</button>
</div>

<div id="modal-overlay">
  <div id="modal">
    <div id="modal-title"></div>
    <div id="modal-sub"></div>
    <textarea id="modal-ta" placeholder="Add a note, question, or feedback about this component…"></textarea>
    <div class="mactions">
      <button class="mbtn mbtn-c" id="modal-cancel">Cancel</button>
      <button class="mbtn mbtn-s" id="modal-save">Save Note</button>
    </div>
  </div>
</div>

<script>
// ── DATA ──────────────────────────────────────────────────────────────────────

var LC = {
  html:   { fill: '#bfdbfe', stroke: '#93c5fd', text: '#1e3a5f' },
  page:   { fill: '#fde68a', stroke: '#d97706', text: '#78350f' },
  driver: { fill: '#bbf7d0', stroke: '#22c55e', text: '#14532d' },
  shared: { fill: '#e9d5ff', stroke: '#a855f7', text: '#581c87' },
  data:   { fill: '#fce7f3', stroke: '#ec4899', text: '#831843' },
};

var CS = {
  'postmessage':  { color: '#a78bfa', dash: '6,3' },
  'service-call': { color: '#34d399', dash: null  },
  'data-flow':    { color: '#60a5fa', dash: null  },
  'dependency':   { color: '#4a5568', dash: '3,3' },
};

var LNAMES = {
  html:   'HTML MODULES  (CDN-served · LMDR branding)',
  page:   'WIX PAGE CODE  ·  Bridge Layer',
  driver: 'DRIVER SERVICES  ·  .jsw (driver-specific)',
  shared: 'SHARED SERVICES  ·  .jsw (cross-surface)',
  data:   'DATA LAYER',
};

var ALL_NODES = [
  // HTML layer
  { id:'html-shells', label:'Driver HTML Shells',  sub:'src/public/driver/*.html — 19 files',              layer:'html',   w:182, h:50 },
  { id:'html-config', label:'*-config.js',          sub:'CDN: constants · valid actions',                  layer:'html',   w:128, h:50 },
  { id:'html-bridge', label:'*-bridge.js',          sub:'CDN: sendToVelo() · origin validation',           layer:'html',   w:132, h:50 },
  { id:'html-render', label:'*-render.js',          sub:'CDN: DOM building · data formatting',             layer:'html',   w:128, h:50 },
  { id:'html-logic',  label:'*-logic.js',           sub:'CDN: event handlers · state management',          layer:'html',   w:128, h:50 },
  // Special AI Matching modules
  { id:'html-agent',  label:'ai-matching-agent.js', sub:'CDN: floating LMDR chat FAB + panel',             layer:'html',   w:175, h:50 },
  { id:'html-results',label:'ai-matching-results.js',sub:'CDN: carrier cards + enrichment accordion',      layer:'html',   w:185, h:50 },
  // Page code
  { id:'p-match',  label:'AI_MATCHING',             sub:'.rof4w.js · 55+ actions · 11 services · Proto A', layer:'page',  w:172, h:50 },
  { id:'p-dash',   label:'Driver Dashboard',        sub:'.ctupv.js · polling + backoff · Proto B',         layer:'page',  w:172, h:50 },
  { id:'p-gam',    label:'DRIVER_GAMIFICATION',     sub:'.ik6n7.js · 10 actions · Proto B',                layer:'page',  w:172, h:50 },
  { id:'p-forums', label:'DRIVER_FORUMS',           sub:'.vzg3s.js · type/payload ⚠ Proto C',              layer:'page',  w:172, h:50 },
  { id:'p-badges', label:'DRIVER_BADGES',           sub:'.jlfgc.js · 3 actions · Proto B',                 layer:'page',  w:155, h:50 },
  { id:'p-docs',   label:'DRIVER_DOCUMENT_UPLOAD',  sub:'.r5jyr.js · 3 actions · Proto B',                 layer:'page',  w:172, h:50 },
  { id:'p-announce',label:'DRIVER_ANNOUNCEMENTS',   sub:'.jgkc4.js · 4 actions · Proto B',                 layer:'page',  w:172, h:50 },
  { id:'p-policies',label:'DRIVER_POLICIES',        sub:'.mbmmh.js · 4 actions · Proto B',                 layer:'page',  w:155, h:50 },
  // Driver-specific services
  { id:'sd-profiles', label:'driverProfiles',           sub:'driverProfiles.jsw · profile CRUD · discoverability', layer:'driver', w:175, h:50 },
  { id:'sd-insights', label:'driverInsightsService',    sub:'driverInsightsService.jsw · stats/analytics',         layer:'driver', w:175, h:50 },
  { id:'sd-matching', label:'driverMatching',           sub:'driverMatching.jsw · scoring algorithm',               layer:'driver', w:165, h:50 },
  { id:'sd-scorecard',label:'driverScorecardService',   sub:'driverScorecardService.jsw',                           layer:'driver', w:175, h:50 },
  { id:'sd-lifecycle',label:'driverLifecycleService',   sub:'driverLifecycleService.jsw · lifecycle stages',        layer:'driver', w:175, h:50 },
  { id:'sd-financial',label:'driverFinancialService',   sub:'driverFinancialService.jsw · earnings',                layer:'driver', w:175, h:50 },
  { id:'sd-cockpit',  label:'driverCockpitService',     sub:'driverCockpitService.jsw · cockpit views',             layer:'driver', w:168, h:50 },
  { id:'sd-explain',  label:'matchExplanationService',  sub:'matchExplanationService.jsw · "Why You Matched"',      layer:'driver', w:185, h:50 },
  { id:'sd-pet',      label:'petFriendlyService',       sub:'petFriendlyService.jsw · crowdsourced stops',          layer:'driver', w:168, h:50 },
  { id:'sd-health',   label:'healthService',            sub:'healthService.jsw · trucker health content',           layer:'driver', w:158, h:50 },
  { id:'sd-mentor',   label:'mentoringService',         sub:'mentorService.jsw · mentor program',                   layer:'driver', w:155, h:50 },
  // Shared services (used by drivers and other surfaces)
  { id:'ss-carrier-match', label:'carrierMatching',          sub:'carrierMatching.jsw · findMatchingCarriers',         layer:'shared', w:168, h:50 },
  { id:'ss-app',           label:'applicationService',        sub:'applicationService.jsw · submit · withdraw',         layer:'shared', w:162, h:50 },
  { id:'ss-mutual',        label:'mutualInterestService',     sub:'mutualInterestService.jsw · interest tracking',      layer:'shared', w:172, h:50 },
  { id:'ss-async',         label:'asyncSearchService',        sub:'asyncSearchService.jsw · semantic search · polling', layer:'shared', w:178, h:50 },
  { id:'ss-ocr',           label:'ocrService',                sub:'ocrService.jsw · document auto-fill (Gemini)',       layer:'shared', w:165, h:50 },
  { id:'ss-enrich',        label:'aiEnrichment',              sub:'aiEnrichment.jsw · carrier enrichment (Claude)',     layer:'shared', w:165, h:50 },
  { id:'ss-agent',         label:'agentService',              sub:'agentService.jsw · driver role · tool orchestration',layer:'shared', w:178, h:50 },
  { id:'ss-voice',         label:'voiceService',              sub:'voiceService.jsw · VAPI calls',                      layer:'shared', w:148, h:50 },
  { id:'ss-announce',      label:'carrierAnnouncementsService',sub:'carrierAnnouncementsService.jsw',                    layer:'shared', w:195, h:50 },
  { id:'ss-policies',      label:'carrierPolicyService',      sub:'carrierPolicyService.jsw',                           layer:'shared', w:158, h:50 },
  { id:'ss-forum',         label:'forumService',              sub:'forumService.jsw · threads · posts · XP',            layer:'shared', w:155, h:50 },
  { id:'ss-msg',           label:'messaging',                 sub:'messaging.jsw + messagingRealtime.jsw',              layer:'shared', w:155, h:50 },
  { id:'ss-docs',          label:'documentCollectionService', sub:'documentCollectionService.jsw',                      layer:'shared', w:185, h:50 },
  { id:'ss-onboard',       label:'onboardingWorkflowService', sub:'onboardingWorkflowService.jsw · workflow status',    layer:'shared', w:188, h:50 },
  { id:'ss-gamify',        label:'gamificationService',       sub:'gamificationService.jsw · progression',              layer:'shared', w:165, h:50 },
  { id:'ss-challenge',     label:'challengeService',          sub:'challengeService.jsw · start · claim reward',        layer:'shared', w:158, h:50 },
  { id:'ss-badge',         label:'badgeService',              sub:'badgeService.jsw · getBadges · definitions',         layer:'shared', w:148, h:50 },
  { id:'ss-feature',       label:'featureAdoptionService',    sub:'featureAdoptionService.jsw · interaction tracking',  layer:'shared', w:182, h:50 },
  // Data
  { id:'d-air', label:'Airtable — LMDR Base', sub:'app9N1YCJ3gdhExA0 · driver profiles · interests · messages', layer:'data', w:200, h:50 },
  { id:'d-wix', label:'Wix Collections',       sub:'MemberNotifications (system only)',                          layer:'data', w:168, h:50 },
];

var NM = {};
ALL_NODES.forEach(function(n){ NM[n.id] = n; });

// [from, to, type]
var ALL_CONNS = [
  // html shells → pages
  ['html-shells','p-match','postmessage'],['html-shells','p-dash','postmessage'],
  ['html-shells','p-gam','postmessage'],['html-shells','p-forums','postmessage'],
  ['html-shells','p-badges','postmessage'],['html-shells','p-docs','postmessage'],
  ['html-shells','p-announce','postmessage'],['html-shells','p-policies','postmessage'],
  // module chain (bridge pattern)
  ['html-config','html-bridge','dependency'],['html-bridge','html-render','dependency'],
  ['html-render','html-logic','dependency'],
  ['html-logic','p-match','postmessage'],['p-match','html-render','postmessage'],
  // ai matching special modules
  ['html-agent','p-match','postmessage'],['html-results','p-match','postmessage'],
  // page → driver services
  ['p-match','sd-profiles','service-call'],['p-match','sd-explain','service-call'],
  ['p-dash','sd-insights','service-call'],
  // page → shared services
  ['p-match','ss-carrier-match','service-call'],['p-match','ss-app','service-call'],
  ['p-match','ss-mutual','service-call'],['p-match','ss-async','service-call'],
  ['p-match','ss-ocr','service-call'],['p-match','ss-enrich','service-call'],
  ['p-match','ss-agent','service-call'],['p-match','ss-voice','service-call'],
  ['p-match','ss-feature','service-call'],
  ['p-dash','ss-app','service-call'],['p-dash','ss-msg','service-call'],['p-dash','ss-feature','service-call'],
  ['p-gam','ss-gamify','service-call'],['p-gam','ss-challenge','service-call'],['p-gam','ss-badge','service-call'],
  ['p-forums','ss-forum','service-call'],
  ['p-badges','ss-badge','service-call'],
  ['p-docs','ss-docs','service-call'],['p-docs','ss-onboard','service-call'],
  ['p-announce','ss-announce','service-call'],
  ['p-policies','ss-policies','service-call'],
  // services → data
  ['sd-profiles','d-air','data-flow'],['sd-insights','d-air','data-flow'],
  ['sd-matching','d-air','data-flow'],['sd-scorecard','d-air','data-flow'],
  ['sd-explain','d-air','data-flow'],['sd-pet','d-air','data-flow'],
  ['sd-health','d-air','data-flow'],['sd-mentor','d-air','data-flow'],
  ['ss-carrier-match','d-air','data-flow'],['ss-app','d-air','data-flow'],
  ['ss-mutual','d-air','data-flow'],['ss-async','d-air','data-flow'],
  ['ss-agent','d-air','data-flow'],['ss-voice','d-air','data-flow'],
  ['ss-announce','d-air','data-flow'],['ss-policies','d-air','data-flow'],
  ['ss-forum','d-air','data-flow'],['ss-msg','d-air','data-flow'],
  ['ss-docs','d-air','data-flow'],['ss-onboard','d-air','data-flow'],
  ['ss-gamify','d-air','data-flow'],['ss-challenge','d-air','data-flow'],
  ['ss-badge','d-air','data-flow'],['ss-feature','d-air','data-flow'],
  ['ss-msg','d-wix','data-flow'],
];

// ── PRESETS ───────────────────────────────────────────────────────────────────

function p(id,x,y){ return {id:id,x:x,y:y}; }

var PRESETS = {
  full: {
    desc: 'All 8 driver pages, 11 driver services, 18 shared services, and 2 data stores',
    positions: [
      p('html-shells',480,35),
      // Pages row 1
      p('p-match',30,130), p('p-dash',215,130), p('p-gam',400,130), p('p-forums',585,130),
      // Pages row 2
      p('p-badges',30,200), p('p-docs',200,200), p('p-announce',382,200), p('p-policies',568,200),
      // Driver services row 1
      p('sd-profiles',30,305), p('sd-insights',220,305), p('sd-explain',408,305), p('sd-matching',608,305), p('sd-scorecard',785,305),
      // Driver services row 2
      p('sd-lifecycle',30,375), p('sd-financial',220,375), p('sd-cockpit',408,375), p('sd-pet',585,375), p('sd-health',768,375),
      // Shared services row 1
      p('ss-carrier-match',30,460), p('ss-app',212,460), p('ss-mutual',388,460), p('ss-async',574,460), p('ss-ocr',765,460),
      // Shared services row 2
      p('ss-enrich',30,530), p('ss-agent',208,530), p('ss-voice',398,530), p('ss-gamify',558,530), p('ss-challenge',735,530),
      // Shared services row 3
      p('ss-badge',30,600), p('ss-forum',190,600), p('ss-msg',355,600), p('ss-docs',522,600), p('ss-onboard',720,600),
      p('ss-announce',30,670), p('ss-policies',238,670), p('ss-feature',408,670),
      // Data
      p('d-air',310,760), p('d-wix',620,760),
    ],
  },
  matching: {
    desc: 'AI_MATCHING page — the most complex driver page, wired to 11 backend services including agent + voice',
    positions: [
      p('html-shells',390,35), p('html-agent',620,35), p('html-results',820,35),
      p('p-match',390,135),
      // Services fanned below
      p('sd-profiles',30,285), p('sd-explain',215,285), p('ss-carrier-match',405,285), p('ss-app',598,285), p('ss-mutual',785,285),
      p('ss-async',30,370), p('ss-ocr',215,370), p('ss-enrich',400,370), p('ss-agent',585,370), p('ss-voice',770,370),
      p('ss-feature',480,455),
      p('d-air',430,560),
    ],
  },
  bridge: {
    desc: 'CDN module chain (Proto A — AI Matching with origin validation and MESSAGE_REGISTRY)',
    positions: [
      p('html-config',40,55), p('html-bridge',182,55), p('html-render',324,55), p('html-logic',466,55),
      p('html-agent',625,55), p('html-results',815,55),
      p('p-match',310,205),
      p('ss-carrier-match',140,360), p('ss-agent',425,360), p('ss-enrich',680,360),
      p('d-air',390,500),
    ],
  },
  gamification: {
    desc: 'Gamification stack — challenge, badge, streak, forum XP rewards all wired through driver pages',
    positions: [
      p('html-shells',430,35),
      p('p-gam',195,135), p('p-forums',460,135), p('p-badges',680,135),
      p('ss-gamify',100,285), p('ss-challenge',290,285), p('ss-badge',490,285), p('ss-forum',680,285),
      p('sd-profiles',100,395), p('ss-feature',420,395),
      p('d-air',380,510),
    ],
  },
  messaging: {
    desc: 'Messaging and document workflow — dashboard polling, messaging realtime, document upload + onboarding',
    positions: [
      p('html-shells',420,35),
      p('p-dash',195,135), p('p-docs',470,135),
      p('ss-msg',100,285), p('ss-app',320,285), p('ss-feature',530,285),
      p('ss-docs',200,375), p('ss-onboard',450,375),
      p('sd-insights',120,465),
      p('d-air',390,565), p('d-wix',680,565),
    ],
  },
};

// ── STATE ─────────────────────────────────────────────────────────────────────

var S = {
  preset: 'full',
  layers: { html:true, page:true, driver:true, shared:true, data:true },
  conns: { 'postmessage':true, 'service-call':true, 'data-flow':true },
  comments: [], nextId: 1,
  zoom: 1, panX: 15, panY: 15,
  panning: false, lastX: 0, lastY: 0,
  modalNode: null,
};

// ── SVG HELPERS ───────────────────────────────────────────────────────────────

var svg  = document.getElementById('canvas');
var cg   = document.getElementById('cg');
var defs = document.getElementById('defs-el');
var NS   = 'http://www.w3.org/2000/svg';

function se(tag, attrs, parent) {
  var el = document.createElementNS(NS, tag);
  Object.keys(attrs).forEach(function(k){ el.setAttribute(k, attrs[k]); });
  if (parent) parent.appendChild(el);
  return el;
}

function setupMarkers() {
  while (defs.firstChild) defs.removeChild(defs.firstChild);
  [['postmessage','#a78bfa'],['service-call','#34d399'],['data-flow','#60a5fa'],['dependency','#4a5568']].forEach(function(pair) {
    var m = se('marker',{id:'arr-'+pair[0],markerWidth:'8',markerHeight:'6',refX:'7',refY:'3',orient:'auto'});
    se('polygon',{points:'0 0, 8 3, 0 6',fill:pair[1]},m);
    defs.appendChild(m);
  });
}

function bez(x1,y1,x2,y2,horiz) {
  if (horiz) {
    var mx = (x1+x2)/2;
    return 'M '+x1+' '+y1+' C '+mx+' '+y1+', '+mx+' '+y2+', '+x2+' '+y2;
  }
  var dy = Math.max(Math.abs(y2-y1)*0.42, 28);
  return 'M '+x1+' '+y1+' C '+x1+' '+(y1+dy)+', '+x2+' '+(y2-dy)+', '+x2+' '+y2;
}

// ── RENDER ────────────────────────────────────────────────────────────────────

function getVisible() {
  var posMap = {};
  PRESETS[S.preset].positions.forEach(function(p){ posMap[p.id] = p; });
  return Object.keys(posMap).map(function(id){
    var n = NM[id];
    if (!n || !S.layers[n.layer]) return null;
    var pos = posMap[id];
    return { id:n.id, label:n.label, sub:n.sub, layer:n.layer, w:n.w, h:n.h, x:pos.x, y:pos.y };
  }).filter(Boolean);
}

function getVisConns(nodes) {
  var ids = {};
  nodes.forEach(function(n){ ids[n.id] = true; });
  return ALL_CONNS.filter(function(c){
    if (!ids[c[0]] || !ids[c[1]]) return false;
    if (c[2] === 'dependency') return S.layers.html;
    return S.conns[c[2]];
  });
}

function render() {
  while (cg.firstChild) cg.removeChild(cg.firstChild);
  cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')');

  var nodes = getVisible();
  var np = {};
  nodes.forEach(function(n){ np[n.id] = n; });

  // Layer label bands
  var lyrY = {};
  nodes.forEach(function(n){
    if (!lyrY[n.layer]) lyrY[n.layer] = { minY:9999, minX:9999 };
    if (n.y < lyrY[n.layer].minY) lyrY[n.layer].minY = n.y;
    if (n.x < lyrY[n.layer].minX) lyrY[n.layer].minX = n.x;
  });
  Object.keys(lyrY).forEach(function(layer) {
    var r = lyrY[layer];
    var lbl = se('text',{
      x:r.minX, y:r.minY-7, fill:LC[layer].stroke,
      'font-size':'9','font-weight':'700',
      'font-family':"-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",
      'letter-spacing':'0.07em', opacity:'0.9',
    }, cg);
    lbl.textContent = LNAMES[layer] || layer.toUpperCase();
  });

  // Connections
  getVisConns(nodes).forEach(function(conn) {
    var f = np[conn[0]], t = np[conn[1]], type = conn[2];
    if (!f || !t) return;
    var st = CS[type] || CS['dependency'];
    var fcx=f.x+f.w/2, fcy=f.y+f.h/2, tcx=t.x+t.w/2, tcy=t.y+t.h/2;
    var horiz = Math.abs(fcy-tcy) < 35;
    var d = horiz ? bez(f.x+f.w,fcy,t.x,tcy,true) : bez(fcx,f.y+f.h,tcx,t.y,false);
    var path = se('path',{d:d,stroke:st.color,'stroke-width':'1.5',fill:'none','marker-end':'url(#arr-'+type+')',opacity:'0.5'},cg);
    if (st.dash) path.setAttribute('stroke-dasharray',st.dash);
  });

  // Nodes
  nodes.forEach(function(n) {
    var c = LC[n.layer];
    var hasC = S.comments.some(function(cm){ return cm.target===n.id; });
    var g = se('g',{'data-id':n.id},cg);
    g.style.cursor = 'pointer';
    se('rect',{x:n.x,y:n.y,width:n.w,height:n.h,rx:'7',
      fill:c.fill, stroke:hasC?'#f6ad55':c.stroke, 'stroke-width':hasC?'2.5':'1.5'},g);
    var lbl = se('text',{x:n.x+n.w/2,y:n.y+17,'text-anchor':'middle',fill:c.text,
      'font-size':'11','font-weight':'700',
      'font-family':"-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif"},g);
    lbl.textContent = n.label;
    var maxCh = Math.floor(n.w/6.2);
    var subStr = n.sub.length>maxCh ? n.sub.slice(0,maxCh-1)+'…' : n.sub;
    var sub = se('text',{x:n.x+n.w/2,y:n.y+31,'text-anchor':'middle',fill:c.text,opacity:'0.55',
      'font-size':'8.5','font-family':"'Menlo','Monaco','Courier New',monospace"},g);
    sub.textContent = subStr;
    if (hasC) se('circle',{cx:n.x+n.w-7,cy:n.y+7,r:'5',fill:'#f6ad55'},g);
    var rect = g.querySelector('rect');
    g.addEventListener('click',function(e){ e.stopPropagation(); openModal(n); });
    g.addEventListener('mouseenter',function(){ rect.style.filter='brightness(1.12)'; });
    g.addEventListener('mouseleave',function(){ rect.style.filter=''; });
  });

  document.getElementById('zoom-ind').textContent = Math.round(S.zoom*100)+'%';
}

// ── PROMPT ────────────────────────────────────────────────────────────────────

function updatePrompt() {
  var preset = PRESETS[S.preset];
  var nodes = getVisible();
  var pages   = nodes.filter(function(n){ return n.layer==='page'; });
  var dsvcs   = nodes.filter(function(n){ return n.layer==='driver'; });
  var ssvcs   = nodes.filter(function(n){ return n.layer==='shared'; });
  var data    = nodes.filter(function(n){ return n.layer==='data'; });
  var parts   = ['This is the LMDR Driver surface architecture. View: '+S.preset+' — '+preset.desc+'.',''];
  if (pages.length)  parts.push('Driver pages ('+pages.length+'): '+pages.map(function(n){return n.label;}).join(', ')+'.');
  if (dsvcs.length)  parts.push('Driver-specific services ('+dsvcs.length+'): '+dsvcs.map(function(n){return n.label;}).join(', ')+'.');
  if (ssvcs.length)  parts.push('Shared services ('+ssvcs.length+'): '+ssvcs.map(function(n){return n.label;}).join(', ')+'.');
  if (data.length)   parts.push('Data stores: '+data.map(function(n){return n.label;}).join(', ')+'.');
  var offL = Object.keys(S.layers).filter(function(k){ return !S.layers[k]; });
  if (offL.length) parts.push('Hidden layers: '+offL.join(', ')+'.');
  if (S.comments.length) {
    parts.push('','Feedback on specific components:','');
    S.comments.forEach(function(cm){
      var n = NM[cm.target];
      parts.push('**'+cm.targetLabel+'** ('+(n?n.sub:cm.target)+'):');
      parts.push(cm.text,'');
    });
  } else {
    parts.push('','(Click any node to add a comment or question.)');
  }
  document.getElementById('prompt-output').value = parts.join('\n');
}

// ── MODAL ─────────────────────────────────────────────────────────────────────

function openModal(n) {
  S.modalNode = n;
  document.getElementById('modal-title').textContent = n.label;
  document.getElementById('modal-sub').textContent = n.sub;
  var ex = S.comments.filter(function(c){ return c.target===n.id; })[0];
  document.getElementById('modal-ta').value = ex ? ex.text : '';
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-ta').focus();
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  S.modalNode = null;
}

function saveComment() {
  var text = document.getElementById('modal-ta').value.trim();
  if (!S.modalNode) { closeModal(); return; }
  var n = S.modalNode;
  S.comments = S.comments.filter(function(c){ return c.target!==n.id; });
  if (text) S.comments.push({ id:S.nextId++, target:n.id, targetLabel:n.label, text:text });
  closeModal(); renderComments(); render(); updatePrompt();
}

function renderComments() {
  var list = document.getElementById('clist');
  document.getElementById('ctitle').textContent = 'Comments ('+S.comments.length+')';
  while (list.firstChild) list.removeChild(list.firstChild);
  if (!S.comments.length) {
    var msg = document.createElement('div');
    msg.style.cssText = 'color:#4a5568;font-size:11px;font-style:italic';
    msg.textContent = 'Click any node to add a note.';
    list.appendChild(msg);
    return;
  }
  S.comments.forEach(function(cm) {
    var item = document.createElement('div');
    item.className = 'citem';
    var del = document.createElement('button');
    del.className = 'cdel';
    del.textContent = '×';
    del.setAttribute('aria-label','Delete comment');
    del.addEventListener('click', function() {
      S.comments = S.comments.filter(function(c){ return c.id!==cm.id; });
      renderComments(); render(); updatePrompt();
    });
    var tgt = document.createElement('div');
    tgt.className = 'ctarget';
    tgt.textContent = cm.targetLabel;
    var txt = document.createElement('div');
    txt.className = 'ctext';
    txt.textContent = cm.text.length>90 ? cm.text.slice(0,90)+'…' : cm.text;
    item.appendChild(del); item.appendChild(tgt); item.appendChild(txt);
    list.appendChild(item);
  });
}

// ── PAN + ZOOM ────────────────────────────────────────────────────────────────

var wrap = document.getElementById('canvas-wrap');
wrap.addEventListener('mousedown',function(e){ if(e.target.closest('[data-id]'))return; S.panning=true; S.lastX=e.clientX; S.lastY=e.clientY; });
window.addEventListener('mousemove',function(e){ if(!S.panning)return; S.panX+=e.clientX-S.lastX; S.panY+=e.clientY-S.lastY; S.lastX=e.clientX; S.lastY=e.clientY; cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')'); document.getElementById('zoom-ind').textContent=Math.round(S.zoom*100)+'%'; });
window.addEventListener('mouseup',function(){ S.panning=false; });
wrap.addEventListener('wheel',function(e){ e.preventDefault(); var d=e.deltaY>0?0.88:1.12; S.zoom=Math.max(0.2,Math.min(3.5,S.zoom*d)); cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')'); document.getElementById('zoom-ind').textContent=Math.round(S.zoom*100)+'%'; },{passive:false});
document.getElementById('zoom-in').addEventListener('click',function(){ S.zoom=Math.min(3.5,S.zoom*1.2); cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')'); document.getElementById('zoom-ind').textContent=Math.round(S.zoom*100)+'%'; });
document.getElementById('zoom-out').addEventListener('click',function(){ S.zoom=Math.max(0.2,S.zoom/1.2); cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')'); document.getElementById('zoom-ind').textContent=Math.round(S.zoom*100)+'%'; });
document.getElementById('zoom-reset').addEventListener('click',function(){ S.zoom=1; S.panX=15; S.panY=15; render(); updatePrompt(); });

// ── WIRING ────────────────────────────────────────────────────────────────────

document.querySelectorAll('.preset-btn').forEach(function(btn) {
  btn.addEventListener('click',function(){
    S.preset=btn.dataset.preset; S.zoom=1; S.panX=15; S.panY=15;
    document.querySelectorAll('.preset-btn').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    render(); updatePrompt();
  });
});
document.querySelectorAll('[data-layer]').forEach(function(cb){ cb.addEventListener('change',function(){ S.layers[cb.dataset.layer]=cb.checked; render(); updatePrompt(); }); });
document.querySelectorAll('[data-conn]').forEach(function(cb){ cb.addEventListener('change',function(){ S.conns[cb.dataset.conn]=cb.checked; render(); updatePrompt(); }); });
document.getElementById('modal-cancel').addEventListener('click',closeModal);
document.getElementById('modal-save').addEventListener('click',saveComment);
document.getElementById('modal-overlay').addEventListener('click',function(e){ if(e.target===document.getElementById('modal-overlay'))closeModal(); });
document.getElementById('modal-ta').addEventListener('keydown',function(e){ if(e.key==='Enter'&&e.metaKey)saveComment(); if(e.key==='Escape')closeModal(); });
document.getElementById('copy-btn').addEventListener('click',function(){
  navigator.clipboard.writeText(document.getElementById('prompt-output').value).then(function(){
    var btn=document.getElementById('copy-btn');
    btn.textContent='Copied!'; btn.classList.add('copied');
    setTimeout(function(){ btn.textContent='Copy Prompt'; btn.classList.remove('copied'); },2000);
  });
});

// ── INIT ──────────────────────────────────────────────────────────────────────
setupMarkers(); renderComments(); render(); updatePrompt();
</script>
</body>
</html>
