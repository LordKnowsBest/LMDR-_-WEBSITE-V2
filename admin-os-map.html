<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin OS Architecture Map</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0f1117; color: #e2e8f0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 13px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}
#app { display: flex; flex: 1; overflow: hidden; }
#sidebar {
  width: 228px; background: #161b27; border-right: 1px solid #2d3748;
  display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;
}
.ss { padding: 11px 13px; border-bottom: 1px solid #2d3748; }
.stitle {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; color: #4a5568; margin-bottom: 7px;
}
.preset-btn {
  display: block; width: 100%; padding: 6px 9px; margin-bottom: 3px;
  background: #1e2535; border: 1px solid #2d3748; border-radius: 5px;
  color: #a0aec0; text-align: left; cursor: pointer; font-size: 12px; transition: all 0.12s;
}
.preset-btn:hover { background: #2d3748; color: #e2e8f0; }
.preset-btn.active { background: #1d4ed8; border-color: #3b82f6; color: #fff; font-weight: 600; }
.trow { display: flex; align-items: center; gap: 7px; margin-bottom: 5px; cursor: pointer; }
.trow input[type="checkbox"] { accent-color: #3b82f6; cursor: pointer; }
.ldot { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
.zoom-controls { display: flex; gap: 4px; }
.zbtn {
  flex: 1; padding: 5px 4px; background: #1e2535; border: 1px solid #2d3748;
  border-radius: 4px; color: #a0aec0; cursor: pointer; font-size: 13px; font-weight: bold;
}
.zbtn:hover { background: #2d3748; color: #e2e8f0; }
.citem {
  background: #1e2535; border: 1px solid #2d3748; border-radius: 5px;
  padding: 7px 28px 7px 8px; margin-bottom: 5px; font-size: 11px; position: relative;
}
.ctarget { font-weight: 600; color: #63b3ed; margin-bottom: 2px; }
.ctext { color: #a0aec0; line-height: 1.4; }
.cdel {
  position: absolute; top: 4px; right: 6px; background: none; border: none;
  color: #e53e3e; cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px;
}
#canvas-wrap {
  flex: 1; overflow: hidden; position: relative; background: #090d18;
  background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.04) 1px, transparent 0);
  background-size: 22px 22px;
}
#canvas { width: 100%; height: 100%; cursor: grab; display: block; }
#canvas:active { cursor: grabbing; }
#zoom-ind {
  position: absolute; top: 8px; right: 8px; background: rgba(22,27,39,0.85);
  border: 1px solid #2d3748; border-radius: 4px; padding: 3px 8px;
  font-size: 11px; color: #718096; pointer-events: none;
}
#legend {
  position: absolute; bottom: 8px; left: 8px; background: rgba(10,14,26,0.92);
  border: 1px solid #2d3748; border-radius: 6px; padding: 8px 11px; font-size: 10px;
}
.lgrow { display: flex; align-items: center; gap: 7px; margin-bottom: 3px; color: #718096; }
.lgline { width: 22px; height: 2px; border-radius: 1px; flex-shrink: 0; }
#prompt-area {
  background: #161b27; border-top: 1px solid #2d3748;
  padding: 10px 14px; display: flex; gap: 10px; align-items: flex-start; flex-shrink: 0;
}
#prompt-output {
  flex: 1; background: #0f1117; border: 1px solid #2d3748; border-radius: 5px;
  color: #718096; font-size: 11px; font-family: 'Menlo','Monaco','Courier New',monospace;
  padding: 7px 10px; resize: none; height: 72px; line-height: 1.5;
}
#copy-btn {
  padding: 7px 14px; background: #2563eb; border: none; border-radius: 5px;
  color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; flex-shrink: 0;
}
#copy-btn:hover { background: #1d4ed8; }
#copy-btn.copied { background: #059669; }
.plabel { font-size: 10px; color: #4a5568; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
#modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65);
  z-index: 100; align-items: center; justify-content: center;
}
#modal-overlay.open { display: flex; }
#modal {
  background: #161b27; border: 1px solid #2d3748; border-radius: 9px;
  padding: 18px 20px; width: 370px; max-width: 92vw;
}
#modal-title { font-weight: 700; color: #e2e8f0; margin-bottom: 3px; font-size: 14px; }
#modal-sub { font-size: 10px; color: #4a5568; font-family: 'Menlo','Monaco',monospace; margin-bottom: 11px; }
#modal-ta {
  width: 100%; background: #0f1117; border: 1px solid #2d3748; border-radius: 5px;
  color: #e2e8f0; font-size: 12px; padding: 8px 10px; resize: none;
  height: 76px; font-family: inherit; line-height: 1.5;
}
#modal-ta:focus { outline: none; border-color: #3b82f6; }
.mactions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 11px; }
.mbtn { padding: 7px 13px; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; }
.mbtn-c { background: #2d3748; color: #a0aec0; }
.mbtn-s { background: #2563eb; color: #fff; }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="ss" style="padding-bottom:10px">
      <div style="font-weight:800;font-size:13px;color:#e2e8f0;margin-bottom:1px">Admin OS Map</div>
      <div style="font-size:10px;color:#4a5568">Services &amp; Bridge Architecture</div>
    </div>
    <div class="ss">
      <div class="stitle">Preset Views</div>
      <button class="preset-btn active" data-preset="full">Full OS Overview</button>
      <button class="preset-btn" data-preset="dashboard">Dashboard Hub</button>
      <button class="preset-btn" data-preset="bridge">Bridge Pattern</button>
      <button class="preset-btn" data-preset="agent">Agent Stack</button>
      <button class="preset-btn" data-preset="observability">Observability</button>
    </div>
    <div class="ss">
      <div class="stitle">Layers</div>
      <label class="trow"><input type="checkbox" data-layer="html" checked><span class="ldot" style="background:#bfdbfe"></span><span>HTML Modules</span></label>
      <label class="trow"><input type="checkbox" data-layer="page" checked><span class="ldot" style="background:#fde68a"></span><span>Page Code (Bridge)</span></label>
      <label class="trow"><input type="checkbox" data-layer="service" checked><span class="ldot" style="background:#a7f3d0"></span><span>Backend Services</span></label>
      <label class="trow"><input type="checkbox" data-layer="data" checked><span class="ldot" style="background:#fce7f3"></span><span>Data Layer</span></label>
    </div>
    <div class="ss">
      <div class="stitle">Connections</div>
      <label class="trow"><input type="checkbox" data-conn="postmessage" checked><span class="lgline" style="border-top:2px dashed #a78bfa"></span><span>postMessage</span></label>
      <label class="trow"><input type="checkbox" data-conn="service-call" checked><span class="lgline" style="background:#34d399"></span><span>Service Calls</span></label>
      <label class="trow"><input type="checkbox" data-conn="data-flow" checked><span class="lgline" style="background:#60a5fa"></span><span>Data Access</span></label>
    </div>
    <div class="ss">
      <div class="stitle">Zoom</div>
      <div class="zoom-controls">
        <button class="zbtn" id="zoom-in">+</button>
        <button class="zbtn" id="zoom-reset" title="Reset view">⟳</button>
        <button class="zbtn" id="zoom-out">−</button>
      </div>
    </div>
    <div class="ss" style="flex:1;min-height:0">
      <div class="stitle" id="ctitle">Comments (0)</div>
      <div id="clist"></div>
    </div>
  </div>

  <div id="canvas-wrap">
    <svg id="canvas" xmlns="http://www.w3.org/2000/svg">
      <defs id="defs-el"></defs>
      <g id="cg"></g>
    </svg>
    <div id="zoom-ind">100%</div>
    <div id="legend">
      <div class="lgrow"><div class="lgline" style="border-top:2px dashed #a78bfa"></div>postMessage</div>
      <div class="lgrow"><div class="lgline" style="background:#34d399"></div>Service call</div>
      <div class="lgrow"><div class="lgline" style="background:#60a5fa"></div>Data access</div>
      <div class="lgrow"><div class="lgline" style="border-top:2px dotted #4a5568"></div>Module chain</div>
      <div style="margin-top:5px;padding-top:5px;border-top:1px solid #2d3748;color:#4a5568;font-size:9px">
        Click node to comment · Drag to pan · Scroll to zoom
      </div>
    </div>
  </div>
</div>

<div id="prompt-area">
  <div style="flex:1">
    <div class="plabel">Generated Prompt</div>
    <textarea id="prompt-output" readonly></textarea>
  </div>
  <button id="copy-btn">Copy Prompt</button>
</div>

<div id="modal-overlay">
  <div id="modal">
    <div id="modal-title"></div>
    <div id="modal-sub"></div>
    <textarea id="modal-ta" placeholder="Add a note, question, or feedback about this component…"></textarea>
    <div class="mactions">
      <button class="mbtn mbtn-c" id="modal-cancel">Cancel</button>
      <button class="mbtn mbtn-s" id="modal-save">Save Note</button>
    </div>
  </div>
</div>

<script>
// ── DATA ──────────────────────────────────────────────────────────────────────

var LC = {
  html:    { fill: '#bfdbfe', stroke: '#93c5fd', text: '#1e3a5f' },
  page:    { fill: '#fde68a', stroke: '#d97706', text: '#78350f' },
  service: { fill: '#a7f3d0', stroke: '#10b981', text: '#064e3b' },
  data:    { fill: '#fce7f3', stroke: '#ec4899', text: '#831843' },
};
var CS = {
  'postmessage':  { color: '#a78bfa', dash: '6,3' },
  'service-call': { color: '#34d399', dash: null  },
  'data-flow':    { color: '#60a5fa', dash: null  },
  'dependency':   { color: '#4a5568', dash: '3,3' },
};
var LNAMES = {
  html:    'HTML MODULES  (CDN-served)',
  page:    'WIX PAGE CODE  ·  Bridge Layer',
  service: 'BACKEND SERVICES  ·  .jsw files',
  data:    'DATA LAYER',
};

var ALL_NODES = [
  // HTML
  { id:'html-shells', label:'Admin HTML Shells',  sub:'src/public/admin/*.html — 43 files',          layer:'html',    w:182, h:50 },
  { id:'html-config', label:'*-config.js',         sub:'CDN: constants · valid actions · endpoints',  layer:'html',    w:130, h:50 },
  { id:'html-bridge', label:'*-bridge.js',         sub:'CDN: sendToVelo() · listen()',                layer:'html',    w:130, h:50 },
  { id:'html-render', label:'*-render.js',         sub:'CDN: DOM building · data formatting',         layer:'html',    w:130, h:50 },
  { id:'html-logic',  label:'*-logic.js',          sub:'CDN: event handlers · state management',      layer:'html',    w:130, h:50 },
  // Page code
  { id:'p-dash',  label:'ADMIN_DASHBOARD',       sub:'.svo6l.js · 50+ actions · 8 services',   layer:'page', w:158, h:50 },
  { id:'p-drv',   label:'ADMIN_DRIVERS',         sub:'.uo7vb.js · 9 actions',                  layer:'page', w:148, h:50 },
  { id:'p-car',   label:'ADMIN_CARRIERS',        sub:'.qa2w1.js · 11 actions',                 layer:'page', w:148, h:50 },
  { id:'p-mat',   label:'ADMIN_MATCHES',         sub:'.gqhdo.js · 8 actions',                  layer:'page', w:148, h:50 },
  { id:'p-air',   label:'ADMIN_AI_ROUTER',       sub:'.cqkgi.js · 10 actions',                 layer:'page', w:148, h:50 },
  { id:'p-obs',   label:'ADMIN_OBSERVABILITY',   sub:'.c8pf9.js · 16 actions',                 layer:'page', w:158, h:50 },
  { id:'p-aud',   label:'ADMIN_AUDIT_LOG',       sub:'.ud1zf.js · 13 actions',                 layer:'page', w:148, h:50 },
  { id:'p-feat',  label:'ADMIN_FEATURE_ADOPT',   sub:'.rt8ev.js · type/data proto (not action)',layer:'page', w:162, h:50 },
  { id:'p-con',   label:'ADMIN_CONTENT',         sub:'.ods3g.js',                               layer:'page', w:138, h:50 },
  { id:'p-gam',   label:'ADMIN_GAMIFICATION',    sub:'.jmm93.js',                               layer:'page', w:148, h:50 },
  { id:'p-b2b',   label:'B2B_DASHBOARD',         sub:'.i5csc.js · handleB2BAction',             layer:'page', w:148, h:50 },
  { id:'p-b2bd',  label:'B2B_ACCOUNT_DETAIL',    sub:'.f31mi.js · 5 services',                  layer:'page', w:158, h:50 },
  // Services
  { id:'s-dash',  label:'admin_dashboard_svc',   sub:'admin_dashboard_service.jsw',             layer:'service', w:168, h:50 },
  { id:'s-adm',   label:'admin_service',         sub:'admin_service.jsw',                       layer:'service', w:128, h:50 },
  { id:'s-car',   label:'carrierAdminService',   sub:'carrierAdminService.jsw',                 layer:'service', w:158, h:50 },
  { id:'s-mat',   label:'admin_match_service',   sub:'admin_match_service.jsw',                 layer:'service', w:155, h:50 },
  { id:'s-air',   label:'aiRouterService',       sub:'aiRouterService.jsw · cost optimizer',    layer:'service', w:158, h:50 },
  { id:'s-obs',   label:'observabilityService',  sub:'observabilityService.jsw · anomalies',    layer:'service', w:162, h:50 },
  { id:'s-aud',   label:'admin_audit_service',   sub:'admin_audit_service.jsw',                 layer:'service', w:155, h:50 },
  { id:'s-fea',   label:'featureAdoptionSvc',    sub:'featureAdoptionService.jsw',              layer:'service', w:155, h:50 },
  { id:'s-agt',   label:'agentService',          sub:'agentService.jsw · orchestrator · 4 roles',layer:'service', w:168, h:50 },
  { id:'s-voi',   label:'voiceService',          sub:'voiceService.jsw · VAPI REST wrapper',    layer:'service', w:148, h:50 },
  { id:'s-meta',  label:'metaGovernanceSvc',     sub:'metaGovernanceService.jsw',               layer:'service', w:158, h:50 },
  { id:'s-rag',   label:'ragAnalyticsService',   sub:'ragAnalyticsService.jsw',                 layer:'service', w:155, h:50 },
  { id:'s-con',   label:'admin_content_service', sub:'admin_content_service.jsw',               layer:'service', w:162, h:50 },
  { id:'s-gam',   label:'gamificationService',   sub:'gamificationService.jsw',                 layer:'service', w:155, h:50 },
  { id:'s-led',   label:'agentRunLedgerSvc',     sub:'agentRunLedgerService.jsw · gates',       layer:'service', w:160, h:50 },
  { id:'s-out',   label:'agentOutcomeService',   sub:'agentOutcomeService.jsw · scoring',       layer:'service', w:155, h:50 },
  { id:'s-rin',   label:'ragIngestionService',   sub:'ragIngestionService.jsw',                 layer:'service', w:158, h:50 },
  { id:'s-rfr',   label:'ragFreshnessJob',       sub:'ragFreshnessJob.jsw',                     layer:'service', w:145, h:50 },
  // Data
  { id:'d-air',   label:'Airtable — LMDR Base',  sub:'app9N1YCJ3gdhExA0 · ~162 tables',        layer:'data', w:178, h:50 },
  { id:'d-dlk',   label:'Airtable — DataLake',   sub:'appt00rHHBOiKx9xl · RAW signals',        layer:'data', w:175, h:50 },
  { id:'d-wix',   label:'Wix Collections',       sub:'AdminUsers · MemberNotifications',        layer:'data', w:168, h:50 },
];

var NM = {};
ALL_NODES.forEach(function(n) { NM[n.id] = n; });

// [from, to, type]
var ALL_CONNS = [
  ['html-shells','p-dash','postmessage'],['html-shells','p-drv','postmessage'],
  ['html-shells','p-car','postmessage'],['html-shells','p-mat','postmessage'],
  ['html-shells','p-air','postmessage'],['html-shells','p-obs','postmessage'],
  ['html-shells','p-aud','postmessage'],['html-shells','p-feat','postmessage'],
  ['html-shells','p-con','postmessage'],['html-shells','p-gam','postmessage'],
  ['html-shells','p-b2b','postmessage'],['html-shells','p-b2bd','postmessage'],
  // module chain
  ['html-config','html-bridge','dependency'],['html-bridge','html-render','dependency'],
  ['html-render','html-logic','dependency'],
  ['html-logic','p-car','postmessage'],
  ['p-car','html-render','postmessage'],
  // page → service
  ['p-dash','s-dash','service-call'],['p-dash','s-fea','service-call'],
  ['p-dash','s-agt','service-call'],['p-dash','s-meta','service-call'],
  ['p-dash','s-led','service-call'],['p-dash','s-obs','service-call'],
  ['p-dash','s-out','service-call'],['p-dash','s-voi','service-call'],
  ['p-drv','s-adm','service-call'],['p-car','s-car','service-call'],
  ['p-mat','s-mat','service-call'],['p-air','s-air','service-call'],
  ['p-obs','s-obs','service-call'],['p-obs','s-rag','service-call'],
  ['p-obs','s-rin','service-call'],['p-obs','s-rfr','service-call'],
  ['p-aud','s-aud','service-call'],['p-feat','s-fea','service-call'],
  ['p-con','s-con','service-call'],['p-gam','s-gam','service-call'],
  // service → data
  ['s-dash','d-air','data-flow'],['s-adm','d-air','data-flow'],
  ['s-car','d-air','data-flow'],['s-mat','d-air','data-flow'],
  ['s-air','d-air','data-flow'],['s-obs','d-air','data-flow'],
  ['s-aud','d-air','data-flow'],['s-fea','d-air','data-flow'],
  ['s-agt','d-air','data-flow'],['s-voi','d-air','data-flow'],
  ['s-con','d-air','data-flow'],['s-gam','d-air','data-flow'],
  ['s-led','d-air','data-flow'],['s-out','d-air','data-flow'],
  ['s-rin','d-air','data-flow'],['s-rfr','d-air','data-flow'],
  ['s-rag','d-dlk','data-flow'],['s-rfr','d-dlk','data-flow'],
  ['s-obs','d-wix','data-flow'],
];

// ── PRESETS ───────────────────────────────────────────────────────────────────

function p(id,x,y){ return {id:id,x:x,y:y}; }

var PRESETS = {
  full: {
    desc: 'All 12 admin pages, 16 backend services, and 3 data stores',
    positions: [
      p('html-shells',470,35),
      p('p-dash',30,130), p('p-drv',200,130), p('p-car',358,130), p('p-mat',516,130), p('p-air',674,130), p('p-obs',840,130),
      p('p-aud',30,200), p('p-feat',196,200), p('p-con',368,200), p('p-gam',516,200), p('p-b2b',664,200), p('p-b2bd',820,200),
      p('s-dash',30,305), p('s-adm',210,305), p('s-car',350,305), p('s-mat',520,305), p('s-air',686,305), p('s-obs',856,305),
      p('s-aud',30,375), p('s-fea',196,375), p('s-agt',362,375), p('s-voi',542,375), p('s-meta',700,375), p('s-rag',870,375),
      p('s-con',30,445), p('s-gam',202,445), p('s-led',368,445), p('s-out',538,445), p('s-rin',704,445), p('s-rfr',872,445),
      p('d-wix',110,545), p('d-air',420,545), p('d-dlk',710,545),
    ],
  },
  dashboard: {
    desc: 'ADMIN_DASHBOARD wired to all 8 backend services it orchestrates',
    positions: [
      p('html-shells',380,35), p('p-dash',380,135),
      p('s-dash',30,280), p('s-fea',210,280), p('s-agt',385,280), p('s-meta',565,280), p('s-led',735,280),
      p('s-obs',110,375), p('s-out',310,375), p('s-voi',510,375),
      p('d-air',310,490), p('d-wix',580,490),
    ],
  },
  bridge: {
    desc: 'CDN shell pattern — HTML modules wired through postMessage to Wix page code and backend',
    positions: [
      p('html-config',45,55), p('html-bridge',188,55), p('html-render',330,55), p('html-logic',472,55),
      p('p-car',290,200), p('s-car',290,345), p('d-air',290,490),
    ],
  },
  agent: {
    desc: 'AI agent orchestration — agentService, ledger, outcomes, voice all wired through ADMIN_DASHBOARD',
    positions: [
      p('html-shells',380,35), p('p-dash',380,135),
      p('s-agt',60,285), p('s-led',248,285), p('s-out',438,285), p('s-voi',628,285), p('s-meta',818,285),
      p('s-obs',160,395), p('s-fea',480,395),
      p('d-air',440,510),
    ],
  },
  observability: {
    desc: 'Monitoring stack — observabilityService plus RAG pipeline (analytics, ingestion, freshness)',
    positions: [
      p('html-shells',420,35), p('p-obs',420,135),
      p('s-obs',60,285), p('s-rag',268,285), p('s-rin',472,285), p('s-rfr',672,285),
      p('d-air',200,430), p('d-dlk',540,430),
    ],
  },
};

// ── STATE ─────────────────────────────────────────────────────────────────────

var S = {
  preset: 'full',
  layers: { html:true, page:true, service:true, data:true },
  conns: { 'postmessage':true, 'service-call':true, 'data-flow':true },
  comments: [], nextId: 1,
  zoom: 1, panX: 15, panY: 15,
  panning: false, lastX: 0, lastY: 0,
  modalNode: null,
};

// ── SVG HELPERS ───────────────────────────────────────────────────────────────

var svg  = document.getElementById('canvas');
var cg   = document.getElementById('cg');
var defs = document.getElementById('defs-el');
var NS   = 'http://www.w3.org/2000/svg';

function se(tag, attrs, parent) {
  var el = document.createElementNS(NS, tag);
  Object.keys(attrs).forEach(function(k){ el.setAttribute(k, attrs[k]); });
  if (parent) parent.appendChild(el);
  return el;
}

function setupMarkers() {
  while (defs.firstChild) defs.removeChild(defs.firstChild);
  [['postmessage','#a78bfa'],['service-call','#34d399'],['data-flow','#60a5fa'],['dependency','#4a5568']].forEach(function(pair) {
    var id = pair[0], c = pair[1];
    var m = se('marker',{id:'arr-'+id,markerWidth:'8',markerHeight:'6',refX:'7',refY:'3',orient:'auto'});
    var poly = se('polygon',{points:'0 0, 8 3, 0 6',fill:c},m);
    defs.appendChild(m);
  });
}

function bez(x1,y1,x2,y2,horiz) {
  if (horiz) {
    var mx = (x1+x2)/2;
    return 'M '+x1+' '+y1+' C '+mx+' '+y1+', '+mx+' '+y2+', '+x2+' '+y2;
  }
  var dy = Math.max(Math.abs(y2-y1)*0.42, 28);
  return 'M '+x1+' '+y1+' C '+x1+' '+(y1+dy)+', '+x2+' '+(y2-dy)+', '+x2+' '+y2;
}

// ── RENDER ────────────────────────────────────────────────────────────────────

function getVisible() {
  var preset = PRESETS[S.preset];
  var posMap = {};
  preset.positions.forEach(function(p){ posMap[p.id] = p; });
  return Object.keys(posMap).map(function(id){
    var n = NM[id];
    if (!n || !S.layers[n.layer]) return null;
    var pos = posMap[id];
    return { id:n.id, label:n.label, sub:n.sub, layer:n.layer, w:n.w, h:n.h, x:pos.x, y:pos.y };
  }).filter(Boolean);
}

function getVisConns(nodes) {
  var ids = {};
  nodes.forEach(function(n){ ids[n.id] = true; });
  return ALL_CONNS.filter(function(c){
    if (!ids[c[0]] || !ids[c[1]]) return false;
    if (c[2] === 'dependency') return S.layers.html;
    return S.conns[c[2]];
  });
}

function render() {
  while (cg.firstChild) cg.removeChild(cg.firstChild);
  cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')');

  var nodes = getVisible();
  var np = {};
  nodes.forEach(function(n){ np[n.id] = n; });
  var conns = getVisConns(nodes);

  // Layer labels
  var lyrY = {};
  nodes.forEach(function(n){
    if (!lyrY[n.layer]) lyrY[n.layer] = { minY:9999, maxY:-9999, minX:9999 };
    if (n.y < lyrY[n.layer].minY) lyrY[n.layer].minY = n.y;
    if (n.x < lyrY[n.layer].minX) lyrY[n.layer].minX = n.x;
  });
  Object.keys(lyrY).forEach(function(layer) {
    var r = lyrY[layer];
    var lbl = se('text',{
      x: r.minX, y: r.minY-7,
      fill: LC[layer].stroke, 'font-size':'9', 'font-weight':'700',
      'font-family':"-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",
      'letter-spacing':'0.07em', opacity:'0.9',
    }, cg);
    lbl.textContent = LNAMES[layer] || layer.toUpperCase();
  });

  // Connections
  conns.forEach(function(conn) {
    var fid=conn[0], tid=conn[1], type=conn[2];
    var f = np[fid], t = np[tid];
    if (!f || !t) return;
    var st = CS[type] || CS['dependency'];
    var fcx = f.x+f.w/2, fcy = f.y+f.h/2;
    var tcx = t.x+t.w/2, tcy = t.y+t.h/2;
    var horiz = Math.abs(fcy-tcy) < 35;
    var d = horiz ? bez(f.x+f.w, fcy, t.x, tcy, true) : bez(fcx, f.y+f.h, tcx, t.y, false);
    var attrs = { d:d, stroke:st.color, 'stroke-width':'1.5', fill:'none',
      'marker-end':'url(#arr-'+type+')', opacity:'0.55' };
    var path = se('path', attrs, cg);
    if (st.dash) path.setAttribute('stroke-dasharray', st.dash);
  });

  // Nodes
  nodes.forEach(function(n) {
    var c = LC[n.layer];
    var hasC = S.comments.some(function(cm){ return cm.target === n.id; });
    var g = se('g', {'data-id': n.id}, cg);
    g.style.cursor = 'pointer';

    se('rect',{
      x:n.x, y:n.y, width:n.w, height:n.h, rx:'7',
      fill:c.fill, stroke: hasC ? '#f6ad55' : c.stroke,
      'stroke-width': hasC ? '2.5' : '1.5',
    }, g);

    var lbl = se('text',{
      x:n.x+n.w/2, y:n.y+17, 'text-anchor':'middle', fill:c.text,
      'font-size':'11', 'font-weight':'700',
      'font-family':"-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",
    }, g);
    lbl.textContent = n.label;

    var maxCh = Math.floor(n.w/6.2);
    var subStr = n.sub.length > maxCh ? n.sub.slice(0, maxCh-1)+'…' : n.sub;
    var sub = se('text',{
      x:n.x+n.w/2, y:n.y+31, 'text-anchor':'middle', fill:c.text, opacity:'0.55',
      'font-size':'8.5', 'font-family':"'Menlo','Monaco','Courier New',monospace",
    }, g);
    sub.textContent = subStr;

    if (hasC) se('circle',{cx:n.x+n.w-7, cy:n.y+7, r:'5', fill:'#f6ad55'}, g);

    g.addEventListener('click', function(e){ e.stopPropagation(); openModal(n); });
    var rect = g.querySelector('rect');
    g.addEventListener('mouseenter', function(){ rect.style.filter='brightness(1.12)'; });
    g.addEventListener('mouseleave', function(){ rect.style.filter=''; });
  });

  document.getElementById('zoom-ind').textContent = Math.round(S.zoom*100)+'%';
}

// ── PROMPT ────────────────────────────────────────────────────────────────────

function updatePrompt() {
  var preset = PRESETS[S.preset];
  var nodes = getVisible();
  var pages = nodes.filter(function(n){ return n.layer==='page'; });
  var svcs  = nodes.filter(function(n){ return n.layer==='service'; });
  var data  = nodes.filter(function(n){ return n.layer==='data'; });
  var parts = ['This is the LMDR Admin OS architecture. View: '+S.preset+' — '+preset.desc+'.',''];
  if (pages.length) parts.push('Admin pages ('+pages.length+'): '+pages.map(function(n){return n.label;}).join(', ')+'.');
  if (svcs.length)  parts.push('Backend services ('+svcs.length+'): '+svcs.map(function(n){return n.label;}).join(', ')+'.');
  if (data.length)  parts.push('Data stores: '+data.map(function(n){return n.label;}).join(', ')+'.');
  var offL = Object.keys(S.layers).filter(function(k){ return !S.layers[k]; });
  if (offL.length) parts.push('Hidden layers: '+offL.join(', ')+'.');
  if (S.comments.length) {
    parts.push('','Feedback on specific components:','');
    S.comments.forEach(function(cm){
      var n = NM[cm.target];
      parts.push('**'+cm.targetLabel+'** ('+(n?n.sub:cm.target)+'):');
      parts.push(cm.text,'');
    });
  } else {
    parts.push('','(Click any node to add a comment or question.)');
  }
  document.getElementById('prompt-output').value = parts.join('\n');
}

// ── MODAL ─────────────────────────────────────────────────────────────────────

function openModal(n) {
  S.modalNode = n;
  document.getElementById('modal-title').textContent = n.label;
  document.getElementById('modal-sub').textContent = n.sub;
  var ex = S.comments.filter(function(c){ return c.target===n.id; })[0];
  document.getElementById('modal-ta').value = ex ? ex.text : '';
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-ta').focus();
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  S.modalNode = null;
}

function saveComment() {
  var text = document.getElementById('modal-ta').value.trim();
  if (!S.modalNode) { closeModal(); return; }
  var n = S.modalNode;
  S.comments = S.comments.filter(function(c){ return c.target!==n.id; });
  if (text) S.comments.push({ id:S.nextId++, target:n.id, targetLabel:n.label, text:text });
  closeModal(); renderComments(); render(); updatePrompt();
}

function renderComments() {
  var list = document.getElementById('clist');
  document.getElementById('ctitle').textContent = 'Comments ('+S.comments.length+')';
  while (list.firstChild) list.removeChild(list.firstChild);
  if (!S.comments.length) {
    var msg = document.createElement('div');
    msg.style.cssText = 'color:#4a5568;font-size:11px;font-style:italic';
    msg.textContent = 'Click any node to add a note.';
    list.appendChild(msg);
    return;
  }
  S.comments.forEach(function(cm) {
    var item = document.createElement('div');
    item.className = 'citem';

    var del = document.createElement('button');
    del.className = 'cdel';
    del.textContent = '×';
    del.setAttribute('aria-label', 'Delete comment');
    del.addEventListener('click', function() {
      S.comments = S.comments.filter(function(c){ return c.id !== cm.id; });
      renderComments(); render(); updatePrompt();
    });

    var tgt = document.createElement('div');
    tgt.className = 'ctarget';
    tgt.textContent = cm.targetLabel;

    var txt = document.createElement('div');
    txt.className = 'ctext';
    txt.textContent = cm.text.length > 90 ? cm.text.slice(0,90)+'…' : cm.text;

    item.appendChild(del);
    item.appendChild(tgt);
    item.appendChild(txt);
    list.appendChild(item);
  });
}

// ── PAN + ZOOM ────────────────────────────────────────────────────────────────

var wrap = document.getElementById('canvas-wrap');

wrap.addEventListener('mousedown', function(e) {
  if (e.target.closest('[data-id]')) return;
  S.panning = true; S.lastX = e.clientX; S.lastY = e.clientY;
});
window.addEventListener('mousemove', function(e) {
  if (!S.panning) return;
  S.panX += e.clientX - S.lastX; S.panY += e.clientY - S.lastY;
  S.lastX = e.clientX; S.lastY = e.clientY;
  cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')');
  document.getElementById('zoom-ind').textContent = Math.round(S.zoom*100)+'%';
});
window.addEventListener('mouseup', function(){ S.panning = false; });

wrap.addEventListener('wheel', function(e) {
  e.preventDefault();
  var delta = e.deltaY > 0 ? 0.88 : 1.12;
  S.zoom = Math.max(0.25, Math.min(3.5, S.zoom * delta));
  cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')');
  document.getElementById('zoom-ind').textContent = Math.round(S.zoom*100)+'%';
}, { passive: false });

document.getElementById('zoom-in').addEventListener('click', function() {
  S.zoom = Math.min(3.5, S.zoom*1.2);
  cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')');
  document.getElementById('zoom-ind').textContent = Math.round(S.zoom*100)+'%';
});
document.getElementById('zoom-out').addEventListener('click', function() {
  S.zoom = Math.max(0.25, S.zoom/1.2);
  cg.setAttribute('transform','translate('+S.panX+','+S.panY+') scale('+S.zoom+')');
  document.getElementById('zoom-ind').textContent = Math.round(S.zoom*100)+'%';
});
document.getElementById('zoom-reset').addEventListener('click', function() {
  S.zoom=1; S.panX=15; S.panY=15; render(); updatePrompt();
});

// ── CONTROLS WIRING ───────────────────────────────────────────────────────────

document.querySelectorAll('.preset-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    S.preset = btn.dataset.preset;
    S.zoom=1; S.panX=15; S.panY=15;
    document.querySelectorAll('.preset-btn').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    render(); updatePrompt();
  });
});

document.querySelectorAll('[data-layer]').forEach(function(cb) {
  cb.addEventListener('change', function(){ S.layers[cb.dataset.layer]=cb.checked; render(); updatePrompt(); });
});

document.querySelectorAll('[data-conn]').forEach(function(cb) {
  cb.addEventListener('change', function(){ S.conns[cb.dataset.conn]=cb.checked; render(); updatePrompt(); });
});

document.getElementById('modal-cancel').addEventListener('click', closeModal);
document.getElementById('modal-save').addEventListener('click', saveComment);
document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});
document.getElementById('modal-ta').addEventListener('keydown', function(e) {
  if (e.key==='Enter' && e.metaKey) saveComment();
  if (e.key==='Escape') closeModal();
});

document.getElementById('copy-btn').addEventListener('click', function() {
  var text = document.getElementById('prompt-output').value;
  navigator.clipboard.writeText(text).then(function() {
    var btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!'; btn.classList.add('copied');
    setTimeout(function(){ btn.textContent='Copy Prompt'; btn.classList.remove('copied'); }, 2000);
  });
});

// ── INIT ──────────────────────────────────────────────────────────────────────
setupMarkers();
renderComments();
render();
updatePrompt();
</script>
</body>
</html>
