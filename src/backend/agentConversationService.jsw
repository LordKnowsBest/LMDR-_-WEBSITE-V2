// ============================================================================
// AGENT CONVERSATION SERVICE - Manages conversation history and context
// ============================================================================

import * as dataAccess from 'backend/dataAccess';

const COLLECTIONS = {
  conversations: 'agentConversations',
  turns: 'agentTurns'
};

export async function createConversation(role, userId) {
  const record = {
    role,
    userId,
    startedAt: new Date().toISOString(),
    status: 'active',
    turnCount: 0
  };

  const result = await dataAccess.insertRecord(COLLECTIONS.conversations, record, { suppressAuth: true });
  return { conversationId: result.record?._id || result.record?.id, ...record };
}

export async function addTurn(conversationId, role, content, toolCalls = null) {
  const record = {
    conversationId,
    role,
    content: typeof content === 'string' ? content : JSON.stringify(content),
    toolCalls: toolCalls ? JSON.stringify(toolCalls) : null,
    timestamp: new Date().toISOString()
  };

  await dataAccess.insertRecord(COLLECTIONS.turns, record, { suppressAuth: true });
  return record;
}

export async function getRecentContext(conversationId, maxTurns = 20) {
  const result = await dataAccess.queryRecords(COLLECTIONS.turns, {
    filters: { conversationId },
    limit: maxTurns,
    sort: { timestamp: 'asc' },
    suppressAuth: true
  });

  return (result.items || []).map(item => ({
    role: item.role,
    content: item.content,
    toolCalls: item.toolCalls ? JSON.parse(item.toolCalls) : null,
    timestamp: item.timestamp
  }));
}

export async function getConversation(conversationId) {
  const result = await dataAccess.queryRecords(COLLECTIONS.conversations, {
    filters: { _id: conversationId },
    limit: 1,
    suppressAuth: true
  });

  return result.items?.[0] || null;
}

export async function endConversation(conversationId) {
  return await dataAccess.updateRecord(COLLECTIONS.conversations, {
    _id: conversationId,
    status: 'ended',
    endedAt: new Date().toISOString()
  }, { suppressAuth: true });
}
