import {
  CONFIG,
  getStripeSecrets,
  stripeRequest,
  getSubscriptionByCarrier,
  getApiPartner,
  getApiPriceId,
  getApiSubscriptionByPartner,
  getBillingHistory as coreGetBillingHistory,
  getApiBillingSummary as coreGetApiBillingSummary,
  getCheckoutSession as coreGetCheckoutSession,
  createPlacementDepositCheckout as coreCreatePlacementDepositCheckout
} from 'backend/stripeCore';

// ============================================================================
// CHECKOUT SESSION
// ============================================================================

export async function createCheckoutSession(priceId, carrierDot, email, successUrl, cancelUrl, billingPeriod = 'monthly') {
  try {
    if (!priceId || !carrierDot || !email) return { success: false, error: 'Missing required parameters' };
    const secrets = await getStripeSecrets();
    let resolvedPriceId = priceId;

    if (priceId === 'pro') {
      resolvedPriceId = (billingPeriod === '6month' && secrets.pricePro6Month) ? secrets.pricePro6Month : (secrets.priceProMonthly || secrets.pricePro);
    } else if (priceId === 'enterprise') {
      resolvedPriceId = (billingPeriod === '6month' && secrets.priceEnterprise6Month) ? secrets.priceEnterprise6Month : secrets.priceEnterprise;
    }

    if (!resolvedPriceId) return { success: false, error: 'Invalid price ID configuration' };

    const existing = await getSubscriptionByCarrier(carrierDot);
    if (existing && existing.status === 'active') return { success: false, error: 'Already has active subscription' };

    const sessionData = await stripeRequest('/checkout/sessions', 'POST', {
      'mode': 'subscription', 'payment_method_types[0]': 'card', 'line_items[0][price]': resolvedPriceId, 'line_items[0][quantity]': '1', 'customer_email': email,
      'success_url': successUrl || 'https://www.lastmiledr.app/subscription-success?session_id={CHECKOUT_SESSION_ID}',
      'cancel_url': cancelUrl || 'https://www.lastmiledr.app/subscription-canceled',
      'metadata[carrier_dot]': carrierDot, 'subscription_data[metadata][carrier_dot]': carrierDot
    });

    return { success: true, checkoutUrl: sessionData.url, sessionId: sessionData.id };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// ============================================================================
// CUSTOMER PORTAL
// ============================================================================

export async function createPortalSession(carrierDot, returnUrl) {
  try {
    const subscription = await getSubscriptionByCarrier(carrierDot);
    if (!subscription || !subscription.stripe_customer_id) return { success: false, error: 'No subscription found' };

    const portalData = await stripeRequest('/billing_portal/sessions', 'POST', {
      'customer': subscription.stripe_customer_id,
      'return_url': returnUrl || 'https://www.lastmiledr.app/recruiter-console'
    });

    return { success: true, portalUrl: portalData.url };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// ============================================================================
// SUBSCRIPTION QUERIES
// ============================================================================

export async function getSubscriptionDetails(carrierDot) {
  try {
    const subscription = await getSubscriptionByCarrier(carrierDot);
    if (!subscription) return { success: true, subscription: null, tier: 'free', usage: { viewsUsed: 0, viewsLimit: 5, viewsRemaining: 5 } };

    const tier = subscription.plan_type || 'free';
    const planConfig = CONFIG.plans[tier] || { monthlyQuota: 5 };
    const viewsUsed = subscription.views_used_this_month || 0;
    const viewsLimit = planConfig.monthlyQuota === -1 ? Infinity : planConfig.monthlyQuota;

    return {
      success: true,
      subscription: { id: subscription._id, stripeSubscriptionId: subscription.stripe_subscription_id, planType: tier, status: subscription.status || 'active' },
      tier,
      usage: { viewsUsed, viewsLimit: planConfig.monthlyQuota === -1 ? 'unlimited' : viewsLimit, viewsRemaining: planConfig.monthlyQuota === -1 ? 'unlimited' : Math.max(0, viewsLimit - viewsUsed) }
    };
  } catch (error) { return { success: false, error: error.message }; }
}

export async function getBillingHistory(carrierDot, limit = 50) {
  return coreGetBillingHistory(carrierDot, limit);
}

// ============================================================================
// STRIPE PUBLIC INFO
// ============================================================================

export async function getPublishableKey() {
  try {
    const secrets = await getStripeSecrets();
    return { success: true, publishableKey: secrets.publishableKey };
  } catch (error) { return { success: false, error: error.message }; }
}

export async function getCheckoutSession(sessionId) {
  return coreGetCheckoutSession(sessionId);
}

export async function createPlacementDepositCheckout(carrierDot, email, driverCount, successUrl, cancelUrl, formData = {}) {
  return coreCreatePlacementDepositCheckout(carrierDot, email, driverCount, successUrl, cancelUrl, formData);
}

// ============================================================================
// API PLATFORM BILLING
// ============================================================================

export async function createApiCheckoutSession(
  partnerId,
  tier = 'starter',
  planType = 'monthly',
  successUrl = null,
  cancelUrl = null
) {
  try {
    const normalizedTier = String(tier || 'starter').toLowerCase();
    const normalizedPlan = String(planType || 'monthly').toLowerCase();
    const partner = await getApiPartner(partnerId);
    if (!partner) return { success: false, error: 'Partner not found' };

    const priceId = await getApiPriceId(normalizedTier, normalizedPlan);
    if (!priceId) return { success: false, error: 'API tier price is not configured' };

    const sessionData = await stripeRequest('/checkout/sessions', 'POST', {
      'mode': 'subscription',
      'payment_method_types[0]': 'card',
      'line_items[0][price]': priceId,
      'line_items[0][quantity]': '1',
      'customer_email': partner.contact_email,
      'success_url': successUrl || 'https://www.lastmiledr.app/api-portal?billing=success&session_id={CHECKOUT_SESSION_ID}',
      'cancel_url': cancelUrl || 'https://www.lastmiledr.app/api-portal?billing=canceled',
      'metadata[partner_id]': partnerId,
      'metadata[api_tier]': normalizedTier,
      'metadata[product]': 'external_api_platform',
      'subscription_data[metadata][partner_id]': partnerId,
      'subscription_data[metadata][api_tier]': normalizedTier,
      'subscription_data[metadata][product]': 'external_api_platform'
    });

    return { success: true, checkoutUrl: sessionData.url, sessionId: sessionData.id };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

export async function createApiPortalSession(partnerId, returnUrl = null) {
  try {
    const subscription = await getApiSubscriptionByPartner(partnerId);
    if (!subscription?.stripe_customer_id) {
      return { success: false, error: 'No Stripe customer found for partner' };
    }

    const portalData = await stripeRequest('/billing_portal/sessions', 'POST', {
      'customer': subscription.stripe_customer_id,
      'return_url': returnUrl || 'https://www.lastmiledr.app/api-portal'
    });

    return { success: true, portalUrl: portalData.url };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

export async function getApiBillingSummary(partnerId, periodKey = null) {
  return coreGetApiBillingSummary(partnerId, periodKey);
}
