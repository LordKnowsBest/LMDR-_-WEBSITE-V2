/**
 * adminSupportAgentService.jsw
 * Thin wrapper for admin support operations agent actions.
 * Delegates to supportTicketService, knowledgeBaseService, npsService.
 */

import * as dataAccess from 'backend/dataAccess';

const COLLECTIONS = {
  supportTickets: 'supportTickets',
  ticketComments: 'ticketComments'
};

// ── 1. Get Support Tickets ───────────────────────────────────────
export async function getSupportTickets(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const ticketSvc = await import('backend/supportTicketService');
    const result = await ticketSvc.getTicketsList(params);
    return result;
  } catch (error) {
    console.error('[AdminSupport] getSupportTickets error:', error.message);
    return { error: error.message };
  }
}

// ── 2. Get Ticket Detail ─────────────────────────────────────────
export async function getTicketDetail(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.ticketId) return { error: 'params.ticketId is required' };

    const ticket = await dataAccess.getRecord(COLLECTIONS.supportTickets, params.ticketId, { suppressAuth: true });
    if (!ticket) return { error: 'Ticket not found' };

    const commentsResult = await dataAccess.queryRecords(COLLECTIONS.ticketComments, {
      filters: { ticket_id: params.ticketId },
      sort: [{ field: 'created_at', direction: 'asc' }],
      suppressAuth: true
    });

    return { ticket, comments: commentsResult.items || [] };
  } catch (error) {
    console.error('[AdminSupport] getTicketDetail error:', error.message);
    return { error: error.message };
  }
}

// ── 3. Update Ticket Status ──────────────────────────────────────
export async function updateTicketStatus(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.ticketId) return { error: 'params.ticketId is required' };

    const ticketSvc = await import('backend/supportTicketService');

    if (params.status === 'closed') {
      const result = await ticketSvc.changeTicketStatus(params.ticketId, 'closed', params.reason || '');
      return result;
    }

    // For other status changes, use changeTicketStatus as well
    if (params.status) {
      const result = await ticketSvc.changeTicketStatus(params.ticketId, params.status, params.reason || '');
      return result;
    }

    // If only priority update, use direct dataAccess
    if (params.priority) {
      const result = await dataAccess.updateRecord(COLLECTIONS.supportTickets, {
        _id: params.ticketId,
        priority: params.priority,
        updated_at: new Date().toISOString()
      }, { suppressAuth: true });
      return result;
    }

    return { error: 'params.status or params.priority is required' };
  } catch (error) {
    console.error('[AdminSupport] updateTicketStatus error:', error.message);
    return { error: error.message };
  }
}

// ── 4. Assign Ticket ─────────────────────────────────────────────
export async function assignTicket(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.ticketId) return { error: 'params.ticketId is required' };

    const ticketSvc = await import('backend/supportTicketService');
    const result = await ticketSvc.assignTicket(params.ticketId, params.agentId || userId);
    return result;
  } catch (error) {
    console.error('[AdminSupport] assignTicket error:', error.message);
    return { error: error.message };
  }
}

// ── 5. Get Knowledge Base ────────────────────────────────────────
export async function getKnowledgeBase(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const kbSvc = await import('backend/knowledgeBaseService');

    if (params.query) {
      const result = await kbSvc.searchArticles(params.query, params.filters || {});
      return result;
    }

    // No query — return all articles (searchArticles with empty query returns all)
    const result = await kbSvc.searchArticles('', params.filters || {});
    return result;
  } catch (error) {
    console.error('[AdminSupport] getKnowledgeBase error:', error.message);
    return { error: error.message };
  }
}

// ── 6. Create KB Article ─────────────────────────────────────────
export async function createKBArticle(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.title) return { error: 'params.title is required' };

    const kbSvc = await import('backend/knowledgeBaseService');
    const result = await kbSvc.createArticle({ ...params, author_id: userId });
    return result;
  } catch (error) {
    console.error('[AdminSupport] createKBArticle error:', error.message);
    return { error: error.message };
  }
}

// ── 7. Get NPS Scores ────────────────────────────────────────────
export async function getNPSScores(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const npsSvc = await import('backend/npsService');

    const days = params.days || 30;
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - days);

    const dateRange = { start: start.toISOString(), end: end.toISOString() };
    const result = await npsSvc.getNPSScore(dateRange, params.segment || null);
    return result;
  } catch (error) {
    console.error('[AdminSupport] getNPSScores error:', error.message);
    return { error: error.message };
  }
}

// ── 8. Get CSAT Report ───────────────────────────────────────────
export async function getCSATReport(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const npsSvc = await import('backend/npsService');

    const days = params.days || 30;
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - days);

    const dateRange = { start: start.toISOString(), end: end.toISOString() };

    // Get CSAT score (NPS service supports different survey types via segment)
    const csatResult = await npsSvc.getNPSScore(dateRange, { trigger: 'csat' });

    // Also get trend data for longer range
    const trendDays = params.trendDays || 90;
    const trendStart = new Date();
    trendStart.setDate(trendStart.getDate() - trendDays);
    const trendRange = { start: trendStart.toISOString(), end: end.toISOString() };
    const trendResult = await npsSvc.getNPSTrend(trendRange, 'weekly');

    return {
      csat: csatResult,
      trend: trendResult.trend || []
    };
  } catch (error) {
    console.error('[AdminSupport] getCSATReport error:', error.message);
    return { error: error.message };
  }
}
