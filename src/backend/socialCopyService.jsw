/**
 * Social Copy Service
 *
 * Generates platform-specific social media copy for CDL driver recruiting
 * using Gemini via aiRouterService.
 *
 * Each platform gets a distinct system prompt tuned for engagement.
 *
 * NOTE: The import uses `routeAIRequest` â€” that is the actual exported name
 * from aiRouterService.jsw (line 688). The brief requested `routeRequest`,
 * which does not exist. All internal calls below use `routeAIRequest`.
 */

import { routeAIRequest } from 'backend/aiRouterService';

// Platform character limits
const CHAR_LIMITS = {
  facebook:  63206,
  instagram: 2200,
  linkedin:  3000
};

// Platform-specific system prompts
const SYSTEM_PROMPTS = {
  facebook: `You are a social media copywriter for a CDL truck driver recruiting company called {companyName}.
Write a Facebook post to attract CDL-A drivers to apply.
Tone: Conversational, community-focused. Use storytelling. Ask one question to encourage comments.
Use 1-2 relevant emojis naturally. Keep under 300 characters (not counting hashtags).
End with a clear CTA: "Apply Now", "Message Us", or "Learn More".
Do NOT include hashtags.
Return only the post copy â€” no explanations, no quotes around it.`,

  instagram: `You are a social media copywriter for a CDL truck driver recruiting company called {companyName}.
Write an Instagram caption to attract CDL-A drivers to apply.
Tone: Casual, authentic, punchy. Use 3-5 emojis naturally throughout.
First sentence must be under 125 characters (shown before "more" cutoff) â€” make it a hook.
After the main copy, add one blank line, then include 8-12 relevant hashtags such as #CDLJobs #TruckDriver #CDLLife #TruckingJobs #HiringNow #CDLDriver #FreightLife #TruckerLife.
End the caption with: "Link in bio to apply ðŸ”—"
Return only the caption â€” no explanations, no quotes around it.`,

  linkedin: `You are a social media copywriter for a CDL truck driver recruiting company called {companyName}.
Write a LinkedIn post to attract CDL-A drivers to apply for open positions.
Tone: Professional, authoritative, value-driven. Lead with an industry insight, statistic, or challenge drivers face.
Use bullet points or a short numbered list to highlight 2-3 key benefits of the role.
Include 2-3 professional hashtags inline (e.g. #CDLJobs #TruckingIndustry #DriverRecruitment).
No emojis. Maximum 600 characters.
End with a professional CTA that invites drivers to apply or connect.
Return only the post copy â€” no explanations, no quotes around it.`
};

/**
 * Generate platform-specific social media copy
 * @param {Object} params
 * @param {string} params.brief - Short description of the post goal / job details
 * @param {string} params.platform - 'facebook' | 'instagram' | 'linkedin'
 * @param {string} params.companyName - Carrier/recruiter company name (auto-filled from profile)
 * @param {string} params.jobTitle - Optional job title to mention
 * @param {string} params.highlights - Optional comma-separated benefits (e.g. "home weekly, $0.65/mile, sign-on bonus")
 * @param {string} params.carrierDot - For logging/context
 */
export async function generatePlatformCopy({ brief, platform = 'facebook', companyName = 'our company', jobTitle = 'CDL-A Driver', highlights = '', carrierDot = '' }) {
  try {
    if (!SYSTEM_PROMPTS[platform]) {
      return { success: false, error: `Unsupported platform: ${platform}` };
    }

    const systemPrompt = SYSTEM_PROMPTS[platform].replace('{companyName}', companyName);

    const userMessage = buildUserMessage(brief, jobTitle, highlights, platform);

    const result = await routeAIRequest('social_copy_generation', {
      systemPrompt,
      userMessage,
      maxTokens: 500,
      temperature: 0.8
    });

    if (!result.success) {
      return { success: false, error: result.error || 'AI copy generation failed' };
    }

    const copy = (result.text || result.content || '').trim();
    const charLimit = CHAR_LIMITS[platform];

    return {
      success: true,
      copy,
      platform,
      charCount: copy.length,
      charLimit,
      overLimit: copy.length > charLimit
    };
  } catch (error) {
    console.error('[socialCopyService] generatePlatformCopy error:', error);
    return { success: false, error: error.message };
  }
}

function buildUserMessage(brief, jobTitle, highlights, platform) {
  let msg = `Write a ${platform} post for this context:\n`;
  msg += `- Job: ${jobTitle}\n`;
  if (brief) msg += `- Goal / brief: ${brief}\n`;
  if (highlights) msg += `- Key benefits to highlight: ${highlights}\n`;
  msg += `\nGenerate the post now.`;
  return msg;
}
