import wixData from 'wix-data';
import { usesAirtable, getWixCollectionName, getAirtableTableName } from 'backend/configData';
import * as airtable from 'backend/airtableClient';
import { getResponseTimeBadgeForStats } from 'backend/badgeService';

const CONFIG = {
    interestsCollection: 'DriverCarrierInterests'
};

/**
 * Get responsiveness stats for a specific carrier
 * Supports both Wix and Airtable data sources based on config
 */
export async function getRecruiterStats(dotNumber) {
    try {
        const dotString = String(dotNumber);
        const collectionKey = 'driverCarrierInterests';
        let interactions = [];

        if (usesAirtable(collectionKey)) {
            // Airtable path
            const tableName = getAirtableTableName(collectionKey);
            // Airtable formula to filter by carrier_dot and non-null recruiter_response_time
            const formula = `AND({Carrier DOT} = '${dotString}', {Recruiter Response Time} != BLANK())`;
            const result = await airtable.queryRecords(tableName, {
                filterByFormula: formula
            });
            interactions = result.records || [];
        } else {
            // Wix path
            const result = await wixData.query(CONFIG.interestsCollection)
                .eq('carrier_dot', dotString)
                .isNotNull('recruiter_response_time')
                .find({ suppressAuth: true });
            interactions = result.items;
        }

        if (interactions.length === 0) {
            return {
                dot_number: dotString,
                avg_response_hours: null,
                total_interactions: 0,
                badge: null
            };
        }

        let totalHours = 0;
        interactions.forEach(item => {
            totalHours += (item.recruiter_response_time || item['Recruiter Response Time'] || 0);
        });

        const avg = totalHours / interactions.length;

        // Use centralized badge calculation from badgeService for consistency
        const badgeInfo = getResponseTimeBadgeForStats(avg);

        return {
            dot_number: dotString,
            avg_response_hours: Math.round(avg * 10) / 10,
            total_interactions: interactions.length,
            badge: badgeInfo.badge,
            badge_color: badgeInfo.badge_color
        };
    } catch (error) {
        console.error(`‚ùå Error calculating recruiter stats for ${dotNumber}:`, error.message);
        return {
            dot_number: String(dotNumber),
            error: error.message
        };
    }
}
