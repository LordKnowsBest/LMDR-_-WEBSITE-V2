/**
 * adminPortalAgentService.jsw
 * Thin wrapper for admin portal agent actions.
 * Delegates to admin_dashboard_service, admin_service, admin_content_service, admin_audit_service.
 */

import * as dataAccess from 'backend/dataAccess';

const COLLECTIONS = {
  auditLog: 'auditLog',
  systemLogs: 'systemLogs'
};

// ── 1. Admin Dashboard ────────────────────────────────────────────
export async function getAdminDashboard(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const dashSvc = await import('backend/admin_dashboard_service');
    const result = await dashSvc.getDashboardOverview();
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] getAdminDashboard error:', error.message);
    return { error: error.message };
  }
}

// ── 2. User List ──────────────────────────────────────────────────
export async function getUserList(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const adminSvc = await import('backend/admin_service');
    const userType = params.userType || 'driver';

    if (userType === 'carrier') {
      const result = await adminSvc.getCarriersList(params);
      return result;
    }
    const result = await adminSvc.getDriversList(params);
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] getUserList error:', error.message);
    return { error: error.message };
  }
}

// ── 3. User Detail ────────────────────────────────────────────────
export async function getUserDetail(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.targetUserId) return { error: 'params.targetUserId is required' };
    const adminSvc = await import('backend/admin_service');
    const userType = params.userType || 'driver';

    if (userType === 'carrier') {
      const result = await adminSvc.getCarrierDetail(params.targetUserId);
      return result;
    }
    const result = await adminSvc.getDriverDetail(params.targetUserId);
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] getUserDetail error:', error.message);
    return { error: error.message };
  }
}

// ── 4. Suspend User ───────────────────────────────────────────────
export async function suspendUser(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.targetUserId) return { error: 'params.targetUserId is required' };
    const adminSvc = await import('backend/admin_service');
    const result = await adminSvc.suspendDriver(params.targetUserId, params.reason || 'Suspended by admin agent');
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] suspendUser error:', error.message);
    return { error: error.message };
  }
}

// ── 5. Unsuspend User ─────────────────────────────────────────────
export async function unsuspendUser(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.targetUserId) return { error: 'params.targetUserId is required' };
    const adminSvc = await import('backend/admin_service');
    const result = await adminSvc.updateDriverStatus(params.targetUserId, 'active');
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] unsuspendUser error:', error.message);
    return { error: error.message };
  }
}

// ── 6. Moderation Queue ───────────────────────────────────────────
export async function getModerationQueue(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const contentSvc = await import('backend/admin_content_service');
    const result = await contentSvc.getModerationQueue(params);
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] getModerationQueue error:', error.message);
    return { error: error.message };
  }
}

// ── 7. Moderate Content ───────────────────────────────────────────
export async function moderateContent(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.contentId) return { error: 'params.contentId is required' };
    if (!params.decision) return { error: 'params.decision is required' };

    const contentSvc = await import('backend/admin_content_service');
    const contentType = params.contentType || 'review';

    if (contentType === 'job') {
      const result = await contentSvc.updateJobStatus(params.contentId, params.decision);
      return result;
    }
    if (contentType === 'document') {
      const result = await contentSvc.updateDocumentStatus(params.contentId, params.docType, params.decision, params.reason);
      return result;
    }
    // Default: review
    const result = await contentSvc.updateReviewStatus(params.contentId, params.decision, params.reason);
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] moderateContent error:', error.message);
    return { error: error.message };
  }
}

// ── 8. AI Dashboard ───────────────────────────────────────────────
export async function getAIDashboard(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const dashSvc = await import('backend/admin_dashboard_service');
    const result = await dashSvc.getAIUsageStats(params.period || '30d');
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] getAIDashboard error:', error.message);
    return { error: error.message };
  }
}

// ── 9. Compliance Audit ───────────────────────────────────────────
export async function getComplianceAudit(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const auditSvc = await import('backend/admin_audit_service');
    const result = await auditSvc.getAuditLog(params);
    return result;
  } catch (error) {
    console.error('[AdminPortalAgent] getComplianceAudit error:', error.message);
    return { error: error.message };
  }
}

// ── 10. Login Activity ────────────────────────────────────────────
export async function getLoginActivity(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const page = params.page || 1;
    const pageSize = params.pageSize || 50;

    // Try auditLog collection first (filtered to login/auth events)
    const auditResult = await dataAccess.queryRecords(COLLECTIONS.auditLog, {
      filters: { category: 'auth' },
      sort: { field: 'created_at', order: 'desc' },
      limit: pageSize,
      skip: (page - 1) * pageSize,
      suppressAuth: true
    });

    if (auditResult.items && auditResult.items.length > 0) {
      return {
        items: auditResult.items,
        totalCount: auditResult.totalCount || auditResult.items.length,
        page,
        pageSize
      };
    }

    // Fallback: query systemLogs for auth events
    const logsResult = await dataAccess.queryRecords(COLLECTIONS.systemLogs, {
      filters: { category: 'auth' },
      sort: { field: 'created_at', order: 'desc' },
      limit: pageSize,
      skip: (page - 1) * pageSize,
      suppressAuth: true
    });

    return {
      items: logsResult.items || [],
      totalCount: logsResult.totalCount || (logsResult.items || []).length,
      page,
      pageSize
    };
  } catch (error) {
    console.error('[AdminPortalAgent] getLoginActivity error:', error.message);
    return { error: error.message };
  }
}
