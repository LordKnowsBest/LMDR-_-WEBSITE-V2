/**
 * Email Service
 * 
 * Handles sending transactional and notification emails to users.
 * Uses Wix Triggered Emails (wix-users-backend.emailUser).
 * 
 * @module backend/emailService
 */

import wixUsersBackend from 'wix-users-backend';
import { log } from 'backend/observabilityService';

// ============================================================================
// PUBLIC WEB METHODS
// ============================================================================

/**
 * Sends a confirmation email to the driver after a successful application.
 * 
 * @param {string} userId - The Wix User ID of the driver
 * @param {Object} data - variables to pass to the email template
 */
export async function sendApplicationConfirmation(userId, data) {
  try {
    const emailId = 'applicationConfirmation'; 

    const variables = {
      driverName: data.driverName || 'Driver',
      carrierName: data.carrierName || 'the carrier',
      carrierDot: data.carrierDot || '',
      applicationId: data.applicationId || ''
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending application confirmation:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends a notification email when application status changes.
 */
export async function sendStatusUpdateNotification(userId, data) {
  try {
    const emailId = 'statusUpdateNotification';

    const statusLabel = data.newStatus
      ? data.newStatus.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
      : 'Updated';

    const variables = {
      driverName: data.driverName || 'Driver',
      carrierName: data.carrierName || 'the carrier',
      newStatus: statusLabel,
      applicationId: data.applicationId || ''
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending status update:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends a notification email when a new message is received.
 */
export async function sendMessageNotification(userId, data) {
  try {
    const emailId = 'newMessageNotification';

    const preview = data.messagePreview
      ? data.messagePreview.substring(0, 100) + (data.messagePreview.length > 100 ? '...' : '')
      : 'New message';

    const dashboardUrl = data.isDriver
      ? 'https://www.lastmiledr.app/driver-dashboard'
      : 'https://www.lastmiledr.app/account/my-account';

    const variables = {
      recipientName: data.recipientName || 'User',
      senderName: data.senderName || 'Someone',
      messagePreview: preview,
      carrierName: data.carrierName || '',
      dashboardUrl: dashboardUrl
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending message notification:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends a compliance reminder or alert email.
 */
export async function sendComplianceNotification(userId, data) {
  try {
    let emailId = '';

    switch (data.type) {
      case '30_day': emailId = 'compliance_reminder_30_day'; break;
      case '14_day': emailId = 'compliance_reminder_14_day'; break;
      case '7_day': emailId = 'compliance_reminder_7_day'; break;
      case 'due_today': emailId = 'compliance_reminder_due_today'; break;
      case 'overdue': emailId = 'compliance_overdue'; break;
      default: throw new Error(`Invalid compliance notification type: ${data.type}`);
    }

    const variables = {
      eventTitle: data.eventTitle || 'Compliance Item',
      dueDate: data.dueDate || '',
      driverName: data.driverName || 'N/A',
      dashboardUrl: data.dashboardUrl || 'https://www.lastmiledr.app/carrier/compliance'
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending compliance notification:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends notification about a new incident.
 */
export async function sendIncidentNotification(userId, data) {
  try {
    const emailId = data.isReportable ? 'incident_dot_reportable' : 'incident_reported';

    const variables = {
      incidentNumber: data.incidentNumber,
      incidentType: data.type,
      dashboardUrl: 'https://www.lastmiledr.app/carrier/incidents'
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending incident notification:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends a weekly/monthly leaderboard announcement email.
 */
export async function sendLeaderboardAnnouncementEmail(userId, data) {
  try {
    const emailId = 'leaderboard_announcement';

    const rankSuffix = getRankSuffix(data.rank);
    const rankDisplay = `${data.rank}${rankSuffix}`;
    const periodName = data.period === 'weekly' ? 'This Week' : 'This Month';

    let topThreeDisplay = '';
    if (data.topThree && data.topThree.length > 0) {
      topThreeDisplay = data.topThree
        .slice(0, 3)
        .map((r, i) => `${i + 1}. ${r.recruiterName || 'Recruiter'} - ${r.displayValue || r.score}`)
        .join('\n');
    }

    const variables = {
      recruiterName: data.recruiterName || 'Recruiter',
      rank: rankDisplay,
      score: data.score || 0,
      periodName: periodName,
      leaderboardType: formatLeaderboardType(data.leaderboardType),
      periodStart: data.periodStart || '',
      periodEnd: data.periodEnd || '',
      topThreeDisplay: topThreeDisplay,
      leaderboardUrl: 'https://www.lastmiledr.app/recruiter/leaderboard'
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending leaderboard email:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Send batch leaderboard announcements
 */
export async function sendBatchLeaderboardAnnouncements(topRecruiters, period, leaderboardType, periodStart, periodEnd) {
  const results = { sent: 0, failed: 0, details: [] };
  const topThree = topRecruiters.slice(0, 3);

  // Consider using chunking if this list is long, though usually it's top 10
  for (const recruiter of topRecruiters) {
    if (!recruiter.recruiterId) {
      results.details.push({ rank: recruiter.rank, status: 'skipped', reason: 'no_user_id' });
      continue;
    }

    const emailResult = await sendLeaderboardAnnouncementEmail(recruiter.recruiterId, {
      recruiterName: recruiter.recruiterName,
      rank: recruiter.rank,
      score: recruiter.score,
      period,
      leaderboardType,
      periodStart,
      periodEnd,
      topThree
    });

    if (emailResult.success) {
      results.sent++;
      results.details.push({ rank: recruiter.rank, recruiterId: recruiter.recruiterId, status: 'sent' });
    } else {
      results.failed++;
      results.details.push({ rank: recruiter.rank, recruiterId: recruiter.recruiterId, status: 'failed', error: emailResult.error });
    }
  }

  return results;
}

/**
 * Sends an intervention email to a driver.
 */
export async function sendInterventionEmail(driverUserId, subject, body) {
  try {
    const emailId = 'interventionEmail';

    const variables = {
      subject: subject || 'Important message from your carrier',
      body: body || '',
      dashboardUrl: 'https://www.lastmiledr.app/driver-dashboard'
    };

    await wixUsersBackend.emailUser(emailId, driverUserId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending intervention email:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends a severe weather alert email.
 */
export async function sendWeatherAlertEmail(userId, data) {
  try {
    const emailId = 'weather_alert_severe';

    const variables = {
      headline: data.headline || 'Severe Weather Alert',
      severity: data.severity || 'Severe',
      event: data.event || 'Weather Alert',
      location: data.location || 'Your Area',
      description: data.description ? data.description.substring(0, 150) + '...' : 'Check app for details.',
      dashboardUrl: 'https://www.lastmiledr.app/driver/road-utilities'
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending weather alert:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Sends a reminder email for a requested document.
 */
export async function sendDocumentReminderEmail(userId, data) {
  try {
    const emailId = 'document_reminder';

    const variables = {
      documentName: data.documentName || 'Document',
      uploadUrl: data.uploadUrl || 'https://lastmilecdl.com/document-upload',
      driverName: data.driverName || 'Driver'
    };

    await wixUsersBackend.emailUser(emailId, userId, {
      variables: variables
    });

    return { success: true };
  } catch (error) {
    console.error('[emailService] Error sending document reminder:', error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Placeholder for payment receipt email.
 */
export async function sendPaymentReceivedEmail(email, data) {
  // In a real implementation, this might use a different provider (SendGrid, Postmark)
  // as triggered emails usually require a Wix Member ID.
  console.log(`[emailService] Payment receipt logic needed for ${email}`);
  return { success: true, method: 'log_only_placeholder' };
}

// ============================================================================
// HELPERS
// ============================================================================

function getRankSuffix(rank) {
  if (rank === 1) return 'st';
  if (rank === 2) return 'nd';
  if (rank === 3) return 'rd';
  return 'th';
}

function formatLeaderboardType(type) {
  const typeNames = {
    'overall': 'Top Recruiters',
    'hires': 'Top Hirers',
    'response_time': 'Fastest Responders',
    'retention': 'Retention Leaders'
  };
  return typeNames[type] || 'Leaderboard';
}