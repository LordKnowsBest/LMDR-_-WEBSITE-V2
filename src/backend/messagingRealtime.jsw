import wixUsersBackend from 'wix-users-backend';
import * as dataAccess from 'backend/dataAccess';

// Collection keys for dataAccess routing
const COLLECTION_KEYS = {
    messages: 'messages'
};

// ============================================================================
// GET NEW MESSAGES (For Polling)
// ============================================================================

/**
 * Fetches messages newer than a given timestamp for efficient polling.
 */
export async function getNewMessages(applicationId, sinceTimestamp) {
    if (!applicationId) return { success: false, error: 'Missing applicationId' };

    try {
        const userId = await getCurrentUserId();
        if (!userId) return { success: false, error: 'Not authenticated' };

        const sinceDate = sinceTimestamp ? new Date(sinceTimestamp) : new Date(0);

        const result = await dataAccess.queryRecords(COLLECTION_KEYS.messages, {
            filters: {
                application_id: applicationId,
                timestamp: { gt: sinceDate }
            },
            sort: [{ field: 'timestamp', direction: 'asc' }],
            suppressAuth: true
        });

        const items = result.items || [];
        return {
            success: true,
            messages: items,
            hasNew: items.length > 0,
            latestTimestamp: items.length > 0 ? items[items.length - 1].timestamp : sinceTimestamp
        };
    } catch (error) {
        console.error('Error fetching new messages:', error);
        return { success: false, error: error.message };
    }
}

// ============================================================================
// GET UNREAD COUNT FOR USER
// ============================================================================

/**
 * Gets the total unread message count across all applications for current user.
 */
export async function getUnreadCountForUser() {
    try {
        const userId = await getCurrentUserId();
        if (!userId) return { success: false, error: 'Not authenticated' };

        const result = await dataAccess.queryRecords(COLLECTION_KEYS.messages, {
            filters: {
                receiver_id: userId,
                is_read: false
            },
            suppressAuth: true
        });

        const items = result.items || [];
        const byApplication = {};
        items.forEach(msg => {
            const appId = msg.application_id;
            byApplication[appId] = (byApplication[appId] || 0) + 1;
        });

        return {
            success: true,
            count: items.length,
            byApplication
        };
    } catch (error) {
        console.error('Error counting unread messages:', error);
        return { success: false, error: error.message, count: 0 };
    }
}

// ============================================================================
// POLL STATUS (Lightweight check for changes)
// ============================================================================

/**
 * Lightweight check if there are any new messages since a timestamp.
 */
export async function checkForNewMessages(applicationId, sinceTimestamp) {
    if (!applicationId || !sinceTimestamp) return { hasNew: false, newCount: 0 };

    try {
        const sinceDate = new Date(sinceTimestamp);
        const count = await dataAccess.countRecords(COLLECTION_KEYS.messages, {
            application_id: applicationId,
            timestamp: { gt: sinceDate }
        });

        return { hasNew: count > 0, newCount: count };
    } catch (error) {
        console.error('Error checking for new messages:', error);
        return { hasNew: false, newCount: 0 };
    }
}

// ============================================================================
// HELPER
// ============================================================================

async function getCurrentUserId() {
    const currentUser = wixUsersBackend.currentUser;
    return currentUser.loggedIn ? currentUser.id : null;
}

// ============================================================================
// HELPER
// ============================================================================

async function getCurrentUserId() {
    const currentUser = wixUsersBackend.currentUser;
    if (!currentUser.loggedIn) {
        return null;
    }
    return currentUser.id;
}
