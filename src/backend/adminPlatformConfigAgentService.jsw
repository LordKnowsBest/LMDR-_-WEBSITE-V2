/**
 * adminPlatformConfigAgentService.jsw
 * Thin wrapper for admin platform configuration agent actions.
 * Delegates to admin_config_service and queries Airtable collections
 * directly for feature flags, AB tests, email templates, notification rules.
 */

import * as dataAccess from 'backend/dataAccess';

const COLLECTIONS = {
  featureFlags: 'featureFlags',
  abTests: 'abTests',
  emailTemplates: 'emailTemplates',
  notificationRules: 'notificationRules',
  platformSettings: 'platformSettings'
};

// ── 1. Get Feature Flags ─────────────────────────────────────────
export async function getFeatureFlags(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const filters = {};
    if (params.status === 'active') filters.enabled = 'Yes';
    else if (params.status === 'inactive') filters.enabled = 'No';

    const result = await dataAccess.queryRecords(COLLECTIONS.featureFlags, {
      filters,
      limit: params.limit || 100,
      suppressAuth: true
    });

    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] getFeatureFlags error:', error.message);
    return { error: error.message };
  }
}

// ── 2. Toggle Feature Flag ───────────────────────────────────────
export async function toggleFeatureFlag(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    let flagId = params.flagId;

    // Look up by name if no ID provided
    if (!flagId && params.flagName) {
      const found = await dataAccess.findByField(COLLECTIONS.featureFlags, 'flag_name', params.flagName, { suppressAuth: true });
      if (!found) return { error: `Flag not found: ${params.flagName}` };
      flagId = found._id;
    }

    if (!flagId) return { error: 'params.flagId or params.flagName is required' };

    // Coerce boolean to Airtable single select string
    const enabledValue = params.enabled ? 'Yes' : 'No';

    const result = await dataAccess.updateRecord(COLLECTIONS.featureFlags, {
      _id: flagId,
      enabled: enabledValue,
      updated_by: userId,
      updated_at: new Date().toISOString()
    }, { suppressAuth: true });

    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] toggleFeatureFlag error:', error.message);
    return { error: error.message };
  }
}

// ── 3. Get AB Tests ──────────────────────────────────────────────
export async function getABTests(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const filters = {};
    if (params.status) filters.status = params.status;

    const result = await dataAccess.queryRecords(COLLECTIONS.abTests, {
      filters,
      limit: params.limit || 50,
      skip: params.offset || 0,
      suppressAuth: true
    });

    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] getABTests error:', error.message);
    return { error: error.message };
  }
}

// ── 4. Create AB Test ────────────────────────────────────────────
export async function createABTest(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.name) return { error: 'params.name is required' };

    const record = {
      name: params.name,
      description: params.description || '',
      variants: JSON.stringify(params.variants || []),
      traffic_split: params.trafficSplit || '50/50',
      status: 'draft',
      metric: params.metric || '',
      created_by: userId,
      created_at: new Date().toISOString()
    };

    const result = await dataAccess.insertRecord(COLLECTIONS.abTests, record, { suppressAuth: true });
    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] createABTest error:', error.message);
    return { error: error.message };
  }
}

// ── 5. Get Email Templates ───────────────────────────────────────
export async function getEmailTemplates(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const filters = {};
    if (params.category) filters.category = params.category;

    const result = await dataAccess.queryRecords(COLLECTIONS.emailTemplates, {
      filters,
      limit: params.limit || 50,
      skip: params.offset || 0,
      suppressAuth: true
    });

    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] getEmailTemplates error:', error.message);
    return { error: error.message };
  }
}

// ── 6. Update Email Template ─────────────────────────────────────
export async function updateEmailTemplate(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.templateId) return { error: 'params.templateId is required' };

    const updates = {
      _id: params.templateId,
      ...(params.updates || {}),
      updated_by: userId,
      updated_at: new Date().toISOString()
    };

    const result = await dataAccess.updateRecord(COLLECTIONS.emailTemplates, updates, { suppressAuth: true });
    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] updateEmailTemplate error:', error.message);
    return { error: error.message };
  }
}

// ── 7. Get Notification Rules ────────────────────────────────────
export async function getNotificationRules(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const filters = {};
    if (params.status) filters.status = params.status;

    const result = await dataAccess.queryRecords(COLLECTIONS.notificationRules, {
      filters,
      limit: params.limit || 50,
      skip: params.offset || 0,
      suppressAuth: true
    });

    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] getNotificationRules error:', error.message);
    return { error: error.message };
  }
}

// ── 8. Update Notification Rule ──────────────────────────────────
export async function updateNotificationRule(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.ruleId) return { error: 'params.ruleId is required' };

    const updates = {
      _id: params.ruleId,
      ...(params.updates || {}),
      updated_by: userId,
      updated_at: new Date().toISOString()
    };

    const result = await dataAccess.updateRecord(COLLECTIONS.notificationRules, updates, { suppressAuth: true });
    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] updateNotificationRule error:', error.message);
    return { error: error.message };
  }
}

// ── 9. Get Platform Config ───────────────────────────────────────
export async function getPlatformConfig(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const configSvc = await import('backend/admin_config_service');

    if (params.settingName) {
      const result = await configSvc.getSystemSetting(params.settingName);
      return result;
    }

    const result = await configSvc.getSystemSettings();
    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] getPlatformConfig error:', error.message);
    return { error: error.message };
  }
}

// ── 10. Update Platform Config ───────────────────────────────────
export async function updatePlatformConfig(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };

    const configSvc = await import('backend/admin_config_service');

    const settings = params.settings || { [params.settingName]: params.value };
    const result = await configSvc.updateSystemSettings(settings);
    return result;
  } catch (error) {
    console.error('[AdminPlatformConfig] updatePlatformConfig error:', error.message);
    return { error: error.message };
  }
}
