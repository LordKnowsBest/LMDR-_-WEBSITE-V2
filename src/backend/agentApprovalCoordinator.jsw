// ============================================================================
// AGENT APPROVAL COORDINATOR - Phase 4 branch-aware approval scaffolding
// Keeps current single-gate resume flow intact while adding a stable metadata
// shape for future branch-aware gate coordination.
// ============================================================================

export function buildApprovalContext(baseContext = {}, metadata = {}) {
  const pendingApprovals = Array.isArray(metadata.pendingApprovals) ? metadata.pendingApprovals : [];
  const completedToolResults = Array.isArray(metadata.completedToolResults) ? metadata.completedToolResults : [];
  const verification = metadata.verification || null;
  return {
    ...baseContext,
    pendingApprovals,
    completedToolResults,
    verification,
    executionContext: {
      node_id: metadata.node_id || '',
      branch_id: metadata.branch_id || '',
      execution_mode: metadata.execution_mode || '',
      plan_id: metadata.plan_id || baseContext.planId || ''
    }
  };
}

export function getApprovalExecutionContext(approvalContext = {}) {
  return approvalContext.executionContext || {
    node_id: '',
    branch_id: '',
    execution_mode: '',
    plan_id: approvalContext.planId || ''
  };
}

export function getPendingApprovalQueue(approvalContext = {}) {
  if (Array.isArray(approvalContext.pendingApprovals) && approvalContext.pendingApprovals.length > 0) {
    return approvalContext.pendingApprovals;
  }
  if (approvalContext.pendingToolBlock) {
    return [{
      gateId: approvalContext.gateId || '',
      stepId: approvalContext.stepId || '',
      toolName: approvalContext.toolName || approvalContext.pendingToolBlock.name || '',
      toolDescription: approvalContext.toolDescription || '',
      args: approvalContext.args || approvalContext.pendingToolBlock.input || {},
      riskLevel: approvalContext.riskLevel || '',
      auditFields: approvalContext.auditFields || [],
      toolBlock: approvalContext.pendingToolBlock,
      executionContext: getApprovalExecutionContext(approvalContext)
    }];
  }
  return [];
}

export function buildNextApprovalContext(approvalContext = {}, resolvedApproval = null, remainingApprovals = []) {
  const completedToolResults = [...(approvalContext.completedToolResults || [])];
  if (resolvedApproval) {
    completedToolResults.push(resolvedApproval);
  }

  const nextApproval = remainingApprovals[0] || null;
  if (!nextApproval) {
    return {
      ...approvalContext,
      pendingApprovals: [],
      completedToolResults
    };
  }

  return buildApprovalContext({
    ...approvalContext,
    gateId: nextApproval.gateId,
    stepId: nextApproval.stepId,
    toolName: nextApproval.toolName,
    toolDescription: nextApproval.toolDescription,
    args: nextApproval.args,
    riskLevel: nextApproval.riskLevel,
    auditFields: nextApproval.auditFields,
    pendingToolBlock: nextApproval.toolBlock
  }, {
    ...nextApproval.executionContext,
    pendingApprovals: remainingApprovals,
    completedToolResults,
    verification: approvalContext.verification || null
  });
}
