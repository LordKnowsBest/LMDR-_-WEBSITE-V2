/**
 * Airtable Connection Test Module
 *
 * This module provides a comprehensive test function to verify
 * the Airtable integration is working correctly. It tests:
 * - API connection and authentication
 * - Table access (v2_Carriers)
 * - Field transformation (snake_case <-> Title Case)
 * - Record querying functionality
 *
 * Usage from a Wix page:
 * ```javascript
 * import { runConnectionTest } from 'backend/tests/airtableConnectionTest';
 *
 * $w.onReady(async function() {
 *   const result = await runConnectionTest();
 *   console.log('Test Result:', result);
 * });
 * ```
 *
 * @module backend/tests/airtableConnectionTest
 */

import {
  testConnection,
  queryRecords,
  toWixFormat,
  toAirtableFormat,
  getTableMappings,
  getTableFieldMappings
} from 'backend/airtableClient';

// ============================================================================
// TEST CONFIGURATION
// ============================================================================

const TEST_CONFIG = {
  tableName: 'Carriers',  // Wix collection name
  recordLimit: 3,         // Number of records to fetch for testing
  expectedFields: ['company_name', 'dot_number', 'phy_state', 'operating_status']
};

// ============================================================================
// MAIN TEST FUNCTION
// ============================================================================

/**
 * Run a comprehensive Airtable connection test
 *
 * @returns {Promise<Object>} Test results object with structure:
 * {
 *   success: boolean,           // Overall test success
 *   timestamp: string,          // ISO timestamp of test run
 *   tests: {
 *     connection: {...},        // API connection test results
 *     tableAccess: {...},       // Table access test results
 *     fieldTransform: {...},    // Field transformation test results
 *     queryRecords: {...}       // Record query test results
 *   },
 *   summary: {
 *     passed: number,           // Number of tests passed
 *     failed: number,           // Number of tests failed
 *     total: number             // Total tests run
 *   }
 * }
 */
export async function runConnectionTest() {
  const startTime = Date.now();
  const results = {
    success: false,
    timestamp: new Date().toISOString(),
    tests: {},
    summary: {
      passed: 0,
      failed: 0,
      total: 0
    }
  };

  console.log('='.repeat(60));
  console.log('AIRTABLE CONNECTION TEST - Starting');
  console.log('='.repeat(60));

  // Test 1: API Connection
  results.tests.connection = await testApiConnection();
  updateSummary(results.summary, results.tests.connection.passed);

  // Only continue if connection test passed
  if (!results.tests.connection.passed) {
    results.success = false;
    results.duration = Date.now() - startTime;
    console.log('\n❌ Connection failed - skipping remaining tests');
    return results;
  }

  // Test 2: Table Access
  results.tests.tableAccess = await testTableAccess();
  updateSummary(results.summary, results.tests.tableAccess.passed);

  // Test 3: Field Transformation
  results.tests.fieldTransform = await testFieldTransformation();
  updateSummary(results.summary, results.tests.fieldTransform.passed);

  // Test 4: Query Records
  results.tests.queryRecords = await testQueryRecords();
  updateSummary(results.summary, results.tests.queryRecords.passed);

  // Calculate overall success
  results.success = results.summary.failed === 0;
  results.duration = Date.now() - startTime;

  console.log('\n' + '='.repeat(60));
  console.log(`TEST COMPLETE: ${results.success ? 'PASSED' : 'FAILED'}`);
  console.log(`Passed: ${results.summary.passed}/${results.summary.total}`);
  console.log(`Duration: ${results.duration}ms`);
  console.log('='.repeat(60));

  return results;
}

// ============================================================================
// INDIVIDUAL TEST FUNCTIONS
// ============================================================================

/**
 * Test 1: API Connection
 * Verifies that we can connect to the Airtable API with valid credentials
 */
async function testApiConnection() {
  console.log('\n--- Test 1: API Connection ---');

  const result = {
    name: 'API Connection',
    passed: false,
    details: {}
  };

  try {
    const connectionResult = await testConnection();

    result.details = {
      baseId: connectionResult.baseId,
      tableCount: connectionResult.tableCount,
      sampleTables: connectionResult.tables || []
    };

    if (connectionResult.success) {
      result.passed = true;
      result.message = `Connected successfully. Found ${connectionResult.tableCount} tables.`;
      console.log(`✅ ${result.message}`);

      // Check if v2_Carriers table exists
      const hasCarriersTable = (connectionResult.tables || []).some(
        t => t === 'v2_Carriers' || t.includes('Carrier')
      );
      result.details.hasCarriersTable = hasCarriersTable;

      if (hasCarriersTable) {
        console.log('   ✓ v2_Carriers table found');
      } else {
        console.log('   ⚠ v2_Carriers table not found in first 10 tables');
      }
    } else {
      result.passed = false;
      result.message = connectionResult.error || 'Connection failed';
      result.error = connectionResult.error;
      console.log(`❌ ${result.message}`);
    }
  } catch (error) {
    result.passed = false;
    result.message = `Exception: ${error.message}`;
    result.error = error.message;
    console.log(`❌ ${result.message}`);
  }

  return result;
}

/**
 * Test 2: Table Access
 * Verifies that the table name mappings are correctly configured
 */
async function testTableAccess() {
  console.log('\n--- Test 2: Table Mappings ---');

  const result = {
    name: 'Table Mappings',
    passed: false,
    details: {}
  };

  try {
    const tableMappings = getTableMappings();
    const mappingCount = Object.keys(tableMappings).length;

    result.details.mappingCount = mappingCount;
    result.details.carriersMapping = tableMappings['Carriers'];
    result.details.driverProfilesMapping = tableMappings['DriverProfiles'];

    // Check critical mappings exist
    const criticalMappings = ['Carriers', 'DriverProfiles', 'DriverJobs'];
    const missingMappings = criticalMappings.filter(m => !tableMappings[m]);

    if (missingMappings.length === 0) {
      result.passed = true;
      result.message = `All ${mappingCount} table mappings configured correctly.`;
      console.log(`✅ ${result.message}`);
      console.log(`   Carriers -> ${tableMappings['Carriers']}`);
      console.log(`   DriverProfiles -> ${tableMappings['DriverProfiles']}`);
    } else {
      result.passed = false;
      result.message = `Missing critical mappings: ${missingMappings.join(', ')}`;
      result.details.missingMappings = missingMappings;
      console.log(`❌ ${result.message}`);
    }
  } catch (error) {
    result.passed = false;
    result.message = `Exception: ${error.message}`;
    result.error = error.message;
    console.log(`❌ ${result.message}`);
  }

  return result;
}

/**
 * Test 3: Field Transformation
 * Verifies that field name transformations work correctly (snake_case <-> Title Case)
 */
async function testFieldTransformation() {
  console.log('\n--- Test 3: Field Transformation ---');

  const result = {
    name: 'Field Transformation',
    passed: false,
    details: {}
  };

  try {
    // Get field mappings for Carriers
    const fieldMappings = getTableFieldMappings('Carriers');
    result.details.fieldMappingCount = Object.keys(fieldMappings).length;

    // Test Wix -> Airtable transformation
    const testWixRecord = {
      company_name: 'Test Trucking LLC',
      dot_number: 1234567,
      phy_state: 'TX',
      operating_status: 'AUTHORIZED'
    };

    const airtableFormatted = toAirtableFormat(testWixRecord, 'Carriers');
    result.details.wixToAirtable = {
      input: testWixRecord,
      output: airtableFormatted
    };

    // Verify expected transformations
    const expectedTransforms = {
      'Company Name': 'Test Trucking LLC',
      'DOT Number': 1234567,
      'Physical State': 'TX',
      'Operating Status': 'AUTHORIZED'
    };

    const transformErrors = [];
    for (const [expectedField, expectedValue] of Object.entries(expectedTransforms)) {
      if (airtableFormatted[expectedField] !== expectedValue) {
        transformErrors.push(`${expectedField}: expected "${expectedValue}", got "${airtableFormatted[expectedField]}"`);
      }
    }

    // Test Airtable -> Wix transformation
    const testAirtableRecord = {
      id: 'recTEST123',
      createdTime: '2024-01-15T10:30:00.000Z',
      fields: {
        'Company Name': 'Reverse Test LLC',
        'DOT Number': 9876543,
        'Physical State': 'CA',
        'Operating Status': 'ACTIVE'
      }
    };

    const wixFormatted = toWixFormat(testAirtableRecord, 'Carriers');
    result.details.airtableToWix = {
      input: testAirtableRecord,
      output: wixFormatted
    };

    // Verify reverse transformations
    if (wixFormatted._id !== 'recTEST123') {
      transformErrors.push(`_id: expected "recTEST123", got "${wixFormatted._id}"`);
    }
    if (wixFormatted.company_name !== 'Reverse Test LLC') {
      transformErrors.push(`company_name: expected "Reverse Test LLC", got "${wixFormatted.company_name}"`);
    }
    if (wixFormatted.dot_number !== 9876543) {
      transformErrors.push(`dot_number: expected 9876543, got ${wixFormatted.dot_number}`);
    }

    if (transformErrors.length === 0) {
      result.passed = true;
      result.message = 'Field transformations working correctly.';
      console.log(`✅ ${result.message}`);
      console.log(`   company_name -> Company Name ✓`);
      console.log(`   dot_number -> DOT Number ✓`);
      console.log(`   Airtable record -> Wix format ✓`);
    } else {
      result.passed = false;
      result.message = `Transformation errors: ${transformErrors.join('; ')}`;
      result.details.errors = transformErrors;
      console.log(`❌ ${result.message}`);
    }
  } catch (error) {
    result.passed = false;
    result.message = `Exception: ${error.message}`;
    result.error = error.message;
    console.log(`❌ ${result.message}`);
  }

  return result;
}

/**
 * Test 4: Query Records
 * Actually fetches records from v2_Carriers and verifies the data
 */
async function testQueryRecords() {
  console.log('\n--- Test 4: Query Records ---');

  const result = {
    name: 'Query Records',
    passed: false,
    details: {}
  };

  try {
    console.log(`   Fetching ${TEST_CONFIG.recordLimit} records from ${TEST_CONFIG.tableName}...`);

    const queryResult = await queryRecords(TEST_CONFIG.tableName, {
      maxRecords: TEST_CONFIG.recordLimit
    });

    result.details.queryResult = {
      success: !queryResult.error,
      recordCount: queryResult.records?.length || 0,
      hasMore: queryResult.hasMore || false
    };

    if (queryResult.error) {
      result.passed = false;
      result.message = `Query failed: ${queryResult.error}`;
      result.error = queryResult.error;
      console.log(`❌ ${result.message}`);
      return result;
    }

    const records = queryResult.records || [];

    if (records.length === 0) {
      result.passed = false;
      result.message = 'No records returned from v2_Carriers';
      console.log(`❌ ${result.message}`);
      return result;
    }

    // Verify records have expected fields
    result.details.sampleRecords = records.map(r => ({
      _id: r._id,
      company_name: r.company_name,
      dot_number: r.dot_number,
      phy_state: r.phy_state,
      operating_status: r.operating_status
    }));

    // Check if records have the expected Wix field names (snake_case)
    const firstRecord = records[0];
    const hasExpectedFields = TEST_CONFIG.expectedFields.some(field =>
      firstRecord[field] !== undefined
    );

    if (hasExpectedFields) {
      result.passed = true;
      result.message = `Successfully queried ${records.length} records with properly transformed fields.`;
      console.log(`✅ ${result.message}`);

      records.forEach((record, index) => {
        console.log(`   [${index + 1}] ${record.company_name || 'N/A'} (DOT: ${record.dot_number || 'N/A'})`);
      });
    } else {
      result.passed = false;
      result.message = 'Records returned but field transformation may not be working';
      result.details.firstRecordKeys = Object.keys(firstRecord);
      console.log(`⚠ ${result.message}`);
      console.log(`   Record keys: ${Object.keys(firstRecord).join(', ')}`);
    }
  } catch (error) {
    result.passed = false;
    result.message = `Exception: ${error.message}`;
    result.error = error.message;
    console.log(`❌ ${result.message}`);
  }

  return result;
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Update the summary counters based on test result
 */
function updateSummary(summary, passed) {
  summary.total++;
  if (passed) {
    summary.passed++;
  } else {
    summary.failed++;
  }
}

// ============================================================================
// ADDITIONAL TEST UTILITIES
// ============================================================================

/**
 * Quick connection check - lightweight test for status checks
 *
 * @returns {Promise<Object>} { connected: boolean, message: string }
 */
export async function quickConnectionCheck() {
  try {
    const result = await testConnection();
    return {
      connected: result.success,
      message: result.success ? 'Airtable connected' : result.error,
      tableCount: result.tableCount || 0
    };
  } catch (error) {
    return {
      connected: false,
      message: error.message,
      tableCount: 0
    };
  }
}

/**
 * Get sample carriers for verification
 *
 * @param {number} limit - Number of carriers to fetch (default 5)
 * @returns {Promise<Array>} Array of carrier records in Wix format
 */
export async function getSampleCarriers(limit = 5) {
  try {
    const result = await queryRecords('Carriers', { maxRecords: limit });

    if (result.error) {
      return { success: false, error: result.error, carriers: [] };
    }

    return {
      success: true,
      count: result.records.length,
      carriers: result.records.map(c => ({
        _id: c._id,
        company_name: c.company_name,
        dot_number: c.dot_number,
        phy_state: c.phy_state,
        operating_status: c.operating_status,
        hiring_status: c.hiring_status
      }))
    };
  } catch (error) {
    return { success: false, error: error.message, carriers: [] };
  }
}

/**
 * Verify secret configuration
 * Returns info about which secret name was found
 *
 * @returns {Promise<Object>} Secret configuration status
 */
export async function verifySecretConfig() {
  // This is a diagnostic function - the actual secret check happens in airtableClient
  // We just report on the expected configuration
  return {
    expectedSecrets: ['AIRTABLE_PAT', 'AIRTABLE_API_KEY'],
    priority: 'AIRTABLE_PAT is checked first, then AIRTABLE_API_KEY as fallback',
    baseId: 'app9N1YCJ3gdhExA0',
    note: 'Add AIRTABLE_PAT to Wix Secrets Manager with your Airtable Personal Access Token'
  };
}
