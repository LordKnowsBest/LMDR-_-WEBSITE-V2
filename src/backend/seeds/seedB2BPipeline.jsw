/**
 * SEED DATA: B2B Pipeline, Sequences, Analytics & Outreach
 * =========================================================
 * Seeds B2B pipeline-related collections for Wave 3 verification.
 *
 * Collections seeded:
 *   - b2bOpportunities (5 records)
 *   - b2bSequences (3 records)
 *   - b2bSequenceSteps (9 records)
 *   - b2bEmails (5 records)
 *   - b2bTextMessages (3 records)
 *   - b2bCalls (5 records)
 *   - b2bAnalyticsSnapshots (7 records)
 *   - b2bCompetitorIntel (3 records)
 *   - b2bLeadAttribution (5 records)
 *   - b2bSpend (3 records)
 *   - b2bPlaybooks (2 records)
 *   - b2bValueProps (3 records)
 *   - b2bAutomationRules (2 records)
 *   - b2bCallCampaigns (2 records)
 *
 * NOTE: b2bAccounts, b2bActivities, b2bContacts overlap with J6 (seedB2BAccounts).
 * countData() will skip if already seeded.
 *
 * @module backend/seeds/seedB2BPipeline
 */

import wixData from 'wix-data';
import { usesAirtable, getAirtableTableName, getWixCollectionName } from 'backend/configData';
import * as airtable from 'backend/airtableClient';

// =============================================================================
// DUAL-SOURCE HELPERS (do not modify)
// =============================================================================

async function insertData(collectionKey, data) {
    if (usesAirtable(collectionKey)) {
        const tableName = getAirtableTableName(collectionKey);
        const { _id, ...airtableData } = data;
        return await airtable.createRecord(tableName, airtableData);
    }
    const wixName = getWixCollectionName(collectionKey);
    return await wixData.insert(wixName, data, { suppressAuth: true });
}

async function countData(collectionKey) {
    if (usesAirtable(collectionKey)) {
        const tableName = getAirtableTableName(collectionKey);
        const result = await airtable.queryRecords(tableName, { maxRecords: 1 });
        return (result.records || []).length;
    }
    const wixName = getWixCollectionName(collectionKey);
    return await wixData.query(wixName).limit(1).count({ suppressAuth: true });
}

// =============================================================================
// COLLECTION KEYS
// =============================================================================

const COLLECTIONS = {
    opportunities: 'b2bOpportunities',
    sequences: 'b2bSequences',
    sequenceSteps: 'b2bSequenceSteps',
    emails: 'b2bEmails',
    textMessages: 'b2bTextMessages',
    calls: 'b2bCalls',
    analyticsSnapshots: 'b2bAnalyticsSnapshots',
    competitorIntel: 'b2bCompetitorIntel',
    leadAttribution: 'b2bLeadAttribution',
    spend: 'b2bSpend',
    playbooks: 'b2bPlaybooks',
    valueProps: 'b2bValueProps',
    automationRules: 'b2bAutomationRules',
    callCampaigns: 'b2bCallCampaigns'
};

// =============================================================================
// DATA GENERATORS
// =============================================================================

function generateOpportunities() {
    const now = new Date();
    return [
        {
            account_id: '__TEST_SEED__acc_1',
            title: 'TransGlobal Platform License',
            stage: 'negotiation',
            value: 75000,
            probability: 70,
            close_date: new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString(),
            owner_id: 'rep_001',
            created_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            account_id: '__TEST_SEED__acc_2',
            title: 'Heartland Recruiting Package',
            stage: 'proposal',
            value: 35000,
            probability: 50,
            close_date: new Date(now.getTime() + 45 * 24 * 60 * 60 * 1000).toISOString(),
            owner_id: 'rep_002',
            created_at: new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            account_id: '__TEST_SEED__acc_3',
            title: 'Mountain Express Starter Plan',
            stage: 'discovery',
            value: 12000,
            probability: 25,
            close_date: new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000).toISOString(),
            owner_id: 'rep_001',
            created_at: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            account_id: '__TEST_SEED__acc_1',
            title: 'TransGlobal Enterprise Upgrade',
            stage: 'verbal_commit',
            value: 100000,
            probability: 90,
            close_date: new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000).toISOString(),
            owner_id: 'rep_001',
            created_at: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            account_id: '__TEST_SEED__acc_5',
            title: 'Legacy Transport Renewal',
            stage: 'closed_lost',
            value: 5000,
            probability: 0,
            close_date: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),
            owner_id: 'rep_002',
            created_at: new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString()
        }
    ];
}

function generateSequences() {
    const now = new Date();
    return [
        {
            name: 'New Prospect Outreach',
            description: 'Multi-channel welcome sequence for new prospects',
            status: 'active',
            trigger_type: 'manual',
            steps_count: 3,
            created_by: 'rep_001',
            created_at: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            name: 'Signal-Based Follow-up',
            description: 'Triggered when match signals detected for carrier',
            status: 'active',
            trigger_type: 'signal_based',
            steps_count: 3,
            created_by: 'rep_002',
            created_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            name: 'Re-engagement Campaign',
            description: 'Monthly check-in for dormant accounts',
            status: 'paused',
            trigger_type: 'time_based',
            steps_count: 3,
            created_by: 'rep_001',
            created_at: new Date(now.getTime() - 45 * 24 * 60 * 60 * 1000).toISOString()
        }
    ];
}

function generateSequenceSteps() {
    const now = new Date();
    return [
        // Sequence 1: New Prospect Outreach
        { sequence_id: '__TEST_SEED__seq_1', step_number: 1, channel: 'email', template: 'welcome_intro', delay_hours: 0, created_at: now.toISOString() },
        { sequence_id: '__TEST_SEED__seq_1', step_number: 2, channel: 'call', template: 'intro_call_script', delay_hours: 48, created_at: now.toISOString() },
        { sequence_id: '__TEST_SEED__seq_1', step_number: 3, channel: 'sms', template: 'meeting_reminder', delay_hours: 72, created_at: now.toISOString() },
        // Sequence 2: Signal-Based Follow-up
        { sequence_id: '__TEST_SEED__seq_2', step_number: 1, channel: 'email', template: 'signal_alert_email', delay_hours: 0, created_at: now.toISOString() },
        { sequence_id: '__TEST_SEED__seq_2', step_number: 2, channel: 'call', template: 'signal_followup_call', delay_hours: 24, created_at: now.toISOString() },
        { sequence_id: '__TEST_SEED__seq_2', step_number: 3, channel: 'email', template: 'case_study_send', delay_hours: 72, created_at: now.toISOString() },
        // Sequence 3: Re-engagement
        { sequence_id: '__TEST_SEED__seq_3', step_number: 1, channel: 'email', template: 'reengagement_v1', delay_hours: 0, created_at: now.toISOString() },
        { sequence_id: '__TEST_SEED__seq_3', step_number: 2, channel: 'sms', template: 'quick_checkin', delay_hours: 168, created_at: now.toISOString() },
        { sequence_id: '__TEST_SEED__seq_3', step_number: 3, channel: 'call', template: 'reengagement_call', delay_hours: 336, created_at: now.toISOString() }
    ];
}

function generateEmails() {
    const now = new Date();
    return [
        { account_id: '__TEST_SEED__acc_1', contact_id: '__TEST_SEED__con_1', subject: 'Welcome to VelocityMatch', status: 'opened', sent_at: new Date(now.getTime() - 25 * 24 * 60 * 60 * 1000).toISOString(), opened_at: new Date(now.getTime() - 25 * 24 * 60 * 60 * 1000 + 3600000).toISOString(), clicked_at: null },
        { account_id: '__TEST_SEED__acc_1', contact_id: '__TEST_SEED__con_2', subject: 'Case Study: 40% Faster Hiring', status: 'clicked', sent_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString(), opened_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000 + 7200000).toISOString(), clicked_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000 + 10800000).toISOString() },
        { account_id: '__TEST_SEED__acc_2', contact_id: '__TEST_SEED__con_3', subject: 'Your Recruiting ROI Analysis', status: 'delivered', sent_at: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString(), opened_at: null, clicked_at: null },
        { account_id: '__TEST_SEED__acc_3', contact_id: '__TEST_SEED__con_5', subject: 'Partnership Proposal', status: 'sent', sent_at: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString(), opened_at: null, clicked_at: null },
        { account_id: '__TEST_SEED__acc_4', contact_id: '__TEST_SEED__con_7', subject: 'Introduction to VelocityMatch', status: 'bounced', sent_at: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString(), opened_at: null, clicked_at: null }
    ];
}

function generateTextMessages() {
    const now = new Date();
    return [
        { account_id: '__TEST_SEED__acc_1', contact_id: '__TEST_SEED__con_1', content: 'Hi Sarah, just confirming our call tomorrow at 2pm CT. Looking forward to it!', status: 'delivered', sent_at: new Date(now.getTime() - 24 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_2', contact_id: '__TEST_SEED__con_3', content: 'James, sent you the proposal via email. Let me know if you have questions!', status: 'sent', sent_at: new Date(now.getTime() - 11 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_4', contact_id: '__TEST_SEED__con_7', content: 'Hi David, this is the VelocityMatch team. Would you have 15 min this week?', status: 'failed', sent_at: new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString() }
    ];
}

function generateCalls() {
    const now = new Date();
    return [
        { account_id: '__TEST_SEED__acc_1', contact_id: '__TEST_SEED__con_1', duration_seconds: 1800, outcome: 'connected', notes: 'Great intro call. Sarah interested in platform demo.', called_at: new Date(now.getTime() - 23 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_2', contact_id: '__TEST_SEED__con_3', duration_seconds: 600, outcome: 'voicemail', notes: 'Left message about proposal follow-up.', called_at: new Date(now.getTime() - 9 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_3', contact_id: '__TEST_SEED__con_5', duration_seconds: 0, outcome: 'no_answer', notes: null, called_at: new Date(now.getTime() - 8 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_4', contact_id: '__TEST_SEED__con_7', duration_seconds: 120, outcome: 'busy', notes: 'Asked to call back next week.', called_at: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_5', contact_id: '__TEST_SEED__con_8', duration_seconds: 0, outcome: 'wrong_number', notes: 'Number no longer valid for this contact.', called_at: new Date(now.getTime() - 35 * 24 * 60 * 60 * 1000).toISOString() }
    ];
}

function generateAnalyticsSnapshots() {
    const now = new Date();
    const snapshots = [];
    for (let i = 6; i >= 0; i--) {
        const day = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        snapshots.push({
            snapshot_date: day.toISOString().split('T')[0],
            total_accounts: 45 + (6 - i),
            total_pipeline_value: 200000 + (6 - i) * 5000,
            conversion_rate: 0.12 + (6 - i) * 0.005,
            avg_deal_size: 35000 + (6 - i) * 500,
            deals_closed: 2 + Math.floor((6 - i) / 3),
            created_at: day.toISOString()
        });
    }
    return snapshots;
}

function generateCompetitorIntel() {
    const now = new Date();
    return [
        { competitor_name: 'TruckHire Pro', intel_type: 'pricing', details: 'Raised per-driver pricing from $49 to $69/month effective Q2', source: 'customer_feedback', reported_at: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString() },
        { competitor_name: 'FleetRecruit AI', intel_type: 'feature', details: 'Launched AI-powered interview scheduling module', source: 'press_release', reported_at: new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000).toISOString() },
        { competitor_name: 'DriverConnect', intel_type: 'partnership', details: 'Partnered with major job board for exclusive CDL listings', source: 'industry_news', reported_at: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString() }
    ];
}

function generateLeadAttribution() {
    const now = new Date();
    return [
        { account_id: '__TEST_SEED__acc_1', source: 'organic', campaign: 'seo_trucking_keywords', cost: 0, converted: true, attributed_at: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_2', source: 'referral', campaign: 'customer_referral_q1', cost: 500, converted: true, attributed_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_3', source: 'event', campaign: 'mats_2026_booth', cost: 2500, converted: false, attributed_at: new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_4', source: 'paid', campaign: 'linkedin_carrier_ads', cost: 150, converted: false, attributed_at: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString() },
        { account_id: '__TEST_SEED__acc_5', source: 'paid', campaign: 'google_ads_recruiting', cost: 300, converted: true, attributed_at: new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString() }
    ];
}

function generateSpend() {
    const now = new Date();
    return [
        { category: 'advertising', amount: 5000, period: '2026-01', description: 'LinkedIn + Google Ads for carrier acquisition', created_at: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString() },
        { category: 'events', amount: 8000, period: '2026-01', description: 'MATS 2026 booth and sponsorship', created_at: new Date(now.getTime() - 25 * 24 * 60 * 60 * 1000).toISOString() },
        { category: 'tools', amount: 1200, period: '2026-01', description: 'CRM and outreach tool subscriptions', created_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString() }
    ];
}

function generatePlaybooks() {
    return [
        { name: 'Enterprise Carrier Playbook', description: 'Step-by-step for carriers with 200+ drivers', stage: 'qualified', steps: JSON.stringify(['Research', 'Intro Call', 'Demo', 'Proposal', 'Negotiation', 'Close']), created_at: new Date().toISOString() },
        { name: 'SMB Quick Close', description: 'Accelerated process for small fleets under 50 drivers', stage: 'discovery', steps: JSON.stringify(['Qualify', 'Demo + Proposal', 'Close']), created_at: new Date().toISOString() }
    ];
}

function generateValueProps() {
    return [
        { title: 'Reduce Time-to-Hire by 40%', description: 'AI-powered matching finds qualified CDL drivers faster than manual searching', category: 'efficiency', target_persona: 'recruiter', created_at: new Date().toISOString() },
        { title: 'Safety-First Driver Matching', description: 'Integrated FMCSA data ensures you only see drivers meeting your safety standards', category: 'compliance', target_persona: 'fleet_manager', created_at: new Date().toISOString() },
        { title: 'Lower Cost-Per-Hire', description: 'Platform subscription replaces expensive per-hire recruiting fees', category: 'cost', target_persona: 'executive', created_at: new Date().toISOString() }
    ];
}

function generateAutomationRules() {
    return [
        { name: 'Auto-qualify on signal detection', trigger: 'signal_detected', condition: JSON.stringify({ signal_strength: 'strong' }), action_type: 'update_stage', action_config: JSON.stringify({ new_stage: 'qualified' }), active: true, created_at: new Date().toISOString() },
        { name: 'Alert on stale opportunities', trigger: 'time_elapsed', condition: JSON.stringify({ days_in_stage: 30 }), action_type: 'create_alert', action_config: JSON.stringify({ severity: 'warning' }), active: true, created_at: new Date().toISOString() }
    ];
}

function generateCallCampaigns() {
    const now = new Date();
    return [
        { name: 'Q1 Carrier Blitz', description: 'High-volume outbound to uncontacted prospects', status: 'active', target_count: 50, completed_count: 18, start_date: new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000).toISOString(), created_at: new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000).toISOString() },
        { name: 'Re-engagement Calls', description: 'Follow up with dormant accounts from last quarter', status: 'paused', target_count: 25, completed_count: 10, start_date: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(), created_at: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString() }
    ];
}

// =============================================================================
// SEED FUNCTIONS
// =============================================================================

async function seedCollection(key, generator) {
    const existing = await countData(key);
    if (existing > 0) {
        console.log(`[Seed] ${key} already has data. Skipping.`);
        return { seeded: false, count: existing };
    }

    const items = generator();
    console.log(`[Seed] Seeding ${items.length} records into ${key}...`);

    const ids = [];
    const chunks = chunkArray(items, 10);

    for (const chunk of chunks) {
        const results = await Promise.all(
            chunk.map(async (item) => {
                try {
                    const result = await insertData(key, item);
                    return { success: true, id: result._id || result.id };
                } catch (error) {
                    console.error(`[Seed] Failed to insert into ${key}:`, error.message);
                    return { success: false, error: error.message };
                }
            })
        );
        ids.push(...results.filter(r => r.success).map(r => r.id));
        await new Promise(r => setTimeout(r, 200));
    }

    return { seeded: true, count: ids.length, ids };
}

// =============================================================================
// ORCHESTRATOR
// =============================================================================

export async function seedAllB2BPipeline() {
    console.log('='.repeat(50));
    console.log('[Seed] Starting B2B Pipeline seed...');
    console.log('='.repeat(50));

    const results = {};

    results.opportunities = await seedCollection(COLLECTIONS.opportunities, generateOpportunities);
    results.sequences = await seedCollection(COLLECTIONS.sequences, generateSequences);
    results.sequenceSteps = await seedCollection(COLLECTIONS.sequenceSteps, generateSequenceSteps);
    results.emails = await seedCollection(COLLECTIONS.emails, generateEmails);
    results.textMessages = await seedCollection(COLLECTIONS.textMessages, generateTextMessages);
    results.calls = await seedCollection(COLLECTIONS.calls, generateCalls);
    results.analyticsSnapshots = await seedCollection(COLLECTIONS.analyticsSnapshots, generateAnalyticsSnapshots);
    results.competitorIntel = await seedCollection(COLLECTIONS.competitorIntel, generateCompetitorIntel);
    results.leadAttribution = await seedCollection(COLLECTIONS.leadAttribution, generateLeadAttribution);
    results.spend = await seedCollection(COLLECTIONS.spend, generateSpend);
    results.playbooks = await seedCollection(COLLECTIONS.playbooks, generatePlaybooks);
    results.valueProps = await seedCollection(COLLECTIONS.valueProps, generateValueProps);
    results.automationRules = await seedCollection(COLLECTIONS.automationRules, generateAutomationRules);
    results.callCampaigns = await seedCollection(COLLECTIONS.callCampaigns, generateCallCampaigns);

    console.log('='.repeat(50));
    console.log('[Seed] Complete:', JSON.stringify(results, null, 2));
    console.log('='.repeat(50));

    return results;
}

export const seedAll = seedAllB2BPipeline;

// =============================================================================
// UTILITIES
// =============================================================================

function chunkArray(arr, size) {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
    }
    return chunks;
}
