/**
 * Seed Carrier Comms Data
 *
 * Creates test data for the carrier communications domain: announcements,
 * read receipts, comments, notification settings, policies, and acknowledgments.
 *
 * Collections seeded here (7):
 *   - carrierAnnouncements (5 records: published, draft, scheduled, archived, urgent)
 *   - announcementReadReceipts (10 records)
 *   - announcementComments (5 records)
 *   - carrierNotificationSettings (2 records)
 *   - driverNotificationPreferences (3 records)
 *   - policyDocuments (3 records: active, draft, archived)
 *   - policyAcknowledgments (5 records)
 *
 * NOTE: policyDocuments and policyAcknowledgments keys are NOT yet in configData.js.
 *       They must be added before running this seed for those two collections.
 *
 * Run via:
 *   import { seedAllCarrierComms } from 'backend/seeds/seedCarrierComms';
 *   const result = await seedAllCarrierComms();
 *
 * @module backend/seeds/seedCarrierComms
 */

import wixData from 'wix-data';
import { usesAirtable, getAirtableTableName, getWixCollectionName } from 'backend/configData';
import * as airtable from 'backend/airtableClient';

// =============================================================================
// DUAL-SOURCE HELPERS
// =============================================================================

async function insertData(collectionKey, data) {
    if (usesAirtable(collectionKey)) {
        const tableName = getAirtableTableName(collectionKey);
        const { _id, ...airtableData } = data;
        return await airtable.createRecord(tableName, airtableData);
    }
    const wixName = getWixCollectionName(collectionKey);
    return await wixData.insert(wixName, data, { suppressAuth: true });
}

async function countData(collectionKey) {
    if (usesAirtable(collectionKey)) {
        const tableName = getAirtableTableName(collectionKey);
        const result = await airtable.queryRecords(tableName, { maxRecords: 1 });
        return (result.records || []).length;
    }
    const wixName = getWixCollectionName(collectionKey);
    return await wixData.query(wixName).limit(1).count({ suppressAuth: true });
}

// =============================================================================
// COLLECTION KEYS
// =============================================================================

const COLLECTIONS = {
    carrierAnnouncements: 'carrierAnnouncements',
    announcementReadReceipts: 'announcementReadReceipts',
    announcementComments: 'announcementComments',
    carrierNotificationSettings: 'carrierNotificationSettings',
    driverNotificationPreferences: 'driverNotificationPreferences',
    policyDocuments: 'policyDocuments',
    policyAcknowledgments: 'policyAcknowledgments'
};

// =============================================================================
// DATA GENERATORS
// =============================================================================

function generateCarrierAnnouncements() {
    const now = new Date();
    return [
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Holiday Schedule Update',
            content: 'All drivers should note the updated holiday schedule for Q1 2026. Please review the attached calendar.',
            priority: 'normal',
            status: 'published',
            target_audience: JSON.stringify({ type: 'all', segments: [] }),
            allow_comments: true,
            read_count: 42,
            total_recipients: 50,
            attachments: '[]',
            published_at: new Date(now - 86400000).toISOString(),
            created_at: new Date(now - 172800000).toISOString(),
            updated_at: new Date(now - 86400000).toISOString(),
            expires_at: null,
            scheduled_at: null,
            created_by: 'admin-1'
        },
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Draft: New Safety Protocol',
            content: 'Draft version of our upcoming safety protocol changes.',
            priority: 'normal',
            status: 'draft',
            target_audience: JSON.stringify({ type: 'all', segments: [] }),
            allow_comments: false,
            read_count: 0,
            total_recipients: 0,
            attachments: '[]',
            published_at: null,
            created_at: new Date(now - 3600000).toISOString(),
            updated_at: new Date(now - 3600000).toISOString(),
            expires_at: null,
            scheduled_at: null,
            created_by: 'admin-1'
        },
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Upcoming Route Changes',
            content: 'Route changes effective March 1. All affected drivers will receive individual notifications.',
            priority: 'high',
            status: 'scheduled',
            target_audience: JSON.stringify({ type: 'segments', segments: ['otr', 'regional'] }),
            allow_comments: true,
            read_count: 0,
            total_recipients: 35,
            attachments: '[]',
            published_at: null,
            created_at: new Date(now - 7200000).toISOString(),
            updated_at: new Date(now - 7200000).toISOString(),
            expires_at: new Date(now + 2592000000).toISOString(),
            scheduled_at: new Date(now + 604800000).toISOString(),
            created_by: 'admin-1'
        },
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Archived: Old Benefits Info',
            content: 'Previous benefits information that has been superseded.',
            priority: 'low',
            status: 'archived',
            target_audience: JSON.stringify({ type: 'all', segments: [] }),
            allow_comments: false,
            read_count: 48,
            total_recipients: 50,
            attachments: '[]',
            published_at: new Date(now - 5184000000).toISOString(),
            created_at: new Date(now - 5270400000).toISOString(),
            updated_at: new Date(now - 2592000000).toISOString(),
            expires_at: null,
            scheduled_at: null,
            created_by: 'admin-2'
        },
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ URGENT: Weather Alert I-70',
            content: 'Severe winter storm warning for I-70 corridor. All drivers should check conditions before departing.',
            priority: 'urgent',
            status: 'published',
            target_audience: JSON.stringify({ type: 'segments', segments: ['otr'] }),
            allow_comments: true,
            read_count: 15,
            total_recipients: 30,
            attachments: '[]',
            published_at: new Date(now - 1800000).toISOString(),
            created_at: new Date(now - 1800000).toISOString(),
            updated_at: new Date(now - 1800000).toISOString(),
            expires_at: new Date(now + 172800000).toISOString(),
            scheduled_at: null,
            created_by: 'admin-1'
        }
    ];
}

function generateAnnouncementReadReceipts(announcementIds) {
    const now = new Date();
    return [
        { announcement_id: announcementIds[0] || 'ann-1', driver_id: 'test-driver-1', read_at: new Date(now - 80000000).toISOString(), device_type: 'web', time_spent_seconds: 45 },
        { announcement_id: announcementIds[0] || 'ann-1', driver_id: 'test-driver-2', read_at: new Date(now - 75000000).toISOString(), device_type: 'mobile', time_spent_seconds: 30 },
        { announcement_id: announcementIds[0] || 'ann-1', driver_id: 'test-driver-3', read_at: new Date(now - 70000000).toISOString(), device_type: 'web', time_spent_seconds: 60 },
        { announcement_id: announcementIds[0] || 'ann-1', driver_id: 'test-driver-4', read_at: new Date(now - 65000000).toISOString(), device_type: 'mobile', time_spent_seconds: 15 },
        { announcement_id: announcementIds[0] || 'ann-1', driver_id: 'test-driver-5', read_at: new Date(now - 60000000).toISOString(), device_type: 'web', time_spent_seconds: 90 },
        { announcement_id: announcementIds[4] || 'ann-5', driver_id: 'test-driver-1', read_at: new Date(now - 1200000).toISOString(), device_type: 'mobile', time_spent_seconds: 20 },
        { announcement_id: announcementIds[4] || 'ann-5', driver_id: 'test-driver-2', read_at: new Date(now - 1000000).toISOString(), device_type: 'web', time_spent_seconds: 35 },
        { announcement_id: announcementIds[4] || 'ann-5', driver_id: 'test-driver-6', read_at: new Date(now - 900000).toISOString(), device_type: 'mobile', time_spent_seconds: 10 },
        { announcement_id: announcementIds[3] || 'ann-4', driver_id: 'test-driver-1', read_at: new Date(now - 4000000000).toISOString(), device_type: 'web', time_spent_seconds: 120 },
        { announcement_id: announcementIds[3] || 'ann-4', driver_id: 'test-driver-3', read_at: new Date(now - 3900000000).toISOString(), device_type: 'web', time_spent_seconds: 55 }
    ];
}

function generateAnnouncementComments(announcementIds) {
    const now = new Date();
    return [
        {
            announcement_id: announcementIds[0] || 'ann-1',
            driver_id: 'test-driver-1',
            driver_name: 'TestDriver1',
            comment_text: '__TEST_SEED__ Thanks for the heads up on the schedule changes.',
            is_hidden: false,
            created_at: new Date(now - 50000000).toISOString()
        },
        {
            announcement_id: announcementIds[0] || 'ann-1',
            driver_id: 'test-driver-2',
            driver_name: 'TestDriver2',
            comment_text: '__TEST_SEED__ Will this affect the Christmas Eve pickup schedule?',
            is_hidden: false,
            created_at: new Date(now - 40000000).toISOString()
        },
        {
            announcement_id: announcementIds[4] || 'ann-5',
            driver_id: 'test-driver-3',
            driver_name: 'TestDriver3',
            comment_text: '__TEST_SEED__ Confirming I-70 is closed at mile marker 180.',
            is_hidden: false,
            created_at: new Date(now - 1500000).toISOString()
        },
        {
            announcement_id: announcementIds[4] || 'ann-5',
            driver_id: 'test-driver-spam',
            driver_name: 'SpamUser',
            comment_text: '__TEST_SEED__ Buy cheap stuff online now!!!',
            is_hidden: true,
            created_at: new Date(now - 1400000).toISOString()
        },
        {
            announcement_id: announcementIds[0] || 'ann-1',
            driver_id: 'test-driver-4',
            driver_name: '',
            comment_text: '__TEST_SEED__',
            is_hidden: false,
            created_at: new Date(now - 30000000).toISOString()
        }
    ];
}

function generateCarrierNotificationSettings() {
    return [
        {
            carrier_id: '__TEST_SEED__carrier-1',
            email_notifications: true,
            push_notifications: true,
            sms_notifications: false,
            digest_frequency: 'daily',
            urgent_override: true,
            quiet_hours_start: '22:00',
            quiet_hours_end: '06:00',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            carrier_id: '__TEST_SEED__carrier-2',
            email_notifications: true,
            push_notifications: false,
            sms_notifications: true,
            digest_frequency: 'weekly',
            urgent_override: true,
            quiet_hours_start: null,
            quiet_hours_end: null,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }
    ];
}

function generateDriverNotificationPreferences() {
    return [
        {
            driver_id: 'test-driver-1',
            carrier_id: '__TEST_SEED__carrier-1',
            email_enabled: true,
            push_enabled: true,
            sms_enabled: false,
            announcement_digest: 'realtime',
            policy_reminders: true,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            driver_id: 'test-driver-2',
            carrier_id: '__TEST_SEED__carrier-1',
            email_enabled: true,
            push_enabled: false,
            sms_enabled: false,
            announcement_digest: 'daily',
            policy_reminders: true,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            driver_id: 'test-driver-3',
            carrier_id: '__TEST_SEED__carrier-1',
            email_enabled: false,
            push_enabled: false,
            sms_enabled: false,
            announcement_digest: 'none',
            policy_reminders: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }
    ];
}

function generatePolicyDocuments() {
    const now = new Date();
    return [
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Driver Safety Handbook',
            category: 'safety',
            description: 'Comprehensive safety guidelines for all company drivers.',
            content_type: 'markdown',
            content: '# Safety Handbook\n\n## General Rules\n\n1. Always wear seatbelt.\n2. Follow HOS regulations.\n3. Report incidents immediately.',
            external_url: '',
            version: 3,
            status: 'published',
            requires_acknowledgment: true,
            acknowledgment_deadline: new Date(now + 2592000000).toISOString(),
            target_audience: JSON.stringify({ type: 'all', segments: [] }),
            is_mandatory: true,
            change_summary: 'Updated HOS section with latest FMCSA regs.',
            created_at: new Date(now - 8640000000).toISOString(),
            updated_at: new Date(now - 86400000).toISOString(),
            published_at: new Date(now - 86400000).toISOString(),
            created_by: 'admin-1'
        },
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Draft: PTO Policy Update',
            category: 'benefits',
            description: 'Draft of the updated PTO accrual policy.',
            content_type: 'markdown',
            content: '# PTO Policy\n\nDraft content pending review.',
            external_url: '',
            version: 1,
            status: 'draft',
            requires_acknowledgment: false,
            acknowledgment_deadline: null,
            target_audience: JSON.stringify({ type: 'all', segments: [] }),
            is_mandatory: false,
            change_summary: '',
            created_at: new Date(now - 3600000).toISOString(),
            updated_at: new Date(now - 3600000).toISOString(),
            published_at: null,
            created_by: 'admin-1'
        },
        {
            carrier_id: '__TEST_SEED__carrier-1',
            title: '__TEST_SEED__ Archived: Old Drug Testing Policy',
            category: 'compliance',
            description: 'Previous drug testing policy superseded by updated version.',
            content_type: 'pdf',
            content: '',
            external_url: '',
            version: 2,
            status: 'archived',
            requires_acknowledgment: true,
            acknowledgment_deadline: null,
            target_audience: JSON.stringify({ type: 'all', segments: [] }),
            is_mandatory: true,
            change_summary: 'Archived - replaced by v3.',
            created_at: new Date(now - 31536000000).toISOString(),
            updated_at: new Date(now - 15768000000).toISOString(),
            published_at: new Date(now - 31536000000).toISOString(),
            created_by: 'admin-2'
        }
    ];
}

function generatePolicyAcknowledgments(policyIds) {
    const now = new Date();
    return [
        {
            policy_id: policyIds[0] || 'pol-1',
            driver_id: 'test-driver-1',
            acknowledged_at: new Date(now - 5000000).toISOString(),
            signature_type: 'checkbox',
            ip_address: '192.168.1.100',
            device_info: 'Chrome/Win10',
            policy_version: 3
        },
        {
            policy_id: policyIds[0] || 'pol-1',
            driver_id: 'test-driver-2',
            acknowledged_at: new Date(now - 4000000).toISOString(),
            signature_type: 'checkbox',
            ip_address: '10.0.0.50',
            device_info: 'Safari/iOS',
            policy_version: 3
        },
        {
            policy_id: policyIds[0] || 'pol-1',
            driver_id: 'test-driver-3',
            acknowledged_at: new Date(now - 3000000).toISOString(),
            signature_type: 'e_signature',
            ip_address: '172.16.0.22',
            device_info: 'Firefox/Linux',
            policy_version: 3
        },
        {
            policy_id: policyIds[2] || 'pol-3',
            driver_id: 'test-driver-1',
            acknowledged_at: new Date(now - 20000000000).toISOString(),
            signature_type: 'checkbox',
            ip_address: '192.168.1.100',
            device_info: 'Chrome/Win10',
            policy_version: 2
        },
        {
            policy_id: policyIds[2] || 'pol-3',
            driver_id: 'test-driver-4',
            acknowledged_at: new Date(now - 19000000000).toISOString(),
            signature_type: 'checkbox',
            ip_address: '',
            device_info: '',
            policy_version: 2
        }
    ];
}

// =============================================================================
// SEED FUNCTIONS
// =============================================================================

async function seedCollection(key, items) {
    const existing = await countData(key);
    if (existing > 0) {
        console.log(`[Seed] ${key} already has data. Skipping.`);
        return { seeded: false, count: existing };
    }

    console.log(`[Seed] Seeding ${items.length} records into ${key}...`);
    const ids = [];
    const chunks = chunkArray(items, 10);

    for (const chunk of chunks) {
        const results = await Promise.all(
            chunk.map(async (item) => {
                try {
                    const result = await insertData(key, item);
                    return { success: true, id: result._id || result.id };
                } catch (error) {
                    console.error(`[Seed] Failed to insert into ${key}:`, error.message);
                    return { success: false, error: error.message };
                }
            })
        );
        ids.push(...results.filter(r => r.success).map(r => r.id));
        await new Promise(r => setTimeout(r, 200));
    }

    return { seeded: true, count: ids.length, ids };
}

export async function seedCarrierAnnouncements() {
    return seedCollection(COLLECTIONS.carrierAnnouncements, generateCarrierAnnouncements());
}

export async function seedAnnouncementReadReceipts(announcementIds) {
    return seedCollection(COLLECTIONS.announcementReadReceipts, generateAnnouncementReadReceipts(announcementIds || []));
}

export async function seedAnnouncementComments(announcementIds) {
    return seedCollection(COLLECTIONS.announcementComments, generateAnnouncementComments(announcementIds || []));
}

export async function seedCarrierNotificationSettings() {
    return seedCollection(COLLECTIONS.carrierNotificationSettings, generateCarrierNotificationSettings());
}

export async function seedDriverNotificationPreferences() {
    return seedCollection(COLLECTIONS.driverNotificationPreferences, generateDriverNotificationPreferences());
}

export async function seedPolicyDocuments() {
    return seedCollection(COLLECTIONS.policyDocuments, generatePolicyDocuments());
}

export async function seedPolicyAcknowledgments(policyIds) {
    return seedCollection(COLLECTIONS.policyAcknowledgments, generatePolicyAcknowledgments(policyIds || []));
}

// =============================================================================
// ORCHESTRATOR
// =============================================================================

/**
 * Seed all carrier comms collections in dependency order.
 *
 * Usage from Wix page:
 * ```javascript
 * import { seedAllCarrierComms } from 'backend/seeds/seedCarrierComms';
 * const result = await seedAllCarrierComms();
 * console.log('Seed result:', result);
 * ```
 *
 * @returns {Promise<Object>} Results per collection
 */
export async function seedAllCarrierComms() {
    console.log('='.repeat(50));
    console.log('[Seed] Starting CarrierComms seed...');
    console.log('='.repeat(50));

    const results = {};

    // Step 1: Carrier Announcements (no deps)
    results.carrierAnnouncements = await seedCarrierAnnouncements();

    // Step 2: Read Receipts (depends on announcement IDs)
    results.announcementReadReceipts = await seedAnnouncementReadReceipts(results.carrierAnnouncements.ids);

    // Step 3: Comments (depends on announcement IDs)
    results.announcementComments = await seedAnnouncementComments(results.carrierAnnouncements.ids);

    // Step 4: Carrier Notification Settings (no deps)
    results.carrierNotificationSettings = await seedCarrierNotificationSettings();

    // Step 5: Driver Notification Preferences (no deps)
    results.driverNotificationPreferences = await seedDriverNotificationPreferences();

    // Step 6: Policy Documents (no deps)
    results.policyDocuments = await seedPolicyDocuments();

    // Step 7: Policy Acknowledgments (depends on policy IDs)
    results.policyAcknowledgments = await seedPolicyAcknowledgments(results.policyDocuments.ids);

    console.log('='.repeat(50));
    console.log('[Seed] CarrierComms seed complete:', JSON.stringify(results, null, 2));
    console.log('='.repeat(50));

    return results;
}

// =============================================================================
// UTILITIES
// =============================================================================

function chunkArray(arr, size) {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
    }
    return chunks;
}
