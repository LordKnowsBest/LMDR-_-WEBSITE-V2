/**
 * SEED DATA: Carrier Matching
 * ===========================
 * Seeds carrier accounts and hiring preferences for Wave 1 verification.
 *
 * Collections seeded:
 *   - carrierAccounts (10 records) -> v2_Carriers
 *   - carrierHiringPreferences (10 records) -> v2_Carrier Hiring Preferences
 *
 * Edge cases included:
 *   - 1 inactive carrier (no hiring preferences)
 *   - 1 carrier with immediate urgency
 *   - 1 carrier accepting recent grads (0 experience required)
 *   - 1 carrier with high pay range
 *   - 1 carrier with restrictive requirements (many endorsements)
 *
 * @module backend/seeds/seedCarrierMatching
 */

import wixData from 'wix-data';
import { usesAirtable, getAirtableTableName, getWixCollectionName } from 'backend/configData';
import * as airtable from 'backend/airtableClient';

// =============================================================================
// DUAL-SOURCE HELPERS (do not modify)
// =============================================================================

async function insertData(collectionKey, data) {
    if (usesAirtable(collectionKey)) {
        const tableName = getAirtableTableName(collectionKey);
        const { _id, ...airtableData } = data;
        return await airtable.createRecord(tableName, airtableData);
    }
    const wixName = getWixCollectionName(collectionKey);
    return await wixData.insert(wixName, data, { suppressAuth: true });
}

async function countData(collectionKey) {
    if (usesAirtable(collectionKey)) {
        const tableName = getAirtableTableName(collectionKey);
        const result = await airtable.queryRecords(tableName, { maxRecords: 1 });
        return (result.records || []).length;
    }
    const wixName = getWixCollectionName(collectionKey);
    return await wixData.query(wixName).limit(1).count({ suppressAuth: true });
}

// =============================================================================
// COLLECTION KEYS
// =============================================================================

const COLLECTIONS = {
    carriers: 'carrierAccounts',       // v2_Carriers - active platform accounts
    preferences: 'carrierHiringPreferences' // v2_Carrier Hiring Preferences
};

// =============================================================================
// DATA GENERATORS
// =============================================================================

const CDL_CLASSES = ['A', 'B', 'C'];
const ENDORSEMENTS = ['H', 'N', 'P', 'S', 'T', 'X'];
const EQUIPMENT_TYPES = ['Dry Van', 'Reefer', 'Flatbed', 'Tanker', 'Intermodal'];
const CARRIER_OPERATIONS = ['Authorized For Hire', 'Private(Property)', 'Exempt For Hire'];
const URGENCY_LEVELS = ['immediate', '2_week', '30_day', 'ongoing'];
const STATES = ['TX', 'CA', 'FL', 'GA', 'IL', 'OH', 'PA', 'NY', 'NC', 'MI'];
const ZIP_CODES = ['75001', '90210', '33101', '30301', '60601', '44101', '19101', '10001', '27601', '48201'];

const CARRIER_NAMES = [
    'Swift Transportation',
    'Werner Enterprises',
    'J.B. Hunt Transport',
    'Schneider National',
    'Landstar System',
    'XPO Logistics',
    'Old Dominion Freight',
    'Knight Transportation',
    'Saia Inc',
    'Heartland Express'
];

function generateCarriers(count = 10) {
    const records = [];
    const now = new Date();

    for (let i = 0; i < count; i++) {
        const isInactive = i === 0;
        const isHighPay = i === 3;
        const isSmallFleet = i === 4;
        const isLargeFleet = i === 5;

        const carrier = {
            // Test seed identifier
            dot_number: 1000000 + i, // __TEST_SEED__ DOT numbers 1000000-1000009
            legal_name: `__TEST_SEED__ ${CARRIER_NAMES[i % CARRIER_NAMES.length]}`,
            dba_name: i % 2 === 0 ? `Test ${CARRIER_NAMES[i % CARRIER_NAMES.length]} DBA` : null,
            mc_number: 500000 + i,

            // Location
            city: ['Dallas', 'Los Angeles', 'Miami', 'Atlanta', 'Chicago', 'Columbus', 'Philadelphia', 'New York', 'Raleigh', 'Detroit'][i],
            state: STATES[i % STATES.length],
            zip_code: parseInt(ZIP_CODES[i % ZIP_CODES.length]),

            // Contact
            telephone: `555-010-000${i}`,
            email_address: `carrier${i}@test.lmdr.com`,

            // Fleet info
            fleet_size: isSmallFleet ? 15 : (isLargeFleet ? 500 : 50 + (i * 20)),
            power_units: isSmallFleet ? 10 : (isLargeFleet ? 450 : 40 + (i * 15)),
            driver_total: isSmallFleet ? 12 : (isLargeFleet ? 480 : 45 + (i * 18)),
            truck_age_avg: 2 + (i % 5),

            // Pay
            pay_rate_min: isHighPay ? 0.65 : (0.45 + (i * 0.02)),
            pay_rate_max: isHighPay ? 0.85 : (0.55 + (i * 0.02)),
            pay_cpm: isHighPay ? 75 : (50 + i * 2),

            // Operations
            carrier_operation: CARRIER_OPERATIONS[i % CARRIER_OPERATIONS.length],

            // Scores
            turnover_rate_pct: isInactive ? 80 : (15 + (i * 5)),
            accident_rate: i % 3 === 0 ? 2 : (i % 5 === 0 ? 1 : 0),
            priority_score: isInactive ? 20 : (60 + (i * 4)),
            fleet_score: isSmallFleet ? 40 : (isLargeFleet ? 90 : 60 + (i * 3)),
            recruitment_score: isInactive ? 30 : (50 + (i * 5)),
            combined_score: isInactive ? 35 : (55 + (i * 4)),

            // Mileage
            recent_mileage: isSmallFleet ? 500000 : (isLargeFleet ? 50000000 : 5000000 + (i * 1000000)),
            recent_mileage_year: 2025,
            fleet_mpg: 6 + (i % 3),
            load_truck_ratio: 1.2 + (i * 0.1),

            // Metadata
            owner: `__TEST_SEED__carrier_owner_${i}`,
            created_date: new Date(now.getTime() - (30 - i) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            updated_date: now.toISOString().split('T')[0]
        };

        records.push(carrier);
    }

    return records;
}

function generateHiringPreferences(carrierDots = []) {
    const records = [];
    const now = new Date();

    // Skip the first carrier (inactive) - no preferences
    for (let i = 1; i < carrierDots.length; i++) {
        const isImmediateHire = i === 1;
        const isRecentGradFriendly = i === 2;
        const isHighPay = i === 3;
        const isRestrictive = i === 6;

        const preferences = {
            carrier_dot: carrierDots[i],

            // CDL requirements
            required_cdl_class: CDL_CLASSES[i % CDL_CLASSES.length],
            required_cdl_types: JSON.stringify(
                isRestrictive ? ['A'] : CDL_CLASSES.slice(0, 2 + (i % 2))
            ),
            required_endorsements: JSON.stringify(
                isRestrictive
                    ? ['H', 'T', 'N', 'X']
                    : ENDORSEMENTS.slice(0, i % 3)
            ),

            // Experience
            min_experience_years: isRecentGradFriendly ? 0 : (1 + (i % 3)),
            max_experience_years: isRecentGradFriendly ? 5 : null,
            accepts_recent_grads: isRecentGradFriendly ? 'Yes' : 'No',

            // Safety requirements
            max_accidents_3yr: isRestrictive ? 0 : (1 + (i % 2)),
            max_violations_3yr: isRestrictive ? 0 : (2 + (i % 3)),

            // Location targeting
            target_states: JSON.stringify(STATES.slice(i % 5, (i % 5) + 3)),
            target_zip_codes: JSON.stringify([ZIP_CODES[i % ZIP_CODES.length]]),
            target_radius_miles: 50 + (i * 25),

            // Pay
            offered_pay_min_cpm: isHighPay ? 65 : (45 + (i * 2)),
            offered_pay_max_cpm: isHighPay ? 85 : (55 + (i * 2)),

            // Equipment
            equipment_types: JSON.stringify(
                EQUIPMENT_TYPES.slice(0, 1 + (i % 3))
            ),

            // Urgency
            urgency: isImmediateHire ? 'immediate' : URGENCY_LEVELS[i % URGENCY_LEVELS.length],

            // Scoring weights (customized for some carriers)
            weight_qualifications: 30 + (i % 10),
            weight_experience: 20 + (i % 5),
            weight_location: 20 - (i % 5),
            weight_availability: 15,
            weight_salary_fit: 10,
            weight_engagement: 5,

            // Status
            is_active: 'Yes'
        };

        records.push(preferences);
    }

    return records;
}

// =============================================================================
// SEED FUNCTIONS
// =============================================================================

export async function seedCarrierAccounts() {
    const key = COLLECTIONS.carriers;
    const existing = await countData(key);
    if (existing > 0) {
        console.log(`[Seed] ${key} already has data. Skipping.`);
        return { seeded: false, count: existing };
    }

    const items = generateCarriers(10);
    console.log(`[Seed] Seeding ${items.length} records into ${key}...`);

    const ids = [];
    const dots = [];
    const chunks = chunkArray(items, 10);

    for (const chunk of chunks) {
        const results = await Promise.all(
            chunk.map(async (item) => {
                try {
                    const result = await insertData(key, item);
                    return { success: true, id: result._id || result.id, dot: item.dot_number };
                } catch (error) {
                    console.error(`[Seed] Failed to insert carrier ${item.dot_number}:`, error.message);
                    return { success: false, error: error.message };
                }
            })
        );
        ids.push(...results.filter(r => r.success).map(r => r.id));
        dots.push(...results.filter(r => r.success).map(r => r.dot));
        await new Promise(r => setTimeout(r, 200)); // Rate limit
    }

    return { seeded: true, count: ids.length, ids, dots };
}

export async function seedCarrierHiringPreferences(carrierDots) {
    const key = COLLECTIONS.preferences;
    if (!carrierDots?.length) {
        console.log(`[Seed] No carrier DOTs provided for ${key}. Skipping.`);
        return { seeded: false, count: 0 };
    }

    const items = generateHiringPreferences(carrierDots);
    console.log(`[Seed] Seeding ${items.length} records into ${key}...`);

    const ids = [];
    const chunks = chunkArray(items, 10);

    for (const chunk of chunks) {
        const results = await Promise.all(
            chunk.map(item => insertData(key, item)
                .then(r => ({ success: true, id: r._id || r.id }))
                .catch(e => ({ success: false, error: e.message }))
            )
        );
        ids.push(...results.filter(r => r.success).map(r => r.id));
        await new Promise(r => setTimeout(r, 200));
    }

    return { seeded: true, count: ids.length, ids };
}

// =============================================================================
// ORCHESTRATOR
// =============================================================================

/**
 * Seed all carrier matching collections
 *
 * Usage from Wix page:
 * ```javascript
 * import { seedAllCarrierMatching } from 'backend/seeds/seedCarrierMatching';
 * const result = await seedAllCarrierMatching();
 * console.log('Seed result:', result);
 * ```
 */
export async function seedAllCarrierMatching() {
    console.log('='.repeat(50));
    console.log('[Seed] Starting CarrierMatching seed...');
    console.log('='.repeat(50));

    const results = {};

    // Step 1: Seed carrier accounts
    results.carriers = await seedCarrierAccounts();

    // Step 2: Seed hiring preferences (depends on carrier DOTs)
    if (results.carriers.dots?.length) {
        results.hiringPreferences = await seedCarrierHiringPreferences(results.carriers.dots);
    }

    console.log('='.repeat(50));
    console.log('[Seed] Complete:', JSON.stringify(results, null, 2));
    console.log('='.repeat(50));

    return results;
}

// Alias for consistency with template
export const seedAll = seedAllCarrierMatching;

// =============================================================================
// UTILITIES
// =============================================================================

function chunkArray(arr, size) {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
    }
    return chunks;
}
