/**
 * adminBusinessOpsAgentService.jsw
 * Thin wrapper for admin business operations agent actions.
 * Delegates to adminRevenueService, adminBillingService, adminInvoiceService, adminCommissionService.
 */

import * as dataAccess from 'backend/dataAccess';

const COLLECTIONS = {
  subscriptions: 'carrierSubscriptions'
};

// ── 1. Revenue Dashboard ──────────────────────────────────────────
export async function getRevenueDashboard(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const revenueSvc = await import('backend/adminRevenueService');
    const result = await revenueSvc.getRevenueSnapshot();
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] getRevenueDashboard error:', error.message);
    return { error: error.message };
  }
}

// ── 2. Billing Overview ───────────────────────────────────────────
export async function getBillingOverview(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const billingSvc = await import('backend/adminBillingService');

    if (params.carrierDot) {
      const result = await billingSvc.getBillingDetails(params.carrierDot);
      return result;
    }

    // Summary of active subscriptions
    const subs = await dataAccess.queryRecords(COLLECTIONS.subscriptions, {
      filters: { status: 'active' },
      limit: 1000,
      suppressAuth: true
    });
    const items = subs.items || [];
    const totalActive = items.length;
    const totalMRR = items.reduce((sum, s) => sum + (Number(s.monthly_amount) || 0), 0);

    return { totalActive, totalMRR, currency: 'USD' };
  } catch (error) {
    console.error('[AdminBusinessOps] getBillingOverview error:', error.message);
    return { error: error.message };
  }
}

// ── 3. Get Invoices ───────────────────────────────────────────────
export async function getInvoices(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const invoiceSvc = await import('backend/adminInvoiceService');
    const result = await invoiceSvc.getInvoices(params);
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] getInvoices error:', error.message);
    return { error: error.message };
  }
}

// ── 4. Create Invoice ─────────────────────────────────────────────
export async function createInvoice(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const invoiceSvc = await import('backend/adminInvoiceService');
    const result = await invoiceSvc.createInvoice({ ...params, created_by: userId });
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] createInvoice error:', error.message);
    return { error: error.message };
  }
}

// ── 5. Commission Report ──────────────────────────────────────────
export async function getCommissionReport(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const commissionSvc = await import('backend/adminCommissionService');
    const result = await commissionSvc.getCommissionSummary(params.period || 'current');
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] getCommissionReport error:', error.message);
    return { error: error.message };
  }
}

// ── 6. Approve Commission ─────────────────────────────────────────
export async function approveCommission(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.commissionId) return { error: 'params.commissionId is required' };
    const commissionSvc = await import('backend/adminCommissionService');
    const result = await commissionSvc.approveCommission(params.commissionId, userId);
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] approveCommission error:', error.message);
    return { error: error.message };
  }
}

// ── 7. MRR Metrics ────────────────────────────────────────────────
export async function getMRRMetrics(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const revenueSvc = await import('backend/adminRevenueService');
    const result = await revenueSvc.getMRRTrend(params.months || 12);
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] getMRRMetrics error:', error.message);
    return { error: error.message };
  }
}

// ── 8. Churn Metrics ──────────────────────────────────────────────
export async function getChurnMetrics(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const revenueSvc = await import('backend/adminRevenueService');
    const result = await revenueSvc.getChurnAnalysis(params.days || 90);
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] getChurnMetrics error:', error.message);
    return { error: error.message };
  }
}

// ── 9. ARPU Breakdown ─────────────────────────────────────────────
export async function getARPUBreakdown(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const revenueSvc = await import('backend/adminRevenueService');
    const result = await revenueSvc.getRevenueByTier();
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] getARPUBreakdown error:', error.message);
    return { error: error.message };
  }
}

// ── 10. Export Financial Report ────────────────────────────────────
export async function exportFinancialReport(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const revenueSvc = await import('backend/adminRevenueService');
    const result = await revenueSvc.exportRevenueCSV(params.type || 'snapshot');
    return result;
  } catch (error) {
    console.error('[AdminBusinessOps] exportFinancialReport error:', error.message);
    return { error: error.message };
  }
}
