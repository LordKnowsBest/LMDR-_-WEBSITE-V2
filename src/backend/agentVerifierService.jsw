// ============================================================================
// AGENT VERIFIER SERVICE - Phase 4 verifier scaffolding
// Provides lightweight verification before final synthesis on flagged workflows.
// ============================================================================

function summarizeVerificationIssues(role, workflowType, responseText) {
  const issues = [];
  if (!responseText || !responseText.trim()) {
    issues.push('empty_response');
  }
  if (workflowType === 'admin_diagnostics' && !/health|trace|api|performance|error|benchmark/i.test(responseText || '')) {
    issues.push('missing_diagnostic_terms');
  }
  if (role === 'driver' && /(guaranteed|promise|definitely)/i.test(responseText || '')) {
    issues.push('overconfident_driver_language');
  }
  return issues;
}

export async function verifyPlannedResponse(role, executionPlan, verificationContext = {}) {
  const workflowType = executionPlan?.workflow_type || `${role}_general`;
  const responseText = verificationContext.responseText || '';
  const prefetchedSummary = verificationContext.prefetchedSummary || '';
  const issues = summarizeVerificationIssues(role, workflowType, responseText);

  let status = 'verified';
  if (issues.includes('empty_response')) {
    status = 'blocked';
  } else if (issues.length > 0) {
    status = 'degraded_but_acceptable';
  }

  return {
    status,
    workflow_type: workflowType,
    issues,
    prefetched_context_present: !!prefetchedSummary,
    verifier_type: workflowType === 'admin_diagnostics' ? 'consistency_verifier' : 'policy_verifier'
  };
}
