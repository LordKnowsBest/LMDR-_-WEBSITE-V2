import * as dataAccess from 'backend/dataAccess';

const COLLECTIONS = {
  tasks: 'b2bTasks',
  contacts: 'b2bContacts',
  activities: 'b2bActivities',
  matchSignals: 'b2bMatchSignals'
};

// ── 1. Match Intelligence ──────────────────────────────────────────────
export async function getMatchIntelligence(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.carrierDot) return { error: 'carrierDot is required' };
    const signalSvc = await import('backend/b2bMatchSignalService');
    return await signalSvc.getSignalByCarrier(params.carrierDot);
  } catch (error) {
    console.error('[B2BAgent] getMatchIntelligence error:', error.message);
    return { error: error.message };
  }
}

// ── 2. Pipeline ────────────────────────────────────────────────────────
export async function getB2BPipeline(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const pipelineSvc = await import('backend/b2bPipelineService');
    return await pipelineSvc.getPipelineView(params);
  } catch (error) {
    console.error('[B2BAgent] getB2BPipeline error:', error.message);
    return { error: error.message };
  }
}

// ── 3. Opportunity Stage ───────────────────────────────────────────────
export async function updateOpportunityStage(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.opportunityId) return { error: 'opportunityId is required' };
    if (!params.newStage) return { error: 'newStage is required' };
    const pipelineSvc = await import('backend/b2bPipelineService');
    return await pipelineSvc.moveStage(params.opportunityId, params.newStage, params.closeReason || '');
  } catch (error) {
    console.error('[B2BAgent] updateOpportunityStage error:', error.message);
    return { error: error.message };
  }
}

// ── 4. Create Outreach ─────────────────────────────────────────────────
export async function createOutreach(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const activitySvc = await import('backend/b2bActivityService');
    return await activitySvc.logEmail(
      params.accountId,
      params.contactId || '',
      params.subject || 'Outreach',
      'sent',
      userId
    );
  } catch (error) {
    console.error('[B2BAgent] createOutreach error:', error.message);
    return { error: error.message };
  }
}

// ── 5. B2B Events ──────────────────────────────────────────────────────
export async function getB2BEvents(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const activitySvc = await import('backend/b2bActivityService');
    return await activitySvc.getAccountTimeline(params.accountId, params);
  } catch (error) {
    console.error('[B2BAgent] getB2BEvents error:', error.message);
    return { error: error.message };
  }
}

// ── 6. Run Research Agent ──────────────────────────────────────────────
export async function runResearchAgent(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const researchSvc = await import('backend/b2bResearchAgentService');
    return await researchSvc.generateBrief(params.accountId, true);
  } catch (error) {
    console.error('[B2BAgent] runResearchAgent error:', error.message);
    return { error: error.message };
  }
}

// ── 7. Get Research Results ────────────────────────────────────────────
export async function getResearchResults(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const researchSvc = await import('backend/b2bResearchAgentService');
    return await researchSvc.generateBrief(params.accountId, false);
  } catch (error) {
    console.error('[B2BAgent] getResearchResults error:', error.message);
    return { error: error.message };
  }
}

// ── 8. B2B Analytics ───────────────────────────────────────────────────
export async function getB2BAnalytics(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const analyticsSvc = await import('backend/b2bAnalyticsService');
    return await analyticsSvc.getDashboardKPIs(params);
  } catch (error) {
    console.error('[B2BAgent] getB2BAnalytics error:', error.message);
    return { error: error.message };
  }
}

// ── 9. Create B2B Account ──────────────────────────────────────────────
export async function createB2BAccount(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const accountSvc = await import('backend/b2bAccountService');
    return await accountSvc.createAccount({ ...params, owner_id: userId });
  } catch (error) {
    console.error('[B2BAgent] createB2BAccount error:', error.message);
    return { error: error.message };
  }
}

// ── 10. Update B2B Account ─────────────────────────────────────────────
export async function updateB2BAccount(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const accountSvc = await import('backend/b2bAccountService');
    return await accountSvc.updateAccount(params.accountId, params);
  } catch (error) {
    console.error('[B2BAgent] updateB2BAccount error:', error.message);
    return { error: error.message };
  }
}

// ── 11. Get Tasks ──────────────────────────────────────────────────────
export async function getTasks(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    const filters = {};
    if (params.accountId) {
      filters.account_id = params.accountId;
    } else {
      filters.assigned_to = userId;
    }
    filters.status = params.status || 'open';

    const result = await dataAccess.queryRecords(COLLECTIONS.tasks, {
      filters,
      sort: [{ fieldName: 'due_date', order: 'asc' }],
      limit: params.limit || 50,
      skip: params.skip || 0,
      suppressAuth: true
    });
    return result;
  } catch (error) {
    console.error('[B2BAgent] getTasks error:', error.message);
    return { error: error.message };
  }
}

// ── 12. Create Task ────────────────────────────────────────────────────
export async function createTask(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.title) return { error: 'title is required' };
    const record = {
      account_id: params.accountId || '',
      title: params.title,
      description: params.description || '',
      status: 'open',
      priority: params.priority || 'medium',
      due_date: params.dueDate || '',
      assigned_to: params.assignedTo || userId,
      created_by: userId,
      created_at: new Date().toISOString()
    };
    return await dataAccess.insertRecord(COLLECTIONS.tasks, record, { suppressAuth: true });
  } catch (error) {
    console.error('[B2BAgent] createTask error:', error.message);
    return { error: error.message };
  }
}

// ── 13. Complete Task ──────────────────────────────────────────────────
export async function completeTask(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.taskId) return { error: 'taskId is required' };

    const existing = await dataAccess.getRecord(COLLECTIONS.tasks, params.taskId, { suppressAuth: true });
    if (!existing) return { error: 'Task not found' };

    return await dataAccess.updateRecord(COLLECTIONS.tasks, params.taskId, {
      status: 'completed',
      completed_at: new Date().toISOString()
    }, { suppressAuth: true });
  } catch (error) {
    console.error('[B2BAgent] completeTask error:', error.message);
    return { error: error.message };
  }
}

// ── 14. Get Contacts ───────────────────────────────────────────────────
export async function getContacts(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const result = await dataAccess.queryRecords(COLLECTIONS.contacts, {
      filters: { account_id: params.accountId },
      limit: params.limit || 50,
      skip: params.skip || 0,
      suppressAuth: true
    });
    return result;
  } catch (error) {
    console.error('[B2BAgent] getContacts error:', error.message);
    return { error: error.message };
  }
}

// ── 15. Add Contact ────────────────────────────────────────────────────
export async function addContact(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const record = {
      account_id: params.accountId,
      first_name: params.firstName || '',
      last_name: params.lastName || '',
      email: params.email || '',
      phone: params.phone || '',
      title: params.title || '',
      role: params.role || '',
      is_primary: params.isPrimary ? 'Yes' : 'No',
      created_by: userId,
      created_at: new Date().toISOString()
    };
    return await dataAccess.insertRecord(COLLECTIONS.contacts, record, { suppressAuth: true });
  } catch (error) {
    console.error('[B2BAgent] addContact error:', error.message);
    return { error: error.message };
  }
}

// ── 16. Get Notes ──────────────────────────────────────────────────────
export async function getNotes(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    const result = await dataAccess.queryRecords(COLLECTIONS.activities, {
      filters: { account_id: params.accountId, activity_type: 'note' },
      sort: [{ fieldName: 'created_at', order: 'desc' }],
      limit: params.limit || 50,
      skip: params.skip || 0,
      suppressAuth: true
    });
    return result;
  } catch (error) {
    console.error('[B2BAgent] getNotes error:', error.message);
    return { error: error.message };
  }
}

// ── 17. Add Note ───────────────────────────────────────────────────────
export async function addNote(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId) return { error: 'accountId is required' };
    if (!params.notes) return { error: 'notes is required' };
    const activitySvc = await import('backend/b2bActivityService');
    return await activitySvc.logNote(params.accountId, params.notes, userId);
  } catch (error) {
    console.error('[B2BAgent] addNote error:', error.message);
    return { error: error.message };
  }
}

// ── 18. Get Account Score ──────────────────────────────────────────────
export async function getAccountScore(userId, params = {}) {
  try {
    if (!userId) return { error: 'userId is required' };
    if (!params.accountId && !params.carrierDot) {
      return { error: 'accountId or carrierDot is required' };
    }

    const filters = {};
    if (params.accountId) filters.account_id = params.accountId;
    if (params.carrierDot) filters.carrier_dot = params.carrierDot;

    const result = await dataAccess.queryRecords(COLLECTIONS.matchSignals, {
      filters,
      limit: 1,
      suppressAuth: true
    });

    const items = result?.items || result || [];
    const signal = Array.isArray(items) ? items[0] : items;
    if (!signal) return { error: 'No signal data found' };

    const fit = Number(signal.fit_score) || 0;
    const intent = Number(signal.intent_score) || 0;
    const engagement = Number(signal.engagement_score) || 0;
    const composite = Math.round((fit + intent + engagement) / 3);

    return {
      fit_score: fit,
      intent_score: intent,
      engagement_score: engagement,
      composite_score: composite,
      signal
    };
  } catch (error) {
    console.error('[B2BAgent] getAccountScore error:', error.message);
    return { error: error.message };
  }
}
