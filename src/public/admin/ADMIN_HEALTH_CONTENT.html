<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Content Manager | LMDR Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-active { @apply border-b-2 border-blue-600 text-blue-600; }
        .markdown-editor { font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Health Content Manager</h1>
                <p class="text-slate-500 text-sm">Manage resources and moderate community tips</p>
            </div>
            <button onclick="openResourceModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                <i class="fa-solid fa-plus mr-2"></i> New Resource
            </button>
        </header>

        <!-- TABS -->
        <div class="bg-white rounded-t-xl border-b border-slate-200 px-6 flex gap-6">
            <button onclick="switchTab('resources')" id="tab-resources" class="py-4 text-sm font-medium text-slate-600 hover:text-slate-900 border-b-2 border-transparent tab-active">
                Resources
            </button>
            <button onclick="switchTab('tips')" id="tab-tips" class="py-4 text-sm font-medium text-slate-600 hover:text-slate-900 border-b-2 border-transparent relative">
                Tip Moderation
                <span id="pending-count" class="hidden absolute top-3 -right-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span>
            </button>
        </div>

        <!-- CONTENT -->
        <div class="bg-white rounded-b-xl shadow-sm min-h-[500px] p-6">
            
            <!-- RESOURCES VIEW -->
            <div id="view-resources" class="space-y-4">
                <div class="flex gap-4 mb-4">
                    <input type="text" placeholder="Search resources..." class="flex-1 border border-slate-300 rounded-lg px-4 py-2 text-sm">
                    <select class="border border-slate-300 rounded-lg px-4 py-2 text-sm bg-white">
                        <option value="all">All Categories</option>
                        <option value="exercise">Exercise</option>
                        <option value="nutrition">Nutrition</option>
                        <option value="mental_health">Mental Health</option>
                        <option value="sleep">Sleep</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200">
                                <th class="py-3 pl-2">Title</th>
                                <th class="py-3">Category</th>
                                <th class="py-3">Stats</th>
                                <th class="py-3">Status</th>
                                <th class="py-3 text-right pr-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resources-list" class="text-sm text-slate-700 divide-y divide-slate-100">
                            <!-- Injected -->
                            <tr><td colspan="5" class="text-center py-10 text-slate-400">Loading resources...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TIPS VIEW -->
            <div id="view-tips" class="hidden space-y-6">
                <div id="tips-list" class="grid grid-cols-1 gap-4">
                    <!-- Injected -->
                    <div class="text-center py-10 text-slate-400">No pending tips to moderate.</div>
                </div>
            </div>

        </div>
    </div>

    <!-- RESOURCE EDITOR MODAL -->
    <div id="editor-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800" id="editor-title">Create Resource</h3>
                <button onclick="closeEditor()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                        <input type="text" id="edit-title" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Slug</label>
                        <input type="text" id="edit-slug" class="w-full border border-slate-300 rounded-lg px-3 py-2 bg-slate-50" readonly>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                        <select id="edit-category" class="w-full border border-slate-300 rounded-lg px-3 py-2 bg-white">
                            <option value="exercise">Exercise</option>
                            <option value="nutrition">Nutrition</option>
                            <option value="mental_health">Mental Health</option>
                            <option value="sleep">Sleep</option>
                            <option value="telemedicine">Telemedicine</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Thumbnail URL</label>
                        <input type="text" id="edit-thumbnail" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                    </div>
                     <div class="flex items-center pt-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="edit-featured" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm font-medium text-slate-700">Featured on Homepage</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Summary</label>
                    <textarea id="edit-summary" rows="2" class="w-full border border-slate-300 rounded-lg px-3 py-2"></textarea>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                    <div class="flex flex-col">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Content (Markdown)</label>
                        <textarea id="edit-content" class="flex-1 w-full border border-slate-300 rounded-lg px-3 py-2 markdown-editor resize-none" oninput="updatePreview()"></textarea>
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Preview</label>
                        <div id="preview-content" class="flex-1 w-full border border-slate-200 bg-slate-50 rounded-lg px-4 py-2 overflow-y-auto prose prose-sm max-w-none"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 flex justify-end gap-3 bg-slate-50 rounded-b-xl">
                <button onclick="closeEditor()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg font-medium">Cancel</button>
                <button onclick="saveResource()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Save Resource</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE & BRIDGE
        // ==========================================
        let resources = [];
        let tips = [];

        function sendToVelo(type, data = {}) {
            if (window.parent) window.parent.postMessage({ type, data }, '*');
        }

        window.onmessage = (event) => {
            const { type, data } = event.data || {};
            if (type === 'resourcesList') {
                resources = data;
                renderResources();
            }
            if (type === 'tipsList') {
                tips = data;
                renderTips();
                updatePendingCount();
            }
        };

        // ==========================================
        // UI LOGIC
        // ==========================================
        function switchTab(tab) {
            document.querySelectorAll('button[id^="tab-"]').forEach(b => b.classList.remove('tab-active', 'border-blue-600', 'text-blue-600'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active', 'border-blue-600', 'text-blue-600');
            
            document.getElementById('view-resources').classList.add('hidden');
            document.getElementById('view-tips').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');

            if(tab === 'resources') sendToVelo('getResources');
            if(tab === 'tips') sendToVelo('getPendingTips');
        }

        function renderResources() {
            const tbody = document.getElementById('resources-list');
            tbody.innerHTML = resources.map(r => `
                <tr class="hover:bg-slate-50 group">
                    <td class="py-3 pl-2">
                        <div class="font-medium text-slate-900">${r.title}</div>
                        <div class="text-xs text-slate-400 font-mono">/${r.slug}</div>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-1 bg-slate-100 rounded text-xs font-medium uppercase tracking-wide text-slate-600">${r.category}</span>
                    </td>
                    <td class="py-3 text-xs text-slate-500">
                        <div class="flex gap-3">
                            <span><i class="fa-solid fa-eye mr-1"></i> ${r.view_count || 0}</span>
                            <span><i class="fa-solid fa-thumbs-up mr-1"></i> ${r.helpful_count || 0}</span>
                        </div>
                    </td>
                    <td class="py-3">
                        ${r.is_featured ? '<span class="text-amber-600 text-xs font-bold"><i class="fa-solid fa-star mr-1"></i> Featured</span>' : '<span class="text-slate-400 text-xs">Standard</span>'}
                    </td>
                    <td class="py-3 text-right pr-2">
                        <button onclick='editResource("${r._id}")' class="text-blue-600 hover:text-blue-800 p-2"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick='deleteResource("${r._id}")' class="text-red-400 hover:text-red-600 p-2"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTips() {
            const list = document.getElementById('tips-list');
            if (tips.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-slate-400">No pending tips to moderate.</div>';
                return;
            }

            list.innerHTML = tips.map(tip => `
                <div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm flex gap-4">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold uppercase tracking-wide text-slate-500">${tip.category}</span>
                            <span class="text-xs text-slate-400">${new Date(tip.created_at).toLocaleDateString()}</span>
                        </div>
                        <h4 class="font-bold text-slate-900 mb-1">${tip.title}</h4>
                        <p class="text-slate-600 text-sm italic">"${tip.tip_text}"</p>
                    </div>
                    <div class="flex flex-col gap-2 justify-center border-l border-slate-100 pl-4">
                        <button onclick="moderateTip('${tip._id}', 'approve')" class="bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded text-sm font-medium transition flex items-center gap-1">
                            <i class="fa-solid fa-check"></i> Approve
                        </button>
                        <button onclick="moderateTip('${tip._id}', 'reject')" class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1.5 rounded text-sm font-medium transition flex items-center gap-1">
                            <i class="fa-solid fa-xmark"></i> Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updatePendingCount() {
            const count = tips.length;
            const badge = document.getElementById('pending-count');
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        
        function moderateTip(id, action) {
            sendToVelo('moderateTip', { id, action });
            // Optimistic removal
            tips = tips.filter(t => t._id !== id);
            renderTips();
            updatePendingCount();
        }

        function editResource(id) {
            const r = resources.find(x => x._id === id);
            if(!r) return;

            document.getElementById('editor-title').textContent = 'Edit Resource';
            document.getElementById('edit-id').value = r._id;
            document.getElementById('edit-title').value = r.title;
            document.getElementById('edit-slug').value = r.slug;
            document.getElementById('edit-category').value = r.category;
            document.getElementById('edit-thumbnail').value = r.thumbnail?.url || '';
            document.getElementById('edit-summary').value = r.summary || '';
            document.getElementById('edit-content').value = r.content || '';
            document.getElementById('edit-featured').checked = r.is_featured || false;
            
            updatePreview();
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function openResourceModal() {
            document.getElementById('editor-title').textContent = 'New Resource';
            document.getElementById('edit-id').value = '';
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-slug').value = ''; // Auto-generate
            document.getElementById('edit-category').value = 'exercise';
            document.getElementById('edit-thumbnail').value = '';
            document.getElementById('edit-summary').value = '';
            document.getElementById('edit-content').value = '';
            document.getElementById('edit-featured').checked = false;
            
            updatePreview();
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function closeEditor() {
            document.getElementById('editor-modal').classList.add('hidden');
        }

        function updatePreview() {
            const content = document.getElementById('edit-content').value;
            document.getElementById('preview-content').innerHTML = marked.parse(content);
        }

        document.getElementById('edit-title').addEventListener('input', (e) => {
            // Simple slug generation if new
            if(!document.getElementById('edit-id').value) {
                document.getElementById('edit-slug').value = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            }
        });

        function saveResource() {
            const data = {
                _id: document.getElementById('edit-id').value || null,
                title: document.getElementById('edit-title').value,
                slug: document.getElementById('edit-slug').value,
                category: document.getElementById('edit-category').value,
                thumbnail: { url: document.getElementById('edit-thumbnail').value },
                summary: document.getElementById('edit-summary').value,
                content: document.getElementById('edit-content').value,
                is_featured: document.getElementById('edit-featured').checked
            };

            sendToVelo('saveResource', data);
            closeEditor();
        }

        function deleteResource(id) {
            if(confirm('Are you sure you want to delete this resource?')) {
                sendToVelo('deleteResource', { id });
            }
        }

        window.onload = () => {
            sendToVelo('ready');
            sendToVelo('getResources');
        };
    </script>
</body>
</html>