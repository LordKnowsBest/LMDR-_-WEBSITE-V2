<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>LMDR Content Moderation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        // LMDR Brand Tokens
                        "primary": "#2563eb",       // blue-600
                        "primary-dark": "#1d4ed8",  // blue-700
                        "accent": "#fbbf24",        // amber-400

                        // Theme Colors (Dark)
                        "background-dark": "#0f172a", // slate-900
                        "surface-dark": "#1e293b",    // slate-800
                        "surface-darker": "#0f172a",  // slate-900

                        // Theme Colors (Light)
                        "background-light": "#f8fafc", // slate-50
                        "surface-light": "#ffffff",    // white
                        "surface-lighter": "#f1f5f9",  // slate-100

                        "border-dark": "#334155",      // slate-700
                        "border-light": "#e2e8f0",     // slate-200
                        "text-muted": "#94a3b8",       // slate-400
                        "text-dark": "#0f172a",        // slate-900
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Scrollbar Styling */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            border-radius: 3px;
            background: #64748b;
        }

        html.dark .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* Light Mode Overrides handled via classes mainly, but some utilities helper */
        html.light .bg-surface-dark {
            background-color: #ffffff;
        }

        html.light .bg-surface-darker {
            background-color: #f1f5f9;
        }

        html.light .border-border-dark {
            border-color: #e2e8f0;
        }

        html.light .text-text-muted {
            color: #64748b;
        }

        html.light .bg-background-dark {
            background-color: #f8fafc;
        }

        /* Smooth theme transition */
        .bg-surface-dark,
        .bg-surface-darker,
        .border-border-dark,
        .bg-background-dark,
        body {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* Touch Targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
    </style>
</head>

<body
    class="font-display antialiased h-screen flex flex-col bg-background-dark dark:bg-background-dark text-text-dark dark:text-white transition-colors duration-300">

    <!-- Header -->
    <header
        class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button onclick="window.parent.postMessage({action: 'navigate', target: 'dashboard'}, '*')"
                class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-lg text-text-muted transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div>
                <h1 class="text-xl font-black tracking-tight">Content Moderation</h1>
                <p class="text-xs text-text-muted">Review and approve user-generated content</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()"
                class="touch-target flex items-center justify-center w-10 h-10 rounded-lg bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                title="Toggle theme">
                <span id="themeIconSun"
                    class="material-symbols-outlined text-[20px] text-amber-400 hidden">light_mode</span>
                <span id="themeIconMoon" class="material-symbols-outlined text-[20px] text-slate-400">dark_mode</span>
            </button>

            <button onclick="loadQueue()"
                class="touch-target flex items-center justify-center w-10 h-10 rounded-lg bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-slate-100 dark:hover:bg-slate-700 text-primary transition-colors">
                <span class="material-symbols-outlined">refresh</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Sidebar / Filters -->
        <aside class="w-64 border-r border-border-dark bg-surface-darker flex flex-col hidden md:flex">
            <nav class="p-4 space-y-2">
                <button onclick="setFilter('all')" id="nav-all"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-lg bg-surface-dark dark:bg-surface-dark text-text-dark dark:text-white font-medium border border-transparent shadow-sm">
                    <span class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px]">inbox</span>
                        All Pending
                    </span>
                    <span id="count-all"
                        class="bg-primary text-white px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </button>
                <div class="h-px bg-border-dark my-2 opacity-50"></div>
                <button onclick="setFilter('reviews')" id="nav-reviews"
                    class="w-full flex items-center justify-between px-4 py-2 rounded-lg text-text-muted hover:bg-surface-dark hover:text-text-dark dark:hover:text-white transition-colors">
                    <span class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px]">star</span>
                        Reviews
                    </span>
                </button>
                <button onclick="setFilter('jobs')" id="nav-jobs"
                    class="w-full flex items-center justify-between px-4 py-2 rounded-lg text-text-muted hover:bg-surface-dark hover:text-text-dark dark:hover:text-white transition-colors">
                    <span class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px]">work</span>
                        Job Postings
                    </span>
                </button>
                <button onclick="setFilter('documents')" id="nav-documents"
                    class="w-full flex items-center justify-between px-4 py-2 rounded-lg text-text-muted hover:bg-surface-dark hover:text-text-dark dark:hover:text-white transition-colors">
                    <span class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px]">description</span>
                        Documents
                    </span>
                </button>
            </nav>
        </aside>

        <!-- Queue List -->
        <main class="flex-1 overflow-y-auto scrollbar-thin bg-background-dark p-4 md:p-6">

            <!-- Mobile Filter Tabs -->
            <div class="md:hidden flex gap-2 overflow-x-auto pb-4 mb-2 scrollbar-hide">
                <button onclick="setFilter('all')"
                    class="bg-primary text-white whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium">All</button>
                <button onclick="setFilter('reviews')"
                    class="bg-surface-dark border border-border-dark text-text-muted whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium">Reviews</button>
                <button onclick="setFilter('jobs')"
                    class="bg-surface-dark border border-border-dark text-text-muted whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium">Jobs</button>
                <button onclick="setFilter('documents')"
                    class="bg-surface-dark border border-border-dark text-text-muted whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium">Documents</button>
            </div>

            <div id="queue-container" class="space-y-4 max-w-4xl mx-auto">
                <!-- Loading State -->
                <div class="text-center py-12 text-text-muted">
                    <span class="material-symbols-outlined text-4xl animate-spin mb-2 text-primary">sync</span>
                    <p>Loading pending items...</p>
                </div>
            </div>

        </main>

    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 z-50 bg-black/90 hidden items-center justify-center p-4 backdrop-blur-sm">
        <button onclick="closeImageModal()"
            class="absolute top-4 right-4 text-white p-2 hover:bg-white/10 rounded-full transition-colors">
            <span class="material-symbols-outlined text-3xl">close</span>
        </button>
        <img id="modalImage" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl">
    </div>

    <script>
        // ============================================
        // STATE & INIT
        // ============================================
        let currentFilter = 'all';
        let queueData = [];
        const THEME_KEY = 'lmdr-admin-theme';

        window.addEventListener('message', handleMessage);

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            // In a real scenario, this would wait for a handshake
            // but for simple Velo implementation we request immediately
            sendToVelo({ action: 'getModerationQueue' });
        });

        function sendToVelo(msg) {
            window.parent.postMessage(msg, '*');
        }

        function loadQueue() {
            sendToVelo({ action: 'getModerationQueue' });
        }

        // ============================================
        // THEME LOGIC (Shared with Dashboard)
        // ============================================
        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            // Default to dark if no pref, per brand dashboard default
            const theme = saved || (prefersDark ? 'dark' : 'dark');
            applyTheme(theme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            const sun = document.getElementById('themeIconSun');
            const moon = document.getElementById('themeIconMoon');

            if (theme === 'dark') {
                html.classList.add('dark');
                html.classList.remove('light');
                sun.classList.remove('hidden');
                moon.classList.add('hidden');
            } else {
                html.classList.remove('dark');
                html.classList.add('light');
                sun.classList.add('hidden');
                moon.classList.remove('hidden');
            }
        }

        function toggleTheme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        }

        // ============================================
        // LOGIC
        // ============================================
        function handleMessage(event) {
            const { action, payload } = event.data;
            if (action === 'moderationQueueLoaded') {
                queueData = payload.items || [];
                renderQueue();
                updateCounts(payload.total);
            } else if (action === 'actionSuccess') {
                // Remove item from queue
                if (payload && payload.id) {
                    queueData = queueData.filter(i => i.id !== payload.id);
                }
                renderQueue();
                updateCounts(queueData.length);
            }
        }

        function setFilter(filter) {
            currentFilter = filter;

            // Update active state in sidebar
            document.querySelectorAll('nav button').forEach(btn => {
                const isActive = btn.id === `nav-${filter}`;
                if (isActive) {
                    btn.className = "w-full flex items-center justify-between px-4 py-3 rounded-lg bg-surface-dark dark:bg-surface-dark text-text-dark dark:text-white font-medium border border-border-light dark:border-border-dark shadow-sm";
                    btn.querySelector('.bg-primary')?.classList.remove('hidden');
                } else {
                    btn.className = "w-full flex items-center justify-between px-4 py-2 rounded-lg text-text-muted hover:bg-surface-dark hover:text-text-dark dark:hover:text-white transition-colors";
                }
            });

            // Update active state in mobile tabs
            // (Simple implementation: refresh rendering handles content only)

            renderQueue();
        }

        function updateCounts(total) {
            const badge = document.getElementById('count-all');
            if (badge) badge.textContent = total || 0;
        }

        function renderQueue() {
            const container = document.getElementById('queue-container');
            const filtered = currentFilter === 'all'
                ? queueData
                : queueData.filter(i => i.type === currentFilter || (currentFilter === 'documents' && i.type === 'document'));

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 border-2 border-dashed border-border-dark rounded-xl">
                        <div class="w-16 h-16 bg-surface-dark rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-4xl text-emerald-500">check_circle</span>
                        </div>
                        <h3 class="text-lg font-bold">All caught up!</h3>
                        <p class="text-text-muted">No pending items in this queue.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => createCard(item)).join('');
        }

        function createCard(item) {
            if (item.type === 'review') return createReviewCard(item);
            if (item.type === 'job') return createJobCard(item);
            if (item.type === 'document') return createDocumentCard(item);
            return '';
        }

        // --- Card Templates (Using Brand Colors) ---

        function createReviewCard(item) {
            return `
                <div class="bg-surface-dark border border-border-dark rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-accent/10 text-accent flex items-center justify-center border border-accent/20">
                                <span class="material-symbols-outlined text-2xl">star</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">Review for ${item.title}</h3>
                                <p class="text-sm text-text-muted mt-0.5">By ${item.subtitle} • ${formatDate(item.timestamp)}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded bg-surface-darker text-xs text-text-muted font-mono border border-border-dark">ID: ${item.id.slice(0, 6)}</span>
                    </div>
                    
                    <div class="bg-surface-darker p-4 rounded-lg mb-5 text-sm leading-relaxed border border-border-dark italic text-text-muted">
                        "${item.data.content || 'No content provided'}"
                        <div class="mt-3 flex gap-1">
                             ${renderStars(item.data.rating || 0)}
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 border-t border-border-dark pt-4">
                        <button onclick="handleAction('reject', '${item.id}', 'review')" class="px-5 py-2.5 rounded-lg border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-bold transition-all">Reject</button>
                        <button onclick="handleAction('approve', '${item.id}', 'review')" class="px-5 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold shadow-lg shadow-emerald-600/20 transition-all">Approve Review</button>
                    </div>
                </div>
            `;
        }

        function createJobCard(item) {
            return `
                <div class="bg-surface-dark border border-border-dark rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-blue-600/10 text-blue-600 flex items-center justify-center border border-blue-600/20">
                                <span class="material-symbols-outlined text-2xl">work</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">${item.title}</h3>
                                <p class="text-sm text-text-muted mt-0.5">${item.subtitle} • ${formatDate(item.timestamp)}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded bg-surface-darker text-xs text-text-muted font-mono border border-border-dark">ID: ${item.id.slice(0, 6)}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-5 text-sm">
                        <div class="bg-surface-darker p-3 rounded border border-border-dark">
                            <span class="text-text-muted block text-xs mb-1 uppercase tracking-wider font-bold">Pay Range</span>
                            <span class="font-medium">${item.data.pay_range || 'Not specified'}</span>
                        </div>
                        <div class="bg-surface-darker p-3 rounded border border-border-dark">
                            <span class="text-text-muted block text-xs mb-1 uppercase tracking-wider font-bold">Experience</span>
                            <span class="font-medium">${item.data.experience_required || 'Not specified'}</span>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 border-t border-border-dark pt-4">
                        <button onclick="handleAction('reject', '${item.id}', 'job')" class="px-5 py-2.5 rounded-lg border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-bold transition-all">Reject</button>
                        <button onclick="handleAction('approve', '${item.id}', 'job')" class="px-5 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold shadow-lg shadow-emerald-600/20 transition-all">Approve Post</button>
                    </div>
                </div>
            `;
        }

        function createDocumentCard(item) {
            return `
                <div class="bg-surface-dark border border-border-dark rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-violet-600/10 text-violet-600 flex items-center justify-center border border-violet-600/20">
                                <span class="material-symbols-outlined text-2xl">description</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">${item.title} Verification</h3>
                                <p class="text-sm text-text-muted mt-0.5">Driver: ${item.subtitle} • ${formatDate(item.timestamp)}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded bg-surface-darker text-xs text-text-muted font-mono border border-border-dark">ID: ${item.id.slice(0, 6)}</span>
                    </div>

                    <div class="mb-5">
                        <div class="h-56 bg-surface-darker rounded-lg flex items-center justify-center overflow-hidden border border-border-dark relative group">
                            <img src="${item.data}" class="max-h-full max-w-full object-contain">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-sm">
                                <button onclick="openImageModal('${item.data}')" class="px-5 py-2.5 bg-white text-slate-900 rounded-full font-bold shadow-xl hover:scale-105 transition-transform flex items-center gap-2">
                                    <span class="material-symbols-outlined">zoom_in</span> View Fullscreen
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 border-t border-border-dark pt-4">
                         <button onclick="handleAction('reject', '${item.id}', 'document', '${item.subtype}')" class="px-5 py-2.5 rounded-lg border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-bold transition-all">Reject</button>
                        <button onclick="handleAction('approve', '${item.id}', 'document', '${item.subtype}')" class="px-5 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold shadow-lg shadow-emerald-600/20 transition-all">Verify Document</button>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ACTIONS & UTILS
        // ============================================

        function handleAction(action, id, type, subtype = null) {
            let reason = null;
            if (action === 'reject') {
                reason = prompt("Reason for rejection:");
                if (reason === null) return; // Cancelled
            }

            sendToVelo({
                action: 'performModeration',
                payload: {
                    id, type, subtype,
                    status: action === 'approve' ? (type === 'document' ? 'verified' : 'approved') : 'rejected',
                    reason
                }
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function renderStars(rating) {
            return Array(5).fill(0).map((_, i) =>
                `<span class="material-symbols-outlined text-[18px] ${i < rating ? 'text-accent fill-current' : 'text-slate-600'}">star</span>`
            ).join('');
        }

        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = src;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('modalImage').src = '';
        }
    </script>
</body>

</html>