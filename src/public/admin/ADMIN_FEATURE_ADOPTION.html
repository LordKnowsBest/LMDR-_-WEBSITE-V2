<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>VelocityMatch | Feature Adoption Dashboard</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <!-- Tailwind CDN + INLINE config -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'lmdr-blue': '#2563eb', 'lmdr-deep': '#1e40af',
                        'lmdr-yellow': '#fbbf24', 'lmdr-dark': '#0f172a',
                        'beige': '#F5F5DC', 'beige-d': '#E8E0C8',
                        'tan': '#C8B896', 'ivory': '#FFFFF5', 'sg': '#859900'
                    },
                    fontFamily: { 'd': ['Inter', 'sans-serif'] }
                }
            }
        };
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- External CSS via CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/css/admin-feature-adoption.css"/>
</head>
<body class="font-sans antialiased">
    <div class="min-h-screen p-4 md:p-6 space-y-6">

        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-lmdr-blue">analytics</span>
                    Feature Adoption Dashboard
                </h1>
                <p class="text-sm text-slate-400 mt-1">Track feature health, adoption trends, and lifecycle status</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex bg-slate-800 rounded-lg p-1 text-sm">
                    <button onclick="setTimeRange('7d')" id="tr7d" class="px-3 py-1.5 rounded-md transition-colors text-slate-400 hover:text-white">7d</button>
                    <button onclick="setTimeRange('30d')" id="tr30d" class="px-3 py-1.5 rounded-md bg-lmdr-blue text-white">30d</button>
                    <button onclick="setTimeRange('90d')" id="tr90d" class="px-3 py-1.5 rounded-md transition-colors text-slate-400 hover:text-white">90d</button>
                </div>
                <button onclick="refreshAll()" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors" title="Refresh">
                    <span class="material-symbols-outlined text-slate-400" id="refreshIcon">refresh</span>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="summaryCards">
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Total Features</div>
                <div class="text-2xl font-bold text-white mt-1" id="totalFeatures">--</div>
                <div class="text-xs text-slate-500 mt-1" id="totalFeaturesDetail">Loading...</div>
            </div>
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Healthy</div>
                <div class="text-2xl font-bold text-emerald-400 mt-1" id="healthyCount">--</div>
                <div class="text-xs text-slate-500 mt-1">Score 70+</div>
            </div>
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Warning</div>
                <div class="text-2xl font-bold text-amber-400 mt-1" id="warningCount">--</div>
                <div class="text-xs text-slate-500 mt-1">Score 40-69</div>
            </div>
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Critical</div>
                <div class="text-2xl font-bold text-red-400 mt-1" id="criticalCount">--</div>
                <div class="text-xs text-slate-500 mt-1">Score &lt; 40</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="overflow-x-auto pb-1 mb-6">
            <div class="flex gap-6 border-b border-slate-700 text-sm font-medium min-w-max">
                <button onclick="switchTab('overview')" id="tabOverview" class="pb-3 tab-active">Overview</button>
                <button onclick="switchTab('registry')" id="tabRegistry" class="pb-3 tab-inactive">Feature Registry</button>
                <button onclick="switchTab('funnels')" id="tabFunnels" class="pb-3 tab-inactive">Funnels</button>
                <button onclick="switchTab('atrisk')" id="tabAtRisk" class="pb-3 tab-inactive">At-Risk</button>
            </div>
        </div>

        <!-- Tab: Overview -->
        <div id="panelOverview" class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-4">
                    <h3 class="text-sm font-semibold text-white mb-3">Lifecycle Distribution</h3>
                    <div class="h-64"><canvas id="lifecycleChart"></canvas></div>
                </div>
                <div class="card p-4">
                    <h3 class="text-sm font-semibold text-white mb-3">Health Score Distribution</h3>
                    <div class="h-64"><canvas id="healthDistChart"></canvas></div>
                </div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-white">Feature Health Grid</h3>
                    <select id="sortBy" onchange="sortFeatures()" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1 text-slate-300">
                        <option value="health-asc">Health: Low to High</option>
                        <option value="health-desc">Health: High to Low</option>
                        <option value="users-desc">Users: Most</option>
                        <option value="name-asc">Name: A-Z</option>
                    </select>
                </div>
                <div id="healthGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 max-h-[500px] overflow-y-auto scrollbar-thin pr-1">
                    <div class="card p-4 skeleton h-32"></div>
                    <div class="card p-4 skeleton h-32"></div>
                    <div class="card p-4 skeleton h-32"></div>
                    <div class="card p-4 skeleton h-32"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Feature Registry -->
        <div id="panelRegistry" class="hidden space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <input type="text" id="registrySearch" placeholder="Search features..." oninput="filterRegistry()"
                        class="text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-300 placeholder:text-slate-500 w-64"/>
                    <select id="registryStatusFilter" onchange="filterRegistry()" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-slate-300">
                        <option value="all">All Statuses</option>
                        <option value="beta">Beta</option>
                        <option value="active">Active</option>
                        <option value="deprecated">Deprecated</option>
                        <option value="sunset">Sunset</option>
                    </select>
                </div>
                <button onclick="showRegisterModal()" class="text-xs bg-lmdr-blue hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">add</span> Register Feature
                </button>
            </div>
            <div class="card overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-slate-700 text-left text-slate-400 text-xs uppercase">
                            <th class="p-3">Feature</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Category</th>
                            <th class="p-3">Health</th>
                            <th class="p-3">Users (30d)</th>
                            <th class="p-3">Trend</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="registryTableBody">
                        <tr><td colspan="7" class="p-6 text-center text-slate-500">Loading features...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Funnels -->
        <div id="panelFunnels" class="hidden space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-white">Conversion Funnels</h3>
                <select id="funnelSelector" onchange="loadFunnelData()" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-slate-300">
                    <option value="">Select a funnel...</option>
                </select>
            </div>
            <div id="funnelContent" class="card p-6">
                <div class="text-center text-slate-500 py-8">
                    <span class="material-symbols-outlined text-4xl mb-2">filter_alt</span>
                    <p>Select a funnel to view conversion data</p>
                </div>
            </div>
        </div>

        <!-- Tab: At-Risk -->
        <div id="panelAtRisk" class="hidden space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-red-400">warning</span>
                <h3 class="text-sm font-semibold text-white">At-Risk Features</h3>
                <span class="text-xs text-slate-500">Features that need attention</span>
            </div>
            <div id="atRiskList" class="space-y-3">
                <div class="card p-4 skeleton h-24"></div>
                <div class="card p-4 skeleton h-24"></div>
            </div>
        </div>

        <!-- Feature Detail Panel (slide-down) -->
        <div id="featureDetailPanel" class="detail-panel card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white" id="detailFeatureName">Feature Details</h3>
                <button onclick="closeDetailPanel()" class="text-slate-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <div class="text-xs text-slate-400">Health Score</div>
                    <div class="text-3xl font-bold mt-1" id="detailHealthScore">--</div>
                    <div class="health-bar mt-2"><div class="health-bar-fill" id="detailHealthBar" style="width:0%"></div></div>
                </div>
                <div>
                    <div class="text-xs text-slate-400">Health Breakdown</div>
                    <div class="mt-2 space-y-1 text-xs" id="detailBreakdown">--</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400">Recommendation</div>
                    <div class="mt-2 text-sm text-slate-300" id="detailRecommendation">--</div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center" id="detailStats">
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Unique Users</div>
                    <div class="text-lg font-bold text-white" id="detailUsers">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Completion Rate</div>
                    <div class="text-lg font-bold text-emerald-400" id="detailCompletion">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Error Rate</div>
                    <div class="text-lg font-bold text-red-400" id="detailErrorRate">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Avg Duration</div>
                    <div class="text-lg font-bold text-blue-400" id="detailDuration">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Abandon Rate</div>
                    <div class="text-lg font-bold text-amber-400" id="detailAbandon">--</div>
                </div>
            </div>
        </div>

        <!-- Register Feature Modal -->
        <div id="registerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="card p-6 w-full max-w-md space-y-4">
                <h3 class="text-lg font-bold text-white">Register New Feature</h3>
                <div>
                    <label class="text-xs text-slate-400">Feature ID</label>
                    <input id="regFeatureId" type="text" placeholder="e.g. carrier_search" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white"/>
                </div>
                <div>
                    <label class="text-xs text-slate-400">Display Name</label>
                    <input id="regDisplayName" type="text" placeholder="e.g. Carrier Search" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white"/>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400">Category</label>
                        <select id="regCategory" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="driver">Driver</option>
                            <option value="recruiter">Recruiter</option>
                            <option value="carrier">Carrier</option>
                            <option value="admin">Admin</option>
                            <option value="platform">Platform</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Status</label>
                        <select id="regStatus" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="beta">Beta</option>
                            <option value="active" selected>Active</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400">Expected Monthly Users</label>
                    <input id="regExpectedUsers" type="number" value="50" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white"/>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="closeRegisterModal()" class="text-sm text-slate-400 hover:text-white px-4 py-2">Cancel</button>
                    <button onclick="submitRegisterFeature()" class="text-sm bg-lmdr-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Register</button>
                </div>
                <div id="regError" class="text-xs text-red-400 hidden"></div>
            </div>
        </div>
    </div>

    <!-- Module Loading (ordered by dependency) -->
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-feature-adoption-config.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-feature-adoption-bridge.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-feature-adoption-render.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-feature-adoption-logic.js"></script>

    <!-- Bootstrap -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            FeatureAdoptionLogic.exposeGlobals();
            FeatureAdoptionLogic.init();
        });
    </script>
</body>
</html>
