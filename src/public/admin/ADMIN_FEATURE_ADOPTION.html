<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Feature Adoption Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                colors: {
                    lmdr: {
                        dark: '#0f172a',
                        blue: '#2563eb',
                        yellow: '#fbbf24',
                        canvas: '#f8fafc',
                    }
                }
            }
        }
    }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; background: #0f172a; color: #e2e8f0; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .health-bar { height: 6px; border-radius: 3px; background: #1e293b; overflow: hidden; }
        .health-bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #60a5fa; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
        .tab-inactive:hover { color: #cbd5e1; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .card:hover { border-color: #475569; }
        .funnel-step { position: relative; }
        .funnel-step::after {
            content: '';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-left-color: #475569;
        }
        .funnel-step:last-child::after { display: none; }
        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .detail-panel { transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 0; opacity: 0; overflow: hidden; }
        .detail-panel.open { max-height: 600px; opacity: 1; }
    </style>
</head>

<body class="font-sans antialiased">
    <div class="min-h-screen p-4 md:p-6 space-y-6">

        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-lmdr-blue">analytics</span>
                    Feature Adoption Dashboard
                </h1>
                <p class="text-sm text-slate-400 mt-1">Track feature health, adoption trends, and lifecycle status</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex bg-slate-800 rounded-lg p-1 text-sm">
                    <button onclick="setTimeRange('7d')" id="tr7d" class="px-3 py-1.5 rounded-md transition-colors text-slate-400 hover:text-white">7d</button>
                    <button onclick="setTimeRange('30d')" id="tr30d" class="px-3 py-1.5 rounded-md bg-lmdr-blue text-white">30d</button>
                    <button onclick="setTimeRange('90d')" id="tr90d" class="px-3 py-1.5 rounded-md transition-colors text-slate-400 hover:text-white">90d</button>
                </div>
                <button onclick="refreshAll()" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors" title="Refresh">
                    <span class="material-symbols-outlined text-slate-400" id="refreshIcon">refresh</span>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="summaryCards">
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Total Features</div>
                <div class="text-2xl font-bold text-white mt-1" id="totalFeatures">--</div>
                <div class="text-xs text-slate-500 mt-1" id="totalFeaturesDetail">Loading...</div>
            </div>
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Healthy</div>
                <div class="text-2xl font-bold text-emerald-400 mt-1" id="healthyCount">--</div>
                <div class="text-xs text-slate-500 mt-1">Score 70+</div>
            </div>
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Warning</div>
                <div class="text-2xl font-bold text-amber-400 mt-1" id="warningCount">--</div>
                <div class="text-xs text-slate-500 mt-1">Score 40-69</div>
            </div>
            <div class="card p-4">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Critical</div>
                <div class="text-2xl font-bold text-red-400 mt-1" id="criticalCount">--</div>
                <div class="text-xs text-slate-500 mt-1">Score &lt; 40</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-6 border-b border-slate-700 text-sm font-medium">
            <button onclick="switchTab('overview')" id="tabOverview" class="pb-3 tab-active">Overview</button>
            <button onclick="switchTab('registry')" id="tabRegistry" class="pb-3 tab-inactive">Feature Registry</button>
            <button onclick="switchTab('funnels')" id="tabFunnels" class="pb-3 tab-inactive">Funnels</button>
            <button onclick="switchTab('atrisk')" id="tabAtRisk" class="pb-3 tab-inactive">At-Risk</button>
        </div>

        <!-- Tab: Overview -->
        <div id="panelOverview" class="space-y-6">
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-4">
                    <h3 class="text-sm font-semibold text-white mb-3">Lifecycle Distribution</h3>
                    <div class="h-64"><canvas id="lifecycleChart"></canvas></div>
                </div>
                <div class="card p-4">
                    <h3 class="text-sm font-semibold text-white mb-3">Health Score Distribution</h3>
                    <div class="h-64"><canvas id="healthDistChart"></canvas></div>
                </div>
            </div>

            <!-- Health Grid -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-white">Feature Health Grid</h3>
                    <select id="sortBy" onchange="sortFeatures()" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1 text-slate-300">
                        <option value="health-asc">Health: Low to High</option>
                        <option value="health-desc">Health: High to Low</option>
                        <option value="users-desc">Users: Most</option>
                        <option value="name-asc">Name: A-Z</option>
                    </select>
                </div>
                <div id="healthGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 max-h-[500px] overflow-y-auto scrollbar-thin pr-1">
                    <div class="card p-4 skeleton h-32"></div>
                    <div class="card p-4 skeleton h-32"></div>
                    <div class="card p-4 skeleton h-32"></div>
                    <div class="card p-4 skeleton h-32"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Feature Registry -->
        <div id="panelRegistry" class="hidden space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <input type="text" id="registrySearch" placeholder="Search features..." oninput="filterRegistry()"
                        class="text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-300 placeholder:text-slate-500 w-64" />
                    <select id="registryStatusFilter" onchange="filterRegistry()" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-slate-300">
                        <option value="all">All Statuses</option>
                        <option value="beta">Beta</option>
                        <option value="active">Active</option>
                        <option value="deprecated">Deprecated</option>
                        <option value="sunset">Sunset</option>
                    </select>
                </div>
                <button onclick="showRegisterModal()" class="text-xs bg-lmdr-blue hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">add</span> Register Feature
                </button>
            </div>
            <div class="card overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-slate-700 text-left text-slate-400 text-xs uppercase">
                            <th class="p-3">Feature</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Category</th>
                            <th class="p-3">Health</th>
                            <th class="p-3">Users (30d)</th>
                            <th class="p-3">Trend</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="registryTableBody">
                        <tr><td colspan="7" class="p-6 text-center text-slate-500">Loading features...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Funnels -->
        <div id="panelFunnels" class="hidden space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-white">Conversion Funnels</h3>
                <select id="funnelSelector" onchange="loadFunnelData()" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-slate-300">
                    <option value="">Select a funnel...</option>
                </select>
            </div>
            <div id="funnelContent" class="card p-6">
                <div class="text-center text-slate-500 py-8">
                    <span class="material-symbols-outlined text-4xl mb-2">filter_alt</span>
                    <p>Select a funnel to view conversion data</p>
                </div>
            </div>
        </div>

        <!-- Tab: At-Risk -->
        <div id="panelAtRisk" class="hidden space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-red-400">warning</span>
                <h3 class="text-sm font-semibold text-white">At-Risk Features</h3>
                <span class="text-xs text-slate-500">Features that need attention</span>
            </div>
            <div id="atRiskList" class="space-y-3">
                <div class="card p-4 skeleton h-24"></div>
                <div class="card p-4 skeleton h-24"></div>
            </div>
        </div>

        <!-- Feature Detail Panel (slide-down) -->
        <div id="featureDetailPanel" class="detail-panel card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white" id="detailFeatureName">Feature Details</h3>
                <button onclick="closeDetailPanel()" class="text-slate-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <div class="text-xs text-slate-400">Health Score</div>
                    <div class="text-3xl font-bold mt-1" id="detailHealthScore">--</div>
                    <div class="health-bar mt-2"><div class="health-bar-fill" id="detailHealthBar" style="width:0%"></div></div>
                </div>
                <div>
                    <div class="text-xs text-slate-400">Health Breakdown</div>
                    <div class="mt-2 space-y-1 text-xs" id="detailBreakdown">--</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400">Recommendation</div>
                    <div class="mt-2 text-sm text-slate-300" id="detailRecommendation">--</div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center" id="detailStats">
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Unique Users</div>
                    <div class="text-lg font-bold text-white" id="detailUsers">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Completion Rate</div>
                    <div class="text-lg font-bold text-emerald-400" id="detailCompletion">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Error Rate</div>
                    <div class="text-lg font-bold text-red-400" id="detailErrorRate">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Avg Duration</div>
                    <div class="text-lg font-bold text-blue-400" id="detailDuration">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="text-xs text-slate-400">Abandon Rate</div>
                    <div class="text-lg font-bold text-amber-400" id="detailAbandon">--</div>
                </div>
            </div>
        </div>

        <!-- Register Feature Modal -->
        <div id="registerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="card p-6 w-full max-w-md space-y-4">
                <h3 class="text-lg font-bold text-white">Register New Feature</h3>
                <div>
                    <label class="text-xs text-slate-400">Feature ID</label>
                    <input id="regFeatureId" type="text" placeholder="e.g. carrier_search" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                </div>
                <div>
                    <label class="text-xs text-slate-400">Display Name</label>
                    <input id="regDisplayName" type="text" placeholder="e.g. Carrier Search" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400">Category</label>
                        <select id="regCategory" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="driver">Driver</option>
                            <option value="recruiter">Recruiter</option>
                            <option value="carrier">Carrier</option>
                            <option value="admin">Admin</option>
                            <option value="platform">Platform</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Status</label>
                        <select id="regStatus" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="beta">Beta</option>
                            <option value="active" selected>Active</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400">Expected Monthly Users</label>
                    <input id="regExpectedUsers" type="number" value="50" class="w-full mt-1 text-sm bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="closeRegisterModal()" class="text-sm text-slate-400 hover:text-white px-4 py-2">Cancel</button>
                    <button onclick="submitRegisterFeature()" class="text-sm bg-lmdr-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Register</button>
                </div>
                <div id="regError" class="text-xs text-red-400 hidden"></div>
            </div>
        </div>
    </div>

    <script>
    // =========================================================================
    // STATE
    // =========================================================================
    let state = {
        features: [],
        funnels: [],
        atRiskFeatures: [],
        selectedTimeRange: '30d',
        selectedFeatureId: null,
        charts: {}
    };

    // =========================================================================
    // POSTMESSAGE BRIDGE
    // =========================================================================
    function sendToVelo(type, data = {}) {
        window.parent.postMessage({ type, data }, '*');
    }

    window.addEventListener('message', function(event) {
        const msg = event.data;
        if (!msg || !msg.type) return;

        switch (msg.type) {
            case 'featureLifecycleReportResult':
                handleLifecycleReport(msg.data);
                break;
            case 'featureStatsResult':
                handleFeatureStats(msg.data);
                break;
            case 'featureHealthScoreResult':
                handleHealthScore(msg.data);
                break;
            case 'atRiskFeaturesResult':
                handleAtRiskFeatures(msg.data);
                break;
            case 'funnelsListResult':
                handleFunnelsList(msg.data);
                break;
            case 'funnelConversionResult':
                handleFunnelConversion(msg.data);
                break;
            case 'registerFeatureResult':
                handleRegisterResult(msg.data);
                break;
            case 'updateFeatureStatusResult':
                handleStatusUpdateResult(msg.data);
                break;
        }
    });

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    function init() {
        sendToVelo('featureAdoptionReady');
        refreshAll();
    }

    function refreshAll() {
        const icon = document.getElementById('refreshIcon');
        icon.classList.add('animate-spin');
        setTimeout(() => icon.classList.remove('animate-spin'), 2000);

        sendToVelo('getFeatureLifecycleReport');
        sendToVelo('getAtRiskFeatures');
        sendToVelo('getFunnelsList');
    }

    // =========================================================================
    // TABS
    // =========================================================================
    function switchTab(tab) {
        const tabs = ['Overview', 'Registry', 'Funnels', 'AtRisk'];
        tabs.forEach(t => {
            const panel = document.getElementById('panel' + t);
            const tabBtn = document.getElementById('tab' + t);
            if (t.toLowerCase() === tab) {
                panel.classList.remove('hidden');
                tabBtn.className = 'pb-3 tab-active';
            } else {
                panel.classList.add('hidden');
                tabBtn.className = 'pb-3 tab-inactive';
            }
        });
    }

    // =========================================================================
    // TIME RANGE
    // =========================================================================
    function setTimeRange(range) {
        state.selectedTimeRange = range;
        ['7d', '30d', '90d'].forEach(r => {
            const btn = document.getElementById('tr' + r);
            if (r === range) {
                btn.className = 'px-3 py-1.5 rounded-md bg-lmdr-blue text-white';
            } else {
                btn.className = 'px-3 py-1.5 rounded-md transition-colors text-slate-400 hover:text-white';
            }
        });
        refreshAll();
    }

    // =========================================================================
    // LIFECYCLE REPORT HANDLER
    // =========================================================================
    function handleLifecycleReport(data) {
        if (!data || data.error) {
            console.warn('Lifecycle report error:', data?.error);
            return;
        }

        state.features = data.features || [];
        const summary = data.summary || {};

        // Update summary cards
        document.getElementById('totalFeatures').textContent = summary.total || 0;
        document.getElementById('totalFeaturesDetail').textContent =
            `${summary.byStatus?.active || 0} active, ${summary.byStatus?.beta || 0} beta`;
        document.getElementById('healthyCount').textContent = summary.byHealth?.healthy || 0;
        document.getElementById('warningCount').textContent = summary.byHealth?.warning || 0;
        document.getElementById('criticalCount').textContent = summary.byHealth?.critical || 0;

        // Render charts
        renderLifecycleChart(summary.byStatus || {});
        renderHealthDistChart(state.features);

        // Render health grid
        renderHealthGrid(state.features);

        // Render registry table
        renderRegistryTable(state.features);
    }

    // =========================================================================
    // CHARTS
    // =========================================================================
    function renderLifecycleChart(byStatus) {
        const ctx = document.getElementById('lifecycleChart');
        if (state.charts.lifecycle) state.charts.lifecycle.destroy();

        state.charts.lifecycle = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Beta', 'Deprecated', 'Sunset'],
                datasets: [{
                    data: [byStatus.active || 0, byStatus.beta || 0, byStatus.deprecated || 0, byStatus.sunset || 0],
                    backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 16, font: { size: 11 } } }
                },
                cutout: '65%'
            }
        });
    }

    function renderHealthDistChart(features) {
        const ctx = document.getElementById('healthDistChart');
        if (state.charts.healthDist) state.charts.healthDist.destroy();

        const buckets = { '0-19': 0, '20-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 };
        features.forEach(f => {
            const s = f.healthScore || 0;
            if (s < 20) buckets['0-19']++;
            else if (s < 40) buckets['20-39']++;
            else if (s < 60) buckets['40-59']++;
            else if (s < 80) buckets['60-79']++;
            else buckets['80-100']++;
        });

        state.charts.healthDist = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(buckets),
                datasets: [{
                    data: Object.values(buckets),
                    backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#22c55e', '#10b981'],
                    borderWidth: 0,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 11 } } },
                    y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', stepSize: 1, font: { size: 11 } } }
                }
            }
        });
    }

    // =========================================================================
    // HEALTH GRID
    // =========================================================================
    function renderHealthGrid(features) {
        const container = document.getElementById('healthGrid');
        if (!features.length) {
            container.innerHTML = '<div class="col-span-full text-center text-slate-500 py-8">No features registered yet</div>';
            return;
        }

        container.innerHTML = features.map(f => {
            const color = f.healthScore >= 70 ? 'emerald' : f.healthScore >= 40 ? 'amber' : 'red';
            const trendIcon = f.trend?.startsWith('+') ? 'trending_up' : f.trend?.startsWith('-') ? 'trending_down' : 'trending_flat';
            const trendColor = f.trend?.startsWith('+') ? 'text-emerald-400' : f.trend?.startsWith('-') ? 'text-red-400' : 'text-slate-400';
            const statusBadge = getStatusBadge(f.status);

            return `
            <div class="card p-4 cursor-pointer hover:bg-slate-800/50 transition-colors" onclick="showFeatureDetail('${f.featureId}')">
                <div class="flex items-start justify-between mb-2">
                    <div class="text-sm font-medium text-white truncate pr-2">${f.displayName || f.featureId}</div>
                    ${statusBadge}
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl font-bold text-${color}-400">${f.healthScore}</span>
                    <span class="material-symbols-outlined text-sm ${trendColor}">${trendIcon}</span>
                    <span class="text-xs ${trendColor}">${f.trend || '0%'}</span>
                </div>
                <div class="health-bar">
                    <div class="health-bar-fill bg-${color}-400" style="width:${f.healthScore}%"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-slate-500">
                    <span>${f.last30DaysUsers || 0} users</span>
                    <span>${f.category || 'uncategorized'}</span>
                </div>
            </div>`;
        }).join('');
    }

    function sortFeatures() {
        const sort = document.getElementById('sortBy').value;
        let sorted = [...state.features];
        switch (sort) {
            case 'health-asc': sorted.sort((a, b) => (a.healthScore || 0) - (b.healthScore || 0)); break;
            case 'health-desc': sorted.sort((a, b) => (b.healthScore || 0) - (a.healthScore || 0)); break;
            case 'users-desc': sorted.sort((a, b) => (b.last30DaysUsers || 0) - (a.last30DaysUsers || 0)); break;
            case 'name-asc': sorted.sort((a, b) => (a.displayName || a.featureId).localeCompare(b.displayName || b.featureId)); break;
        }
        renderHealthGrid(sorted);
    }

    // =========================================================================
    // REGISTRY TABLE
    // =========================================================================
    function renderRegistryTable(features) {
        const tbody = document.getElementById('registryTableBody');
        if (!features.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-slate-500">No features registered</td></tr>';
            return;
        }

        tbody.innerHTML = features.map(f => {
            const color = f.healthScore >= 70 ? 'emerald' : f.healthScore >= 40 ? 'amber' : 'red';
            const trendColor = f.trend?.startsWith('+') ? 'text-emerald-400' : f.trend?.startsWith('-') ? 'text-red-400' : 'text-slate-400';

            return `
            <tr class="border-b border-slate-800 hover:bg-slate-800/30 cursor-pointer" onclick="showFeatureDetail('${f.featureId}')">
                <td class="p-3">
                    <div class="font-medium text-white">${f.displayName || f.featureId}</div>
                    <div class="text-xs text-slate-500">${f.featureId}</div>
                </td>
                <td class="p-3">${getStatusBadge(f.status)}</td>
                <td class="p-3 text-slate-400">${f.category || '--'}</td>
                <td class="p-3">
                    <span class="font-bold text-${color}-400">${f.healthScore}</span>
                </td>
                <td class="p-3 text-slate-300">${f.last30DaysUsers || 0}</td>
                <td class="p-3 ${trendColor}">${f.trend || '0%'}</td>
                <td class="p-3">
                    <button onclick="event.stopPropagation(); changeFeatureStatus('${f.featureId}')" class="text-xs text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined text-sm">edit</span>
                    </button>
                </td>
            </tr>`;
        }).join('');
    }

    function filterRegistry() {
        const search = document.getElementById('registrySearch').value.toLowerCase();
        const status = document.getElementById('registryStatusFilter').value;
        let filtered = state.features;
        if (search) {
            filtered = filtered.filter(f =>
                (f.displayName || '').toLowerCase().includes(search) ||
                f.featureId.toLowerCase().includes(search)
            );
        }
        if (status !== 'all') {
            filtered = filtered.filter(f => f.status === status);
        }
        renderRegistryTable(filtered);
    }

    // =========================================================================
    // FEATURE DETAIL
    // =========================================================================
    function showFeatureDetail(featureId) {
        state.selectedFeatureId = featureId;
        const feature = state.features.find(f => f.featureId === featureId);
        if (!feature) return;

        document.getElementById('detailFeatureName').textContent = feature.displayName || feature.featureId;

        const score = feature.healthScore || 0;
        const color = score >= 70 ? '#22c55e' : score >= 40 ? '#f59e0b' : '#ef4444';
        document.getElementById('detailHealthScore').textContent = score;
        document.getElementById('detailHealthScore').style.color = color;

        const bar = document.getElementById('detailHealthBar');
        bar.style.width = score + '%';
        bar.style.backgroundColor = color;

        // Request detailed stats and health breakdown
        sendToVelo('getFeatureStats', { featureId, timeRange: state.selectedTimeRange });
        sendToVelo('getFeatureHealthScore', { featureId });

        const panel = document.getElementById('featureDetailPanel');
        panel.classList.add('open');
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function handleFeatureStats(data) {
        if (!data || data.error) return;
        const s = data.summary || data;
        document.getElementById('detailUsers').textContent = s.uniqueUsers || 0;
        document.getElementById('detailCompletion').textContent = (s.completionRate || 0) + '%';
        document.getElementById('detailErrorRate').textContent = (s.errorRate || 0) + '%';
        document.getElementById('detailDuration').textContent = formatDuration(s.avgDurationMs || 0);
        document.getElementById('detailAbandon').textContent = (s.abandonRate || 0) + '%';
    }

    function handleHealthScore(data) {
        if (!data || data.error) return;
        const bd = data.breakdown || {};
        const labels = {
            adoptionRate: 'Adoption',
            completionRate: 'Completion',
            errorRate: 'Error (inv)',
            retentionRate: 'Retention',
            engagementDepth: 'Engagement'
        };
        let html = '';
        for (const [key, label] of Object.entries(labels)) {
            const val = bd[key] || 0;
            const color = val >= 70 ? 'bg-emerald-400' : val >= 40 ? 'bg-amber-400' : 'bg-red-400';
            html += `<div class="flex items-center gap-2">
                <span class="w-20 text-slate-400">${label}</span>
                <div class="flex-1 health-bar"><div class="health-bar-fill ${color}" style="width:${val}%"></div></div>
                <span class="w-8 text-right text-slate-300">${val}</span>
            </div>`;
        }
        document.getElementById('detailBreakdown').innerHTML = html;
        document.getElementById('detailRecommendation').textContent = data.recommendation || '--';
    }

    function closeDetailPanel() {
        document.getElementById('featureDetailPanel').classList.remove('open');
        state.selectedFeatureId = null;
    }

    // =========================================================================
    // AT-RISK FEATURES
    // =========================================================================
    function handleAtRiskFeatures(data) {
        const list = document.getElementById('atRiskList');
        const features = Array.isArray(data) ? data : data?.features || [];
        state.atRiskFeatures = features;

        if (!features.length) {
            list.innerHTML = `<div class="card p-6 text-center">
                <span class="material-symbols-outlined text-4xl text-emerald-400 mb-2">check_circle</span>
                <p class="text-slate-300">No at-risk features detected</p>
                <p class="text-xs text-slate-500 mt-1">All features are performing within acceptable thresholds</p>
            </div>`;
            return;
        }

        list.innerHTML = features.map(f => {
            const riskFactors = f.riskFactors || [];
            return `
            <div class="card p-4 border-l-4 border-red-400 cursor-pointer hover:bg-slate-800/50" onclick="showFeatureDetail('${f.featureId}')">
                <div class="flex items-start justify-between">
                    <div>
                        <div class="font-medium text-white">${f.displayName || f.featureId}</div>
                        <div class="text-xs text-slate-500 mt-1">${f.recommendation || 'Needs investigation'}</div>
                    </div>
                    <span class="text-2xl font-bold text-red-400">${f.healthScore || 0}</span>
                </div>
                ${riskFactors.length ? `<div class="flex flex-wrap gap-1 mt-2">
                    ${riskFactors.map(r => `<span class="text-xs bg-red-900/30 text-red-300 px-2 py-0.5 rounded">${r}</span>`).join('')}
                </div>` : ''}
            </div>`;
        }).join('');
    }

    // =========================================================================
    // FUNNELS
    // =========================================================================
    function handleFunnelsList(data) {
        const funnels = Array.isArray(data) ? data : data?.funnels || [];
        state.funnels = funnels;

        const selector = document.getElementById('funnelSelector');
        selector.innerHTML = '<option value="">Select a funnel...</option>' +
            funnels.map(f => `<option value="${f.funnelId}">${f.displayName || f.funnelId}</option>`).join('');
    }

    function loadFunnelData() {
        const funnelId = document.getElementById('funnelSelector').value;
        if (!funnelId) return;

        document.getElementById('funnelContent').innerHTML =
            '<div class="text-center py-8 text-slate-500">Loading funnel data...</div>';

        const days = state.selectedTimeRange === '7d' ? 7 : state.selectedTimeRange === '90d' ? 90 : 30;
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - days);

        sendToVelo('getFunnelConversion', {
            funnelId,
            timeRange: { start: start.toISOString(), end: end.toISOString() }
        });
    }

    function handleFunnelConversion(data) {
        const container = document.getElementById('funnelContent');
        if (!data || data.error) {
            container.innerHTML = `<div class="text-center py-8 text-red-400">${data?.error || 'Failed to load funnel'}</div>`;
            return;
        }

        const steps = data.steps || [];
        const dropoff = data.dropoffAnalysis?.biggestDropoff;

        let html = `
        <div class="mb-4">
            <div class="text-sm text-white font-medium">${data.displayName || data.funnelId}</div>
            <div class="text-xs text-slate-500">${data.timeRange?.start || ''} to ${data.timeRange?.end || ''}</div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-slate-400">Total Entered</div>
                <div class="text-xl font-bold text-white">${data.totalEntered || 0}</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-slate-400">Overall Conversion</div>
                <div class="text-xl font-bold text-emerald-400">${data.overallConversionRate || 0}%</div>
            </div>
        </div>
        <div class="flex items-center gap-2 overflow-x-auto pb-4">`;

        steps.forEach((step, idx) => {
            const barHeight = Math.max(20, Math.round((step.completed / (steps[0]?.entered || 1)) * 100));
            const color = step.conversionRate >= 80 ? 'bg-emerald-500' : step.conversionRate >= 50 ? 'bg-amber-500' : 'bg-red-500';
            html += `
            <div class="funnel-step flex-shrink-0 text-center min-w-[120px]">
                <div class="text-xs text-slate-400 mb-1 truncate">${step.displayName || step.featureId}</div>
                <div class="mx-auto w-16 bg-slate-800 rounded-md overflow-hidden" style="height:100px">
                    <div class="${color} w-full rounded-md transition-all" style="height:${barHeight}%; margin-top:${100-barHeight}%"></div>
                </div>
                <div class="text-sm font-bold text-white mt-1">${step.completed}</div>
                <div class="text-xs text-slate-500">${step.conversionRate}%</div>
            </div>`;
        });

        html += '</div>';

        if (dropoff) {
            html += `
            <div class="mt-4 p-3 bg-red-900/20 border border-red-800/30 rounded-lg">
                <div class="flex items-center gap-2 text-sm text-red-300">
                    <span class="material-symbols-outlined text-sm">warning</span>
                    Biggest drop-off at step ${dropoff.step}: ${dropoff.lostUsers} users lost
                </div>
            </div>`;
        }

        container.innerHTML = html;
    }

    // =========================================================================
    // REGISTER FEATURE
    // =========================================================================
    function showRegisterModal() {
        document.getElementById('registerModal').classList.remove('hidden');
    }

    function closeRegisterModal() {
        document.getElementById('registerModal').classList.add('hidden');
        document.getElementById('regError').classList.add('hidden');
    }

    function submitRegisterFeature() {
        const featureId = document.getElementById('regFeatureId').value.trim();
        const displayName = document.getElementById('regDisplayName').value.trim();
        const category = document.getElementById('regCategory').value;
        const status = document.getElementById('regStatus').value;
        const expectedUsers = parseInt(document.getElementById('regExpectedUsers').value) || 50;

        if (!featureId || !displayName) {
            const err = document.getElementById('regError');
            err.textContent = 'Feature ID and Display Name are required';
            err.classList.remove('hidden');
            return;
        }

        sendToVelo('registerFeature', { featureData: { featureId, displayName, category, status, expectedUsers } });
    }

    function handleRegisterResult(data) {
        if (data?.success) {
            closeRegisterModal();
            refreshAll();
        } else {
            const err = document.getElementById('regError');
            err.textContent = data?.error || 'Registration failed';
            err.classList.remove('hidden');
        }
    }

    // =========================================================================
    // STATUS CHANGE
    // =========================================================================
    function changeFeatureStatus(featureId) {
        const feature = state.features.find(f => f.featureId === featureId);
        const currentStatus = feature?.status || 'active';
        const newStatus = prompt(`Change status for "${featureId}"\nCurrent: ${currentStatus}\nOptions: beta, active, deprecated, sunset`);
        if (!newStatus || !['beta', 'active', 'deprecated', 'sunset'].includes(newStatus)) return;
        sendToVelo('updateFeatureStatus', { featureId, status: newStatus, reason: 'Admin dashboard update' });
    }

    function handleStatusUpdateResult(data) {
        if (data?.success) {
            refreshAll();
        }
    }

    // =========================================================================
    // UTILITIES
    // =========================================================================
    function getStatusBadge(status) {
        const colors = {
            beta: 'bg-blue-900/40 text-blue-300',
            active: 'bg-emerald-900/40 text-emerald-300',
            deprecated: 'bg-amber-900/40 text-amber-300',
            sunset: 'bg-red-900/40 text-red-300'
        };
        return `<span class="text-xs px-2 py-0.5 rounded ${colors[status] || colors.active}">${status || 'active'}</span>`;
    }

    function formatDuration(ms) {
        if (!ms || ms === 0) return '0s';
        if (ms < 1000) return ms + 'ms';
        if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
        return (ms / 60000).toFixed(1) + 'm';
    }

    // Initialize
    init();
    </script>
</body>
</html>
