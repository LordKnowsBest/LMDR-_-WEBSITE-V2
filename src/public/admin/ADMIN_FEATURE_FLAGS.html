<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Admin - Feature Flags</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lmdr: {
                            dark: '#0f172a',
                            blue: '#2563eb',
                            yellow: '#fbbf24',
                            canvas: '#f8fafc',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .bg-background-dark { background-color: #0f172a; }
        .bg-surface-dark { background-color: #1e293b; }
        .bg-surface-darker { background-color: #0f172a; }
        .border-border-dark { border-color: #334155; }
        
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .modal-backdrop { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        
        /* Toggle Switch */
        .toggle-bg { background-color: #475569; transition: background-color 0.2s; }
        .toggle-dot { transform: translateX(0); transition: transform 0.2s; }
        input:checked + .toggle-bg { background-color: #2563eb; }
        input:checked + .toggle-bg .toggle-dot { transform: translateX(1.5rem); }
    </style>
</head>

<body class="font-display antialiased bg-background-dark text-white">

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <!-- Main Container -->
    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="LMDRBridge.navigateTo('admin-dashboard')" class="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div>
                        <h1 class="text-xl md:text-2xl font-black tracking-tight text-white">Feature Flags</h1>
                        <p class="text-xs md:text-sm text-slate-400 mt-0.5">Control feature rollouts and platform toggles</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openCreateModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg transition-colors shadow-lg shadow-blue-900/20">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                        <span class="hidden md:inline">Create Flag</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Filters Bar -->
        <div class="flex-shrink-0 bg-surface-dark border-b border-border-dark px-4 md:px-6 py-3">
            <div class="flex flex-col md:flex-row gap-3">
                <div class="relative flex-1">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">search</span>
                    <input type="text" id="flagSearch" oninput="filterFlags()" placeholder="Search by key or name..." 
                        class="w-full bg-surface-darker border-border-dark rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 text-white">
                </div>
                <div class="flex gap-2">
                    <select id="filterCategory" onchange="filterFlags()" class="bg-surface-darker border-border-dark rounded-lg text-sm py-2 pl-3 pr-10 focus:ring-blue-500 focus:border-blue-500 text-white">
                        <option value="all">All Categories</option>
                        <option value="ui">UI</option>
                        <option value="backend">Backend</option>
                        <option value="experiment">Experiment</option>
                        <option value="killswitch">Kill Switch</option>
                    </select>
                    <select id="filterEnv" onchange="filterFlags()" class="bg-surface-darker border-border-dark rounded-lg text-sm py-2 pl-3 pr-10 focus:ring-blue-500 focus:border-blue-500 text-white">
                        <option value="all">All Environments</option>
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                        <option value="development">Development</option>
                    </select>
                    <button onclick="refreshFlags()" class="p-2 bg-surface-darker border-border-dark border rounded-lg hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined text-[20px] text-slate-400">refresh</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="px-4 md:px-6 py-6">
                <!-- Flag Grid -->
                <div id="flagGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    <!-- Flags rendered here -->
                    <div class="col-span-full py-20 text-center">
                        <div class="inline-block w-8 h-8 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                        <p class="text-slate-400">Loading feature flags...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="flagModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-surface-dark border border-border-dark rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto pointer-events-auto shadow-2xl">
                <div class="sticky top-0 bg-surface-dark border-b border-border-dark px-6 py-4 flex items-center justify-between">
                    <h2 id="modalTitle" class="text-lg font-bold">Create Feature Flag</h2>
                    <button onclick="closeModal()" class="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <form id="flagForm" onsubmit="saveFlag(event)" class="p-6 space-y-6">
                    <input type="hidden" id="flagId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Flag Key (Unique)</label>
                            <input type="text" id="formKey" required placeholder="e.g. new_dashboard_v2" 
                                class="w-full bg-surface-darker border-border-dark rounded-lg px-4 py-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Display Name</label>
                            <input type="text" id="formName" required placeholder="e.g. New Dashboard UI"
                                class="w-full bg-surface-darker border-border-dark rounded-lg px-4 py-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Description</label>
                        <textarea id="formDescription" rows="2" placeholder="What does this flag control?"
                            class="w-full bg-surface-darker border-border-dark rounded-lg px-4 py-2.5 text-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Category</label>
                            <select id="formCategory" class="w-full bg-surface-darker border-border-dark rounded-lg px-4 py-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="ui">UI</option>
                                <option value="backend">Backend</option>
                                <option value="experiment">Experiment</option>
                                <option value="killswitch">Kill Switch</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Environment</label>
                            <select id="formEnv" class="w-full bg-surface-darker border-border-dark rounded-lg px-4 py-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="production">Production</option>
                                <option value="staging">Staging</option>
                                <option value="development">Development</option>
                            </select>
                        </div>
                    </div>

                    <div class="p-4 bg-surface-darker rounded-xl border border-border-dark space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm font-bold">Rollout Settings</h3>
                                <p class="text-xs text-slate-400">Master switch and global percentage</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="formEnabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs font-medium">
                                <span class="text-slate-400">Global Rollout Percentage</span>
                                <span id="rolloutValue" class="text-blue-400">0%</span>
                            </div>
                            <input type="range" id="formRollout" min="0" max="100" step="1" oninput="updateRolloutValue(this.value)"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>

                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold text-slate-400 uppercase">Default Value:</span>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="defaultValue" value="true" checked class="text-blue-600 bg-surface-darker border-border-dark focus:ring-blue-500">
                                <span class="text-xs">True</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="defaultValue" value="false" class="text-blue-600 bg-surface-darker border-border-dark focus:ring-blue-500">
                                <span class="text-xs">False</span>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-bold">Targeting Rules</h3>
                            <button type="button" onclick="addRule()" class="text-xs font-bold text-blue-400 hover:text-blue-300">
                                + Add Rule
                            </button>
                        </div>
                        <div id="rulesList" class="space-y-3">
                            <!-- Rules rendered here -->
                            <p class="text-center py-4 text-xs text-slate-500 italic border border-dashed border-border-dark rounded-lg">No custom targeting rules defined</p>
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-border-dark">
                        <button type="button" onclick="closeModal()" class="px-6 py-2.5 text-sm font-bold text-slate-400 hover:text-white transition-colors">Cancel</button>
                        <button type="submit" class="px-8 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg transition-colors shadow-lg shadow-blue-900/20">Save Flag</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Rule Template (Hidden) -->
    <template id="ruleTemplate">
        <div class="rule-item p-4 bg-surface-darker rounded-xl border border-border-dark space-y-3 relative group">
            <button type="button" onclick="this.closest('.rule-item').remove()" class="absolute top-2 right-2 p-1 text-slate-500 hover:text-rose-400 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="material-symbols-outlined text-[18px]">delete</span>
            </button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <input type="text" placeholder="Rule Name (e.g. Pro Users)" class="rule-name w-full bg-surface-dark border-border-dark rounded-lg px-3 py-1.5 text-xs focus:ring-blue-500 focus:border-blue-500">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-slate-500 uppercase font-bold">Rollout:</span>
                    <input type="number" min="0" max="100" value="100" class="rule-rollout w-16 bg-surface-dark border-border-dark rounded-lg px-2 py-1.5 text-xs focus:ring-blue-500 focus:border-blue-500">
                    <span class="text-xs text-slate-500">%</span>
                </div>
            </div>
            <div class="conditions-list space-y-2">
                <!-- Conditions here -->
            </div>
            <button type="button" onclick="addCondition(this)" class="text-[10px] font-bold text-blue-400 hover:text-blue-300">+ Add Condition</button>
        </div>
    </template>

    <!-- Condition Template (Hidden) -->
    <template id="conditionTemplate">
        <div class="condition-item flex flex-wrap md:flex-nowrap gap-2 items-center">
            <input type="text" placeholder="Attribute (e.g. user.role)" class="cond-attr flex-1 min-w-[120px] bg-surface-dark border-border-dark rounded-lg px-3 py-1.5 text-[11px] focus:ring-blue-500 focus:border-blue-500">
            <select class="cond-op bg-surface-dark border-border-dark rounded-lg px-2 py-1.5 text-[11px] focus:ring-blue-500 focus:border-blue-500">
                <option value="equals">Equals</option>
                <option value="not_equals">Not Equals</option>
                <option value="in">In</option>
                <option value="not_in">Not In</option>
                <option value="contains">Contains</option>
                <option value="greater_than">></option>
                <option value="less_than"><</option>
            </select>
            <input type="text" placeholder="Value" class="cond-val flex-1 min-w-[80px] bg-surface-dark border-border-dark rounded-lg px-3 py-1.5 text-[11px] focus:ring-blue-500 focus:border-blue-500">
            <button type="button" onclick="this.closest('.condition-item').remove()" class="p-1 text-slate-500 hover:text-rose-400">
                <span class="material-symbols-outlined text-[16px]">close</span>
            </button>
        </div>
    </template>

    <script src="../js/lmdr-html-bridge.js"></script>
    <script>
        let allFlags = [];
        let editingFlag = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            LMDRBridge.on('actionSuccess', (msg) => {
                showToast(msg, 'success');
                refreshFlags();
            });
            LMDRBridge.on('actionError', (msg) => showToast(msg, 'error'));
            LMDRBridge.on('flagsLoaded', (flags) => {
                allFlags = flags;
                renderFlags(flags);
            });

            // Initial load
            refreshFlags();
        });

        // ============================================
        // FLAG MANAGEMENT
        // ============================================
        function refreshFlags() {
            LMDRBridge.send('getAllFlags');
        }

        function renderFlags(flags) {
            const grid = document.getElementById('flagGrid');
            if (!flags || flags.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full py-20 text-center">
                        <span class="material-symbols-outlined text-4xl text-slate-600 mb-2">flag</span>
                        <p class="text-slate-400">No feature flags found</p>
                        <button onclick="openCreateModal()" class="mt-4 text-blue-400 font-bold hover:underline">Create your first flag</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = flags.map(flag => `
                <div class="bg-surface-dark border border-border-dark rounded-xl p-5 space-y-4 hover:border-slate-600 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${getCategoryColor(flag.category)}">${flag.category}</span>
                                <span class="text-xs text-slate-500 font-medium">${flag.environment}</span>
                            </div>
                            <h3 class="text-base font-bold truncate text-white" title="${flag.name}">${flag.name}</h3>
                            <code class="text-[10px] text-blue-400 bg-blue-400/10 px-1 rounded">${flag.key}</code>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${flag.enabled ? 'checked' : ''} onchange="toggleFlag('${flag.key}', this.checked)" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <p class="text-xs text-slate-400 line-clamp-2 h-8">${flag.description || 'No description provided'}</p>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold uppercase text-slate-500">
                            <span>Rollout</span>
                            <span class="text-blue-400">${flag.rolloutPercentage}%</span>
                        </div>
                        <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-600" style="width: ${flag.rolloutPercentage}%"></div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-2 border-t border-border-dark/50">
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-slate-500 font-bold uppercase">Rules</span>
                                <span class="text-xs font-medium">${(flag.targetRules || []).length}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[9px] text-slate-500 font-bold uppercase">Default</span>
                                <span class="text-xs font-medium text-slate-300">${flag.defaultValue ? 'True' : 'False'}</span>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editFlag('${flag.key}')" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-[20px]">edit</span>
                            </button>
                            <button onclick="confirmDelete('${flag.key}')" class="p-2 hover:bg-rose-900/30 rounded-lg text-slate-400 hover:text-rose-400 transition-colors">
                                <span class="material-symbols-outlined text-[20px]">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getCategoryColor(cat) {
            switch(cat) {
                case 'ui': return 'bg-violet-500/20 text-violet-400';
                case 'backend': return 'bg-blue-500/20 text-blue-400';
                case 'experiment': return 'bg-amber-500/20 text-amber-400';
                case 'killswitch': return 'bg-rose-500/20 text-rose-400';
                default: return 'bg-slate-500/20 text-slate-400';
            }
        }

        // ============================================
        // MODAL & FORM
        // ============================================
        function openCreateModal() {
            editingFlag = null;
            document.getElementById('modalTitle').textContent = 'Create Feature Flag';
            document.getElementById('flagForm').reset();
            document.getElementById('formKey').disabled = false;
            document.getElementById('flagId').value = '';
            document.getElementById('rolloutValue').textContent = '0%';
            document.getElementById('rulesList').innerHTML = '<p class="text-center py-4 text-xs text-slate-500 italic border border-dashed border-border-dark rounded-lg">No custom targeting rules defined</p>';
            
            document.getElementById('flagModal').classList.remove('hidden');
        }

        function editFlag(key) {
            const flag = allFlags.find(f => f.key === key);
            if (!flag) return;

            editingFlag = flag;
            document.getElementById('modalTitle').textContent = 'Edit Feature Flag';
            document.getElementById('formKey').value = flag.key;
            document.getElementById('formKey').disabled = true;
            document.getElementById('formName').value = flag.name || '';
            document.getElementById('formDescription').value = flag.description || '';
            document.getElementById('formCategory').value = flag.category || 'ui';
            document.getElementById('formEnv').value = flag.environment || 'production';
            document.getElementById('formEnabled').checked = !!flag.enabled;
            document.getElementById('formRollout').value = flag.rolloutPercentage || 0;
            updateRolloutValue(flag.rolloutPercentage || 0);
            
            const defaultValRadios = document.getElementsByName('defaultValue');
            defaultValRadios[0].checked = flag.defaultValue !== false;
            defaultValRadios[1].checked = flag.defaultValue === false;

            // Render rules
            renderRulesInForm(flag.targetRules || []);

            document.getElementById('flagModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('flagModal').classList.add('hidden');
        }

        function updateRolloutValue(val) {
            document.getElementById('rolloutValue').textContent = val + '%';
        }

        function renderRulesInForm(rules) {
            const container = document.getElementById('rulesList');
            if (rules.length === 0) {
                container.innerHTML = '<p class="text-center py-4 text-xs text-slate-500 italic border border-dashed border-border-dark rounded-lg">No custom targeting rules defined</p>';
                return;
            }

            container.innerHTML = '';
            rules.forEach(rule => {
                const ruleEl = addRule();
                ruleEl.querySelector('.rule-name').value = rule.name || '';
                ruleEl.querySelector('.rule-rollout').value = rule.percentage ?? 100;
                
                const condContainer = ruleEl.querySelector('.conditions-list');
                condContainer.innerHTML = '';
                (rule.conditions || []).forEach(cond => {
                    const condEl = addCondition(ruleEl.querySelector('button[onclick*="addCondition"]'));
                    condEl.querySelector('.cond-attr').value = cond.attribute || '';
                    condEl.querySelector('.cond-op').value = cond.operator || 'equals';
                    condEl.querySelector('.cond-val').value = cond.value || '';
                });
            });
        }

        function addRule() {
            const container = document.getElementById('rulesList');
            const placeholder = container.querySelector('p');
            if (placeholder) placeholder.remove();

            const template = document.getElementById('ruleTemplate');
            const clone = template.content.cloneNode(true);
            const ruleItem = clone.querySelector('.rule-item');
            container.appendChild(clone);
            return ruleItem;
        }

        function addCondition(btn) {
            const container = btn.previousElementSibling;
            const template = document.getElementById('conditionTemplate');
            const clone = template.content.cloneNode(true);
            const condItem = clone.querySelector('.condition-item');
            container.appendChild(clone);
            return condItem;
        }

        async function saveFlag(e) {
            e.preventDefault();
            
            const flagData = {
                key: document.getElementById('formKey').value,
                name: document.getElementById('formName').value,
                description: document.getElementById('formDescription').value,
                category: document.getElementById('formCategory').value,
                environment: document.getElementById('formEnv').value,
                enabled: document.getElementById('formEnabled').checked,
                rolloutPercentage: parseInt(document.getElementById('formRollout').value),
                defaultValue: document.querySelector('input[name="defaultValue"]:checked').value === 'true',
                targetRules: collectRules()
            };

            if (editingFlag) {
                LMDRBridge.send('updateFlag', { flagKey: flagData.key, updates: flagData });
            } else {
                LMDRBridge.send('createFlag', { flagData });
            }
            
            closeModal();
        }

        function collectRules() {
            const rules = [];
            const ruleItems = document.querySelectorAll('.rule-item');
            ruleItems.forEach(item => {
                const conditions = [];
                item.querySelectorAll('.condition-item').forEach(c => {
                    conditions.push({
                        attribute: c.querySelector('.cond-attr').value,
                        operator: c.querySelector('.cond-op').value,
                        value: c.querySelector('.cond-val').value
                    });
                });

                rules.push({
                    id: 'rule_' + Math.random().toString(36).substr(2, 9),
                    name: item.querySelector('.rule-name').value,
                    percentage: parseInt(item.querySelector('.rule-rollout').value),
                    enabled: true,
                    conditions: conditions
                });
            });
            return rules;
        }

        // ============================================
        // ACTIONS
        // ============================================
        function toggleFlag(key, enabled) {
            LMDRBridge.send('toggleFlag', { flagKey: key, enabled });
        }

        function confirmDelete(key) {
            if (confirm(`Are you sure you want to delete flag '${key}'? This cannot be undone.`)) {
                LMDRBridge.send('deleteFlag', { flagKey: key });
            }
        }

        function filterFlags() {
            const search = document.getElementById('flagSearch').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const env = document.getElementById('filterEnv').value;

            const filtered = allFlags.filter(f => {
                const matchesSearch = f.key.toLowerCase().includes(search) || (f.name && f.name.toLowerCase().includes(search));
                const matchesCategory = category === 'all' || f.category === category;
                const matchesEnv = env === 'all' || f.environment === env;
                return matchesSearch && matchesCategory && matchesEnv;
            });

            renderFlags(filtered);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-rose-600' : 'bg-blue-600';
            const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';

            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-lg ${bgColor} shadow-lg text-white`;
            toast.innerHTML = `
                <span class="material-symbols-outlined text-[20px]">${icon}</span>
                <span class="text-sm font-medium flex-1">${message}</span>
                <button onclick="document.getElementById('${id}').remove()" class="text-white/80 hover:text-white">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            `;
            container.appendChild(toast);
            setTimeout(() => { if (document.getElementById(id)) document.getElementById(id).remove(); }, 5000);
        }
    </script>
</body>
</html>
