<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Notification Rules</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="p-4 md:p-6">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-xl font-bold">Notification Rules</h1>
        <p class="text-xs text-slate-400">Configure event-driven notifications, throttling, and preview content.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="refreshRules()" class="px-3 py-2 text-sm rounded bg-slate-800 hover:bg-slate-700">Refresh</button>
        <button onclick="openCreate()" class="px-3 py-2 text-sm rounded bg-blue-600 hover:bg-blue-500">Create Rule</button>
      </div>
    </header>

    <div class="mb-4 flex gap-2">
      <input id="searchInput" oninput="renderRules()" placeholder="Search by name or event" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-800 text-sm">
      <select id="eventFilter" onchange="renderRules()" class="px-3 py-2 rounded bg-slate-900 border border-slate-800 text-sm">
        <option value="all">All events</option>
        <option value="match.new">match.new</option>
        <option value="application.status_changed">application.status_changed</option>
        <option value="message.received">message.received</option>
        <option value="document.expiring">document.expiring</option>
      </select>
    </div>

    <div id="rulesContainer" class="space-y-3"></div>
  </div>

  <div id="ruleModal" class="hidden fixed inset-0 bg-black/60 p-4">
    <div class="max-w-2xl mx-auto mt-8 bg-slate-900 border border-slate-700 rounded-lg p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modalTitle" class="font-semibold">Create Rule</h2>
        <button onclick="closeModal()" class="text-slate-400 hover:text-white">x</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="ruleName" placeholder="Rule name" class="px-3 py-2 rounded bg-slate-950 border border-slate-800 text-sm">
        <input id="ruleEvent" placeholder="Trigger event (e.g. match.new)" class="px-3 py-2 rounded bg-slate-950 border border-slate-800 text-sm">
      </div>
      <textarea id="ruleDescription" placeholder="Description" class="mt-3 w-full px-3 py-2 rounded bg-slate-950 border border-slate-800 text-sm"></textarea>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3 text-sm">
        <label class="flex items-center gap-2"><input id="ruleActive" type="checkbox" checked> Active</label>
        <label class="flex items-center gap-2"><input id="throttleEnabled" type="checkbox"> Throttle</label>
        <input id="maxPerHour" type="number" min="1" value="5" placeholder="Max/hr" class="px-2 py-1 rounded bg-slate-950 border border-slate-800">
        <input id="maxPerDay" type="number" min="1" value="20" placeholder="Max/day" class="px-2 py-1 rounded bg-slate-950 border border-slate-800">
      </div>
      <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="inAppTemplate" placeholder="In-app template (e.g. New {{match.score}}% match)" class="px-3 py-2 rounded bg-slate-950 border border-slate-800 text-sm">
        <input id="emailTemplateKey" placeholder="Email template key (optional)" class="px-3 py-2 rounded bg-slate-950 border border-slate-800 text-sm">
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button onclick="closeModal()" class="px-3 py-2 text-sm rounded bg-slate-800 hover:bg-slate-700">Cancel</button>
        <button onclick="saveRule()" class="px-3 py-2 text-sm rounded bg-blue-600 hover:bg-blue-500">Save</button>
      </div>
    </div>
  </div>

  <script src="../js/lmdr-html-bridge.js"></script>
  <script>
    let rules = [];
    let editingRule = null;

    document.addEventListener('DOMContentLoaded', () => {
      LMDRBridge.on('rulesLoaded', (payload) => {
        rules = payload || [];
        renderRules();
      });
      LMDRBridge.on('ruleTestResult', (payload) => {
        alert(`Would dispatch: ${payload.wouldDispatch ? 'Yes' : 'No'}\nChannels: ${payload.channels.length}`);
      });
      LMDRBridge.on('actionSuccess', (message) => {
        alert(message);
        refreshRules();
      });
      LMDRBridge.on('actionError', (message) => alert(message || 'Error'));
      refreshRules();
    });

    function refreshRules() {
      LMDRBridge.send('getAllRules');
    }

    function renderRules() {
      const container = document.getElementById('rulesContainer');
      const search = document.getElementById('searchInput').value.toLowerCase();
      const eventFilter = document.getElementById('eventFilter').value;
      const filtered = rules.filter((rule) => {
        const matchesSearch = (rule.name || '').toLowerCase().includes(search) || (rule.triggerEvent || '').toLowerCase().includes(search);
        const matchesEvent = eventFilter === 'all' || rule.triggerEvent === eventFilter;
        return matchesSearch && matchesEvent;
      });

      if (!filtered.length) {
        container.innerHTML = '<div class="text-sm text-slate-400 py-8 text-center border border-dashed border-slate-800 rounded">No rules found.</div>';
        return;
      }

      container.innerHTML = filtered.map((rule) => `
        <div class="border border-slate-800 rounded p-4 bg-slate-900">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">${escapeHtml(rule.name || 'Untitled')}</div>
              <div class="text-xs text-slate-400">${escapeHtml(rule.triggerEvent || '')}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-2 py-1 rounded ${rule.isActive ? 'bg-emerald-900 text-emerald-300' : 'bg-slate-800 text-slate-300'}">${rule.isActive ? 'ACTIVE' : 'INACTIVE'}</span>
              <button onclick="toggleRule('${rule._id}', ${!rule.isActive})" class="text-xs px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">${rule.isActive ? 'Disable' : 'Enable'}</button>
              <button onclick="editRule('${rule._id}')" class="text-xs px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">Edit</button>
              <button onclick="testRule('${rule._id}')" class="text-xs px-2 py-1 rounded bg-indigo-700 hover:bg-indigo-600">Test</button>
              <button onclick="removeRule('${rule._id}')" class="text-xs px-2 py-1 rounded bg-rose-800 hover:bg-rose-700">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function openCreate() {
      editingRule = null;
      document.getElementById('modalTitle').textContent = 'Create Rule';
      document.getElementById('ruleName').value = '';
      document.getElementById('ruleEvent').value = '';
      document.getElementById('ruleDescription').value = '';
      document.getElementById('ruleActive').checked = true;
      document.getElementById('throttleEnabled').checked = false;
      document.getElementById('maxPerHour').value = 5;
      document.getElementById('maxPerDay').value = 20;
      document.getElementById('inAppTemplate').value = '';
      document.getElementById('emailTemplateKey').value = '';
      document.getElementById('ruleModal').classList.remove('hidden');
    }

    function editRule(ruleId) {
      const rule = rules.find((item) => item._id === ruleId);
      if (!rule) return;
      editingRule = rule;
      document.getElementById('modalTitle').textContent = 'Edit Rule';
      document.getElementById('ruleName').value = rule.name || '';
      document.getElementById('ruleEvent').value = rule.triggerEvent || '';
      document.getElementById('ruleDescription').value = rule.description || '';
      document.getElementById('ruleActive').checked = !!rule.isActive;
      document.getElementById('throttleEnabled').checked = !!(rule.throttling && rule.throttling.enabled);
      document.getElementById('maxPerHour').value = (rule.throttling && rule.throttling.maxPerHour) || 5;
      document.getElementById('maxPerDay').value = (rule.throttling && rule.throttling.maxPerDay) || 20;
      const inApp = (rule.channels || []).find((ch) => ch.type === 'in_app');
      const email = (rule.channels || []).find((ch) => ch.type === 'email');
      document.getElementById('inAppTemplate').value = (inApp && inApp.template) || '';
      document.getElementById('emailTemplateKey').value = (email && email.templateKey) || '';
      document.getElementById('ruleModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('ruleModal').classList.add('hidden');
    }

    function saveRule() {
      const ruleData = {
        name: document.getElementById('ruleName').value.trim(),
        triggerEvent: document.getElementById('ruleEvent').value.trim(),
        description: document.getElementById('ruleDescription').value.trim(),
        isActive: document.getElementById('ruleActive').checked,
        priority: 'medium',
        conditions: [],
        channels: buildChannels(),
        throttling: {
          enabled: document.getElementById('throttleEnabled').checked,
          maxPerHour: Number(document.getElementById('maxPerHour').value || 5),
          maxPerDay: Number(document.getElementById('maxPerDay').value || 20),
          cooldownMinutes: 30,
          groupSimilar: false
        },
        scheduling: {
          delayMinutes: 0,
          respectQuietHours: true,
          quietHoursStart: '22:00',
          quietHoursEnd: '08:00',
          quietHoursTimezone: 'user',
          daysOfWeek: [0, 1, 2, 3, 4, 5, 6]
        }
      };

      if (!ruleData.name || !ruleData.triggerEvent) {
        alert('Name and trigger event are required.');
        return;
      }

      if (editingRule) {
        LMDRBridge.send('updateRule', { ruleId: editingRule._id, updates: ruleData });
      } else {
        LMDRBridge.send('createRule', { ruleData: ruleData });
      }
      closeModal();
    }

    function buildChannels() {
      const inAppTemplate = document.getElementById('inAppTemplate').value.trim();
      const emailTemplateKey = document.getElementById('emailTemplateKey').value.trim();
      const channels = [];
      if (inAppTemplate) {
        channels.push({ type: 'in_app', enabled: true, template: inAppTemplate });
      }
      if (emailTemplateKey) {
        channels.push({ type: 'email', enabled: true, templateKey: emailTemplateKey });
      }
      return channels;
    }

    function toggleRule(ruleId, isActive) {
      LMDRBridge.send('toggleRule', { ruleId: ruleId, isActive: isActive });
    }

    function removeRule(ruleId) {
      if (!confirm('Delete this rule?')) return;
      LMDRBridge.send('deleteRule', { ruleId: ruleId });
    }

    function testRule(ruleId) {
      LMDRBridge.send('testRule', {
        ruleId: ruleId,
        sampleData: {
          userId: 'test-user',
          user: { firstName: 'Alex' },
          carrier: { name: 'Acme Logistics' },
          match: { score: 92 }
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>
</body>
</html>
