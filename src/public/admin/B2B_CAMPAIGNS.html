<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Campaign Reporting</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>tailwind.config={theme:{extend:{fontFamily:{sans:['Inter','sans-serif']},colors:{lmdr:{dark:'#0f172a',blue:'#2563eb',yellow:'#fbbf24'}}}}}</script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}body{font-family:'Inter',sans-serif}
        .touch-target{min-height:44px;min-width:44px}.touch-active:active{opacity:.7;transform:scale(.98)}
        .scrollbar-thin::-webkit-scrollbar{width:6px}.scrollbar-thin::-webkit-scrollbar-track{background:#1e293b}.scrollbar-thin::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
        .toast{animation:slideIn .3s ease-out}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @supports(padding:max(0px)){.safe-bottom{padding-bottom:max(16px,env(safe-area-inset-bottom))}.safe-top{padding-top:max(16px,env(safe-area-inset-top))}}
        .kpi-card{transition:transform .15s ease}.kpi-card:hover{transform:translateY(-2px)}
    </style>
</head>
<body class="font-sans antialiased bg-slate-950 text-white">
    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <div class="flex flex-col h-full">
        <header class="flex-shrink-0 border-b border-slate-800 bg-slate-900 px-4 md:px-6 py-4 safe-top">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl md:text-2xl font-black tracking-tight">Campaign Reporting</h1>
                    <p class="text-xs text-slate-400 mt-0.5">Outreach performance by channel & rep</p>
                </div>
                <div class="flex items-center gap-2">
                    <select id="dateRange" onchange="refresh()" class="touch-target bg-slate-800 border border-slate-700 rounded-lg text-sm px-3 py-2 text-slate-300">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                    <button onclick="refresh()" class="touch-target touch-active w-10 h-10 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 flex items-center justify-center">
                        <span class="material-symbols-outlined text-[20px] text-slate-300">refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-auto scrollbar-thin">
            <div class="p-4 md:p-6 space-y-6">

                <!-- KPI Row -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Emails Sent</p>
                        <p id="kpiEmailSent" class="text-2xl font-black mt-1 text-blue-400">—</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Open Rate</p>
                        <p id="kpiOpenRate" class="text-2xl font-black mt-1 text-cyan-400">—</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Reply Rate</p>
                        <p id="kpiReplyRate" class="text-2xl font-black mt-1 text-emerald-400">—</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">SMS Sent</p>
                        <p id="kpiSmsSent" class="text-2xl font-black mt-1 text-amber-400">—</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Calls Made</p>
                        <p id="kpiCalls" class="text-2xl font-black mt-1 text-purple-400">—</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Connect Rate</p>
                        <p id="kpiConnectRate" class="text-2xl font-black mt-1 text-rose-400">—</p>
                    </div>
                </div>

                <!-- Channel Breakdown + Rep Performance -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <!-- Channel Chart -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider mb-4">Channel Breakdown</h2>
                        <div class="h-[250px]"><canvas id="channelChart"></canvas></div>
                    </div>

                    <!-- Rep Performance -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 py-3 border-b border-slate-800">
                            <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Rep Performance</h2>
                        </div>
                        <div class="overflow-auto max-h-[280px] scrollbar-thin">
                            <table class="w-full text-sm">
                                <thead><tr class="text-xs text-slate-400 uppercase border-b border-slate-800"><th class="text-left px-4 py-2">Rep</th><th class="text-right px-4 py-2">Touches</th><th class="text-right px-4 py-2">Replies</th><th class="text-right px-4 py-2">Meetings</th></tr></thead>
                                <tbody id="repTable" class="divide-y divide-slate-800/50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Channel Detail Cards -->
                <div id="channelCards" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Rendered dynamically -->
                </div>

            </div>
            <div class="safe-bottom"></div>
        </main>
    </div>

    <script>
        let channelChartInstance = null;

        const VALID_ACTIONS = ['init','metricsLoaded','channelsLoaded','repsLoaded','actionError'];
        function isValidMessage(d){return d&&typeof d==='object'&&typeof d.action==='string'&&VALID_ACTIONS.includes(d.action)}
        function sendToVelo(msg){window.parent.postMessage(msg,'*')}

        window.addEventListener('message',function(e){
            const d=e.data;if(!isValidMessage(d))return;
            switch(d.action){
                case 'init':refresh();break;
                case 'metricsLoaded':renderMetrics(d.payload);break;
                case 'channelsLoaded':renderChannels(d.payload);break;
                case 'repsLoaded':renderReps(d.payload);break;
                case 'actionError':showToast(d.message||'Error','error');break;
            }
        });

        function refresh(){
            const days=parseInt(document.getElementById('dateRange').value)||30;
            sendToVelo({action:'getOutreachMetrics',days});
            sendToVelo({action:'getChannelPerformance',days});
            sendToVelo({action:'getRepPerformance',days});
        }

        function renderMetrics(m){
            if(!m)return;
            const e=m.email||{};const s=m.sms||{};const c=m.call||{};
            setText('kpiEmailSent',String(e.sent||0));
            setText('kpiOpenRate',(e.open_rate||0)+'%');
            setText('kpiReplyRate',(e.reply_rate||0)+'%');
            setText('kpiSmsSent',String(s.sent||0));
            setText('kpiCalls',String(c.total||0));
            setText('kpiConnectRate',(c.connect_rate||0)+'%');
        }

        function renderChannels(channels){
            if(!channels)return;
            // Chart
            const ctx=document.getElementById('channelChart').getContext('2d');
            if(channelChartInstance)channelChartInstance.destroy();
            const labels=channels.map(c=>c.channel.charAt(0).toUpperCase()+c.channel.slice(1));
            channelChartInstance=new Chart(ctx,{
                type:'bar',
                data:{
                    labels,
                    datasets:[
                        {label:'Sent',data:channels.map(c=>c.sent),backgroundColor:'rgba(59,130,246,0.6)'},
                        {label:'Replied',data:channels.map(c=>c.replied),backgroundColor:'rgba(34,197,94,0.6)'}
                    ]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},scales:{x:{ticks:{color:'#64748b'}},y:{ticks:{color:'#64748b'},grid:{color:'rgba(51,65,85,0.3)'}}}}
            });

            // Detail cards
            const container=document.getElementById('channelCards');
            const icons={email:'mail',sms:'sms',voice:'call'};
            const colors={email:'blue',sms:'amber',voice:'emerald'};
            container.innerHTML=channels.map(c=>{
                const col=colors[c.channel]||'slate';
                const replyRate=c.sent>0?Math.round((c.replied/c.sent)*100):0;
                return `
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-[20px] text-${col}-400">${icons[c.channel]||'campaign'}</span>
                            <h3 class="text-sm font-bold text-slate-200">${esc(c.channel.charAt(0).toUpperCase()+c.channel.slice(1))}</h3>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-slate-400">Sent</span><span class="text-white font-semibold">${c.sent}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Delivered</span><span class="text-white font-semibold">${c.delivered}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Replied</span><span class="text-emerald-400 font-semibold">${c.replied}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Reply Rate</span><span class="text-${col}-400 font-semibold">${replyRate}%</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderReps(reps){
            const tbody=document.getElementById('repTable');
            if(!reps||reps.length===0){tbody.innerHTML='<tr><td colspan="4" class="px-4 py-6 text-center text-slate-500 text-sm">No rep data</td></tr>';return;}
            tbody.innerHTML=reps.map(r=>`
                <tr class="hover:bg-slate-800/50">
                    <td class="px-4 py-2.5 text-slate-200 font-medium">${esc(r.owner_id||'Unassigned')}</td>
                    <td class="px-4 py-2.5 text-right text-slate-300">${r.touches}</td>
                    <td class="px-4 py-2.5 text-right text-emerald-400">${r.replies}</td>
                    <td class="px-4 py-2.5 text-right text-purple-400">${r.meetings}</td>
                </tr>
            `).join('');
        }

        function setText(id,t){const el=document.getElementById(id);if(el)el.textContent=t;}
        function esc(s){if(!s)return '';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}
        function showToast(m,t='info'){const c=document.getElementById('toastContainer');const cl={success:'bg-emerald-600',error:'bg-red-600',info:'bg-blue-600'};const el=document.createElement('div');el.className=`toast ${cl[t]||cl.info} text-white text-sm px-4 py-3 rounded-lg shadow-lg`;el.textContent=m;c.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300)},3000);}

        document.addEventListener('DOMContentLoaded',()=>{refresh();});
    </script>
</body>
</html>
