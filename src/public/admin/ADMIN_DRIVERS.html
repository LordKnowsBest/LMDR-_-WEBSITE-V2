<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Admin - Drivers Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    lmdr: {
                        dark: '#0f172a',
                        blue: '#2563eb',
                        yellow: '#fbbf24',
                        canvas: '#f8fafc',
                    }
                },
                animation: {
                    'float': 'float 6s ease-in-out infinite',
                },
                keyframes: {
                    float: {
                        '0%, 100%': { transform: 'translateY(0)' },
                        '50%': { transform: 'translateY(-10px)' },
                    }
                }
            }
        }
    }
</script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Scrollbar styling */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Row highlight on selection */
        tr.selected {
            background-color: rgba(37, 99, 235, 0.1) !important;
        }

        /* Dropdown menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            z-index: 50;
            min-width: 180px;
        }

        .dropdown-menu.open {
            display: block;
        }

        /* Toast notifications */
        .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        /* Filter dropdown */
        .filter-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            z-index: 40;
            min-width: 200px;
        }

        .filter-dropdown.open {
            display: block;
        }

        /* Mobile card view */
        .driver-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .driver-card.selected {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.1);
        }

        /* Touch-friendly buttons */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 767px) {
            .filter-dropdown {
                position: fixed;
                left: 16px;
                right: 16px;
                top: auto;
                bottom: 0;
                border-radius: 16px 16px 0 0;
                max-height: 60vh;
                overflow-y: auto;
            }

            .filter-dropdown::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #475569;
                border-radius: 2px;
                margin: 8px auto 16px;
            }

            .dropdown-menu {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: 0;
                top: auto;
                border-radius: 16px 16px 0 0;
            }
        }

        /* Bottom sheet overlay for mobile */
        .mobile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 39;
            display: none;
        }

        .mobile-overlay.open {
            display: block;
        }

        /* Swipe indicator */
        .swipe-hint {
            width: 40px;
            height: 4px;
            background: #475569;
            border-radius: 2px;
            margin: 8px auto;
        }

        /* Safe area padding for notched devices */
        @supports (padding: max(0px)) {
            .safe-bottom {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }

            .safe-top {
                padding-top: max(16px, env(safe-area-inset-top));
            }
        }

        /* Prevent text selection on touch */
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }

        /* Active state for touch */
        .touch-active:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        /* Light mode overrides */
        html.light body {
            background-color: #f1f5f9;
            color: #1e293b;
        }

        html.light .bg-background-dark {
            background-color: #f1f5f9;
        }

        html.light .bg-surface-dark {
            background-color: #ffffff;
        }

        html.light .bg-surface-darker {
            background-color: #f8fafc;
        }

        html.light .bg-surface-darker\/50 {
            background-color: rgba(248, 250, 252, 0.5);
        }

        html.light .border-border-dark {
            border-color: #e2e8f0;
        }

        html.light .text-white {
            color: #1e293b;
        }

        html.light .text-text-muted {
            color: #64748b;
        }

        html.light .hover\:bg-\[\\#2d3a4f\]:hover {
            background-color: #e2e8f0;
        }

        html.light .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        }

        html.light .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        html.light .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #94a3b8;
        }

        html.light tr.selected {
            background-color: rgba(37, 99, 235, 0.05) !important;
        }

        html.light .driver-card {
            background: #ffffff;
            border-color: #e2e8f0;
        }

        html.light .driver-card.selected {
            background: rgba(37, 99, 235, 0.05);
        }
    </style>
</head>

<body class="bg-background-dark font-display text-white antialiased selection:bg-primary selection:text-white">

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="closeAllMenus()"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <!-- Main Container -->
    <div class="flex flex-col h-full">

        <!-- Page Header - Mobile Optimized -->
        <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-3 md:py-4 safe-top">
            <!-- Mobile Header -->
            <div class="flex items-center justify-between md:hidden mb-3">
                <h1 class="text-xl font-black tracking-tight">Drivers</h1>
                <div class="flex items-center gap-2">
                    <button onclick="toggleTheme()" id="themeToggleMobile"
                        class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark">
                        <span class="material-symbols-outlined text-[20px]">dark_mode</span>
                    </button>
                    <button onclick="exportDrivers()"
                        class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark">
                        <span class="material-symbols-outlined text-[20px]">download</span>
                    </button>
                    <button onclick="openAddDriverModal()"
                        class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-primary">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                    </button>
                </div>
            </div>

            <!-- Desktop Header -->
            <div class="hidden md:flex flex-wrap justify-between gap-4">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2 text-sm text-text-muted mb-1">
                        <span>Dashboard</span>
                        <span>/</span>
                        <span>User Management</span>
                        <span>/</span>
                        <span class="text-white">Drivers</span>
                    </div>
                    <h1 class="text-2xl font-black tracking-tight">Drivers Management</h1>
                    <p class="text-sm text-text-muted">Manage driver accounts, verify documents, and monitor supply
                        health.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleTheme()" id="themeToggleDesktop"
                        class="flex h-10 w-10 items-center justify-center rounded-lg bg-surface-dark border border-border-dark hover:bg-[#2d3a4f] transition-colors"
                        title="Toggle theme">
                        <span class="material-symbols-outlined text-[18px]">dark_mode</span>
                    </button>
                    <button onclick="exportDrivers()"
                        class="flex h-10 items-center justify-center gap-2 rounded-lg bg-surface-dark border border-border-dark px-4 text-sm font-medium hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[18px]">download</span>
                        <span>Export</span>
                    </button>
                    <button onclick="openAddDriverModal()"
                        class="flex h-10 items-center justify-center gap-2 rounded-lg bg-primary px-4 text-sm font-bold hover:bg-primary-dark transition-colors shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                        <span>Add Driver</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Cards - Mobile Scrollable -->
        <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 border-b border-border-dark bg-surface-darker/50">
            <!-- Mobile: Horizontal scroll -->
            <div class="flex md:hidden gap-3 overflow-x-auto scrollbar-hide pb-1 -mx-4 px-4">
                <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-text-muted text-[10px] font-medium uppercase">Total</span>
                        <div class="w-6 h-6 bg-primary/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-[14px]">group</span>
                        </div>
                    </div>
                    <div class="text-xl font-bold" id="statTotalDriversMobile">--</div>
                    <div class="text-[10px] text-emerald-400" id="statTotalDriversTrendMobile">--</div>
                </div>
                <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-text-muted text-[10px] font-medium uppercase">Active</span>
                        <div class="w-6 h-6 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-emerald-400 text-[14px]">check_circle</span>
                        </div>
                    </div>
                    <div class="text-xl font-bold" id="statActiveDriversMobile">--</div>
                    <div class="text-[10px] text-text-muted" id="statActiveDriversPercentMobile">--</div>
                </div>
                <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-text-muted text-[10px] font-medium uppercase">Pending</span>
                        <div class="w-6 h-6 bg-amber-500/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-amber-400 text-[14px]">pending</span>
                        </div>
                    </div>
                    <div class="text-xl font-bold" id="statPendingDriversMobile">--</div>
                    <div class="text-[10px] text-amber-400">Action needed</div>
                </div>
                <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-text-muted text-[10px] font-medium uppercase">Expired</span>
                        <div class="w-6 h-6 bg-rose-500/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-rose-400 text-[14px]">warning</span>
                        </div>
                    </div>
                    <div class="text-xl font-bold" id="statExpiredDocsMobile">--</div>
                    <div class="text-[10px] text-rose-400">Attention</div>
                </div>
            </div>

            <!-- Desktop: Grid layout -->
            <div class="hidden md:grid grid-cols-4 gap-4">
                <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Total Drivers</span>
                        <div class="w-8 h-8 bg-primary/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-[18px]">group</span>
                        </div>
                    </div>
                    <div class="text-2xl font-bold" id="statTotalDrivers">--</div>
                    <div class="text-xs text-emerald-400 mt-1" id="statTotalDriversTrend">--</div>
                </div>
                <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Active</span>
                        <div class="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-emerald-400 text-[18px]">check_circle</span>
                        </div>
                    </div>
                    <div class="text-2xl font-bold" id="statActiveDrivers">--</div>
                    <div class="text-xs text-text-muted mt-1" id="statActiveDriversPercent">--</div>
                </div>
                <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Pending
                            Verification</span>
                        <div class="w-8 h-8 bg-amber-500/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-amber-400 text-[18px]">pending</span>
                        </div>
                    </div>
                    <div class="text-2xl font-bold" id="statPendingDrivers">--</div>
                    <div class="text-xs text-amber-400 mt-1">Requires action</div>
                </div>
                <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Expired Docs</span>
                        <div class="w-8 h-8 bg-rose-500/20 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-rose-400 text-[18px]">warning</span>
                        </div>
                    </div>
                    <div class="text-2xl font-bold" id="statExpiredDocs">--</div>
                    <div class="text-xs text-rose-400 mt-1">Needs attention</div>
                </div>
            </div>
        </div>

        <!-- Toolbar & Filters - Mobile Optimized -->
        <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 bg-surface-darker border-b border-border-dark">
            <div class="flex flex-col gap-3">
                <!-- Search - Full width on mobile -->
                <div class="flex items-center gap-2 rounded-lg border border-border-dark bg-surface-dark px-3 py-2.5">
                    <span class="material-symbols-outlined text-text-muted text-[20px]">search</span>
                    <input id="searchInput"
                        class="w-full bg-transparent text-sm placeholder-text-muted focus:outline-none"
                        placeholder="Search name, email, or ID..." type="text" oninput="handleSearch()" />
                    <button id="clearSearchBtn" onclick="clearSearch()" class="hidden text-text-muted hover:text-white">
                        <span class="material-symbols-outlined text-[18px]">close</span>
                    </button>
                </div>

                <!-- Filter Row -->
                <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0">
                    <!-- View Toggle (Mobile only) -->
                    <div class="md:hidden flex bg-surface-dark border border-border-dark rounded-lg p-0.5">
                        <button onclick="setViewMode('card')" id="viewCardBtn"
                            class="flex items-center justify-center w-9 h-8 rounded-md bg-primary text-white">
                            <span class="material-symbols-outlined text-[18px]">grid_view</span>
                        </button>
                        <button onclick="setViewMode('table')" id="viewTableBtn"
                            class="flex items-center justify-center w-9 h-8 rounded-md text-text-muted">
                            <span class="material-symbols-outlined text-[18px]">view_list</span>
                        </button>
                    </div>

                    <!-- Status Filter -->
                    <div class="relative flex-shrink-0">
                        <button onclick="toggleFilter('status')"
                            class="filter-chip touch-active flex h-9 items-center gap-1.5 rounded-lg bg-surface-dark border border-border-dark pl-3 pr-2 whitespace-nowrap">
                            <span class="text-xs font-medium">Status: <span id="statusFilterLabel"
                                    class="text-text-muted">All</span></span>
                            <span class="material-symbols-outlined text-text-muted text-[18px]">expand_more</span>
                        </button>
                        <div id="statusFilterDropdown"
                            class="filter-dropdown bg-surface-dark border border-border-dark rounded-lg shadow-xl overflow-hidden">
                            <div class="swipe-hint md:hidden"></div>
                            <button onclick="setFilter('status', 'all', 'All')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">All
                                Statuses</button>
                            <button onclick="setFilter('status', 'active', 'Active')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Active
                            </button>
                            <button onclick="setFilter('status', 'pending', 'Pending')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 bg-amber-500 rounded-full"></span> Pending
                            </button>
                            <button onclick="setFilter('status', 'suspended', 'Suspended')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 bg-rose-500 rounded-full"></span> Suspended
                            </button>
                            <button onclick="setFilter('status', 'incomplete', 'Incomplete')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 bg-slate-500 rounded-full"></span> Incomplete
                            </button>
                        </div>
                    </div>

                    <!-- Verification Filter -->
                    <div class="relative flex-shrink-0">
                        <button onclick="toggleFilter('verification')"
                            class="filter-chip touch-active flex h-9 items-center gap-1.5 rounded-lg bg-surface-dark border border-border-dark pl-3 pr-2 whitespace-nowrap">
                            <span class="text-xs font-medium">Verified: <span id="verificationFilterLabel"
                                    class="text-text-muted">All</span></span>
                            <span class="material-symbols-outlined text-text-muted text-[18px]">expand_more</span>
                        </button>
                        <div id="verificationFilterDropdown"
                            class="filter-dropdown bg-surface-dark border border-border-dark rounded-lg shadow-xl overflow-hidden">
                            <div class="swipe-hint md:hidden"></div>
                            <button onclick="setFilter('verification', 'all', 'All')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">All</button>
                            <button onclick="setFilter('verification', 'verified', 'Yes')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">Verified</button>
                            <button onclick="setFilter('verification', 'in_review', 'Review')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">In
                                Review</button>
                            <button onclick="setFilter('verification', 'unverified', 'No')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">Unverified</button>
                            <button onclick="setFilter('verification', 'expired', 'Expired')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">Expired
                                Docs</button>
                        </div>
                    </div>

                    <!-- Tier Filter (Hidden on small mobile) -->
                    <div class="relative flex-shrink-0 hidden sm:block">
                        <button onclick="toggleFilter('tier')"
                            class="filter-chip touch-active flex h-9 items-center gap-1.5 rounded-lg bg-surface-dark border border-border-dark pl-3 pr-2 whitespace-nowrap">
                            <span class="text-xs font-medium">Tier: <span id="tierFilterLabel"
                                    class="text-text-muted">All</span></span>
                            <span class="material-symbols-outlined text-text-muted text-[18px]">expand_more</span>
                        </button>
                        <div id="tierFilterDropdown"
                            class="filter-dropdown bg-surface-dark border border-border-dark rounded-lg shadow-xl overflow-hidden">
                            <div class="swipe-hint md:hidden"></div>
                            <button onclick="setFilter('tier', 'all', 'All')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">All
                                Tiers</button>
                            <button onclick="setFilter('tier', 'premium', 'Premium')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">Premium</button>
                            <button onclick="setFilter('tier', 'free', 'Free')"
                                class="w-full px-4 py-3 md:py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors">Free</button>
                        </div>
                    </div>

                    <!-- Clear Filters -->
                    <button onclick="clearAllFilters()" id="clearFiltersBtn"
                        class="hidden flex-shrink-0 h-9 items-center gap-1.5 text-primary px-2">
                        <span class="material-symbols-outlined text-[18px]">filter_list_off</span>
                        <span class="text-xs font-medium hidden md:inline">Clear</span>
                    </button>
                </div>
            </div>

            <!-- Bulk Actions Bar - Mobile Optimized -->
            <div id="bulkActionsBar" class="hidden mt-3 bg-primary/10 border border-primary/30 rounded-lg px-3 py-2.5">
                <div class="flex items-center justify-between">
                    <span class="text-sm"><span id="selectedCount" class="font-bold">0</span> selected</span>
                    <div class="flex items-center gap-2">
                        <button onclick="bulkAction('verify')"
                            class="touch-active flex items-center gap-1 px-2.5 py-1.5 text-xs font-medium bg-emerald-500/20 text-emerald-400 rounded-lg">
                            <span class="material-symbols-outlined text-[16px]">verified</span>
                            <span class="hidden sm:inline">Verify</span>
                        </button>
                        <button onclick="bulkAction('suspend')"
                            class="touch-active flex items-center gap-1 px-2.5 py-1.5 text-xs font-medium bg-rose-500/20 text-rose-400 rounded-lg">
                            <span class="material-symbols-outlined text-[16px]">block</span>
                            <span class="hidden sm:inline">Suspend</span>
                        </button>
                        <button onclick="clearSelection()"
                            class="touch-target flex items-center justify-center w-8 h-8 text-text-muted">
                            <span class="material-symbols-outlined text-[20px]">close</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area - Switches between Card (mobile) and Table (desktop) views -->
        <div class="flex-1 overflow-hidden">
            <!-- Mobile Card View -->
            <div id="mobileCardView" class="md:hidden h-full overflow-y-auto scrollbar-thin px-4 py-3">
                <div id="driversCardContainer">
                    <!-- Cards rendered here -->
                </div>
                <!-- Mobile Load More / Pagination -->
                <div id="mobilePagination" class="py-4 text-center">
                    <div class="text-xs text-text-muted mb-3">
                        <span id="mobileResultCount">0</span> drivers
                    </div>
                    <button onclick="loadMore()" id="loadMoreBtn"
                        class="hidden touch-active w-full py-3 bg-surface-dark border border-border-dark rounded-lg text-sm font-medium">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Desktop Table View -->
            <div id="desktopTableView" class="hidden md:block h-full px-6 py-4">
                <div
                    class="h-full flex flex-col rounded-xl border border-border-dark bg-surface-darker overflow-hidden">
                    <div class="flex-1 overflow-auto scrollbar-thin">
                        <table class="min-w-full">
                            <thead class="sticky top-0 z-10">
                                <tr class="bg-surface-dark border-b border-border-dark">
                                    <th class="w-12 px-4 py-3">
                                        <input id="selectAllCheckbox" type="checkbox"
                                            class="h-4 w-4 rounded border-border-dark bg-surface-dark text-primary focus:ring-primary cursor-pointer"
                                            onchange="toggleSelectAll()" />
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        <button onclick="sortBy('name')"
                                            class="flex items-center gap-1 hover:text-primary transition-colors">
                                            Name
                                            <span class="material-symbols-outlined text-[16px]"
                                                id="sortIconName">unfold_more</span>
                                        </button>
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        Email</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        Status</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        Verification</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        <button onclick="sortBy('profileCompletion')"
                                            class="flex items-center gap-1 hover:text-primary transition-colors">
                                            Profile %
                                            <span class="material-symbols-outlined text-[16px]"
                                                id="sortIconProfile">unfold_more</span>
                                        </button>
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        Location</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        <button onclick="sortBy('lastActive')"
                                            class="flex items-center gap-1 hover:text-primary transition-colors">
                                            Last Active
                                            <span class="material-symbols-outlined text-[16px]"
                                                id="sortIconActive">unfold_more</span>
                                        </button>
                                    </th>
                                    <th
                                        class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody" class="divide-y divide-border-dark">
                                <!-- Loading skeleton -->
                                <tr>
                                    <td colspan="9" class="px-4 py-8 text-center">
                                        <div class="flex flex-col items-center gap-3">
                                            <div
                                                class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin">
                                            </div>
                                            <span class="text-text-muted text-sm">Loading drivers...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Footer -->
                    <div
                        class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-3 border-t border-border-dark bg-surface-dark px-4 py-3">
                        <div class="text-xs text-text-muted">
                            Showing <span id="paginationFrom" class="font-medium text-white">0</span> to <span
                                id="paginationTo" class="font-medium text-white">0</span> of <span id="paginationTotal"
                                class="font-medium text-white">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="pageSizeSelect" onchange="changePageSize()"
                                class="h-8 rounded-lg border border-border-dark bg-surface-dark px-2 text-xs focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <div class="flex gap-1">
                                <button onclick="goToPage('prev')" id="prevPageBtn" disabled
                                    class="touch-target flex h-8 items-center justify-center rounded-lg border border-border-dark bg-surface-dark px-3 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="material-symbols-outlined text-[18px]">chevron_left</span>
                                </button>
                                <button onclick="goToPage('next')" id="nextPageBtn"
                                    class="touch-target flex h-8 items-center justify-center rounded-lg border border-border-dark bg-surface-dark px-3 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Detail Modal - Full screen on mobile -->
    <div id="driverDetailModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeDriverModal()"></div>
        <div
            class="absolute inset-0 md:inset-auto md:right-0 md:top-0 md:h-full md:w-full md:max-w-2xl bg-surface-darker md:border-l border-border-dark shadow-2xl overflow-y-auto safe-bottom">
            <div id="driverDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Mobile Action Sheet -->
    <div id="mobileActionSheet" class="fixed inset-x-0 bottom-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeMobileActionSheet()"></div>
        <div class="absolute inset-x-0 bottom-0 bg-surface-dark border-t border-border-dark rounded-t-2xl safe-bottom">
            <div class="swipe-hint"></div>
            <div id="mobileActionSheetContent" class="px-4 pb-4">
                <!-- Actions rendered here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let state = {
            drivers: [],
            selectedIds: new Set(),
            currentPage: 1,
            pageSize: 25,
            totalCount: 0,
            sortField: 'lastActive',
            sortDirection: 'desc',
            filters: {
                status: 'all',
                verification: 'all',
                tier: 'all',
                search: ''
            },
            isLoading: false,
            viewMode: 'card', // 'card' or 'table'
            isMobile: window.innerWidth < 768
        };

        const DEBUG_MESSAGES = true;

        const MESSAGE_REGISTRY = {
            // Messages FROM Velo that HTML handles
            inbound: [
                'driversLoaded',
                'driverDetail',
                'statsLoaded',
                'actionSuccess',
                'actionError',
                'init',
                'pong', // Health check response
                'emailRevealed',
                'exportReady'
            ],
            // Messages TO Velo that HTML sends
            outbound: [
                'getDrivers',
                'getStats',
                'getDriverDetail',
                'verifyDriver',
                'suspendDriver',
                'bulkVerify',
                'bulkSuspend',
                'exportDrivers',
                'openMessageModal',
                'openAddDriverModal',
                'revealEmail',
                'ping' // Health check
            ]
        };

        // ==========================================
        // SECURITY HARDENING UTILITIES
        // ==========================================

        // Origin validation - verifies message comes from trusted parent frame
        function isValidOrigin(event) {
            if (window.parent === window) {
                console.warn('‚ö†Ô∏è SECURITY: Not running in iframe context');
                return false;
            }
            if (event.source !== window.parent) {
                console.warn('‚ö†Ô∏è SECURITY: Message not from parent frame');
                return false;
            }
            return true;
        }

        // Schema validation - ensures message has required structure
        function validateMessageSchema(msg) {
            if (!msg || typeof msg !== 'object') return false;
            // The pattern here expects 'action' instead of 'type' for ADMIN_DRIVERS
            if (typeof msg.action !== 'string' || msg.action.length === 0) return false;
            return true;
        }

        // HTML sanitization - strips dangerous content from user-generated strings
        function stripHtml(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Safe text content setter - use instead of innerHTML for user content
        function safeSetText(element, text) {
            if (element) element.textContent = text;
        }

        function validateInboundMessage(action) {
            if (!MESSAGE_REGISTRY.inbound.includes(action)) {
                console.warn(`‚ö†Ô∏è UNREGISTERED INBOUND MESSAGE: "${action}" - Add to MESSAGE_REGISTRY.inbound`);
                return false;
            }
            return true;
        }

        function logMessageFlow(direction, action, data) {
            if (!DEBUG_MESSAGES) return;
            const arrow = direction === 'in' ? 'üì•' : 'üì§';
            const label = direction === 'in' ? 'Velo‚ÜíHTML' : 'HTML‚ÜíVelo';
            console.log(`${arrow} [${label}] ${action}`, data ? Object.keys(data) : '(no data)');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('message', handleMessage);
        window.addEventListener('resize', handleResize);

        document.addEventListener('DOMContentLoaded', () => {
            handleResize();
            verifyConnection();
            refreshData();
            sendToVelo({ action: 'getStats' });
        });

        function handleResize() {
            const wasMobile = state.isMobile;
            state.isMobile = window.innerWidth < 768;

            if (wasMobile !== state.isMobile) {
                renderContent();
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-chip') && !e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
                document.getElementById('mobileOverlay').classList.remove('open');
            }
            if (!e.target.closest('.action-btn') && !e.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('open'));
            }
        });

        // ============================================
        // MESSAGE HANDLING
        // ============================================
        function handleMessage(event) {
            if (!isValidOrigin(event)) return;

            const data = event.data;
            if (!validateMessageSchema(data)) return;
            if (!validateInboundMessage(data.action)) return;

            logMessageFlow('in', data.action, data.payload);

            switch (data.action) {
                case 'pong':
                    connectionVerified = true;
                    console.log('‚úÖ CONNECTION: Health check successful');
                    break;
                case 'init':
                    refreshData(); // Uses state.filters and page defaults
                    break;
                case 'driversLoaded':
                    handleDriversLoaded(data.payload);
                    break;
                case 'driverDetail':
                    showDriverDetail(data.payload);
                    break;
                case 'statsLoaded':
                    updateStats(data.payload);
                    break;
                case 'actionSuccess':
                    showToast(data.message || 'Action completed successfully', 'success');
                    refreshData();
                    break;
                case 'actionError':
                    showToast(data.message || 'An error occurred', 'error');
                    break;
                case 'emailRevealed':
                    if (data.payload && data.payload.driverId && data.payload.email) {
                        const emailEl = document.querySelector(`[data-email-driver="${data.payload.driverId}"]`);
                        if (emailEl) {
                            emailEl.textContent = data.payload.email;
                            emailEl.classList.remove('blur-sm');
                        }
                        showToast('Email revealed', 'success');
                    }
                    break;
                case 'exportReady':
                    if (data.payload) {
                        downloadCSV(data.payload);
                    }
                    break;
            }
        }

        function downloadCSV(payload) {
            const blob = new Blob([payload.csv || payload.data || ''], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = payload.filename || 'drivers_export.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export downloaded', 'success');
        }

        function sendToVelo(message) {
            const { action, ...payload } = message;

            // Validate outbound message
            if (!MESSAGE_REGISTRY.outbound.includes(action)) {
                console.warn(`‚ö†Ô∏è UNREGISTERED OUTBOUND MESSAGE: "${action}" - Add to MESSAGE_REGISTRY.outbound`);
            }

            logMessageFlow('out', action, payload);
            window.parent.postMessage(message, '*');
        }

        // Health check - verify communication with Velo
        let connectionVerified = false;
        function verifyConnection() {
            if (connectionVerified) return;
            sendToVelo({ action: 'ping', timestamp: Date.now() });
            setTimeout(() => {
                if (!connectionVerified) {
                    console.warn('‚ö†Ô∏è CONNECTION CHECK: No pong received from Velo within 3s');
                }
            }, 3000);
        }

        // ============================================
        // DATA HANDLING
        // ============================================
        function handleDriversLoaded(payload) {
            state.drivers = payload.drivers || [];
            state.totalCount = payload.totalCount || 0;
            state.currentPage = payload.currentPage || 1;
            state.isLoading = false;
            renderContent();
            updatePagination();
        }

        function updateStats(stats) {
            // Desktop stats
            document.getElementById('statTotalDrivers').textContent = stats.total?.toLocaleString() || '0';
            document.getElementById('statTotalDriversTrend').textContent = `+${stats.newThisWeek || 0} this week`;
            document.getElementById('statActiveDrivers').textContent = stats.active?.toLocaleString() || '0';
            document.getElementById('statActiveDriversPercent').textContent = `${stats.activePercent || 0}% of total`;
            document.getElementById('statPendingDrivers').textContent = stats.pending?.toLocaleString() || '0';
            document.getElementById('statExpiredDocs').textContent = stats.expiredDocs?.toLocaleString() || '0';

            // Mobile stats
            document.getElementById('statTotalDriversMobile').textContent = stats.total?.toLocaleString() || '0';
            document.getElementById('statTotalDriversTrendMobile').textContent = `+${stats.newThisWeek || 0}`;
            document.getElementById('statActiveDriversMobile').textContent = stats.active?.toLocaleString() || '0';
            document.getElementById('statActiveDriversPercentMobile').textContent = `${stats.activePercent || 0}%`;
            document.getElementById('statPendingDriversMobile').textContent = stats.pending?.toLocaleString() || '0';
            document.getElementById('statExpiredDocsMobile').textContent = stats.expiredDocs?.toLocaleString() || '0';
        }

        function refreshData() {
            state.isLoading = true;
            showLoadingState();
            sendToVelo({
                action: 'getDrivers',
                filters: state.filters,
                page: state.currentPage,
                pageSize: state.pageSize,
                sortField: state.sortField,
                sortDirection: state.sortDirection
            });
            sendToVelo({ action: 'getStats' });
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderContent() {
            if (state.isMobile && state.viewMode === 'card') {
                renderCards();
            } else {
                renderTable();
            }
            document.getElementById('mobileResultCount').textContent = state.totalCount.toLocaleString();
        }

        function renderCards() {
            const container = document.getElementById('driversCardContainer');

            if (state.drivers.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <span class="material-symbols-outlined text-[48px] text-text-muted mb-3">search_off</span>
                    <p class="text-text-muted text-sm mb-3">No drivers found</p>
                    <button onclick="clearAllFilters()" class="text-primary text-sm">Clear filters</button>
                </div>
            `;
                return;
            }

            container.innerHTML = state.drivers.map(driver => renderDriverCard(driver)).join('');
        }

        function renderDriverCard(driver) {
            const isSelected = state.selectedIds.has(driver._id);
            return `
            <div class="driver-card ${isSelected ? 'selected' : ''}" data-id="${driver._id}">
                <div class="flex items-start gap-3">
                    <!-- Checkbox -->
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${driver._id}')"
                           class="mt-1 h-5 w-5 rounded border-border-dark bg-surface-dark text-primary flex-shrink-0"/>

                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-full bg-surface-darker flex items-center justify-center text-sm font-bold flex-shrink-0 ${driver.profileImage ? 'bg-cover bg-center' : ''}"
                         style="${driver.profileImage ? `background-image: url('${driver.profileImage}')` : ''}">
                        ${!driver.profileImage ? getInitials(driver.firstName, driver.lastName) : ''}
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                            <div>
                                <div class="font-semibold truncate">${escapeHtml(driver.firstName || '')} ${escapeHtml(driver.lastName || '')}</div>
                                <div class="text-xs text-text-muted truncate">${maskEmail(driver.email)}</div>
                            </div>
                            <button onclick="showMobileActions('${driver._id}')" class="touch-target flex items-center justify-center w-8 h-8 -mr-2 text-text-muted">
                                <span class="material-symbols-outlined">more_vert</span>
                            </button>
                        </div>

                        <!-- Status Row -->
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            ${renderStatusBadge(driver.status)}
                            ${renderVerificationBadge(driver.verificationStatus)}
                        </div>

                        <!-- Profile Progress -->
                        <div class="flex items-center gap-2 mt-3">
                            <div class="flex-1 h-1.5 rounded-full bg-surface-darker overflow-hidden">
                                <div class="h-full rounded-full ${getProfileBarColor(driver.profileCompletion)}" style="width: ${driver.profileCompletion || 0}%;"></div>
                            </div>
                            <span class="text-xs text-text-muted">${driver.profileCompletion || 0}%</span>
                        </div>

                        <!-- Meta -->
                        <div class="flex items-center gap-3 mt-2 text-xs text-text-muted">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">location_on</span>
                                ${escapeHtml(driver.location || 'N/A')}
                            </span>
                            <span>${formatRelativeTime(driver.lastActive)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }

        function renderTable() {
            const tbody = document.getElementById('driversTableBody');

            if (state.drivers.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-4 py-12 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <span class="material-symbols-outlined text-[48px] text-text-muted">search_off</span>
                            <span class="text-text-muted">No drivers found matching your criteria</span>
                            <button onclick="clearAllFilters()" class="text-primary text-sm hover:underline">Clear all filters</button>
                        </div>
                    </td>
                </tr>
            `;
                return;
            }

            tbody.innerHTML = state.drivers.map((driver, index) => renderDriverRow(driver, index)).join('');
        }

        function renderDriverRow(driver, index) {
            const isSelected = state.selectedIds.has(driver._id);
            const isOddRow = index % 2 === 1;

            return `
            <tr class="group ${isSelected ? 'selected' : ''} ${isOddRow ? 'bg-[#1a1f2e]' : ''} hover:bg-[#1f2937] transition-colors" data-id="${driver._id}">
                <td class="px-4 py-4">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${driver._id}')" class="h-4 w-4 rounded border-border-dark bg-surface-dark text-primary focus:ring-primary cursor-pointer"/>
                </td>
                <td class="px-4 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-surface-dark flex items-center justify-center text-sm font-bold ${driver.profileImage ? 'bg-cover bg-center' : ''}"
                             style="${driver.profileImage ? `background-image: url('${driver.profileImage}')` : ''}">
                            ${!driver.profileImage ? getInitials(driver.firstName, driver.lastName) : ''}
                        </div>
                        <div>
                            <div class="text-sm font-medium">${escapeHtml(driver.firstName || '')} ${escapeHtml(driver.lastName || '')}</div>
                            <div class="text-xs text-text-muted">ID: #${driver._id?.substring(0, 8) || 'N/A'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-4">
                    <div class="flex items-center gap-2 text-sm text-text-muted font-mono">
                        ${maskEmail(driver.email)}
                        <button onclick="revealEmail('${driver._id}')" class="text-text-muted hover:text-primary transition-colors">
                            <span class="material-symbols-outlined text-[16px]">visibility</span>
                        </button>
                    </div>
                </td>
                <td class="px-4 py-4">${renderStatusBadge(driver.status)}</td>
                <td class="px-4 py-4">${renderVerificationStatus(driver.verificationStatus)}</td>
                <td class="px-4 py-4">
                    <div class="flex items-center gap-3">
                        <div class="h-1.5 w-24 rounded-full bg-surface-dark overflow-hidden">
                            <div class="h-full rounded-full ${getProfileBarColor(driver.profileCompletion)}" style="width: ${driver.profileCompletion || 0}%;"></div>
                        </div>
                        <span class="text-xs font-medium">${driver.profileCompletion || 0}%</span>
                    </div>
                </td>
                <td class="px-4 py-4 text-sm text-text-muted">${escapeHtml(driver.location || 'Not specified')}</td>
                <td class="px-4 py-4">
                    <div class="text-sm">${formatRelativeTime(driver.lastActive)}</div>
                    <div class="text-xs text-text-muted">Joined ${formatDate(driver._createdDate)}</div>
                </td>
                <td class="px-4 py-4 text-right relative">
                    <button onclick="toggleActionMenu('${driver._id}')" class="action-btn rounded-lg p-2 text-text-muted hover:bg-surface-dark hover:text-primary transition-colors">
                        <span class="material-symbols-outlined">more_horiz</span>
                    </button>
                    <div id="actionMenu-${driver._id}" class="dropdown-menu bg-surface-dark border border-border-dark rounded-lg shadow-xl overflow-hidden">
                        <button onclick="viewDriver('${driver._id}')" class="w-full px-4 py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">visibility</span> View Profile
                        </button>
                        <button onclick="messageDriver('${driver._id}')" class="w-full px-4 py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">mail</span> Send Message
                        </button>
                        <button onclick="verifyDriver('${driver._id}')" class="w-full px-4 py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2 text-emerald-400">
                            <span class="material-symbols-outlined text-[18px]">verified</span> Mark Verified
                        </button>
                        <div class="border-t border-border-dark"></div>
                        <button onclick="suspendDriver('${driver._id}')" class="w-full px-4 py-2.5 text-left text-sm hover:bg-[#2d3a4f] transition-colors flex items-center gap-2 text-rose-400">
                            <span class="material-symbols-outlined text-[18px]">block</span> Suspend Account
                        </button>
                    </div>
                </td>
            </tr>
        `;
        }

        function renderStatusBadge(status) {
            const badges = {
                active: '<span class="inline-flex items-center rounded-full bg-emerald-500/10 px-2 py-0.5 text-[11px] font-medium text-emerald-400">Active</span>',
                pending: '<span class="inline-flex items-center rounded-full bg-amber-500/10 px-2 py-0.5 text-[11px] font-medium text-amber-400">Pending</span>',
                suspended: '<span class="inline-flex items-center rounded-full bg-rose-500/10 px-2 py-0.5 text-[11px] font-medium text-rose-400">Suspended</span>',
                incomplete: '<span class="inline-flex items-center rounded-full bg-slate-500/10 px-2 py-0.5 text-[11px] font-medium text-slate-400">Incomplete</span>'
            };
            return badges[status] || badges.incomplete;
        }

        function renderVerificationBadge(status) {
            const badges = {
                verified: '<span class="inline-flex items-center gap-1 text-[11px] text-emerald-400"><span class="material-symbols-outlined text-[14px]">verified</span></span>',
                in_review: '<span class="inline-flex items-center gap-1 text-[11px] text-amber-400"><span class="material-symbols-outlined text-[14px]">pending</span></span>',
                expired: '<span class="inline-flex items-center gap-1 text-[11px] text-rose-400"><span class="material-symbols-outlined text-[14px]">warning</span></span>',
                unverified: ''
            };
            return badges[status] || '';
        }

        function renderVerificationStatus(status) {
            const statuses = {
                verified: '<div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px] text-emerald-500">verified</span><span class="text-sm text-slate-300">Verified</span></div>',
                in_review: '<div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px] text-amber-500">pending_actions</span><span class="text-sm text-slate-300">In Review</span></div>',
                expired: '<div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px] text-rose-500">warning</span><span class="text-sm text-slate-300">Expired</span></div>',
                unverified: '<div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px] text-slate-400">gpp_bad</span><span class="text-sm text-slate-300">Unverified</span></div>'
            };
            return statuses[status] || statuses.unverified;
        }

        function getProfileBarColor(percentage) {
            if (percentage >= 80) return 'bg-primary';
            if (percentage >= 50) return 'bg-amber-500';
            return 'bg-slate-400';
        }

        function showLoadingState() {
            if (state.isMobile) {
                document.getElementById('driversCardContainer').innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-text-muted text-sm mt-3">Loading...</span>
                </div>
            `;
            } else {
                document.getElementById('driversTableBody').innerHTML = `
                <tr>
                    <td colspan="9" class="px-4 py-8 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-text-muted text-sm">Loading drivers...</span>
                        </div>
                    </td>
                </tr>
            `;
            }
        }

        // ============================================
        // VIEW MODE
        // ============================================
        function setViewMode(mode) {
            state.viewMode = mode;
            document.getElementById('viewCardBtn').className = mode === 'card'
                ? 'flex items-center justify-center w-9 h-8 rounded-md bg-primary text-white'
                : 'flex items-center justify-center w-9 h-8 rounded-md text-text-muted';
            document.getElementById('viewTableBtn').className = mode === 'table'
                ? 'flex items-center justify-center w-9 h-8 rounded-md bg-primary text-white'
                : 'flex items-center justify-center w-9 h-8 rounded-md text-text-muted';
            renderContent();
        }

        // ============================================
        // FILTERS & SEARCH
        // ============================================
        function toggleFilter(filterName) {
            const dropdown = document.getElementById(`${filterName}FilterDropdown`);
            const isOpen = dropdown.classList.contains('open');

            document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
            document.getElementById('mobileOverlay').classList.remove('open');

            if (!isOpen) {
                dropdown.classList.add('open');
                if (state.isMobile) {
                    document.getElementById('mobileOverlay').classList.add('open');
                }
            }
        }

        function setFilter(filterName, value, label) {
            state.filters[filterName] = value;
            document.getElementById(`${filterName}FilterLabel`).textContent = label;
            document.getElementById(`${filterName}FilterDropdown`).classList.remove('open');
            document.getElementById('mobileOverlay').classList.remove('open');
            state.currentPage = 1;
            updateClearFiltersVisibility();
            refreshData();
        }

        function handleSearch() {
            const searchValue = document.getElementById('searchInput').value;
            state.filters.search = searchValue;
            state.currentPage = 1;

            document.getElementById('clearSearchBtn').classList.toggle('hidden', !searchValue);
            updateClearFiltersVisibility();

            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                refreshData();
            }, 300);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            state.filters.search = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            updateClearFiltersVisibility();
            refreshData();
        }

        function clearAllFilters() {
            state.filters = { status: 'all', verification: 'all', tier: 'all', search: '' };
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            document.getElementById('statusFilterLabel').textContent = 'All';
            document.getElementById('verificationFilterLabel').textContent = 'All';
            document.getElementById('tierFilterLabel').textContent = 'All';
            state.currentPage = 1;
            updateClearFiltersVisibility();
            refreshData();
        }

        function updateClearFiltersVisibility() {
            const hasFilters = state.filters.status !== 'all' ||
                state.filters.verification !== 'all' ||
                state.filters.tier !== 'all' ||
                state.filters.search !== '';
            document.getElementById('clearFiltersBtn').classList.toggle('hidden', !hasFilters);
            document.getElementById('clearFiltersBtn').classList.toggle('flex', hasFilters);
        }

        // ============================================
        // SORTING
        // ============================================
        function sortBy(field) {
            if (state.sortField === field) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortField = field;
                state.sortDirection = 'desc';
            }

            document.querySelectorAll('[id^="sortIcon"]').forEach(icon => {
                icon.textContent = 'unfold_more';
            });
            const fieldName = field.charAt(0).toUpperCase() + field.slice(1);
            const icon = document.getElementById(`sortIcon${fieldName}`);
            if (icon) {
                icon.textContent = state.sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward';
            }

            refreshData();
        }

        // ============================================
        // SELECTION
        // ============================================
        function toggleSelect(id) {
            if (state.selectedIds.has(id)) {
                state.selectedIds.delete(id);
            } else {
                state.selectedIds.add(id);
            }
            updateSelectionUI();

            // Update card/row visual
            const element = document.querySelector(`[data-id="${id}"]`);
            if (element) {
                element.classList.toggle('selected', state.selectedIds.has(id));
            }
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox.checked) {
                state.drivers.forEach(d => state.selectedIds.add(d._id));
            } else {
                state.selectedIds.clear();
            }
            renderContent();
            updateSelectionUI();
        }

        function clearSelection() {
            state.selectedIds.clear();
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox) checkbox.checked = false;
            renderContent();
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const bulkBar = document.getElementById('bulkActionsBar');
            const count = state.selectedIds.size;

            if (count > 0) {
                bulkBar.classList.remove('hidden');
                document.getElementById('selectedCount').textContent = count;
            } else {
                bulkBar.classList.add('hidden');
            }
        }

        // ============================================
        // PAGINATION
        // ============================================
        function updatePagination() {
            const from = state.totalCount === 0 ? 0 : (state.currentPage - 1) * state.pageSize + 1;
            const to = Math.min(state.currentPage * state.pageSize, state.totalCount);

            document.getElementById('paginationFrom').textContent = from;
            document.getElementById('paginationTo').textContent = to;
            document.getElementById('paginationTotal').textContent = state.totalCount;

            document.getElementById('prevPageBtn').disabled = state.currentPage === 1;
            document.getElementById('nextPageBtn').disabled = to >= state.totalCount;

            // Mobile load more
            document.getElementById('loadMoreBtn').classList.toggle('hidden', to >= state.totalCount);
        }

        function goToPage(direction) {
            if (direction === 'prev' && state.currentPage > 1) {
                state.currentPage--;
            } else if (direction === 'next') {
                state.currentPage++;
            }
            refreshData();
        }

        function loadMore() {
            state.currentPage++;
            // For mobile, we'd append results instead of replacing
            refreshData();
        }

        function changePageSize() {
            state.pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            state.currentPage = 1;
            refreshData();
        }

        // ============================================
        // ACTIONS
        // ============================================
        function toggleActionMenu(id) {
            const menu = document.getElementById(`actionMenu-${id}`);
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                if (d !== menu) d.classList.remove('open');
            });
            menu.classList.toggle('open');
        }

        function showMobileActions(driverId) {
            const driver = state.drivers.find(d => d._id === driverId);
            if (!driver) return;

            const content = document.getElementById('mobileActionSheetContent');
            content.innerHTML = `
            <div class="text-center mb-4">
                <div class="font-semibold">${escapeHtml(driver.firstName)} ${escapeHtml(driver.lastName)}</div>
                <div class="text-sm text-text-muted">${maskEmail(driver.email)}</div>
            </div>
            <div class="space-y-2">
                <button onclick="viewDriver('${driverId}'); closeMobileActionSheet();" class="touch-active w-full flex items-center gap-3 px-4 py-3 bg-surface-darker rounded-lg">
                    <span class="material-symbols-outlined">visibility</span>
                    <span>View Profile</span>
                </button>
                <button onclick="messageDriver('${driverId}'); closeMobileActionSheet();" class="touch-active w-full flex items-center gap-3 px-4 py-3 bg-surface-darker rounded-lg">
                    <span class="material-symbols-outlined">mail</span>
                    <span>Send Message</span>
                </button>
                <button onclick="verifyDriver('${driverId}'); closeMobileActionSheet();" class="touch-active w-full flex items-center gap-3 px-4 py-3 bg-emerald-500/10 text-emerald-400 rounded-lg">
                    <span class="material-symbols-outlined">verified</span>
                    <span>Mark Verified</span>
                </button>
                <button onclick="suspendDriver('${driverId}'); closeMobileActionSheet();" class="touch-active w-full flex items-center gap-3 px-4 py-3 bg-rose-500/10 text-rose-400 rounded-lg">
                    <span class="material-symbols-outlined">block</span>
                    <span>Suspend Account</span>
                </button>
            </div>
        `;

            document.getElementById('mobileActionSheet').classList.remove('hidden');
        }

        function closeMobileActionSheet() {
            document.getElementById('mobileActionSheet').classList.add('hidden');
        }

        function viewDriver(id) {
            sendToVelo({ action: 'getDriverDetail', driverId: id });
            document.getElementById('driverDetailModal').classList.remove('hidden');
            document.getElementById('driverDetailContent').innerHTML = `
            <div class="flex items-center justify-center h-64">
                <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            </div>
        `;
            closeAllMenus();
        }

        function closeDriverModal() {
            document.getElementById('driverDetailModal').classList.add('hidden');
        }

        function showDriverDetail(driver) {
            const content = document.getElementById('driverDetailContent');
            content.innerHTML = `
            <div class="sticky top-0 bg-surface-darker border-b border-border-dark px-4 md:px-6 py-4 flex items-center justify-between safe-top">
                <h2 class="text-lg font-bold">Driver Profile</h2>
                <button onclick="closeDriverModal()" class="touch-target flex items-center justify-center w-10 h-10 hover:bg-surface-dark rounded-lg transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-4 md:p-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 rounded-full bg-surface-dark flex items-center justify-center text-xl font-bold flex-shrink-0 ${driver.profileImage ? 'bg-cover bg-center' : ''}"
                         style="${driver.profileImage ? `background-image: url('${driver.profileImage}')` : ''}">
                        ${!driver.profileImage ? getInitials(driver.firstName, driver.lastName) : ''}
                    </div>
                    <div class="min-w-0">
                        <h3 class="text-xl font-bold truncate">${escapeHtml(driver.firstName || '')} ${escapeHtml(driver.lastName || '')}</h3>
                        <p class="text-text-muted truncate">${escapeHtml(driver.email || '')}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-surface-dark rounded-lg p-3">
                        <div class="text-[10px] text-text-muted uppercase mb-1">Status</div>
                        ${renderStatusBadge(driver.status)}
                    </div>
                    <div class="bg-surface-dark rounded-lg p-3">
                        <div class="text-[10px] text-text-muted uppercase mb-1">Verification</div>
                        ${renderVerificationStatus(driver.verificationStatus)}
                    </div>
                    <div class="bg-surface-dark rounded-lg p-3">
                        <div class="text-[10px] text-text-muted uppercase mb-1">Profile</div>
                        <div class="text-lg font-bold">${driver.profileCompletion || 0}%</div>
                    </div>
                    <div class="bg-surface-dark rounded-lg p-3">
                        <div class="text-[10px] text-text-muted uppercase mb-1">Location</div>
                        <div class="text-sm truncate">${escapeHtml(driver.location || 'Not specified')}</div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-xs uppercase text-text-muted">Quick Actions</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="messageDriver('${driver._id}')" class="touch-active flex items-center justify-center gap-2 py-3 bg-surface-dark rounded-lg">
                            <span class="material-symbols-outlined text-[20px]">mail</span>
                            <span class="text-sm">Message</span>
                        </button>
                        <button onclick="verifyDriver('${driver._id}')" class="touch-active flex items-center justify-center gap-2 py-3 bg-emerald-500/20 text-emerald-400 rounded-lg">
                            <span class="material-symbols-outlined text-[20px]">verified</span>
                            <span class="text-sm">Verify</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        }

        function messageDriver(id) {
            sendToVelo({ action: 'openMessageModal', driverId: id });
            closeAllMenus();
        }

        function verifyDriver(id) {
            if (confirm('Mark this driver as verified?')) {
                sendToVelo({ action: 'verifyDriver', driverId: id });
            }
            closeAllMenus();
        }

        function suspendDriver(id) {
            if (confirm('Suspend this driver account?')) {
                sendToVelo({ action: 'suspendDriver', driverId: id });
            }
            closeAllMenus();
        }

        function bulkAction(action) {
            const ids = Array.from(state.selectedIds);
            if (ids.length === 0) return;

            if (confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} ${ids.length} driver(s)?`)) {
                sendToVelo({ action: `bulk${action.charAt(0).toUpperCase() + action.slice(1)}`, driverIds: ids });
            }
        }

        function exportDrivers() {
            sendToVelo({ action: 'exportDrivers', filters: state.filters });
            showToast('Preparing export...', 'info');
        }

        function openAddDriverModal() {
            sendToVelo({ action: 'openAddDriverModal' });
        }

        function revealEmail(id) {
            sendToVelo({ action: 'revealEmail', driverId: id });
        }

        function closeAllMenus() {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
            document.getElementById('mobileOverlay').classList.remove('open');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        // Consistent sanitization utility
        function escapeHtml(str) {
            return stripHtml(str);
        }

        function getInitials(firstName, lastName) {
            return ((firstName?.[0] || '') + (lastName?.[0] || '')).toUpperCase() || '?';
        }

        function maskEmail(email) {
            if (!email) return 'N/A';
            const [local, domain] = email.split('@');
            if (!domain) return email;
            return `${local[0]}***@${domain}`;
        }

        function formatRelativeTime(date) {
            if (!date) return 'Never';
            const now = new Date();
            const then = new Date(date);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatDate(date);
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-rose-500',
                info: 'bg-primary',
                warning: 'bg-amber-500'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            toast.innerHTML = `
            <span class="material-symbols-outlined text-[20px]">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
            <span class="text-sm font-medium flex-1">${escapeHtml(message)}</span>
            <button onclick="this.parentElement.remove()" class="ml-2">
                <span class="material-symbols-outlined text-[18px]">close</span>
            </button>
        `;

            container.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    toast.style.transition = 'all 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        const THEME_KEY = 'lmdr-admin-theme';

        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'dark');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
            } else {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
            }
            updateThemeIcons(theme);
        }

        function toggleTheme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        }

        function updateThemeIcons(theme) {
            const icon = theme === 'dark' ? 'dark_mode' : 'light_mode';
            const mobileBtn = document.getElementById('themeToggleMobile');
            const desktopBtn = document.getElementById('themeToggleDesktop');
            if (mobileBtn) mobileBtn.querySelector('.material-symbols-outlined').textContent = icon;
            if (desktopBtn) desktopBtn.querySelector('.material-symbols-outlined').textContent = icon;
        }

        // Initialize theme on load
        initTheme();
    </script>

</body>

</html>