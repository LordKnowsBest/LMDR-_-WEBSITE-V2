<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>B2B Outreach</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>tailwind.config={theme:{extend:{fontFamily:{sans:['Inter','sans-serif']},colors:{lmdr:{dark:'#0f172a',blue:'#2563eb',yellow:'#fbbf24'}}}}}</script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}body{font-family:'Inter',sans-serif}
        .touch-target{min-height:44px;min-width:44px}.touch-active:active{opacity:.7;transform:scale(.98)}
        .scrollbar-thin::-webkit-scrollbar{width:6px}.scrollbar-thin::-webkit-scrollbar-track{background:#1e293b}.scrollbar-thin::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
        .toast{animation:slideIn .3s ease-out}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @supports(padding:max(0px)){.safe-bottom{padding-bottom:max(16px,env(safe-area-inset-bottom))}.safe-top{padding-top:max(16px,env(safe-area-inset-top))}}
        .step-card{transition:all .15s ease}.step-card:hover{background:rgba(37,99,235,.06)}
    </style>
</head>
<body class="font-sans antialiased bg-slate-950 text-white">
    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <div class="flex flex-col h-full">
        <header class="flex-shrink-0 border-b border-slate-800 bg-slate-900 px-4 md:px-6 py-4 safe-top">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div>
                    <h1 class="text-xl md:text-2xl font-black tracking-tight">Outreach Workspace</h1>
                    <p class="text-xs text-slate-400 mt-0.5">Sequences, templates & campaigns</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="createSequence()" class="touch-target touch-active flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-[18px]">add</span>New Sequence
                    </button>
                    <button onclick="refreshOutreach()" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700">
                        <span class="material-symbols-outlined text-[20px] text-slate-300">refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Throttle Status Bar -->
        <div class="flex-shrink-0 border-b border-slate-800 bg-slate-900/50 px-4 md:px-6 py-2">
            <div class="flex items-center gap-4 md:gap-8 text-xs">
                <span class="text-slate-500">Today's limits:</span>
                <div><span class="material-symbols-outlined text-[14px] text-blue-400 align-middle">mail</span> <span id="emailLimit" class="text-slate-300">—</span></div>
                <div><span class="material-symbols-outlined text-[14px] text-amber-400 align-middle">sms</span> <span id="smsLimit" class="text-slate-300">—</span></div>
                <div><span class="material-symbols-outlined text-[14px] text-emerald-400 align-middle">call</span> <span id="callLimit" class="text-slate-300">—</span></div>
                <div id="quietHoursIndicator" class="hidden"><span class="text-red-400">Quiet hours active</span></div>
            </div>
        </div>

        <main class="flex-1 overflow-auto scrollbar-thin">
            <div class="p-4 md:p-6 space-y-6">

                <!-- Sequence List -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                    <div class="px-4 md:px-5 py-3 border-b border-slate-800 flex items-center justify-between">
                        <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Sequences</h2>
                        <div class="flex gap-2">
                            <select id="seqStatusFilter" onchange="refreshOutreach()" class="bg-slate-800 border border-slate-700 rounded text-xs px-2 py-1 text-slate-300">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="draft">Draft</option>
                                <option value="paused">Paused</option>
                            </select>
                        </div>
                    </div>
                    <div id="sequenceList" class="divide-y divide-slate-800/50 max-h-[300px] overflow-auto scrollbar-thin">
                        <div class="p-6 text-center text-slate-500 text-sm">Loading sequences...</div>
                    </div>
                </div>

                <!-- Sequence Builder (shown when editing) -->
                <div id="sequenceBuilder" class="hidden bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                    <div class="px-4 md:px-5 py-3 border-b border-slate-800 flex items-center justify-between">
                        <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Sequence Builder</h2>
                        <button onclick="closeBuilder()" class="text-xs text-slate-400 hover:text-white">Close</button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-slate-400 block mb-1">Sequence Name</label>
                                <input id="seqName" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white" placeholder="e.g., New Carrier Intro" />
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 block mb-1">Channels</label>
                                <div class="flex gap-2">
                                    <label class="flex items-center gap-1 text-xs text-slate-300"><input type="checkbox" id="chEmail" checked class="rounded bg-slate-700 border-slate-600 text-blue-600" /> Email</label>
                                    <label class="flex items-center gap-1 text-xs text-slate-300"><input type="checkbox" id="chSms" class="rounded bg-slate-700 border-slate-600 text-blue-600" /> SMS</label>
                                    <label class="flex items-center gap-1 text-xs text-slate-300"><input type="checkbox" id="chCall" class="rounded bg-slate-700 border-slate-600 text-blue-600" /> Call</label>
                                </div>
                            </div>
                        </div>

                        <!-- Steps -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs text-slate-400">Steps</label>
                                <button onclick="addStep()" class="text-xs text-blue-400 hover:text-blue-300 font-medium">+ Add Step</button>
                            </div>
                            <div id="stepList" class="space-y-2">
                                <p class="text-xs text-slate-600 text-center py-4">No steps yet. Add a step to get started.</p>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 pt-2">
                            <button onclick="saveSequence()" class="touch-target touch-active px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-sm font-medium transition-colors">Save Sequence</button>
                        </div>
                    </div>
                </div>

                <!-- Template Library -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                    <div class="px-4 md:px-5 py-3 border-b border-slate-800">
                        <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Template Variables</h2>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{carrier_name}}</code><p class="text-slate-500 mt-0.5">Company name</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{match_count}}</code><p class="text-slate-500 mt-0.5">Driver matches</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{top_regions}}</code><p class="text-slate-500 mt-0.5">Best regions</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{contact_name}}</code><p class="text-slate-500 mt-0.5">Contact name</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{equipment}}</code><p class="text-slate-500 mt-0.5">Equipment types</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{signal_score}}</code><p class="text-slate-500 mt-0.5">Match score</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{fleet_size}}</code><p class="text-slate-500 mt-0.5">Fleet size</p></div>
                            <div class="bg-slate-800 rounded-lg px-3 py-2"><code class="text-blue-400">{{rep_name}}</code><p class="text-slate-500 mt-0.5">Your name</p></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="safe-bottom"></div>
        </main>
    </div>

    <script>
        let editingSequenceId = null;
        let steps = [];

        const VALID_ACTIONS = ['init','sequencesLoaded','sequenceLoaded','throttleStatus','sequenceSaved','stepSaved','actionSuccess','actionError','emailContentGenerated','smsContentGenerated','callScriptGenerated','draftSaved','draftApproved','draftsLoaded'];
        function isValidMessage(d){return d&&typeof d==='object'&&typeof d.action==='string'&&VALID_ACTIONS.includes(d.action)}
        function sendToVelo(msg){window.parent.postMessage(msg,'*')}

        window.addEventListener('message',function(e){
            const d=e.data; if(!isValidMessage(d))return;
            switch(d.action){
                case 'init':refreshOutreach();break;
                case 'sequencesLoaded':renderSequences(d.payload);break;
                case 'sequenceLoaded':openBuilder(d.payload);break;
                case 'throttleStatus':renderThrottle(d.payload);break;
                case 'sequenceSaved':showToast('Sequence saved','success');closeBuilder();refreshOutreach();break;
                case 'emailContentGenerated':handleAIContent(d.payload,'email');break;
                case 'smsContentGenerated':handleAIContent(d.payload,'sms');break;
                case 'callScriptGenerated':handleAIContent(d.payload,'call');break;
                case 'draftSaved':showToast('Draft saved for review','success');break;
                case 'draftApproved':showToast('Draft approved','success');break;
                case 'draftsLoaded':renderPendingDrafts(d.payload);break;
                case 'actionSuccess':showToast(d.message||'Done','success');break;
                case 'actionError':showToast(d.message||'Error','error');break;
            }
        });

        function refreshOutreach(){
            const status=document.getElementById('seqStatusFilter').value;
            sendToVelo({action:'getSequences',status});
            sendToVelo({action:'getThrottleStatus'});
        }

        function renderSequences(seqs){
            const c=document.getElementById('sequenceList');
            if(!seqs||seqs.length===0){c.innerHTML='<div class="p-6 text-center text-slate-500 text-sm">No sequences found</div>';return;}
            const statusBadge={active:'bg-emerald-500/20 text-emerald-400',draft:'bg-slate-700 text-slate-400',paused:'bg-amber-500/20 text-amber-400',archived:'bg-red-500/20 text-red-400'};
            c.innerHTML=seqs.map(s=>`
                <div class="px-4 md:px-5 py-3 flex items-center justify-between gap-3 step-card cursor-pointer" onclick="editSequence('${esc(s._id||s.id)}')">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-100 truncate">${esc(s.name)}</p>
                        <p class="text-xs text-slate-400 mt-0.5">Channels: ${esc(s.channel_mix||'—')}</p>
                    </div>
                    <span class="text-xs font-bold px-2 py-0.5 rounded-full ${statusBadge[s.status]||statusBadge.draft}">${esc(s.status||'draft')}</span>
                </div>
            `).join('');
        }

        function renderThrottle(t){
            if(!t)return;
            if(t.email)setText('emailLimit',`${t.email.remaining||0}/${t.email.limit||200}`);
            if(t.sms)setText('smsLimit',`${t.sms.remaining||0}/${t.sms.limit||100}`);
            if(t.call)setText('callLimit',`${t.call.remaining||0}/${t.call.limit||50}`);
            document.getElementById('quietHoursIndicator').classList.toggle('hidden',!t.quietHours);
        }

        function createSequence(){editingSequenceId=null;steps=[];document.getElementById('seqName').value='';document.getElementById('sequenceBuilder').classList.remove('hidden');renderSteps();}
        function editSequence(id){sendToVelo({action:'getSequence',sequenceId:id});}
        function openBuilder(data){
            if(!data)return;
            editingSequenceId=data.sequence?._id||data.sequence?.id||null;
            document.getElementById('seqName').value=data.sequence?.name||'';
            const mix=data.sequence?.channel_mix||'';
            document.getElementById('chEmail').checked=mix.includes('email');
            document.getElementById('chSms').checked=mix.includes('sms');
            document.getElementById('chCall').checked=mix.includes('call');
            steps=data.steps||[];
            document.getElementById('sequenceBuilder').classList.remove('hidden');
            renderSteps();
        }
        function closeBuilder(){document.getElementById('sequenceBuilder').classList.add('hidden');editingSequenceId=null;steps=[];}

        function addStep(){
            steps.push({step_type:'email',subject:'',template:'',delay_hours:24,step_order:steps.length+1,ai_generated:false,purpose:'follow_up'});
            renderSteps();
        }

        // AI Content Generation
        let currentAIStepIndex = null;
        let aiPreviewContent = null;

        function generateAIContent(stepIndex){
            currentAIStepIndex = stepIndex;
            const step = steps[stepIndex];
            const accountId = currentAccountId || '';
            const contactId = currentContactId || '';
            if(!accountId){showToast('Select an account first','error');return;}
            showToast('Generating AI content...','info');
            switch(step.step_type){
                case 'email':
                    sendToVelo({action:'generateEmailContent',accountId,contactId,purpose:step.purpose||'follow_up',sequenceStepId:step._id||step.id||''});
                    break;
                case 'sms':
                    sendToVelo({action:'generateSmsContent',accountId,contactId,purpose:step.purpose||'follow_up',sequenceStepId:step._id||step.id||''});
                    break;
                case 'call':
                    sendToVelo({action:'generateCallScript',accountId,contactId,purpose:step.purpose||'intro',sequenceStepId:step._id||step.id||''});
                    break;
                default:
                    showToast('AI generation not supported for this step type','error');
            }
        }

        function handleAIContent(payload, channel){
            if(currentAIStepIndex === null) return;
            const content = payload.content;
            aiPreviewContent = content;
            if(channel === 'email'){
                steps[currentAIStepIndex].subject = content.subject || '';
                steps[currentAIStepIndex].template = content.body || '';
            } else if(channel === 'sms'){
                steps[currentAIStepIndex].template = content.message || '';
            } else if(channel === 'call'){
                const script = [content.opening||'', '', 'Value Props:', ...(content.valueProps||[]).map(v=>'• '+v), '', 'Questions:', ...(content.questions||[]).map(q=>'• '+q), '', 'Closing:', content.closing||''].join('\n');
                steps[currentAIStepIndex].template = script;
            }
            steps[currentAIStepIndex].ai_generated = true;
            renderSteps();
            showToast(payload.cached ? 'AI content loaded (cached)' : 'AI content generated', 'success');
            if(payload.fallback) showToast('Used fallback template (AI unavailable)','info');
            currentAIStepIndex = null;
        }

        function toggleAIGenerated(stepIndex){
            steps[stepIndex].ai_generated = !steps[stepIndex].ai_generated;
            renderSteps();
        }

        function renderPendingDrafts(drafts){
            // Could render a drafts panel - for now just log
            console.log('Pending drafts:', drafts);
        }

        // Track current account/contact for AI generation context
        let currentAccountId = null;
        let currentContactId = null;

        function setContextForAI(accountId, contactId){
            currentAccountId = accountId;
            currentContactId = contactId;
        }

        function renderSteps(){
            const c=document.getElementById('stepList');
            if(steps.length===0){c.innerHTML='<p class="text-xs text-slate-600 text-center py-4">No steps yet. Add a step to get started.</p>';return;}
            const typeIcons={email:'mail',sms:'sms',call:'call',wait:'hourglass_empty',task:'task_alt'};
            const canGenerateAI = ['email','sms','call'];
            c.innerHTML=steps.map((s,i)=>`
                <div class="bg-slate-800 rounded-lg p-3 flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full ${s.ai_generated?'bg-cyan-600/30':'bg-slate-700'} flex items-center justify-center">
                        <span class="material-symbols-outlined text-[16px] ${s.ai_generated?'text-cyan-400':'text-slate-300'}">${s.ai_generated?'auto_awesome':typeIcons[s.step_type]||'circle'}</span>
                    </div>
                    <div class="flex-1 space-y-2">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select onchange="steps[${i}].step_type=this.value;renderSteps()" class="bg-slate-700 border border-slate-600 rounded text-xs px-2 py-1 text-white">
                                <option value="email" ${s.step_type==='email'?'selected':''}>Email</option>
                                <option value="sms" ${s.step_type==='sms'?'selected':''}>SMS</option>
                                <option value="call" ${s.step_type==='call'?'selected':''}>Call</option>
                                <option value="wait" ${s.step_type==='wait'?'selected':''}>Wait</option>
                                <option value="task" ${s.step_type==='task'?'selected':''}>Task</option>
                            </select>
                            <select onchange="steps[${i}].purpose=this.value" class="bg-slate-700 border border-slate-600 rounded text-xs px-2 py-1 text-white">
                                <option value="intro" ${s.purpose==='intro'?'selected':''}>Intro</option>
                                <option value="follow_up" ${s.purpose==='follow_up'||!s.purpose?'selected':''}>Follow-up</option>
                                <option value="proposal" ${s.purpose==='proposal'?'selected':''}>Proposal</option>
                                <option value="check_in" ${s.purpose==='check_in'?'selected':''}>Check-in</option>
                                <option value="discovery" ${s.purpose==='discovery'?'selected':''}>Discovery</option>
                                <option value="close" ${s.purpose==='close'?'selected':''}>Close</option>
                            </select>
                            <input type="number" value="${s.delay_hours}" onchange="steps[${i}].delay_hours=parseInt(this.value)" class="w-16 bg-slate-700 border border-slate-600 rounded text-xs px-2 py-1 text-white" placeholder="Delay" />
                            <span class="text-xs text-slate-500">hrs</span>
                            ${canGenerateAI.includes(s.step_type)?`
                                <button onclick="toggleAIGenerated(${i})" class="text-xs px-2 py-1 rounded ${s.ai_generated?'bg-cyan-600/20 text-cyan-400 border border-cyan-600/50':'bg-slate-700 text-slate-400 border border-slate-600'}" title="Toggle AI generation at send time">
                                    <span class="material-symbols-outlined text-[12px] align-middle">auto_awesome</span> AI ${s.ai_generated?'On':'Off'}
                                </button>
                                <button onclick="generateAIContent(${i})" class="text-xs px-2 py-1 rounded bg-blue-600/20 text-blue-400 border border-blue-600/50 hover:bg-blue-600/30" title="Generate AI content now">
                                    <span class="material-symbols-outlined text-[12px] align-middle">edit_note</span> Generate
                                </button>
                            `:''}
                        </div>
                        ${s.step_type==='email'?`<input type="text" value="${esc(s.subject||'')}" onchange="steps[${i}].subject=this.value" class="w-full bg-slate-700 border border-slate-600 rounded text-xs px-2 py-1 text-white" placeholder="Subject line..." />`:''}
                        <textarea onchange="steps[${i}].template=this.value" class="w-full bg-slate-700 border border-slate-600 rounded text-xs px-2 py-1 text-white h-20 resize-none scrollbar-thin" placeholder="${s.ai_generated?'AI will generate content at send time...':'Message template (use {{variables}})...'}">${esc(s.template||'')}</textarea>
                        ${s.ai_generated?`<p class="text-[10px] text-cyan-500"><span class="material-symbols-outlined text-[10px] align-middle">info</span> AI-generated content will be personalized for each contact at send time</p>`:''}
                    </div>
                    <button onclick="steps.splice(${i},1);renderSteps()" class="text-slate-500 hover:text-red-400"><span class="material-symbols-outlined text-[18px]">close</span></button>
                </div>
            `).join('');
        }

        function saveSequence(){
            const name=document.getElementById('seqName').value.trim();
            if(!name){showToast('Name required','error');return;}
            const channels=[];
            if(document.getElementById('chEmail').checked)channels.push('email');
            if(document.getElementById('chSms').checked)channels.push('sms');
            if(document.getElementById('chCall').checked)channels.push('call');
            sendToVelo({action:'saveSequence',sequenceId:editingSequenceId,name,channels,steps});
        }

        function setText(id,t){const el=document.getElementById(id);if(el)el.textContent=t;}
        function esc(s){if(!s)return '';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}
        function showToast(m,t='info'){const c=document.getElementById('toastContainer');const cl={success:'bg-emerald-600',error:'bg-red-600',info:'bg-blue-600'};const el=document.createElement('div');el.className=`toast ${cl[t]||cl.info} text-white text-sm px-4 py-3 rounded-lg shadow-lg`;el.textContent=m;c.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300)},3000);}

        document.addEventListener('DOMContentLoaded',()=>{refreshOutreach();});
    </script>
</body>
</html>
