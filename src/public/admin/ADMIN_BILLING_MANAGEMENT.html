<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Billing Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24', canvas: '#f8fafc' }
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/css/admin-billing.css" />
</head>

<body class="bg-slate-900 text-white font-sans">
    <div id="app" class="h-full flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex-shrink-0 bg-slate-800 border-b border-slate-700 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-xs font-bold">VM</div>
                    <h1 class="text-lg font-bold">Billing Management</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="pendingBadgeBtn" onclick="BillingLogic.loadPendingApprovals()" class="relative touch-target touch-active flex items-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">
                        <span class="material-symbols-outlined text-base">pending_actions</span>
                        <span>Approvals</span>
                        <span id="pendingCount" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4">
            <!-- Search Bar -->
            <div class="relative">
                <div class="flex items-center bg-slate-800 border border-slate-700 rounded-lg px-3">
                    <span class="material-symbols-outlined text-slate-400">search</span>
                    <input id="searchInput" type="text"
                        placeholder="Search by DOT number, company name, or email..."
                        class="w-full bg-transparent border-none text-white placeholder-slate-400 px-3 py-3 text-sm focus:outline-none focus:ring-0"
                        oninput="BillingLogic.handleSearchInput(this.value)" />
                    <button id="searchClear" class="hidden text-slate-400 hover:text-white" onclick="BillingLogic.clearSearch()">
                        <span class="material-symbols-outlined text-base">close</span>
                    </button>
                </div>
                <div id="searchDropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-20 search-dropdown"></div>
            </div>

            <!-- Customer Details Panel (hidden until customer selected) -->
            <div id="customerPanel" class="hidden space-y-4">
                <!-- Customer Info Header -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Carrier Info</h3>
                            <div class="space-y-1.5">
                                <p class="text-base font-bold" id="carrierName">--</p>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">DOT:</span> <span id="carrierDot">--</span></p>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">Email:</span> <span id="carrierEmail">--</span></p>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">Phone:</span> <span id="carrierPhone">--</span></p>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Subscription</h3>
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2">
                                    <span id="planBadge" class="px-2 py-0.5 rounded text-xs font-semibold uppercase">--</span>
                                    <span id="statusBadge" class="px-2 py-0.5 rounded text-xs font-semibold">--</span>
                                </div>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">Period:</span> <span id="periodDates">--</span></p>
                                <div class="mt-2">
                                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                                        <span>Usage</span>
                                        <span id="usageText">0 / 0</span>
                                    </div>
                                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div id="usageBar" class="h-full rounded-full transition-all duration-500 usage-bar-green" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="BillingLogic.openModal('changePlan')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">swap_horiz</span> Change Plan
                    </button>
                    <button onclick="BillingLogic.openModal('applyCredit')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">add_card</span> Apply Credit
                    </button>
                    <button onclick="BillingLogic.openModal('pause')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">pause_circle</span> Pause
                    </button>
                    <button onclick="BillingLogic.openModal('cancel')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">cancel</span> Cancel
                    </button>
                    <button onclick="BillingLogic.openModal('refund')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">receipt_long</span> Refund
                    </button>
                </div>

                <!-- Billing History Table -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-700">
                        <h3 class="text-sm font-semibold">Billing History</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-slate-400 border-b border-slate-700">
                                    <th class="px-4 py-2 font-medium">Date</th>
                                    <th class="px-4 py-2 font-medium">Type</th>
                                    <th class="px-4 py-2 font-medium">Amount</th>
                                    <th class="px-4 py-2 font-medium">Status</th>
                                    <th class="px-4 py-2 font-medium">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billingHistoryBody">
                                <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">Select a customer to view billing history</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Adjustments Timeline -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-700">
                        <h3 class="text-sm font-semibold">Adjustments</h3>
                    </div>
                    <div id="adjustmentsTimeline" class="p-4 space-y-3">
                        <p class="text-sm text-slate-500 text-center py-4">No adjustments</p>
                    </div>
                </div>
            </div>

            <!-- Pending Approvals Panel -->
            <div id="approvalsPanel" class="hidden bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between cursor-pointer" onclick="BillingLogic.toggleApprovals()">
                    <h3 class="text-sm font-semibold flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-amber-400">pending_actions</span>
                        Pending Approvals
                    </h3>
                    <span id="approvalsChevron" class="material-symbols-outlined text-base text-slate-400 transition-transform">expand_more</span>
                </div>
                <div id="approvalsContent" class="hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-400 border-b border-slate-700">
                                <th class="px-4 py-2 font-medium">Carrier</th>
                                <th class="px-4 py-2 font-medium">Type</th>
                                <th class="px-4 py-2 font-medium">Amount</th>
                                <th class="px-4 py-2 font-medium">Reason</th>
                                <th class="px-4 py-2 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="approvalsBody">
                            <tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Loading skeleton -->
            <div id="loadingSkeleton" class="hidden space-y-4">
                <div class="skeleton h-24 rounded-lg"></div>
                <div class="skeleton h-12 rounded-lg"></div>
                <div class="skeleton h-48 rounded-lg"></div>
            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <!-- Change Plan Modal -->
        <div id="changePlanModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Change Subscription Plan</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Select Plan</label>
                    <select id="newPlanSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="pro">Pro</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="immediateChange" class="rounded bg-slate-700 border-slate-600 text-blue-500 focus:ring-blue-500" />
                    <label for="immediateChange" class="text-sm">Apply immediately (with proration)</label>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="BillingLogic.submitChangePlan()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">Confirm Change</button>
                </div>
            </div>
        </div>

        <!-- Apply Credit Modal -->
        <div id="applyCreditModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Apply Credit</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Amount ($)</label>
                    <input id="creditAmount" type="number" min="0.01" step="0.01" placeholder="0.00"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none"
                        oninput="BillingLogic.checkCreditWarning()" />
                    <p id="creditWarning" class="hidden mt-1 text-xs text-amber-400">Credits over $100 require approval</p>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason</label>
                    <textarea id="creditReason" rows="3" placeholder="Reason for credit..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="BillingLogic.submitCredit()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-sm font-medium transition-colors">Apply Credit</button>
                </div>
            </div>
        </div>

        <!-- Pause Modal -->
        <div id="pauseModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Pause Subscription</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Duration</label>
                    <select id="pauseDuration" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason</label>
                    <textarea id="pauseReason" rows="3" placeholder="Reason for pausing..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-yellow-500 focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="BillingLogic.submitPause()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">Pause Subscription</button>
                </div>
            </div>
        </div>

        <!-- Cancel Modal -->
        <div id="cancelModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-red-400">Cancel Subscription</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="immediateCancel" class="rounded bg-slate-700 border-slate-600 text-red-500 focus:ring-red-500" />
                    <label for="immediateCancel" class="text-sm">Cancel immediately (otherwise at period end)</label>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason (required)</label>
                    <textarea id="cancelReason" rows="3" placeholder="Reason for cancellation..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-red-500 focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="cancelConfirm" class="rounded bg-slate-700 border-slate-600 text-red-500 focus:ring-red-500" />
                    <label for="cancelConfirm" class="text-sm text-red-300">I confirm this cancellation</label>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Go Back</button>
                    <button onclick="BillingLogic.submitCancel()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">Cancel Subscription</button>
                </div>
            </div>
        </div>

        <!-- Refund Modal -->
        <div id="refundModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Process Refund</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Invoice ID</label>
                    <input id="refundInvoice" type="text" placeholder="inv_..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-orange-500 focus:outline-none" />
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Amount ($)</label>
                    <input id="refundAmount" type="number" min="0.01" step="0.01" placeholder="0.00"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-orange-500 focus:outline-none" />
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason</label>
                    <textarea id="refundReason" rows="3" placeholder="Reason for refund..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-orange-500 focus:outline-none resize-none"></textarea>
                </div>
                <p class="text-xs text-amber-400">All refunds require approval before processing</p>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="BillingLogic.submitRefund()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm font-medium transition-colors">Submit Refund</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[60] space-y-2"></div>

    <!-- CDN Modules (ordered by dependency) -->
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-billing-config.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-billing-bridge.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-billing-render.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-billing-logic.js"></script>

    <!-- Bootstrap -->
    <script>
        BillingLogic.exposeGlobals();
        document.addEventListener('DOMContentLoaded', function () { BillingLogic.init(); });
    </script>
</body>

</html>
