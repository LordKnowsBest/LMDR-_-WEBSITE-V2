<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Billing Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lmdr: {
                            dark: '#0f172a',
                            blue: '#2563eb',
                            yellow: '#fbbf24',
                            canvas: '#f8fafc',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }

        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .touch-target { min-height: 44px; min-width: 44px; }
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .search-dropdown {
            max-height: 280px;
            overflow-y: auto;
        }

        .usage-bar-green { background: #22c55e; }
        .usage-bar-yellow { background: #eab308; }
        .usage-bar-red { background: #ef4444; }

        .status-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-paused { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-cancelling { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .status-pending { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-approved { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-rejected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    </style>
</head>

<body class="bg-slate-900 text-white font-sans">
    <div id="app" class="h-full flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex-shrink-0 bg-slate-800 border-b border-slate-700 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-xs font-bold">VM</div>
                    <h1 class="text-lg font-bold">Billing Management</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="pendingBadgeBtn" onclick="loadPendingApprovals()" class="relative touch-target touch-active flex items-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">
                        <span class="material-symbols-outlined text-base">pending_actions</span>
                        <span>Approvals</span>
                        <span id="pendingCount" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4">
            <!-- Search Bar -->
            <div class="relative">
                <div class="flex items-center bg-slate-800 border border-slate-700 rounded-lg px-3">
                    <span class="material-symbols-outlined text-slate-400">search</span>
                    <input id="searchInput" type="text"
                        placeholder="Search by DOT number, company name, or email..."
                        class="w-full bg-transparent border-none text-white placeholder-slate-400 px-3 py-3 text-sm focus:outline-none focus:ring-0"
                        oninput="handleSearchInput(this.value)" />
                    <button id="searchClear" class="hidden text-slate-400 hover:text-white" onclick="clearSearch()">
                        <span class="material-symbols-outlined text-base">close</span>
                    </button>
                </div>
                <div id="searchDropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-20 search-dropdown"></div>
            </div>

            <!-- Customer Details Panel (hidden until customer selected) -->
            <div id="customerPanel" class="hidden space-y-4">
                <!-- Customer Info Header -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left: Carrier Info -->
                        <div>
                            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Carrier Info</h3>
                            <div class="space-y-1.5">
                                <p class="text-base font-bold" id="carrierName">--</p>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">DOT:</span> <span id="carrierDot">--</span></p>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">Email:</span> <span id="carrierEmail">--</span></p>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">Phone:</span> <span id="carrierPhone">--</span></p>
                            </div>
                        </div>
                        <!-- Right: Subscription Info -->
                        <div>
                            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-2">Subscription</h3>
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2">
                                    <span id="planBadge" class="px-2 py-0.5 rounded text-xs font-semibold uppercase">--</span>
                                    <span id="statusBadge" class="px-2 py-0.5 rounded text-xs font-semibold">--</span>
                                </div>
                                <p class="text-sm text-slate-300"><span class="text-slate-500">Period:</span> <span id="periodDates">--</span></p>
                                <div class="mt-2">
                                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                                        <span>Usage</span>
                                        <span id="usageText">0 / 0</span>
                                    </div>
                                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div id="usageBar" class="h-full rounded-full transition-all duration-500 usage-bar-green" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="openModal('changePlan')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">swap_horiz</span> Change Plan
                    </button>
                    <button onclick="openModal('applyCredit')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">add_card</span> Apply Credit
                    </button>
                    <button onclick="openModal('pause')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">pause_circle</span> Pause
                    </button>
                    <button onclick="openModal('cancel')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">cancel</span> Cancel
                    </button>
                    <button onclick="openModal('refund')" class="touch-target touch-active flex items-center gap-1.5 px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-base">receipt_long</span> Refund
                    </button>
                </div>

                <!-- Billing History Table -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-700">
                        <h3 class="text-sm font-semibold">Billing History</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-slate-400 border-b border-slate-700">
                                    <th class="px-4 py-2 font-medium">Date</th>
                                    <th class="px-4 py-2 font-medium">Type</th>
                                    <th class="px-4 py-2 font-medium">Amount</th>
                                    <th class="px-4 py-2 font-medium">Status</th>
                                    <th class="px-4 py-2 font-medium">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billingHistoryBody">
                                <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">Select a customer to view billing history</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Adjustments Timeline -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-700">
                        <h3 class="text-sm font-semibold">Adjustments</h3>
                    </div>
                    <div id="adjustmentsTimeline" class="p-4 space-y-3">
                        <p class="text-sm text-slate-500 text-center py-4">No adjustments</p>
                    </div>
                </div>
            </div>

            <!-- Pending Approvals Panel -->
            <div id="approvalsPanel" class="hidden bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between cursor-pointer" onclick="toggleApprovals()">
                    <h3 class="text-sm font-semibold flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-amber-400">pending_actions</span>
                        Pending Approvals
                    </h3>
                    <span id="approvalsChevron" class="material-symbols-outlined text-base text-slate-400 transition-transform">expand_more</span>
                </div>
                <div id="approvalsContent" class="hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-400 border-b border-slate-700">
                                <th class="px-4 py-2 font-medium">Carrier</th>
                                <th class="px-4 py-2 font-medium">Type</th>
                                <th class="px-4 py-2 font-medium">Amount</th>
                                <th class="px-4 py-2 font-medium">Reason</th>
                                <th class="px-4 py-2 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="approvalsBody">
                            <tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Loading skeleton -->
            <div id="loadingSkeleton" class="hidden space-y-4">
                <div class="skeleton h-24 rounded-lg"></div>
                <div class="skeleton h-12 rounded-lg"></div>
                <div class="skeleton h-48 rounded-lg"></div>
            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <!-- Change Plan Modal -->
        <div id="changePlanModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Change Subscription Plan</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Select Plan</label>
                    <select id="newPlanSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="pro">Pro</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="immediateChange" class="rounded bg-slate-700 border-slate-600 text-blue-500 focus:ring-blue-500" />
                    <label for="immediateChange" class="text-sm">Apply immediately (with proration)</label>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="submitChangePlan()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">Confirm Change</button>
                </div>
            </div>
        </div>

        <!-- Apply Credit Modal -->
        <div id="applyCreditModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Apply Credit</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Amount ($)</label>
                    <input id="creditAmount" type="number" min="0.01" step="0.01" placeholder="0.00"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none"
                        oninput="checkCreditWarning()" />
                    <p id="creditWarning" class="hidden mt-1 text-xs text-amber-400">Credits over $100 require approval</p>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason</label>
                    <textarea id="creditReason" rows="3" placeholder="Reason for credit..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="submitCredit()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-sm font-medium transition-colors">Apply Credit</button>
                </div>
            </div>
        </div>

        <!-- Pause Modal -->
        <div id="pauseModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Pause Subscription</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Duration</label>
                    <select id="pauseDuration" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason</label>
                    <textarea id="pauseReason" rows="3" placeholder="Reason for pausing..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-yellow-500 focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="submitPause()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">Pause Subscription</button>
                </div>
            </div>
        </div>

        <!-- Cancel Modal -->
        <div id="cancelModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-red-400">Cancel Subscription</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="immediateCancel" class="rounded bg-slate-700 border-slate-600 text-red-500 focus:ring-red-500" />
                    <label for="immediateCancel" class="text-sm">Cancel immediately (otherwise at period end)</label>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason (required)</label>
                    <textarea id="cancelReason" rows="3" placeholder="Reason for cancellation..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-red-500 focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="cancelConfirm" class="rounded bg-slate-700 border-slate-600 text-red-500 focus:ring-red-500" />
                    <label for="cancelConfirm" class="text-sm text-red-300">I confirm this cancellation</label>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Go Back</button>
                    <button onclick="submitCancel()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">Cancel Subscription</button>
                </div>
            </div>
        </div>

        <!-- Refund Modal -->
        <div id="refundModal" class="hidden bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Process Refund</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Invoice ID</label>
                    <input id="refundInvoice" type="text" placeholder="inv_..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-orange-500 focus:outline-none" />
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Amount ($)</label>
                    <input id="refundAmount" type="number" min="0.01" step="0.01" placeholder="0.00"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-orange-500 focus:outline-none" />
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Reason</label>
                    <textarea id="refundReason" rows="3" placeholder="Reason for refund..."
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-orange-500 focus:outline-none resize-none"></textarea>
                </div>
                <p class="text-xs text-amber-400">All refunds require approval before processing</p>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Cancel</button>
                    <button onclick="submitRefund()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm font-medium transition-colors">Submit Refund</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[60] space-y-2"></div>

    <script>
        // ====================================================================
        // STATE
        // ====================================================================
        const state = {
            currentCustomer: null,
            billingHistory: [],
            adjustments: [],
            pendingApprovals: [],
            searchDebounce: null,
            approvalsOpen: false
        };

        // ====================================================================
        // POSTMESSAGE BRIDGE
        // ====================================================================
        function sendToVelo(data) {
            window.parent.postMessage(data, '*');
        }

        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (!msg || !msg.action) return;

            switch (msg.action) {
                case 'init':
                    loadPendingApprovals();
                    break;
                case 'searchResults':
                    renderSearchResults(msg.payload);
                    break;
                case 'customerLoaded':
                    renderCustomerDetails(msg.payload);
                    break;
                case 'billingHistoryLoaded':
                    renderBillingHistory(msg.payload);
                    break;
                case 'adjustmentsLoaded':
                    renderAdjustments(msg.payload);
                    break;
                case 'pendingApprovalsLoaded':
                    renderApprovals(msg.payload);
                    break;
                case 'actionSuccess':
                    showToast(msg.message, 'success');
                    refreshCurrentCustomer();
                    break;
                case 'actionError':
                    showToast(msg.message, 'error');
                    break;
            }
        });

        // ====================================================================
        // SEARCH
        // ====================================================================
        function handleSearchInput(value) {
            clearTimeout(state.searchDebounce);
            const clearBtn = document.getElementById('searchClear');

            if (value.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
                document.getElementById('searchDropdown').classList.add('hidden');
                return;
            }

            if (value.length < 2) return;

            state.searchDebounce = setTimeout(() => {
                sendToVelo({ action: 'searchCustomer', query: value });
            }, 300);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').classList.add('hidden');
            document.getElementById('searchDropdown').classList.add('hidden');
        }

        function renderSearchResults(payload) {
            const dropdown = document.getElementById('searchDropdown');
            const results = payload?.results || [];

            if (!results.length) {
                dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400">No results found</div>';
                dropdown.classList.remove('hidden');
                return;
            }

            dropdown.innerHTML = results.map(r => `
                <button class="w-full text-left px-4 py-3 hover:bg-slate-700 transition-colors border-b border-slate-700 last:border-0"
                    onclick="selectCustomer('${r.carrier_dot}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium">${r.company_name || 'DOT ' + r.carrier_dot}</p>
                            <p class="text-xs text-slate-400">DOT: ${r.carrier_dot}${r.email ? ' | ' + r.email : ''}</p>
                        </div>
                        ${r.status ? `<span class="status-${r.status} px-2 py-0.5 rounded text-xs font-medium">${r.status}</span>` : ''}
                    </div>
                </button>
            `).join('');

            dropdown.classList.remove('hidden');
        }

        function selectCustomer(dot) {
            document.getElementById('searchDropdown').classList.add('hidden');
            document.getElementById('loadingSkeleton').classList.remove('hidden');
            document.getElementById('customerPanel').classList.add('hidden');
            state.currentCustomer = dot;
            sendToVelo({ action: 'getBillingDetails', carrierDot: dot });
        }

        // ====================================================================
        // RENDER CUSTOMER DETAILS
        // ====================================================================
        function renderCustomerDetails(payload) {
            document.getElementById('loadingSkeleton').classList.add('hidden');
            document.getElementById('customerPanel').classList.remove('hidden');

            const carrier = payload?.carrier || {};
            const sub = payload?.subscription || {};

            document.getElementById('carrierName').textContent = carrier.company_name || 'Unknown Carrier';
            document.getElementById('carrierDot').textContent = state.currentCustomer || '--';
            document.getElementById('carrierEmail').textContent = carrier.email || '--';
            document.getElementById('carrierPhone').textContent = carrier.phone || '--';

            // Plan badge
            const planBadge = document.getElementById('planBadge');
            const plan = (sub.plan_type || 'free').toLowerCase();
            planBadge.textContent = plan;
            planBadge.className = plan === 'enterprise'
                ? 'px-2 py-0.5 rounded text-xs font-semibold uppercase bg-purple-500/20 text-purple-400'
                : plan === 'pro'
                    ? 'px-2 py-0.5 rounded text-xs font-semibold uppercase bg-blue-500/20 text-blue-400'
                    : 'px-2 py-0.5 rounded text-xs font-semibold uppercase bg-slate-500/20 text-slate-400';

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            const status = (sub.status || 'none').toLowerCase();
            statusBadge.textContent = status;
            statusBadge.className = `status-${status} px-2 py-0.5 rounded text-xs font-semibold`;

            // Period dates
            const start = sub.current_period_start ? new Date(sub.current_period_start).toLocaleDateString() : '--';
            const end = sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString() : '--';
            document.getElementById('periodDates').textContent = `${start} - ${end}`;

            // Usage bar
            const used = sub.views_used_this_month || 0;
            const limit = sub.monthly_view_quota || 0;
            const pct = limit > 0 ? Math.min(100, Math.round((used / limit) * 100)) : 0;
            document.getElementById('usageText').textContent = limit === -1 ? `${used} / Unlimited` : `${used} / ${limit}`;
            const usageBar = document.getElementById('usageBar');
            usageBar.style.width = limit === -1 ? '10%' : `${pct}%`;
            usageBar.className = `h-full rounded-full transition-all duration-500 ${pct > 80 ? 'usage-bar-red' : pct > 50 ? 'usage-bar-yellow' : 'usage-bar-green'}`;

            // Render billing history and adjustments
            if (payload?.billingHistory) renderBillingHistory({ history: payload.billingHistory });
            if (payload?.adjustments) renderAdjustments({ adjustments: payload.adjustments });
        }

        function renderBillingHistory(payload) {
            const body = document.getElementById('billingHistoryBody');
            const history = payload?.history || [];

            if (!history.length) {
                body.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">No billing history</td></tr>';
                return;
            }

            body.innerHTML = history.map(h => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                    <td class="px-4 py-2.5 text-xs">${h.timestamp ? new Date(h.timestamp).toLocaleDateString() : '--'}</td>
                    <td class="px-4 py-2.5 text-xs capitalize">${h.event_type || '--'}</td>
                    <td class="px-4 py-2.5 text-xs font-medium">${h.amount ? '$' + Number(h.amount).toFixed(2) : '--'}</td>
                    <td class="px-4 py-2.5"><span class="status-${(h.status || 'active').toLowerCase()} px-1.5 py-0.5 rounded text-xs">${h.status || 'completed'}</span></td>
                    <td class="px-4 py-2.5 text-xs">
                        ${h.invoice_id ? `<button class="text-blue-400 hover:underline text-xs" onclick="window.open('https://dashboard.stripe.com/invoices/${h.invoice_id}', '_blank')">View Invoice</button>` : '--'}
                    </td>
                </tr>
            `).join('');
        }

        function renderAdjustments(payload) {
            const container = document.getElementById('adjustmentsTimeline');
            const adjustments = payload?.adjustments || [];

            if (!adjustments.length) {
                container.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">No adjustments</p>';
                return;
            }

            container.innerHTML = adjustments.map(a => {
                const typeIcon = a.type === 'credit' ? 'add_card' : 'receipt_long';
                const typeColor = a.type === 'credit' ? 'text-emerald-400' : 'text-orange-400';
                return `
                    <div class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg">
                        <span class="material-symbols-outlined ${typeColor} mt-0.5">${typeIcon}</span>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-sm font-medium capitalize">${a.type || '--'}</span>
                                <span class="text-sm font-bold">$${Number(a.amount || 0).toFixed(2)}</span>
                                <span class="status-${(a.status || '').toLowerCase()} px-1.5 py-0.5 rounded text-xs">${a.status || '--'}</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-0.5">${a.reason || 'No reason provided'}</p>
                            <p class="text-xs text-slate-500 mt-0.5">${a.created_date ? new Date(a.created_date).toLocaleString() : '--'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ====================================================================
        // PENDING APPROVALS
        // ====================================================================
        function loadPendingApprovals() {
            sendToVelo({ action: 'getPendingApprovals' });
        }

        function renderApprovals(payload) {
            const pending = payload?.pending || [];
            state.pendingApprovals = pending;

            // Update badge count
            const badge = document.getElementById('pendingCount');
            if (pending.length > 0) {
                badge.textContent = pending.length;
                badge.classList.remove('hidden');
                document.getElementById('approvalsPanel').classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const body = document.getElementById('approvalsBody');
            if (!pending.length) {
                body.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">No pending approvals</td></tr>';
                return;
            }

            body.innerHTML = pending.map(p => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                    <td class="px-4 py-2.5 text-xs font-medium">${p.carrier_dot || '--'}</td>
                    <td class="px-4 py-2.5 text-xs capitalize">${p.type || '--'}</td>
                    <td class="px-4 py-2.5 text-xs font-bold">$${Number(p.amount || 0).toFixed(2)}</td>
                    <td class="px-4 py-2.5 text-xs text-slate-400 max-w-[150px] truncate">${p.reason || '--'}</td>
                    <td class="px-4 py-2.5 flex gap-1">
                        <button onclick="handleApprove('${p._id}')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 rounded text-xs transition-colors">Approve</button>
                        <button onclick="handleReject('${p._id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors">Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleApprovals() {
            state.approvalsOpen = !state.approvalsOpen;
            document.getElementById('approvalsContent').classList.toggle('hidden', !state.approvalsOpen);
            document.getElementById('approvalsChevron').style.transform = state.approvalsOpen ? 'rotate(180deg)' : '';
        }

        function handleApprove(id) {
            sendToVelo({ action: 'approveAdjustment', adjustmentId: id });
        }

        function handleReject(id) {
            const notes = prompt('Rejection reason:');
            if (notes === null) return;
            sendToVelo({ action: 'rejectAdjustment', adjustmentId: id, notes });
        }

        // ====================================================================
        // MODALS
        // ====================================================================
        function openModal(type) {
            if (!state.currentCustomer) {
                showToast('Select a customer first', 'error');
                return;
            }
            document.getElementById('modalOverlay').classList.remove('hidden');
            const modals = ['changePlanModal', 'applyCreditModal', 'pauseModal', 'cancelModal', 'refundModal'];
            modals.forEach(m => document.getElementById(m).classList.add('hidden'));

            const modalMap = {
                changePlan: 'changePlanModal',
                applyCredit: 'applyCreditModal',
                pause: 'pauseModal',
                cancel: 'cancelModal',
                refund: 'refundModal'
            };
            if (modalMap[type]) document.getElementById(modalMap[type]).classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function checkCreditWarning() {
            const amount = parseFloat(document.getElementById('creditAmount').value) || 0;
            document.getElementById('creditWarning').classList.toggle('hidden', amount <= 100);
        }

        // ====================================================================
        // MODAL SUBMIT HANDLERS
        // ====================================================================
        function submitChangePlan() {
            const newPlan = document.getElementById('newPlanSelect').value;
            const immediate = document.getElementById('immediateChange').checked;
            sendToVelo({ action: 'changePlan', carrierDot: state.currentCustomer, newPlan, immediate });
            closeModal();
        }

        function submitCredit() {
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const reason = document.getElementById('creditReason').value.trim();
            if (!amount || amount <= 0) { showToast('Enter a valid amount', 'error'); return; }
            if (!reason) { showToast('Reason is required', 'error'); return; }
            sendToVelo({ action: 'applyCredit', carrierDot: state.currentCustomer, amount, reason });
            closeModal();
        }

        function submitPause() {
            const days = parseInt(document.getElementById('pauseDuration').value);
            const reason = document.getElementById('pauseReason').value.trim();
            sendToVelo({ action: 'pauseSubscription', carrierDot: state.currentCustomer, days, reason });
            closeModal();
        }

        function submitCancel() {
            const reason = document.getElementById('cancelReason').value.trim();
            const confirmed = document.getElementById('cancelConfirm').checked;
            if (!reason) { showToast('Reason is required', 'error'); return; }
            if (!confirmed) { showToast('Please confirm the cancellation', 'error'); return; }
            const immediate = document.getElementById('immediateCancel').checked;
            sendToVelo({ action: 'cancelSubscription', carrierDot: state.currentCustomer, immediate, reason });
            closeModal();
        }

        function submitRefund() {
            const invoiceId = document.getElementById('refundInvoice').value.trim();
            const amount = parseFloat(document.getElementById('refundAmount').value);
            const reason = document.getElementById('refundReason').value.trim();
            if (!invoiceId) { showToast('Invoice ID is required', 'error'); return; }
            if (!amount || amount <= 0) { showToast('Enter a valid amount', 'error'); return; }
            if (!reason) { showToast('Reason is required', 'error'); return; }
            sendToVelo({ action: 'processRefund', carrierDot: state.currentCustomer, invoiceId, amount, reason });
            closeModal();
        }

        // ====================================================================
        // UTILITIES
        // ====================================================================
        function refreshCurrentCustomer() {
            if (state.currentCustomer) {
                sendToVelo({ action: 'getBillingDetails', carrierDot: state.currentCustomer });
            }
            loadPendingApprovals();
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = {
                success: 'bg-emerald-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            const icons = {
                success: 'check_circle',
                error: 'error',
                info: 'info'
            };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info} px-4 py-3 rounded-lg shadow-xl flex items-center gap-2 text-sm max-w-sm`;
            toast.innerHTML = `<span class="material-symbols-outlined text-base">${icons[type] || icons.info}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        // Close search dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#searchInput') && !e.target.closest('#searchDropdown')) {
                document.getElementById('searchDropdown').classList.add('hidden');
            }
        });
    </script>
</body>

</html>
