<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    lmdr: {
                        dark: '#0f172a',
                        blue: '#2563eb',
                        yellow: '#fbbf24',
                        canvas: '#f8fafc',
                    }
                },
                animation: {
                    'float': 'float 6s ease-in-out infinite',
                },
                keyframes: {
                    float: {
                        '0%, 100%': { transform: 'translateY(0)' },
                        '50%': { transform: 'translateY(-10px)' },
                    }
                }
            }
        }
    }
</script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }

        .touch-active:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        @supports (padding: max(0px)) {
            .safe-bottom {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }

            .safe-top {
                padding-top: max(16px, env(safe-area-inset-top));
            }
        }

        .health-healthy {
            color: #22c55e;
        }

        .health-degraded {
            color: #eab308;
        }

        .health-unhealthy {
            color: #ef4444;
        }

        /* Feature Adoption Styles */
        .feature-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .health-badge-healthy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .health-badge-warning {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .health-badge-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-badge-beta {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .status-badge-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-badge-deprecated {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .status-badge-sunset {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .at-risk-alert {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .at-risk-warning {
            border-left: 4px solid #eab308;
            background: rgba(234, 179, 8, 0.1);
        }

        .funnel-step {
            position: relative;
        }

        .funnel-step::after {
            content: '';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 8px solid #475569;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        .funnel-step:last-child::after {
            display: none;
        }

        .funnel-bar {
            transition: width 0.5s ease-out;
        }

        .tab-active {
            background: #2563eb;
            color: white;
        }

        .tab-inactive {
            background: transparent;
            color: #94a3b8;
        }

        .tab-inactive:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .alert-critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .alert-warning {
            border-left-color: #eab308;
            background: rgba(234, 179, 8, 0.1);
        }

        .alert-info {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .nav-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .nav-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .nav-card:active {
            transform: scale(0.98);
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Light mode overrides */
        html.light .bg-surface-dark {
            background-color: #ffffff;
        }

        html.light .bg-surface-darker {
            background-color: #f1f5f9;
        }

        html.light .border-border-dark {
            border-color: #e2e8f0;
        }

        html.light .text-text-muted {
            color: #64748b;
        }

        html.light .bg-background-dark {
            background-color: #f8fafc;
        }

        html.light .nav-card {
            background-color: #ffffff;
            border-color: #e2e8f0;
        }

        html.light .nav-card:hover {
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        html.light .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        html.light .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        html.light .alert-critical {
            background: rgba(239, 68, 68, 0.05);
        }

        html.light .alert-warning {
            background: rgba(234, 179, 8, 0.05);
        }

        html.light .alert-info {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Smooth transitions */
        .bg-surface-dark,
        .bg-surface-darker,
        .border-border-dark,
        .bg-background-dark,
        .nav-card,
        body {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
    </style>
</head>

<body
    class="font-display antialiased transition-colors duration-300 bg-background-dark dark:bg-background-dark dark:text-white text-text-dark">

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <!-- Main Container -->
    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-4 safe-top">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl md:text-2xl font-black tracking-tight">Admin Dashboard</h1>
                    <p class="text-xs md:text-sm text-text-muted mt-0.5">System overview and management</p>
                </div>
                <div class="flex items-center gap-2 md:gap-3">
                    <!-- Health Indicator -->
                    <div id="healthIndicator"
                        class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface-dark dark:bg-surface-dark bg-surface-light border border-border-dark dark:border-border-dark border-border-light">
                        <span class="w-2 h-2 rounded-full bg-emerald-400 pulse-dot"></span>
                        <span class="text-xs font-medium text-emerald-400">Healthy</span>
                    </div>
                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()"
                        class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark dark:bg-surface-dark bg-surface-light border border-border-dark dark:border-border-dark border-border-light hover:bg-slate-700 dark:hover:bg-slate-700 hover:bg-slate-100 transition-colors"
                        title="Toggle light/dark mode">
                        <span id="themeIconSun"
                            class="material-symbols-outlined text-[20px] text-amber-400 hidden">light_mode</span>
                        <span id="themeIconMoon"
                            class="material-symbols-outlined text-[20px] text-slate-400">dark_mode</span>
                    </button>
                    <!-- Refresh Button -->
                    <button onclick="refreshDashboard()"
                        class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark dark:bg-surface-dark bg-surface-light border border-border-dark dark:border-border-dark border-border-light hover:bg-slate-700 dark:hover:bg-slate-700 hover:bg-slate-100 transition-colors">
                        <span class="material-symbols-outlined text-[20px]">refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="px-4 md:px-6 py-4 md:py-6 space-y-4 md:space-y-6">

                <!-- Quick Stats Row - Mobile Scrollable -->
                <div
                    class="flex md:grid md:grid-cols-4 gap-3 md:gap-4 overflow-x-auto scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0 pb-1">
                    <!-- Drivers Card -->
                    <div onclick="navigateTo('drivers')"
                        class="nav-card flex-shrink-0 w-40 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-4 cursor-pointer">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 bg-violet-500/20 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-violet-400">person</span>
                            </div>
                            <span class="material-symbols-outlined text-text-muted text-[18px]">arrow_forward</span>
                        </div>
                        <div class="text-2xl font-bold" id="statDrivers">--</div>
                        <div class="text-xs text-text-muted">Total Drivers</div>
                        <div class="flex items-center gap-1 mt-2 text-xs">
                            <span class="text-emerald-400" id="statDriversNew">+0</span>
                            <span class="text-text-muted">this week</span>
                        </div>
                    </div>

                    <!-- Carriers Card -->
                    <div onclick="navigateTo('carriers')"
                        class="nav-card flex-shrink-0 w-40 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-4 cursor-pointer">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-blue-400">local_shipping</span>
                            </div>
                            <span class="material-symbols-outlined text-text-muted text-[18px]">arrow_forward</span>
                        </div>
                        <div class="text-2xl font-bold" id="statCarriers">--</div>
                        <div class="text-xs text-text-muted">Total Carriers</div>
                        <div class="flex items-center gap-1 mt-2 text-xs">
                            <span class="text-emerald-400" id="statCarriersNew">+0</span>
                            <span class="text-text-muted">this week</span>
                        </div>
                    </div>

                    <!-- Matches Card -->
                    <div
                        class="nav-card flex-shrink-0 w-40 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-4 cursor-pointer">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-emerald-400">handshake</span>
                            </div>
                            <span class="material-symbols-outlined text-text-muted text-[18px]">trending_up</span>
                        </div>
                        <div class="text-2xl font-bold" id="statMatches">--</div>
                        <div class="text-xs text-text-muted">Matches Today</div>
                        <div class="flex items-center gap-1 mt-2 text-xs">
                            <span class="text-text-muted" id="statMatchesWeek">0 this week</span>
                        </div>
                    </div>

                    <!-- Needs Attention Card -->
                    <div
                        class="nav-card flex-shrink-0 w-40 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-4 cursor-pointer">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-amber-400">warning</span>
                            </div>
                            <span id="attentionBadge"
                                class="hidden px-2 py-0.5 bg-amber-500 text-white text-[10px] font-bold rounded-full">!</span>
                        </div>
                        <div class="text-2xl font-bold" id="statAttention">--</div>
                        <div class="text-xs text-text-muted">Needs Attention</div>
                        <div class="flex items-center gap-1 mt-2 text-xs text-amber-400" id="attentionBreakdown">
                            --
                        </div>
                    </div>

                    <!-- AI/LLM Usage Card -->
                    <div onclick="scrollToAIUsage()"
                        class="nav-card flex-shrink-0 w-40 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-4 cursor-pointer">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 bg-cyan-500/20 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-cyan-400">smart_toy</span>
                            </div>
                            <span id="aiBudgetBadge"
                                class="hidden px-2 py-0.5 bg-amber-500 text-white text-[10px] font-bold rounded-full">$</span>
                        </div>
                        <div class="text-2xl font-bold" id="statAICost">$--</div>
                        <div class="text-xs text-text-muted">AI Spend (Week)</div>
                        <div class="flex items-center gap-1 mt-2 text-xs" id="aiTokenCount">
                            <span class="text-cyan-400">--</span>
                            <span class="text-text-muted">tokens</span>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">

                    <!-- Left Column: Activity Chart + Quick Actions -->
                    <div class="lg:col-span-2 space-y-4 md:space-y-6">

                        <!-- Activity Chart -->
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-base md:text-lg font-bold">Activity Overview</h2>
                                <div class="flex gap-1 bg-surface-darker rounded-lg p-1">
                                    <button onclick="loadChartData('week')" id="chartWeekBtn"
                                        class="px-3 py-1.5 text-xs font-medium rounded-md bg-primary text-white">Week</button>
                                    <button onclick="loadChartData('month')" id="chartMonthBtn"
                                        class="px-3 py-1.5 text-xs font-medium rounded-md text-text-muted hover:text-white">Month</button>
                                </div>
                            </div>
                            <div class="h-48 md:h-64">
                                <canvas id="activityChart"></canvas>
                            </div>
                            <div class="flex justify-center gap-6 mt-4 text-xs">
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-emerald-400"></span>
                                    <span class="text-text-muted">Matches</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-violet-400"></span>
                                    <span class="text-text-muted">New Drivers</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Navigation Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button onclick="navigateTo('drivers')"
                                class="nav-card bg-surface-dark border border-border-dark rounded-xl p-4 text-left">
                                <span class="material-symbols-outlined text-violet-400 mb-2">manage_accounts</span>
                                <div class="text-sm font-semibold">Manage Drivers</div>
                                <div class="text-xs text-text-muted mt-1">Verify, suspend, review</div>
                            </button>
                            <button onclick="navigateTo('carriers')"
                                class="nav-card bg-surface-dark border border-border-dark rounded-xl p-4 text-left">
                                <span class="material-symbols-outlined text-blue-400 mb-2">inventory_2</span>
                                <div class="text-sm font-semibold">Manage Carriers</div>
                                <div class="text-xs text-text-muted mt-1">Enrichment, flags</div>
                            </button>
                            <button onclick="navigateTo('audit-log')"
                                class="nav-card bg-surface-dark border border-border-dark rounded-xl p-4 text-left">
                                <span class="material-symbols-outlined text-amber-400 mb-2">history</span>
                                <div class="text-sm font-semibold">Audit Log</div>
                                <div class="text-xs text-text-muted mt-1">Admin activity</div>
                            </button>
                            <button onclick="navigateTo('settings')"
                                class="nav-card bg-surface-dark border border-border-dark rounded-xl p-4 text-left">
                                <span class="material-symbols-outlined text-slate-400 mb-2">settings</span>
                                <div class="text-sm font-semibold">Settings</div>
                                <div class="text-xs text-text-muted mt-1">System config</div>
                            </button>
                            <button onclick="navigateTo('ai-router')"
                                class="nav-card bg-surface-dark border border-border-dark rounded-xl p-4 text-left">
                                <span class="material-symbols-outlined text-cyan-400 mb-2">smart_toy</span>
                                <div class="text-sm font-semibold">AI Router</div>
                                <div class="text-xs text-text-muted mt-1">LLM configuration</div>
                            </button>
                        </div>

                        <!-- Enrichment Status -->
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-base md:text-lg font-bold">Enrichment Status</h2>
                                <span class="text-xs text-text-muted" id="enrichmentCoverage">--% coverage</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="text-center p-3 bg-surface-darker rounded-lg">
                                    <div class="text-xl md:text-2xl font-bold text-emerald-400" id="enrichmentFresh">--
                                    </div>
                                    <div class="text-[10px] md:text-xs text-text-muted">Fresh (&lt;7d)</div>
                                </div>
                                <div class="text-center p-3 bg-surface-darker rounded-lg">
                                    <div class="text-xl md:text-2xl font-bold text-amber-400" id="enrichmentStale">--
                                    </div>
                                    <div class="text-[10px] md:text-xs text-text-muted">Stale (7-14d)</div>
                                </div>
                                <div class="text-center p-3 bg-surface-darker rounded-lg">
                                    <div class="text-xl md:text-2xl font-bold text-rose-400" id="enrichmentExpired">--
                                    </div>
                                    <div class="text-[10px] md:text-xs text-text-muted">Expired (&gt;14d)</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI/LLM Usage Panel -->
                        <div id="aiUsagePanel" class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-cyan-400">smart_toy</span>
                                    <h2 class="text-base md:text-lg font-bold">AI/LLM Usage</h2>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex gap-1 bg-surface-darker rounded-lg p-1">
                                        <button onclick="loadAIUsage('day')" id="aiDayBtn"
                                            class="px-2 py-1 text-[10px] font-medium rounded text-text-muted hover:text-white">24h</button>
                                        <button onclick="loadAIUsage('week')" id="aiWeekBtn"
                                            class="px-2 py-1 text-[10px] font-medium rounded bg-primary text-white">Week</button>
                                        <button onclick="loadAIUsage('month')" id="aiMonthBtn"
                                            class="px-2 py-1 text-[10px] font-medium rounded text-text-muted hover:text-white">Month</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Budget Status Bar -->
                            <div id="aiBudgetStatus" class="mb-4 p-3 rounded-lg bg-surface-darker">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs text-text-muted">Monthly Budget</span>
                                    <span class="text-xs font-medium" id="aiBudgetPercent">--% of $100</span>
                                </div>
                                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div id="aiBudgetBar"
                                        class="h-full bg-cyan-400 rounded-full transition-all duration-500"
                                        style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between mt-1 text-[10px] text-text-muted">
                                    <span>$0</span>
                                    <span id="aiBudgetProjection">Projected: $--</span>
                                    <span>$100</span>
                                </div>
                            </div>

                            <!-- Summary Stats -->
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                <div class="text-center p-2 bg-surface-darker rounded-lg">
                                    <div class="text-lg font-bold text-cyan-400" id="aiTotalCost">$--</div>
                                    <div class="text-[9px] text-text-muted">Total Cost</div>
                                </div>
                                <div class="text-center p-2 bg-surface-darker rounded-lg">
                                    <div class="text-lg font-bold text-violet-400" id="aiTotalTokens">--</div>
                                    <div class="text-[9px] text-text-muted">Tokens</div>
                                </div>
                                <div class="text-center p-2 bg-surface-darker rounded-lg">
                                    <div class="text-lg font-bold text-emerald-400" id="aiTotalRequests">--</div>
                                    <div class="text-[9px] text-text-muted">Requests</div>
                                </div>
                                <div class="text-center p-2 bg-surface-darker rounded-lg">
                                    <div class="text-lg font-bold" id="aiAvgLatency">--</div>
                                    <div class="text-[9px] text-text-muted">Avg Latency</div>
                                </div>
                            </div>

                            <!-- Cost by Provider -->
                            <div class="mb-4">
                                <h3 class="text-xs font-semibold text-text-muted mb-2">Cost by Provider</h3>
                                <div id="aiProviderBars" class="space-y-2">
                                    <!-- Rendered dynamically -->
                                    <div class="text-center py-3 text-text-muted text-xs">Loading...</div>
                                </div>
                            </div>

                            <!-- Usage Chart -->
                            <div class="mb-4">
                                <h3 class="text-xs font-semibold text-text-muted mb-2">Usage Trend</h3>
                                <div class="h-32">
                                    <canvas id="aiUsageChart"></canvas>
                                </div>
                            </div>

                            <!-- Function Breakdown -->
                            <div>
                                <h3 class="text-xs font-semibold text-text-muted mb-2">Usage by Function</h3>
                                <div id="aiFunctionList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin">
                                    <!-- Rendered dynamically -->
                                    <div class="text-center py-3 text-text-muted text-xs">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Alerts + Activity Feed -->
                    <div class="space-y-4 md:space-y-6">

                        <!-- System Alerts -->
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-base md:text-lg font-bold">System Alerts</h2>
                                <span id="alertCount"
                                    class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs font-bold rounded-full">0</span>
                            </div>
                            <div id="alertsList" class="space-y-3 max-h-64 overflow-y-auto scrollbar-thin">
                                <div class="text-center py-6 text-text-muted text-sm">
                                    <span class="material-symbols-outlined text-3xl mb-2 block">check_circle</span>
                                    No alerts
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-base md:text-lg font-bold">Recent Activity</h2>
                                <span class="text-xs text-text-muted">Last 15 events</span>
                            </div>
                            <div id="activityFeed" class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin">
                                <div class="text-center py-6 text-text-muted text-sm">
                                    Loading activity...
                                </div>
                            </div>
                        </div>

                        <!-- Platform Health -->
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-base md:text-lg font-bold">Platform Health</h2>
                                <span id="healthStatus"
                                    class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs font-bold rounded-full">Healthy</span>
                            </div>
                            <div id="servicesList" class="space-y-2">
                                <!-- Services rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- FEATURE ADOPTION SECTION (Full Width)        -->
                <!-- ============================================ -->
                <div id="featureAdoptionSection" class="bg-surface-dark border border-border-dark rounded-xl p-4 md:p-6">
                    <!-- Section Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-purple-400">analytics</span>
                            </div>
                            <div>
                                <h2 class="text-lg md:text-xl font-bold">Feature Adoption Dashboard</h2>
                                <p class="text-xs text-text-muted">Track feature lifecycle, health scores, and conversion funnels</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Time Range Selector -->
                            <div class="flex gap-1 bg-surface-darker rounded-lg p-1">
                                <button onclick="setFeatureTimeRange(7)" id="featRange7d"
                                    class="px-2 py-1 text-[10px] font-medium rounded tab-active">7d</button>
                                <button onclick="setFeatureTimeRange(14)" id="featRange14d"
                                    class="px-2 py-1 text-[10px] font-medium rounded tab-inactive">14d</button>
                                <button onclick="setFeatureTimeRange(30)" id="featRange30d"
                                    class="px-2 py-1 text-[10px] font-medium rounded tab-inactive">30d</button>
                            </div>
                            <!-- Refresh Button -->
                            <button onclick="refreshFeatureAdoption()"
                                class="p-2 bg-surface-darker rounded-lg hover:bg-slate-700 transition-colors"
                                title="Refresh data">
                                <span class="material-symbols-outlined text-[18px]">refresh</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="flex gap-1 bg-surface-darker rounded-lg p-1 mb-6 overflow-x-auto">
                        <button onclick="setFeatureTab('overview')" id="featTabOverview"
                            class="flex-1 md:flex-none px-4 py-2 text-xs font-medium rounded-md tab-active whitespace-nowrap">
                            <span class="material-symbols-outlined text-[14px] mr-1 align-middle">dashboard</span>
                            Overview
                        </button>
                        <button onclick="setFeatureTab('funnels')" id="featTabFunnels"
                            class="flex-1 md:flex-none px-4 py-2 text-xs font-medium rounded-md tab-inactive whitespace-nowrap">
                            <span class="material-symbols-outlined text-[14px] mr-1 align-middle">filter_alt</span>
                            Funnels
                        </button>
                        <button onclick="setFeatureTab('at-risk')" id="featTabAtRisk"
                            class="flex-1 md:flex-none px-4 py-2 text-xs font-medium rounded-md tab-inactive whitespace-nowrap">
                            <span class="material-symbols-outlined text-[14px] mr-1 align-middle">warning</span>
                            At-Risk
                            <span id="atRiskBadge" class="hidden ml-1 px-1.5 py-0.5 bg-rose-500 text-white text-[9px] font-bold rounded-full">0</span>
                        </button>
                    </div>

                    <!-- Overview Tab Content -->
                    <div id="featContentOverview" class="space-y-6">
                        <!-- Summary Stats Row -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="p-4 bg-surface-darker rounded-xl text-center">
                                <div class="text-2xl md:text-3xl font-bold text-purple-400" id="featTotalFeatures">--</div>
                                <div class="text-xs text-text-muted">Total Features</div>
                            </div>
                            <div class="p-4 bg-surface-darker rounded-xl text-center">
                                <div class="text-2xl md:text-3xl font-bold text-emerald-400" id="featHealthyCount">--</div>
                                <div class="text-xs text-text-muted">Healthy (70+)</div>
                            </div>
                            <div class="p-4 bg-surface-darker rounded-xl text-center">
                                <div class="text-2xl md:text-3xl font-bold text-amber-400" id="featWarningCount">--</div>
                                <div class="text-xs text-text-muted">Warning (40-69)</div>
                            </div>
                            <div class="p-4 bg-surface-darker rounded-xl text-center">
                                <div class="text-2xl md:text-3xl font-bold text-rose-400" id="featCriticalCount">--</div>
                                <div class="text-xs text-text-muted">Critical (&lt;40)</div>
                            </div>
                        </div>

                        <!-- Charts Row -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Lifecycle Status Distribution (Donut Chart) -->
                            <div class="bg-surface-darker rounded-xl p-4">
                                <h3 class="text-sm font-semibold mb-4">Lifecycle Status Distribution</h3>
                                <div class="flex items-center justify-center">
                                    <div class="relative w-48 h-48">
                                        <canvas id="featureStatusChart"></canvas>
                                        <div class="donut-center">
                                            <div class="text-2xl font-bold" id="featStatusTotal">--</div>
                                            <div class="text-[10px] text-text-muted">Features</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-wrap justify-center gap-3 mt-4">
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full bg-violet-400"></span>
                                        <span class="text-[10px] text-text-muted">Beta</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full bg-emerald-400"></span>
                                        <span class="text-[10px] text-text-muted">Active</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full bg-amber-400"></span>
                                        <span class="text-[10px] text-text-muted">Deprecated</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full bg-rose-400"></span>
                                        <span class="text-[10px] text-text-muted">Sunset</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Health Score Distribution -->
                            <div class="bg-surface-darker rounded-xl p-4">
                                <h3 class="text-sm font-semibold mb-4">Health Score Distribution</h3>
                                <div class="h-48">
                                    <canvas id="featureHealthChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Feature Health Grid -->
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-semibold">Feature Health Overview</h3>
                                <div class="flex gap-2">
                                    <select id="featFilterStatus" onchange="filterFeatures()"
                                        class="px-2 py-1 text-xs bg-surface-darker border border-border-dark rounded-lg text-text-muted">
                                        <option value="all">All Statuses</option>
                                        <option value="beta">Beta</option>
                                        <option value="active">Active</option>
                                        <option value="deprecated">Deprecated</option>
                                        <option value="sunset">Sunset</option>
                                    </select>
                                    <select id="featSortBy" onchange="sortFeatures()"
                                        class="px-2 py-1 text-xs bg-surface-darker border border-border-dark rounded-lg text-text-muted">
                                        <option value="health-desc">Health (High to Low)</option>
                                        <option value="health-asc">Health (Low to High)</option>
                                        <option value="users-desc">Users (High to Low)</option>
                                        <option value="name-asc">Name (A-Z)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="featureHealthGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 max-h-96 overflow-y-auto scrollbar-thin pr-2">
                                <div class="col-span-full text-center py-8 text-text-muted text-sm">
                                    <span class="material-symbols-outlined text-4xl mb-2 block">hourglass_empty</span>
                                    Loading features...
                                </div>
                            </div>
                        </div>

                        <!-- Top/Bottom Features Table -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Top Performers -->
                            <div class="bg-surface-darker rounded-xl p-4">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="material-symbols-outlined text-emerald-400 text-[18px]">trending_up</span>
                                    <h3 class="text-sm font-semibold">Top Performers</h3>
                                </div>
                                <div id="topFeaturesTable" class="space-y-2">
                                    <div class="text-center py-4 text-text-muted text-xs">Loading...</div>
                                </div>
                            </div>

                            <!-- Bottom Performers -->
                            <div class="bg-surface-darker rounded-xl p-4">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="material-symbols-outlined text-rose-400 text-[18px]">trending_down</span>
                                    <h3 class="text-sm font-semibold">Needs Attention</h3>
                                </div>
                                <div id="bottomFeaturesTable" class="space-y-2">
                                    <div class="text-center py-4 text-text-muted text-xs">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Funnels Tab Content -->
                    <div id="featContentFunnels" class="hidden space-y-6">
                        <!-- Funnel Selector -->
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="flex-1">
                                <label class="text-xs text-text-muted block mb-1">Select Funnel</label>
                                <select id="funnelSelector" onchange="loadFunnelData(this.value)"
                                    class="w-full px-3 py-2 bg-surface-darker border border-border-dark rounded-lg text-sm">
                                    <option value="">-- Select a funnel --</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="refreshFunnelList()"
                                    class="px-3 py-2 bg-surface-darker border border-border-dark rounded-lg text-xs hover:bg-slate-700 transition-colors">
                                    <span class="material-symbols-outlined text-[14px] mr-1 align-middle">refresh</span>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Funnel Visualization -->
                        <div id="funnelVisualization" class="bg-surface-darker rounded-xl p-6">
                            <div class="text-center py-12 text-text-muted">
                                <span class="material-symbols-outlined text-5xl mb-3 block">filter_alt</span>
                                <p class="text-sm">Select a funnel to view conversion data</p>
                            </div>
                        </div>

                        <!-- Funnel Details -->
                        <div id="funnelDetails" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-surface-darker rounded-xl p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-400" id="funnelTotalEntered">--</div>
                                    <div class="text-xs text-text-muted">Total Entered</div>
                                </div>
                                <div class="bg-surface-darker rounded-xl p-4 text-center">
                                    <div class="text-2xl font-bold text-emerald-400" id="funnelTotalCompleted">--</div>
                                    <div class="text-xs text-text-muted">Completed</div>
                                </div>
                                <div class="bg-surface-darker rounded-xl p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-400" id="funnelConversionRate">--%</div>
                                    <div class="text-xs text-text-muted">Overall Conversion</div>
                                </div>
                            </div>

                            <!-- Funnel Steps Table -->
                            <div class="bg-surface-darker rounded-xl p-4">
                                <h4 class="text-sm font-semibold mb-4">Step-by-Step Analysis</h4>
                                <div id="funnelStepsTable" class="space-y-3">
                                    <!-- Rendered dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- At-Risk Tab Content -->
                    <div id="featContentAtRisk" class="hidden space-y-6">
                        <!-- At-Risk Alert Banner -->
                        <div id="atRiskAlertBanner" class="at-risk-alert rounded-xl p-4 hidden">
                            <div class="flex items-start gap-3">
                                <span class="material-symbols-outlined text-rose-400 text-2xl">error</span>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-rose-400">Critical Features Detected</h4>
                                    <p class="text-sm text-text-muted mt-1" id="atRiskAlertMessage">
                                        Some features are below retirement threshold and require immediate attention.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- At-Risk Features List -->
                        <div id="atRiskFeaturesList" class="space-y-4">
                            <div class="text-center py-12 text-text-muted">
                                <span class="material-symbols-outlined text-5xl mb-3 block text-emerald-400">verified</span>
                                <p class="text-sm">No at-risk features detected</p>
                                <p class="text-xs mt-1">All features are performing within healthy thresholds</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Spacer for Mobile -->
                <div class="h-4 md:h-0"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let state = {
            dashboard: null,
            chartPeriod: 'week',
            chart: null,
            aiUsage: null,
            aiUsageChart: null,
            aiUsagePeriod: 'week',
            // Feature Adoption state
            featureAdoption: {
                lifecycleReport: null,
                atRiskFeatures: null,
                funnels: null,
                selectedFunnel: null,
                funnelData: null,
                timeRange: 7, // days
                activeTab: 'overview', // overview, funnels, at-risk
                statusChart: null,
                healthChart: null
            }
        };

        const VALID_ACTIONS = [
            'dashboardLoaded', 'chartDataLoaded',
            'actionSuccess', 'actionError', 'init',
            'aiUsageLoaded', 'aiHealthLoaded', 'featureStatsLoaded',
            // Feature Adoption Log actions
            'featureLifecycleReportResult', 'featureStatsResult',
            'atRiskFeaturesResult', 'funnelConversionResult',
            'updateFeatureStatusResult', 'funnelsListResult'
        ];

        function isValidMessage(data) {
            return data && typeof data === 'object' &&
                typeof data.action === 'string' &&
                VALID_ACTIONS.includes(data.action);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('message', handleMessage);

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initChart();
            initAIUsageChart();
            initFeatureAdoptionCharts();
            sendToVelo({ action: 'getDashboard' });
            sendToVelo({ action: 'getAIUsage', period: 'week' });
            sendToVelo({ action: 'getFeatureStats' });
            // Load Feature Adoption data
            loadFeatureAdoptionData();
        });

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        const THEME_KEY = 'lmdr-admin-theme';

        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'dark'); // Default to dark for admin

            applyTheme(theme);

            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            const body = document.body;

            if (theme === 'dark') {
                html.classList.add('dark');
                html.classList.remove('light');
                body.classList.add('bg-background-dark', 'text-white');
                body.classList.remove('bg-background-light', 'text-text-dark');
                document.getElementById('themeIconSun').classList.remove('hidden');
                document.getElementById('themeIconMoon').classList.add('hidden');
            } else {
                html.classList.remove('dark');
                html.classList.add('light');
                body.classList.remove('bg-background-dark', 'text-white');
                body.classList.add('bg-background-light', 'text-text-dark');
                document.getElementById('themeIconSun').classList.add('hidden');
                document.getElementById('themeIconMoon').classList.remove('hidden');
            }
        }

        function toggleTheme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
            showToast(`Switched to ${newTheme} mode`, 'info');
        }

        function sendToVelo(message) {
            window.parent.postMessage(message, '*');
        }

        // ============================================
        // MESSAGE HANDLING
        // ============================================
        function handleMessage(event) {
            const data = event.data;
            if (!isValidMessage(data)) return;

            switch (data.action) {
                case 'init':
                    sendToVelo({ action: 'getDashboard' });
                    break;
                case 'dashboardLoaded':
                    handleDashboardLoaded(data.payload);
                    break;
                case 'chartDataLoaded':
                    updateChart(data.payload);
                    break;
                case 'actionSuccess':
                    showToast(data.message || 'Action completed', 'success');
                    break;
                case 'actionError':
                    showToast(data.message || 'An error occurred', 'error');
                    break;
                case 'aiUsageLoaded':
                    handleAIUsageLoaded(data.payload);
                    break;
                case 'aiHealthLoaded':
                    handleAIHealthLoaded(data.payload);
                    break;
                case 'featureStatsLoaded':
                    handleFeatureStatsLoaded(data.payload);
                    break;
                // Feature Adoption Log handlers
                case 'featureLifecycleReportResult':
                    handleFeatureLifecycleReport(data.payload);
                    break;
                case 'featureStatsResult':
                    handleFeatureStatsResult(data.payload);
                    break;
                case 'atRiskFeaturesResult':
                    handleAtRiskFeatures(data.payload);
                    break;
                case 'funnelConversionResult':
                    handleFunnelConversion(data.payload);
                    break;
                case 'updateFeatureStatusResult':
                    handleFeatureStatusUpdate(data.payload);
                    break;
                case 'funnelsListResult':
                    handleFunnelsList(data.payload);
                    break;
            }
        }

        // ============================================
        // DATA HANDLERS
        // ============================================
        function handleDashboardLoaded(data) {
            state.dashboard = data;

            // Update quick stats
            document.getElementById('statDrivers').textContent = data.drivers?.total?.toLocaleString() || '0';
            document.getElementById('statDriversNew').textContent = `+${data.drivers?.newThisWeek || 0}`;
            document.getElementById('statCarriers').textContent = data.carriers?.total?.toLocaleString() || '0';
            document.getElementById('statCarriersNew').textContent = `+${data.carriers?.newThisWeek || 0}`;
            document.getElementById('statMatches').textContent = data.matches?.today?.toLocaleString() || '0';
            document.getElementById('statMatchesWeek').textContent = `${data.matches?.thisWeek || 0} this week`;

            // Needs attention
            const attention = (data.drivers?.pending || 0) + (data.carriers?.flagged || 0);
            document.getElementById('statAttention').textContent = attention;
            document.getElementById('attentionBreakdown').textContent =
                `${data.drivers?.pending || 0} pending, ${data.carriers?.flagged || 0} flagged`;

            if (attention > 0) {
                document.getElementById('attentionBadge').classList.remove('hidden');
            }

            // Enrichment stats
            document.getElementById('enrichmentCoverage').textContent = `${data.enrichment?.coverage || 0}% coverage`;
            document.getElementById('enrichmentFresh').textContent = data.enrichment?.fresh || 0;
            document.getElementById('enrichmentStale').textContent = data.enrichment?.stale || 0;
            document.getElementById('enrichmentExpired').textContent = data.enrichment?.expired || 0;

            // Health indicator
            updateHealthIndicator(data.health);

            // Alerts
            renderAlerts(data.alerts);

            // Activity feed
            renderActivityFeed(data.activity);

            // Services health
            renderServicesHealth(data.health?.services);

            // Load chart data
            sendToVelo({ action: 'getChartData', period: state.chartPeriod });
        }

        // ============================================
        // RENDERING
        // ============================================
        function updateHealthIndicator(health) {
            const indicator = document.getElementById('healthIndicator');
            const statusEl = document.getElementById('healthStatus');
            const dot = indicator.querySelector('span:first-child');
            const text = indicator.querySelector('span:last-child');

            const status = health?.status || 'unknown';
            const colorMap = {
                healthy: { bg: 'bg-emerald-400', text: 'text-emerald-400', label: 'Healthy' },
                degraded: { bg: 'bg-amber-400', text: 'text-amber-400', label: 'Degraded' },
                unhealthy: { bg: 'bg-rose-400', text: 'text-rose-400', label: 'Unhealthy' },
                unknown: { bg: 'bg-slate-400', text: 'text-slate-400', label: 'Unknown' }
            };

            const config = colorMap[status] || colorMap.unknown;

            dot.className = `w-2 h-2 rounded-full ${config.bg} pulse-dot`;
            text.className = `text-xs font-medium ${config.text}`;
            text.textContent = config.label;

            statusEl.className = `px-2 py-0.5 ${config.bg.replace('bg-', 'bg-').replace('-400', '-500/20')} ${config.text} text-xs font-bold rounded-full`;
            statusEl.textContent = config.label;
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alertsList');
            const countEl = document.getElementById('alertCount');

            countEl.textContent = alerts?.unresolvedCount || 0;

            if (!alerts?.items?.length) {
                container.innerHTML = `
                <div class="text-center py-6 text-text-muted text-sm">
                    <span class="material-symbols-outlined text-3xl mb-2 block text-emerald-400">check_circle</span>
                    No active alerts
                </div>
            `;
                return;
            }

            container.innerHTML = alerts.items.map(alert => {
                const typeClass = `alert-${alert.type || 'info'}`;
                const icon = alert.type === 'critical' ? 'error' : alert.type === 'warning' ? 'warning' : 'info';

                return `
                <div class="p-3 rounded-lg border-l-4 ${typeClass}">
                    <div class="flex items-start gap-2">
                        <span class="material-symbols-outlined text-[18px] mt-0.5">${icon}</span>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium">${alert.title}</div>
                            <div class="text-xs text-text-muted mt-0.5">${alert.message}</div>
                        </div>
                        ${!alert.isDynamic ? `
                            <button onclick="resolveAlert('${alert._id}')" class="text-text-muted hover:text-white p-1">
                                <span class="material-symbols-outlined text-[16px]">close</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderActivityFeed(activities) {
            const container = document.getElementById('activityFeed');

            if (!activities?.length) {
                container.innerHTML = `
                <div class="text-center py-6 text-text-muted text-sm">
                    No recent activity
                </div>
            `;
                return;
            }

            container.innerHTML = activities.map(activity => {
                const colorMap = {
                    blue: 'bg-blue-500/20 text-blue-400',
                    green: 'bg-emerald-500/20 text-emerald-400',
                    purple: 'bg-violet-500/20 text-violet-400',
                    amber: 'bg-amber-500/20 text-amber-400'
                };
                const iconColor = colorMap[activity.color] || colorMap.blue;

                let description = '';
                switch (activity.type) {
                    case 'admin_action':
                        description = `${activity.adminEmail || 'Admin'} ${formatAction(activity.action)}`;
                        break;
                    case 'match':
                        description = `${activity.driverName} matched with ${activity.carrierName} (${activity.score}%)`;
                        break;
                    case 'new_driver':
                        description = `New driver registered: ${activity.name}`;
                        break;
                    default:
                        description = 'Activity';
                }

                return `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-lg ${iconColor} flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-[16px]">${activity.icon}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm truncate">${description}</div>
                        <div class="text-xs text-text-muted">${formatTime(activity.timestamp)}</div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderServicesHealth(services) {
            const container = document.getElementById('servicesList');

            if (!services) {
                container.innerHTML = '<div class="text-text-muted text-sm">No data</div>';
                return;
            }

            const serviceNames = {
                matching: 'Matching Engine',
                enrichment: 'AI Enrichment',
                database: 'Database'
            };

            container.innerHTML = Object.entries(services).map(([key, service]) => {
                const statusColor = service.status === 'up' ? 'bg-emerald-400' : 'bg-amber-400';
                const textColor = service.status === 'up' ? 'text-emerald-400' : 'text-amber-400';

                return `
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full ${statusColor}"></span>
                        <span class="text-sm">${serviceNames[key] || key}</span>
                    </div>
                    <span class="text-xs ${textColor}">${service.score}%</span>
                </div>
            `;
            }).join('');
        }

        // ============================================
        // CHART
        // ============================================
        function initChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');

            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Matches',
                            data: [],
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'New Drivers',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 0,
                                callback: function (val, idx) {
                                    const label = this.getLabelForValue(val);
                                    return label ? label.slice(5) : ''; // Show MM-DD
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function updateChart(data) {
            if (!state.chart || !data) return;

            state.chart.data.labels = data.labels || [];
            state.chart.data.datasets[0].data = data.matches || [];
            state.chart.data.datasets[1].data = data.drivers || [];
            state.chart.update();
        }

        function loadChartData(period) {
            state.chartPeriod = period;

            // Update button states
            document.getElementById('chartWeekBtn').className = period === 'week'
                ? 'px-3 py-1.5 text-xs font-medium rounded-md bg-primary text-white'
                : 'px-3 py-1.5 text-xs font-medium rounded-md text-text-muted hover:text-white';
            document.getElementById('chartMonthBtn').className = period === 'month'
                ? 'px-3 py-1.5 text-xs font-medium rounded-md bg-primary text-white'
                : 'px-3 py-1.5 text-xs font-medium rounded-md text-text-muted hover:text-white';

            sendToVelo({ action: 'getChartData', period });
        }

        // ============================================
        // AI USAGE CHART & HANDLERS
        // ============================================
        function initAIUsageChart() {
            const ctx = document.getElementById('aiUsageChart').getContext('2d');

            state.aiUsageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cost ($)',
                        data: [],
                        backgroundColor: 'rgba(34, 211, 238, 0.6)',
                        borderColor: '#22d3ee',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 9 },
                                maxRotation: 0,
                                callback: function (val, idx) {
                                    const label = this.getLabelForValue(val);
                                    if (!label) return '';
                                    return label.length > 5 ? label.slice(-5) : label;
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 9 },
                                callback: (val) => '$' + val.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function handleAIUsageLoaded(data) {
            state.aiUsage = data;

            // Update quick stat card
            document.getElementById('statAICost').textContent = `$${data.summary?.totalCost?.toFixed(2) || '0.00'}`;
            document.getElementById('aiTokenCount').innerHTML = `
            <span class="text-cyan-400">${formatNumber(data.summary?.totalTokens || 0)}</span>
            <span class="text-text-muted">tokens</span>
        `;

            // Budget badge
            const budgetBadge = document.getElementById('aiBudgetBadge');
            if (data.summary?.budgetStatus?.status === 'critical') {
                budgetBadge.classList.remove('hidden', 'bg-amber-500');
                budgetBadge.classList.add('bg-rose-500');
            } else if (data.summary?.budgetStatus?.status === 'warning') {
                budgetBadge.classList.remove('hidden', 'bg-rose-500');
                budgetBadge.classList.add('bg-amber-500');
            } else {
                budgetBadge.classList.add('hidden');
            }

            // Budget status bar
            const budgetPercent = data.summary?.budgetStatus?.percentOfWarning || 0;
            const budgetBar = document.getElementById('aiBudgetBar');
            budgetBar.style.width = `${Math.min(budgetPercent, 100)}%`;

            if (data.summary?.budgetStatus?.status === 'critical') {
                budgetBar.className = 'h-full bg-rose-400 rounded-full transition-all duration-500';
            } else if (data.summary?.budgetStatus?.status === 'warning') {
                budgetBar.className = 'h-full bg-amber-400 rounded-full transition-all duration-500';
            } else {
                budgetBar.className = 'h-full bg-cyan-400 rounded-full transition-all duration-500';
            }

            document.getElementById('aiBudgetPercent').textContent = `${budgetPercent}% of $100`;
            document.getElementById('aiBudgetProjection').textContent = `Projected: $${data.summary?.monthlyProjection?.toFixed(2) || '0.00'}`;

            // Summary stats
            document.getElementById('aiTotalCost').textContent = `$${data.summary?.totalCost?.toFixed(2) || '0.00'}`;
            document.getElementById('aiTotalTokens').textContent = formatNumber(data.summary?.totalTokens || 0);
            document.getElementById('aiTotalRequests').textContent = formatNumber(data.summary?.totalRequests || 0);

            const avgLatency = data.summary?.avgLatency || 0;
            const latencyEl = document.getElementById('aiAvgLatency');
            latencyEl.textContent = avgLatency > 1000 ? `${(avgLatency / 1000).toFixed(1)}s` : `${avgLatency}ms`;
            latencyEl.className = `text-lg font-bold ${avgLatency > 3000 ? 'text-rose-400' : avgLatency > 1500 ? 'text-amber-400' : 'text-emerald-400'}`;

            // Provider breakdown
            renderProviderBars(data.byProvider || []);

            // Function breakdown
            renderFunctionList(data.byFunction || []);

            // Update usage chart
            updateAIUsageChart(data.trends);
        }

        function handleAIHealthLoaded(data) {
            // Could be used to update AI-specific health indicators
            console.log('[AI Health]', data);
        }

        function handleFeatureStatsLoaded(features) {
            // Legacy handler - now redirects to the Feature Adoption dashboard
            // This handler is kept for backward compatibility with existing Velo code
            if (!features || !features.length) return;

            // Transform legacy format to new format and pass to lifecycle report handler
            const transformedData = {
                features: features.map(f => ({
                    featureId: f.featureId,
                    displayName: f.featureId,
                    status: f.status?.toLowerCase()?.replace(' ', '_') || 'active',
                    category: 'legacy',
                    healthScore: f.interactions30d > 100 ? 80 : f.interactions30d > 50 ? 60 : f.interactions30d > 10 ? 40 : 20,
                    last7DaysUsers: Math.floor(f.interactions30d / 4) || 0,
                    last30DaysUsers: f.interactions30d || 0,
                    completionRate: 0,
                    trend: f.interactions30d > 50 ? 'growing' : f.interactions30d > 10 ? 'stable' : 'declining'
                })),
                summary: {
                    total: features.length,
                    byStatus: features.reduce((acc, f) => {
                        const status = (f.status || 'active').toLowerCase().replace(' ', '_');
                        acc[status] = (acc[status] || 0) + 1;
                        return acc;
                    }, {}),
                    byHealth: {
                        healthy: features.filter(f => f.interactions30d > 50).length,
                        warning: features.filter(f => f.interactions30d > 10 && f.interactions30d <= 50).length,
                        critical: features.filter(f => f.interactions30d <= 10).length
                    }
                }
            };

            handleFeatureLifecycleReport(transformedData);
        }

        function renderProviderBars(providers) {
            const container = document.getElementById('aiProviderBars');

            if (!providers.length) {
                container.innerHTML = `<div class="text-center py-3 text-text-muted text-xs">No data</div>`;
                return;
            }

            const maxCost = Math.max(...providers.map(p => p.cost)) || 1;
            const providerColors = {
                anthropic: 'bg-orange-400',
                openai: 'bg-emerald-400',
                groq: 'bg-cyan-400',
                perplexity: 'bg-violet-400',
                google: 'bg-blue-400',
                mistral: 'bg-amber-400',
                cohere: 'bg-pink-400'
            };

            container.innerHTML = providers.map(provider => {
                const width = Math.max((provider.cost / maxCost) * 100, 2);
                const color = providerColors[provider.provider] || 'bg-slate-400';

                return `
                <div class="flex items-center gap-2">
                    <div class="w-20 text-[10px] text-text-muted truncate">${provider.name}</div>
                    <div class="flex-1 h-4 bg-slate-700 rounded overflow-hidden">
                        <div class="${color} h-full rounded transition-all duration-500" style="width: ${width}%"></div>
                    </div>
                    <div class="w-14 text-right text-[10px] font-medium">$${provider.cost.toFixed(2)}</div>
                </div>
            `;
            }).join('');
        }

        function renderFunctionList(functions) {
            const container = document.getElementById('aiFunctionList');

            if (!functions.length) {
                container.innerHTML = `<div class="text-center py-3 text-text-muted text-xs">No data</div>`;
                return;
            }

            container.innerHTML = functions.map(func => `
            <div class="flex items-center justify-between py-1.5 border-b border-border-dark/50 last:border-0">
                <span class="text-[11px] text-text-muted">${func.name}</span>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-violet-400">${formatNumber(func.tokens)} tok</span>
                    <span class="text-[10px] font-medium text-cyan-400">$${func.cost.toFixed(2)}</span>
                </div>
            </div>
        `).join('');
        }

        function updateAIUsageChart(trends) {
            if (!state.aiUsageChart || !trends) return;

            state.aiUsageChart.data.labels = trends.labels || [];
            state.aiUsageChart.data.datasets[0].data = trends.costs || [];
            state.aiUsageChart.update();
        }

        function loadAIUsage(period) {
            state.aiUsagePeriod = period;

            // Update button states
            document.getElementById('aiDayBtn').className = period === 'day'
                ? 'px-2 py-1 text-[10px] font-medium rounded bg-primary text-white'
                : 'px-2 py-1 text-[10px] font-medium rounded text-text-muted hover:text-white';
            document.getElementById('aiWeekBtn').className = period === 'week'
                ? 'px-2 py-1 text-[10px] font-medium rounded bg-primary text-white'
                : 'px-2 py-1 text-[10px] font-medium rounded text-text-muted hover:text-white';
            document.getElementById('aiMonthBtn').className = period === 'month'
                ? 'px-2 py-1 text-[10px] font-medium rounded bg-primary text-white'
                : 'px-2 py-1 text-[10px] font-medium rounded text-text-muted hover:text-white';

            sendToVelo({ action: 'getAIUsage', period });
        }

        function scrollToAIUsage() {
            document.getElementById('aiUsagePanel').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================
        // ACTIONS
        // ============================================
        function navigateTo(destination) {
            sendToVelo({ action: 'navigateTo', destination });
        }

        function refreshDashboard() {
            sendToVelo({ action: 'getDashboard' });
            showToast('Refreshing...', 'info');
        }

        function resolveAlert(alertId) {
            sendToVelo({ action: 'resolveAlert', alertId });
        }

        // ============================================
        // HELPERS
        // ============================================
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatAction(action) {
            const actions = {
                verifyDriver: 'verified a driver',
                suspendDriver: 'suspended a driver',
                updateDriverStatus: 'updated driver status',
                flagCarrier: 'flagged a carrier',
                unflagCarrier: 'unflagged a carrier',
                updateCarrierStatus: 'updated carrier status',
                refreshEnrichment: 'refreshed enrichment'
            };
            return actions[action] || action;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

            return date.toLocaleDateString();
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();

            const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-rose-600' : 'bg-primary';
            const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';

            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-lg ${bgColor} shadow-lg`;
            toast.innerHTML = `
            <span class="material-symbols-outlined text-[20px]">${icon}</span>
            <span class="text-sm font-medium flex-1">${message}</span>
            <button onclick="document.getElementById('${id}').remove()" class="text-white/80 hover:text-white">
                <span class="material-symbols-outlined text-[18px]">close</span>
            </button>
        `;

            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // ============================================
        // FEATURE ADOPTION DASHBOARD
        // ============================================

        function initFeatureAdoptionCharts() {
            // Initialize Lifecycle Status Donut Chart
            const statusCtx = document.getElementById('featureStatusChart')?.getContext('2d');
            if (statusCtx) {
                state.featureAdoption.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Beta', 'Active', 'Deprecated', 'Sunset'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#a855f7', '#22c55e', '#eab308', '#ef4444'],
                            borderWidth: 0,
                            cutout: '70%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.label}: ${ctx.raw} features`
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const idx = elements[0].index;
                                const statuses = ['beta', 'active', 'deprecated', 'sunset'];
                                document.getElementById('featFilterStatus').value = statuses[idx];
                                filterFeatures();
                            }
                        }
                    }
                });
            }

            // Initialize Health Score Distribution Bar Chart
            const healthCtx = document.getElementById('featureHealthChart')?.getContext('2d');
            if (healthCtx) {
                state.featureAdoption.healthChart = new Chart(healthCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-20', '21-40', '41-60', '61-80', '81-100'],
                        datasets: [{
                            label: 'Features',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#94a3b8', font: { size: 10 } }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(51, 65, 85, 0.3)' },
                                ticks: {
                                    color: '#94a3b8',
                                    font: { size: 10 },
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }

        function loadFeatureAdoptionData() {
            const timeRange = state.featureAdoption.timeRange;
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - timeRange);

            // Request lifecycle report
            sendToVelo({ action: 'getFeatureLifecycleReport' });

            // Request at-risk features
            sendToVelo({ action: 'getAtRiskFeatures' });

            // Request funnels list
            sendToVelo({ action: 'getFunnelsList' });
        }

        function refreshFeatureAdoption() {
            showToast('Refreshing feature adoption data...', 'info');
            loadFeatureAdoptionData();
        }

        function setFeatureTimeRange(days) {
            state.featureAdoption.timeRange = days;

            // Update button states
            document.getElementById('featRange7d').className = `px-2 py-1 text-[10px] font-medium rounded ${days === 7 ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('featRange14d').className = `px-2 py-1 text-[10px] font-medium rounded ${days === 14 ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('featRange30d').className = `px-2 py-1 text-[10px] font-medium rounded ${days === 30 ? 'tab-active' : 'tab-inactive'}`;

            loadFeatureAdoptionData();
        }

        function setFeatureTab(tab) {
            state.featureAdoption.activeTab = tab;

            // Update tab button states
            document.getElementById('featTabOverview').className = `flex-1 md:flex-none px-4 py-2 text-xs font-medium rounded-md whitespace-nowrap ${tab === 'overview' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('featTabFunnels').className = `flex-1 md:flex-none px-4 py-2 text-xs font-medium rounded-md whitespace-nowrap ${tab === 'funnels' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('featTabAtRisk').className = `flex-1 md:flex-none px-4 py-2 text-xs font-medium rounded-md whitespace-nowrap ${tab === 'at-risk' ? 'tab-active' : 'tab-inactive'}`;

            // Toggle content visibility
            document.getElementById('featContentOverview').classList.toggle('hidden', tab !== 'overview');
            document.getElementById('featContentFunnels').classList.toggle('hidden', tab !== 'funnels');
            document.getElementById('featContentAtRisk').classList.toggle('hidden', tab !== 'at-risk');
        }

        function handleFeatureLifecycleReport(data) {
            if (!data) return;
            state.featureAdoption.lifecycleReport = data;

            const features = data.features || [];
            const summary = data.summary || {};

            // Update summary stats
            document.getElementById('featTotalFeatures').textContent = summary.total || features.length;
            document.getElementById('featHealthyCount').textContent = summary.byHealth?.healthy || 0;
            document.getElementById('featWarningCount').textContent = summary.byHealth?.warning || 0;
            document.getElementById('featCriticalCount').textContent = summary.byHealth?.critical || 0;
            document.getElementById('featStatusTotal').textContent = summary.total || features.length;

            // Update status chart
            if (state.featureAdoption.statusChart) {
                const statusData = summary.byStatus || { beta: 0, active: 0, deprecated: 0, sunset: 0 };
                state.featureAdoption.statusChart.data.datasets[0].data = [
                    statusData.beta || 0,
                    statusData.active || 0,
                    statusData.deprecated || 0,
                    statusData.sunset || 0
                ];
                state.featureAdoption.statusChart.update();
            }

            // Update health distribution chart
            if (state.featureAdoption.healthChart) {
                const healthBuckets = [0, 0, 0, 0, 0]; // 0-20, 21-40, 41-60, 61-80, 81-100
                features.forEach(f => {
                    const score = f.healthScore || 0;
                    if (score <= 20) healthBuckets[0]++;
                    else if (score <= 40) healthBuckets[1]++;
                    else if (score <= 60) healthBuckets[2]++;
                    else if (score <= 80) healthBuckets[3]++;
                    else healthBuckets[4]++;
                });
                state.featureAdoption.healthChart.data.datasets[0].data = healthBuckets;
                state.featureAdoption.healthChart.update();
            }

            // Render feature health grid
            renderFeatureHealthGrid(features);

            // Render top/bottom features tables
            renderTopBottomFeatures(features);
        }

        function handleFeatureStatsResult(data) {
            // Handle individual feature stats (for drill-down)
            console.log('[Feature Stats]', data);
        }

        function handleAtRiskFeatures(data) {
            if (!data) return;
            state.featureAdoption.atRiskFeatures = data;

            const atRiskFeatures = data.atRiskFeatures || [];
            const atRiskCount = atRiskFeatures.length;

            // Update badge
            const badge = document.getElementById('atRiskBadge');
            if (atRiskCount > 0) {
                badge.textContent = atRiskCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Update alert banner
            const banner = document.getElementById('atRiskAlertBanner');
            const criticalFeatures = atRiskFeatures.filter(f => f.riskLevel === 'critical');
            if (criticalFeatures.length > 0) {
                banner.classList.remove('hidden');
                document.getElementById('atRiskAlertMessage').textContent =
                    `${criticalFeatures.length} critical feature(s) need immediate attention. Consider deprecating or sunsetting.`;
            } else {
                banner.classList.add('hidden');
            }

            // Render at-risk features list
            renderAtRiskFeatures(atRiskFeatures);
        }

        function handleFunnelsList(data) {
            if (!data) return;
            state.featureAdoption.funnels = data.funnels || data || [];

            const selector = document.getElementById('funnelSelector');
            const funnels = state.featureAdoption.funnels;

            selector.innerHTML = '<option value="">-- Select a funnel --</option>' +
                funnels.map(f => `<option value="${f.funnelId}">${f.displayName}</option>`).join('');
        }

        function handleFunnelConversion(data) {
            if (!data) return;
            state.featureAdoption.funnelData = data;

            // Update summary stats
            document.getElementById('funnelTotalEntered').textContent = data.totalEntered?.toLocaleString() || '--';
            document.getElementById('funnelTotalCompleted').textContent = data.totalCompleted?.toLocaleString() || '--';
            document.getElementById('funnelConversionRate').textContent = `${data.overallConversionRate?.toFixed(1) || '--'}%`;

            // Show funnel details section
            document.getElementById('funnelDetails').classList.remove('hidden');

            // Render funnel visualization
            renderFunnelVisualization(data);

            // Render funnel steps table
            renderFunnelSteps(data.steps || []);
        }

        function handleFeatureStatusUpdate(data) {
            if (data?.success) {
                showToast(`Feature status updated to "${data.newStatus}"`, 'success');
                loadFeatureAdoptionData();
            } else {
                showToast('Failed to update feature status', 'error');
            }
        }

        function renderFeatureHealthGrid(features) {
            const container = document.getElementById('featureHealthGrid');
            const filter = document.getElementById('featFilterStatus').value;
            const sortBy = document.getElementById('featSortBy').value;

            // Filter features
            let filteredFeatures = filter === 'all'
                ? features
                : features.filter(f => f.status?.toLowerCase() === filter);

            // Sort features
            filteredFeatures.sort((a, b) => {
                switch (sortBy) {
                    case 'health-desc': return (b.healthScore || 0) - (a.healthScore || 0);
                    case 'health-asc': return (a.healthScore || 0) - (b.healthScore || 0);
                    case 'users-desc': return (b.last7DaysUsers || 0) - (a.last7DaysUsers || 0);
                    case 'name-asc': return (a.displayName || a.featureId).localeCompare(b.displayName || b.featureId);
                    default: return 0;
                }
            });

            if (filteredFeatures.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-text-muted text-sm">
                        <span class="material-symbols-outlined text-4xl mb-2 block">search_off</span>
                        No features match the selected filter
                    </div>`;
                return;
            }

            container.innerHTML = filteredFeatures.map(feature => {
                const healthScore = feature.healthScore || 0;
                const healthClass = healthScore >= 70 ? 'health-badge-healthy' :
                    healthScore >= 40 ? 'health-badge-warning' : 'health-badge-critical';
                const statusClass = `status-badge-${(feature.status || 'active').toLowerCase()}`;
                const trend = feature.trend || 'stable';
                const trendIcon = trend === 'growing' ? 'trending_up' :
                    trend === 'declining' ? 'trending_down' : 'trending_flat';
                const trendColor = trend === 'growing' ? 'text-emerald-400' :
                    trend === 'declining' ? 'text-rose-400' : 'text-text-muted';

                return `
                    <div class="feature-card bg-surface-darker rounded-xl p-4 cursor-pointer" onclick="showFeatureDetails('${feature.featureId}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-semibold truncate">${feature.displayName || feature.featureId}</div>
                                <div class="text-[10px] text-text-muted mt-0.5">${feature.category || 'uncategorized'}</div>
                            </div>
                            <span class="px-2 py-0.5 text-[9px] font-bold rounded-full ${statusClass} uppercase">${feature.status || 'active'}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold">${healthScore}</div>
                                <div class="text-[10px] text-text-muted">Health Score</div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-1 ${trendColor}">
                                    <span class="material-symbols-outlined text-[16px]">${trendIcon}</span>
                                    <span class="text-xs font-medium">${feature.last7DaysUsers?.toLocaleString() || 0}</span>
                                </div>
                                <div class="text-[10px] text-text-muted">Users (7d)</div>
                            </div>
                        </div>
                        <div class="mt-3 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-500 ${healthScore >= 70 ? 'bg-emerald-400' : healthScore >= 40 ? 'bg-amber-400' : 'bg-rose-400'}"
                                style="width: ${healthScore}%"></div>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderTopBottomFeatures(features) {
            // Sort by health for top/bottom
            const sorted = [...features].sort((a, b) => (b.healthScore || 0) - (a.healthScore || 0));
            const top5 = sorted.slice(0, 5);
            const bottom5 = sorted.slice(-5).reverse();

            // Render top performers
            const topContainer = document.getElementById('topFeaturesTable');
            topContainer.innerHTML = top5.map((f, idx) => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                    <div class="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-xs font-bold">${idx + 1}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate">${f.displayName || f.featureId}</div>
                        <div class="text-[10px] text-text-muted">${f.last7DaysUsers?.toLocaleString() || 0} users</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-emerald-400">${f.healthScore || 0}</div>
                        <div class="text-[10px] text-text-muted">${((f.completionRate || 0)).toFixed(1)}% CR</div>
                    </div>
                </div>
            `).join('') || '<div class="text-center py-4 text-text-muted text-xs">No data</div>';

            // Render bottom performers
            const bottomContainer = document.getElementById('bottomFeaturesTable');
            bottomContainer.innerHTML = bottom5.map((f, idx) => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                    <div class="w-6 h-6 rounded-full bg-rose-500/20 flex items-center justify-center text-rose-400 text-xs font-bold">${sorted.length - bottom5.length + idx + 1}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate">${f.displayName || f.featureId}</div>
                        <div class="text-[10px] text-text-muted">${f.last7DaysUsers?.toLocaleString() || 0} users</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-rose-400">${f.healthScore || 0}</div>
                        <div class="text-[10px] text-text-muted">${((f.completionRate || 0)).toFixed(1)}% CR</div>
                    </div>
                </div>
            `).join('') || '<div class="text-center py-4 text-text-muted text-xs">No data</div>';
        }

        function renderAtRiskFeatures(features) {
            const container = document.getElementById('atRiskFeaturesList');

            if (!features || features.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-text-muted">
                        <span class="material-symbols-outlined text-5xl mb-3 block text-emerald-400">verified</span>
                        <p class="text-sm">No at-risk features detected</p>
                        <p class="text-xs mt-1">All features are performing within healthy thresholds</p>
                    </div>`;
                return;
            }

            container.innerHTML = features.map(feature => {
                const riskClass = feature.riskLevel === 'critical' ? 'at-risk-alert' : 'at-risk-warning';
                const riskColor = feature.riskLevel === 'critical' ? 'text-rose-400' : 'text-amber-400';

                return `
                    <div class="${riskClass} rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined ${riskColor} text-2xl">
                                    ${feature.riskLevel === 'critical' ? 'error' : 'warning'}
                                </span>
                                <div>
                                    <div class="font-semibold">${feature.displayName || feature.featureId}</div>
                                    <div class="text-xs text-text-muted mt-0.5">Health Score: <span class="${riskColor} font-bold">${feature.healthScore}</span></div>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-[10px] font-bold rounded-full ${riskColor} bg-current/20 uppercase">${feature.riskLevel}</span>
                        </div>
                        <div class="mb-3">
                            <div class="text-xs font-medium text-text-muted mb-1">Issues:</div>
                            <ul class="text-xs space-y-1">
                                ${(feature.issues || []).map(issue => `
                                    <li class="flex items-start gap-2">
                                        <span class="material-symbols-outlined text-[14px] ${riskColor} mt-0.5">arrow_right</span>
                                        <span>${issue}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="flex items-center justify-between text-xs text-text-muted mb-3">
                            <span>Days since significant use: <strong class="${riskColor}">${feature.daysSinceSignificantUse || '--'}</strong></span>
                            <span>Threshold: ${feature.retirementThreshold || 30} days</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="investigateFeature('${feature.featureId}')"
                                class="flex-1 px-3 py-2 text-xs font-medium rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition-colors">
                                <span class="material-symbols-outlined text-[14px] mr-1 align-middle">search</span>
                                Investigate
                            </button>
                            ${feature.recommendedAction === 'deprecate' ? `
                                <button onclick="updateFeatureStatus('${feature.featureId}', 'deprecated')"
                                    class="flex-1 px-3 py-2 text-xs font-medium rounded-lg bg-amber-500/20 text-amber-400 hover:bg-amber-500/30 transition-colors">
                                    <span class="material-symbols-outlined text-[14px] mr-1 align-middle">do_not_disturb</span>
                                    Deprecate
                                </button>
                            ` : ''}
                            ${feature.recommendedAction === 'sunset' ? `
                                <button onclick="updateFeatureStatus('${feature.featureId}', 'sunset')"
                                    class="flex-1 px-3 py-2 text-xs font-medium rounded-lg bg-rose-500/20 text-rose-400 hover:bg-rose-500/30 transition-colors">
                                    <span class="material-symbols-outlined text-[14px] mr-1 align-middle">cancel</span>
                                    Sunset
                                </button>
                            ` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        function renderFunnelVisualization(data) {
            const container = document.getElementById('funnelVisualization');
            const steps = data.steps || [];

            if (steps.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-text-muted">
                        <span class="material-symbols-outlined text-5xl mb-3 block">filter_alt</span>
                        <p class="text-sm">No funnel data available</p>
                    </div>`;
                return;
            }

            const maxEntered = Math.max(...steps.map(s => s.entered || 0)) || 1;

            container.innerHTML = `
                <h4 class="text-sm font-semibold mb-6">${data.displayName || 'Funnel Analysis'}</h4>
                <div class="space-y-4">
                    ${steps.map((step, idx) => {
                        const width = Math.max(((step.entered || 0) / maxEntered) * 100, 10);
                        const dropoff = idx > 0 ? steps[idx - 1].entered - step.entered : 0;
                        const dropoffPercent = idx > 0 ? ((dropoff / steps[idx - 1].entered) * 100).toFixed(1) : 0;
                        const isProblematic = step.conversionRate < 50;

                        return `
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <span class="w-6 h-6 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-xs font-bold">${step.order}</span>
                                        <span class="text-sm font-medium">${step.displayName}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-sm font-bold">${step.entered?.toLocaleString()}</span>
                                        <span class="text-xs text-text-muted ml-2">(${step.conversionRate?.toFixed(1)}%)</span>
                                    </div>
                                </div>
                                <div class="h-8 bg-slate-700 rounded-lg overflow-hidden relative">
                                    <div class="funnel-bar h-full ${isProblematic ? 'bg-amber-500' : 'bg-purple-500'} rounded-lg flex items-center justify-end pr-2"
                                        style="width: ${width}%">
                                        ${step.completed ? `<span class="text-[10px] font-bold text-white">${step.completed.toLocaleString()} completed</span>` : ''}
                                    </div>
                                </div>
                                ${idx > 0 && dropoff > 0 ? `
                                    <div class="flex items-center gap-1 mt-1 text-xs text-rose-400">
                                        <span class="material-symbols-outlined text-[14px]">arrow_downward</span>
                                        <span>${dropoff.toLocaleString()} dropped (${dropoffPercent}%)</span>
                                    </div>
                                ` : ''}
                            </div>`;
                    }).join('')}
                </div>
                ${data.dropoffAnalysis?.biggestDropoff ? `
                    <div class="mt-6 p-3 bg-rose-500/10 border border-rose-500/20 rounded-lg">
                        <div class="flex items-center gap-2 text-rose-400">
                            <span class="material-symbols-outlined">insights</span>
                            <span class="text-sm font-medium">Biggest Drop-off</span>
                        </div>
                        <p class="text-xs text-text-muted mt-1">
                            Step ${data.dropoffAnalysis.biggestDropoff.step}: Lost ${data.dropoffAnalysis.biggestDropoff.lostUsers.toLocaleString()} users
                        </p>
                    </div>
                ` : ''}`;
        }

        function renderFunnelSteps(steps) {
            const container = document.getElementById('funnelStepsTable');

            if (!steps || steps.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-text-muted text-xs">No step data available</div>';
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-6 gap-2 text-[10px] text-text-muted font-medium pb-2 border-b border-border-dark">
                    <div>Step</div>
                    <div>Name</div>
                    <div class="text-right">Entered</div>
                    <div class="text-right">Completed</div>
                    <div class="text-right">Conv. Rate</div>
                    <div class="text-right">Avg Time</div>
                </div>
                ${steps.map(step => {
                    const convColor = step.conversionRate >= 70 ? 'text-emerald-400' :
                        step.conversionRate >= 40 ? 'text-amber-400' : 'text-rose-400';

                    return `
                        <div class="grid grid-cols-6 gap-2 py-2 text-xs border-b border-border-dark/50 last:border-0">
                            <div class="font-bold text-purple-400">${step.order}</div>
                            <div class="truncate">${step.displayName}</div>
                            <div class="text-right font-medium">${step.entered?.toLocaleString()}</div>
                            <div class="text-right font-medium">${step.completed?.toLocaleString()}</div>
                            <div class="text-right font-bold ${convColor}">${step.conversionRate?.toFixed(1)}%</div>
                            <div class="text-right text-text-muted">${step.avgTimeToNextMs ? formatDuration(step.avgTimeToNextMs) : '-'}</div>
                        </div>`;
                }).join('')}`;
        }

        function filterFeatures() {
            if (state.featureAdoption.lifecycleReport) {
                renderFeatureHealthGrid(state.featureAdoption.lifecycleReport.features || []);
            }
        }

        function sortFeatures() {
            if (state.featureAdoption.lifecycleReport) {
                renderFeatureHealthGrid(state.featureAdoption.lifecycleReport.features || []);
            }
        }

        function loadFunnelData(funnelId) {
            if (!funnelId) {
                document.getElementById('funnelDetails').classList.add('hidden');
                document.getElementById('funnelVisualization').innerHTML = `
                    <div class="text-center py-12 text-text-muted">
                        <span class="material-symbols-outlined text-5xl mb-3 block">filter_alt</span>
                        <p class="text-sm">Select a funnel to view conversion data</p>
                    </div>`;
                return;
            }

            state.featureAdoption.selectedFunnel = funnelId;

            const timeRange = state.featureAdoption.timeRange;
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - timeRange);

            sendToVelo({
                action: 'getFunnelConversion',
                funnelId,
                timeRange: {
                    start: startDate.toISOString(),
                    end: endDate.toISOString()
                }
            });
        }

        function refreshFunnelList() {
            sendToVelo({ action: 'getFunnelsList' });
            showToast('Refreshing funnels list...', 'info');
        }

        function showFeatureDetails(featureId) {
            // Request detailed stats for this feature
            const timeRange = state.featureAdoption.timeRange;
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - timeRange);

            sendToVelo({
                action: 'getFeatureStats',
                featureId,
                timeRange: {
                    start: startDate.toISOString(),
                    end: endDate.toISOString()
                },
                groupBy: 'day'
            });

            showToast(`Loading details for ${featureId}...`, 'info');
        }

        function investigateFeature(featureId) {
            showFeatureDetails(featureId);
        }

        function updateFeatureStatus(featureId, status) {
            if (!confirm(`Are you sure you want to change the status of "${featureId}" to "${status}"?`)) {
                return;
            }

            sendToVelo({
                action: 'updateFeatureStatus',
                featureId,
                status,
                reason: `Manual status change via Admin Dashboard`
            });
        }

        function formatDuration(ms) {
            if (!ms) return '-';
            if (ms < 1000) return `${ms}ms`;
            if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
            if (ms < 3600000) return `${Math.floor(ms / 60000)}m`;
            return `${(ms / 3600000).toFixed(1)}h`;
        }
    </script>
</body>

</html>