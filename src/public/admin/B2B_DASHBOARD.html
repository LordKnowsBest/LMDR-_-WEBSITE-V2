<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>B2B Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24', canvas: '#f8fafc' }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .pulse-dot {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }

        .touch-active:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        @supports (padding: max(0px)) {
            .safe-bottom {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }

            .safe-top {
                padding-top: max(16px, env(safe-area-inset-top));
            }
        }

        .kpi-card {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .prospect-row {
            transition: background 0.15s ease;
        }

        .prospect-row:hover {
            background: rgba(37, 99, 235, 0.08);
        }
    </style>
</head>

<body class="font-sans antialiased bg-slate-950 text-white">

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="flex-shrink-0 border-b border-slate-800 bg-slate-900 px-4 md:px-6 py-4 safe-top">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-xl md:text-2xl font-black tracking-tight">B2B Dashboard</h1>
                    <p class="text-xs md:text-sm text-slate-400 mt-0.5">Carrier acquisition pipeline & opportunities</p>
                </div>
                <div class="flex items-center gap-2 md:gap-3 self-end md:self-auto">
                    <!-- Date Range -->
                    <select id="dateRange" onchange="handleDateRangeChange()"
                        class="touch-target bg-slate-800 border border-slate-700 rounded-lg text-sm px-3 py-2 text-slate-300 focus:ring-blue-500 focus:border-blue-500">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                    <!-- Refresh -->
                    <button onclick="refreshDashboard()"
                        class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-colors">
                        <span class="material-symbols-outlined text-[20px] text-slate-300">refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-auto scrollbar-thin">
            <div class="p-4 md:p-6 space-y-6">

                <!-- KPI Row -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Pipeline Cover.</p>
                        <p id="kpiPipelineCoverage" class="text-2xl md:text-3xl font-black mt-1 text-blue-400">--</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Win Rate</p>
                        <p id="kpiWinRate" class="text-2xl md:text-3xl font-black mt-1 text-emerald-400">--</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Avg Cycle</p>
                        <p id="kpiAvgCycle" class="text-2xl md:text-3xl font-black mt-1 text-amber-400">--</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Pipeline Value</p>
                        <p id="kpiPipelineValue" class="text-2xl md:text-3xl font-black mt-1 text-purple-400">--</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Velocity</p>
                        <p id="kpiVelocity" class="text-2xl md:text-3xl font-black mt-1 text-cyan-400">--</p>
                    </div>
                    <div class="kpi-card bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Responses</p>
                        <p id="kpiResponses" class="text-2xl md:text-3xl font-black mt-1 text-rose-400">--</p>
                    </div>
                </div>

                <!-- Two Column: Prospects + Alerts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">

                    <!-- Top Non-Client Carriers -->
                    <div class="lg:col-span-2 bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 md:px-5 py-3 border-b border-slate-800 flex items-center justify-between">
                            <div>
                                <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Top Non-Client
                                    Carriers</h2>
                                <p class="text-xs text-slate-500 mt-0.5">Ranked by AI signal score</p>
                            </div>
                            <span id="prospectCount" class="text-xs text-slate-500">0 prospects</span>
                        </div>
                        <div id="prospectList"
                            class="divide-y divide-slate-800/50 max-h-[360px] overflow-auto scrollbar-thin">
                            <div class="p-8 text-center text-slate-500">
                                <span class="material-symbols-outlined text-4xl mb-2 block">search</span>
                                <p class="text-sm">Loading prospects...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 md:px-5 py-3 border-b border-slate-800">
                            <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Alerts</h2>
                        </div>
                        <div id="alertList"
                            class="divide-y divide-slate-800/50 max-h-[360px] overflow-auto scrollbar-thin">
                            <div class="p-6 text-center text-slate-500">
                                <span class="material-symbols-outlined text-3xl mb-2 block">notifications</span>
                                <p class="text-sm">No alerts</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Two Column: Top Opportunities + Next Actions -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">

                    <!-- Top Opportunities -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 md:px-5 py-3 border-b border-slate-800">
                            <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Top Opportunities</h2>
                        </div>
                        <div id="opportunityList"
                            class="divide-y divide-slate-800/50 max-h-[300px] overflow-auto scrollbar-thin">
                            <div class="p-6 text-center text-slate-500">
                                <span class="material-symbols-outlined text-3xl mb-2 block">trending_up</span>
                                <p class="text-sm">Loading opportunities...</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Next Actions -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 md:px-5 py-3 border-b border-slate-800 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h2 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Next Actions</h2>
                                <span class="text-xs px-2 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 font-medium">AI</span>
                            </div>
                            <span id="actionCount" class="text-xs text-slate-500"></span>
                        </div>
                        <div id="nextActionsList" class="divide-y divide-slate-800/50 max-h-[350px] overflow-auto scrollbar-thin">
                            <div class="p-6 text-center text-slate-500">
                                <span class="material-symbols-outlined text-3xl mb-2 block animate-spin">progress_activity</span>
                                <p class="text-sm">Loading AI recommendations...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="safe-bottom"></div>
        </main>
    </div>

    <!-- PostMessage Bridge -->
    <script>
        const VALID_ACTIONS = [
            'init', 'kpisLoaded', 'topProspectsLoaded', 'alertsLoaded',
            'topOpportunitiesLoaded', 'nextActionsLoaded',
            'signalSpikesLoaded', 'actionSuccess', 'actionError',
            // AI Next-Best-Action Engine (Phase 11)
            'aiNextActionsLoaded', 'actionSnoozed', 'actionSkipped', 'actionRecorded'
        ];

        function isValidMessage(data) {
            return data && typeof data === 'object' && typeof data.action === 'string' && VALID_ACTIONS.includes(data.action);
        }

        function sendToVelo(message) {
            window.parent.postMessage(message, '*');
        }

        window.addEventListener('message', function (event) {
            const data = event.data;
            if (!isValidMessage(data)) return;

            switch (data.action) {
                case 'init':
                    refreshDashboard();
                    break;
                case 'kpisLoaded':
                    renderKPIs(data.payload);
                    break;
                case 'topProspectsLoaded':
                    renderProspects(data.payload);
                    break;
                case 'alertsLoaded':
                    renderAlerts(data.payload);
                    break;
                case 'topOpportunitiesLoaded':
                    renderOpportunities(data.payload);
                    break;
                case 'nextActionsLoaded':
                    renderNextActions(data.payload);
                    break;
                case 'signalSpikesLoaded':
                    // Signal spike data received — could be used for enhanced alerts
                    break;
                case 'aiNextActionsLoaded':
                    renderAINextActions(data.payload);
                    break;
                case 'actionSnoozed':
                    showToast('Action snoozed', 'info');
                    refreshAIActions();
                    break;
                case 'actionSkipped':
                    showToast('Action skipped', 'info');
                    refreshAIActions();
                    break;
                case 'actionRecorded':
                    // Action tracking recorded - no UI feedback needed
                    break;
                case 'actionSuccess':
                    showToast(data.message || 'Done', 'success');
                    break;
                case 'actionError':
                    showToast(data.message || 'Error', 'error');
                    break;
            }
        });

        // ============================================================
        // RENDER FUNCTIONS
        // ============================================================

        function renderKPIs(kpis) {
            if (!kpis) return;
            setText('kpiPipelineCoverage', kpis.pipeline_coverage ? kpis.pipeline_coverage + 'x' : '0x');
            setText('kpiWinRate', (kpis.win_rate || 0) + '%');
            setText('kpiAvgCycle', (kpis.avg_cycle_days || 0) + 'd');
            setText('kpiPipelineValue', formatCurrency(kpis.pipeline_value || 0));
            setText('kpiVelocity', (kpis.activity_velocity || 0) + '/wk');
            setText('kpiResponses', String(kpis.responses_period || 0));
        }

        function renderProspects(prospects) {
            const container = document.getElementById('prospectList');
            if (!prospects || prospects.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500"><span class="material-symbols-outlined text-3xl mb-2 block">search_off</span><p class="text-sm">No prospects found</p></div>';
                setText('prospectCount', '0 prospects');
                return;
            }
            setText('prospectCount', prospects.length + ' prospects');
            container.innerHTML = prospects.map(p => {
                const urgencyDot = p.urgency === 'high'
                    ? '<span class="inline-block w-2 h-2 rounded-full bg-red-500 pulse-dot mr-1.5" title="High urgency"></span>'
                    : '';
                const newBadge = p.is_new_this_week
                    ? '<span class="ml-1.5 px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-500/20 text-blue-400 uppercase">New</span>'
                    : '';
                const driverCount = p.driver_count_high_match
                    ? `${p.driver_count_high_match} matching drivers`
                    : '';
                const subtitle = [
                    `DOT ${esc(p.carrier_dot || '—')}`,
                    esc(p.region || '—'),
                    `Fleet ${p.fleet_size || '?'}`,
                    driverCount
                ].filter(Boolean).join(' \u00b7 ');

                return `
                <div class="prospect-row px-4 md:px-5 py-3 flex items-center justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-100 truncate flex items-center">${urgencyDot}${esc(p.carrier_name || p.carrier_dot || 'Unknown')}${newBadge}</p>
                        <p class="text-xs text-slate-400 mt-0.5">${subtitle}</p>
                    </div>
                    <div class="flex-shrink-0 text-right">
                        <span class="inline-block px-2 py-0.5 rounded-full text-xs font-bold ${getScoreBadgeClass(p.signal_score)}">${p.signal_score || '—'}</span>
                        <p class="text-[10px] text-slate-500 mt-0.5">AI Score</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-1">
                        <button onclick="quickAction('call', '${esc(p.carrier_dot)}')" class="touch-active p-1.5 rounded-lg hover:bg-slate-800 transition-colors" title="Call">
                            <span class="material-symbols-outlined text-[18px] text-emerald-400">call</span>
                        </button>
                        <button onclick="quickAction('email', '${esc(p.carrier_dot)}')" class="touch-active p-1.5 rounded-lg hover:bg-slate-800 transition-colors" title="Email">
                            <span class="material-symbols-outlined text-[18px] text-blue-400">mail</span>
                        </button>
                        <button onclick="quickAction('sms', '${esc(p.carrier_dot)}')" class="touch-active p-1.5 rounded-lg hover:bg-slate-800 transition-colors" title="Text">
                            <span class="material-symbols-outlined text-[18px] text-amber-400">sms</span>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alertList');
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500"><span class="material-symbols-outlined text-3xl mb-2 block">check_circle</span><p class="text-sm">No active alerts</p></div>';
                return;
            }
            container.innerHTML = alerts.map(a => `
                <div class="px-4 py-3 border-l-4 ${a.severity === 'HIGH' ? 'border-red-500 bg-red-500/5' : 'border-amber-500 bg-amber-500/5'}">
                    <p class="text-xs font-bold ${a.severity === 'HIGH' ? 'text-red-400' : 'text-amber-400'} uppercase">${esc(a.severity)}</p>
                    <p class="text-sm text-slate-300 mt-0.5">${esc(a.message)}</p>
                </div>
            `).join('');
        }

        function renderOpportunities(opps) {
            const container = document.getElementById('opportunityList');
            if (!opps || opps.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500"><span class="material-symbols-outlined text-3xl mb-2 block">inventory_2</span><p class="text-sm">No open opportunities</p></div>';
                return;
            }
            container.innerHTML = opps.map(o => {
                const risks = o.risk_flags || [];
                const riskBadge = risks.length > 0
                    ? `<span class="text-xs px-1.5 py-0.5 rounded bg-red-500/20 text-red-400">${esc(risks[0].type)}</span>`
                    : '<span class="text-xs px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400">On track</span>';
                return `
                    <div class="px-4 md:px-5 py-3 flex items-center justify-between gap-3 prospect-row cursor-pointer" onclick="viewAccount('${esc(o.account_id)}')">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-slate-100 truncate">${esc(o.account_name || o.account_id)}</p>
                            <p class="text-xs text-slate-400 mt-0.5">Stage: ${esc(o.stage)} &middot; ${formatCurrency(o.value_estimate || 0)}</p>
                        </div>
                        <div class="flex-shrink-0">${riskBadge}</div>
                    </div>
                `;
            }).join('');
        }

        function renderNextActions(actions) {
            // Legacy fallback - redirect to AI version
            renderAINextActions({ actions: actions || [] });
        }

        function renderAINextActions(data) {
            const container = document.getElementById('nextActionsList');
            const countEl = document.getElementById('actionCount');
            const actions = data?.actions || [];
            const totalScored = data?.totalScored || actions.length;

            if (countEl) {
                countEl.textContent = totalScored > 0 ? `${actions.length} of ${totalScored} shown` : '';
            }

            if (!actions || actions.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500"><span class="material-symbols-outlined text-3xl mb-2 block">event_available</span><p class="text-sm">All caught up! No actions needed.</p></div>';
                return;
            }

            const channelIcon = { call: 'call', email: 'mail', sms: 'sms' };
            const priorityColor = (score) => {
                if (score >= 70) return 'bg-red-500/20 text-red-400';
                if (score >= 50) return 'bg-amber-500/20 text-amber-400';
                if (score >= 30) return 'bg-blue-500/20 text-blue-400';
                return 'bg-slate-700 text-slate-400';
            };

            container.innerHTML = actions.map((a, idx) => {
                const icon = channelIcon[a.recommendedChannel] || 'task_alt';
                const topReason = a.reasons && a.reasons[0] ? a.reasons[0].text : '';
                const reasonPriority = a.reasons && a.reasons[0] ? a.reasons[0].priority : 'low';
                const reasonColor = reasonPriority === 'critical' ? 'text-red-400' :
                                    reasonPriority === 'high' ? 'text-amber-400' : 'text-cyan-400';
                const daysText = a.daysSinceTouch !== undefined
                    ? (a.daysSinceTouch === 0 ? 'Today' : a.daysSinceTouch === 1 ? 'Yesterday' : `${a.daysSinceTouch}d ago`)
                    : '';

                return `
                    <div class="px-4 md:px-5 py-3 hover:bg-slate-800/50 transition-colors">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[18px] text-cyan-400">${icon}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <p class="text-sm font-medium text-slate-100 truncate cursor-pointer hover:text-cyan-400" onclick="startAction(${idx})">${esc(a.accountName)}</p>
                                    <span class="text-xs px-1.5 py-0.5 rounded font-medium ${priorityColor(a.score)}">${a.score}</span>
                                </div>
                                <p class="text-xs ${reasonColor} mt-0.5 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[14px]">lightbulb</span>
                                    ${esc(topReason)}
                                </p>
                                <div class="flex items-center gap-2 mt-1">
                                    ${a.stage ? `<span class="text-xs text-slate-500">${esc(a.stage)}</span>` : ''}
                                    ${a.value ? `<span class="text-xs text-slate-500">${formatCurrency(a.value)}</span>` : ''}
                                    ${daysText ? `<span class="text-xs text-slate-600">• ${daysText}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-1">
                                <button onclick="startAction(${idx})" class="p-1.5 rounded hover:bg-emerald-500/20 text-emerald-400 transition-colors" title="Start action">
                                    <span class="material-symbols-outlined text-[18px]">play_arrow</span>
                                </button>
                                <button onclick="snoozeAction(${idx})" class="p-1.5 rounded hover:bg-blue-500/20 text-blue-400 transition-colors" title="Snooze 1 day">
                                    <span class="material-symbols-outlined text-[18px]">snooze</span>
                                </button>
                                <button onclick="skipAction(${idx})" class="p-1.5 rounded hover:bg-slate-500/20 text-slate-500 transition-colors" title="Skip">
                                    <span class="material-symbols-outlined text-[18px]">close</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            window._aiActions = actions;
        }

        // ============================================================
        // ACTIONS
        // ============================================================

        function refreshDashboard() {
            const days = parseInt(document.getElementById('dateRange').value) || 30;
            sendToVelo({ action: 'getDashboardKPIs', days });
            sendToVelo({ action: 'getTopProspects', limit: 15 });
            sendToVelo({ action: 'getAlerts' });
            sendToVelo({ action: 'getTopOpportunities', limit: 10 });
            sendToVelo({ action: 'getAINextActions', limit: 15 });
        }

        function refreshAIActions() {
            sendToVelo({ action: 'getAINextActions', limit: 15 });
        }

        function handleDateRangeChange() {
            refreshDashboard();
        }

        function quickAction(type, carrierDot) {
            sendToVelo({ action: 'quickAction', type, carrierDot });
            showToast(`${type} action initiated`, 'info');
        }

        function viewAccount(accountId) {
            sendToVelo({ action: 'viewAccount', accountId });
        }

        // AI Action Handlers
        function startAction(idx) {
            const action = window._aiActions && window._aiActions[idx];
            if (!action) return;

            // Record that this action was taken
            sendToVelo({
                action: 'recordActionTaken',
                accountId: action.accountId,
                opportunityId: action.opportunityId,
                recommendedChannel: action.recommendedChannel,
                actualChannel: action.recommendedChannel,
                score: action.score,
                reasons: action.reasons
            });

            // Navigate to account
            viewAccount(action.accountId);
        }

        function snoozeAction(idx) {
            const action = window._aiActions && window._aiActions[idx];
            if (!action) return;

            sendToVelo({
                action: 'snoozeAction',
                accountId: action.accountId,
                opportunityId: action.opportunityId,
                snoozeDays: 1
            });
        }

        function skipAction(idx) {
            const action = window._aiActions && window._aiActions[idx];
            if (!action) return;

            sendToVelo({
                action: 'skipAction',
                accountId: action.accountId,
                opportunityId: action.opportunityId,
                skipReason: 'User skipped'
            });
        }

        // ============================================================
        // HELPERS
        // ============================================================

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function esc(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function formatCurrency(val) {
            const num = Number(val) || 0;
            if (num >= 1000000) return '$' + (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return '$' + (num / 1000).toFixed(0) + 'k';
            return '$' + num;
        }

        function getScoreBadgeClass(score) {
            const s = Number(score) || 0;
            if (s >= 80) return 'bg-emerald-500/20 text-emerald-400';
            if (s >= 50) return 'bg-amber-500/20 text-amber-400';
            return 'bg-slate-700 text-slate-400';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', info: 'bg-blue-600', warning: 'bg-amber-600' };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info} text-white text-sm px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            toast.innerHTML = `<span class="material-symbols-outlined text-[18px]">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>${esc(message)}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            refreshDashboard();
        });
    </script>
</body>

</html>