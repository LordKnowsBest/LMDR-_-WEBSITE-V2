<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Revenue Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lmdr: {
                            dark: '#0f172a',
                            blue: '#2563eb',
                            yellow: '#fbbf24',
                            canvas: '#f8fafc',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }

        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .change-positive { color: #22c55e; }
        .change-negative { color: #ef4444; }

        .cohort-high { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
        .cohort-mid { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .cohort-low { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .touch-target { min-height: 44px; min-width: 44px; }
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }
    </style>
</head>

<body class="bg-slate-900 text-white font-sans">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Scrollable Content -->
    <div id="mainContent" class="h-full overflow-y-auto scrollbar-thin p-4 md:p-6 space-y-6">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-lmdr-blue rounded-lg flex items-center justify-center font-bold text-sm">VM</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">Revenue Dashboard</h1>
                    <p class="text-slate-400 text-sm">Financial performance and subscription analytics</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnRefresh" onclick="requestAllData()"
                    class="touch-target touch-active flex items-center gap-2 px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm hover:bg-slate-700 transition">
                    <span class="material-symbols-outlined text-lg">refresh</span>
                    Refresh
                </button>
                <div class="relative">
                    <button id="btnExport" onclick="toggleExportMenu()"
                        class="touch-target touch-active flex items-center gap-2 px-4 py-2 bg-lmdr-blue rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                        <span class="material-symbols-outlined text-lg">download</span>
                        Export CSV
                    </button>
                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-10">
                        <button onclick="handleExport('snapshot')" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 rounded-t-lg">Snapshot</button>
                        <button onclick="handleExport('trend')" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-700">MRR Trend</button>
                        <button onclick="handleExport('cohort')" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 rounded-b-lg">Cohort Data</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- KPI Cards -->
        <div id="kpiGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- MRR -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-blue-400">payments</span>
                    <span id="mrrChange" class="text-xs font-medium px-2 py-0.5 rounded-full bg-slate-700">--</span>
                </div>
                <p class="text-slate-400 text-sm">Monthly Recurring Revenue</p>
                <p id="mrrValue" class="text-2xl font-bold mt-1 skeleton rounded h-8 w-32">&nbsp;</p>
            </div>
            <!-- ARR -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-purple-400">trending_up</span>
                    <span class="text-xs text-slate-500">MRR x 12</span>
                </div>
                <p class="text-slate-400 text-sm">Annual Recurring Revenue</p>
                <p id="arrValue" class="text-2xl font-bold mt-1 skeleton rounded h-8 w-32">&nbsp;</p>
            </div>
            <!-- Churn Rate -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-red-400">person_remove</span>
                    <span id="churnDirection" class="text-xs font-medium px-2 py-0.5 rounded-full bg-slate-700">--</span>
                </div>
                <p class="text-slate-400 text-sm">Churn Rate (30d)</p>
                <p id="churnRateValue" class="text-2xl font-bold mt-1 skeleton rounded h-8 w-24">&nbsp;</p>
            </div>
            <!-- Active Subscribers -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-green-400">group</span>
                    <span id="subChange" class="text-xs font-medium px-2 py-0.5 rounded-full bg-slate-700">--</span>
                </div>
                <p class="text-slate-400 text-sm">Active Subscribers</p>
                <p id="activeSubsValue" class="text-2xl font-bold mt-1 skeleton rounded h-8 w-20">&nbsp;</p>
            </div>
            <!-- ARPU -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-yellow-400">person</span>
                </div>
                <p class="text-slate-400 text-sm">Avg Revenue Per User</p>
                <p id="arpuValue" class="text-2xl font-bold mt-1 skeleton rounded h-8 w-24">&nbsp;</p>
            </div>
            <!-- LTV -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-cyan-400">diamond</span>
                </div>
                <p class="text-slate-400 text-sm">Average Lifetime Value</p>
                <p id="ltvValue" class="text-2xl font-bold mt-1 skeleton rounded h-8 w-28">&nbsp;</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- MRR Trend Chart -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <h2 class="text-lg font-semibold mb-4">MRR Trend (12 months)</h2>
                <div class="relative h-64">
                    <canvas id="mrrChart"></canvas>
                </div>
            </div>

            <!-- Revenue by Tier -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <h2 class="text-lg font-semibold mb-4">Revenue by Tier</h2>
                <div class="relative h-64">
                    <canvas id="tierChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Cohort Retention Table -->
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
            <h2 class="text-lg font-semibold mb-4">Cohort Retention Analysis</h2>
            <div class="overflow-x-auto scrollbar-thin">
                <table id="cohortTable" class="w-full text-sm">
                    <thead>
                        <tr class="text-slate-400 border-b border-slate-700">
                            <th class="text-left py-3 px-3 font-medium">Cohort</th>
                            <th class="text-center py-3 px-3 font-medium">Size</th>
                        </tr>
                    </thead>
                    <tbody id="cohortBody">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-slate-500">
                                <div class="skeleton rounded h-6 w-48 mx-auto">&nbsp;</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Churn Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <h2 class="text-lg font-semibold mb-4">Churn Breakdown</h2>
                <div class="relative h-64">
                    <canvas id="churnChart"></canvas>
                </div>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                <h2 class="text-lg font-semibold mb-4">Churn Reasons</h2>
                <div id="churnReasonsList" class="space-y-3">
                    <div class="skeleton rounded h-10 w-full">&nbsp;</div>
                    <div class="skeleton rounded h-10 w-full">&nbsp;</div>
                    <div class="skeleton rounded h-10 w-3/4">&nbsp;</div>
                </div>
                <div id="churnSummary" class="mt-4 pt-4 border-t border-slate-700 hidden">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Total churned (30d)</span>
                        <span id="churnTotal" class="font-semibold">0</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-slate-400">Churn rate</span>
                        <span id="churnRateSummary" class="font-semibold">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom padding for safe area -->
        <div class="h-6"></div>
    </div>

    <script>
        // ========================================
        // STATE
        // ========================================
        let mrrChartInstance = null;
        let tierChartInstance = null;
        let churnChartInstance = null;

        // ========================================
        // POSTMESSAGE BRIDGE
        // ========================================
        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (!msg || !msg.action) return;

            switch (msg.action) {
                case 'init':
                    requestAllData();
                    break;
                case 'revenueLoaded':
                    renderKPICards(msg.payload);
                    break;
                case 'mrrTrendLoaded':
                    renderMRRChart(msg.payload);
                    break;
                case 'tierRevenueLoaded':
                    renderTierChart(msg.payload);
                    break;
                case 'cohortLoaded':
                    renderCohortTable(msg.payload);
                    break;
                case 'churnLoaded':
                    renderChurnPanel(msg.payload);
                    break;
                case 'exportReady':
                    downloadCSV(msg.payload);
                    break;
                case 'actionError':
                    showToast(msg.message, 'error');
                    break;
                case 'actionSuccess':
                    showToast(msg.message, 'success');
                    break;
            }
        });

        function sendToVelo(action, payload) {
            window.parent.postMessage({ action, ...payload }, '*');
        }

        function requestAllData() {
            sendToVelo('getRevenue');
            sendToVelo('getMRRTrend', { months: 12 });
            sendToVelo('getTierRevenue');
            sendToVelo('getCohort', { months: 6 });
            sendToVelo('getChurn', { days: 30 });
        }

        // ========================================
        // KPI CARDS
        // ========================================
        function renderKPICards(data) {
            if (!data) return;

            document.getElementById('mrrValue').textContent = formatCurrency(data.mrr);
            document.getElementById('mrrValue').classList.remove('skeleton');
            document.getElementById('arrValue').textContent = formatCurrency(data.arr);
            document.getElementById('arrValue').classList.remove('skeleton');
            document.getElementById('churnRateValue').textContent = (data.churnRate * 100).toFixed(2) + '%';
            document.getElementById('churnRateValue').classList.remove('skeleton');
            document.getElementById('activeSubsValue').textContent = (data.totalActive || 0).toLocaleString();
            document.getElementById('activeSubsValue').classList.remove('skeleton');
            document.getElementById('arpuValue').textContent = formatCurrency(data.arpu);
            document.getElementById('arpuValue').classList.remove('skeleton');
            document.getElementById('ltvValue').textContent = formatCurrency(data.ltv);
            document.getElementById('ltvValue').classList.remove('skeleton');

            // Change badges
            renderChangeBadge('mrrChange', data.mrrChange);
            renderChangeBadge('subChange', data.subscriberChange);

            // Churn direction
            const churnDir = document.getElementById('churnDirection');
            if (data.churnRate > 0.05) {
                churnDir.textContent = 'High';
                churnDir.className = 'text-xs font-medium px-2 py-0.5 rounded-full bg-red-500/20 text-red-400';
            } else if (data.churnRate > 0.02) {
                churnDir.textContent = 'Moderate';
                churnDir.className = 'text-xs font-medium px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400';
            } else {
                churnDir.textContent = 'Low';
                churnDir.className = 'text-xs font-medium px-2 py-0.5 rounded-full bg-green-500/20 text-green-400';
            }
        }

        function renderChangeBadge(elementId, changePercent) {
            const el = document.getElementById(elementId);
            if (changePercent === undefined || changePercent === null) return;

            const isPositive = changePercent >= 0;
            const arrow = isPositive ? '\u2191' : '\u2193';
            el.textContent = `${arrow} ${Math.abs(changePercent).toFixed(1)}%`;
            el.className = `text-xs font-medium px-2 py-0.5 rounded-full ${isPositive ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
        }

        // ========================================
        // MRR TREND CHART
        // ========================================
        function renderMRRChart(data) {
            if (!data || !data.length) return;

            const ctx = document.getElementById('mrrChart').getContext('2d');
            if (mrrChartInstance) mrrChartInstance.destroy();

            mrrChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDateLabel(d.date)),
                    datasets: [{
                        label: 'MRR',
                        data: data.map(d => d.mrr),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `MRR: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(71, 85, 105, 0.3)' },
                            ticks: { color: '#94a3b8', maxTicksLimit: 12 }
                        },
                        y: {
                            grid: { color: 'rgba(71, 85, 105, 0.3)' },
                            ticks: {
                                color: '#94a3b8',
                                callback: (v) => '$' + (v >= 1000 ? (v / 1000).toFixed(0) + 'k' : v)
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // TIER CHART
        // ========================================
        function renderTierChart(data) {
            if (!data || !data.length) return;

            const ctx = document.getElementById('tierChart').getContext('2d');
            if (tierChartInstance) tierChartInstance.destroy();

            const tierColors = {
                free: '#64748b',
                pro: '#2563eb',
                enterprise: '#8b5cf6'
            };

            tierChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => capitalize(d.tier)),
                    datasets: [{
                        label: 'Revenue',
                        data: data.map(d => d.revenue),
                        backgroundColor: data.map(d => tierColors[d.tier] || '#64748b'),
                        borderRadius: 6,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${formatCurrency(ctx.raw)} (${data[ctx.dataIndex].count} subs)`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(71, 85, 105, 0.3)' },
                            ticks: {
                                color: '#94a3b8',
                                callback: (v) => '$' + (v >= 1000 ? (v / 1000).toFixed(0) + 'k' : v)
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        // ========================================
        // COHORT TABLE
        // ========================================
        function renderCohortTable(data) {
            if (!data || !data.length) {
                document.getElementById('cohortBody').innerHTML =
                    '<tr><td colspan="8" class="text-center py-8 text-slate-500">No cohort data available</td></tr>';
                return;
            }

            const maxMonths = Math.max(...data.map(c => c.retention.length));

            // Rebuild header
            const thead = document.getElementById('cohortTable').querySelector('thead tr');
            thead.innerHTML = '<th class="text-left py-3 px-3 font-medium">Cohort</th><th class="text-center py-3 px-3 font-medium">Size</th>';
            for (let i = 0; i < maxMonths; i++) {
                thead.innerHTML += `<th class="text-center py-3 px-3 font-medium">M${i}</th>`;
            }

            // Build rows
            const tbody = document.getElementById('cohortBody');
            tbody.innerHTML = '';

            for (const cohort of data) {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700/50 hover:bg-slate-700/30';

                let cells = `<td class="py-3 px-3 font-medium">${cohort.cohort}</td>`;
                cells += `<td class="text-center py-3 px-3">${cohort.total}</td>`;

                for (let i = 0; i < maxMonths; i++) {
                    const pct = cohort.retention[i];
                    if (pct !== undefined) {
                        const cls = pct >= 70 ? 'cohort-high' : pct >= 40 ? 'cohort-mid' : 'cohort-low';
                        cells += `<td class="text-center py-3 px-3"><span class="px-2 py-0.5 rounded text-xs font-medium ${cls}">${pct}%</span></td>`;
                    } else {
                        cells += '<td class="text-center py-3 px-3 text-slate-600">-</td>';
                    }
                }

                row.innerHTML = cells;
                tbody.appendChild(row);
            }
        }

        // ========================================
        // CHURN PANEL
        // ========================================
        function renderChurnPanel(data) {
            if (!data) return;

            // Pie chart
            const ctx = document.getElementById('churnChart').getContext('2d');
            if (churnChartInstance) churnChartInstance.destroy();

            const reasons = data.reasons || [];
            const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#06b6d4', '#8b5cf6', '#ec4899'];

            if (reasons.length > 0) {
                churnChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: reasons.map(r => r.reason),
                        datasets: [{
                            data: reasons.map(r => r.count),
                            backgroundColor: reasons.map((_, i) => colors[i % colors.length]),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#94a3b8', padding: 12, usePointStyle: true }
                            }
                        }
                    }
                });
            }

            // Reasons list
            const list = document.getElementById('churnReasonsList');
            if (reasons.length === 0) {
                list.innerHTML = '<p class="text-slate-500 text-sm">No churn data in the period</p>';
            } else {
                list.innerHTML = reasons.map((r, i) => `
                    <div class="flex items-center justify-between bg-slate-700/30 rounded-lg px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full" style="background:${colors[i % colors.length]}"></div>
                            <span class="text-sm">${r.reason}</span>
                        </div>
                        <span class="text-sm font-semibold">${r.count}</span>
                    </div>
                `).join('');
            }

            // Summary
            const summary = document.getElementById('churnSummary');
            summary.classList.remove('hidden');
            document.getElementById('churnTotal').textContent = data.totalChurned || 0;
            document.getElementById('churnRateSummary').textContent = ((data.churnRate || 0) * 100).toFixed(2) + '%';
        }

        // ========================================
        // EXPORT
        // ========================================
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
        }

        function handleExport(type) {
            document.getElementById('exportMenu').classList.add('hidden');
            sendToVelo('exportCSV', { exportType: type });
        }

        function downloadCSV(payload) {
            if (!payload || !payload.csv) return;
            const blob = new Blob([payload.csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = payload.filename || 'revenue_export.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV exported successfully', 'success');
        }

        // ========================================
        // UTILITIES
        // ========================================
        function formatCurrency(value) {
            if (value === null || value === undefined) return '$0';
            return '$' + Number(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatDateLabel(dateStr) {
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            } catch (_) { return dateStr; }
        }

        function capitalize(s) {
            return s ? s.charAt(0).toUpperCase() + s.slice(1) : '';
        }

        function showToast(message, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            const icon = type === 'error' ? 'error' : 'check_circle';
            toast.className = `toast flex items-center gap-2 px-4 py-3 ${bgColor} rounded-lg shadow-lg text-sm max-w-sm`;
            toast.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        // Close export menu on outside click
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('exportMenu');
            const btn = document.getElementById('btnExport');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>
</body>

</html>
