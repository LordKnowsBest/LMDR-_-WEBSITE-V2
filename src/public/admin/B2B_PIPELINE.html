<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>B2B Pipeline</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24' } } } } }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; }
        .touch-target { min-height: 44px; min-width: 44px; }
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @supports (padding: max(0px)) { .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); } .safe-top { padding-top: max(16px, env(safe-area-inset-top)); } }

        .deal-card { transition: transform 0.15s ease, box-shadow 0.15s ease; cursor: pointer; }
        .deal-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .stage-column { min-width: 260px; max-width: 320px; }
    </style>
</head>
<body class="font-sans antialiased bg-slate-950 text-white">

    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="flex-shrink-0 border-b border-slate-800 bg-slate-900 px-4 md:px-6 py-4 safe-top">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div>
                    <h1 class="text-xl md:text-2xl font-black tracking-tight">Pipeline</h1>
                    <p class="text-xs text-slate-400 mt-0.5">Deal flow & forecast</p>
                </div>
                <div class="flex items-center gap-2">
                    <!-- View Toggle -->
                    <div class="flex bg-slate-800 rounded-lg p-0.5">
                        <button id="btnKanban" onclick="setView('kanban')" class="px-3 py-1.5 rounded-md text-xs font-medium bg-blue-600 text-white transition-colors">Kanban</button>
                        <button id="btnTable" onclick="setView('table')" class="px-3 py-1.5 rounded-md text-xs font-medium text-slate-400 hover:text-white transition-colors">Table</button>
                    </div>
                    <!-- Filter -->
                    <select id="ownerFilter" onchange="applyFilters()" class="touch-target bg-slate-800 border border-slate-700 rounded-lg text-sm px-3 py-2 text-slate-300">
                        <option value="">All Reps</option>
                    </select>
                    <button onclick="refreshPipeline()" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700">
                        <span class="material-symbols-outlined text-[20px] text-slate-300">refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Forecast Bar -->
        <div id="forecastBar" class="flex-shrink-0 border-b border-slate-800 bg-slate-900/50 px-4 md:px-6 py-2.5">
            <div class="flex items-center gap-4 md:gap-8 text-sm overflow-x-auto">
                <div><span class="text-slate-400">Commit:</span> <span id="fcCommit" class="font-bold text-emerald-400">$0</span></div>
                <div><span class="text-slate-400">Best:</span> <span id="fcBest" class="font-bold text-blue-400">$0</span></div>
                <div><span class="text-slate-400">Pipeline:</span> <span id="fcPipeline" class="font-bold text-purple-400">$0</span></div>
                <div><span class="text-slate-400">Deals:</span> <span id="fcDeals" class="font-bold text-white">0</span></div>
                <div><span class="text-slate-400">Coverage:</span> <span id="fcCoverage" class="font-bold text-amber-400">—</span></div>
            </div>
        </div>

        <!-- Kanban View -->
        <main id="kanbanView" class="flex-1 overflow-auto scrollbar-thin">
            <div id="kanbanContainer" class="flex gap-4 p-4 md:p-6 min-h-full">
                <!-- Columns rendered dynamically -->
                <div class="flex items-center justify-center w-full text-slate-500 py-12">
                    <span class="material-symbols-outlined text-4xl mr-3">view_kanban</span>
                    <span>Loading pipeline...</span>
                </div>
            </div>
        </main>

        <!-- Table View (hidden by default) -->
        <main id="tableView" class="flex-1 overflow-auto scrollbar-thin hidden">
            <div class="p-4 md:p-6">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-xs text-slate-400 uppercase tracking-wider border-b border-slate-800">
                            <th class="pb-3 pr-4">Account</th>
                            <th class="pb-3 pr-4">Stage</th>
                            <th class="pb-3 pr-4">Value</th>
                            <th class="pb-3 pr-4">Owner</th>
                            <th class="pb-3 pr-4">Risk</th>
                            <th class="pb-3">Next Step</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-800/50"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        let currentView = 'kanban';
        let pipelineData = { stages: [], summary: {} };

        const VALID_ACTIONS = ['init', 'pipelineLoaded', 'forecastLoaded', 'stageUpdated', 'actionSuccess', 'actionError'];
        function isValidMessage(d) { return d && typeof d === 'object' && typeof d.action === 'string' && VALID_ACTIONS.includes(d.action); }
        function sendToVelo(msg) { window.parent.postMessage(msg, '*'); }

        window.addEventListener('message', function(e) {
            const d = e.data;
            if (!isValidMessage(d)) return;
            switch (d.action) {
                case 'init': refreshPipeline(); break;
                case 'pipelineLoaded': pipelineData = d.payload || { stages: [], summary: {} }; renderPipeline(); break;
                case 'forecastLoaded': renderForecast(d.payload); break;
                case 'stageUpdated': showToast('Stage updated', 'success'); refreshPipeline(); break;
                case 'actionSuccess': showToast(d.message || 'Done', 'success'); break;
                case 'actionError': showToast(d.message || 'Error', 'error'); break;
            }
        });

        function refreshPipeline() {
            const ownerId = document.getElementById('ownerFilter').value;
            sendToVelo({ action: 'getPipeline', ownerId });
            sendToVelo({ action: 'getForecast', ownerId });
        }

        function applyFilters() { refreshPipeline(); }

        function setView(view) {
            currentView = view;
            document.getElementById('kanbanView').classList.toggle('hidden', view !== 'kanban');
            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.getElementById('btnKanban').className = `px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${view === 'kanban' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`;
            document.getElementById('btnTable').className = `px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${view === 'table' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`;
            renderPipeline();
        }

        function renderPipeline() {
            if (currentView === 'kanban') renderKanban();
            else renderTable();
        }

        function renderKanban() {
            const container = document.getElementById('kanbanContainer');
            const stages = pipelineData.stages || [];
            if (stages.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center w-full text-slate-500 py-12"><span class="material-symbols-outlined text-4xl mr-3">inbox</span>No pipeline data</div>';
                return;
            }

            const stageColors = { prospecting: 'border-slate-500', discovery: 'border-blue-500', proposal: 'border-amber-500', negotiation: 'border-purple-500' };

            container.innerHTML = stages.map(stage => `
                <div class="stage-column flex-shrink-0 flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full ${stageColors[stage.stage_id] || 'border-slate-500'} bg-current opacity-60"></div>
                            <h3 class="text-sm font-bold text-slate-200">${esc(stage.name)}</h3>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-semibold text-slate-300">${stage.opportunity_count}</span>
                            <span class="text-xs text-slate-500 ml-1">${formatCurrency(stage.value_sum)}</span>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2 bg-slate-900/30 rounded-xl p-2 min-h-[200px]">
                        ${(stage.opportunities || []).map(opp => renderDealCard(opp, stage.stage_id)).join('')}
                        ${stage.opportunities.length === 0 ? '<p class="text-xs text-slate-600 text-center py-8">No deals</p>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderDealCard(opp, stageId) {
            const risks = opp.risk_flags || [];
            const hasRisk = risks.length > 0;
            const riskColor = hasRisk ? 'border-l-red-500' : 'border-l-transparent';
            return `
                <div class="deal-card bg-slate-900 border border-slate-800 border-l-2 ${riskColor} rounded-lg p-3" onclick="viewDeal('${esc(opp._id || opp.id)}', '${esc(opp.account_id)}')">
                    <p class="text-sm font-semibold text-slate-100 truncate">${esc(opp.account_name || opp.account_id)}</p>
                    <p class="text-xs text-slate-400 mt-1">${formatCurrency(opp.value_estimate || 0)}</p>
                    ${hasRisk ? `<div class="mt-2 flex flex-wrap gap-1">${risks.slice(0, 2).map(r => `<span class="text-[10px] px-1.5 py-0.5 rounded bg-red-500/20 text-red-400">${esc(r.type)}</span>`).join('')}</div>` : ''}
                    ${opp.next_step ? `<p class="text-[11px] text-slate-500 mt-1.5 truncate">Next: ${esc(opp.next_step)}</p>` : ''}
                </div>
            `;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const allOpps = [];
            (pipelineData.stages || []).forEach(s => {
                (s.opportunities || []).forEach(o => { o._stageName = s.name; allOpps.push(o); });
            });

            if (allOpps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-500">No deals in pipeline</td></tr>';
                return;
            }

            tbody.innerHTML = allOpps.map(o => {
                const risks = o.risk_flags || [];
                return `
                    <tr class="hover:bg-slate-900/50 cursor-pointer" onclick="viewDeal('${esc(o._id || o.id)}', '${esc(o.account_id)}')">
                        <td class="py-3 pr-4 text-slate-200 font-medium">${esc(o.account_name || o.account_id)}</td>
                        <td class="py-3 pr-4"><span class="text-xs px-2 py-0.5 rounded-full bg-slate-800 text-slate-300">${esc(o._stageName)}</span></td>
                        <td class="py-3 pr-4 text-emerald-400 font-semibold">${formatCurrency(o.value_estimate || 0)}</td>
                        <td class="py-3 pr-4 text-slate-400">${esc(o.owner_id || '—')}</td>
                        <td class="py-3 pr-4">${risks.length > 0 ? `<span class="text-xs text-red-400">${risks.length} risk${risks.length > 1 ? 's' : ''}</span>` : '<span class="text-xs text-emerald-400">OK</span>'}</td>
                        <td class="py-3 text-slate-400 text-xs truncate max-w-[200px]">${esc(o.next_step || '—')}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderForecast(fc) {
            if (!fc) return;
            setText('fcCommit', formatCurrency(fc.commit || 0));
            setText('fcBest', formatCurrency(fc.best || 0));
            setText('fcPipeline', formatCurrency(fc.pipeline || 0));
            setText('fcDeals', String(fc.deal_count || 0));
            setText('fcCoverage', pipelineData.summary?.pipeline_coverage ? pipelineData.summary.pipeline_coverage + 'x' : '—');
        }

        function viewDeal(oppId, accountId) {
            sendToVelo({ action: 'viewAccount', accountId });
        }

        function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
        function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }
        function formatCurrency(v) { const n = Number(v)||0; if (n>=1e6) return '$'+(n/1e6).toFixed(1)+'M'; if (n>=1e3) return '$'+(n/1e3).toFixed(0)+'k'; return '$'+n; }
        function showToast(m, t='info') { const c=document.getElementById('toastContainer'); const cl={success:'bg-emerald-600',error:'bg-red-600',info:'bg-blue-600'}; const el=document.createElement('div'); el.className=`toast ${cl[t]||cl.info} text-white text-sm px-4 py-3 rounded-lg shadow-lg`; el.textContent=m; c.appendChild(el); setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity 0.3s';setTimeout(()=>el.remove(),300);},3000); }

        document.addEventListener('DOMContentLoaded', () => { refreshPipeline(); });
    </script>
</body>
</html>
