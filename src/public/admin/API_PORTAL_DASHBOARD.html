<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>VelocityMatch | API Portal Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            vm: {
              deep: '#0f172a',
              blue: '#2563eb',
              mint: '#14b8a6',
              panel: '#111827',
              edge: '#1f2937',
              coral: '#fb7185'
            }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] }
        }
      }
    };
  </script>
</head>
<body class="bg-vm-deep text-slate-100 font-sans min-h-screen p-6">
  <header class="mb-6">
    <h1 class="text-2xl font-bold">API Partner Portal</h1>
    <p class="text-sm text-slate-400">Usage, key lifecycle, environment switching, billing, and webhook validation.</p>
  </header>

  <section class="bg-vm-panel border border-vm-edge rounded-xl p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
      <label class="text-xs text-slate-400">Partner ID
        <input id="partnerId" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" placeholder="ptn_..." />
      </label>
      <label class="text-xs text-slate-400">Period
        <select id="period" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1">
          <option value="">Current</option>
          <option value="2026-01">2026-01</option>
          <option value="2026-02">2026-02</option>
        </select>
      </label>
      <label class="text-xs text-slate-400">Environment
        <select id="environment" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1">
          <option value="sandbox">sandbox</option>
          <option value="production">production</option>
        </select>
      </label>
      <div class="flex flex-wrap gap-2">
        <button id="loadSnapshot" class="px-3 py-2 bg-vm-blue rounded text-sm">Load Snapshot</button>
        <button id="setEnvironment" class="px-3 py-2 bg-vm-mint text-slate-900 rounded text-sm font-semibold">Set Env</button>
      </div>
    </div>
  </section>

  <section class="bg-vm-panel border border-vm-edge rounded-xl p-4 mb-4">
    <h2 class="font-semibold mb-3">Key + Billing + Webhook Actions</h2>
    <div class="flex flex-wrap gap-2 items-end">
      <button id="listKeys" class="px-3 py-2 bg-slate-700 rounded text-sm">List Keys</button>
      <button id="createKey" class="px-3 py-2 bg-vm-mint text-slate-900 rounded text-sm font-semibold">Create Sandbox Key</button>
      <button id="getBillingHistory" class="px-3 py-2 bg-slate-700 rounded text-sm">Billing History</button>
      <button id="createBillingPortal" class="px-3 py-2 bg-vm-blue rounded text-sm">Billing Portal</button>
      <button id="createCheckout" class="px-3 py-2 bg-vm-blue rounded text-sm">Create Growth Checkout</button>
      <label class="text-xs text-slate-400 flex-1 min-w-[220px]">Webhook URL (optional)
        <input id="webhookUrl" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" placeholder="https://example.com/webhook" />
      </label>
      <button id="sendWebhookTest" class="px-3 py-2 bg-vm-coral rounded text-sm">Send Test</button>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Partner</h2>
      <pre id="partnerPane" class="text-xs text-slate-300 whitespace-pre-wrap">No data</pre>
    </div>
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Usage Summary</h2>
      <pre id="usagePane" class="text-xs text-slate-300 whitespace-pre-wrap">No data</pre>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Usage Trend (recent periods)</h2>
      <div id="usageTrend" class="space-y-2 text-xs text-slate-300">No data</div>
    </div>
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Endpoint Breakdown</h2>
      <div id="endpointBreakdown" class="space-y-2 text-xs text-slate-300">No data</div>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">API Keys</h2>
      <pre id="keysPane" class="text-xs text-slate-300 whitespace-pre-wrap">No data</pre>
    </div>
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Billing / Webhooks</h2>
      <pre id="billingPane" class="text-xs text-slate-300 whitespace-pre-wrap">No data</pre>
    </div>
  </section>

  <script>
    const $ = (id) => document.getElementById(id);
    function post(action, extra = {}) { window.parent.postMessage({ action, ...extra }, '*'); }
    function partnerId() { return $('partnerId').value.trim(); }
    function periodKey() { return $('period').value || null; }
    function show(id, value) { $(id).textContent = JSON.stringify(value, null, 2); }

    function toNumber(value) {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function renderBars(containerId, items, keyLabel, keyValue) {
      const host = $(containerId);
      host.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        host.textContent = 'No data';
        return;
      }

      const max = items.reduce((best, item) => Math.max(best, toNumber(item[keyValue])), 0) || 1;
      items.slice(0, 10).forEach((item) => {
        const label = item[keyLabel] || 'unknown';
        const value = toNumber(item[keyValue]);
        const width = Math.max(5, Math.round((value / max) * 100));

        const row = document.createElement('div');
        row.innerHTML = '<div class="flex justify-between"><span>' + label + '</span><span>' + value + '</span></div>' +
          '<div class="mt-1 h-2 bg-slate-800 rounded"><div class="h-2 bg-vm-blue rounded" style="width:' + width + '%"></div></div>';
        host.appendChild(row);
      });
    }

    function summarizeEndpointCounts(usageRecords) {
      const totals = {};
      (usageRecords || []).forEach((record) => {
        const endpointCounts = record?.endpoint_usage || record?.endpoint_counts || {};
        Object.keys(endpointCounts || {}).forEach((endpoint) => {
          totals[endpoint] = (totals[endpoint] || 0) + toNumber(endpointCounts[endpoint]);
        });
      });

      return Object.keys(totals)
        .map((endpoint) => ({ endpoint, calls: totals[endpoint] }))
        .sort((a, b) => b.calls - a.calls);
    }

    function renderUsage(snapshot) {
      const usageRecords = snapshot?.usage || [];
      const trend = usageRecords
        .map((record) => ({ period: record.period_key || 'current', calls: toNumber(record.total_calls || record.calls) }))
        .sort((a, b) => String(a.period).localeCompare(String(b.period)));

      const endpointBreakdown = summarizeEndpointCounts(usageRecords);
      renderBars('usageTrend', trend, 'period', 'calls');
      renderBars('endpointBreakdown', endpointBreakdown, 'endpoint', 'calls');
    }

    window.addEventListener('message', (event) => {
      const data = event.data || {};
      if (data.action === 'init') {
        post('getSnapshot', { partnerId: partnerId(), periodKey: periodKey() });
      }

      if (data.action === 'snapshotLoaded') {
        show('partnerPane', data.payload?.partner || data.payload);
        show('usagePane', {
          usage: data.payload?.usage,
          subscription: data.payload?.subscription,
          environment: data.payload?.environment
        });
        show('keysPane', data.payload?.api_keys || []);
        show('billingPane', {
          billing: data.payload?.billing,
          webhook_deliveries: data.payload?.webhook_deliveries
        });

        if (data.payload?.environment) {
          $('environment').value = data.payload.environment;
        }
        renderUsage(data.payload || {});
      }

      if (data.action === 'environmentSet') {
        show('usagePane', { environment_update: data.payload });
      }

      if (data.action === 'keysLoaded' || data.action === 'keyCreated' || data.action === 'keyRevoked' || data.action === 'keyRotated') {
        show('keysPane', data.payload);
      }

      if (
        data.action === 'billingHistoryLoaded' ||
        data.action === 'webhookTestResult' ||
        data.action === 'checkoutCreated' ||
        data.action === 'billingPortalCreated'
      ) {
        show('billingPane', data.payload);
      }

      if (data.action === 'actionError') {
        show('billingPane', { error: data.message });
      }
    });

    $('loadSnapshot').addEventListener('click', () => post('getSnapshot', { partnerId: partnerId(), periodKey: periodKey() }));
    $('setEnvironment').addEventListener('click', () => post('setEnvironment', { partnerId: partnerId(), environment: $('environment').value }));
    $('listKeys').addEventListener('click', () => post('listKeys', { partnerId: partnerId() }));
    $('createKey').addEventListener('click', () => post('createKey', {
      partnerId: partnerId(),
      options: { environment: 'sandbox', name: 'Portal Sandbox Key' }
    }));
    $('getBillingHistory').addEventListener('click', () => post('getBillingHistory', { partnerId: partnerId(), limit: 50 }));
    $('createBillingPortal').addEventListener('click', () => post('createBillingPortal', { partnerId: partnerId() }));
    $('createCheckout').addEventListener('click', () => post('createCheckout', {
      partnerId: partnerId(),
      tier: 'growth',
      planType: 'monthly'
    }));
    $('sendWebhookTest').addEventListener('click', () => post('sendWebhookTest', {
      partnerId: partnerId(),
      webhookUrl: $('webhookUrl').value.trim() || null
    }));
  </script>
</body>
</html>
