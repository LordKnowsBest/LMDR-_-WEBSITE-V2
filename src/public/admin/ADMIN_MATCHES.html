<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Touch-friendly targets */
        .touch-target { min-height: 44px; min-width: 44px; }

        /* Score colors */
        .score-excellent { background: linear-gradient(135deg, #10b981, #059669); }
        .score-good { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .score-fair { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .score-low { background: linear-gradient(135deg, #6b7280, #4b5563); }

        /* Status badges */
        .status-interested { background: #dbeafe; color: #1d4ed8; }
        .status-applied { background: #ede9fe; color: #7c3aed; }
        .status-in_review { background: #fef3c7; color: #d97706; }
        .status-accepted { background: #d1fae5; color: #059669; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .status-hired { background: #d1fae5; color: #047857; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Tab styling */
        .tab-btn {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: #eff6ff;
        }

        /* Card hover effects */
        .match-card {
            transition: all 0.2s ease;
        }
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Score ring */
        .score-ring {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Bottom sheet for mobile */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .bottom-sheet.open { transform: translateY(0); }
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: #d1d5db;
            border-radius: 2px;
            margin: 12px auto;
        }

        /* Backdrop */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 99;
        }
        .backdrop.open { opacity: 1; visibility: visible; }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Responsive table */
        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-cards { display: block; }
        }
        @media (min-width: 769px) {
            .desktop-table { display: block; }
            .mobile-cards { display: none; }
        }

        /* Dark mode overrides */
        html.dark body { background: #0f172a; color: #e2e8f0; }
        html.dark .bg-gray-50 { background-color: #0f172a; }
        html.dark .bg-white { background-color: #1e293b; }
        html.dark .border-gray-200, html.dark .border-gray-100 { border-color: #334155; }
        html.dark .text-gray-900 { color: #f1f5f9; }
        html.dark .text-gray-600 { color: #94a3b8; }
        html.dark .text-gray-500 { color: #64748b; }
        html.dark .text-gray-400 { color: #64748b; }
        html.dark .bg-gray-100 { background-color: #334155; }
        html.dark .hover\:bg-gray-100:hover { background-color: #334155; }
        html.dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.2); }
        html.dark .bg-green-100 { background-color: rgba(34, 197, 94, 0.2); }
        html.dark .bg-amber-100 { background-color: rgba(245, 158, 11, 0.2); }
        html.dark .bg-purple-100 { background-color: rgba(168, 85, 247, 0.2); }
        html.dark .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); }
        html.dark .bottom-sheet { background: #1e293b; }
        html.dark .tab-btn.active { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-bottom-color: #3b82f6; }
        html.dark ::-webkit-scrollbar-track { background: #1e293b; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Match Management</h1>
                    <p class="text-sm text-gray-500 mt-0.5">Driver-carrier matching analytics</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="themeToggle" onclick="toggleTheme()" class="touch-target p-2 text-gray-600 hover:bg-gray-100 rounded-lg" title="Toggle theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button id="refreshBtn" class="touch-target p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-t border-gray-100 overflow-x-auto">
            <button class="tab-btn active flex-1 px-4 py-3 text-sm font-medium text-gray-600 touch-target whitespace-nowrap" data-tab="matches">
                <i class="fas fa-handshake mr-2"></i>Matches
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-gray-600 touch-target whitespace-nowrap" data-tab="interests">
                <i class="fas fa-heart mr-2"></i>Interests
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-gray-600 touch-target whitespace-nowrap" data-tab="analytics">
                <i class="fas fa-chart-line mr-2"></i>Analytics
            </button>
        </div>
    </header>

    <!-- Stats Cards -->
    <div id="statsSection" class="px-4 py-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide">Today</p>
                        <p id="statToday" class="text-2xl font-bold text-gray-900 mt-1">-</p>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-day text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide">This Week</p>
                        <p id="statWeek" class="text-2xl font-bold text-gray-900 mt-1">-</p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-bar text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide">Avg Score</p>
                        <p id="statAvgScore" class="text-2xl font-bold text-gray-900 mt-1">-</p>
                    </div>
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-star text-purple-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide">Conversion</p>
                        <p id="statConversion" class="text-2xl font-bold text-gray-900 mt-1">-</p>
                    </div>
                    <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-percentage text-amber-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="px-4 pb-24">
        <!-- Matches Tab -->
        <div id="matchesTab" class="tab-content">
            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
                <div class="flex flex-wrap gap-3">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs text-gray-500 mb-1">Search</label>
                        <input type="text" id="matchSearch" placeholder="Driver or carrier name..."
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="w-32">
                        <label class="block text-xs text-gray-500 mb-1">Min Score</label>
                        <select id="matchMinScore" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm touch-target">
                            <option value="">Any</option>
                            <option value="90">90+</option>
                            <option value="75">75+</option>
                            <option value="60">60+</option>
                        </select>
                    </div>
                    <div class="w-32">
                        <label class="block text-xs text-gray-500 mb-1">Action</label>
                        <select id="matchAction" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm touch-target">
                            <option value="all">All Actions</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="filterMatchesBtn" class="touch-target px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-filter mr-1"></i>Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Match List -->
            <div id="matchList" class="space-y-3">
                <!-- Matches will be rendered here -->
                <div class="skeleton h-20 rounded-xl"></div>
                <div class="skeleton h-20 rounded-xl"></div>
                <div class="skeleton h-20 rounded-xl"></div>
            </div>

            <!-- Pagination -->
            <div id="matchPagination" class="flex justify-center items-center gap-2 mt-6 hidden">
                <button id="matchPrevBtn" class="touch-target px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm disabled:opacity-50">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="matchPageInfo" class="text-sm text-gray-600 px-4">Page 1 of 1</span>
                <button id="matchNextBtn" class="touch-target px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm disabled:opacity-50">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Interests Tab -->
        <div id="interestsTab" class="tab-content hidden">
            <!-- Interest Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
                <div class="flex flex-wrap gap-3">
                    <div class="w-40">
                        <label class="block text-xs text-gray-500 mb-1">Status</label>
                        <select id="interestStatus" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm touch-target">
                            <option value="all">All Status</option>
                            <option value="interested">Interested</option>
                            <option value="applied">Applied</option>
                            <option value="in_review">In Review</option>
                            <option value="accepted">Accepted</option>
                            <option value="rejected">Rejected</option>
                            <option value="hired">Hired</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs text-gray-500 mb-1">Date From</label>
                        <input type="date" id="interestDateFrom" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs text-gray-500 mb-1">Date To</label>
                        <input type="date" id="interestDateTo" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    </div>
                    <div class="flex items-end">
                        <button id="filterInterestsBtn" class="touch-target px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-filter mr-1"></i>Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Interest List -->
            <div id="interestList" class="space-y-3">
                <div class="skeleton h-24 rounded-xl"></div>
                <div class="skeleton h-24 rounded-xl"></div>
            </div>

            <!-- Interest Pagination -->
            <div id="interestPagination" class="flex justify-center items-center gap-2 mt-6 hidden">
                <button id="interestPrevBtn" class="touch-target px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm disabled:opacity-50">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="interestPageInfo" class="text-sm text-gray-600 px-4">Page 1 of 1</span>
                <button id="interestNextBtn" class="touch-target px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm disabled:opacity-50">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content hidden">
            <!-- Trend Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-900">Match Trends</h3>
                    <div class="flex gap-2">
                        <button class="trend-period-btn px-3 py-1 text-sm rounded-lg bg-blue-100 text-blue-700" data-period="week">Week</button>
                        <button class="trend-period-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-600" data-period="month">Month</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Score Distribution -->
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <h3 class="font-semibold text-gray-900 mb-4">Score Distribution</h3>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <span class="w-20 text-sm text-gray-600">Excellent</span>
                            <div class="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden mx-3">
                                <div id="scoreExcellent" class="h-full bg-green-500 rounded-full" style="width: 0%"></div>
                            </div>
                            <span id="scoreExcellentCount" class="w-10 text-sm font-medium text-right">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-20 text-sm text-gray-600">Good</span>
                            <div class="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden mx-3">
                                <div id="scoreGood" class="h-full bg-blue-500 rounded-full" style="width: 0%"></div>
                            </div>
                            <span id="scoreGoodCount" class="w-10 text-sm font-medium text-right">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-20 text-sm text-gray-600">Fair</span>
                            <div class="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden mx-3">
                                <div id="scoreFair" class="h-full bg-yellow-500 rounded-full" style="width: 0%"></div>
                            </div>
                            <span id="scoreFairCount" class="w-10 text-sm font-medium text-right">0</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-20 text-sm text-gray-600">Low</span>
                            <div class="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden mx-3">
                                <div id="scoreLow" class="h-full bg-gray-400 rounded-full" style="width: 0%"></div>
                            </div>
                            <span id="scoreLowCount" class="w-10 text-sm font-medium text-right">0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <h3 class="font-semibold text-gray-900 mb-4">Top Carriers</h3>
                    <div id="topCarriersList" class="space-y-3">
                        <div class="skeleton h-8 rounded"></div>
                        <div class="skeleton h-8 rounded"></div>
                        <div class="skeleton h-8 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- Top Matches This Week -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-900">Top Matches This Week</h3>
                    <button id="exportBtn" class="text-sm text-blue-600 hover:text-blue-700">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                </div>
                <div id="topMatchesList" class="space-y-2">
                    <div class="skeleton h-12 rounded"></div>
                    <div class="skeleton h-12 rounded"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Match Detail Bottom Sheet -->
    <div id="backdrop" class="backdrop"></div>
    <div id="matchDetailSheet" class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">Match Details</h3>
                <button id="closeDetailBtn" class="touch-target p-2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="matchDetailContent">
                <!-- Detail content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // State
        let currentTab = 'matches';
        let matchPage = 1;
        let interestPage = 1;
        let trendsChart = null;
        let currentStats = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        // Listen for messages from Velo
        window.onmessage = (event) => {
            const { action, payload, message } = event.data;

            switch (action) {
                case 'init':
                    loadInitialData();
                    break;
                case 'matchesLoaded':
                    renderMatches(payload);
                    break;
                case 'matchDetailLoaded':
                    renderMatchDetail(payload);
                    break;
                case 'interestsLoaded':
                    renderInterests(payload);
                    break;
                case 'statsLoaded':
                    renderStats(payload);
                    break;
                case 'trendsLoaded':
                    renderTrendsChart(payload);
                    break;
                case 'topMatchesLoaded':
                    renderTopMatches(payload);
                    break;
                case 'actionListLoaded':
                    populateActionFilter(payload);
                    break;
                case 'exportReady':
                    downloadCSV(payload, 'matches_export.csv');
                    break;
                case 'actionError':
                    showToast(message, 'error');
                    break;
            }
        };

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Refresh
            document.getElementById('refreshBtn').addEventListener('click', loadInitialData);

            // Match filters
            document.getElementById('filterMatchesBtn').addEventListener('click', () => {
                matchPage = 1;
                loadMatches();
            });

            // Interest filters
            document.getElementById('filterInterestsBtn').addEventListener('click', () => {
                interestPage = 1;
                loadInterests();
            });

            // Pagination
            document.getElementById('matchPrevBtn').addEventListener('click', () => {
                if (matchPage > 1) { matchPage--; loadMatches(); }
            });
            document.getElementById('matchNextBtn').addEventListener('click', () => {
                matchPage++; loadMatches();
            });
            document.getElementById('interestPrevBtn').addEventListener('click', () => {
                if (interestPage > 1) { interestPage--; loadInterests(); }
            });
            document.getElementById('interestNextBtn').addEventListener('click', () => {
                interestPage++; loadInterests();
            });

            // Trend period buttons
            document.querySelectorAll('.trend-period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.trend-period-btn').forEach(b => {
                        b.classList.remove('bg-blue-100', 'text-blue-700');
                        b.classList.add('bg-gray-100', 'text-gray-600');
                    });
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-blue-100', 'text-blue-700');
                    loadTrends(btn.dataset.period);
                });
            });

            // Export
            document.getElementById('exportBtn').addEventListener('click', exportMatches);

            // Bottom sheet
            document.getElementById('backdrop').addEventListener('click', closeDetailSheet);
            document.getElementById('closeDetailBtn').addEventListener('click', closeDetailSheet);
        }

        function loadInitialData() {
            sendToVelo({ action: 'getStats' });
            sendToVelo({ action: 'getActionList' });
            loadMatches();
            loadInterests();
            loadTrends('week');
            sendToVelo({ action: 'getTopMatches', limit: 10 });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
        }

        function loadMatches() {
            const filters = {
                carrierName: document.getElementById('matchSearch').value,
                minScore: document.getElementById('matchMinScore').value,
                action: document.getElementById('matchAction').value
            };
            sendToVelo({ action: 'getMatches', filters, page: matchPage, pageSize: 50 });
        }

        function loadInterests() {
            const filters = {
                status: document.getElementById('interestStatus').value,
                dateFrom: document.getElementById('interestDateFrom').value,
                dateTo: document.getElementById('interestDateTo').value
            };
            sendToVelo({ action: 'getInterests', filters, page: interestPage, pageSize: 50 });
        }

        function loadTrends(period) {
            sendToVelo({ action: 'getTrends', period });
        }

        function renderStats(stats) {
            currentStats = stats;
            document.getElementById('statToday').textContent = stats.matches.today.toLocaleString();
            document.getElementById('statWeek').textContent = stats.matches.thisWeek.toLocaleString();
            document.getElementById('statAvgScore').textContent = stats.matches.averageScore + '%';
            document.getElementById('statConversion').textContent = stats.interests.conversionRate + '%';

            // Score distribution
            const total = stats.scoreDistribution.excellent + stats.scoreDistribution.good +
                         stats.scoreDistribution.fair + stats.scoreDistribution.low;
            if (total > 0) {
                updateScoreBar('Excellent', stats.scoreDistribution.excellent, total);
                updateScoreBar('Good', stats.scoreDistribution.good, total);
                updateScoreBar('Fair', stats.scoreDistribution.fair, total);
                updateScoreBar('Low', stats.scoreDistribution.low, total);
            }

            // Top carriers
            renderTopCarriers(stats.topCarriers);
        }

        function updateScoreBar(category, count, total) {
            const catLower = category.toLowerCase();
            const percent = Math.round((count / total) * 100);
            document.getElementById('score' + category).style.width = percent + '%';
            document.getElementById('score' + category + 'Count').textContent = count;
        }

        function renderTopCarriers(carriers) {
            const container = document.getElementById('topCarriersList');
            if (!carriers || carriers.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No data available</p>';
                return;
            }

            container.innerHTML = carriers.map((carrier, index) => `
                <div class="flex items-center justify-between py-2 ${index > 0 ? 'border-t border-gray-100' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 text-xs font-bold flex items-center justify-center">${index + 1}</span>
                        <span class="text-sm font-medium text-gray-900 truncate max-w-[180px]">${escapeHtml(carrier.name)}</span>
                    </div>
                    <span class="text-sm text-gray-600">${carrier.count} matches</span>
                </div>
            `).join('');
        }

        function renderMatches(data) {
            const container = document.getElementById('matchList');
            const pagination = document.getElementById('matchPagination');

            if (!data.matches || data.matches.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center">
                        <i class="fas fa-handshake text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">No matches found</p>
                    </div>
                `;
                pagination.classList.add('hidden');
                return;
            }

            // Mobile cards
            const mobileHtml = data.matches.map(match => `
                <div class="match-card bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer" onclick="openMatchDetail('${match._id}')">
                    <div class="flex items-start gap-3">
                        <div class="score-ring ${getScoreClass(match.match_score)}">
                            ${match.match_score}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="font-semibold text-gray-900">${escapeHtml(match.carrier_name || 'Unknown Carrier')}</p>
                                    <p class="text-sm text-gray-500">${escapeHtml(match.driver_name || 'Anonymous')}</p>
                                </div>
                                <span class="text-xs text-gray-400">${match.relativeTime}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">${match.actionLabel}</span>
                                ${match.carrier_dot ? `<span class="text-xs text-gray-400">DOT: ${match.carrier_dot}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="mobile-cards space-y-3">${mobileHtml}</div>`;

            // Desktop table
            container.innerHTML += `
                <div class="desktop-table bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Carrier</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Driver</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${data.matches.map(match => `
                                <tr class="hover:bg-gray-50 cursor-pointer" onclick="openMatchDetail('${match._id}')">
                                    <td class="px-4 py-3">
                                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg text-white text-sm font-bold ${getScoreClass(match.match_score)}">
                                            ${match.match_score}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <p class="font-medium text-gray-900">${escapeHtml(match.carrier_name || 'Unknown')}</p>
                                        <p class="text-xs text-gray-500">DOT: ${match.carrier_dot || '-'}</p>
                                    </td>
                                    <td class="px-4 py-3">
                                        <p class="text-gray-900">${escapeHtml(match.driver_name || 'Anonymous')}</p>
                                        <p class="text-xs text-gray-500">${match.driver_zip || '-'}</p>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">${match.actionLabel}</span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${match.relativeTime}</td>
                                    <td class="px-4 py-3 text-right">
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Pagination
            pagination.classList.remove('hidden');
            document.getElementById('matchPageInfo').textContent = `Page ${data.currentPage} of ${data.totalPages}`;
            document.getElementById('matchPrevBtn').disabled = data.currentPage <= 1;
            document.getElementById('matchNextBtn').disabled = data.currentPage >= data.totalPages;
        }

        function renderInterests(data) {
            const container = document.getElementById('interestList');
            const pagination = document.getElementById('interestPagination');

            if (!data.interests || data.interests.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center">
                        <i class="fas fa-heart text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">No interests found</p>
                    </div>
                `;
                pagination.classList.add('hidden');
                return;
            }

            container.innerHTML = data.interests.map(interest => `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="font-semibold text-gray-900">${escapeHtml(interest.carrier_name || 'Unknown Carrier')}</p>
                            <p class="text-sm text-gray-500">
                                ${interest.driver ? `${escapeHtml(interest.driver.firstName || '')} ${escapeHtml(interest.driver.lastName || '')}`.trim() : 'Unknown Driver'}
                            </p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium status-${interest.status || 'interested'}">
                            ${interest.statusLabel?.label || interest.status || 'Interested'}
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-4 text-gray-500">
                            <span><i class="fas fa-star mr-1"></i>${interest.match_score || '-'}%</span>
                            <span><i class="fas fa-eye mr-1"></i>${interest.view_count || 0} views</span>
                        </div>
                        <span class="text-gray-400">${interest.relativeTime}</span>
                    </div>
                </div>
            `).join('');

            // Pagination
            pagination.classList.remove('hidden');
            document.getElementById('interestPageInfo').textContent = `Page ${data.currentPage} of ${data.totalPages}`;
            document.getElementById('interestPrevBtn').disabled = data.currentPage <= 1;
            document.getElementById('interestNextBtn').disabled = data.currentPage >= data.totalPages;
        }

        function renderTrendsChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');

            if (trendsChart) {
                trendsChart.destroy();
            }

            const labels = data.labels.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Matches',
                            data: data.matches,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Interests',
                            data: data.interests,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function renderTopMatches(matches) {
            const container = document.getElementById('topMatchesList');

            if (!matches || matches.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No matches this week</p>';
                return;
            }

            container.innerHTML = matches.map(match => `
                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 rounded-lg text-white text-xs font-bold flex items-center justify-center ${getScoreClass(match.match_score)}">
                            ${match.match_score}
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${escapeHtml(match.carrier_name || 'Unknown')}</p>
                            <p class="text-xs text-gray-500">${escapeHtml(match.driver_name || 'Anonymous')}</p>
                        </div>
                    </div>
                    <span class="text-xs text-gray-400">${match.relativeTime}</span>
                </div>
            `).join('');
        }

        function populateActionFilter(actions) {
            const select = document.getElementById('matchAction');
            select.innerHTML = '<option value="all">All Actions</option>';
            actions.forEach(action => {
                const label = action.charAt(0).toUpperCase() + action.slice(1);
                select.innerHTML += `<option value="${action}">${label}</option>`;
            });
        }

        function openMatchDetail(matchId) {
            sendToVelo({ action: 'getMatchDetail', matchId });
            document.getElementById('backdrop').classList.add('open');
            document.getElementById('matchDetailSheet').classList.add('open');
        }

        function renderMatchDetail(match) {
            const container = document.getElementById('matchDetailContent');

            container.innerHTML = `
                <div class="flex items-center gap-4 mb-6">
                    <div class="score-ring ${getScoreClass(match.match_score)}" style="width: 64px; height: 64px; font-size: 18px;">
                        ${match.match_score}
                    </div>
                    <div>
                        <p class="text-lg font-bold text-gray-900">${escapeHtml(match.carrier_name || 'Unknown Carrier')}</p>
                        <p class="text-gray-500">DOT: ${match.carrier_dot || '-'}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 uppercase">Driver</p>
                        <p class="font-medium text-gray-900">${escapeHtml(match.driver_name || 'Anonymous')}</p>
                        <p class="text-sm text-gray-500">${match.driver_zip || '-'}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 uppercase">Action</p>
                        <p class="font-medium text-gray-900">${match.actionLabel || match.action || 'Match'}</p>
                        <p class="text-sm text-gray-500">${match.relativeTime}</p>
                    </div>
                </div>

                ${match.carrierInfo ? `
                    <div class="border-t border-gray-200 pt-4 mb-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Carrier Info</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-500">Fleet Size:</span>
                                <span class="font-medium ml-2">${match.carrierInfo.nbr_power_unit || '-'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Location:</span>
                                <span class="font-medium ml-2">${match.carrierInfo.phy_city || ''}, ${match.carrierInfo.phy_state || ''}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Safety Rating:</span>
                                <span class="font-medium ml-2">${match.carrierInfo.safety_rating || 'Not Rated'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Status:</span>
                                <span class="font-medium ml-2">${match.carrierInfo.status || 'Active'}</span>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${match.relatedMatches && match.relatedMatches.length > 0 ? `
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Related Matches (${match.relatedMatches.length})</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${match.relatedMatches.slice(0, 5).map(rm => `
                                <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                    <div class="flex items-center gap-2">
                                        <span class="w-6 h-6 rounded text-white text-xs font-bold flex items-center justify-center ${getScoreClass(rm.match_score)}">
                                            ${rm.match_score}
                                        </span>
                                        <span class="text-sm text-gray-900">${escapeHtml(rm.driver_name || 'Anonymous')}</span>
                                    </div>
                                    <span class="text-xs text-gray-400">${getRelativeTime(rm.timestamp)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function closeDetailSheet() {
            document.getElementById('backdrop').classList.remove('open');
            document.getElementById('matchDetailSheet').classList.remove('open');
        }

        function exportMatches() {
            const filters = {
                minScore: document.getElementById('matchMinScore').value
            };
            sendToVelo({ action: 'exportMatches', filters });
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            showToast('Export downloaded successfully');
        }

        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 75) return 'score-good';
            if (score >= 60) return 'score-fair';
            return 'score-low';
        }

        function getRelativeTime(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#dc2626' : '#1f2937';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function sendToVelo(message) {
            window.parent.postMessage(message, '*');
        }

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        const THEME_KEY = 'lmdr-admin-theme';

        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
            }
            updateThemeIcon(theme);
        }

        function toggleTheme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        }

        function updateThemeIcon(theme) {
            const btn = document.getElementById('themeToggle');
            if (btn) {
                btn.innerHTML = theme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        }

        // Initialize theme on load
        initTheme();
    </script>
</body>
</html>
