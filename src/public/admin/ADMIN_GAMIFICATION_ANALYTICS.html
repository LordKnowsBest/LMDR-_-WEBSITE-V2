<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamification Analytics - VelocityMatch Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24', canvas: '#f8fafc' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .stat-card {
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Gamification Analytics</h1>
                <p class="text-sm text-slate-500">Monitor XP economy, achievements, and engagement</p>
            </div>
            <div class="flex gap-3">
                <button id="refreshBtn" onclick="loadMetrics()"
                    class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                    <i class="fa-solid fa-refresh"></i> Refresh
                </button>
                <button id="abuseCheckBtn" onclick="checkAbuse()"
                    class="px-4 py-2 bg-red-50 border border-red-200 rounded-lg text-sm font-medium text-red-700 hover:bg-red-100 flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved"></i> Check Abuse
                </button>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="text-xs text-slate-400 mb-4">
            Last updated: <span id="lastUpdated">-</span>
        </div>

        <!-- Economy Health Section -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-coins text-yellow-500"></i> Economy Health
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Total Drivers</div>
                    <div class="text-2xl font-bold text-slate-900" id="totalDrivers">-</div>
                    <div class="text-xs text-slate-400 mt-1">Active in gamification</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">XP in Circulation</div>
                    <div class="text-2xl font-bold text-blue-600" id="totalXP">-</div>
                    <div class="text-xs text-slate-400 mt-1">Avg: <span id="avgXP">-</span> per user</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Total Recruiters</div>
                    <div class="text-2xl font-bold text-slate-900" id="totalRecruiters">-</div>
                    <div class="text-xs text-slate-400 mt-1">Active in gamification</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Points in Circulation</div>
                    <div class="text-2xl font-bold text-purple-600" id="totalPoints">-</div>
                    <div class="text-xs text-slate-400 mt-1">Avg: <span id="avgPoints">-</span> per user</div>
                </div>
            </div>

            <!-- Health Indicators -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 mb-2">Daily XP Rate</div>
                    <div class="text-xl font-semibold" id="dailyXPRate">-</div>
                </div>
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 mb-2">Daily Points Rate</div>
                    <div class="text-xl font-semibold" id="dailyPointsRate">-</div>
                </div>
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 mb-2">Level Progression</div>
                    <div class="text-xl font-semibold" id="levelHealth">-</div>
                </div>
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 mb-2">Rank Progression</div>
                    <div class="text-xl font-semibold" id="rankHealth">-</div>
                </div>
            </div>
        </div>

        <!-- Achievements & Challenges Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Achievements -->
            <div class="bg-white rounded-xl border border-slate-200 p-5">
                <h3 class="text-md font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-trophy text-yellow-500"></i> Achievement Unlock Rates
                </h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <div class="text-xs text-slate-500">Driver Achievements</div>
                        <div class="text-2xl font-bold" id="driverAchievements">-</div>
                        <div class="text-xs text-slate-400"><span id="driverAchievementRate">-</span> avg/user</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">Recruiter Badges</div>
                        <div class="text-2xl font-bold" id="recruiterBadges">-</div>
                        <div class="text-xs text-slate-400"><span id="recruiterBadgeRate">-</span> avg/user</div>
                    </div>
                </div>
                <div class="text-xs text-slate-500 mb-2">Top Achievements (by unlock rate)</div>
                <div id="topAchievements" class="space-y-2">
                    <div class="loading-shimmer h-6 rounded"></div>
                    <div class="loading-shimmer h-6 rounded"></div>
                    <div class="loading-shimmer h-6 rounded"></div>
                </div>
            </div>

            <!-- Challenges -->
            <div class="bg-white rounded-xl border border-slate-200 p-5">
                <h3 class="text-md font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-bullseye text-green-500"></i> Challenge Completion Rates
                </h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <div class="text-xs text-slate-500">Driver Challenges</div>
                        <div class="text-2xl font-bold" id="driverChallengeRate">-</div>
                        <div class="text-xs text-slate-400"><span id="driverChallengesCompleted">-</span> completed
                        </div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">Recruiter Challenges</div>
                        <div class="text-2xl font-bold" id="recruiterChallengeRate">-</div>
                        <div class="text-xs text-slate-400"><span id="recruiterChallengesCompleted">-</span> completed
                        </div>
                    </div>
                </div>
                <div class="text-xs text-slate-500 mb-2">By Challenge Type</div>
                <div id="challengesByType" class="space-y-2">
                    <div class="loading-shimmer h-6 rounded"></div>
                    <div class="loading-shimmer h-6 rounded"></div>
                </div>
            </div>
        </div>

        <!-- Engagement Section -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-green-500"></i> Engagement Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Daily Active</div>
                    <div class="text-2xl font-bold text-green-600" id="dailyActive">-</div>
                    <div class="text-xs text-slate-400 mt-1">Last 24 hours</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Weekly Active</div>
                    <div class="text-2xl font-bold text-blue-600" id="weeklyActive">-</div>
                    <div class="text-xs text-slate-400 mt-1">Last 7 days</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Monthly Active</div>
                    <div class="text-2xl font-bold text-purple-600" id="monthlyActive">-</div>
                    <div class="text-xs text-slate-400 mt-1">Last 30 days</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Stickiness</div>
                    <div class="text-2xl font-bold text-amber-600" id="stickiness">-</div>
                    <div class="text-xs text-slate-400 mt-1">DAU/WAU ratio</div>
                </div>
            </div>

            <!-- Referrals & Match Quality -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-sm font-medium text-slate-700 mb-3">Referral Performance</div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-xl font-bold text-slate-900" id="totalReferrals">-</div>
                            <div class="text-xs text-slate-500">Total</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-green-600" id="successfulReferrals">-</div>
                            <div class="text-xs text-slate-500">Successful</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-blue-600" id="referralConversion">-</div>
                            <div class="text-xs text-slate-500">Conversion</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-sm font-medium text-slate-700 mb-3">Match Quality Bonuses</div>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-xl font-bold text-slate-900" id="totalBonuses">-</div>
                            <div class="text-xs text-slate-500">Total</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-yellow-500" id="excellentBonuses">-</div>
                            <div class="text-xs text-slate-500">Excellent</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-blue-500" id="greatBonuses">-</div>
                            <div class="text-xs text-slate-500">Great</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-green-500" id="goodBonuses">-</div>
                            <div class="text-xs text-slate-500">Good</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-calendar-star text-purple-500"></i> Seasonal Events
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500">Total Events</div>
                    <div class="text-2xl font-bold" id="totalEvents">-</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500">Active Events</div>
                    <div class="text-2xl font-bold text-green-600" id="activeEvents">-</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500">Completed Events</div>
                    <div class="text-2xl font-bold text-slate-600" id="completedEvents">-</div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 border border-slate-200">
                    <div class="text-xs text-slate-500">Total Participants</div>
                    <div class="text-2xl font-bold text-purple-600" id="totalParticipants">-</div>
                </div>
            </div>
            <div id="eventsList" class="bg-white rounded-xl border border-slate-200 overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="text-left px-4 py-3 font-medium text-slate-600">Event</th>
                            <th class="text-left px-4 py-3 font-medium text-slate-600">Status</th>
                            <th class="text-right px-4 py-3 font-medium text-slate-600">Participants</th>
                            <th class="text-right px-4 py-3 font-medium text-slate-600">XP Earned</th>
                            <th class="text-right px-4 py-3 font-medium text-slate-600">Avg XP/User</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-slate-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Abuse Detection Modal -->
        <div id="abuseModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="font-semibold text-slate-900">Abuse Detection Report</h3>
                    <button onclick="closeAbuseModal()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div id="abuseContent" class="p-4 overflow-y-auto max-h-[60vh]">
                    <div class="text-center text-slate-400 py-8">Running analysis...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
            (function () {
                'use strict';

                // Initialize
                function init() {
                    loadMetrics();
                }

                // Load all metrics
                window.loadMetrics = async function () {
                    document.getElementById('refreshBtn').disabled = true;
                    document.getElementById('refreshBtn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';

                    window.parent.postMessage({ type: 'getGamificationMetrics' }, '*');
                };

                // Check for abuse
                window.checkAbuse = function () {
                    document.getElementById('abuseModal').classList.remove('hidden');
                    document.getElementById('abuseContent').innerHTML = '<div class="text-center text-slate-400 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Running analysis...</div>';
                    window.parent.postMessage({ type: 'detectAbusePatterns' }, '*');
                };

                window.closeAbuseModal = function () {
                    document.getElementById('abuseModal').classList.add('hidden');
                };

                // Listen for messages
                window.addEventListener('message', function (event) {
                    const { type, data } = event.data || {};

                    if (type === 'gamificationMetricsResult') {
                        updateDashboard(data);
                        document.getElementById('refreshBtn').disabled = false;
                        document.getElementById('refreshBtn').innerHTML = '<i class="fa-solid fa-refresh"></i> Refresh';
                    }

                    if (type === 'abuseDetectionResult') {
                        displayAbuseReport(data);
                    }
                });

                // Update dashboard with metrics
                function updateDashboard(data) {
                    if (!data || !data.success) {
                        console.error('Failed to load metrics:', data?.error);
                        return;
                    }

                    const { metrics } = data;
                    document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleString();

                    // Economy Health
                    if (metrics.economy) {
                        const { drivers, recruiters, healthIndicators } = metrics.economy;

                        document.getElementById('totalDrivers').textContent = formatNumber(drivers?.totalUsers || 0);
                        document.getElementById('totalXP').textContent = formatNumber(drivers?.totalXPInCirculation || 0);
                        document.getElementById('avgXP').textContent = formatNumber(drivers?.averageXP || 0);
                        document.getElementById('dailyXPRate').textContent = '+' + formatNumber(drivers?.dailyXPEarnRate || 0) + '/day';

                        document.getElementById('totalRecruiters').textContent = formatNumber(recruiters?.totalUsers || 0);
                        document.getElementById('totalPoints').textContent = formatNumber(recruiters?.totalPointsInCirculation || 0);
                        document.getElementById('avgPoints').textContent = formatNumber(recruiters?.averagePoints || 0);
                        document.getElementById('dailyPointsRate').textContent = '+' + formatNumber(recruiters?.dailyPointsEarnRate || 0) + '/day';

                        document.getElementById('levelHealth').innerHTML = getHealthBadge(healthIndicators?.levelProgressionHealth);
                        document.getElementById('rankHealth').innerHTML = getHealthBadge(healthIndicators?.rankProgressionHealth);
                    }

                    // Achievements
                    if (metrics.achievements) {
                        const { drivers, recruiters } = metrics.achievements;

                        document.getElementById('driverAchievements').textContent = formatNumber(drivers?.totalUnlocks || 0);
                        document.getElementById('driverAchievementRate').textContent = drivers?.averagePerUser || 0;
                        document.getElementById('recruiterBadges').textContent = formatNumber(recruiters?.totalUnlocks || 0);
                        document.getElementById('recruiterBadgeRate').textContent = recruiters?.averagePerUser || 0;

                        // Top achievements
                        const topAchievements = drivers?.unlockRates?.slice(0, 5) || [];
                        document.getElementById('topAchievements').innerHTML = topAchievements.map(a => `
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-700">${a.achievementId}</span>
                            <span class="text-slate-500">${a.unlockRate}%</span>
                        </div>
                    `).join('') || '<div class="text-slate-400 text-sm">No data</div>';
                    }

                    // Challenges
                    if (metrics.challenges) {
                        const { drivers, recruiters } = metrics.challenges;

                        document.getElementById('driverChallengeRate').textContent = (drivers?.completionRate || 0) + '%';
                        document.getElementById('driverChallengesCompleted').textContent = formatNumber(drivers?.completed || 0);
                        document.getElementById('recruiterChallengeRate').textContent = (recruiters?.completionRate || 0) + '%';
                        document.getElementById('recruiterChallengesCompleted').textContent = formatNumber(recruiters?.completed || 0);

                        // By type
                        const byType = drivers?.byType || [];
                        document.getElementById('challengesByType').innerHTML = byType.map(t => `
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-700">${t.type}</span>
                            <span class="text-slate-500">${t.completionRate}% (${t.completed}/${t.total})</span>
                        </div>
                    `).join('') || '<div class="text-slate-400 text-sm">No data</div>';
                    }

                    // Engagement
                    if (metrics.engagement) {
                        const { activeUsers, referrals, matchQuality } = metrics.engagement;

                        document.getElementById('dailyActive').textContent = formatNumber(activeUsers?.daily || 0);
                        document.getElementById('weeklyActive').textContent = formatNumber(activeUsers?.weekly || 0);
                        document.getElementById('monthlyActive').textContent = formatNumber(activeUsers?.monthly || 0);
                        document.getElementById('stickiness').textContent = (activeUsers?.stickinessRatio || 0) + '%';

                        document.getElementById('totalReferrals').textContent = formatNumber(referrals?.total || 0);
                        document.getElementById('successfulReferrals').textContent = formatNumber(referrals?.successful || 0);
                        document.getElementById('referralConversion').textContent = (referrals?.conversionRate || 0) + '%';

                        document.getElementById('totalBonuses').textContent = formatNumber(matchQuality?.totalBonuses || 0);
                        document.getElementById('excellentBonuses').textContent = formatNumber(matchQuality?.byTier?.excellent || 0);
                        document.getElementById('greatBonuses').textContent = formatNumber(matchQuality?.byTier?.great || 0);
                        document.getElementById('goodBonuses').textContent = formatNumber(matchQuality?.byTier?.good || 0);
                    }

                    // Events
                    if (metrics.events) {
                        const { summary, events } = metrics.events;

                        document.getElementById('totalEvents').textContent = summary?.totalEvents || 0;
                        document.getElementById('activeEvents').textContent = summary?.activeEvents || 0;
                        document.getElementById('completedEvents').textContent = summary?.completedEvents || 0;
                        document.getElementById('totalParticipants').textContent = formatNumber(summary?.totalParticipants || 0);

                        // Events table
                        document.getElementById('eventsTableBody').innerHTML = events?.map(e => `
                        <tr class="border-b border-slate-100">
                            <td class="px-4 py-3 font-medium">${e.name}</td>
                            <td class="px-4 py-3">${getStatusBadge(e.status)}</td>
                            <td class="px-4 py-3 text-right">${formatNumber(e.participants)}</td>
                            <td class="px-4 py-3 text-right">${formatNumber(e.totalXPEarned)}</td>
                            <td class="px-4 py-3 text-right">${formatNumber(e.avgXPPerUser)}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">No events</td></tr>';
                    }
                }

                // Display abuse report
                function displayAbuseReport(data) {
                    if (!data || !data.success) {
                        document.getElementById('abuseContent').innerHTML = `
                        <div class="text-center text-red-500 py-8">
                            <i class="fa-solid fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Failed to run analysis: ${data?.error || 'Unknown error'}</p>
                        </div>
                    `;
                        return;
                    }

                    const { summary, suspiciousUsers, totalUsersAnalyzed, period } = data;

                    let html = `
                    <div class="mb-4">
                        <div class="text-sm text-slate-500 mb-2">Analysis Period: ${period} | Users Analyzed: ${totalUsersAnalyzed}</div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-red-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-red-600">${summary.highRisk}</div>
                                <div class="text-xs text-red-500">High Risk</div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-yellow-600">${summary.mediumRisk}</div>
                                <div class="text-xs text-yellow-500">Medium Risk</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3">
                                <div class="text-2xl font-bold text-green-600">${summary.lowRisk}</div>
                                <div class="text-xs text-green-500">Low Risk</div>
                            </div>
                        </div>
                    </div>
                `;

                    if (suspiciousUsers.length === 0) {
                        html += '<div class="text-center text-green-600 py-4"><i class="fa-solid fa-check-circle mr-2"></i>No suspicious activity detected</div>';
                    } else {
                        html += '<div class="text-sm font-medium text-slate-700 mb-2">Suspicious Users</div>';
                        html += '<div class="space-y-3">';
                        suspiciousUsers.forEach(user => {
                            const riskColor = user.riskLevel === 'high' ? 'red' : user.riskLevel === 'medium' ? 'yellow' : 'green';
                            html += `
                            <div class="border border-${riskColor}-200 bg-${riskColor}-50 rounded-lg p-3">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-mono text-xs">${user.userId}</span>
                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-${riskColor}-100 text-${riskColor}-700">${user.riskLevel.toUpperCase()}</span>
                                </div>
                                <div class="text-xs text-slate-600 mb-2">
                                    ${user.eventCount} events | ${user.totalXP} XP | ${user.totalPoints} points
                                </div>
                                <div class="text-xs">
                                    ${user.flags.map(f => `<span class="inline-block bg-white px-2 py-0.5 rounded mr-1 mb-1">${f.type}: ${f.value} (threshold: ${f.threshold})</span>`).join('')}
                                </div>
                            </div>
                        `;
                        });
                        html += '</div>';
                    }

                    document.getElementById('abuseContent').innerHTML = html;
                }

                // Helper functions
                function formatNumber(num) {
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                    return num.toLocaleString();
                }

                function getHealthBadge(health) {
                    const badges = {
                        healthy: '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">Healthy</span>',
                        too_slow: '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium">Too Slow</span>',
                        too_fast: '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">Too Fast</span>',
                        insufficient_data: '<span class="px-2 py-1 bg-slate-100 text-slate-500 rounded text-xs font-medium">No Data</span>'
                    };
                    return badges[health] || badges.insufficient_data;
                }

                function getStatusBadge(status) {
                    const badges = {
                        active: '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">Active</span>',
                        scheduled: '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">Scheduled</span>',
                        ended: '<span class="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-xs">Ended</span>',
                        draft: '<span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs">Draft</span>'
                    };
                    return badges[status] || status;
                }

                // Start
                init();
            })();
    </script>
</body>

</html>