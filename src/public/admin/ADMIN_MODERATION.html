<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Moderation Queue | LMDR Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            dark: '#0f172a',
                            blue: '#2563eb',
                            yellow: '#fbbf24',
                            canvas: '#f8fafc',
                        },
                        // Admin Tokens
                        primary: { DEFAULT: '#2563eb', dark: '#1d4ed8' },
                        background: { dark: '#0f172a', light: '#f8fafc' },
                        surface: { dark: '#1e293b', light: '#ffffff', darker: '#0f172a', lighter: '#f1f5f9' },
                        border: { dark: '#334155', light: '#e2e8f0' },
                        text: { muted: '#94a3b8', dark: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Shared Admin Styles */
        body { font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        /* Markdown Preview */
        .markdown-body p { margin-bottom: 0.5rem; line-height: 1.5; font-size: 0.875rem; }
        .markdown-body blockquote { border-left: 3px solid #475569; padding-left: 0.75rem; color: #94a3b8; font-style: italic; }
        
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Light/Dark overrides */
        html.light .bg-surface-dark { background-color: #ffffff; }
        html.light .bg-surface-darker { background-color: #f1f5f9; }
        html.light .border-border-dark { border-color: #e2e8f0; }
        html.light .text-text-muted { color: #64748b; }
        html.light body { background-color: #f8fafc; color: #0f172a; }
        
        .report-item.active { border-left: 4px solid #2563eb; background-color: rgba(37, 99, 235, 0.1); }
    </style>
</head>

<body class="bg-background-dark text-white transition-colors duration-300">

    <div class="flex flex-col h-full">
        <!-- Header -->
        <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black tracking-tight">Moderation Queue</h1>
                <p class="text-xs text-text-muted mt-0.5">Review and action reported content</p>
            </div>
            <div class="flex gap-2">
                <button onclick="refreshQueue()" class="p-2 rounded-lg bg-surface-dark border border-border-dark hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined text-[20px]">refresh</span>
                </button>
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-surface-dark border border-border-dark hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined text-[20px] text-amber-400 dark:hidden">light_mode</span>
                    <span class="material-symbols-outlined text-[20px] text-slate-400 hidden dark:block">dark_mode</span>
                </button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar: List -->
            <div class="w-1/3 min-w-[320px] border-r border-border-dark flex flex-col bg-surface-darker">
                <!-- Filters -->
                <div class="p-4 border-b border-border-dark space-y-3">
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-2.5 text-text-muted text-[18px]">search</span>
                        <input type="text" placeholder="Search reports..." 
                            class="w-full bg-surface-dark border border-border-dark rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-1 focus:ring-primary focus:border-primary placeholder-text-muted">
                    </div>
                    <div class="flex gap-1 bg-surface-dark rounded-lg p-1">
                        <button onclick="setFilter('pending')" id="tab-pending" class="flex-1 py-1.5 text-xs font-medium rounded bg-primary text-white">Pending</button>
                        <button onclick="setFilter('resolved')" id="tab-resolved" class="flex-1 py-1.5 text-xs font-medium rounded text-text-muted hover:text-white">Resolved</button>
                    </div>
                </div>

                <!-- List -->
                <div id="report-list" class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-2">
                    <!-- Injected items -->
                    <div class="text-center py-10 text-text-muted text-xs">Loading queue...</div>
                </div>
            </div>

            <!-- Main: Detail -->
            <div class="flex-1 bg-surface-dark flex flex-col overflow-hidden relative">
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-text-muted">
                    <span class="material-symbols-outlined text-6xl mb-4 opacity-20">verified_user</span>
                    <p class="text-sm">Select a report to review</p>
                </div>

                <div id="detail-view" class="hidden flex flex-col h-full">
                    <!-- Detail Header -->
                    <div class="flex-shrink-0 p-6 border-b border-border-dark flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-rose-500/20 text-rose-400" id="detail-reason">SPAM</span>
                                <span class="text-xs text-text-muted" id="detail-date">--</span>
                            </div>
                            <h2 class="text-lg font-bold" id="detail-type">Reported Post</h2>
                            <div class="flex items-center gap-2 mt-2 text-xs">
                                <span class="text-text-muted">Reported by:</span>
                                <span class="font-medium text-white" id="detail-reporter">User</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openExternalLink()" class="text-primary hover:underline text-xs flex items-center gap-1">
                                View Context <span class="material-symbols-outlined text-[14px]">open_in_new</span>
                            </button>
                        </div>
                    </div>

                    <!-- Content Preview -->
                    <div class="flex-1 overflow-y-auto scrollbar-thin p-6">
                        <div class="bg-surface-darker border border-border-dark rounded-xl p-4 mb-6 relative">
                            <span class="absolute -top-3 left-4 px-2 bg-surface-darker text-[10px] font-bold text-text-muted uppercase">Content Preview</span>
                            <div id="detail-content" class="markdown-body">
                                <!-- Content -->
                            </div>
                        </div>

                        <div class="bg-surface-darker border border-border-dark rounded-xl p-4">
                            <span class="text-xs font-bold text-text-muted uppercase block mb-3">Moderator Action</span>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs text-text-muted mb-1.5">Internal Notes</label>
                                    <textarea id="mod-notes" rows="3" class="w-full bg-surface-dark border border-border-dark rounded-lg p-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary" placeholder="Reason for action..."></textarea>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="takeAction('dismiss')" class="py-2.5 rounded-lg border border-border-dark hover:bg-slate-700 text-xs font-bold text-text-muted transition-colors">
                                        Dismiss Report
                                    </button>
                                    <button onclick="takeAction('warn')" class="py-2.5 rounded-lg border border-amber-500/30 text-amber-400 hover:bg-amber-500/10 text-xs font-bold transition-colors">
                                        Issue Warning
                                    </button>
                                    <button onclick="takeAction('hide')" class="py-2.5 rounded-lg border border-border-dark bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold transition-colors">
                                        Hide Content
                                    </button>
                                    <button onclick="takeAction('ban')" class="py-2.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-bold transition-colors">
                                        Ban User
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE
        // ==========================================
        let state = {
            filter: 'pending',
            reports: [],
            activeReportId: null
        };

        // ==========================================
        // BRIDGE
        // ==========================================
        function sendToVelo(type, payload = {}) {
            if (window.parent) {
                window.parent.postMessage({ type, payload }, '*');
            }
        }

        window.onmessage = (event) => {
            const { type, payload } = event.data || {};
            if (!type) return;

            switch (type) {
                case 'queueData':
                    state.reports = payload.items || [];
                    renderList();
                    break;
                case 'actionSuccess':
                    // Remove from list or move to resolved
                    state.reports = state.reports.filter(r => r._id !== payload.reportId);
                    if (state.activeReportId === payload.reportId) {
                        closeDetail();
                    }
                    renderList();
                    break;
            }
        };

        // ==========================================
        // UI LOGIC
        // ==========================================
        function setFilter(filter) {
            state.filter = filter;
            document.getElementById('tab-pending').className = filter === 'pending' ? 'flex-1 py-1.5 text-xs font-medium rounded bg-primary text-white' : 'flex-1 py-1.5 text-xs font-medium rounded text-text-muted hover:text-white';
            document.getElementById('tab-resolved').className = filter === 'resolved' ? 'flex-1 py-1.5 text-xs font-medium rounded bg-primary text-white' : 'flex-1 py-1.5 text-xs font-medium rounded text-text-muted hover:text-white';
            
            // In real app, fetch new data. For prototype, just re-render assuming we have all or fetch
            sendToVelo('getQueue', { status: filter });
        }

        function refreshQueue() {
            sendToVelo('getQueue', { status: state.filter });
        }

        function renderList() {
            const container = document.getElementById('report-list');
            if (state.reports.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-text-muted text-xs">No ${state.filter} reports.</div>`;
                return;
            }

            container.innerHTML = state.reports.map(report => {
                const isActive = report._id === state.activeReportId;
                const severityColor = report.reason === 'spam' ? 'text-amber-400' : 'text-rose-400';
                
                return `
                    <div onclick="selectReport('${report._id}')" 
                        class="report-item p-3 rounded-lg cursor-pointer transition-colors ${isActive ? 'active' : 'hover:bg-surface-dark border-l-4 border-transparent'}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-bold uppercase ${severityColor}">${report.reason}</span>
                            <span class="text-[10px] text-text-muted">${new Date(report.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="text-sm font-medium truncate text-white mb-1">Report on ${report.postId}</div>
                        <div class="text-xs text-text-muted truncate">${report.details || 'No details provided'}</div>
                    </div>
                `;
            }).join('');
        }

        function selectReport(id) {
            state.activeReportId = id;
            renderList(); // Update active state styling
            
            const report = state.reports.find(r => r._id === id);
            if (!report) return;

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');

            // Populate Detail
            document.getElementById('detail-reason').textContent = report.reason;
            document.getElementById('detail-date').textContent = new Date(report.createdAt).toLocaleString();
            document.getElementById('detail-reporter').textContent = report.reporterId || 'Anonymous';
            
            // Assuming payload includes enriched post content
            const content = report.postContent || '*Content not available or deleted*';
            document.getElementById('detail-content').innerHTML = marked.parse(content);
            
            document.getElementById('mod-notes').value = '';
        }

        function closeDetail() {
            state.activeReportId = null;
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            renderList();
        }

        function takeAction(action) {
            const notes = document.getElementById('mod-notes').value;
            if (!state.activeReportId) return;

            // Optimistic UI feedback
            sendToVelo('moderateReport', {
                reportId: state.activeReportId,
                action: action,
                notes: notes
            });
        }

        function openExternalLink() {
            // TODO: Navigate to actual thread
        }

        // ==========================================
        // THEME
        // ==========================================
        const THEME_KEY = 'lmdr-admin-theme';
        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const theme = saved || 'dark';
            if (theme === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem(THEME_KEY, document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        initTheme();
        window.onload = () => {
            sendToVelo('ready');
            refreshQueue();
        };
    </script>
</body>
</html>