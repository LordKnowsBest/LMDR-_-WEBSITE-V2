<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Account Detail</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24', canvas: '#f8fafc' } } } }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }
        body { font-family: 'Inter', sans-serif; }
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .touch-target { min-height: 44px; min-width: 44px; }
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        @supports (padding: max(0px)) { .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); } .safe-top { padding-top: max(16px, env(safe-area-inset-top)); } }
        .timeline-item { position: relative; padding-left: 2rem; }
        .timeline-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -12px; width: 2px; background: #334155; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; border-radius: 50%; border: 2px solid #475569; background: #0f172a; }
    </style>
</head>
<body class="font-sans antialiased bg-slate-950 text-white">

    <div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="flex-shrink-0 border-b border-slate-800 bg-slate-900 px-4 md:px-6 py-4 safe-top">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="goBack()" class="touch-active p-1 rounded-lg hover:bg-slate-800">
                        <span class="material-symbols-outlined text-slate-400">arrow_back</span>
                    </button>
                    <div>
                        <h1 id="accountName" class="text-lg md:text-xl font-black tracking-tight">Loading...</h1>
                        <p id="accountMeta" class="text-xs text-slate-400 mt-0.5">—</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="statusBadge" class="text-xs font-bold px-2.5 py-1 rounded-full bg-slate-700 text-slate-300">—</span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-auto scrollbar-thin">
            <div class="p-4 md:p-6 space-y-6">

                <!-- Top Row: Signal + Opportunity + Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                    <!-- Match Signal Summary -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Match Signal</h3>
                        <div class="flex items-baseline gap-2 mb-2">
                            <span id="signalScore" class="text-3xl font-black text-blue-400">—</span>
                            <span class="text-sm text-slate-500">score</span>
                        </div>
                        <p id="signalDrivers" class="text-sm text-slate-300">— matching drivers</p>
                        <p id="signalRegions" class="text-xs text-slate-500 mt-1">Regions: —</p>
                        <p id="signalEquipment" class="text-xs text-slate-500">Equipment: —</p>
                    </div>

                    <!-- Opportunity Status -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Opportunity</h3>
                        <p class="text-sm text-slate-300">Stage: <span id="oppStage" class="font-semibold text-white">—</span></p>
                        <p class="text-sm text-slate-300 mt-1">Value: <span id="oppValue" class="font-semibold text-emerald-400">—</span></p>
                        <p class="text-sm text-slate-300 mt-1">Next Step: <span id="oppNextStep" class="font-medium text-slate-200">—</span></p>
                        <p id="oppNextStepDate" class="text-xs text-slate-500 mt-0.5">—</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Actions</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="action('call')" class="touch-target touch-active flex items-center gap-2 px-3 py-2.5 rounded-lg bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/30 text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-[18px]">call</span>Call
                            </button>
                            <button onclick="action('email')" class="touch-target touch-active flex items-center gap-2 px-3 py-2.5 rounded-lg bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-[18px]">mail</span>Email
                            </button>
                            <button onclick="action('sms')" class="touch-target touch-active flex items-center gap-2 px-3 py-2.5 rounded-lg bg-amber-600/20 text-amber-400 hover:bg-amber-600/30 text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-[18px]">sms</span>Text
                            </button>
                            <button onclick="action('task')" class="touch-target touch-active flex items-center gap-2 px-3 py-2.5 rounded-lg bg-purple-600/20 text-purple-400 hover:bg-purple-600/30 text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-[18px]">add_task</span>Task
                            </button>
                            <button onclick="action('brief')" class="touch-target touch-active col-span-2 flex items-center justify-center gap-2 px-3 py-2.5 rounded-lg bg-cyan-600/20 text-cyan-400 hover:bg-cyan-600/30 text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-[18px]">auto_awesome</span>Generate Brief
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Two Column: Contacts + Timeline -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">

                    <!-- Contacts -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
                            <h3 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Contacts</h3>
                            <button onclick="action('addContact')" class="touch-active text-xs text-blue-400 hover:text-blue-300 font-medium">+ Add</button>
                        </div>
                        <div id="contactList" class="divide-y divide-slate-800/50 max-h-[300px] overflow-auto scrollbar-thin">
                            <div class="p-4 text-center text-slate-500 text-sm">No contacts yet</div>
                        </div>
                    </div>

                    <!-- Activity Timeline -->
                    <div class="lg:col-span-2 bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
                            <h3 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Activity Timeline</h3>
                            <button onclick="action('logActivity')" class="touch-active text-xs text-blue-400 hover:text-blue-300 font-medium">+ Log Activity</button>
                        </div>
                        <div id="timeline" class="p-4 max-h-[400px] overflow-auto scrollbar-thin space-y-4">
                            <div class="text-center text-slate-500 text-sm py-4">No activities yet</div>
                        </div>
                    </div>
                </div>

                <!-- Deal Risks & Notes -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Deal Risks & Notes</h3>
                    <div id="riskList" class="space-y-2">
                        <p class="text-sm text-slate-500">No risks identified</p>
                    </div>
                </div>

            </div>
            <div class="safe-bottom"></div>
        </main>
    </div>

    <script>
        let currentAccountId = null;

        const VALID_ACTIONS = ['init', 'accountLoaded', 'signalLoaded', 'opportunityLoaded', 'contactsLoaded', 'timelineLoaded', 'risksLoaded', 'actionSuccess', 'actionError'];

        function isValidMessage(data) {
            return data && typeof data === 'object' && typeof data.action === 'string' && VALID_ACTIONS.includes(data.action);
        }

        function sendToVelo(message) { window.parent.postMessage(message, '*'); }

        window.addEventListener('message', function(event) {
            const data = event.data;
            if (!isValidMessage(data)) return;

            switch (data.action) {
                case 'init':
                    if (data.accountId) { currentAccountId = data.accountId; loadAccount(data.accountId); }
                    break;
                case 'accountLoaded': renderAccount(data.payload); break;
                case 'signalLoaded': renderSignal(data.payload); break;
                case 'opportunityLoaded': renderOpportunity(data.payload); break;
                case 'contactsLoaded': renderContacts(data.payload); break;
                case 'timelineLoaded': renderTimeline(data.payload); break;
                case 'risksLoaded': renderRisks(data.payload); break;
                case 'actionSuccess': showToast(data.message || 'Done', 'success'); break;
                case 'actionError': showToast(data.message || 'Error', 'error'); break;
            }
        });

        function loadAccount(accountId) {
            sendToVelo({ action: 'getAccount', accountId });
            sendToVelo({ action: 'getSignal', accountId });
            sendToVelo({ action: 'getOpportunity', accountId });
            sendToVelo({ action: 'getContacts', accountId });
            sendToVelo({ action: 'getTimeline', accountId, limit: 30 });
            sendToVelo({ action: 'getRisks', accountId });
        }

        function renderAccount(account) {
            if (!account) return;
            currentAccountId = account._id || account.id;
            setText('accountName', account.carrier_name || 'Unknown');
            setText('accountMeta', `DOT ${account.carrier_dot || '—'} · ${account.segment || '—'} · ${account.region || '—'} · Fleet ${account.fleet_size || '?'}`);
            const badge = document.getElementById('statusBadge');
            const statusColors = { target: 'bg-slate-700 text-slate-300', prospecting: 'bg-blue-500/20 text-blue-400', engaged: 'bg-amber-500/20 text-amber-400', client: 'bg-emerald-500/20 text-emerald-400', churned: 'bg-red-500/20 text-red-400' };
            badge.className = `text-xs font-bold px-2.5 py-1 rounded-full ${statusColors[account.status] || statusColors.target}`;
            badge.textContent = (account.status || 'target').replace('_', ' ');
        }

        function renderSignal(signal) {
            if (!signal) return;
            setText('signalScore', signal.signal_score || '—');
            setText('signalDrivers', (signal.driver_count_high_match || 0) + ' matching drivers');
            setText('signalRegions', 'Regions: ' + (signal.top_regions || '—'));
            setText('signalEquipment', 'Equipment: ' + (signal.top_equipment || '—'));
        }

        function renderOpportunity(opp) {
            if (!opp) { setText('oppStage', 'None'); return; }
            setText('oppStage', opp.stage || '—');
            setText('oppValue', formatCurrency(opp.value_estimate || 0));
            setText('oppNextStep', opp.next_step || 'Not set');
            setText('oppNextStepDate', opp.next_step_at ? 'Due: ' + new Date(opp.next_step_at).toLocaleDateString() : '');
        }

        function renderContacts(contacts) {
            const container = document.getElementById('contactList');
            if (!contacts || contacts.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-500 text-sm">No contacts yet</div>';
                return;
            }
            container.innerHTML = contacts.map(c => `
                <div class="px-4 py-3">
                    <p class="text-sm font-semibold text-slate-100">${esc(c.name)}</p>
                    <p class="text-xs text-slate-400">${esc(c.role || 'No role')}</p>
                    <div class="flex items-center gap-3 mt-1.5">
                        ${c.phone ? `<a href="tel:${esc(c.phone)}" class="text-xs text-blue-400 hover:underline">${esc(c.phone)}</a>` : ''}
                        ${c.email ? `<span class="text-xs text-slate-500">${esc(c.email)}</span>` : ''}
                    </div>
                    <span class="inline-block mt-1 text-[10px] px-1.5 py-0.5 rounded ${c.consent_status === 'opted_out' ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-400'}">${esc(c.consent_status || 'pending')}</span>
                </div>
            `).join('');
        }

        function renderTimeline(activities) {
            const container = document.getElementById('timeline');
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 text-sm py-4">No activities yet</div>';
                return;
            }
            const iconMap = { email: 'mail', sms: 'sms', call: 'call', meeting: 'groups', task: 'task_alt', note: 'sticky_note_2', stage_change: 'swap_horiz', signal: 'auto_awesome' };
            const colorMap = { email: 'border-blue-500', sms: 'border-amber-500', call: 'border-emerald-500', meeting: 'border-purple-500', task: 'border-cyan-500', note: 'border-slate-500', stage_change: 'border-pink-500' };

            container.innerHTML = activities.map(a => {
                const d = a.created_at ? new Date(a.created_at) : null;
                const dateStr = d ? d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot ${colorMap[a.type] || 'border-slate-600'}"></div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[16px] text-slate-400">${iconMap[a.type] || 'circle'}</span>
                                <span class="text-xs text-slate-500">${dateStr}</span>
                            </div>
                            <p class="text-sm text-slate-200 mt-0.5">${esc(a.subject || a.type)}</p>
                            ${a.notes ? `<p class="text-xs text-slate-500 mt-0.5">${esc(a.notes)}</p>` : ''}
                            ${a.outcome ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-400 mt-1 inline-block">${esc(a.outcome)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRisks(risks) {
            const container = document.getElementById('riskList');
            if (!risks || risks.length === 0) {
                container.innerHTML = '<p class="text-sm text-emerald-400">No risks identified</p>';
                return;
            }
            container.innerHTML = risks.map(r => `
                <div class="flex items-start gap-2 px-3 py-2 rounded-lg ${r.type === 'sla_breach' || r.type === 'overdue' ? 'bg-red-500/10' : 'bg-amber-500/10'}">
                    <span class="material-symbols-outlined text-[16px] mt-0.5 ${r.type === 'sla_breach' || r.type === 'overdue' ? 'text-red-400' : 'text-amber-400'}">warning</span>
                    <p class="text-sm ${r.type === 'sla_breach' || r.type === 'overdue' ? 'text-red-300' : 'text-amber-300'}">${esc(r.message)}</p>
                </div>
            `).join('');
        }

        function action(type) {
            sendToVelo({ action: 'accountAction', type, accountId: currentAccountId });
        }

        function goBack() { sendToVelo({ action: 'navigate', target: 'dashboard' }); }

        function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
        function esc(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = String(str); return d.innerHTML; }
        function formatCurrency(v) { const n = Number(v) || 0; if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M'; if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'k'; return '$' + n; }
        function showToast(msg, type = 'info') {
            const c = document.getElementById('toastContainer');
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', info: 'bg-blue-600' };
            const t = document.createElement('div');
            t.className = `toast ${colors[type] || colors.info} text-white text-sm px-4 py-3 rounded-lg shadow-lg`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>
