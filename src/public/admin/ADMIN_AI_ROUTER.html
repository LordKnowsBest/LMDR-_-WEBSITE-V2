<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - AI Router</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #e2e8f0;
        }

        .touch-target { min-height: 44px; min-width: 44px; }

        /* Provider colors */
        .provider-anthropic { background: linear-gradient(135deg, #d97706, #b45309); }
        .provider-openai { background: linear-gradient(135deg, #10b981, #059669); }
        .provider-groq { background: linear-gradient(135deg, #f97316, #ea580c); }
        .provider-perplexity { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .provider-google { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .provider-mistral { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .provider-cohere { background: linear-gradient(135deg, #ec4899, #db2777); }

        .provider-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        /* Category badges */
        .category-enrichment { background: #7c3aed20; color: #a78bfa; border: 1px solid #7c3aed40; }
        .category-research { background: #06b6d420; color: #22d3ee; border: 1px solid #06b6d440; }
        .category-documents { background: #f5940620; color: #fbbf24; border: 1px solid #f5940640; }
        .category-real-time { background: #f9731620; color: #fb923c; border: 1px solid #f9731640; }
        .category-chat { background: #10b98120; color: #34d399; border: 1px solid #10b98140; }
        .category-analysis { background: #ec489920; color: #f472b6; border: 1px solid #ec489940; }
        .category-processing { background: #6366f120; color: #818cf8; border: 1px solid #6366f140; }
        .category-search { background: #14b8a620; color: #2dd4bf; border: 1px solid #14b8a640; }

        /* Status indicators */
        .status-healthy { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-not_configured { color: #f59e0b; }
        .status-testing { color: #3b82f6; }

        /* Cards */
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
        }

        .function-card {
            transition: all 0.2s ease;
        }
        .function-card:hover {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: #374151;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .toggle-switch.active { background: #10b981; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .toggle-switch.active::after { transform: translateX(22px); }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
        }
        .modal-backdrop.open { opacity: 1; visibility: visible; }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-content.open { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }

        /* Speed indicator */
        .speed-ultra-fast { color: #10b981; }
        .speed-fast { color: #22d3ee; }
        .speed-medium { color: #fbbf24; }
        .speed-slow { color: #f97316; }

        /* Quality indicator */
        .quality-highest { color: #a78bfa; }
        .quality-high { color: #60a5fa; }
        .quality-good { color: #34d399; }
        .quality-standard { color: #9ca3af; }

        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s infinite; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #059669; color: white; }
        .toast.error { background: #dc2626; color: white; }

        /* Tabs */
        .tab-btn {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
            background: rgba(129, 140, 248, 0.1);
        }

        /* Light mode overrides */
        html.light body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #1e293b; }
        html.light .glass-card { background: rgba(255, 255, 255, 0.9); border-color: rgba(226, 232, 240, 0.5); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); }
        html.light .text-white { color: #1e293b; }
        html.light .text-slate-400 { color: #64748b; }
        html.light .text-slate-500 { color: #64748b; }
        html.light .bg-slate-700 { background-color: #e2e8f0; }
        html.light .border-slate-700 { border-color: #e2e8f0; }
        html.light .func-card { background: rgba(255, 255, 255, 0.8); border-color: rgba(226, 232, 240, 0.5); }
        html.light .func-card:hover { border-color: #94a3b8; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass-card mx-4 mt-4 mb-6">
        <div class="p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-robot text-indigo-400"></i>
                        AI Router Configuration
                    </h1>
                    <p class="text-sm text-slate-400 mt-1">Configure LLM providers for each system function</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="themeToggle" onclick="toggleTheme()" class="touch-target w-10 h-10 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="testAllBtn" class="touch-target px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-vial mr-2"></i>Test All
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-t border-slate-700 overflow-x-auto">
            <button class="tab-btn active flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="functions">
                <i class="fas fa-cogs mr-2"></i>Functions
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="providers">
                <i class="fas fa-cloud mr-2"></i>Providers
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="usage">
                <i class="fas fa-chart-bar mr-2"></i>Usage
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 pb-8">
        <!-- Functions Tab -->
        <div id="functionsTab" class="tab-content">
            <!-- Category Filter -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium bg-slate-700 text-white" data-category="all">All</button>
                <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium category-enrichment" data-category="enrichment">Enrichment</button>
                <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium category-research" data-category="research">Research</button>
                <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium category-documents" data-category="documents">Documents</button>
                <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium category-chat" data-category="chat">Chat</button>
                <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium category-real-time" data-category="real-time">Real-time</button>
            </div>

            <!-- Function Cards -->
            <div id="functionsList" class="grid gap-4">
                <div class="skeleton h-32 rounded-xl"></div>
                <div class="skeleton h-32 rounded-xl"></div>
                <div class="skeleton h-32 rounded-xl"></div>
            </div>
        </div>

        <!-- Providers Tab -->
        <div id="providersTab" class="tab-content hidden">
            <div id="providersList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="skeleton h-48 rounded-xl"></div>
                <div class="skeleton h-48 rounded-xl"></div>
                <div class="skeleton h-48 rounded-xl"></div>
            </div>
        </div>

        <!-- Usage Tab -->
        <div id="usageTab" class="tab-content hidden">
            <!-- Stats Overview -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-card p-4">
                    <p class="text-xs text-slate-400 uppercase tracking-wide">Total Calls</p>
                    <p id="statTotalCalls" class="text-2xl font-bold text-white mt-1">-</p>
                </div>
                <div class="glass-card p-4">
                    <p class="text-xs text-slate-400 uppercase tracking-wide">Tokens Used</p>
                    <p id="statTotalTokens" class="text-2xl font-bold text-white mt-1">-</p>
                </div>
                <div class="glass-card p-4">
                    <p class="text-xs text-slate-400 uppercase tracking-wide">Avg Latency</p>
                    <p id="statAvgLatency" class="text-2xl font-bold text-white mt-1">-</p>
                </div>
                <div class="glass-card p-4">
                    <p class="text-xs text-slate-400 uppercase tracking-wide">Error Rate</p>
                    <p id="statErrorRate" class="text-2xl font-bold text-white mt-1">-</p>
                </div>
            </div>

            <!-- Period Toggle -->
            <div class="flex gap-2 mb-4">
                <button class="usage-period-btn px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white" data-period="week">This Week</button>
                <button class="usage-period-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300" data-period="month">This Month</button>
            </div>

            <!-- Usage by Provider -->
            <div class="glass-card p-4 mb-4">
                <h3 class="text-lg font-semibold text-white mb-4">Usage by Provider</h3>
                <div id="providerUsageList" class="space-y-3">
                    <div class="skeleton h-12 rounded"></div>
                    <div class="skeleton h-12 rounded"></div>
                </div>
            </div>

            <!-- Usage by Function -->
            <div class="glass-card p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Usage by Function</h3>
                <div id="functionUsageList" class="space-y-3">
                    <div class="skeleton h-12 rounded"></div>
                    <div class="skeleton h-12 rounded"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Configure Modal -->
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="configModal" class="modal-content glass-card">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-lg font-bold text-white">Configure Function</h3>
                <button id="closeModalBtn" class="touch-target p-2 text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="configForm" class="space-y-4">
                <input type="hidden" id="configFunctionId">

                <!-- Provider Select -->
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Provider</label>
                    <select id="configProvider" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select provider...</option>
                    </select>
                </div>

                <!-- Model Select -->
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Model</label>
                    <select id="configModel" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select model...</option>
                    </select>
                </div>

                <!-- Model Info -->
                <div id="modelInfo" class="hidden p-3 bg-slate-800 rounded-lg">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-slate-400">Speed:</span>
                            <span id="modelSpeed" class="ml-2 font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-slate-400">Quality:</span>
                            <span id="modelQuality" class="ml-2 font-medium">-</span>
                        </div>
                    </div>
                </div>

                <!-- Fallback Provider -->
                <div class="pt-4 border-t border-slate-700">
                    <label class="block text-sm text-slate-400 mb-2">Fallback Provider (Optional)</label>
                    <select id="configFallbackProvider" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                        <option value="">No fallback</option>
                    </select>
                </div>

                <!-- Fallback Model -->
                <div id="fallbackModelSection" class="hidden">
                    <label class="block text-sm text-slate-400 mb-2">Fallback Model</label>
                    <select id="configFallbackModel" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                        <option value="">Select model...</option>
                    </select>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="resetConfigBtn" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors">
                        Reset to Default
                    </button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors">
                        Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // State
        let currentTab = 'functions';
        let providers = {};
        let functions = {};
        let config = {};
        let selectedCategory = 'all';
        let editingFunctionId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        // Listen for messages from Velo
        window.onmessage = (event) => {
            const { action, payload, message } = event.data;

            switch (action) {
                case 'init':
                    loadInitialData();
                    break;
                case 'configLoaded':
                    config = payload;
                    renderFunctions();
                    break;
                case 'providersLoaded':
                    providers = payload;
                    renderProviders();
                    populateProviderSelects();
                    break;
                case 'functionsLoaded':
                    functions = payload;
                    break;
                case 'modelsLoaded':
                    populateModelSelect(payload.providerId, payload.models);
                    break;
                case 'usageStatsLoaded':
                    renderUsageStats(payload);
                    break;
                case 'configUpdated':
                    showToast('Configuration saved successfully', 'success');
                    closeModal();
                    break;
                case 'configReset':
                    showToast('Configuration reset to default', 'success');
                    closeModal();
                    break;
                case 'testingProvider':
                    updateProviderStatus(payload.providerId, 'testing');
                    break;
                case 'providerTestResult':
                    handleTestResult(payload);
                    break;
                case 'testingAllProviders':
                    showToast('Testing all providers...', 'success');
                    break;
                case 'allProvidersTestResult':
                    handleAllTestResults(payload);
                    break;
                case 'actionError':
                    showToast(message, 'error');
                    break;
            }
        };

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Category filter
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedCategory = btn.dataset.category;
                    document.querySelectorAll('.category-filter').forEach(b => {
                        b.classList.remove('bg-slate-700', 'text-white');
                        b.classList.add('bg-transparent');
                    });
                    btn.classList.add('bg-slate-700', 'text-white');
                    renderFunctions();
                });
            });

            // Test all providers
            document.getElementById('testAllBtn').addEventListener('click', () => {
                sendToVelo({ action: 'testAllProviders' });
            });

            // Modal
            document.getElementById('modalBackdrop').addEventListener('click', closeModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);

            // Config form
            document.getElementById('configProvider').addEventListener('change', (e) => {
                if (e.target.value) {
                    sendToVelo({ action: 'getModels', providerId: e.target.value });
                }
            });

            document.getElementById('configModel').addEventListener('change', (e) => {
                updateModelInfo();
            });

            document.getElementById('configFallbackProvider').addEventListener('change', (e) => {
                const section = document.getElementById('fallbackModelSection');
                if (e.target.value) {
                    section.classList.remove('hidden');
                    // Load fallback models
                    const provider = providers[e.target.value];
                    if (provider) {
                        const select = document.getElementById('configFallbackModel');
                        select.innerHTML = '<option value="">Select model...</option>' +
                            provider.models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    }
                } else {
                    section.classList.add('hidden');
                }
            });

            document.getElementById('configForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveConfiguration();
            });

            document.getElementById('resetConfigBtn').addEventListener('click', () => {
                if (editingFunctionId) {
                    sendToVelo({ action: 'resetConfig', functionId: editingFunctionId });
                }
            });

            // Usage period
            document.querySelectorAll('.usage-period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.usage-period-btn').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white');
                        b.classList.add('bg-slate-700', 'text-slate-300');
                    });
                    btn.classList.remove('bg-slate-700', 'text-slate-300');
                    btn.classList.add('bg-indigo-600', 'text-white');
                    sendToVelo({ action: 'getUsageStats', period: btn.dataset.period });
                });
            });
        }

        function loadInitialData() {
            sendToVelo({ action: 'getProviders' });
            sendToVelo({ action: 'getConfig' });
            sendToVelo({ action: 'getUsageStats', period: 'week' });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
        }

        function renderFunctions() {
            const container = document.getElementById('functionsList');

            const filteredConfig = Object.entries(config).filter(([id, func]) => {
                if (selectedCategory === 'all') return true;
                return func.category === selectedCategory;
            });

            if (filteredConfig.length === 0) {
                container.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <i class="fas fa-cogs text-4xl text-slate-600 mb-3"></i>
                        <p class="text-slate-400">No functions in this category</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredConfig.map(([funcId, func]) => {
                const provider = providers[func.provider] || { name: func.provider };
                const providerClass = `provider-${func.provider}`;

                return `
                    <div class="function-card glass-card p-4" data-function="${funcId}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-semibold text-white">${escapeHtml(func.name)}</h3>
                                    <span class="px-2 py-0.5 rounded text-xs category-${func.category}">${func.category}</span>
                                    ${func.isCustomized ? '<span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded text-xs">Customized</span>' : ''}
                                </div>
                                <p class="text-sm text-slate-400">${escapeHtml(func.description)}</p>
                            </div>
                            <button class="touch-target p-2 text-slate-400 hover:text-white" onclick="openConfigModal('${funcId}')">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="provider-badge ${providerClass}">
                                    ${getProviderIcon(func.provider)}
                                    ${escapeHtml(provider.name || func.provider)}
                                </span>
                                <span class="text-sm text-slate-500">${escapeHtml(func.model)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Priority: ${func.priority}</span>
                            </div>
                        </div>

                        ${func.fallbackProvider ? `
                            <div class="mt-3 pt-3 border-t border-slate-700 flex items-center gap-2 text-sm text-slate-400">
                                <i class="fas fa-shield-alt text-xs"></i>
                                Fallback: ${escapeHtml(func.fallbackProvider)} / ${escapeHtml(func.fallbackModel || 'default')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderProviders() {
            const container = document.getElementById('providersList');

            container.innerHTML = Object.entries(providers).map(([id, provider]) => {
                const statusClass = provider.configured ? 'status-healthy' : 'status-not_configured';
                const statusIcon = provider.configured ? 'check-circle' : 'exclamation-circle';
                const statusText = provider.configured ? 'Configured' : 'Not Configured';

                return `
                    <div class="glass-card p-4 provider-card" data-provider="${id}">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white provider-${id}">
                                    ${getProviderIcon(id)}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-white">${escapeHtml(provider.name)}</h3>
                                    <p class="text-xs ${statusClass}">
                                        <i class="fas fa-${statusIcon} mr-1"></i>${statusText}
                                    </p>
                                </div>
                            </div>
                            <button class="touch-target px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm" onclick="testProvider('${id}')">
                                <i class="fas fa-vial mr-1"></i>Test
                            </button>
                        </div>

                        <p class="text-sm text-slate-400 mb-4">${escapeHtml(provider.description)}</p>

                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-500">Latency</span>
                                <span class="text-slate-300">${provider.characteristics?.latency || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Cost Tier</span>
                                <span class="text-slate-300">${provider.characteristics?.costTier || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Models</span>
                                <span class="text-slate-300">${provider.models?.length || 0}</span>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <p class="text-xs text-slate-500 mb-2">Capabilities</p>
                            <div class="flex flex-wrap gap-1">
                                ${(provider.capabilities || []).slice(0, 5).map(cap =>
                                    `<span class="px-2 py-0.5 bg-slate-700 text-slate-300 rounded text-xs">${cap}</span>`
                                ).join('')}
                            </div>
                        </div>

                        ${!provider.configured ? `
                            <div class="mt-4 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                                <p class="text-xs text-amber-400">
                                    <i class="fas fa-key mr-1"></i>
                                    Set secret: <code class="bg-slate-800 px-1 rounded">${provider.apiKeySecret}</code>
                                </p>
                            </div>
                        ` : ''}

                        <div id="testResult-${id}" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                    </div>
                `;
            }).join('');
        }

        function renderUsageStats(stats) {
            document.getElementById('statTotalCalls').textContent = stats.totalCalls.toLocaleString();
            document.getElementById('statTotalTokens').textContent = formatTokens(stats.totalTokens);
            document.getElementById('statAvgLatency').textContent = stats.avgLatency + 'ms';
            document.getElementById('statErrorRate').textContent = stats.errorRate + '%';

            // Provider usage
            const providerContainer = document.getElementById('providerUsageList');
            const providerEntries = Object.entries(stats.byProvider);

            if (providerEntries.length === 0) {
                providerContainer.innerHTML = '<p class="text-slate-500 text-sm">No usage data yet</p>';
            } else {
                const maxCalls = Math.max(...providerEntries.map(([_, p]) => p.calls));
                providerContainer.innerHTML = providerEntries.map(([id, data]) => {
                    const width = maxCalls > 0 ? (data.calls / maxCalls * 100) : 0;
                    const provider = providers[id] || { name: id };

                    return `
                        <div class="flex items-center gap-4">
                            <div class="w-32 flex items-center gap-2">
                                <span class="w-6 h-6 rounded flex items-center justify-center text-xs text-white provider-${id}">
                                    ${getProviderIcon(id)}
                                </span>
                                <span class="text-sm text-slate-300 truncate">${escapeHtml(provider.name || id)}</span>
                            </div>
                            <div class="flex-1 h-6 bg-slate-800 rounded overflow-hidden">
                                <div class="h-full provider-${id}" style="width: ${width}%"></div>
                            </div>
                            <div class="w-20 text-right text-sm text-slate-400">${data.calls.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }

            // Function usage
            const functionContainer = document.getElementById('functionUsageList');
            const functionEntries = Object.entries(stats.byFunction);

            if (functionEntries.length === 0) {
                functionContainer.innerHTML = '<p class="text-slate-500 text-sm">No usage data yet</p>';
            } else {
                const maxFuncCalls = Math.max(...functionEntries.map(([_, f]) => f.calls));
                functionContainer.innerHTML = functionEntries.map(([id, data]) => {
                    const width = maxFuncCalls > 0 ? (data.calls / maxFuncCalls * 100) : 0;
                    const func = config[id] || { name: id };

                    return `
                        <div class="flex items-center gap-4">
                            <div class="w-40 text-sm text-slate-300 truncate">${escapeHtml(func.name || id)}</div>
                            <div class="flex-1 h-6 bg-slate-800 rounded overflow-hidden">
                                <div class="h-full bg-indigo-500" style="width: ${width}%"></div>
                            </div>
                            <div class="w-20 text-right text-sm text-slate-400">${data.calls.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function openConfigModal(functionId) {
            editingFunctionId = functionId;
            const func = config[functionId];

            document.getElementById('modalTitle').textContent = `Configure: ${func.name}`;
            document.getElementById('configFunctionId').value = functionId;

            // Populate provider select
            const providerSelect = document.getElementById('configProvider');
            providerSelect.innerHTML = '<option value="">Select provider...</option>' +
                Object.entries(providers).map(([id, p]) =>
                    `<option value="${id}" ${id === func.provider ? 'selected' : ''}>${p.name}</option>`
                ).join('');

            // Load models for current provider
            if (func.provider) {
                sendToVelo({ action: 'getModels', providerId: func.provider });
            }

            // Fallback provider
            const fallbackSelect = document.getElementById('configFallbackProvider');
            fallbackSelect.innerHTML = '<option value="">No fallback</option>' +
                Object.entries(providers).map(([id, p]) =>
                    `<option value="${id}" ${id === func.fallbackProvider ? 'selected' : ''}>${p.name}</option>`
                ).join('');

            if (func.fallbackProvider) {
                document.getElementById('fallbackModelSection').classList.remove('hidden');
                const provider = providers[func.fallbackProvider];
                if (provider) {
                    document.getElementById('configFallbackModel').innerHTML =
                        '<option value="">Select model...</option>' +
                        provider.models.map(m =>
                            `<option value="${m.id}" ${m.id === func.fallbackModel ? 'selected' : ''}>${m.name}</option>`
                        ).join('');
                }
            } else {
                document.getElementById('fallbackModelSection').classList.add('hidden');
            }

            document.getElementById('modalBackdrop').classList.add('open');
            document.getElementById('configModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('modalBackdrop').classList.remove('open');
            document.getElementById('configModal').classList.remove('open');
            editingFunctionId = null;
        }

        function populateProviderSelects() {
            // Already handled in openConfigModal
        }

        function populateModelSelect(providerId, models) {
            const func = config[editingFunctionId];
            const select = document.getElementById('configModel');

            select.innerHTML = '<option value="">Select model...</option>' +
                models.map(m =>
                    `<option value="${m.id}" data-speed="${m.speed}" data-quality="${m.quality}" ${m.id === func?.model ? 'selected' : ''}>
                        ${m.name} (${m.tier})
                    </option>`
                ).join('');

            updateModelInfo();
        }

        function updateModelInfo() {
            const select = document.getElementById('configModel');
            const option = select.options[select.selectedIndex];
            const infoDiv = document.getElementById('modelInfo');

            if (option && option.value) {
                const speed = option.dataset.speed;
                const quality = option.dataset.quality;

                document.getElementById('modelSpeed').textContent = speed;
                document.getElementById('modelSpeed').className = `ml-2 font-medium speed-${speed}`;

                document.getElementById('modelQuality').textContent = quality;
                document.getElementById('modelQuality').className = `ml-2 font-medium quality-${quality}`;

                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function saveConfiguration() {
            const functionId = document.getElementById('configFunctionId').value;
            const config = {
                provider: document.getElementById('configProvider').value,
                model: document.getElementById('configModel').value,
                fallbackProvider: document.getElementById('configFallbackProvider').value || null,
                fallbackModel: document.getElementById('configFallbackModel').value || null,
                enabled: true
            };

            if (!config.provider || !config.model) {
                showToast('Please select a provider and model', 'error');
                return;
            }

            sendToVelo({ action: 'updateConfig', functionId, config });
        }

        function testProvider(providerId) {
            sendToVelo({ action: 'testProvider', providerId });
        }

        function updateProviderStatus(providerId, status) {
            const resultDiv = document.getElementById(`testResult-${providerId}`);
            if (resultDiv) {
                resultDiv.classList.remove('hidden');
                resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-blue-500/10 border border-blue-500/30';
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
            }
        }

        function handleTestResult(result) {
            const resultDiv = document.getElementById(`testResult-${result.provider}`);
            if (resultDiv) {
                resultDiv.classList.remove('hidden');

                if (result.status === 'healthy') {
                    resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-green-500/10 border border-green-500/30 text-green-400';
                    resultDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Healthy (${result.latencyMs}ms)`;
                } else if (result.status === 'not_configured') {
                    resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-amber-500/10 border border-amber-500/30 text-amber-400';
                    resultDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${result.message}`;
                } else {
                    resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500/10 border border-red-500/30 text-red-400';
                    resultDiv.innerHTML = `<i class="fas fa-times-circle mr-2"></i>${result.message}`;
                }
            }
        }

        function handleAllTestResults(results) {
            Object.entries(results).forEach(([providerId, result]) => {
                handleTestResult({ ...result, provider: providerId });
            });
            showToast('All provider tests complete', 'success');
        }

        function getProviderIcon(providerId) {
            const icons = {
                anthropic: '<i class="fas fa-brain"></i>',
                openai: '<i class="fas fa-robot"></i>',
                groq: '<i class="fas fa-bolt"></i>',
                perplexity: '<i class="fas fa-search"></i>',
                google: '<i class="fab fa-google"></i>',
                mistral: '<i class="fas fa-wind"></i>',
                cohere: '<i class="fas fa-link"></i>'
            };
            return icons[providerId] || '<i class="fas fa-cloud"></i>';
        }

        function formatTokens(tokens) {
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(1) + 'K';
            return tokens.toString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function sendToVelo(message) {
            window.parent.postMessage(message, '*');
        }

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        const THEME_KEY = 'lmdr-admin-theme';

        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'dark');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
            } else {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
            }
            updateThemeIcon(theme);
        }

        function toggleTheme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        }

        function updateThemeIcon(theme) {
            const btn = document.getElementById('themeToggle');
            if (btn) {
                btn.innerHTML = theme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        }

        // Initialize theme on load
        initTheme();
    </script>
</body>
</html>
