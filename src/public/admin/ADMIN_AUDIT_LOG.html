<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>VelocityMatch Admin - Audit Log</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2563eb",
                        "primary-dark": "#1d4ed8",
                        "background-dark": "#0f172a",
                        "surface-dark": "#1e293b",
                        "surface-darker": "#0f172a",
                        "border-dark": "#334155",
                        "text-muted": "#94a3b8",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }

        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .touch-target { min-height: 44px; min-width: 44px; }
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }

        @supports (padding: max(0px)) {
            .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
            .safe-top { padding-top: max(16px, env(safe-area-inset-top)); }
        }

        .modal-backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }

        .filter-dropdown { display: none; position: absolute; top: calc(100% + 4px); left: 0; z-index: 40; min-width: 200px; }
        .filter-dropdown.open { display: block; }

        @media (max-width: 767px) {
            .filter-dropdown {
                position: fixed;
                left: 16px;
                right: 16px;
                top: auto;
                bottom: 0;
                border-radius: 16px 16px 0 0;
                max-height: 60vh;
                overflow-y: auto;
            }
            .filter-dropdown::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #475569;
                border-radius: 2px;
                margin: 8px auto 16px;
            }
        }

        .mobile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 39;
            display: none;
        }
        .mobile-overlay.open { display: block; }

        .swipe-hint {
            width: 40px;
            height: 4px;
            background: #475569;
            border-radius: 2px;
            margin: 8px auto;
        }

        /* Category colors */
        .category-driver { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .category-carrier { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .category-system { background: rgba(234, 179, 8, 0.2); color: #fbbf24; }
        .category-auth { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .category-other { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }

        /* Audit entry card */
        .audit-entry {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        /* Timeline connector */
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .timeline-line {
            width: 2px;
            background: #334155;
            flex-shrink: 0;
        }

        /* Light mode overrides */
        html.light body { background-color: #f1f5f9; color: #1e293b; }
        html.light .bg-background-dark { background-color: #f1f5f9; }
        html.light .bg-surface-dark { background-color: #ffffff; }
        html.light .bg-surface-darker { background-color: #f8fafc; }
        html.light .bg-surface-darker\/50 { background-color: rgba(248, 250, 252, 0.5); }
        html.light .border-border-dark { border-color: #e2e8f0; }
        html.light .text-white { color: #1e293b; }
        html.light .text-text-muted { color: #64748b; }
        html.light .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); }
        html.light .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        html.light .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; }
        html.light .timeline-dot { border-color: #e2e8f0; background: #f8fafc; }
        html.light .timeline-line { background: #e2e8f0; }
    </style>
</head>
<body class="bg-background-dark font-display text-white antialiased">

<!-- Mobile Overlay -->
<div id="mobileOverlay" class="mobile-overlay" onclick="closeAllMenus()"></div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

<!-- Main Container -->
<div class="flex flex-col h-full">

    <!-- Header -->
    <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-3 md:py-4 safe-top">
        <!-- Mobile Header -->
        <div class="flex items-center justify-between md:hidden mb-3">
            <h1 class="text-xl font-black tracking-tight">Audit Log</h1>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" id="themeToggleMobile" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark">
                    <span class="material-symbols-outlined text-[20px]">dark_mode</span>
                </button>
                <button onclick="exportAuditLog()" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark">
                    <span class="material-symbols-outlined text-[20px]">download</span>
                </button>
            </div>
        </div>

        <!-- Desktop Header -->
        <div class="hidden md:flex flex-wrap justify-between gap-4">
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2 text-sm text-text-muted mb-1">
                    <span>Dashboard</span>
                    <span>/</span>
                    <span class="text-white">Audit Log</span>
                </div>
                <h1 class="text-2xl font-black tracking-tight">Admin Audit Log</h1>
                <p class="text-sm text-text-muted">Track all administrative actions for compliance and security.</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" id="themeToggleDesktop" class="flex h-10 w-10 items-center justify-center rounded-lg bg-surface-dark border border-border-dark hover:bg-[#2d3a4f] transition-colors" title="Toggle theme">
                    <span class="material-symbols-outlined text-[18px]">dark_mode</span>
                </button>
                <button onclick="switchTab('log')" class="flex h-10 items-center justify-center gap-2 rounded-lg bg-surface-dark border border-border-dark px-4 text-sm font-medium hover:bg-[#2d3a4f] transition-colors tab-nav-btn active" data-tab="log">
                    <span class="material-symbols-outlined text-[18px]">list_alt</span>
                    <span>Audit Log</span>
                </button>
                <button onclick="switchTab('reports')" class="flex h-10 items-center justify-center gap-2 rounded-lg bg-surface-dark border border-border-dark px-4 text-sm font-medium hover:bg-[#2d3a4f] transition-colors tab-nav-btn" data-tab="reports">
                    <span class="material-symbols-outlined text-[18px]">analytics</span>
                    <span>Compliance Reports</span>
                </button>
                <button onclick="exportAuditLog()" class="flex h-10 items-center justify-center gap-2 rounded-lg bg-primary border border-primary px-4 text-sm font-medium hover:bg-primary-dark transition-colors">
                    <span class="material-symbols-outlined text-[18px]">download</span>
                    <span>Export CSV</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Stats Cards - Mobile Scrollable -->
    <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 border-b border-border-dark bg-surface-darker/50">
        <div class="flex md:grid md:grid-cols-4 gap-3 md:gap-4 overflow-x-auto scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0 pb-1">
            <div class="flex-shrink-0 w-36 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-3 md:p-4">
                <div class="flex items-center justify-between mb-1.5 md:mb-2">
                    <span class="text-text-muted text-[10px] md:text-xs font-medium uppercase">Total</span>
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-primary/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-[14px] md:text-[18px]">history</span>
                    </div>
                </div>
                <div class="text-xl md:text-2xl font-bold" id="statTotal">--</div>
                <div class="text-[10px] md:text-xs text-text-muted">all time</div>
            </div>
            <div class="flex-shrink-0 w-36 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-3 md:p-4">
                <div class="flex items-center justify-between mb-1.5 md:mb-2">
                    <span class="text-text-muted text-[10px] md:text-xs font-medium uppercase">Today</span>
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-emerald-400 text-[14px] md:text-[18px]">today</span>
                    </div>
                </div>
                <div class="text-xl md:text-2xl font-bold" id="statToday">--</div>
                <div class="text-[10px] md:text-xs text-emerald-400">actions</div>
            </div>
            <div class="flex-shrink-0 w-36 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-3 md:p-4">
                <div class="flex items-center justify-between mb-1.5 md:mb-2">
                    <span class="text-text-muted text-[10px] md:text-xs font-medium uppercase">This Week</span>
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-400 text-[14px] md:text-[18px]">date_range</span>
                    </div>
                </div>
                <div class="text-xl md:text-2xl font-bold" id="statWeek">--</div>
                <div class="text-[10px] md:text-xs text-text-muted" id="statDailyAvg">~0/day</div>
            </div>
            <div class="flex-shrink-0 w-36 md:w-auto bg-surface-dark border border-border-dark rounded-xl p-3 md:p-4">
                <div class="flex items-center justify-between mb-1.5 md:mb-2">
                    <span class="text-text-muted text-[10px] md:text-xs font-medium uppercase">This Month</span>
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-violet-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-violet-400 text-[14px] md:text-[18px]">calendar_month</span>
                    </div>
                </div>
                <div class="text-xl md:text-2xl font-bold" id="statMonth">--</div>
                <div class="text-[10px] md:text-xs text-text-muted">actions</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 bg-surface-darker border-b border-border-dark">
        <div class="flex flex-col gap-3">
            <!-- Search -->
            <div class="flex items-center gap-2 rounded-lg border border-border-dark bg-surface-dark px-3 py-2.5">
                <span class="material-symbols-outlined text-text-muted text-[20px]">search</span>
                <input id="searchInput" class="w-full bg-transparent text-sm placeholder-text-muted focus:outline-none" placeholder="Search by admin email or target ID..." type="text" oninput="handleSearch()"/>
                <button id="clearSearchBtn" onclick="clearSearch()" class="hidden text-text-muted hover:text-white">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            </div>

            <!-- Filter row -->
            <div class="flex flex-wrap items-center gap-2">
                <!-- Category Filter -->
                <div class="relative">
                    <button onclick="toggleFilterDropdown('categoryFilter')" class="filter-chip touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[16px]">category</span>
                        <span id="categoryFilterLabel">Category</span>
                        <span class="material-symbols-outlined text-[16px]">expand_more</span>
                    </button>
                    <div id="categoryFilter" class="filter-dropdown bg-surface-dark border border-border-dark rounded-xl shadow-xl p-2">
                        <button onclick="setFilter('category', 'all')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">All Categories</button>
                        <button onclick="setFilter('category', 'driver')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-violet-400"></span>Driver Actions
                        </button>
                        <button onclick="setFilter('category', 'carrier')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-400"></span>Carrier Actions
                        </button>
                        <button onclick="setFilter('category', 'system')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-amber-400"></span>System Actions
                        </button>
                        <button onclick="setFilter('category', 'auth')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>Auth Actions
                        </button>
                    </div>
                </div>

                <!-- Target Type Filter -->
                <div class="relative">
                    <button onclick="toggleFilterDropdown('targetFilter')" class="filter-chip touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[16px]">filter_alt</span>
                        <span id="targetFilterLabel">Target</span>
                        <span class="material-symbols-outlined text-[16px]">expand_more</span>
                    </button>
                    <div id="targetFilter" class="filter-dropdown bg-surface-dark border border-border-dark rounded-xl shadow-xl p-2">
                        <button onclick="setFilter('targetType', 'all')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">All Targets</button>
                        <button onclick="setFilter('targetType', 'driver')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Drivers</button>
                        <button onclick="setFilter('targetType', 'carrier')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Carriers</button>
                        <button onclick="setFilter('targetType', 'system')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">System</button>
                    </div>
                </div>

                <!-- Date Range -->
                <div class="flex items-center gap-2">
                    <input type="date" id="dateFrom" onchange="applyDateFilter()" class="h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm focus:outline-none focus:ring-1 focus:ring-primary"/>
                    <span class="text-text-muted text-sm">to</span>
                    <input type="date" id="dateTo" onchange="applyDateFilter()" class="h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm focus:outline-none focus:ring-1 focus:ring-primary"/>
                </div>

                <!-- Clear Filters -->
                <button onclick="clearFilters()" class="h-9 px-3 text-sm text-text-muted hover:text-white transition-colors">
                    Clear filters
                </button>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="flex-1 overflow-hidden relative">
        <!-- Audit Log View -->
        <div id="view-log" class="tab-pane h-full flex flex-col">
            <!-- Mobile Timeline View -->
            <div id="mobileView" class="md:hidden h-full overflow-y-auto scrollbar-thin px-4 py-3">
                <div id="mobileAuditEntries" class="space-y-3">
                    <!-- Entries rendered here -->
                </div>
                <div id="mobilePagination" class="py-4 text-center">
                    <div class="text-xs text-text-muted mb-3">
                        <span id="mobileResultCount">0</span> entries
                    </div>
                    <button onclick="loadMore()" id="loadMoreBtn" class="hidden touch-active w-full py-3 bg-surface-dark border border-border-dark rounded-lg text-sm font-medium">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Desktop Table View -->
            <div id="desktopView" class="hidden md:block h-full px-6 py-4">
                <div class="h-full flex flex-col rounded-xl border border-border-dark bg-surface-darker overflow-hidden shadow-2xl">
                    <div class="flex-1 overflow-auto scrollbar-thin">
                        <table class="min-w-full">
                            <thead class="sticky top-0 z-10">
                                <tr class="bg-surface-dark border-b border-border-dark">
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                        <button onclick="sortBy('timestamp')" class="flex items-center gap-1 hover:text-primary transition-colors">
                                            Timestamp
                                            <span class="material-symbols-outlined text-[16px]" id="sortIconTime">expand_more</span>
                                        </button>
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Action</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Target</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Admin</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Details</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-muted">View</th>
                                </tr>
                            </thead>
                            <tbody id="auditTableBody" class="divide-y divide-border-dark">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                            <span class="text-text-muted text-sm">Loading audit log...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Footer -->
                    <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-3 border-t border-border-dark bg-surface-dark px-4 py-3">
                        <div class="text-xs text-text-muted">
                            Showing <span id="paginationFrom" class="font-medium text-white">0</span> to <span id="paginationTo" class="font-medium text-white">0</span> of <span id="paginationTotal" class="font-medium text-white">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="pageSizeSelect" onchange="changePageSize()" class="h-8 rounded-lg border border-border-dark bg-surface-dark px-2 text-xs focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                            <div class="flex gap-1">
                                <button onclick="goToPage('prev')" id="prevPageBtn" disabled class="touch-target flex h-8 items-center justify-center rounded-lg border border-border-dark bg-surface-dark px-3 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="material-symbols-outlined text-[18px]">chevron_left</span>
                                </button>
                                <button onclick="goToPage('next')" id="nextPageBtn" class="touch-target flex h-8 items-center justify-center rounded-lg border border-border-dark bg-surface-dark px-3 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compliance Reports View -->
        <div id="view-reports" class="tab-pane h-full hidden overflow-y-auto scrollbar-thin p-6">
            <div class="max-w-6xl mx-auto space-y-8">
                <!-- Quick Reports Section -->
                <section>
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">bolt</span>
                        Quick Reports
                    </h2>
                    <div id="quickReportsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Report cards render here -->
                        <div class="skeleton h-32 rounded-xl"></div>
                        <div class="skeleton h-32 rounded-xl"></div>
                        <div class="skeleton h-32 rounded-xl"></div>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left: Report Configuration -->
                    <div class="lg:col-span-1">
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-6 sticky top-6">
                            <h2 class="text-lg font-bold mb-6">Custom Report</h2>
                            <form id="reportConfigForm" class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-text-muted uppercase mb-2">Report Type</label>
                                    <select id="reportTypeSelect" class="w-full bg-surface-darker border border-border-dark rounded-lg p-2.5 text-sm">
                                        <!-- Options injected -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-text-muted uppercase mb-2">Date Range</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="date" id="reportDateFrom" class="bg-surface-darker border border-border-dark rounded-lg p-2 text-xs">
                                        <input type="date" id="reportDateTo" class="bg-surface-darker border border-border-dark rounded-lg p-2 text-xs">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-text-muted uppercase mb-2">Format</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="radio" name="reportFormat" value="csv" checked class="text-primary focus:ring-primary bg-surface-darker border-border-dark"> CSV
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="radio" name="reportFormat" value="json" class="text-primary focus:ring-primary bg-surface-darker border-border-dark"> JSON
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="radio" name="reportFormat" value="pdf" class="text-primary focus:ring-primary bg-surface-darker border-border-dark"> PDF
                                        </label>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 pt-2">
                                    <input type="checkbox" id="maskPII" checked class="rounded text-primary focus:ring-primary bg-surface-darker border-border-dark">
                                    <label for="maskPII" class="text-sm text-text-muted">Mask sensitive PII</label>
                                </div>
                                <button type="button" onclick="ReportsUI.generateCustom()" class="w-full py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold transition-all shadow-lg shadow-primary/20 mt-4">
                                    Generate Report
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Right: History & Scheduled -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Recent Reports -->
                        <section class="bg-surface-dark border border-border-dark rounded-xl overflow-hidden">
                            <div class="px-6 py-4 border-b border-border-dark bg-surface-darker/50 flex items-center justify-between">
                                <h2 class="font-bold">Recent Reports</h2>
                                <button onclick="ReportsUI.loadHistory()" class="text-text-muted hover:text-white transition-colors">
                                    <span class="material-symbols-outlined text-[18px]">refresh</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-surface-darker">
                                        <tr class="text-left text-xs text-text-muted uppercase">
                                            <th class="px-6 py-3">Report Name</th>
                                            <th class="px-6 py-3">Generated</th>
                                            <th class="px-6 py-3">Records</th>
                                            <th class="px-6 py-3 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentReportsTable" class="divide-y divide-border-dark">
                                        <!-- Reports render here -->
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <!-- Scheduled Reports -->
                        <section class="bg-surface-dark border border-border-dark rounded-xl overflow-hidden">
                            <div class="px-6 py-4 border-b border-border-dark bg-surface-darker/50 flex items-center justify-between">
                                <h2 class="font-bold">Scheduled Reports</h2>
                                <button onclick="ReportsUI.openScheduleModal()" class="flex items-center gap-1.5 text-sm text-primary hover:text-primary-dark font-bold transition-colors">
                                    <span class="material-symbols-outlined text-[18px]">add</span>
                                    New Schedule
                                </button>
                            </div>
                            <div id="scheduledReportsList" class="divide-y divide-border-dark">
                                <!-- Schedules render here -->
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Entry Detail Modal -->
<div id="entryDetailModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeEntryModal()"></div>
    <div class="absolute inset-0 md:inset-auto md:right-0 md:top-0 md:h-full md:w-full md:max-w-xl bg-surface-darker md:border-l border-border-dark shadow-2xl overflow-y-auto safe-bottom">
        <div id="entryDetailContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<script>
    // ============================================
    // STATE
    // ============================================
    let state = {
        entries: [],
        currentPage: 1,
        pageSize: 50,
        totalCount: 0,
        sortField: 'timestamp',
        sortDirection: 'desc',
        filters: {
            category: 'all',
            targetType: 'all',
            dateFrom: null,
            dateTo: null,
            search: ''
        },
        isLoading: false,
        isMobile: window.innerWidth < 768
    };

    const VALID_ACTIONS = [
        'auditLogLoaded', 'entryDetailLoaded', 'statsLoaded',
        'adminListLoaded', 'actionListLoaded', 'exportReady',
        'actionSuccess', 'actionError', 'init'
    ];

    function isValidMessage(data) {
        return data && typeof data === 'object' &&
               typeof data.action === 'string' &&
               VALID_ACTIONS.includes(data.action);
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('message', handleMessage);
    window.addEventListener('resize', handleResize);

    document.addEventListener('DOMContentLoaded', () => {
        handleResize();
        sendToVelo({ action: 'getAuditLog', filters: state.filters, page: 1, pageSize: state.pageSize });
        sendToVelo({ action: 'getStats' });
    });

    function handleResize() {
        const wasMobile = state.isMobile;
        state.isMobile = window.innerWidth < 768;
        if (wasMobile !== state.isMobile) {
            renderContent();
        }
    }

    function sendToVelo(message) {
        window.parent.postMessage(message, '*');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-chip') && !e.target.closest('.filter-dropdown')) {
            document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
            document.getElementById('mobileOverlay').classList.remove('open');
        }
    });

    // ============================================
    // MESSAGE HANDLING
    // ============================================
    function handleMessage(event) {
        const data = event.data;
        if (!isValidMessage(data)) return;

        switch (data.action) {
            case 'init':
                sendToVelo({ action: 'getAuditLog', filters: state.filters, page: 1, pageSize: state.pageSize });
                sendToVelo({ action: 'getStats' });
                ReportsUI.init();
                break;
            case 'auditLogLoaded':
                handleAuditLogLoaded(data.payload);
                break;
            case 'entryDetailLoaded':
                showEntryDetail(data.payload);
                break;
            case 'statsLoaded':
                updateStats(data.payload);
                break;
            case 'exportReady':
                downloadCSV(data.payload);
                break;
            case 'reportTemplatesLoaded':
                ReportsUI.renderTemplates(data.payload);
                break;
            case 'complianceReportGenerated':
                showToast('Report generation started', 'success');
                ReportsUI.loadHistory();
                break;
            case 'complianceReportsLoaded':
                ReportsUI.renderHistory(data.payload.items);
                break;
            case 'scheduledReportsLoaded':
                ReportsUI.renderSchedules(data.payload);
                break;
            case 'reportDownloadReady':
                ReportsUI.handleDownload(data.payload);
                break;
            case 'actionSuccess':
                showToast(data.message || 'Action completed', 'success');
                break;
            case 'actionError':
                showToast(data.message || 'An error occurred', 'error');
                break;
        }
    }

    // ============================================
    // TAB MANAGEMENT
    // ============================================
    function switchTab(tab) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.getElementById(`view-${tab}`).classList.remove('hidden');
        
        document.querySelectorAll('.tab-nav-btn').forEach(b => {
            if (b.dataset.tab === tab) {
                b.classList.add('active', 'bg-primary', 'border-primary');
                b.classList.remove('bg-surface-dark', 'border-border-dark');
            } else {
                b.classList.remove('active', 'bg-primary', 'border-primary');
                b.classList.add('bg-surface-dark', 'border-border-dark');
            }
        });

        if (tab === 'reports') {
            ReportsUI.loadData();
        }
    }

    // ============================================
    // COMPLIANCE REPORTS UI
    // ============================================
    const ReportsUI = {
        init() {
            sendToVelo({ action: 'getReportTemplates' });
        },

        loadData() {
            this.loadHistory();
            sendToVelo({ action: 'getScheduledReports' });
        },

        loadHistory() {
            sendToVelo({ action: 'listComplianceReports', options: { limit: 10 } });
        },

        renderTemplates(templates) {
            const grid = document.getElementById('quickReportsGrid');
            const select = document.getElementById('reportTypeSelect');

            grid.innerHTML = templates.map(t => `
                <div class="bg-surface-dark border border-border-dark rounded-xl p-5 hover:border-primary transition-all group">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-10 h-10 rounded-lg bg-surface-darker flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary">${this.getIcon(t.reportType)}</span>
                        </div>
                        <button onclick="ReportsUI.generate('${t.reportType}')" class="px-3 py-1.5 bg-primary/10 text-primary text-xs font-bold rounded-lg group-hover:bg-primary group-hover:text-white transition-all">
                            Generate
                        </button>
                    </div>
                    <h3 class="font-bold text-sm mb-1">${t.name}</h3>
                    <p class="text-xs text-text-muted line-clamp-2">${t.description}</p>
                </div>
            `).join('');

            select.innerHTML = templates.map(t => `<option value="${t.reportType}">${t.name}</option>`).join('');
        },

        renderHistory(reports) {
            const tbody = document.getElementById('recentReportsTable');
            if (!reports || reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-text-muted">No reports generated yet.</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(r => `
                <tr class="hover:bg-surface-dark/50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-medium">${r.name}</div>
                        <div class="text-[10px] text-text-muted uppercase">${r.format} • ${r.reportType}</div>
                    </td>
                    <td class="px-6 py-4 text-xs text-text-muted">
                        ${formatDateTime(r.requestedAt)}
                    </td>
                    <td class="px-6 py-4 text-xs">
                        ${r.status === 'completed' ? `<span class="text-white">${r.recordCount}</span>` : `<span class="text-text-muted italic">${r.status}</span>`}
                    </td>
                    <td class="px-6 py-4 text-right">
                        ${r.status === 'completed' ? `
                            <button onclick="ReportsUI.download('${r._id}')" class="text-primary hover:text-primary-dark transition-colors">
                                <span class="material-symbols-outlined">download</span>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        },

        renderSchedules(schedules) {
            const container = document.getElementById('scheduledReportsList');
            if (!schedules || schedules.length === 0) {
                container.innerHTML = '<div class="px-6 py-8 text-center text-text-muted text-sm italic">No scheduled reports.</div>';
                return;
            }

            container.innerHTML = schedules.map(s => `
                <div class="px-6 py-4 flex items-center justify-between hover:bg-surface-dark/50 transition-all">
                    <div>
                        <div class="font-bold text-sm">${s.name}</div>
                        <div class="text-xs text-text-muted capitalize">${s.frequency} • Next run: ${formatDateTime(s.nextRun)}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="px-2 py-1 rounded bg-surface-darker border border-border-dark text-[10px] uppercase font-bold text-text-muted">
                            ${s.format}
                        </div>
                        <button onclick="ReportsUI.deleteSchedule('${s._id}')" class="p-2 text-text-muted hover:text-rose-400 transition-colors">
                            <span class="material-symbols-outlined text-[18px]">delete</span>
                        </button>
                    </div>
                </div>
            `).join('');
        },

        getIcon(type) {
            const map = {
                admin_activity: 'badge',
                data_access: 'database',
                system_changes: 'settings_suggest',
                security_events: 'security',
                full_audit: 'history_edu',
                custom: 'edit_note'
            };
            return map[type] || 'description';
        },

        generate(type) {
            sendToVelo({ 
                action: 'generateComplianceReport', 
                options: { 
                    reportType: type,
                    format: 'csv'
                } 
            });
        },

        generateCustom() {
            const options = {
                reportType: document.getElementById('reportTypeSelect').value,
                dateRangeStart: document.getElementById('reportDateFrom').value,
                dateRangeEnd: document.getElementById('reportDateTo').value,
                format: document.querySelector('input[name="reportFormat"]:checked').value,
                maskPII: document.getElementById('maskPII').checked
            };
            sendToVelo({ action: 'generateComplianceReport', options });
        },

        download(id) {
            sendToVelo({ action: 'downloadReport', reportId: id });
        },

        handleDownload(payload) {
            if (payload.fileContent) {
                const blob = new Blob([payload.fileContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `compliance_report_${payload.reportId}.${payload.format}`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (payload.fileUrl) {
                window.open(payload.fileUrl, '_blank');
            }
        },

        deleteSchedule(id) {
            if (confirm('Are you sure you want to delete this schedule?')) {
                sendToVelo({ action: 'deleteScheduledReport', scheduleId: id });
            }
        }
    };

    // ============================================
    // DATA HANDLERS
    // ============================================
    let isLoadingMore = false;

    function handleAuditLogLoaded(payload) {
        if (isLoadingMore) {
            state.entries = [...state.entries, ...(payload.entries || [])];
            isLoadingMore = false;
        } else {
            state.entries = payload.entries || [];
        }
        state.totalCount = payload.totalCount || 0;
        state.currentPage = payload.currentPage || 1;
        state.pageSize = payload.pageSize || 50;
        state.isLoading = false;

        renderContent();
        updatePagination();
    }

    function updateStats(stats) {
        document.getElementById('statTotal').textContent = stats.total?.toLocaleString() || '0';
        document.getElementById('statToday').textContent = stats.today?.toLocaleString() || '0';
        document.getElementById('statWeek').textContent = stats.thisWeek?.toLocaleString() || '0';
        document.getElementById('statMonth').textContent = stats.thisMonth?.toLocaleString() || '0';
        document.getElementById('statDailyAvg').textContent = `~${stats.dailyAverage || 0}/day`;
    }

    function refreshData() {
        state.isLoading = true;
        sendToVelo({
            action: 'getAuditLog',
            filters: state.filters,
            page: state.currentPage,
            pageSize: state.pageSize,
            sortField: state.sortField,
            sortDirection: state.sortDirection
        });
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderContent() {
        if (state.isMobile) {
            renderMobileEntries();
        } else {
            renderDesktopTable();
        }
    }

    function renderMobileEntries() {
        const container = document.getElementById('mobileAuditEntries');
        document.getElementById('mobileResultCount').textContent = state.totalCount;

        if (state.entries.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-4xl text-text-muted mb-3 block">history</span>
                    <p class="text-text-muted">No audit entries found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = state.entries.map(entry => renderMobileEntry(entry)).join('');
    }

    function renderMobileEntry(entry) {
        const categoryClass = `category-${entry.category || 'other'}`;

        return `
            <div class="audit-entry" onclick="viewEntry('${entry._id}')">
                <div class="flex items-start gap-3">
                    <div class="timeline-dot ${getCategoryDotColor(entry.category)} mt-1"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-semibold">${entry.actionLabel || entry.action}</span>
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-medium ${categoryClass}">${entry.category || 'other'}</span>
                        </div>
                        <div class="text-xs text-text-muted mb-2">
                            ${entry.targetType}: ${entry.targetId ? entry.targetId.substring(0, 8) + '...' : 'N/A'}
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-text-muted">${entry.adminEmail || 'System'}</span>
                            <span class="text-text-muted">${entry.relativeTime || formatTime(entry.timestamp)}</span>
                        </div>
                    </div>
                    <span class="material-symbols-outlined text-text-muted text-[18px]">chevron_right</span>
                </div>
            </div>
        `;
    }

    function renderDesktopTable() {
        const tbody = document.getElementById('auditTableBody');

        if (state.entries.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-12 text-center">
                        <span class="material-symbols-outlined text-4xl text-text-muted mb-3 block">history</span>
                        <p class="text-text-muted">No audit entries found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = state.entries.map(entry => {
            const categoryClass = `category-${entry.category || 'other'}`;

            return `
                <tr class="hover:bg-surface-dark/50 transition-colors">
                    <td class="px-4 py-3">
                        <div class="text-sm">${formatDateTime(entry.timestamp)}</div>
                        <div class="text-xs text-text-muted">${entry.relativeTime || ''}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded text-xs font-medium ${categoryClass}">${entry.actionLabel || entry.action}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm capitalize">${entry.targetType || 'N/A'}</div>
                        <div class="text-xs text-text-muted font-mono">${entry.targetId ? entry.targetId.substring(0, 12) + '...' : 'N/A'}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${entry.adminEmail || 'System'}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs text-text-muted max-w-[200px] truncate">${formatDetails(entry.details)}</div>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="viewEntry('${entry._id}')" class="touch-target flex items-center justify-center w-8 h-8 rounded-lg hover:bg-surface-dark transition-colors ml-auto">
                            <span class="material-symbols-outlined text-[18px]">visibility</span>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============================================
    // HELPERS
    // ============================================
    function getCategoryDotColor(category) {
        const colors = {
            driver: 'bg-violet-400',
            carrier: 'bg-blue-400',
            system: 'bg-amber-400',
            auth: 'bg-emerald-400'
        };
        return colors[category] || 'bg-slate-400';
    }

    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

        return date.toLocaleDateString();
    }

    function formatDetails(details) {
        if (!details) return 'No details';
        if (typeof details === 'string') return details;

        const entries = Object.entries(details);
        if (entries.length === 0) return 'No details';

        return entries.slice(0, 2).map(([k, v]) => `${k}: ${v}`).join(', ');
    }

    // ============================================
    // FILTERS
    // ============================================
    let searchTimeout;
    function handleSearch() {
        const input = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearchBtn');

        clearBtn.classList.toggle('hidden', !input.value);

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            state.filters.search = input.value;
            state.currentPage = 1;
            refreshData();
        }, 300);
    }

    function clearSearch() {
        const input = document.getElementById('searchInput');
        input.value = '';
        document.getElementById('clearSearchBtn').classList.add('hidden');
        state.filters.search = '';
        state.currentPage = 1;
        refreshData();
    }

    function setFilter(filterName, value) {
        state.filters[filterName] = value;
        state.currentPage = 1;

        const labelMap = {
            category: { all: 'Category', driver: 'Driver', carrier: 'Carrier', system: 'System', auth: 'Auth' },
            targetType: { all: 'Target', driver: 'Drivers', carrier: 'Carriers', system: 'System' }
        };

        if (filterName === 'category') {
            document.getElementById('categoryFilterLabel').textContent = labelMap.category[value] || 'Category';
        } else if (filterName === 'targetType') {
            document.getElementById('targetFilterLabel').textContent = labelMap.targetType[value] || 'Target';
        }

        closeAllMenus();
        refreshData();
    }

    function applyDateFilter() {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        state.filters.dateFrom = dateFrom || null;
        state.filters.dateTo = dateTo || null;
        state.currentPage = 1;
        refreshData();
    }

    function clearFilters() {
        state.filters = {
            category: 'all',
            targetType: 'all',
            dateFrom: null,
            dateTo: null,
            search: ''
        };

        document.getElementById('searchInput').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('categoryFilterLabel').textContent = 'Category';
        document.getElementById('targetFilterLabel').textContent = 'Target';
        document.getElementById('clearSearchBtn').classList.add('hidden');

        state.currentPage = 1;
        refreshData();
    }

    function toggleFilterDropdown(id) {
        const dropdown = document.getElementById(id);
        const wasOpen = dropdown.classList.contains('open');

        closeAllMenus();

        if (!wasOpen) {
            dropdown.classList.add('open');
            if (state.isMobile) {
                document.getElementById('mobileOverlay').classList.add('open');
            }
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
        document.getElementById('mobileOverlay').classList.remove('open');
    }

    // ============================================
    // PAGINATION & SORTING
    // ============================================
    function updatePagination() {
        const from = state.totalCount === 0 ? 0 : (state.currentPage - 1) * state.pageSize + 1;
        const to = Math.min(state.currentPage * state.pageSize, state.totalCount);
        const totalPages = Math.ceil(state.totalCount / state.pageSize);

        document.getElementById('paginationFrom').textContent = from;
        document.getElementById('paginationTo').textContent = to;
        document.getElementById('paginationTotal').textContent = state.totalCount;

        document.getElementById('prevPageBtn').disabled = state.currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = state.currentPage >= totalPages;

        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (state.currentPage < totalPages) {
            loadMoreBtn.classList.remove('hidden');
        } else {
            loadMoreBtn.classList.add('hidden');
        }
    }

    function goToPage(direction) {
        if (direction === 'prev' && state.currentPage > 1) {
            state.currentPage--;
        } else if (direction === 'next') {
            state.currentPage++;
        }
        refreshData();
    }

    function changePageSize() {
        state.pageSize = parseInt(document.getElementById('pageSizeSelect').value);
        state.currentPage = 1;
        refreshData();
    }

    function loadMore() {
        isLoadingMore = true;
        state.currentPage++;
        sendToVelo({
            action: 'getAuditLog',
            filters: state.filters,
            page: state.currentPage,
            pageSize: state.pageSize,
            sortField: state.sortField,
            sortDirection: state.sortDirection
        });
    }

    function sortBy(field) {
        if (state.sortField === field) {
            state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortField = field;
            state.sortDirection = 'desc';
        }

        const icon = document.getElementById('sortIconTime');
        icon.textContent = state.sortDirection === 'asc' ? 'expand_less' : 'expand_more';

        state.currentPage = 1;
        refreshData();
    }

    // ============================================
    // ACTIONS
    // ============================================
    function viewEntry(entryId) {
        sendToVelo({ action: 'getEntryDetail', entryId });
    }

    function exportAuditLog() {
        sendToVelo({ action: 'exportAuditLog', filters: state.filters });
    }

    function downloadCSV(csvContent) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(url);
        showToast('Audit log exported', 'success');
    }

    // ============================================
    // ENTRY DETAIL MODAL
    // ============================================
    function showEntryDetail(entry) {
        const modal = document.getElementById('entryDetailModal');
        const content = document.getElementById('entryDetailContent');

        const categoryClass = `category-${entry.category || 'other'}`;

        content.innerHTML = `
            <div class="sticky top-0 z-10 bg-surface-darker border-b border-border-dark px-4 md:px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold">Audit Entry Detail</h2>
                <button onclick="closeEntryModal()" class="touch-target flex items-center justify-center w-10 h-10 rounded-lg hover:bg-surface-dark transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="px-4 md:px-6 py-4 space-y-4">
                <!-- Action Header -->
                <div class="bg-surface-dark rounded-xl p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 ${getCategoryDotColor(entry.category).replace('bg-', 'bg-').replace('-400', '-500/20')} rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined ${getCategoryDotColor(entry.category).replace('bg-', 'text-')}">${getCategoryIcon(entry.category)}</span>
                        </div>
                        <div>
                            <div class="font-semibold">${entry.actionLabel || entry.action}</div>
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${categoryClass}">${entry.category || 'other'}</span>
                        </div>
                    </div>
                    <div class="text-sm text-text-muted">
                        ${formatDateTime(entry.timestamp)} (${formatTime(entry.timestamp)})
                    </div>
                </div>

                <!-- Admin Info -->
                <div class="bg-surface-dark rounded-xl p-4">
                    <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">admin_panel_settings</span>
                        Admin
                    </h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Email</span>
                            <span class="font-medium">${entry.adminEmail || 'System'}</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Admin ID</span>
                            <span class="font-mono text-xs">${entry.adminId || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <!-- Target Info -->
                <div class="bg-surface-dark rounded-xl p-4">
                    <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">target</span>
                        Target
                    </h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Type</span>
                            <span class="font-medium capitalize">${entry.targetType || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">ID</span>
                            <span class="font-mono text-xs break-all">${entry.targetId || 'N/A'}</span>
                        </div>
                    </div>
                    ${entry.targetDetails && !entry.targetDetails.error ? `
                        <div class="mt-3 pt-3 border-t border-border-dark text-sm">
                            <span class="text-text-muted block text-xs mb-1">Target Name</span>
                            <span class="font-medium">${getTargetName(entry.targetDetails, entry.targetType)}</span>
                        </div>
                    ` : ''}
                </div>

                <!-- Details -->
                ${entry.details && Object.keys(entry.details).length > 0 ? `
                    <div class="bg-surface-dark rounded-xl p-4">
                        <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">info</span>
                            Details
                        </h4>
                        <div class="space-y-2 text-sm">
                            ${Object.entries(entry.details).map(([key, value]) => `
                                <div class="flex justify-between">
                                    <span class="text-text-muted capitalize">${key.replace(/_/g, ' ')}</span>
                                    <span class="font-medium">${formatDetailValue(value)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Related Entries -->
                ${entry.relatedEntries && entry.relatedEntries.length > 0 ? `
                    <div class="bg-surface-dark rounded-xl p-4">
                        <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">history</span>
                            Related Actions (${entry.relatedEntries.length})
                        </h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${entry.relatedEntries.map(related => `
                                <div class="flex items-center justify-between text-sm py-2 border-b border-border-dark last:border-0">
                                    <span>${related.action}</span>
                                    <span class="text-xs text-text-muted">${formatTime(related.timestamp)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

        modal.classList.remove('hidden');
    }

    function closeEntryModal() {
        document.getElementById('entryDetailModal').classList.add('hidden');
    }

    function getCategoryIcon(category) {
        const icons = {
            driver: 'person',
            carrier: 'local_shipping',
            system: 'settings',
            auth: 'lock'
        };
        return icons[category] || 'history';
    }

    function getTargetName(target, type) {
        if (type === 'driver') {
            return `${target.firstName || ''} ${target.lastName || ''}`.trim() || 'Unknown';
        } else if (type === 'carrier') {
            return target.legal_name || target.legalName || 'Unknown';
        }
        return 'N/A';
    }

    function formatDetailValue(value) {
        if (value === null || value === undefined) return 'N/A';
        if (typeof value === 'boolean') return value ? 'Yes' : 'No';
        if (typeof value === 'object') return JSON.stringify(value);
        return String(value);
    }

    // ============================================
    // TOAST
    // ============================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const id = 'toast-' + Date.now();

        const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-rose-600' : 'bg-primary';
        const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';

        const toast = document.createElement('div');
        toast.id = id;
        toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-lg ${bgColor} shadow-lg`;
        toast.innerHTML = `
            <span class="material-symbols-outlined text-[20px]">${icon}</span>
            <span class="text-sm font-medium flex-1">${message}</span>
            <button onclick="document.getElementById('${id}').remove()" class="text-white/80 hover:text-white">
                <span class="material-symbols-outlined text-[18px]">close</span>
            </button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    // ============================================
    // THEME MANAGEMENT
    // ============================================
    const THEME_KEY = 'lmdr-admin-theme';

    function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'dark');
        applyTheme(theme);
    }

    function applyTheme(theme) {
        if (theme === 'light') {
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.add('light');
        } else {
            document.documentElement.classList.remove('light');
            document.documentElement.classList.add('dark');
        }
        updateThemeIcons(theme);
    }

    function toggleTheme() {
        const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, newTheme);
        applyTheme(newTheme);
    }

    function updateThemeIcons(theme) {
        const icon = theme === 'dark' ? 'dark_mode' : 'light_mode';
        const mobileBtn = document.getElementById('themeToggleMobile');
        const desktopBtn = document.getElementById('themeToggleDesktop');
        if (mobileBtn) mobileBtn.querySelector('.material-symbols-outlined').textContent = icon;
        if (desktopBtn) desktopBtn.querySelector('.material-symbols-outlined').textContent = icon;
    }

    // Initialize theme on load
    initTheme();
</script>
</body>
</html>
