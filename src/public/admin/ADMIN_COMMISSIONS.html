<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Commission Tracking</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            dark: '#0f172a',
                            blue: '#2563eb',
                            yellow: '#fbbf24',
                            canvas: '#f8fafc',
                        }
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
        .tab-inactive:hover { color: #e2e8f0; }
        .badge-pending { background: #fbbf2420; color: #fbbf24; }
        .badge-approved { background: #22c55e20; color: #22c55e; }
        .badge-paid { background: #3b82f620; color: #3b82f6; }
    </style>
</head>

<body class="bg-slate-900 text-white font-sans">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Container -->
    <div class="h-screen flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex-none bg-slate-800 border-b border-slate-700 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-sm">VM</div>
                    <h1 class="text-xl font-bold">Commission Tracking</h1>
                </div>
                <div class="flex items-center gap-3">
                    <select id="periodSelector" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                    <button id="btnRecordCommission" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Record Commission
                    </button>
                </div>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="flex-none px-6 py-4 grid grid-cols-3 gap-4" id="summaryCards">
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-green-400">trending_up</span>
                    <span class="text-sm text-slate-400">Total Earned</span>
                </div>
                <div class="text-2xl font-bold text-green-400" id="totalEarned">$0.00</div>
                <div class="text-xs text-slate-500 mt-1"><span id="earnedCount">0</span> deals</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-yellow-400">hourglass_top</span>
                    <span class="text-sm text-slate-400">Pending Approval</span>
                </div>
                <div class="text-2xl font-bold text-yellow-400" id="totalPending">$0.00</div>
                <div class="text-xs text-slate-500 mt-1"><span id="pendingCount">0</span> commissions</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-blue-400">payments</span>
                    <span class="text-sm text-slate-400">Paid This Period</span>
                </div>
                <div class="text-2xl font-bold text-blue-400" id="totalPaid">$0.00</div>
                <div class="text-xs text-slate-500 mt-1"><span id="paidCount">0</span> payouts</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex-none px-6 border-b border-slate-700 flex gap-6">
            <button class="tab-btn tab-active pb-3 text-sm font-medium" data-tab="leaderboard">Leaderboard</button>
            <button class="tab-btn tab-inactive pb-3 text-sm font-medium" data-tab="commissions">Commissions</button>
            <button class="tab-btn tab-inactive pb-3 text-sm font-medium" data-tab="rules">Rules</button>
            <button class="tab-btn tab-inactive pb-3 text-sm font-medium" data-tab="reps">Sales Reps</button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-auto scrollbar-thin p-6">
            <!-- Leaderboard Tab -->
            <div id="tab-leaderboard" class="tab-content">
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-750">
                            <tr class="border-b border-slate-700">
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">#</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Rep Name</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Deals</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Revenue Generated</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Commission Earned</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Avg Deal Size</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <tr><td colspan="6" class="text-center py-8 text-slate-500">Loading leaderboard...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Commissions Tab -->
            <div id="tab-commissions" class="tab-content hidden">
                <!-- Filter Bar -->
                <div class="flex items-center gap-3 mb-4 flex-wrap">
                    <select id="filterStatus" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="paid">Paid</option>
                    </select>
                    <input type="date" id="filterDateFrom" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                    <input type="date" id="filterDateTo" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                    <select id="filterRep" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                        <option value="all">All Reps</option>
                    </select>
                    <div class="flex-1"></div>
                    <button id="btnBulkApprove" class="hidden bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Approve Selected
                    </button>
                    <button id="btnPayoutReport" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">receipt_long</span>
                        Generate Payout Report
                    </button>
                </div>
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="px-4 py-3 w-8"><input type="checkbox" id="checkAll" class="rounded bg-slate-700 border-slate-600" /></th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Date</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Rep</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Carrier</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Type</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Deal Value</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Rate</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Commission</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Status</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commissionsBody">
                            <tr><td colspan="10" class="text-center py-8 text-slate-500">Loading commissions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rules Tab -->
            <div id="tab-rules" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Commission Rules</h2>
                    <button id="btnAddRule" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Add Rule
                    </button>
                </div>
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Rule Name</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Event Type</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Base Rate</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Priority</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Status</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rulesBody">
                            <tr><td colspan="6" class="text-center py-8 text-slate-500">Loading rules...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sales Reps Tab -->
            <div id="tab-reps" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Sales Representatives</h2>
                    <button id="btnAddRep" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <span class="material-symbols-outlined text-lg">person_add</span>
                        Add Rep
                    </button>
                </div>
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Name</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Email</th>
                                <th class="text-left px-4 py-3 text-slate-400 font-medium">Role</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Status</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Total Deals</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Total Revenue</th>
                                <th class="text-right px-4 py-3 text-slate-400 font-medium">Total Earned</th>
                                <th class="text-center px-4 py-3 text-slate-400 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repsBody">
                            <tr><td colspan="8" class="text-center py-8 text-slate-500">Loading reps...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Commission Detail Modal -->
    <div id="commissionDetailModal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-lg mx-4 max-h-[80vh] overflow-auto scrollbar-thin">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Commission Detail</h3>
                    <button onclick="closeModal('commissionDetailModal')" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="commissionDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- Record Commission Modal -->
    <div id="recordCommissionModal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-lg mx-4 max-h-[80vh] overflow-auto scrollbar-thin">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Record Commission</h3>
                    <button onclick="closeModal('recordCommissionModal')" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <form id="recordCommissionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Sales Rep</label>
                        <select id="formRepId" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="">Select rep...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Carrier DOT</label>
                        <input type="text" id="formCarrierDot" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 1234567" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Event Type</label>
                        <select id="formEventType" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="new_subscription">New Subscription</option>
                            <option value="upgrade">Upgrade</option>
                            <option value="renewal">Renewal</option>
                            <option value="placement">Placement</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Deal Value ($)</label>
                            <input type="number" id="formDealValue" required step="0.01" min="0" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="0.00" />
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Commission Rate (%)</label>
                            <input type="number" id="formRate" step="0.01" min="0" max="100" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="10" />
                        </div>
                    </div>
                    <div class="bg-slate-750 rounded-lg p-3 border border-slate-600">
                        <div class="text-sm text-slate-400">Calculated Commission</div>
                        <div class="text-xl font-bold text-green-400" id="formCalculatedAmount">$0.00</div>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Notes</label>
                        <textarea id="formNotes" rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="Optional notes..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        Submit Commission
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Rule Modal -->
    <div id="ruleModal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-lg mx-4 max-h-[80vh] overflow-auto scrollbar-thin">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold" id="ruleModalTitle">Add Rule</h3>
                    <button onclick="closeModal('ruleModal')" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <form id="ruleForm" class="space-y-4">
                    <input type="hidden" id="ruleId" />
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Rule Name</label>
                        <input type="text" id="ruleName" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Event Type</label>
                            <select id="ruleEventType" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                                <option value="new_subscription">New Subscription</option>
                                <option value="upgrade">Upgrade</option>
                                <option value="renewal">Renewal</option>
                                <option value="placement">Placement</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Base Rate (%)</label>
                            <input type="number" id="ruleBaseRate" required step="0.01" min="0" max="100" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Priority (lower = higher priority)</label>
                        <input type="number" id="rulePriority" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" value="10" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Tier Bonuses (JSON)</label>
                        <textarea id="ruleTierBonuses" rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm font-mono" placeholder='[{"min_value": 10000, "rate": 0.12}]'></textarea>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-slate-400">Status</label>
                        <select id="ruleStatus" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        Save Rule
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Rep Modal -->
    <div id="repModal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-lg mx-4 max-h-[80vh] overflow-auto scrollbar-thin">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold" id="repModalTitle">Add Sales Rep</h3>
                    <button onclick="closeModal('repModal')" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <form id="repForm" class="space-y-4">
                    <input type="hidden" id="repId" />
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Name</label>
                            <input type="text" id="repName" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Email</label>
                            <input type="email" id="repEmail" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Phone</label>
                            <input type="tel" id="repPhone" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Role</label>
                            <input type="text" id="repRole" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="e.g., Account Executive" />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Payment Method</label>
                            <select id="repPaymentMethod" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                                <option value="direct_deposit">Direct Deposit</option>
                                <option value="check">Check</option>
                                <option value="paypal">PayPal</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Status</label>
                            <select id="repStatus" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm w-full">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Payment Details</label>
                        <input type="text" id="repPaymentDetails" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="Account number or PayPal email" />
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        Save Rep
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Payout Report Modal -->
    <div id="payoutModal" class="fixed inset-0 modal-backdrop z-40 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 w-full max-w-2xl mx-4 max-h-[80vh] overflow-auto scrollbar-thin">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Payout Report</h3>
                    <button onclick="closeModal('payoutModal')" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="payoutReportContent"></div>
                <div class="mt-4 flex items-center gap-3">
                    <input type="text" id="payoutReference" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="Payout reference (e.g., check #, transfer ID)" />
                    <button id="btnMarkAllPaid" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Mark All Paid
                    </button>
                    <button id="btnExportCSV" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentTab = 'leaderboard';
        let currentPeriod = 'month';
        let commissionsData = [];
        let rulesData = [];
        let repsData = [];
        let leaderboardData = [];
        let payoutReportData = null;
        let selectedCommissions = new Set();

        const defaultRates = {
            new_subscription: 10,
            upgrade: 5,
            renewal: 3,
            placement: 15
        };

        // ============================================
        // POSTMESSAGE BRIDGE
        // ============================================

        function sendToVelo(msg) {
            window.parent.postMessage(msg, '*');
        }

        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (!msg || !msg.action) return;

            switch (msg.action) {
                case 'init':
                    loadInitialData();
                    break;
                case 'summaryLoaded':
                    renderSummary(msg.payload);
                    break;
                case 'leaderboardLoaded':
                    renderLeaderboard(msg.payload);
                    break;
                case 'commissionsLoaded':
                    renderCommissions(msg.payload);
                    break;
                case 'rulesLoaded':
                    renderRules(msg.payload);
                    break;
                case 'repsLoaded':
                    renderReps(msg.payload);
                    break;
                case 'commissionDetailLoaded':
                    showCommissionDetail(msg.payload);
                    break;
                case 'payoutReportReady':
                    renderPayoutReport(msg.payload);
                    break;
                case 'actionSuccess':
                    showToast(msg.message, 'success');
                    refreshCurrentTab();
                    break;
                case 'actionError':
                    showToast(msg.message, 'error');
                    break;
            }
        });

        function loadInitialData() {
            sendToVelo({ action: 'getSummary', period: currentPeriod });
            sendToVelo({ action: 'getLeaderboard', period: currentPeriod });
            sendToVelo({ action: 'getCommissions', filters: {} });
            sendToVelo({ action: 'getRules' });
            sendToVelo({ action: 'getReps' });
        }

        function refreshCurrentTab() {
            sendToVelo({ action: 'getSummary', period: currentPeriod });
            switch (currentTab) {
                case 'leaderboard': sendToVelo({ action: 'getLeaderboard', period: currentPeriod }); break;
                case 'commissions': sendToVelo({ action: 'getCommissions', filters: getCommissionFilters() }); break;
                case 'rules': sendToVelo({ action: 'getRules' }); break;
                case 'reps': sendToVelo({ action: 'getReps' }); break;
            }
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        function formatCurrency(amount) {
            return '$' + (Number(amount) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatPercent(rate) {
            return (Number(rate) * 100).toFixed(1) + '%';
        }

        function statusBadge(status) {
            const cls = status === 'pending' ? 'badge-pending' : status === 'approved' ? 'badge-approved' : 'badge-paid';
            return `<span class="px-2 py-1 rounded-full text-xs font-medium ${cls}">${status}</span>`;
        }

        function rankIcon(rank) {
            if (rank === 1) return '<span class="text-yellow-400">&#x1F947;</span>';
            if (rank === 2) return '<span class="text-slate-300">&#x1F948;</span>';
            if (rank === 3) return '<span class="text-amber-600">&#x1F949;</span>';
            return rank;
        }

        function renderSummary(data) {
            if (!data) return;
            document.getElementById('totalEarned').textContent = formatCurrency(data.total_earned);
            document.getElementById('earnedCount').textContent = data.count_approved + data.count_paid;
            document.getElementById('totalPending').textContent = formatCurrency(data.total_pending);
            document.getElementById('pendingCount').textContent = data.count_pending;
            document.getElementById('totalPaid').textContent = formatCurrency(data.total_paid);
            document.getElementById('paidCount').textContent = data.count_paid;
        }

        function renderLeaderboard(data) {
            leaderboardData = data.leaderboard || data || [];
            const tbody = document.getElementById('leaderboardBody');
            if (!leaderboardData.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No data for this period</td></tr>';
                return;
            }
            tbody.innerHTML = leaderboardData.map(entry => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-750/50">
                    <td class="px-4 py-3 font-bold">${rankIcon(entry.rank)}</td>
                    <td class="px-4 py-3 font-medium">${entry.name || 'Unknown'}</td>
                    <td class="px-4 py-3 text-right">${entry.deals}</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(entry.revenue)}</td>
                    <td class="px-4 py-3 text-right font-semibold text-green-400">${formatCurrency(entry.commission)}</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(entry.avg_deal_size)}</td>
                </tr>
            `).join('');
        }

        function renderCommissions(data) {
            commissionsData = data.commissions || data || [];
            const tbody = document.getElementById('commissionsBody');
            selectedCommissions.clear();
            updateBulkApproveBtn();

            if (!commissionsData.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-slate-500">No commissions found</td></tr>';
                return;
            }

            tbody.innerHTML = commissionsData.map(c => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-750/50 cursor-pointer" data-id="${c._id}">
                    <td class="px-4 py-3"><input type="checkbox" class="comm-check rounded bg-slate-700 border-slate-600" data-id="${c._id}" ${c.status !== 'pending' ? 'disabled' : ''} /></td>
                    <td class="px-4 py-3">${formatDate(c.created_date)}</td>
                    <td class="px-4 py-3">${c.rep_name || c.sales_rep_id || '-'}</td>
                    <td class="px-4 py-3">${c.carrier_name || c.carrier_dot || '-'}</td>
                    <td class="px-4 py-3">${(c.event_type || '').replace(/_/g, ' ')}</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(c.deal_value)}</td>
                    <td class="px-4 py-3 text-right">${formatPercent(c.commission_rate)}</td>
                    <td class="px-4 py-3 text-right font-semibold">${formatCurrency(c.commission_amount)}</td>
                    <td class="px-4 py-3 text-center">${statusBadge(c.status)}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="text-slate-400 hover:text-white" onclick="event.stopPropagation(); viewCommission('${c._id}')">
                            <span class="material-symbols-outlined text-lg">visibility</span>
                        </button>
                    </td>
                </tr>
            `).join('');

            document.querySelectorAll('.comm-check').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    e.stopPropagation();
                    const id = e.target.dataset.id;
                    if (e.target.checked) selectedCommissions.add(id);
                    else selectedCommissions.delete(id);
                    updateBulkApproveBtn();
                });
            });
        }

        function renderRules(data) {
            rulesData = data.rules || data || [];
            const tbody = document.getElementById('rulesBody');
            if (!rulesData.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No rules configured</td></tr>';
                return;
            }
            tbody.innerHTML = rulesData.map(r => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-750/50">
                    <td class="px-4 py-3 font-medium">${r.rule_name || '-'}</td>
                    <td class="px-4 py-3">${(r.event_type || '').replace(/_/g, ' ')}</td>
                    <td class="px-4 py-3 text-right">${formatPercent(r.base_rate)}</td>
                    <td class="px-4 py-3 text-center">${r.priority || '-'}</td>
                    <td class="px-4 py-3 text-center">${statusBadge(r.status || 'active')}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="text-slate-400 hover:text-white" onclick="editRule('${r._id}')">
                            <span class="material-symbols-outlined text-lg">edit</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderReps(data) {
            repsData = data.reps || data || [];
            const tbody = document.getElementById('repsBody');
            // Also populate filter rep dropdown
            const filterRep = document.getElementById('filterRep');
            filterRep.innerHTML = '<option value="all">All Reps</option>' +
                repsData.map(r => `<option value="${r._id}">${r.name}</option>`).join('');
            // Also populate form rep selector
            const formRep = document.getElementById('formRepId');
            formRep.innerHTML = '<option value="">Select rep...</option>' +
                repsData.map(r => `<option value="${r._id}">${r.name}</option>`).join('');

            if (!repsData.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">No sales reps found</td></tr>';
                return;
            }
            tbody.innerHTML = repsData.map(r => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-750/50">
                    <td class="px-4 py-3 font-medium">${r.name || '-'}</td>
                    <td class="px-4 py-3">${r.email || '-'}</td>
                    <td class="px-4 py-3">${r.role || '-'}</td>
                    <td class="px-4 py-3 text-center">${statusBadge(r.status || 'active')}</td>
                    <td class="px-4 py-3 text-right">${r.total_deals || 0}</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(r.total_revenue)}</td>
                    <td class="px-4 py-3 text-right font-semibold text-green-400">${formatCurrency(r.total_commission)}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="text-slate-400 hover:text-white" onclick="editRep('${r._id}')">
                            <span class="material-symbols-outlined text-lg">edit</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showCommissionDetail(commission) {
            if (!commission) return;
            const holdDate = new Date(commission.hold_until);
            const now = new Date();
            const holdExpired = now >= holdDate;
            const daysRemaining = holdExpired ? 0 : Math.ceil((holdDate - now) / (1000 * 60 * 60 * 24));

            document.getElementById('commissionDetailContent').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><div class="text-xs text-slate-400">Sales Rep</div><div class="font-medium">${commission.rep_name || commission.sales_rep_id || '-'}</div></div>
                        <div><div class="text-xs text-slate-400">Carrier</div><div class="font-medium">${commission.carrier_name || commission.carrier_dot || '-'}</div></div>
                        <div><div class="text-xs text-slate-400">Event Type</div><div class="font-medium">${(commission.event_type || '').replace(/_/g, ' ')}</div></div>
                        <div><div class="text-xs text-slate-400">Deal Value</div><div class="font-medium">${formatCurrency(commission.deal_value)}</div></div>
                        <div><div class="text-xs text-slate-400">Rate</div><div class="font-medium">${formatPercent(commission.commission_rate)}</div></div>
                        <div><div class="text-xs text-slate-400">Commission</div><div class="font-bold text-green-400">${formatCurrency(commission.commission_amount)}</div></div>
                    </div>
                    <div class="border-t border-slate-700 pt-4">
                        <div class="text-xs text-slate-400 mb-2">Timeline</div>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                <span class="text-sm">Created: ${formatDate(commission.created_date)}</span>
                            </div>
                            ${commission.approved_date ? `
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                <span class="text-sm">Approved: ${formatDate(commission.approved_date)} by ${commission.approved_by || 'N/A'}</span>
                            </div>` : ''}
                            ${commission.paid_date ? `
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-blue-400"></div>
                                <span class="text-sm">Paid: ${formatDate(commission.paid_date)} (Ref: ${commission.payout_reference || 'N/A'})</span>
                            </div>` : ''}
                        </div>
                    </div>
                    ${commission.status === 'pending' ? `
                    <div class="border-t border-slate-700 pt-4">
                        <div class="flex items-center gap-2 ${holdExpired ? 'text-green-400' : 'text-yellow-400'}">
                            <span class="material-symbols-outlined">${holdExpired ? 'check_circle' : 'hourglass_top'}</span>
                            <span class="text-sm">${holdExpired ? 'Hold period complete - eligible for approval' : daysRemaining + ' days remaining in hold period'}</span>
                        </div>
                        ${holdExpired ? `
                        <div class="mt-3 flex gap-2">
                            <button onclick="approveFromDetail('${commission._id}')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Approve</button>
                        </div>` : ''}
                    </div>` : ''}
                    ${commission.notes ? `<div class="border-t border-slate-700 pt-4"><div class="text-xs text-slate-400 mb-1">Notes</div><div class="text-sm">${commission.notes}</div></div>` : ''}
                </div>
            `;
            document.getElementById('commissionDetailModal').classList.remove('hidden');
        }

        function renderPayoutReport(data) {
            payoutReportData = data;
            const container = document.getElementById('payoutReportContent');
            if (!data || !data.report || !data.report.length) {
                container.innerHTML = '<div class="text-center py-8 text-slate-500">No approved commissions pending payout</div>';
                document.getElementById('payoutModal').classList.remove('hidden');
                return;
            }

            const totalPayout = formatCurrency(data.total_payout);
            container.innerHTML = `
                <div class="mb-4 text-lg font-bold">Total Payout: <span class="text-green-400">${totalPayout}</span></div>
                ${data.report.map(rep => `
                    <div class="bg-slate-750 rounded-lg p-4 mb-3 border border-slate-600">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold">${rep.name} <span class="text-sm text-slate-400">(${rep.payment_method})</span></div>
                            <div class="text-green-400 font-bold">${formatCurrency(rep.total_owed)}</div>
                        </div>
                        <div class="text-xs text-slate-500">${rep.commission_count} commission(s) | ${rep.email}</div>
                    </div>
                `).join('')}
            `;
            document.getElementById('payoutModal').classList.remove('hidden');
        }

        // ============================================
        // ACTIONS
        // ============================================

        function getCommissionFilters() {
            const filters = {};
            const status = document.getElementById('filterStatus').value;
            if (status !== 'all') filters.status = status;
            const dateFrom = document.getElementById('filterDateFrom').value;
            if (dateFrom) filters.dateFrom = dateFrom;
            const dateTo = document.getElementById('filterDateTo').value;
            if (dateTo) filters.dateTo = dateTo;
            const rep = document.getElementById('filterRep').value;
            if (rep !== 'all') filters.repId = rep;
            return filters;
        }

        function viewCommission(id) {
            sendToVelo({ action: 'getCommissionDetail', commissionId: id });
        }

        function approveFromDetail(id) {
            sendToVelo({ action: 'approveCommission', commissionId: id });
            closeModal('commissionDetailModal');
        }

        function editRule(id) {
            const rule = rulesData.find(r => r._id === id);
            if (!rule) return;
            document.getElementById('ruleId').value = rule._id || '';
            document.getElementById('ruleName').value = rule.rule_name || '';
            document.getElementById('ruleEventType').value = rule.event_type || 'new_subscription';
            document.getElementById('ruleBaseRate').value = (Number(rule.base_rate) * 100) || '';
            document.getElementById('rulePriority').value = rule.priority || 10;
            document.getElementById('ruleTierBonuses').value = rule.tier_bonuses ? (typeof rule.tier_bonuses === 'string' ? rule.tier_bonuses : JSON.stringify(rule.tier_bonuses, null, 2)) : '';
            document.getElementById('ruleStatus').value = rule.status || 'active';
            document.getElementById('ruleModalTitle').textContent = 'Edit Rule';
            document.getElementById('ruleModal').classList.remove('hidden');
        }

        function editRep(id) {
            const rep = repsData.find(r => r._id === id);
            if (!rep) return;
            document.getElementById('repId').value = rep._id || '';
            document.getElementById('repName').value = rep.name || '';
            document.getElementById('repEmail').value = rep.email || '';
            document.getElementById('repPhone').value = rep.phone || '';
            document.getElementById('repRole').value = rep.role || '';
            document.getElementById('repPaymentMethod').value = rep.payment_method || 'direct_deposit';
            document.getElementById('repPaymentDetails').value = rep.payment_details || '';
            document.getElementById('repStatus').value = rep.status || 'active';
            document.getElementById('repModalTitle').textContent = 'Edit Sales Rep';
            document.getElementById('repModal').classList.remove('hidden');
        }

        function updateBulkApproveBtn() {
            const btn = document.getElementById('btnBulkApprove');
            if (selectedCommissions.size > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `Approve Selected (${selectedCommissions.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `toast ${bg} text-white px-4 py-3 rounded-lg text-sm shadow-lg flex items-center gap-2`;
            toast.innerHTML = `
                <span class="material-symbols-outlined text-lg">${type === 'success' ? 'check_circle' : 'error'}</span>
                ${message}
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function updateCalculatedCommission() {
            const dealValue = Number(document.getElementById('formDealValue').value) || 0;
            const rateInput = document.getElementById('formRate').value;
            const eventType = document.getElementById('formEventType').value;
            const rate = rateInput ? Number(rateInput) / 100 : (defaultRates[eventType] || 10) / 100;
            const amount = dealValue * rate;
            document.getElementById('formCalculatedAmount').textContent = formatCurrency(amount);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => { b.className = b.className.replace('tab-active', 'tab-inactive'); });
                btn.className = btn.className.replace('tab-inactive', 'tab-active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                currentTab = btn.dataset.tab;
                document.getElementById('tab-' + currentTab).classList.remove('hidden');
            });
        });

        // Period selector
        document.getElementById('periodSelector').addEventListener('change', (e) => {
            currentPeriod = e.target.value;
            sendToVelo({ action: 'getSummary', period: currentPeriod });
            sendToVelo({ action: 'getLeaderboard', period: currentPeriod });
        });

        // Filter changes
        ['filterStatus', 'filterDateFrom', 'filterDateTo', 'filterRep'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                sendToVelo({ action: 'getCommissions', filters: getCommissionFilters() });
            });
        });

        // Check all
        document.getElementById('checkAll').addEventListener('change', (e) => {
            const checks = document.querySelectorAll('.comm-check:not(:disabled)');
            checks.forEach(cb => {
                cb.checked = e.target.checked;
                const id = cb.dataset.id;
                if (e.target.checked) selectedCommissions.add(id);
                else selectedCommissions.delete(id);
            });
            updateBulkApproveBtn();
        });

        // Bulk approve
        document.getElementById('btnBulkApprove').addEventListener('click', () => {
            if (selectedCommissions.size === 0) return;
            sendToVelo({ action: 'bulkApprove', commissionIds: Array.from(selectedCommissions) });
        });

        // Record commission modal
        document.getElementById('btnRecordCommission').addEventListener('click', () => {
            document.getElementById('recordCommissionForm').reset();
            document.getElementById('formCalculatedAmount').textContent = '$0.00';
            document.getElementById('recordCommissionModal').classList.remove('hidden');
        });

        document.getElementById('formDealValue').addEventListener('input', updateCalculatedCommission);
        document.getElementById('formRate').addEventListener('input', updateCalculatedCommission);
        document.getElementById('formEventType').addEventListener('change', () => {
            const eventType = document.getElementById('formEventType').value;
            if (!document.getElementById('formRate').value) {
                document.getElementById('formRate').placeholder = defaultRates[eventType] || 10;
            }
            updateCalculatedCommission();
        });

        document.getElementById('recordCommissionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const eventType = document.getElementById('formEventType').value;
            const rateInput = document.getElementById('formRate').value;
            const rate = rateInput ? Number(rateInput) / 100 : (defaultRates[eventType] || 10) / 100;
            sendToVelo({
                action: 'recordCommission',
                commissionData: {
                    sales_rep_id: document.getElementById('formRepId').value,
                    carrier_dot: document.getElementById('formCarrierDot').value,
                    event_type: eventType,
                    deal_value: Number(document.getElementById('formDealValue').value),
                    commission_rate: rate,
                    notes: document.getElementById('formNotes').value
                }
            });
            closeModal('recordCommissionModal');
        });

        // Rule modal
        document.getElementById('btnAddRule').addEventListener('click', () => {
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleId').value = '';
            document.getElementById('ruleModalTitle').textContent = 'Add Rule';
            document.getElementById('ruleModal').classList.remove('hidden');
        });

        document.getElementById('ruleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const rule = {
                rule_name: document.getElementById('ruleName').value,
                event_type: document.getElementById('ruleEventType').value,
                base_rate: Number(document.getElementById('ruleBaseRate').value) / 100,
                priority: Number(document.getElementById('rulePriority').value) || 10,
                tier_bonuses: document.getElementById('ruleTierBonuses').value || '',
                status: document.getElementById('ruleStatus').value
            };
            const id = document.getElementById('ruleId').value;
            if (id) rule._id = id;
            sendToVelo({ action: 'saveRule', rule });
            closeModal('ruleModal');
        });

        // Rep modal
        document.getElementById('btnAddRep').addEventListener('click', () => {
            document.getElementById('repForm').reset();
            document.getElementById('repId').value = '';
            document.getElementById('repModalTitle').textContent = 'Add Sales Rep';
            document.getElementById('repModal').classList.remove('hidden');
        });

        document.getElementById('repForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const rep = {
                name: document.getElementById('repName').value,
                email: document.getElementById('repEmail').value,
                phone: document.getElementById('repPhone').value,
                role: document.getElementById('repRole').value,
                payment_method: document.getElementById('repPaymentMethod').value,
                payment_details: document.getElementById('repPaymentDetails').value,
                status: document.getElementById('repStatus').value
            };
            const id = document.getElementById('repId').value;
            if (id) rep._id = id;
            sendToVelo({ action: 'saveRep', rep });
            closeModal('repModal');
        });

        // Payout report
        document.getElementById('btnPayoutReport').addEventListener('click', () => {
            sendToVelo({ action: 'generatePayout', period: currentPeriod });
        });

        document.getElementById('btnMarkAllPaid').addEventListener('click', () => {
            if (!payoutReportData || !payoutReportData.report) return;
            const allIds = [];
            payoutReportData.report.forEach(rep => {
                (rep.commissions || []).forEach(c => allIds.push(c._id));
            });
            if (!allIds.length) return;
            const ref = document.getElementById('payoutReference').value;
            sendToVelo({ action: 'markPaid', commissionIds: allIds, payoutReference: ref });
            closeModal('payoutModal');
        });

        document.getElementById('btnExportCSV').addEventListener('click', () => {
            if (!payoutReportData || !payoutReportData.report) return;
            sendToVelo({ action: 'exportCSV', report: payoutReportData });
        });
    </script>
</body>
</html>
