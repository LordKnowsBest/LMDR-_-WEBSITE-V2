<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Platform Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #e2e8f0;
        }

        .touch-target { min-height: 44px; min-width: 44px; }

        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
        }

        /* Tabs */
        .tab-btn {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
            background: rgba(129, 140, 248, 0.1);
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 1.5rem;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            appearance: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #818cf8;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(129, 140, 248, 0.5);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #059669; color: white; }
        .toast.error { background: #dc2626; color: white; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500 mb-4"></i>
            <p class="text-slate-300">Saving settings...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-card mx-4 mt-4 mb-6">
        <div class="p-4 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-sliders-h text-indigo-400"></i>
                    Platform Configuration
                </h1>
                <p class="text-sm text-slate-400 mt-1">Manage matching weights and system parameters</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="resetAllBtn" class="touch-target px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors">
                    Reset Defaults
                </button>
                <button id="saveAllBtn" class="touch-target px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-save mr-2"></i>Save All
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-t border-slate-700 overflow-x-auto">
            <button class="tab-btn active flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="carrier-weights">
                <i class="fas fa-truck mr-2"></i>Carrier Weights
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="driver-weights">
                <i class="fas fa-user-tie mr-2"></i>Driver Weights
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="system">
                <i class="fas fa-microchip mr-2"></i>System
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="tiers">
                <i class="fas fa-layer-group mr-2"></i>Tiers
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="jobs">
                <i class="fas fa-tasks mr-2"></i>Jobs
            </button>
            <button class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-400 touch-target whitespace-nowrap" data-tab="ui">
                <i class="fas fa-paint-brush mr-2"></i>UI
            </button>
        </div>
    </header>

    <main class="px-4 pb-8">
        <!-- Carrier Weights Tab -->
        <div id="carrier-weightsTab" class="tab-content">
            <div class="glass-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-white">Carrier Matching Weights</h2>
                    <div id="carrierWeightsTotal" class="px-3 py-1 rounded bg-indigo-500/20 text-indigo-400 text-sm font-bold">Total: 100%</div>
                </div>
                
                <div id="carrierWeightsList" class="space-y-6">
                    <!-- Dynamic weights will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Driver Weights Tab -->
        <div id="driver-weightsTab" class="tab-content hidden">
            <div class="glass-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-white">Driver Matching Weights</h2>
                    <div id="driverWeightsTotal" class="px-3 py-1 rounded bg-indigo-500/20 text-indigo-400 text-sm font-bold">Total: 100%</div>
                </div>
                
                <div id="driverWeightsList" class="space-y-6">
                    <!-- Dynamic weights will be inserted here -->
                </div>
            </div>
        </div>

        <!-- System Settings Tab -->
        <div id="systemTab" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Cache Settings -->
                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-bolt text-amber-400"></i> Performance & Cache
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Enrichment Cache TTL (Days)</label>
                            <input type="number" id="fmcsa_refresh_days" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white" min="1" max="90">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">UI Cache TTL (Minutes)</label>
                            <input type="number" id="cache_ttl_minutes" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white" min="0" max="1440">
                        </div>
                    </div>
                </div>

                <!-- Batch & Rate Limits -->
                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-layer-group text-blue-400"></i> Batch & Rate Limits
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Enrichment Batch Size</label>
                            <input type="number" id="enrichment_batch_size" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white" min="1" max="10">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Email Batch Size</label>
                            <input type="number" id="email_batch_size" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white" min="1" max="20">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">API Rate Limit (Req/Sec)</label>
                            <input type="number" id="api_rate_limit_per_second" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white" min="1" max="20">
                        </div>
                    </div>
                </div>

                <!-- Maintenance Mode -->
                <div class="glass-card p-6 md:col-span-2">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-white">Maintenance Mode</h2>
                            <p class="text-sm text-slate-400">When enabled, the site will be read-only for most users.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="maintenanceStatus" class="text-xs font-bold px-2 py-1 rounded bg-slate-700 text-slate-400 uppercase">Inactive</span>
                            <button id="maintenanceToggle" class="touch-target px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors">
                                Enable
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tiers Tab -->
        <div id="tiersTab" class="tab-content hidden">
            <div id="tierLimitsGrid" class="grid md:grid-cols-3 gap-6">
                <!-- Dynamic tier cards will be inserted here -->
            </div>
        </div>

        <!-- Jobs Tab -->
        <div id="jobsTab" class="tab-content hidden">
            <div class="glass-card overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-800/50 border-b border-slate-700">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Job Name</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Last Run</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="jobsList" class="divide-y divide-slate-700">
                        <!-- Dynamic job rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- UI Tab -->
        <div id="uiTab" class="tab-content hidden">
            <div class="glass-card p-6">
                <h2 class="text-lg font-semibold text-white mb-6">Announcement Banner</h2>
                <div class="space-y-4 max-w-2xl">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm text-slate-400 font-medium">Show Banner</label>
                        <input type="checkbox" id="banner_enabled" class="w-5 h-5 accent-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Banner Text</label>
                        <input type="text" id="banner_text" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Link URL (Optional)</label>
                        <input type="text" id="banner_link" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Banner Style</label>
                        <select id="banner_type" class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                            <option value="info">Info (Blue)</option>
                            <option value="warning">Warning (Amber)</option>
                            <option value="success">Success (Green)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        // State
        let currentTab = 'carrier-weights';
        let carrierWeights = {};
        let driverWeights = {};
        let systemSettings = {};
        let tierLimits = {};
        let uiSettings = {};
        let jobs = [];

        const CARRIER_WEIGHT_LABELS = {
            location: 'Home Location Match',
            pay: 'Pay / CPM Target',
            operationType: 'Operation Type (OTR/Reg/Local)',
            turnover: 'Carrier Turnover Rate',
            safety: 'Safety Rating & Accident Rate',
            truckAge: 'Average Fleet Truck Age',
            fleetSize: 'Carrier Fleet Size',
            qualityScore: 'AI Match Quality Score'
        };

        const DRIVER_WEIGHT_LABELS = {
            qualifications: 'CDL & Endorsements',
            experience: 'Years of Experience',
            location: 'Distance from Carrier',
            availability: 'Availability Timeline',
            salaryFit: 'Salary Expectations',
            engagement: 'Platform Activity'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        // Listen for messages from Velo
        window.onmessage = (event) => {
            const { action, payload, message } = event.data;

            switch (action) {
                case 'init':
                    loadInitialData();
                    break;
                case 'carrierWeightsLoaded':
                    carrierWeights = payload;
                    renderWeightSliders('carrier', carrierWeights, CARRIER_WEIGHT_LABELS);
                    break;
                case 'driverWeightsLoaded':
                    driverWeights = payload;
                    renderWeightSliders('driver', driverWeights, DRIVER_WEIGHT_LABELS);
                    break;
                case 'systemSettingsLoaded':
                    systemSettings = payload;
                    populateSystemSettings(payload);
                    break;
                case 'tierLimitsLoaded':
                    tierLimits = payload;
                    renderTierLimits(payload);
                    break;
                case 'uiSettingsLoaded':
                    uiSettings = payload;
                    populateUISettings(payload);
                    break;
                case 'jobsLoaded':
                    jobs = payload;
                    renderJobs(payload);
                    break;
                case 'jobTriggered':
                    showToast('Job triggered successfully', 'success');
                    sendToVelo({ action: 'getJobs' }); // Refresh
                    break;
                case 'settingsSaved':
                    setLoading(false);
                    showToast('Settings saved successfully', 'success');
                    break;
                case 'actionError':
                    setLoading(false);
                    showToast(message || 'An error occurred', 'error');
                    break;
            }
        };

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Save all
            document.getElementById('saveAllBtn').addEventListener('click', saveAll);

            // Reset defaults
            document.getElementById('resetAllBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all settings to defaults?')) {
                    sendToVelo({ action: 'resetSettings' });
                }
            });

            // Maintenance toggle
            document.getElementById('maintenanceToggle').addEventListener('click', () => {
                const active = !systemSettings.maintenance_mode;
                sendToVelo({ action: 'toggleMaintenance', enabled: active });
            });
        }

        function loadInitialData() {
            sendToVelo({ action: 'getCarrierWeights' });
            sendToVelo({ action: 'getDriverWeights' });
            sendToVelo({ action: 'getSystemSettings' });
            sendToVelo({ action: 'getTierLimits' });
            sendToVelo({ action: 'getUISettings' });
            sendToVelo({ action: 'getJobs' });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
        }

        function renderWeightSliders(prefix, weights, labels) {
            const container = document.getElementById(`${prefix}WeightsList`);
            container.innerHTML = '';

            Object.entries(weights).forEach(([key, value]) => {
                const div = document.createElement('div');
                div.className = 'slider-container';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm text-slate-300 font-medium">${labels[key] || key}</label>
                        <span class="text-sm font-bold text-indigo-400" id="${prefix}_val_${key}">${value}%</span>
                    </div>
                    <input type="range" min="0" max="100" value="${value}" 
                        oninput="updateWeightDisplay('${prefix}', '${key}', this.value)"
                        data-key="${key}" class="${prefix}-weight-slider">
                `;
                container.appendChild(div);
            });

            updateTotal(prefix);
        }

        function updateWeightDisplay(prefix, key, value) {
            document.getElementById(`${prefix}_val_${key}`).textContent = `${value}%`;
            updateTotal(prefix);
        }

        function updateTotal(prefix) {
            const sliders = document.querySelectorAll(`.${prefix}-weight-slider`);
            let total = 0;
            sliders.forEach(s => total += parseInt(s.value));
            
            const totalDisplay = document.getElementById(`${prefix}WeightsTotal`);
            totalDisplay.textContent = `Total: ${total}%`;
            
            if (total !== 100) {
                totalDisplay.classList.remove('bg-indigo-500/20', 'text-indigo-400');
                totalDisplay.classList.add('bg-amber-500/20', 'text-amber-400');
            } else {
                totalDisplay.classList.remove('bg-amber-500/20', 'text-amber-400');
                totalDisplay.classList.add('bg-indigo-500/20', 'text-indigo-400');
            }
        }

        function populateSystemSettings(settings) {
            Object.entries(settings).forEach(([key, value]) => {
                const input = document.getElementById(key);
                if (input) input.value = value;
            });

            const status = document.getElementById('maintenanceStatus');
            const btn = document.getElementById('maintenanceToggle');
            if (settings.maintenance_mode) {
                status.textContent = 'Active';
                status.className = 'text-xs font-bold px-2 py-1 rounded bg-red-500/20 text-red-400 uppercase';
                btn.textContent = 'Disable';
                btn.className = 'touch-target px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors';
            } else {
                status.textContent = 'Inactive';
                status.className = 'text-xs font-bold px-2 py-1 rounded bg-slate-700 text-slate-400 uppercase';
                btn.textContent = 'Enable';
                btn.className = 'touch-target px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors';
            }
        }

        function renderTierLimits(limits) {
            const container = document.getElementById('tierLimitsGrid');
            container.innerHTML = Object.entries(limits).map(([tier, values]) => `
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white uppercase tracking-wider mb-4 border-b border-slate-700 pb-2">${tier}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Match Results</label>
                            <input type="number" data-tier="${tier}" data-field="match_results" value="${values.match_results}" class="tier-input w-full bg-slate-800 border border-slate-700 rounded p-2 text-white">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Profile Views</label>
                            <input type="number" data-tier="${tier}" data-field="profile_views" value="${values.profile_views}" class="tier-input w-full bg-slate-800 border border-slate-700 rounded p-2 text-white">
                            <p class="text-[10px] text-slate-500 mt-1">(-1 for unlimited)</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderJobs(jobsList) {
            const container = document.getElementById('jobsList');
            container.innerHTML = jobsList.map(job => `
                <tr class="hover:bg-slate-800/30 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-medium text-white">${job.name}</div>
                        <div class="text-xs text-slate-500">${job.service}.${job.function}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-400">
                        ${job.lastRunAt ? new Date(job.lastRunAt).toLocaleString() : 'Never'}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold uppercase ${job.lastStatus === 'success' ? 'bg-green-500/10 text-green-400' : (job.lastStatus === 'failed' ? 'bg-red-500/10 text-red-400' : 'bg-slate-700 text-slate-400')}">
                            ${job.lastStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="triggerJob('${job.id}')" class="text-indigo-400 hover:text-indigo-300 font-bold text-sm">
                            Run Now
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateUISettings(settings) {
            const banner = settings.announcement_banner || {};
            document.getElementById('banner_enabled').checked = banner.enabled;
            document.getElementById('banner_text').value = banner.text || '';
            document.getElementById('banner_link').value = banner.link || '';
            document.getElementById('banner_type').value = banner.type || 'info';
        }

        function triggerJob(id) {
            if (confirm(`Trigger manual run for ${id}?`)) {
                sendToVelo({ action: 'triggerJob', jobId: id });
            }
        }

        function saveAll() {
            setLoading(true);

            // Weights
            const newCarrierWeights = {};
            document.querySelectorAll('.carrier-weight-slider').forEach(s => {
                newCarrierWeights[s.dataset.key] = parseInt(s.value);
            });

            const newDriverWeights = {};
            document.querySelectorAll('.driver-weight-slider').forEach(s => {
                newDriverWeights[s.dataset.key] = parseInt(s.value);
            });

            // System
            const newSystemSettings = {
                cache_ttl_minutes: parseInt(document.getElementById('cache_ttl_minutes').value),
                enrichment_batch_size: parseInt(document.getElementById('enrichment_batch_size').value),
                email_batch_size: parseInt(document.getElementById('email_batch_size').value),
                fmcsa_refresh_days: parseInt(document.getElementById('fmcsa_refresh_days').value),
                api_rate_limit_per_second: parseInt(document.getElementById('api_rate_limit_per_second').value),
                maintenance_mode: systemSettings.maintenance_mode // preserved unless toggled
            };

            // Tiers
            const newTierLimits = {};
            document.querySelectorAll('.tier-input').forEach(input => {
                const tier = input.dataset.tier;
                if (!newTierLimits[tier]) newTierLimits[tier] = {};
                newTierLimits[tier][input.dataset.field] = parseInt(input.value);
            });

            // UI
            const newUISettings = {
                announcement_banner: {
                    enabled: document.getElementById('banner_enabled').checked,
                    text: document.getElementById('banner_text').value,
                    link: document.getElementById('banner_link').value,
                    type: document.getElementById('banner_type').value
                }
            };

            sendToVelo({
                action: 'saveAllSettings',
                payload: {
                    carrierWeights: newCarrierWeights,
                    driverWeights: newDriverWeights,
                    systemSettings: newSystemSettings,
                    tierLimits: newTierLimits,
                    uiSettings: newUISettings
                }
            });
        }

        function setLoading(active) {
            document.getElementById('loadingOverlay').classList.toggle('active', active);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function sendToVelo(message) {
            window.parent.postMessage(message, '*');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
