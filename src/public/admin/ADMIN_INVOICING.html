<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Invoicing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24', canvas: '#f8fafc' }
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .touch-target { min-height: 44px; min-width: 44px; }
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }
        @supports (padding: max(0px)) {
            .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
            .safe-top { padding-top: max(16px, env(safe-area-inset-top)); }
        }
        .status-draft { background: #334155; color: #94a3b8; }
        .status-sent { background: #1e3a5f; color: #60a5fa; }
        .status-paid { background: #14532d; color: #4ade80; }
        .status-overdue { background: #7f1d1d; color: #f87171; }
        .status-void { background: #1e293b; color: #64748b; }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .slide-panel { transition: transform 0.3s ease-out; }
        .slide-panel.hidden { transform: translateX(100%); }
    </style>
</head>

<body class="bg-lmdr-dark text-white font-sans h-full">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Layout -->
    <div id="mainContent" class="h-full flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex items-center justify-between px-4 py-3 border-b border-slate-700/50 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-lmdr-blue flex items-center justify-center text-xs font-bold">VM</div>
                <h1 class="text-lg font-bold">Invoicing</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="headerStats" class="hidden sm:flex items-center gap-4 text-xs text-slate-400">
                    <span>Outstanding: <strong id="statOutstanding" class="text-amber-400">$0.00</strong></span>
                    <span>Overdue: <strong id="statOverdueCount" class="text-red-400">0</strong></span>
                </div>
                <button id="btnNewInvoice" onclick="showCreateForm()" class="touch-target touch-active flex items-center gap-1 px-3 py-2 bg-lmdr-blue text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    New Invoice
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex items-center gap-1 px-4 py-2 border-b border-slate-700/30 shrink-0 overflow-x-auto scrollbar-thin">
            <button onclick="filterByStatus('')" class="tab-btn active touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="">All <span id="countAll" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="filterByStatus('draft')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="draft">Draft <span id="countDraft" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="filterByStatus('sent')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="sent">Sent <span id="countSent" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="filterByStatus('paid')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="paid">Paid <span id="countPaid" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="filterByStatus('overdue')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="overdue">Overdue <span id="countOverdue" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="filterByStatus('void')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="void">Void <span id="countVoid" class="ml-1 text-xs opacity-60"></span></button>
        </nav>

        <!-- Invoice List -->
        <div id="invoiceListView" class="flex-1 overflow-y-auto scrollbar-thin p-4">
            <div id="invoiceListLoading" class="space-y-3">
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
            </div>
            <table id="invoiceTable" class="hidden w-full text-sm">
                <thead>
                    <tr class="text-left text-slate-400 text-xs uppercase border-b border-slate-700/50">
                        <th class="pb-2 px-3">Invoice #</th>
                        <th class="pb-2 px-3">Carrier</th>
                        <th class="pb-2 px-3 text-right">Amount</th>
                        <th class="pb-2 px-3">Status</th>
                        <th class="pb-2 px-3">Due Date</th>
                        <th class="pb-2 px-3">Sent Date</th>
                        <th class="pb-2 px-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody"></tbody>
            </table>
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-slate-400">
                <span class="material-symbols-outlined text-5xl mb-3">receipt_long</span>
                <p class="text-lg font-medium">No invoices found</p>
                <p class="text-sm mt-1">Create your first invoice to get started</p>
            </div>
            <!-- Pagination -->
            <div id="pagination" class="hidden flex items-center justify-between mt-4 pt-4 border-t border-slate-700/30">
                <span id="pageInfo" class="text-xs text-slate-400"></span>
                <div class="flex gap-2">
                    <button id="btnPrev" onclick="changePage(-1)" class="touch-target px-3 py-1.5 text-xs bg-slate-800 rounded-lg hover:bg-slate-700 transition disabled:opacity-40" disabled>Previous</button>
                    <button id="btnNext" onclick="changePage(1)" class="touch-target px-3 py-1.5 text-xs bg-slate-800 rounded-lg hover:bg-slate-700 transition disabled:opacity-40" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Invoice Panel -->
    <div id="invoiceFormPanel" class="fixed inset-0 z-40 hidden">
        <div class="modal-overlay absolute inset-0" onclick="hideCreateForm()"></div>
        <div class="slide-panel absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-slate-900 border-l border-slate-700/50 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-slate-700/50 flex items-center justify-between sticky top-0 bg-slate-900 z-10">
                <h2 id="formTitle" class="text-lg font-bold">New Invoice</h2>
                <button onclick="hideCreateForm()" class="touch-target p-2 hover:bg-slate-800 rounded-lg transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-4 space-y-6">
                <!-- Carrier -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Carrier DOT Number</label>
                    <input id="formCarrierDot" type="text" placeholder="Enter carrier DOT number" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue focus:ring-1 focus:ring-lmdr-blue outline-none" />
                </div>
                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Invoice Date</label>
                        <input id="formInvoiceDate" type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none" />
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Due Date</label>
                        <input id="formDueDate" type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none" />
                    </div>
                </div>
                <!-- Line Items -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs text-slate-400 uppercase">Line Items</label>
                        <button onclick="addLineItem()" class="flex items-center gap-1 text-xs text-lmdr-blue hover:text-blue-400 transition">
                            <span class="material-symbols-outlined text-[16px]">add</span> Add Item
                        </button>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-xs text-slate-400 uppercase border-b border-slate-700/50">
                                    <th class="py-2 px-3 text-left">Description</th>
                                    <th class="py-2 px-3 text-center w-20">Qty</th>
                                    <th class="py-2 px-3 text-right w-28">Unit Price</th>
                                    <th class="py-2 px-3 text-right w-24">Total</th>
                                    <th class="py-2 px-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="lineItemsBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Discount -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Discount Type</label>
                        <select id="discountType" onchange="recalculateTotals()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none">
                            <option value="fixed">Fixed Amount ($)</option>
                            <option value="percentage">Percentage (%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Discount Value</label>
                        <input id="discountValue" type="number" step="0.01" min="0" value="0" oninput="recalculateTotals()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none" />
                    </div>
                </div>
                <!-- Totals -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 space-y-2">
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Subtotal</span><span id="subtotal">$0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Discount</span><span id="discountDisplay" class="text-red-400">-$0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Tax</span><span>$0.00</span></div>
                    <div class="border-t border-slate-700/50 pt-2 flex justify-between text-lg font-bold"><span>Total</span><span id="total">$0.00</span></div>
                </div>
                <!-- Notes -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Notes</label>
                    <textarea id="formNotes" rows="3" placeholder="Additional notes..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none resize-none"></textarea>
                </div>
                <!-- Actions -->
                <div class="flex gap-3 pt-2">
                    <button onclick="saveDraft()" class="touch-target flex-1 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-lg hover:bg-slate-600 transition">Save Draft</button>
                    <button onclick="saveAndSend()" class="touch-target flex-1 py-2.5 bg-lmdr-blue text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">Send Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Detail View -->
    <div id="invoiceDetailPanel" class="fixed inset-0 z-40 hidden">
        <div class="modal-overlay absolute inset-0" onclick="hideDetailView()"></div>
        <div class="slide-panel absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-slate-900 border-l border-slate-700/50 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-slate-700/50 flex items-center justify-between sticky top-0 bg-slate-900 z-10">
                <h2 id="detailTitle" class="text-lg font-bold">Invoice Detail</h2>
                <button onclick="hideDetailView()" class="touch-target p-2 hover:bg-slate-800 rounded-lg transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="detailContent" class="p-4"></div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="hidePaymentModal()"></div>
        <div class="relative bg-slate-900 rounded-xl border border-slate-700/50 w-full max-w-md p-6 mx-4">
            <h3 class="text-lg font-bold mb-4">Record Payment</h3>
            <input type="hidden" id="paymentInvoiceId" />
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Payment Method</label>
                    <select id="paymentMethod" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="check">Check</option>
                        <option value="wire">Wire Transfer</option>
                        <option value="ach">ACH</option>
                        <option value="credit_card">Credit Card</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Reference Number</label>
                    <input id="paymentReference" type="text" placeholder="Transaction or check number" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none" />
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Payment Date</label>
                    <input id="paymentDate" type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none" />
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hidePaymentModal()" class="flex-1 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-lg hover:bg-slate-600 transition">Cancel</button>
                <button onclick="confirmPayment()" class="flex-1 py-2.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">Confirm Payment</button>
            </div>
        </div>
    </div>

    <!-- Void Confirmation Modal -->
    <div id="voidModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="hideVoidModal()"></div>
        <div class="relative bg-slate-900 rounded-xl border border-slate-700/50 w-full max-w-md p-6 mx-4">
            <h3 class="text-lg font-bold mb-2">Void Invoice</h3>
            <p class="text-sm text-red-400 mb-4">This action cannot be undone. The invoice will be permanently voided.</p>
            <input type="hidden" id="voidInvoiceId" />
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase">Reason (required)</label>
                <textarea id="voidReason" rows="3" placeholder="Why is this invoice being voided?" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none resize-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideVoidModal()" class="flex-1 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-lg hover:bg-slate-600 transition">Cancel</button>
                <button onclick="confirmVoid()" class="flex-1 py-2.5 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition">Void Invoice</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="hidePDFPreview()"></div>
        <div class="relative bg-white rounded-xl w-full max-w-3xl max-h-[90vh] overflow-auto mx-4">
            <div class="sticky top-0 bg-white border-b p-3 flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Invoice Preview</span>
                <button onclick="hidePDFPreview()" class="p-1 hover:bg-gray-100 rounded"><span class="material-symbols-outlined text-gray-700">close</span></button>
            </div>
            <div id="pdfPreviewContent"></div>
        </div>
    </div>

    <script>
        // =====================================================================
        // STATE
        // =====================================================================
        let invoices = [];
        let currentFilter = '';
        let currentPage = 1;
        let totalPages = 1;
        let editingInvoiceId = null;
        let lineItemCounter = 0;

        // =====================================================================
        // POSTMESSAGE BRIDGE
        // =====================================================================
        function sendToVelo(data) { window.parent.postMessage(data, '*'); }

        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (!msg || !msg.action) return;
            switch (msg.action) {
                case 'init': requestInvoiceData(); break;
                case 'invoicesLoaded': renderInvoiceList(msg.payload); break;
                case 'invoiceDetailLoaded': renderInvoiceDetail(msg.payload); break;
                case 'invoiceCreated': showToast('Invoice created', 'success'); hideCreateForm(); refreshList(); break;
                case 'invoiceSent': showToast('Invoice sent', 'success'); refreshList(); break;
                case 'paymentRecorded': showToast('Payment recorded', 'success'); hidePaymentModal(); refreshList(); break;
                case 'invoiceVoided': showToast('Invoice voided', 'success'); hideVoidModal(); refreshList(); break;
                case 'invoiceStatsLoaded': renderStats(msg.payload); break;
                case 'pdfReady': showPDFPreview(msg.payload); break;
                case 'actionError': showToast(msg.message || 'An error occurred', 'error'); break;
            }
        });

        function requestInvoiceData() {
            sendToVelo({ action: 'getInvoices', filters: { status: currentFilter }, page: currentPage });
            sendToVelo({ action: 'getInvoiceStats' });
        }

        function refreshList() {
            sendToVelo({ action: 'getInvoices', filters: { status: currentFilter }, page: currentPage });
            sendToVelo({ action: 'getInvoiceStats' });
        }

        // =====================================================================
        // RENDER INVOICE LIST
        // =====================================================================
        function renderInvoiceList(data) {
            const loading = document.getElementById('invoiceListLoading');
            const table = document.getElementById('invoiceTable');
            const empty = document.getElementById('emptyState');
            const tbody = document.getElementById('invoiceTableBody');
            const pag = document.getElementById('pagination');

            loading.classList.add('hidden');
            invoices = data.invoices || [];

            if (invoices.length === 0) {
                table.classList.add('hidden');
                pag.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            table.classList.remove('hidden');
            tbody.innerHTML = '';

            invoices.forEach(inv => {
                const lineItems = typeof inv.line_items === 'string' ? JSON.parse(inv.line_items || '[]') : (inv.line_items || []);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700/30 hover:bg-slate-800/50 cursor-pointer transition';
                tr.onclick = () => viewInvoiceDetail(inv._id);
                tr.innerHTML = `
                    <td class="py-3 px-3 font-mono text-xs">${inv.invoice_number || '-'}</td>
                    <td class="py-3 px-3 text-slate-300">${inv.carrier_dot || '-'}</td>
                    <td class="py-3 px-3 text-right font-medium">${formatCurrency(inv.total)}</td>
                    <td class="py-3 px-3"><span class="px-2 py-0.5 rounded-full text-xs font-medium status-${inv.status}">${inv.status}</span></td>
                    <td class="py-3 px-3 text-slate-400 text-xs">${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                    <td class="py-3 px-3 text-slate-400 text-xs">${inv.sent_date ? new Date(inv.sent_date).toLocaleDateString() : '-'}</td>
                    <td class="py-3 px-3 text-right" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-end gap-1">
                            ${inv.status === 'draft' ? `<button onclick="sendInvoiceAction('${inv._id}')" class="touch-target p-1.5 hover:bg-blue-900/50 rounded-lg transition" title="Send"><span class="material-symbols-outlined text-[18px] text-blue-400">send</span></button>` : ''}
                            ${(inv.status === 'sent' || inv.status === 'overdue') ? `<button onclick="showPaymentModal('${inv._id}')" class="touch-target p-1.5 hover:bg-green-900/50 rounded-lg transition" title="Record Payment"><span class="material-symbols-outlined text-[18px] text-green-400">payments</span></button>` : ''}
                            ${inv.status !== 'void' && inv.status !== 'paid' ? `<button onclick="showVoidModal('${inv._id}')" class="touch-target p-1.5 hover:bg-red-900/50 rounded-lg transition" title="Void"><span class="material-symbols-outlined text-[18px] text-red-400">block</span></button>` : ''}
                            <button onclick="viewPDF('${inv._id}')" class="touch-target p-1.5 hover:bg-slate-700 rounded-lg transition" title="Preview PDF"><span class="material-symbols-outlined text-[18px] text-slate-400">picture_as_pdf</span></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Pagination
            const totalCount = data.totalCount || 0;
            const pageSize = data.pageSize || 20;
            totalPages = Math.ceil(totalCount / pageSize) || 1;
            currentPage = data.page || 1;
            if (totalCount > pageSize) {
                pag.classList.remove('hidden');
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages} (${totalCount} invoices)`;
                document.getElementById('btnPrev').disabled = currentPage <= 1;
                document.getElementById('btnNext').disabled = currentPage >= totalPages;
            } else {
                pag.classList.add('hidden');
            }
        }

        // =====================================================================
        // RENDER STATS
        // =====================================================================
        function renderStats(data) {
            if (!data || !data.stats) return;
            document.getElementById('statOutstanding').textContent = formatCurrency(data.totalOutstanding || 0);
            document.getElementById('statOverdueCount').textContent = data.stats.overdue ? data.stats.overdue.count : 0;

            const countMap = { All: 0, Draft: 0, Sent: 0, Paid: 0, Overdue: 0, Void: 0 };
            for (const [status, info] of Object.entries(data.stats)) {
                countMap[status.charAt(0).toUpperCase() + status.slice(1)] = info.count;
                countMap.All += info.count;
            }
            const el = (id) => document.getElementById(id);
            el('countAll').textContent = countMap.All || '';
            el('countDraft').textContent = countMap.Draft || '';
            el('countSent').textContent = countMap.Sent || '';
            el('countPaid').textContent = countMap.Paid || '';
            el('countOverdue').textContent = countMap.Overdue || '';
            el('countVoid').textContent = countMap.Void || '';
        }

        // =====================================================================
        // RENDER INVOICE DETAIL
        // =====================================================================
        function renderInvoiceDetail(data) {
            if (!data || !data.invoice) return;
            const inv = data.invoice;
            const lineItems = typeof inv.line_items === 'string' ? JSON.parse(inv.line_items || '[]') : (inv.line_items || []);
            const dc = document.getElementById('detailContent');
            document.getElementById('detailTitle').textContent = inv.invoice_number || 'Invoice Detail';

            const statusColors = { draft: 'bg-slate-700 text-slate-300', sent: 'bg-blue-900/50 text-blue-400', paid: 'bg-green-900/50 text-green-400', overdue: 'bg-red-900/50 text-red-400', void: 'bg-slate-800 text-slate-500' };

            dc.innerHTML = `
                <div class="space-y-6">
                    <!-- Status + Actions -->
                    <div class="flex items-center justify-between">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[inv.status] || 'bg-slate-700 text-slate-300'}">${inv.status}</span>
                        <div class="flex gap-2">
                            ${inv.status === 'draft' ? `<button onclick="sendInvoiceAction('${inv._id}')" class="px-3 py-1.5 text-xs bg-blue-600 rounded-lg hover:bg-blue-700 transition">Send</button>` : ''}
                            ${(inv.status === 'sent' || inv.status === 'overdue') ? `<button onclick="showPaymentModal('${inv._id}')" class="px-3 py-1.5 text-xs bg-green-600 rounded-lg hover:bg-green-700 transition">Record Payment</button>` : ''}
                            ${(inv.status !== 'void' && inv.status !== 'paid') ? `<button onclick="showVoidModal('${inv._id}')" class="px-3 py-1.5 text-xs bg-red-600 rounded-lg hover:bg-red-700 transition">Void</button>` : ''}
                            <button onclick="viewPDF('${inv._id}')" class="px-3 py-1.5 text-xs bg-slate-700 rounded-lg hover:bg-slate-600 transition">Preview PDF</button>
                        </div>
                    </div>
                    <!-- Company Header -->
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-6 h-6 rounded bg-lmdr-blue flex items-center justify-center text-[10px] font-bold">VM</div>
                                    <span class="font-bold">VelocityMatch</span>
                                </div>
                                <p class="text-xs text-slate-400">Last Mile Driver Recruiting</p>
                            </div>
                            <div class="text-right">
                                <p class="font-mono font-bold">${inv.invoice_number}</p>
                                <p class="text-xs text-slate-400 mt-1">Date: ${inv.invoice_date ? new Date(inv.invoice_date).toLocaleDateString() : '-'}</p>
                                <p class="text-xs text-slate-400">Due: ${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</p>
                            </div>
                        </div>
                    </div>
                    <!-- Bill To -->
                    <div>
                        <p class="text-xs text-slate-400 uppercase mb-1">Bill To</p>
                        <p class="font-medium">Carrier DOT: ${inv.carrier_dot}</p>
                    </div>
                    <!-- Line Items -->
                    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead><tr class="text-xs text-slate-400 uppercase border-b border-slate-700/50">
                                <th class="py-2 px-3 text-left">Description</th>
                                <th class="py-2 px-3 text-center">Qty</th>
                                <th class="py-2 px-3 text-right">Price</th>
                                <th class="py-2 px-3 text-right">Total</th>
                            </tr></thead>
                            <tbody>${lineItems.map(li => `<tr class="border-b border-slate-700/30"><td class="py-2 px-3">${li.description}</td><td class="py-2 px-3 text-center">${li.quantity}</td><td class="py-2 px-3 text-right">${formatCurrency(li.unit_price)}</td><td class="py-2 px-3 text-right">${formatCurrency(li.quantity * li.unit_price)}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                    <!-- Totals -->
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-slate-400">Subtotal</span><span>${formatCurrency(inv.subtotal)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">Discount</span><span class="text-red-400">-${formatCurrency(inv.discount_amount || 0)}</span></div>
                        <div class="flex justify-between text-lg font-bold border-t border-slate-700/50 pt-2"><span>Total</span><span>${formatCurrency(inv.total)}</span></div>
                    </div>
                    ${inv.notes ? `<div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50"><p class="text-xs text-slate-400 uppercase mb-1">Notes</p><p class="text-sm">${inv.notes}</p></div>` : ''}
                    <!-- Status Timeline -->
                    <div>
                        <p class="text-xs text-slate-400 uppercase mb-3">Timeline</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-green-400"></div><span class="text-xs text-slate-300">Created</span><span class="text-xs text-slate-500 ml-auto">${inv.created_date ? new Date(inv.created_date).toLocaleString() : '-'}</span></div>
                            ${inv.sent_date ? `<div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-blue-400"></div><span class="text-xs text-slate-300">Sent</span><span class="text-xs text-slate-500 ml-auto">${new Date(inv.sent_date).toLocaleString()}</span></div>` : ''}
                            ${inv.paid_date ? `<div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-green-400"></div><span class="text-xs text-slate-300">Paid (${inv.payment_method || 'N/A'})</span><span class="text-xs text-slate-500 ml-auto">${new Date(inv.paid_date).toLocaleString()}</span></div>` : ''}
                            ${inv.void_date ? `<div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-red-400"></div><span class="text-xs text-slate-300">Voided: ${inv.void_reason || '-'}</span><span class="text-xs text-slate-500 ml-auto">${new Date(inv.void_date).toLocaleString()}</span></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('invoiceDetailPanel').classList.remove('hidden');
        }

        // =====================================================================
        // ACTIONS
        // =====================================================================
        function filterByStatus(status) {
            currentFilter = status;
            currentPage = 1;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('bg-lmdr-blue', btn.dataset.status === status);
                btn.classList.toggle('text-white', btn.dataset.status === status);
                btn.classList.toggle('text-slate-400', btn.dataset.status !== status);
            });
            refreshList();
        }

        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            refreshList();
        }

        function viewInvoiceDetail(id) {
            sendToVelo({ action: 'getInvoiceDetail', invoiceId: id });
        }

        function sendInvoiceAction(id) {
            sendToVelo({ action: 'sendInvoice', invoiceId: id });
        }

        function viewPDF(id) {
            sendToVelo({ action: 'generatePDF', invoiceId: id });
        }

        // =====================================================================
        // CREATE / EDIT FORM
        // =====================================================================
        function showCreateForm() {
            editingInvoiceId = null;
            document.getElementById('formTitle').textContent = 'New Invoice';
            document.getElementById('formCarrierDot').value = '';
            document.getElementById('formInvoiceDate').value = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('formDueDate').value = dueDate.toISOString().split('T')[0];
            document.getElementById('discountType').value = 'fixed';
            document.getElementById('discountValue').value = '0';
            document.getElementById('formNotes').value = '';
            document.getElementById('lineItemsBody').innerHTML = '';
            lineItemCounter = 0;
            addLineItem();
            recalculateTotals();
            document.getElementById('invoiceFormPanel').classList.remove('hidden');
        }

        function hideCreateForm() {
            document.getElementById('invoiceFormPanel').classList.add('hidden');
        }

        function hideDetailView() {
            document.getElementById('invoiceDetailPanel').classList.add('hidden');
        }

        // =====================================================================
        // LINE ITEMS EDITOR
        // =====================================================================
        function addLineItem(desc = '', qty = 1, price = 0) {
            const id = lineItemCounter++;
            const tbody = document.getElementById('lineItemsBody');
            const tr = document.createElement('tr');
            tr.className = 'line-item-row border-b border-slate-700/30';
            tr.dataset.id = id;
            tr.innerHTML = `
                <td class="py-2 px-2"><input type="text" value="${desc}" placeholder="Description" class="desc-input w-full bg-transparent border-0 text-sm outline-none" oninput="recalculateTotals()" /></td>
                <td class="py-2 px-2"><input type="number" value="${qty}" min="1" step="1" class="qty-input w-full bg-transparent border-0 text-sm text-center outline-none" oninput="recalculateTotals()" /></td>
                <td class="py-2 px-2"><input type="number" value="${price}" min="0" step="0.01" class="price-input w-full bg-transparent border-0 text-sm text-right outline-none" oninput="recalculateTotals()" /></td>
                <td class="py-2 px-2 text-right text-sm line-total">$0.00</td>
                <td class="py-2 px-1"><button onclick="removeLineItem(this)" class="p-1 hover:bg-red-900/30 rounded transition"><span class="material-symbols-outlined text-[16px] text-red-400">close</span></button></td>
            `;
            tbody.appendChild(tr);
            recalculateTotals();
        }

        function removeLineItem(btn) {
            const row = btn.closest('.line-item-row');
            if (document.querySelectorAll('.line-item-row').length > 1) {
                row.remove();
                recalculateTotals();
            }
        }

        function recalculateTotals() {
            const rows = document.querySelectorAll('.line-item-row');
            let subtotal = 0;
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const lineTotal = qty * price;
                row.querySelector('.line-total').textContent = formatCurrency(lineTotal);
                subtotal += lineTotal;
            });
            const discType = document.getElementById('discountType').value;
            const discVal = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountAmount = discType === 'percentage' ? subtotal * (discVal / 100) : discVal;
            const total = subtotal - discountAmount;
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('discountDisplay').textContent = `-${formatCurrency(discountAmount)}`;
            document.getElementById('total').textContent = formatCurrency(total);
        }

        function getLineItems() {
            const items = [];
            document.querySelectorAll('.line-item-row').forEach(row => {
                const desc = row.querySelector('.desc-input').value.trim();
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                if (desc && qty > 0) {
                    items.push({ description: desc, quantity: qty, unit_price: price });
                }
            });
            return items;
        }

        function saveDraft() {
            const lineItems = getLineItems();
            if (!document.getElementById('formCarrierDot').value.trim()) {
                showToast('Carrier DOT is required', 'error');
                return;
            }
            if (lineItems.length === 0) {
                showToast('At least one line item is required', 'error');
                return;
            }
            sendToVelo({
                action: 'createInvoice',
                invoiceData: {
                    carrier_dot: document.getElementById('formCarrierDot').value.trim(),
                    line_items: lineItems,
                    due_date: document.getElementById('formDueDate').value,
                    discount_type: document.getElementById('discountType').value,
                    discount_value: parseFloat(document.getElementById('discountValue').value) || 0,
                    notes: document.getElementById('formNotes').value.trim()
                }
            });
        }

        function saveAndSend() {
            saveDraft();
            // The backend will create as draft, then the page code can auto-send after creation
        }

        // =====================================================================
        // PAYMENT MODAL
        // =====================================================================
        function showPaymentModal(id) {
            document.getElementById('paymentInvoiceId').value = id;
            document.getElementById('paymentMethod').value = 'check';
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function hidePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function confirmPayment() {
            const id = document.getElementById('paymentInvoiceId').value;
            sendToVelo({
                action: 'recordPayment',
                invoiceId: id,
                paymentDetails: {
                    payment_method: document.getElementById('paymentMethod').value,
                    payment_reference: document.getElementById('paymentReference').value.trim(),
                    payment_date: document.getElementById('paymentDate').value
                }
            });
        }

        // =====================================================================
        // VOID MODAL
        // =====================================================================
        function showVoidModal(id) {
            document.getElementById('voidInvoiceId').value = id;
            document.getElementById('voidReason').value = '';
            document.getElementById('voidModal').classList.remove('hidden');
        }

        function hideVoidModal() {
            document.getElementById('voidModal').classList.add('hidden');
        }

        function confirmVoid() {
            const id = document.getElementById('voidInvoiceId').value;
            const reason = document.getElementById('voidReason').value.trim();
            if (!reason) {
                showToast('Void reason is required', 'error');
                return;
            }
            sendToVelo({ action: 'voidInvoice', invoiceId: id, reason });
        }

        // =====================================================================
        // PDF PREVIEW
        // =====================================================================
        function showPDFPreview(data) {
            if (!data || !data.html) return;
            document.getElementById('pdfPreviewContent').innerHTML = data.html;
            document.getElementById('pdfPreviewModal').classList.remove('hidden');
        }

        function hidePDFPreview() {
            document.getElementById('pdfPreviewModal').classList.add('hidden');
        }

        // =====================================================================
        // UTILITIES
        // =====================================================================
        function formatCurrency(amount) {
            return '$' + Number(amount || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            toast.className = `toast px-4 py-3 rounded-lg text-sm font-medium ${colors[type] || colors.info} shadow-lg`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        // Initialize on bridge ready or standalone
        filterByStatus('');
    </script>
</body>
</html>
