<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>VelocityMatch Invoicing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24', canvas: '#f8fafc' }
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/css/admin-invoicing.css" />
</head>

<body class="bg-lmdr-dark text-white font-sans h-full">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Layout -->
    <div id="mainContent" class="h-full flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex items-center justify-between px-4 py-3 border-b border-slate-700/50 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-lmdr-blue flex items-center justify-center text-xs font-bold">VM</div>
                <h1 class="text-lg font-bold">Invoicing</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="headerStats" class="hidden sm:flex items-center gap-4 text-xs text-slate-400">
                    <span>Outstanding: <strong id="statOutstanding" class="text-amber-400">$0.00</strong></span>
                    <span>Overdue: <strong id="statOverdueCount" class="text-red-400">0</strong></span>
                </div>
                <button id="btnNewInvoice" onclick="InvoicingLogic.showCreateForm()" class="touch-target touch-active flex items-center gap-1 px-3 py-2 bg-lmdr-blue text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    New Invoice
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex items-center gap-1 px-4 py-2 border-b border-slate-700/30 shrink-0 overflow-x-auto scrollbar-thin">
            <button onclick="InvoicingLogic.filterByStatus('')" class="tab-btn active touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="">All <span id="countAll" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="InvoicingLogic.filterByStatus('draft')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="draft">Draft <span id="countDraft" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="InvoicingLogic.filterByStatus('sent')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="sent">Sent <span id="countSent" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="InvoicingLogic.filterByStatus('paid')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="paid">Paid <span id="countPaid" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="InvoicingLogic.filterByStatus('overdue')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="overdue">Overdue <span id="countOverdue" class="ml-1 text-xs opacity-60"></span></button>
            <button onclick="InvoicingLogic.filterByStatus('void')" class="tab-btn touch-target px-3 py-1.5 text-sm rounded-lg font-medium transition" data-status="void">Void <span id="countVoid" class="ml-1 text-xs opacity-60"></span></button>
        </nav>

        <!-- Invoice List -->
        <div id="invoiceListView" class="flex-1 overflow-y-auto scrollbar-thin p-4">
            <div id="invoiceListLoading" class="space-y-3">
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
            </div>
            <table id="invoiceTable" class="hidden w-full text-sm">
                <thead>
                    <tr class="text-left text-slate-400 text-xs uppercase border-b border-slate-700/50">
                        <th class="pb-2 px-3">Invoice #</th>
                        <th class="pb-2 px-3">Carrier</th>
                        <th class="pb-2 px-3 text-right">Amount</th>
                        <th class="pb-2 px-3">Status</th>
                        <th class="pb-2 px-3">Due Date</th>
                        <th class="pb-2 px-3">Sent Date</th>
                        <th class="pb-2 px-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody"></tbody>
            </table>
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-slate-400">
                <span class="material-symbols-outlined text-5xl mb-3">receipt_long</span>
                <p class="text-lg font-medium">No invoices found</p>
                <p class="text-sm mt-1">Create your first invoice to get started</p>
            </div>
            <!-- Pagination -->
            <div id="pagination" class="hidden flex items-center justify-between mt-4 pt-4 border-t border-slate-700/30">
                <span id="pageInfo" class="text-xs text-slate-400"></span>
                <div class="flex gap-2">
                    <button id="btnPrev" onclick="InvoicingLogic.changePage(-1)" class="touch-target px-3 py-1.5 text-xs bg-slate-800 rounded-lg hover:bg-slate-700 transition disabled:opacity-40" disabled>Previous</button>
                    <button id="btnNext" onclick="InvoicingLogic.changePage(1)" class="touch-target px-3 py-1.5 text-xs bg-slate-800 rounded-lg hover:bg-slate-700 transition disabled:opacity-40" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Invoice Panel -->
    <div id="invoiceFormPanel" class="fixed inset-0 z-40 hidden">
        <div class="modal-overlay absolute inset-0" onclick="InvoicingLogic.hideCreateForm()"></div>
        <div class="slide-panel absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-slate-900 border-l border-slate-700/50 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-slate-700/50 flex items-center justify-between sticky top-0 bg-slate-900 z-10">
                <h2 id="formTitle" class="text-lg font-bold">New Invoice</h2>
                <button onclick="InvoicingLogic.hideCreateForm()" class="touch-target p-2 hover:bg-slate-800 rounded-lg transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-4 space-y-6">
                <!-- Carrier -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Carrier DOT Number</label>
                    <input id="formCarrierDot" type="text" placeholder="Enter carrier DOT number" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue focus:ring-1 focus:ring-lmdr-blue outline-none" />
                </div>
                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Invoice Date</label>
                        <input id="formInvoiceDate" type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none" />
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Due Date</label>
                        <input id="formDueDate" type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none" />
                    </div>
                </div>
                <!-- Line Items -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs text-slate-400 uppercase">Line Items</label>
                        <button onclick="InvoicingLogic.addLineItem()" class="flex items-center gap-1 text-xs text-lmdr-blue hover:text-blue-400 transition">
                            <span class="material-symbols-outlined text-[16px]">add</span> Add Item
                        </button>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-xs text-slate-400 uppercase border-b border-slate-700/50">
                                    <th class="py-2 px-3 text-left">Description</th>
                                    <th class="py-2 px-3 text-center w-20">Qty</th>
                                    <th class="py-2 px-3 text-right w-28">Unit Price</th>
                                    <th class="py-2 px-3 text-right w-24">Total</th>
                                    <th class="py-2 px-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="lineItemsBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Discount -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Discount Type</label>
                        <select id="discountType" onchange="InvoicingLogic.recalculateTotals()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none">
                            <option value="fixed">Fixed Amount ($)</option>
                            <option value="percentage">Percentage (%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 uppercase">Discount Value</label>
                        <input id="discountValue" type="number" step="0.01" min="0" value="0" oninput="InvoicingLogic.recalculateTotals()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none" />
                    </div>
                </div>
                <!-- Totals -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 space-y-2">
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Subtotal</span><span id="subtotal">$0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Discount</span><span id="discountDisplay" class="text-red-400">-$0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Tax</span><span>$0.00</span></div>
                    <div class="border-t border-slate-700/50 pt-2 flex justify-between text-lg font-bold"><span>Total</span><span id="total">$0.00</span></div>
                </div>
                <!-- Notes -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Notes</label>
                    <textarea id="formNotes" rows="3" placeholder="Additional notes..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-lmdr-blue outline-none resize-none"></textarea>
                </div>
                <!-- Actions -->
                <div class="flex gap-3 pt-2">
                    <button onclick="InvoicingLogic.saveDraft()" class="touch-target flex-1 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-lg hover:bg-slate-600 transition">Save Draft</button>
                    <button onclick="InvoicingLogic.saveAndSend()" class="touch-target flex-1 py-2.5 bg-lmdr-blue text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">Send Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Detail View -->
    <div id="invoiceDetailPanel" class="fixed inset-0 z-40 hidden">
        <div class="modal-overlay absolute inset-0" onclick="InvoicingLogic.hideDetailView()"></div>
        <div class="slide-panel absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-slate-900 border-l border-slate-700/50 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-slate-700/50 flex items-center justify-between sticky top-0 bg-slate-900 z-10">
                <h2 id="detailTitle" class="text-lg font-bold">Invoice Detail</h2>
                <button onclick="InvoicingLogic.hideDetailView()" class="touch-target p-2 hover:bg-slate-800 rounded-lg transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="detailContent" class="p-4"></div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="InvoicingLogic.hidePaymentModal()"></div>
        <div class="relative bg-slate-900 rounded-xl border border-slate-700/50 w-full max-w-md p-6 mx-4">
            <h3 class="text-lg font-bold mb-4">Record Payment</h3>
            <input type="hidden" id="paymentInvoiceId" />
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Payment Method</label>
                    <select id="paymentMethod" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="check">Check</option>
                        <option value="wire">Wire Transfer</option>
                        <option value="ach">ACH</option>
                        <option value="credit_card">Credit Card</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Reference Number</label>
                    <input id="paymentReference" type="text" placeholder="Transaction or check number" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none" />
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase">Payment Date</label>
                    <input id="paymentDate" type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none" />
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="InvoicingLogic.hidePaymentModal()" class="flex-1 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-lg hover:bg-slate-600 transition">Cancel</button>
                <button onclick="InvoicingLogic.confirmPayment()" class="flex-1 py-2.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">Confirm Payment</button>
            </div>
        </div>
    </div>

    <!-- Void Confirmation Modal -->
    <div id="voidModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="InvoicingLogic.hideVoidModal()"></div>
        <div class="relative bg-slate-900 rounded-xl border border-slate-700/50 w-full max-w-md p-6 mx-4">
            <h3 class="text-lg font-bold mb-2">Void Invoice</h3>
            <p class="text-sm text-red-400 mb-4">This action cannot be undone. The invoice will be permanently voided.</p>
            <input type="hidden" id="voidInvoiceId" />
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase">Reason (required)</label>
                <textarea id="voidReason" rows="3" placeholder="Why is this invoice being voided?" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none resize-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="InvoicingLogic.hideVoidModal()" class="flex-1 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-lg hover:bg-slate-600 transition">Cancel</button>
                <button onclick="InvoicingLogic.confirmVoid()" class="flex-1 py-2.5 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition">Void Invoice</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="InvoicingLogic.hidePDFPreview()"></div>
        <div class="relative bg-white rounded-xl w-full max-w-3xl max-h-[90vh] overflow-auto mx-4">
            <div class="sticky top-0 bg-white border-b p-3 flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Invoice Preview</span>
                <button onclick="InvoicingLogic.hidePDFPreview()" class="p-1 hover:bg-gray-100 rounded"><span class="material-symbols-outlined text-gray-700">close</span></button>
            </div>
            <div id="pdfPreviewContent"></div>
        </div>
    </div>

    <!-- CDN Modules (ordered by dependency) -->
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-invoicing-config.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-invoicing-bridge.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-invoicing-render.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/admin/js/admin-invoicing-logic.js"></script>

    <!-- Bootstrap -->
    <script>
        InvoicingLogic.exposeGlobals();
        document.addEventListener('DOMContentLoaded', function () { InvoicingLogic.init(); });
    </script>
</body>
</html>
