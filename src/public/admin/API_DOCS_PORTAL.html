<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>VelocityMatch | API Docs Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            vm: {
              deep: '#0f172a',
              panel: '#111827',
              edge: '#1f2937',
              blue: '#2563eb',
              mint: '#14b8a6',
              amber: '#f59e0b'
            }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] }
        }
      }
    };
  </script>
</head>
<body class="bg-vm-deep text-slate-100 font-sans min-h-screen p-6">
  <header class="mb-5">
    <h1 class="text-2xl font-bold">External API Documentation</h1>
    <p class="text-sm text-slate-400">Interactive endpoint catalog with search, sandbox try-it, status snapshot, and changelog feed.</p>
  </header>

  <section class="bg-vm-panel border border-vm-edge rounded-xl p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <label class="text-xs text-slate-400">Search Endpoints
        <input id="searchInput" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" placeholder="search by path, category, or method" />
      </label>
      <label class="text-xs text-slate-400">Sandbox Endpoint
        <select id="sandboxEndpoint" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
      </label>
      <label class="text-xs text-slate-400">Sandbox Payload (JSON)
        <input id="sandboxPayload" class="block mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" placeholder='{"region":"TX"}' />
      </label>
      <div class="flex flex-wrap gap-2 items-end">
        <button id="runSandbox" class="px-3 py-2 bg-vm-mint text-slate-900 rounded text-sm font-semibold">Try Sandbox</button>
        <button id="refreshCatalog" class="px-3 py-2 bg-vm-blue rounded text-sm">Refresh Docs</button>
      </div>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Endpoints</h2>
      <div id="endpointList" class="space-y-2 text-xs">Loading...</div>
    </div>
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Sandbox Response</h2>
      <pre id="sandboxResult" class="text-xs text-slate-300 whitespace-pre-wrap">No sandbox request yet</pre>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">Code Examples</h2>
      <div class="flex gap-2 mb-2">
        <button data-lang="curl" class="lang-btn px-2 py-1 text-xs bg-vm-blue rounded">cURL</button>
        <button data-lang="javascript" class="lang-btn px-2 py-1 text-xs bg-slate-700 rounded">JavaScript</button>
        <button data-lang="python" class="lang-btn px-2 py-1 text-xs bg-slate-700 rounded">Python</button>
      </div>
      <pre id="codeExample" class="text-xs text-slate-300 whitespace-pre-wrap">Loading...</pre>
    </div>
    <div class="bg-vm-panel border border-vm-edge rounded-xl p-4">
      <h2 class="font-semibold mb-2">API Status + Changelog Snapshot</h2>
      <pre id="statusPane" class="text-xs text-slate-300 whitespace-pre-wrap">Loading...</pre>
      <pre id="changelogPane" class="mt-3 text-xs text-slate-300 whitespace-pre-wrap">Loading...</pre>
    </div>
  </section>

  <section class="bg-vm-panel border border-vm-edge rounded-xl p-4">
    <h2 class="font-semibold mb-2">References</h2>
    <div class="text-xs text-slate-300 space-y-1">
      <div>OpenAPI: <a class="text-vm-mint underline" href="https://www.lastmiledr.app/docs/api/openapi.external.v1.yaml" target="_blank" rel="noopener">openapi.external.v1.yaml</a></div>
      <div>Postman: <a class="text-vm-mint underline" href="https://www.lastmiledr.app/docs/api/postman.external.v1.collection.json" target="_blank" rel="noopener">postman.external.v1.collection.json</a></div>
      <div>Integration Guide: <a class="text-vm-mint underline" href="https://www.lastmiledr.app/docs/api/integration-guide.external.v1.md" target="_blank" rel="noopener">integration-guide.external.v1.md</a></div>
    </div>
  </section>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = {
      endpoints: [],
      examples: {},
      selectedLanguage: 'curl'
    };

    function post(action, extra = {}) {
      window.parent.postMessage({ action, ...extra }, '*');
    }

    function showJson(id, value) {
      $(id).textContent = JSON.stringify(value, null, 2);
    }

    function renderEndpoints(filterText = '') {
      const host = $('endpointList');
      const term = String(filterText || '').trim().toLowerCase();
      const filtered = state.endpoints.filter((endpoint) => {
        if (!term) return true;
        const blob = [endpoint.method, endpoint.path, endpoint.category, endpoint.description].join(' ').toLowerCase();
        return blob.includes(term);
      });

      host.innerHTML = '';
      if (!filtered.length) {
        host.textContent = 'No endpoints match search criteria.';
        return;
      }

      filtered.forEach((endpoint) => {
        const card = document.createElement('div');
        card.className = 'border border-slate-700 rounded p-2';
        card.innerHTML = '<div class="flex justify-between"><strong>' + endpoint.method + '</strong><span class="text-slate-400">' + endpoint.category + '</span></div>' +
          '<div class="text-slate-200 mt-1">' + endpoint.path + '</div>' +
          '<div class="text-slate-400 mt-1">tier: ' + endpoint.tier + '</div>' +
          '<div class="text-slate-400 mt-1">' + endpoint.description + '</div>';
        host.appendChild(card);
      });
    }

    function refreshSandboxSelect() {
      const select = $('sandboxEndpoint');
      select.innerHTML = '';
      state.endpoints.forEach((endpoint) => {
        const option = document.createElement('option');
        option.value = endpoint.key;
        option.textContent = endpoint.method + ' ' + endpoint.path;
        select.appendChild(option);
      });
    }

    function setLanguage(language) {
      state.selectedLanguage = language;
      const code = state.examples[language] || 'No example available';
      $('codeExample').textContent = code;

      document.querySelectorAll('.lang-btn').forEach((button) => {
        button.classList.toggle('bg-vm-blue', button.dataset.lang === language);
        button.classList.toggle('bg-slate-700', button.dataset.lang !== language);
      });
    }

    function parseSandboxPayload() {
      const raw = $('sandboxPayload').value.trim();
      if (!raw) return {};
      try {
        return JSON.parse(raw);
      } catch (_error) {
        return { raw_input: raw };
      }
    }

    window.addEventListener('message', (event) => {
      const data = event.data || {};

      if (data.action === 'init') {
        post('getDocsCatalog');
        post('getApiStatus', { windowHours: 24 });
        post('getApiChangelog', { limit: 5 });
      }

      if (data.action === 'docsCatalogLoaded') {
        const payload = data.payload || {};
        state.endpoints = payload.endpoints || [];
        state.examples = payload.code_examples || {};
        renderEndpoints($('searchInput').value);
        refreshSandboxSelect();
        setLanguage(state.selectedLanguage);
      }

      if (data.action === 'sandboxResultLoaded') {
        showJson('sandboxResult', data.payload || {});
      }

      if (data.action === 'apiStatusLoaded') {
        showJson('statusPane', data.payload || {});
      }

      if (data.action === 'apiChangelogLoaded') {
        showJson('changelogPane', data.payload || {});
      }

      if (data.action === 'actionError') {
        showJson('sandboxResult', { success: false, error: data.message || 'Unknown error' });
      }
    });

    $('searchInput').addEventListener('input', (event) => renderEndpoints(event.target.value));
    $('refreshCatalog').addEventListener('click', () => post('getDocsCatalog'));
    $('runSandbox').addEventListener('click', () => post('trySandbox', {
      endpointKey: $('sandboxEndpoint').value,
      payload: parseSandboxPayload()
    }));

    document.querySelectorAll('.lang-btn').forEach((button) => {
      button.addEventListener('click', () => setLanguage(button.dataset.lang));
    });
  </script>
</body>
</html>
