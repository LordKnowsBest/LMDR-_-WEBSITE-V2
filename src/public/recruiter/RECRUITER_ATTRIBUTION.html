<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Source Attribution - VelocityMatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            lmdr: { blue: '#2563eb', dark: '#0f172a', yellow: '#fbbf24', canvas: '#f1f5f9' }
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; }
    .thin-scroll::-webkit-scrollbar { width: 6px; }
    .thin-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 4px; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-full overflow-hidden">
    
    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none flex justify-between items-center px-6 z-20">
      <div class="flex items-center gap-4">
        <h1 class="font-bold text-slate-900 text-lg">Source Attribution</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <!-- Date Range Selector -->
        <select id="dateRange" onchange="fetchData()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="365">Last Year</option>
          <option value="all">All Time</option>
        </select>
        
        <!-- Model Toggle -->
        <div class="flex bg-slate-100 rounded-lg p-1">
          <button onclick="setModel('first_touch')" id="btn-first" class="px-3 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-slate-900">First Touch</button>
          <button onclick="setModel('last_touch')" id="btn-last" class="px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-900">Last Touch</button>
        </div>
      </div>
    </header>

    <!-- CONTENT SCROLL AREA -->
    <main class="flex-1 overflow-y-auto thin-scroll p-6 bg-slate-50">
      
      <!-- LOADING STATE -->
      <div id="loading" class="hidden fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      </div>

      <!-- SUMMARY CARDS -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Conversions</div>
          <div class="text-2xl font-black text-slate-900" id="total-conversions">--</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Top Source</div>
          <div class="text-2xl font-black text-blue-600 truncate" id="top-source">--</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Top Medium</div>
          <div class="text-2xl font-black text-purple-600 truncate" id="top-medium">--</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Unattributed</div>
          <div class="text-2xl font-black text-slate-400" id="unattributed-count">--%</div>
        </div>
      </div>

      <!-- CHARTS ROW 1 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Source Bar Chart -->
        <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100 h-80">
          <h3 class="font-bold text-slate-800 mb-4">Conversions by Source</h3>
          <div class="relative h-60 w-full">
            <canvas id="sourceChart"></canvas>
          </div>
        </div>

        <!-- Medium Doughnut Chart -->
        <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100 h-80">
          <h3 class="font-bold text-slate-800 mb-4">Channel Breakdown (Medium)</h3>
          <div class="relative h-60 w-full flex justify-center">
            <canvas id="mediumChart"></canvas>
          </div>
        </div>
      </div>

      <!-- CAMPAIGN TABLE -->
      <div class="bg-white rounded-xl card-shadow border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100">
          <h3 class="font-bold text-slate-800">Campaign Performance</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 font-medium uppercase text-xs">
              <tr>
                <th class="px-6 py-4">Campaign</th>
                <th class="px-6 py-4">Source</th>
                <th class="px-6 py-4">Medium</th>
                <th class="px-6 py-4 text-right">Conversions</th>
                <th class="px-6 py-4 text-right">% of Total</th>
              </tr>
            </thead>
            <tbody id="campaign-table-body" class="divide-y divide-slate-100">
              <!-- Rows rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <script>
    // STATE
    let currentModel = 'first_touch';
    let chartInstances = {};

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      // Connect to Wix
      window.addEventListener('message', handleMessage);
      sendToWix('attributionReady');
      
      // Initial Fetch
      fetchData();
    });

    // FUNCTIONS
    function setModel(model) {
      currentModel = model;
      // Toggle UI
      document.getElementById('btn-first').className = model === 'first_touch' ? 'px-3 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-slate-900' : 'px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-900';
      document.getElementById('btn-last').className = model === 'last_touch' ? 'px-3 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-slate-900' : 'px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-900';
      
      fetchData();
    }

    function fetchData() {
      const days = document.getElementById('dateRange').value;
      const range = getDateRange(days);
      
      showLoading(true);
      
      // Request data from Velo
      sendToWix('getAttributionData', {
        dateRange: range,
        model: currentModel
      });

      // Fallback timeout for dev/mock
      setTimeout(() => {
        if(document.getElementById('loading').classList.contains('hidden')) return;
        // renderDashboard(mockData); // Uncomment to test with mock data if bridge fails
      }, 2000);
    }

    function handleMessage(event) {
      // Security check (same as RecruiterDashboard)
      if (window.parent !== window && event.source !== window.parent) return;

      const msg = event.data;
      if (!msg || !msg.type) return;

      switch (msg.type) {
        case 'attributionData':
          showLoading(false);
          renderDashboard(msg.data);
          break;
      }
    }

    function sendToWix(type, data = {}) {
      if (window.parent) {
        window.parent.postMessage({ type, data }, '*');
      }
    }

    function renderDashboard(data) {
      if (!data) return;

      // 1. Summary Cards
      document.getElementById('total-conversions').textContent = data.total;
      
      const topSrc = Object.entries(data.bySource).sort((a,b) => b[1] - a[1])[0];
      document.getElementById('top-source').textContent = topSrc ? `${topSrc[0]} (${topSrc[1]})` : '--';
      
      const topMed = Object.entries(data.byMedium).sort((a,b) => b[1] - a[1])[0];
      document.getElementById('top-medium').textContent = topMed ? `${topMed[0]} (${topMed[1]})` : '--';

      const unattributed = data.bySource['direct'] || 0 + data.bySource['none'] || 0;
      const unattrPercent = data.total > 0 ? Math.round((unattributed / data.total) * 100) : 0;
      document.getElementById('unattributed-count').textContent = unattrPercent + '%';

      // 2. Charts
      renderSourceChart(data.bySource);
      renderMediumChart(data.byMedium);

      // 3. Campaign Table
      renderCampaignTable(data.byCampaign, data.total);
    }

    function renderSourceChart(sourceData) {
      const ctx = document.getElementById('sourceChart').getContext('2d');
      const labels = Object.keys(sourceData);
      const values = Object.values(sourceData);

      if (chartInstances.source) chartInstances.source.destroy();

      chartInstances.source = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Conversions',
            data: values,
            backgroundColor: '#3b82f6',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function renderMediumChart(mediumData) {
      const ctx = document.getElementById('mediumChart').getContext('2d');
      const labels = Object.keys(mediumData);
      const values = Object.values(mediumData);
      
      if (chartInstances.medium) chartInstances.medium.destroy();

      chartInstances.medium = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } 
          }
        }
      });
    }

    function renderCampaignTable(campaignData, total) {
      const tbody = document.getElementById('campaign-table-body');
      tbody.innerHTML = '';

      // We only have campaign names in the simple breakdown. 
      // In a real app we'd pass array of objects to get source/medium per campaign.
      // For now we just list campaigns.
      
      const sorted = Object.entries(campaignData).sort((a,b) => b[1] - a[1]);

      sorted.forEach(([campaign, count]) => {
        const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 transition';
        tr.innerHTML = `
          <td class="px-6 py-4 font-medium text-slate-900">${campaign}</td>
          <td class="px-6 py-4 text-slate-500">--</td>
          <td class="px-6 py-4 text-slate-500">--</td>
          <td class="px-6 py-4 text-right font-bold text-slate-900">${count}</td>
          <td class="px-6 py-4 text-right text-slate-500">${percent}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function getDateRange(days) {
      if (days === 'all') return { start: new Date(0), end: new Date() };
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - parseInt(days));
      return { start, end };
    }
  </script>
</body>
</html>
