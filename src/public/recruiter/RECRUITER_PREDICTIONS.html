<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predictive Hiring - VelocityMatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            lmdr: { blue: '#2563eb', dark: '#0f172a', yellow: '#fbbf24', canvas: '#f1f5f9' }
          }
        }
      }
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
    }

    .thin-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .thin-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 4px;
    }

    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden pt-safe pb-safe">

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-full overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none flex justify-between items-center px-6 z-20">
      <div class="flex items-center gap-4">
        <h1 class="font-bold text-slate-900 text-lg">Predictive Hiring Forecast</h1>
        <span
          class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-0.5 rounded-full border border-purple-200">BETA</span>
      </div>

      <div class="flex items-center gap-4">
        <button onclick="refreshForecast()" class="text-slate-500 hover:text-blue-600 transition text-sm font-medium">
          <i class="fa-solid fa-rotate-right mr-1"></i> Refresh Model
        </button>
      </div>
    </header>

    <!-- CONTENT SCROLL AREA -->
    <main class="flex-1 overflow-y-auto thin-scroll p-6 bg-slate-50">

      <!-- LOADING STATE -->
      <div id="loading" class="hidden fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      </div>

      <!-- ALERT BANNER -->
      <div id="alert-banner"
        class="hidden mb-6 p-4 bg-amber-50 border-l-4 border-amber-500 rounded-r-xl shadow-sm flex justify-between items-start">
        <div class="flex gap-3">
          <div class="bg-amber-100 p-2 rounded-full text-amber-600">
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <div>
            <h3 class="font-bold text-amber-900" id="alert-title">Hiring Ramp Recommended</h3>
            <p class="text-sm text-amber-800 mt-1" id="alert-message">--</p>
            <div class="mt-3">
              <span class="text-xs font-bold text-amber-700 uppercase tracking-wider">Recommendation:</span>
              <span class="text-sm text-amber-900 font-medium ml-1" id="alert-action">--</span>
            </div>
          </div>
        </div>
        <button onclick="dismissAlert()" class="text-amber-400 hover:text-amber-600"><i
            class="fa-solid fa-times"></i></button>
      </div>

      <!-- FORECAST CHART -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

        <!-- Main Chart -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl card-shadow border border-slate-100 min-h-[400px]">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-slate-800">6-Month Hiring Forecast</h3>
            <div class="flex gap-4 text-xs">
              <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-blue-500 rounded-sm"></div>
                <span class="text-slate-600">Replacement</span>
              </div>
              <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-purple-500 rounded-sm"></div>
                <span class="text-slate-600">Growth</span>
              </div>
            </div>
          </div>
          <div class="relative h-[300px] w-full">
            <canvas id="forecastChart"></canvas>
          </div>
        </div>

        <!-- Risk Factors Panel -->
        <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-slate-400"></i> Turnover Risk
          </h3>

          <div class="text-center py-4 border-b border-slate-100 mb-4">
            <div class="text-4xl font-black text-slate-900" id="risk-count">--</div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Drivers at Risk</div>
            <div class="text-sm text-slate-500 mt-1" id="risk-percent">--% of fleet</div>
          </div>

          <div class="space-y-4" id="risk-factors-list">
            <!-- Rendered by JS -->
          </div>
        </div>
      </div>

      <!-- METRICS & CONFIDENCE -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Model Confidence</div>
          <div class="text-2xl font-black text-emerald-600" id="confidence-score">--%</div>
          <div class="text-xs text-slate-500 mt-1">Based on historical data</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Seasonal Factor</div>
          <div class="text-2xl font-black text-blue-600" id="seasonal-factor">--x</div>
          <div class="text-xs text-slate-500 mt-1">Upcoming multiplier</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Ramp Start Date</div>
          <div class="text-2xl font-black text-purple-600" id="ramp-date">--</div>
          <div class="text-xs text-slate-500 mt-1">Target launch</div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // STATE
    let chartInstance = null;

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      window.addEventListener('message', handleMessage);
      sendToWix('predictionsReady');
      fetchData();
    });

    // FUNCTIONS
    function fetchData() {
      showLoading(true);
      sendToWix('getForecast');

      // Dev Mock
      setTimeout(() => {
        if (document.getElementById('loading').classList.contains('hidden')) return;
        // renderDashboard(mockForecastData); 
      }, 3000);
    }

    function handleMessage(event) {
      if (window.parent !== window && event.source !== window.parent) return;
      const msg = event.data;
      if (!msg || !msg.type) return;

      switch (msg.type) {
        case 'forecastData':
          showLoading(false);
          renderDashboard(msg.data);
          break;
      }
    }

    function sendToWix(type, data = {}) {
      if (window.parent) {
        window.parent.postMessage({ type, data }, '*');
      }
    }

    function renderDashboard(data) {
      if (!data || !data.forecast) return;

      const f = data.forecast;
      const r = data.riskAnalysis;

      // 1. Alert Banner
      if (f.alert_level && f.alert_level !== 'none') {
        document.getElementById('alert-banner').classList.remove('hidden');
        document.getElementById('alert-message').textContent = f.alert_message;
        document.getElementById('alert-action').textContent = f.recommended_action;

        // Color coding
        const banner = document.getElementById('alert-banner');
        if (f.alert_level === 'critical') {
          banner.className = 'mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-xl shadow-sm flex justify-between items-start';
        }
      }

      // 2. Metrics
      document.getElementById('confidence-score').textContent = Math.round(f.confidence_level * 100) + '%';
      document.getElementById('seasonal-factor').textContent = f.seasonal_factor + 'x';
      if (f.ramp_start_date) {
        document.getElementById('ramp-date').textContent = new Date(f.ramp_start_date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      }

      // 3. Risk Panel
      if (r) {
        document.getElementById('risk-count').textContent = r.atRiskCount;
        document.getElementById('risk-percent').textContent = r.riskPercentage + '% of fleet';

        const riskList = document.getElementById('risk-factors-list');
        riskList.innerHTML = '';

        r.topRiskFactors.forEach(factor => {
          const item = document.createElement('div');
          item.className = 'flex justify-between items-center';
          item.innerHTML = `
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 rounded-full ${factor.severity === 'high' ? 'bg-red-500' : 'bg-amber-500'}"></div>
              <span class="text-sm text-slate-700">${factor.factor}</span>
            </div>
            <span class="text-sm font-bold text-slate-900">${factor.count}</span>
          `;
          riskList.appendChild(item);
        });
      }

      // 4. Forecast Chart
      renderChart(f);
    }

    function renderChart(forecast) {
      const ctx = document.getElementById('forecastChart').getContext('2d');

      // Mock monthly distribution based on totals
      const total = forecast.predicted_hires_needed;
      const months = ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul']; // Dynamic in prod

      // Distribute hires (simple average for now)
      const monthlyReplacement = Array(6).fill(Math.round(forecast.replacement_hires / 6));
      const monthlyGrowth = Array(6).fill(Math.round(forecast.growth_hires / 6));

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Replacement',
              data: monthlyReplacement,
              backgroundColor: '#3b82f6',
              borderRadius: 4,
              stack: 'Stack 0'
            },
            {
              label: 'Growth',
              data: monthlyGrowth,
              backgroundColor: '#a855f7',
              borderRadius: 4,
              stack: 'Stack 0'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: '#f1f5f9' }, beginAtZero: true, stacked: true }
          }
        }
      });
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function dismissAlert() {
      document.getElementById('alert-banner').classList.add('hidden');
    }

    function refreshForecast() {
      fetchData();
    }
  </script>
</body>

</html>