<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Campaigns — LMDR Recruiter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { lmdr: { dark: '#0f172a', blue: '#2563eb', yellow: '#fbbf24' } }, fontFamily: { inter: ['Inter', 'sans-serif'] } } } };</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/recruiter/recruiter-design-system.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(30, 41, 59, 0.9));
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #60a5fa;
        }

        .tab-inactive {
            color: #94a3b8;
            border-bottom: 2px solid transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .campaign-row:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 600;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="glass border-b border-slate-700/50 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center">
                <i class="fas fa-envelope text-white text-sm"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white">Email Campaigns</h1>
                <p class="text-xs text-slate-400">Drip sequences &amp; one-time blasts</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button id="newSequenceBtn"
                class="px-4 py-2 rounded-lg border border-slate-600 text-slate-300 text-sm hover:border-blue-500 hover:text-blue-400 transition-all">
                <i class="fas fa-sitemap mr-2"></i>New Sequence
            </button>
            <button id="newCampaignBtn" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium">
                <i class="fas fa-plus mr-2"></i>New Campaign
            </button>
        </div>
    </div>

    <div class="px-6 py-4 grid grid-cols-4 gap-4">
        <div class="stat-card rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">Total Sent</p>
            <p class="text-2xl font-bold text-white" id="statTotalSent">—</p>
        </div>
        <div class="stat-card rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">Avg Open Rate</p>
            <p class="text-2xl font-bold text-white" id="statOpenRate">—</p>
        </div>
        <div class="stat-card rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">Click Rate</p>
            <p class="text-2xl font-bold text-white" id="statClickRate">—</p>
        </div>
        <div class="stat-card rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">Active Sequences</p>
            <p class="text-2xl font-bold text-white" id="statActiveSeq">—</p>
        </div>
    </div>

    <div class="px-6 flex gap-6 border-b border-slate-700/50">
        <button class="tab-active pb-3 text-sm font-medium" data-tab="campaigns"
            onclick="switchTab('campaigns',this)"><i class="fas fa-paper-plane mr-2"></i>Campaigns</button>
        <button class="tab-inactive pb-3 text-sm font-medium" data-tab="sequences"
            onclick="switchTab('sequences',this)"><i class="fas fa-sitemap mr-2"></i>Sequences</button>
    </div>

    <div id="tab-campaigns" class="px-6 py-4 fade-in">
        <div class="glass rounded-xl overflow-hidden">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700/50">
                        <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase">Campaign</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-slate-400 uppercase">Status</th>
                        <th class="text-right px-4 py-3 text-xs font-semibold text-slate-400 uppercase">Sent</th>
                        <th class="text-right px-4 py-3 text-xs font-semibold text-slate-400 uppercase">Open%</th>
                        <th class="text-right px-4 py-3 text-xs font-semibold text-slate-400 uppercase">Click%</th>
                        <th class="px-4 py-3"></th>
                    </tr>
                </thead>
                <tbody id="campaignTableBody">
                    <tr>
                        <td colspan="6" class="text-center py-12 text-slate-500"><i
                                class="fas fa-envelope text-3xl mb-3 block opacity-30"></i>
                            <p class="text-sm">No campaigns yet.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="tab-sequences" class="px-6 py-4 fade-in hidden">
        <div id="sequenceList" class="glass rounded-xl p-8 text-center text-slate-500">
            <i class="fas fa-sitemap text-3xl mb-3 block opacity-30"></i>
            <p class="text-sm">No sequences yet.</p>
        </div>
    </div>

    <!-- Campaign Modal -->
    <div id="campaignModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
        <div class="glass rounded-2xl w-full max-w-xl mx-4 max-h-[90vh] overflow-y-auto fade-in">
            <div class="flex items-center justify-between p-5 border-b border-slate-700/50">
                <h2 class="text-base font-bold text-white"><i class="fas fa-envelope mr-2 text-blue-400"></i>New
                    Campaign</h2>
                <button onclick="closeModal('campaignModal')" class="text-slate-400 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <input id="campName" type="text" placeholder="Campaign Name *"
                    class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                <div class="grid grid-cols-2 gap-3">
                    <input id="campFromEmail" type="email" placeholder="From Email *"
                        class="px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    <input id="campFromName" type="text" placeholder="From Name"
                        class="px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                </div>
                <input id="campSubject" type="text" placeholder="Subject Line *"
                    class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                <textarea id="campContent" rows="5" placeholder="Email HTML content..."
                    class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 font-mono resize-none"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <select id="campCdlClass"
                        class="px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-300 focus:outline-none focus:border-blue-500">
                        <option value="">All CDL Classes</option>
                        <option value="A">CDL-A</option>
                        <option value="B">CDL-B</option>
                    </select>
                    <input id="campState" type="text" placeholder="State filter (e.g. TX)"
                        class="px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                </div>
            </div>
            <div class="flex gap-3 p-5 border-t border-slate-700/50">
                <button onclick="closeModal('campaignModal')"
                    class="flex-1 px-4 py-2 rounded-lg border border-slate-600 text-slate-300 text-sm">Cancel</button>
                <button onclick="saveCampaign('draft')"
                    class="px-4 py-2 rounded-lg border border-blue-600 text-blue-400 text-sm">Save Draft</button>
                <button onclick="saveCampaign('send')"
                    class="btn-primary flex-1 px-4 py-2 rounded-lg text-white text-sm font-medium"><i
                        class="fas fa-paper-plane mr-2"></i>Send</button>
            </div>
        </div>
    </div>

    <!-- Sequence Modal -->
    <div id="sequenceModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
        <div class="glass rounded-2xl w-full max-w-xl mx-4 max-h-[90vh] overflow-y-auto fade-in">
            <div class="flex items-center justify-between p-5 border-b border-slate-700/50">
                <h2 class="text-base font-bold text-white"><i class="fas fa-sitemap mr-2 text-purple-400"></i>New Drip
                    Sequence</h2>
                <button onclick="closeModal('sequenceModal')" class="text-slate-400 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <input id="seqName" type="text" placeholder="Sequence Name *"
                    class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                <select id="seqTrigger"
                    class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-300 focus:outline-none focus:border-blue-500">
                    <option value="manual">Manual enrollment</option>
                    <option value="profile_complete">Driver profile completed</option>
                    <option value="application_submitted">Application submitted</option>
                </select>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-medium text-slate-400">Steps</span>
                    <div class="flex gap-2">
                        <button onclick="addStep('email')"
                            class="px-2 py-1 rounded text-xs bg-blue-600/20 text-blue-400 hover:bg-blue-600/30"><i
                                class="fas fa-envelope mr-1"></i>Email</button>
                        <button onclick="addStep('wait')"
                            class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-300 hover:bg-slate-600"><i
                                class="fas fa-clock mr-1"></i>Wait</button>
                    </div>
                </div>
                <div id="sequenceSteps"
                    class="space-y-2 min-h-[60px] border border-dashed border-slate-700 rounded-lg p-3 text-center text-xs text-slate-500">
                    Add steps above
                </div>
            </div>
            <div class="flex gap-3 p-5 border-t border-slate-700/50">
                <button onclick="closeModal('sequenceModal')"
                    class="flex-1 px-4 py-2 rounded-lg border border-slate-600 text-slate-300 text-sm">Cancel</button>
                <button onclick="saveSequence()"
                    class="btn-primary flex-1 px-4 py-2 rounded-lg text-white text-sm font-medium"><i
                        class="fas fa-save mr-2"></i>Create</button>
            </div>
        </div>
    </div>

    <script>
        let carrierDot = '', campaigns = [], sequences = [], sequenceSteps = [], stepCount = 0;

        window.addEventListener('message', (e) => {
            const { type, data } = e.data || {};
            if (type === 'INIT') { carrierDot = data.carrierDot || ''; loadAll(); }
            if (type === 'CAMPAIGNS_LOADED') renderCampaigns(data.campaigns || []);
            if (type === 'SEQUENCES_LOADED') renderSequences(data.sequences || []);
            if (type === 'CAMPAIGN_CREATED') { closeModal('campaignModal'); loadAll(); showToast('Campaign created!', 'success'); }
            if (type === 'ERROR') showToast(data.message || 'Error', 'error');
        });

        function postToVelo(type, data) { window.parent.postMessage({ type, data }, '*'); }
        function loadAll() { postToVelo('GET_EMAIL_CAMPAIGNS', { carrierDot }); postToVelo('GET_EMAIL_SEQUENCES', { carrierDot }); }

        function switchTab(tab, el) {
            document.querySelectorAll('[data-tab]').forEach(t => { t.classList.remove('tab-active'); t.classList.add('tab-inactive'); });
            el.classList.add('tab-active'); el.classList.remove('tab-inactive');
            document.querySelectorAll('[id^="tab-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
        }

        function renderCampaigns(data) {
            campaigns = data;
            const tbody = document.getElementById('campaignTableBody');
            if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-slate-500"><i class="fas fa-envelope text-3xl mb-3 block opacity-30"></i><p class="text-sm">No campaigns yet.</p></td></tr>'; return; }
            const colors = { draft: 'bg-slate-700 text-slate-300', sent: 'bg-green-500/20 text-green-400', sending: 'bg-blue-500/20 text-blue-400', scheduled: 'bg-yellow-500/20 text-yellow-400' };
            tbody.innerHTML = data.map(c => `<tr class="campaign-row border-b border-slate-700/30 cursor-pointer">
    <td class="px-4 py-3"><p class="text-sm font-medium text-white">${c.campaign_name}</p><p class="text-xs text-slate-400">${c.subject_line || ''}</p></td>
    <td class="px-4 py-3"><span class="status-badge ${colors[c.status] || 'bg-slate-700 text-slate-300'}">${c.status}</span></td>
    <td class="px-4 py-3 text-right text-sm text-slate-300">${(c.sent_count || 0).toLocaleString()}</td>
    <td class="px-4 py-3 text-right text-sm text-green-400">${c.open_rate ? c.open_rate + '%' : '—'}</td>
    <td class="px-4 py-3 text-right text-sm text-blue-400">${c.click_rate ? c.click_rate + '%' : '—'}</td>
    <td class="px-4 py-3 text-right">${c.status === 'draft' ? `<button onclick="postToVelo('SEND_EMAIL_CAMPAIGN_BY_ID',{campaignId:'${c._id}'})" class="px-3 py-1 rounded text-xs bg-blue-600 text-white hover:bg-blue-700">Send</button>` : ''}</td>
  </tr>`).join('');
            document.getElementById('statTotalSent').textContent = data.reduce((s, c) => s + (c.sent_count || 0), 0).toLocaleString();
        }

        function renderSequences(data) {
            sequences = data;
            const list = document.getElementById('sequenceList');
            if (!data.length) { list.innerHTML = '<div class="text-center text-slate-500 py-8"><i class="fas fa-sitemap text-3xl mb-3 block opacity-30"></i><p class="text-sm">No sequences yet.</p></div>'; return; }
            list.innerHTML = '<div class="space-y-3">' + data.map(s => `<div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
    <div><p class="font-semibold text-white">${s.sequence_name}</p><p class="text-xs text-slate-400 mt-1">${(s.steps || []).length} steps · ${s.enrollment_count || 0} enrolled</p></div>
    <span class="status-badge ${s.status === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'}">${s.status}</span>
  </div>`).join('') + '</div>';
            document.getElementById('statActiveSeq').textContent = data.filter(s => s.status === 'active').length;
        }

        document.getElementById('newCampaignBtn').addEventListener('click', () => openModal('campaignModal'));
        document.getElementById('newSequenceBtn').addEventListener('click', () => openModal('sequenceModal'));
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function saveCampaign(action) {
            const data = { carrierDot, campaignName: document.getElementById('campName').value, fromEmail: document.getElementById('campFromEmail').value, fromName: document.getElementById('campFromName').value, subjectLine: document.getElementById('campSubject').value, htmlContent: document.getElementById('campContent').value, audienceFilter: { cdlClass: document.getElementById('campCdlClass').value, state: document.getElementById('campState').value } };
            postToVelo(action === 'send' ? 'SEND_EMAIL_CAMPAIGN' : 'CREATE_EMAIL_CAMPAIGN', data);
        }

        function saveSequence() {
            postToVelo('CREATE_EMAIL_SEQUENCE', { carrierDot, sequenceName: document.getElementById('seqName').value, triggerType: document.getElementById('seqTrigger').value, steps: sequenceSteps });
            closeModal('sequenceModal'); showToast('Sequence created!', 'success');
        }

        function addStep(type) {
            stepCount++;
            const container = document.getElementById('sequenceSteps');
            if (container.classList.contains('text-center') || container.querySelector('.text-center')) { container.innerHTML = ''; container.classList.remove('text-center', 'text-xs', 'text-slate-500'); }
            const step = { type, id: stepCount }; sequenceSteps.push(step);
            const el = document.createElement('div');
            el.className = 'flex items-center gap-3 p-2.5 bg-slate-800 rounded-lg border border-slate-700';
            el.dataset.stepId = stepCount;
            if (type === 'email') { el.innerHTML = `<i class="fas fa-envelope text-blue-400 text-xs w-5"></i><input type="text" placeholder="Subject line..." class="flex-1 bg-transparent text-sm text-white placeholder-slate-500 focus:outline-none" onchange="updateStep(${stepCount},'subjectLine',this.value)"><button onclick="removeStep(${stepCount})" class="text-slate-500 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button>`; }
            else { el.innerHTML = `<i class="fas fa-clock text-slate-400 text-xs w-5"></i><span class="text-sm text-slate-400">Wait</span><input type="number" value="1440" min="60" class="w-16 px-2 py-1 bg-slate-700 border border-slate-600 rounded text-sm text-white text-center focus:outline-none" onchange="updateStep(${stepCount},'delayMinutes',parseInt(this.value))"><span class="text-xs text-slate-400">min</span><button onclick="removeStep(${stepCount})" class="ml-auto text-slate-500 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button>`; }
            container.appendChild(el);
        }

        function updateStep(id, key, value) { const s = sequenceSteps.find(s => s.id === id); if (s) s[key] = value; }
        function removeStep(id) { sequenceSteps = sequenceSteps.filter(s => s.id !== id); document.querySelector(`[data-step-id="${id}"]`)?.remove(); }

        function showToast(msg, type = 'info') {
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            const t = document.createElement('div');
            t.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-4 py-2.5 rounded-lg text-sm font-medium shadow-lg z-50`;
            t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>

</html>