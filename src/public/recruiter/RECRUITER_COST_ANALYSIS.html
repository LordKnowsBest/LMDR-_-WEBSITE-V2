<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cost Per Hire - VelocityMatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            lmdr: { blue: '#2563eb', dark: '#0f172a', yellow: '#fbbf24', canvas: '#f1f5f9' }
          }
        }
      }
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
    }

    .thin-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .thin-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 4px;
    }

    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/recruiter/recruiter-design-system.css">
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden pt-safe pb-safe">

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-full overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none flex justify-between items-center px-6 z-20">
      <div class="flex items-center gap-4">
        <h1 class="font-bold text-slate-900 text-lg">Cost Per Hire Analysis</h1>
      </div>

      <div class="flex items-center gap-4">
        <button onclick="openAddSpendModal()"
          class="bg-lmdr-blue text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-600 transition">
          <i class="fa-solid fa-plus mr-2"></i>Add Spend
        </button>
        <!-- Date Range Selector -->
        <select id="dateRange" onchange="fetchData()"
          class="bg-slate-50 border border-slate-200 text-slate-700 text-base md:text-sm rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="90">Last 90 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="365">Last Year</option>
          <option value="all">All Time</option>
        </select>
      </div>
    </header>

    <!-- CONTENT SCROLL AREA -->
    <main class="flex-1 overflow-y-auto thin-scroll p-6 bg-slate-50">

      <!-- LOADING STATE -->
      <div id="loading" class="hidden fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      </div>

      <!-- SUMMARY CARDS -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Spend</div>
          <div class="text-2xl font-black text-slate-900" id="total-spend">--</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Hires</div>
          <div class="text-2xl font-black text-green-600" id="total-hires">--</div>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow border border-slate-100">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Avg Cost Per Hire</div>
          <div class="text-2xl font-black text-blue-600" id="avg-cph">--</div>
        </div>
      </div>

      <!-- CHARTS ROW -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Spend Breakdown -->
        <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100 h-80">
          <h3 class="font-bold text-slate-800 mb-4">Spend by Channel</h3>
          <div class="relative h-60 w-full flex justify-center">
            <canvas id="spendChart"></canvas>
          </div>
        </div>

        <!-- ROI Chart -->
        <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100 h-80">
          <h3 class="font-bold text-slate-800 mb-4">ROI Score vs. Volume</h3>
          <div class="relative h-60 w-full">
            <canvas id="roiChart"></canvas>
          </div>
        </div>
      </div>

      <!-- TREND CHART -->
      <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100 mb-6 h-96">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-slate-800">Spend vs. Hires Trend</h3>
          <div class="flex gap-4 text-xs">
            <div class="flex items-center gap-1.5">
              <div class="w-3 h-3 bg-blue-500 rounded-sm"></div>
              <span class="text-slate-600">Spend ($)</span>
            </div>
            <div class="flex items-center gap-1.5">
              <div class="w-3 h-3 bg-green-500 rounded-sm"></div>
              <span class="text-slate-600">Hires</span>
            </div>
          </div>
        </div>
        <div class="relative h-72 w-full">
          <canvas id="trendChart"></canvas>
        </div>
      </div>

      <!-- ROI TABLE -->
      <div class="bg-white rounded-xl card-shadow border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100">
          <h3 class="font-bold text-slate-800">Channel ROI Performance</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 font-medium uppercase text-xs">
              <tr>
                <th class="px-6 py-4">Channel</th>
                <th class="px-6 py-4 text-right">Spend</th>
                <th class="px-6 py-4 text-right">Hires</th>
                <th class="px-6 py-4 text-right">CPH</th>
                <th class="px-6 py-4 text-right">ROI Score</th>
              </tr>
            </thead>
            <tbody id="roi-table-body" class="divide-y divide-slate-100">
              <!-- Rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <!-- ADD SPEND MODAL -->
  <div id="addSpendModal"
    class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
        <h3 class="font-bold text-lg text-slate-800">Add Recruiting Spend</h3>
        <button onclick="closeAddSpendModal()" class="text-slate-400 hover:text-slate-600"><i
            class="fa-solid fa-times"></i></button>
      </div>

      <!-- Modal Tabs -->
      <div class="flex border-b border-slate-200">
        <button onclick="switchModalTab('manual')" id="tab-manual"
          class="flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50/50">Manual
          Entry</button>
        <button onclick="switchModalTab('import')" id="tab-import"
          class="flex-1 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-50">Import
          CSV</button>
      </div>

      <div class="p-6 overflow-y-auto flex-1">

        <!-- MANUAL ENTRY FORM -->
        <div id="view-manual" class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Channel</label>
            <select id="spend-channel"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none">
              <option value="indeed">Indeed</option>
              <option value="facebook">Facebook</option>
              <option value="google">Google Ads</option>
              <option value="linkedin">LinkedIn</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Spend Amount ($)</label>
              <input type="number" id="spend-amount"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none"
                placeholder="0.00">
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hires</label>
              <input type="number" id="spend-hires"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none"
                placeholder="0">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Applications (Optional)</label>
              <input type="number" id="spend-apps"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none"
                placeholder="0">
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Campaign Name (Optional)</label>
              <input type="text" id="spend-campaign"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none"
                placeholder="e.g. Spring Hiring">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
              <input type="date" id="spend-start"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label>
              <input type="date" id="spend-end"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-base md:text-sm focus:border-blue-500 focus:outline-none">
            </div>
          </div>
        </div>

        <!-- CSV IMPORT FORM -->
        <div id="view-import" class="hidden space-y-6">
          <div
            class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-400 hover:bg-blue-50/30 transition cursor-pointer"
            onclick="document.getElementById('csv-file').click()">
            <input type="file" id="csv-file" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
            <p class="text-sm font-bold text-slate-700">Click to upload CSV</p>
            <p class="text-xs text-slate-500 mt-1">Required columns: Channel, Spend, Hires, Start Date</p>
          </div>

          <div id="import-preview" class="hidden">
            <div class="flex justify-between items-center mb-2">
              <h4 class="text-xs font-bold text-slate-500 uppercase">Preview (<span id="preview-count">0</span> records)
              </h4>
              <button onclick="clearImport()" class="text-xs text-red-500 hover:underline">Clear</button>
            </div>
            <div class="overflow-x-auto border border-slate-200 rounded-lg max-h-60">
              <table class="w-full text-left text-xs">
                <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0">
                  <tr>
                    <th class="px-3 py-2">Channel</th>
                    <th class="px-3 py-2 text-right">Spend</th>
                    <th class="px-3 py-2 text-right">Hires</th>
                    <th class="px-3 py-2">Date</th>
                  </tr>
                </thead>
                <tbody id="preview-body" class="divide-y divide-slate-100">
                  <!-- JS Rendered -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

      <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
        <button onclick="closeAddSpendModal()"
          class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800">Cancel</button>
        <button onclick="saveSpend()" id="btn-save"
          class="px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md">Save
          Record</button>
      </div>
    </div>
  </div>

  <script>
    // STATE
    let chartInstances = {};
    let parsedImportData = [];
    let activeModalTab = 'manual';

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      window.addEventListener('message', handleMessage);
      sendToWix('costAnalysisReady');

      // Set default dates for modal
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('spend-end').value = today;
      document.getElementById('spend-start').value = today;

      fetchData();
    });

    // FUNCTIONS
    function switchModalTab(tab) {
      activeModalTab = tab;

      // Update Tabs
      document.getElementById('tab-manual').className = tab === 'manual'
        ? 'flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50/50'
        : 'flex-1 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-50';

      document.getElementById('tab-import').className = tab === 'import'
        ? 'flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50/50'
        : 'flex-1 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-50';

      // Update View
      document.getElementById('view-manual').classList.toggle('hidden', tab !== 'manual');
      document.getElementById('view-import').classList.toggle('hidden', tab !== 'import');

      // Update Button Text
      document.getElementById('btn-save').textContent = tab === 'manual' ? 'Save Record' : 'Import Records';
    }

    function handleFileUpload(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        parseCsv(text);
      };
      reader.readAsText(file);
    }

    function parseCsv(text) {
      const lines = text.split('\n');
      parsedImportData = [];

      // Basic CSV parser (assumes headers in first row)
      // Headers expected: Channel, Spend, Hires, Start Date, End Date

      const headers = lines[0].toLowerCase().split(',').map(h => h.trim());

      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        const row = lines[i].split(',').map(c => c.trim());
        const record = {};

        // Map common headers
        const channelIdx = headers.findIndex(h => h.includes('channel'));
        const spendIdx = headers.findIndex(h => h.includes('spend') || h.includes('amount'));
        const hiresIdx = headers.findIndex(h => h.includes('hire'));
        const dateIdx = headers.findIndex(h => h.includes('start') || h.includes('date'));

        if (channelIdx > -1) record.channel = row[channelIdx];
        if (spendIdx > -1) record.spend_amount = parseFloat(row[spendIdx]) * 100; // Convert to cents
        if (hiresIdx > -1) record.hires = parseInt(row[hiresIdx]) || 0;
        if (dateIdx > -1) {
          record.period_start = new Date(row[dateIdx]);
          record.period_end = new Date(row[dateIdx]); // Default to same day if no end date
        } else {
          record.period_start = new Date();
          record.period_end = new Date();
        }

        if (record.spend_amount) {
          parsedImportData.push(record);
        }
      }

      renderImportPreview();
    }

    function renderImportPreview() {
      const tbody = document.getElementById('preview-body');
      tbody.innerHTML = '';

      parsedImportData.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 capitalize">${rec.channel || 'Other'}</td>
          <td class="px-3 py-2 text-right">$${(rec.spend_amount / 100).toFixed(2)}</td>
          <td class="px-3 py-2 text-right">${rec.hires}</td>
          <td class="px-3 py-2">${rec.period_start.toLocaleDateString()}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('preview-count').textContent = parsedImportData.length;
      document.getElementById('import-preview').classList.remove('hidden');
    }

    function clearImport() {
      parsedImportData = [];
      document.getElementById('csv-file').value = '';
      document.getElementById('import-preview').classList.add('hidden');
    }

    function fetchData() {
      const days = document.getElementById('dateRange').value;
      const range = getDateRange(days);

      showLoading(true);
      sendToWix('getCostData', { dateRange: range });
      sendToWix('getSpendTrend', { months: Math.ceil(parseInt(days) / 30) || 6 });
    }

    function saveSpend() {
      if (activeModalTab === 'import') {
        if (parsedImportData.length === 0) {
          alert('No data to import');
          return;
        }

        showLoading(true);
        sendToWix('importSpendCsv', { records: parsedImportData });
        return;
      }

      const channel = document.getElementById('spend-channel').value;
      const amount = document.getElementById('spend-amount').value;
      const hires = document.getElementById('spend-hires').value;
      const apps = document.getElementById('spend-apps').value;
      const campaign = document.getElementById('spend-campaign').value;
      const start = document.getElementById('spend-start').value;
      const end = document.getElementById('spend-end').value;

      if (!amount || !start || !end) {
        alert('Please fill in required fields');
        return;
      }

      showLoading(true);
      sendToWix('saveSpend', {
        channel,
        spend_amount: parseFloat(amount) * 100, // Cents
        hires: parseInt(hires) || 0,
        applications: parseInt(apps) || 0,
        campaign_name: campaign,
        period_start: new Date(start),
        period_end: new Date(end)
      });
    }

    function handleMessage(event) {
      if (window.parent !== window && event.source !== window.parent) return;
      const msg = event.data;
      if (!msg || !msg.type) return;

      switch (msg.type) {
        case 'costData':
          showLoading(false);
          renderDashboard(msg.data);
          break;
        case 'trendData':
          if (msg.data && msg.data.trends) {
            renderTrendChart(msg.data.trends);
          }
          break;
        case 'spendSaved':
        case 'importComplete':
          closeAddSpendModal();
          clearImport();
          fetchData(); // Refresh
          break;
      }
    }

    function getDateRange(days) {
      if (days === 'all') return { start: new Date(0), end: new Date() };
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - parseInt(days));
      return { start, end };
    }
  </script>
</body>

</html>


