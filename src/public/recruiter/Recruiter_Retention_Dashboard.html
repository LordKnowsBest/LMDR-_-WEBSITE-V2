<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retention Prevention Engine | VelocityMatch</title>

    <!-- BRANDING: Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- BRANDING: Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 900: '#0f172a', 800: '#1e293b', 600: '#475569', 500: '#64748b', 100: '#f1f5f9', 50: '#f8fafc' },
                        blue: { 600: '#2563eb', 700: '#1d4ed8' },
                        yellow: { 400: '#fbbf24', 500: '#f59e0b' },
                        red: { 100: '#fee2e2', 600: '#dc2626' },
                        green: { 100: '#dcfce7', 600: '#16a34a' }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .risk-badge-critical {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .risk-badge-high {
            background-color: #ffedd5;
            color: #c2410c;
            border: 1px solid #fed7aa;
        }

        .risk-badge-medium {
            background-color: #fef9c3;
            color: #a16207;
            border: 1px solid #fde047;
        }

        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 700;
        }

        .tab-btn {
            color: #64748b;
            font-weight: 500;
            padding-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #0f172a;
        }

        .hidden-tab {
            display: none;
        }
    </style>
</head>

<body class="text-slate-600">

    <!-- HEADER -->
    <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="h-8 w-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white font-black text-sm">VM</div>
                <div class="flex flex-col">
                    <span class="font-black text-white text-sm tracking-tight leading-none">Velocity<span class="text-blue-400">Match</span></span>
                    <span class="text-[10px] text-blue-200 uppercase font-bold tracking-wider leading-none">Recruiter OS</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-slate-800 px-3 py-1 rounded-full text-xs font-bold text-slate-400">
                    <i class="fa-solid fa-globe mr-1"></i> Industry Avg: 55%
                </div>
                <div
                    class="h-8 w-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xs ring-2 ring-blue-400/30">
                    RC</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- TITLE & ACTIONS -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-3xl font-black text-slate-900">Retention Prevention Engine</h1>
                <p class="text-slate-500 mt-1">Active intervention system to prevent turnover.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="exportWatchlistCSV()"
                    class="bg-white border text-green-600 border-green-100 font-bold px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2">
                    <i class="fa-solid fa-file-csv"></i> Export CSV
                </button>
                <button onclick="refreshData()"
                    class="bg-white border text-blue-600 border-blue-100 font-bold px-4 py-2 rounded-lg hover:bg-blue-50 flex items-center gap-2">
                    <i class="fa-solid fa-rotate"></i> Sync Data
                </button>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex gap-8 border-b border-slate-200 mb-8 overflow-x-auto">
            <button onclick="switchTab('overview')" id="tab-overview"
                class="tab-btn active text-sm uppercase tracking-wide">Overview</button>
            <button onclick="switchTab('watchlist')" id="tab-watchlist"
                class="tab-btn text-sm uppercase tracking-wide">Action Watchlist <span id="badge-count"
                    class="ml-1 bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full text-xs">0</span></button>
            <button onclick="switchTab('analytics')" id="tab-analytics"
                class="tab-btn text-sm uppercase tracking-wide">Survival Trends</button>
        </div>

        <!-- ========================= TAB: OVERVIEW ========================= -->
        <div id="view-overview" class="tab-content">

            <!-- ROI HERO -->
            <div class="bg-slate-900 rounded-2xl p-8 mb-8 text-white relative overflow-hidden shadow-xl">
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-yellow-400 rounded-full blur-3xl opacity-10 -mr-16 -mt-16">
                </div>
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-8">
                    <div>
                        <h2 class="text-yellow-400 font-bold uppercase tracking-wider text-sm mb-2"><i
                                class="fa-solid fa-sack-dollar mr-2"></i> Retention ROI Engine</h2>
                        <div class="flex items-baseline gap-4">
                            <span id="kpi-roi" class="text-5xl md:text-6xl font-black text-white">$0</span>
                            <span class="text-slate-400 font-medium">Churn Cost Avoided</span>
                        </div>
                        <p class="text-slate-400 text-sm mt-4 max-w-lg">
                            Based on preventing <strong class="text-white" id="kpi-saved-drivers">0</strong> departures
                            vs. industry baseline.
                        </p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-slate-400 uppercase">Retention Score</div>
                        <div class="text-4xl font-black text-white mt-1 flex items-center justify-end gap-2">
                            <span id="kpi-retention-score">--</span>
                            <span class="text-green-400 text-lg"><i class="fa-solid fa-arrow-trend-up"></i></span>
                        </div>
                        <div class="text-xs text-slate-500 mt-1">Baseline: 55%</div>
                    </div>
                </div>
            </div>

            <!-- SECONDARY METRICS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Critical Risk -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-l-4 border-slate-100 border-l-red-500">
                    <h3 class="text-xs font-bold uppercase text-red-500 mb-2">Critical Risk</h3>
                    <div class="flex justify-between items-end">
                        <span id="kpi-risk-count" class="text-4xl font-black text-slate-900">--</span>
                        <span class="text-xs font-bold bg-red-100 text-red-600 px-2 py-1 rounded">Action Required</span>
                    </div>
                </div>

                <!-- dNPS Pulse -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-l-4 border-slate-100 border-l-blue-500">
                    <h3 class="text-xs font-bold uppercase text-blue-500 mb-2">dNPS Pulse</h3>
                    <div class="flex justify-between items-end">
                        <span class="text-4xl font-black text-slate-900">+42</span> <!-- Mock -->
                        <span class="text-xs font-bold bg-blue-100 text-blue-600 px-2 py-1 rounded">Good</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 mt-3 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full w-[70%]"></div>
                    </div>
                </div>

                <!-- Pay Stability -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-l-4 border-slate-100 border-l-green-500">
                    <h3 class="text-xs font-bold uppercase text-green-600 mb-2">Fleet Pay Stability</h3>
                    <div class="flex justify-between items-end">
                        <span id="kpi-volatility-status" class="text-3xl font-black text-slate-900">--</span>
                        <i class="fa-solid fa-money-bill-wave text-green-200 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================= TAB: WATCHLIST (ACTION CENTER) ========================= -->
        <div id="view-watchlist" class="tab-content hidden-tab space-y-6">

            <!-- AI PLAYBOOK GEN -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white shadow-lg">
                <div class="flex items-start gap-4">
                    <div
                        class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 backdrop-blur-sm">
                        <i class="fa-solid fa-wand-magic-sparkles text-yellow-300 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg">AI Playbook Generator</h3>
                        <p class="text-blue-100 text-sm mt-1 mb-3">
                            Currently analyzing <strong class="text-white">David Ghost</strong>'s "Silence Signal".
                        </p>
                        <div class="bg-black/20 rounded p-3 text-sm font-mono text-blue-50 border border-white/10">
                            "Recommendation: David's app usage dropped 90% this week. This is a classic 'Silence Signal'
                            preceding resignation. Send the 'Week 2 Check-in' SMS immediately to re-engage."
                        </div>
                        <div class="mt-4 flex gap-3">
                            <button
                                class="bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-bold py-1.5 px-4 rounded text-sm transition-colors">
                                <i class="fa-regular fa-paper-plane mr-1"></i> Send SMS
                            </button>
                            <button
                                class="bg-white/10 hover:bg-white/20 text-white font-bold py-1.5 px-4 rounded text-sm transition-colors">
                                View Script
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLE -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 uppercase tracking-wider font-bold text-xs">
                        <tr>
                            <th class="px-6 py-3">Driver</th>
                            <th class="px-6 py-3">Risk Level</th>
                            <th class="px-6 py-3">Primary Signal</th>
                            <th class="px-6 py-3">Suggested Action</th>
                            <th class="px-6 py-3 text-right">Intervention</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="risk-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========================= TAB: ANALYTICS (SURVIVAL) ========================= -->
        <div id="view-analytics" class="tab-content hidden-tab">
            <div class="grid grid-cols-1 gap-8">
                <!-- SURVIVAL CURVE -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-900 text-lg">Driver Survival Curve (The "90-Day Cliff")</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-400">BENCHMARK:</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div
                                    class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="h-80 w-full">
                        <canvas id="chart-survival"></canvas>
                    </div>
                    <div
                        class="mt-4 p-4 bg-yellow-50 border border-yellow-100 rounded text-xs text-yellow-800 flex gap-2">
                        <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                        <div>
                            <strong>Insight:</strong> Your curve drops sharply at <strong>Day 14</strong>. This
                            indicates an Onboarding/Training gap, not a dispatch issue.
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- FREE TIER OVERLAY -->
    <div id="free-tier-overlay"
        class="fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-lg text-center shadow-2xl border border-white/20">
            <div
                class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                <i class="fa-solid fa-crown"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-900 mb-2">Upgrade to Unlock Retention Engine</h2>
            <p class="text-slate-500 mb-8">
                Identify flight-risk drivers before they leave. Get access to AI-driven risk scores, intervention
                playbooks, and ROI tracking.
            </p>
            <div class="flex flex-col gap-3">
                <a href="/pricing" target="_blank"
                    class="bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg hover:scale-105 transition-all">
                    Upgrade to Pro
                </a>
                <button onclick="history.back()" class="text-slate-400 font-bold text-sm hover:text-slate-600">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        // MOCK DATA (Matches retentionService logic)
        const MOCK_FLEET_DATA = {
            overview: {
                avgRetentionScore: 68, // Improved vs 55% baseline
                highRiskCount: 3,
                activeDrivers: 45,
                roi: {
                    costAvoided: 58500, // (45 * (.68-.55)) * 10000
                    driversSaved: 6
                }
            },
            financialHealth: {
                volatilityStatus: "STABLE"
            },
            atRiskWatchlist: [
                {
                    driverId: 'd1', driverName: 'David Ghost',
                    risk: { level: 'CRITICAL', score: 95, primaryFactor: 'Silence Signal: 50%+ Activity Drop', suggestedActions: ['Trigger Check-in (SMS)'] }
                },
                {
                    driverId: 'd2', driverName: 'Angry Adam',
                    risk: { level: 'CRITICAL', score: 95, primaryFactor: 'Detractor (dNPS 4)', suggestedActions: ['Immediate Manager Call'] }
                },
                {
                    driverId: 'd3', driverName: 'Sarah Volatile',
                    risk: { level: 'HIGH', score: 85, primaryFactor: 'Extreme Pay Volatility (>25%)', suggestedActions: ['Verify Pay / Payroll Audit'] }
                }
            ]
        };

        let chartSurvivalInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderDashboard(MOCK_FLEET_DATA);
            initCharts();
            loadInterventionTemplates();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-tab'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.remove('hidden-tab');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        function renderDashboard(data) {
            // Free Tier Check
            if (data.isFreeTier) {
                document.getElementById('free-tier-overlay').classList.remove('hidden');
                document.getElementById('free-tier-overlay').classList.add('flex');
                document.querySelector('main').classList.add('blur-sm'); // Optional visual effect
                return; // Stop rendering
            }

            // ROI
            document.getElementById('kpi-roi').innerText = '$' + data.overview.roi.costAvoided.toLocaleString();
            document.getElementById('kpi-saved-drivers').innerText = data.overview.roi.driversSaved;

            // Retention Score
            document.getElementById('kpi-retention-score').innerText = data.overview.avgRetentionScore + '%';

            // Metrics
            document.getElementById('kpi-risk-count').innerText = data.overview.highRiskCount;
            document.getElementById('kpi-volatility-status').innerText = data.financialHealth.volatilityStatus;
            document.getElementById('badge-count').innerText = data.overview.highRiskCount;

            // Watchlist
            const tbody = document.getElementById('risk-table-body');
            tbody.innerHTML = '';

            // Store for CSV export
            window.currentWatchlistData = data.atRiskWatchlist;

            data.atRiskWatchlist.forEach(driver => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors group';
                const badgeClass = `risk-badge-${driver.risk.level.toLowerCase()}`;

                // Map risk type for intervention
                const riskTypeMap = {
                    'Silence Signal': 'SILENCE_SIGNAL', 'Detractor': 'DETRACTOR_NPS',
                    'Pay Volatility': 'PAY_VOLATILITY', 'Burnout': 'BURNOUT_RISK',
                    'Safety': 'SAFETY_INCIDENT'
                };
                const detectedRisk = Object.keys(riskTypeMap).find(k => driver.risk.primaryFactor.includes(k));
                const riskTypeValue = detectedRisk ? riskTypeMap[detectedRisk] : 'SILENCE_SIGNAL';

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-900">${driver.driverName}</div>
                        <div class="text-xs text-slate-400">ID: ${driver.driverId}</div>
                    </td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${driver.risk.level}</span></td>
                    <td class="px-6 py-4 text-xs font-medium text-slate-600">${driver.risk.primaryFactor}</td>
                    <td class="px-6 py-4 text-xs text-blue-600 font-bold">
                        <div class="flex gap-2">
                             <button onclick="openQuickIntervention('${driver.driverId}', '${riskTypeValue}')" 
                                class="bg-blue-50 text-blue-700 hover:bg-blue-100 font-bold px-3 py-1.5 rounded text-xs transition-colors">
                                <i class="fa-solid fa-clock mr-1"></i> Schedule 1:1
                            </button>
                            <button onclick="alert('Viewing performance for ${driver.driverName}')" 
                                class="bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold px-3 py-1.5 rounded text-xs transition-colors">
                                <i class="fa-solid fa-chart-line mr-1"></i> View Performance
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="openQuickIntervention('${driver.driverId}', '${riskTypeValue}')" class="text-slate-300 hover:text-blue-600 transition-colors">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportWatchlistCSV() {
            if (!window.currentWatchlistData || window.currentWatchlistData.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const headers = ['Driver Name', 'Driver ID', 'Risk Level', 'Risk Score', 'Primary Factor', 'Suggested Actions'];
            const rows = window.currentWatchlistData.map(d => [
                d.driverName,
                d.driverId,
                d.risk.level,
                d.risk.score,
                d.risk.primaryFactor,
                d.risk.suggestedActions.join('; ')
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `retention_watchlist_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function initCharts() {
            const ctxSurvival = document.getElementById('chart-survival');
            if (ctxSurvival) {
                new Chart(ctxSurvival, {
                    type: 'line',
                    data: {
                        labels: ['Day 0', 'Day 7', 'Day 14', 'Day 30', 'Day 60', 'Day 90', 'Day 180'],
                        datasets: [
                            {
                                label: 'Your Fleet',
                                data: [100, 98, 85, 82, 78, 75, 68],
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Industry Avg',
                                data: [100, 95, 90, 80, 70, 55, 45],
                                borderColor: '#94a3b8',
                                borderDash: [5, 5],
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        }

        function refreshData() {
            // Animation
            const i = document.querySelector('button i.fa-rotate');
            if (i) {
                i.classList.add('fa-spin');
                setTimeout(() => i.classList.remove('fa-spin'), 1000);
            }

            // Request fresh data from Velo Page Code
            window.parent.postMessage({ type: 'refresh' }, '*');
        }

        // ==================== POSTMESSAGE BRIDGE ====================
        function sendMessage(type, payload) {
            window.parent.postMessage({ type, data: payload }, '*');
        }

        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data || !data.type) return;

            switch (data.type) {
                case 'interventionTemplatesLoaded':
                    renderTemplateManagement(data.data);
                    renderInterventionTemplateList(data.data);
                    break;

                case 'interventionSent':
                    if (data.data.success) {
                        showToast('Intervention sent!', 'success');
                        closeQuickIntervention();
                    } else {
                        showToast(data.data.error || 'Failed to send intervention', 'error');
                    }
                    break;

                case 'templateSaved':
                    if (data.data.success) {
                        showToast('Template saved!', 'success');
                        closeTemplateEditor();
                        loadInterventionTemplates();
                    } else {
                        showToast(data.data.error || 'Failed to save template', 'error');
                    }
                    break;

                case 'templateDeleted':
                    if (data.data.success) {
                        showToast('Template deleted', 'success');
                        loadInterventionTemplates();
                    }
                    break;

                case 'interventionOutcomeLogged':
                    if (data.data.success) showToast('Outcome logged', 'success');
                    break;

                case 'driverInterventionsLoaded':
                    // Can be handled for driver detail views
                    break;
            }
        });

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-[100] ${colors[type] || colors.info} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium transition-opacity duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== INTERVENTION FUNCTIONS ====================
        function loadInterventionTemplates() {
            sendMessage('getInterventionTemplates', {});
        }

        function openTemplateEditor(template = null) {
            document.getElementById('templateModalTitle').textContent = template ? 'Edit Template' : 'Create Template';
            document.getElementById('editTemplateId').value = template ? template._id : '';
            document.getElementById('templateName').value = template ? template.template_name : '';
            document.getElementById('templateRiskType').value = template ? template.risk_type : 'SILENCE_SIGNAL';
            document.getElementById('templateChannel').value = template ? template.channel : 'sms';
            document.getElementById('templateSubject').value = template ? template.subject_line : '';
            document.getElementById('templateBody').value = template ? template.body_template : '';
            toggleSubjectLine();
            document.getElementById('templateEditorModal').classList.remove('hidden');
            document.getElementById('templateEditorModal').classList.add('flex');
        }

        function closeTemplateEditor() {
            document.getElementById('templateEditorModal').classList.add('hidden');
            document.getElementById('templateEditorModal').classList.remove('flex');
        }

        function toggleSubjectLine() {
            const channel = document.getElementById('templateChannel').value;
            document.getElementById('subjectLineGroup').style.display = channel === 'email' ? 'block' : 'none';
        }

        function insertVar(varName) {
            const textarea = document.getElementById('templateBody');
            const pos = textarea.selectionStart;
            const text = textarea.value;
            textarea.value = text.substring(0, pos) + '{{' + varName + '}}' + text.substring(pos);
            textarea.focus();
        }

        function submitTemplate() {
            const templateId = document.getElementById('editTemplateId').value;
            const payload = {
                templateName: document.getElementById('templateName').value,
                riskType: document.getElementById('templateRiskType').value,
                channel: document.getElementById('templateChannel').value,
                subjectLine: document.getElementById('templateSubject').value,
                bodyTemplate: document.getElementById('templateBody').value,
                tone: document.querySelector('input[name="templateTone"]:checked')?.value || 'professional'
            };
            if (templateId) payload.templateId = templateId;
            sendMessage('saveTemplate', payload);
        }

        function deleteInterventionTemplate(templateId) {
            if (confirm('Delete this template?')) {
                sendMessage('deleteTemplate', { templateId });
            }
        }

        function renderTemplateManagement(data) {
            const container = document.getElementById('templatesByRiskType');
            if (!data || !container) return;

            const groups = data.templatesByRiskType || {};
            const riskLabels = {
                SILENCE_SIGNAL: 'Silence Signal', DETRACTOR_NPS: 'Detractor NPS',
                PAY_VOLATILITY: 'Pay Volatility', BURNOUT_RISK: 'Burnout Risk',
                SAFETY_INCIDENT: 'Safety Incident'
            };

            container.innerHTML = Object.entries(groups).map(([riskType, templates]) => {
                if (!templates.length) return '';
                return `<div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                    <h4 class="text-sm font-bold text-slate-700 mb-3 uppercase tracking-wide">${riskLabels[riskType] || riskType}</h4>
                    <div class="space-y-2">${templates.map(t => `
                        <div class="flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                            <div class="flex-1 min-w-0">
                                <span class="text-sm font-semibold text-slate-900 block truncate">${t.template_name}</span>
                                <span class="text-xs text-slate-500">${t.channel} | ${t.tone} | Used ${t.usage_count || 0}x | ${t.success_rate || 0}% success</span>
                            </div>
                            <div class="flex gap-2 ml-2">
                                ${!t.is_default ? `<button onclick='openTemplateEditor(${JSON.stringify(t).replace(/'/g, "\\'")})' class="text-xs text-blue-600 hover:text-blue-700 font-bold">Edit</button>
                                <button onclick="deleteInterventionTemplate('${t._id}')" class="text-xs text-red-500 hover:text-red-600 font-bold">Delete</button>` : '<span class="text-xs text-slate-400 font-bold">Default</span>'}
                            </div>
                        </div>
                    `).join('')}</div>
                </div>`;
            }).filter(Boolean).join('');
        }

        function renderInterventionTemplateList(data) {
            const container = document.getElementById('interventionTemplateList');
            if (!data || !container) return;

            const allTemplates = data.allTemplates || [];
            if (!allTemplates.length) {
                container.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">No templates available. Create one first.</p>';
                return;
            }

            container.innerHTML = allTemplates.map(t => `
                <button onclick="sendQuickIntervention('${t._id}')"
                    class="w-full text-left bg-slate-50 hover:bg-blue-50 border border-slate-200 hover:border-blue-200 rounded-lg px-4 py-3 transition-colors group">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-semibold text-slate-900 group-hover:text-blue-700">${t.template_name}</span>
                            <span class="text-xs text-slate-500 block mt-0.5">${t.channel} | ${t.tone}</span>
                        </div>
                        <i class="fa-solid fa-paper-plane text-slate-300 group-hover:text-blue-500 transition-colors"></i>
                    </div>
                </button>
            `).join('');
        }

        function openQuickIntervention(driverId, riskType) {
            document.getElementById('interventionDriverId').value = driverId;
            document.getElementById('quickInterventionModal').classList.remove('hidden');
            document.getElementById('quickInterventionModal').classList.add('flex');
            sendMessage('getInterventionTemplates', { riskType });
        }

        function closeQuickIntervention() {
            document.getElementById('quickInterventionModal').classList.add('hidden');
            document.getElementById('quickInterventionModal').classList.remove('flex');
        }

        function sendQuickIntervention(templateId) {
            const driverId = document.getElementById('interventionDriverId').value;
            sendMessage('sendIntervention', { templateId, driverId, overrides: {} });
        }
    </script>

    <!-- ==================== INTERVENTION TEMPLATES MODAL ==================== -->
    <div id="templateEditorModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div
            class="bg-white border border-slate-200 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
            <h3 class="text-lg font-bold text-slate-900 mb-4" id="templateModalTitle">Create Template</h3>
            <input type="hidden" id="editTemplateId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Template Name</label>
                    <input id="templateName" type="text"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        placeholder="e.g. Burnout Check-in SMS">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Risk Type</label>
                        <select id="templateRiskType"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="SILENCE_SIGNAL">Silence Signal</option>
                            <option value="DETRACTOR_NPS">Detractor NPS</option>
                            <option value="PAY_VOLATILITY">Pay Volatility</option>
                            <option value="BURNOUT_RISK">Burnout Risk</option>
                            <option value="SAFETY_INCIDENT">Safety Incident</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Channel</label>
                        <select id="templateChannel" onchange="toggleSubjectLine()"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="sms">SMS</option>
                            <option value="email">Email</option>
                        </select>
                    </div>
                </div>
                <div id="subjectLineGroup" style="display:none;">
                    <label class="block text-sm font-medium text-slate-600 mb-1">Subject Line</label>
                    <input id="templateSubject" type="text"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Email subject line">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Message Body</label>
                    <div class="flex flex-wrap gap-1 mb-2">
                        <button onclick="insertVar('firstName')"
                            class="px-2 py-1 bg-slate-100 text-xs text-slate-600 rounded hover:bg-blue-50 hover:text-blue-600 border border-slate-200 font-medium">{{firstName}}</button>
                        <button onclick="insertVar('lastName')"
                            class="px-2 py-1 bg-slate-100 text-xs text-slate-600 rounded hover:bg-blue-50 hover:text-blue-600 border border-slate-200 font-medium">{{lastName}}</button>
                        <button onclick="insertVar('carrierName')"
                            class="px-2 py-1 bg-slate-100 text-xs text-slate-600 rounded hover:bg-blue-50 hover:text-blue-600 border border-slate-200 font-medium">{{carrierName}}</button>
                        <button onclick="insertVar('recruiterName')"
                            class="px-2 py-1 bg-slate-100 text-xs text-slate-600 rounded hover:bg-blue-50 hover:text-blue-600 border border-slate-200 font-medium">{{recruiterName}}</button>
                        <button onclick="insertVar('recruiterPhone')"
                            class="px-2 py-1 bg-slate-100 text-xs text-slate-600 rounded hover:bg-blue-50 hover:text-blue-600 border border-slate-200 font-medium">{{recruiterPhone}}</button>
                    </div>
                    <textarea id="templateBody"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-900 text-sm h-32 focus:ring-2 focus:ring-blue-500 outline-none resize-y"
                        placeholder="Type your message..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Tone</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-sm text-slate-600"><input type="radio"
                                name="templateTone" value="empathetic" class="accent-blue-600"> Empathetic</label>
                        <label class="flex items-center gap-2 text-sm text-slate-600"><input type="radio"
                                name="templateTone" value="professional" checked class="accent-blue-600">
                            Professional</label>
                        <label class="flex items-center gap-2 text-sm text-slate-600"><input type="radio"
                                name="templateTone" value="urgent" class="accent-blue-600"> Urgent</label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                <button onclick="closeTemplateEditor()"
                    class="px-4 py-2 text-sm text-slate-500 hover:text-slate-900 font-medium">Cancel</button>
                <button onclick="submitTemplate()"
                    class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm">Save
                    Template</button>
            </div>
        </div>
    </div>

    <!-- ==================== QUICK INTERVENTION MODAL ==================== -->
    <div id="quickInterventionModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="bg-white border border-slate-200 rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl">
            <h3 class="text-lg font-bold text-slate-900 mb-4">Send Intervention</h3>
            <input type="hidden" id="interventionDriverId">
            <div class="space-y-4">
                <div id="interventionTemplateList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                <p class="text-xs text-slate-400">Select a template to send to this driver</p>
            </div>
            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-slate-100">
                <button onclick="closeQuickIntervention()"
                    class="px-4 py-2 text-sm text-slate-500 hover:text-slate-900 font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ==================== TEMPLATE MANAGEMENT SECTION ==================== -->
    <div id="templateManagement" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-slate-900">Intervention Templates</h3>
            <button onclick="openTemplateEditor()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-1">
                <i class="fa-solid fa-plus"></i> New Template
            </button>
        </div>
        <div id="templatesByRiskType" class="space-y-4"></div>
    </div>

</body>

</html>