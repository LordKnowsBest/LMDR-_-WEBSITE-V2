<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recruiting Funnel - VelocityMatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            lmdr: { blue: '#2563eb', dark: '#0f172a', yellow: '#fbbf24', canvas: '#f1f5f9' }
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; }
    .thin-scroll::-webkit-scrollbar { width: 6px; }
    .thin-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 4px; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-full overflow-hidden">
    
    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none flex justify-between items-center px-6 z-20">
      <div class="flex items-center gap-4">
        <h1 class="font-bold text-slate-900 text-lg">Recruiting Funnel</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <!-- Date Range Selector -->
        <select id="dateRange" onchange="fetchData()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="365">Last Year</option>
          <option value="all">All Time</option>
        </select>
      </div>
    </header>

    <!-- CONTENT SCROLL AREA -->
    <main class="flex-1 overflow-y-auto thin-scroll p-6 bg-slate-50">
      
      <!-- LOADING STATE -->
      <div id="loading" class="hidden fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      </div>

      <!-- FUNNEL VISUALIZATION -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <!-- Main Funnel Chart -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl card-shadow border border-slate-100 min-h-[400px]">
          <h3 class="font-bold text-slate-800 mb-4">Pipeline Conversion</h3>
          <div class="relative h-[320px] w-full">
            <canvas id="funnelChart"></canvas>
          </div>
        </div>

        <!-- Bottlenecks Panel -->
        <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100 overflow-y-auto max-h-[400px]">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation text-amber-500"></i> Bottleneck Analysis
          </h3>
          <div id="bottlenecks-list" class="space-y-3">
            <!-- Rendered by JS -->
            <p class="text-sm text-slate-400 italic">Analyzing pipeline data...</p>
          </div>
        </div>
      </div>

      <!-- TIME IN STAGE & METRICS -->
      <div class="bg-white rounded-xl card-shadow border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100">
          <h3 class="font-bold text-slate-800">Stage Performance</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 font-medium uppercase text-xs">
              <tr>
                <th class="px-6 py-4">Stage</th>
                <th class="px-6 py-4 text-right">Candidates</th>
                <th class="px-6 py-4 text-right">Conversion Rate</th>
                <th class="px-6 py-4 text-right">Avg Time in Stage</th>
                <th class="px-6 py-4 text-right">Drop-off</th>
              </tr>
            </thead>
            <tbody id="metrics-table-body" class="divide-y divide-slate-100">
              <!-- Rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <script>
    // STATE
    let chartInstance = null;

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      // Connect to Wix
      window.addEventListener('message', handleMessage);
      sendToWix('funnelReady');
      
      // Initial Fetch
      fetchData();
    });

    // FUNCTIONS
    function fetchData() {
      const days = document.getElementById('dateRange').value;
      const range = getDateRange(days);
      
      showLoading(true);
      
      // Request data from Velo
      sendToWix('getFunnelData', {
        dateRange: range
      });

      // Fallback timeout for dev
      setTimeout(() => {
        if(document.getElementById('loading').classList.contains('hidden')) return;
        // renderDashboard(mockFunnelData); 
      }, 3000);
    }

    function handleMessage(event) {
      if (window.parent !== window && event.source !== window.parent) return;

      const msg = event.data;
      if (!msg || !msg.type) return;

      switch (msg.type) {
        case 'funnelData':
          showLoading(false);
          renderDashboard(msg.data);
          break;
      }
    }

    function sendToWix(type, data = {}) {
      if (window.parent) {
        window.parent.postMessage({ type, data }, '*');
      }
    }

    function renderDashboard(data) {
      if (!data || !data.stages) return;

      // 1. Funnel Chart
      renderFunnelChart(data.stages);

      // 2. Bottlenecks
      renderBottlenecks(data.bottlenecks);

      // 3. Metrics Table
      renderMetricsTable(data.stages, data.conversions);
    }

    function renderFunnelChart(stages) {
      const ctx = document.getElementById('funnelChart').getContext('2d');
      const labels = stages.map(s => formatStageName(s.stage));
      const values = stages.map(s => s.count);
      
      // Calculate drop-off widths for funnel effect visualization
      // Using a horizontal bar chart to simulate funnel
      
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Candidates',
            data: values,
            backgroundColor: values.map((v, i) => i === values.length - 1 ? '#10b981' : '#3b82f6'),
            borderRadius: 4,
            barPercentage: 0.6
          }]
        },
        options: {
          indexAxis: 'y', // Horizontal bars
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#fff',
              anchor: 'end',
              align: 'start',
              offset: -10,
              font: { weight: 'bold' },
              formatter: (value) => value
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { display: false } }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function renderBottlenecks(bottlenecks) {
      const container = document.getElementById('bottlenecks-list');
      container.innerHTML = '';

      if (!bottlenecks || bottlenecks.length === 0) {
        container.innerHTML = `
          <div class="p-4 bg-green-50 border border-green-100 rounded-lg text-green-700 text-sm">
            <i class="fa-solid fa-check-circle mr-2"></i> Healthy pipeline! No major bottlenecks detected.
          </div>`;
        return;
      }

      bottlenecks.forEach(b => {
        const item = document.createElement('div');
        item.className = 'p-4 bg-red-50 border border-red-100 rounded-lg';
        item.innerHTML = `
          <div class="flex justify-between items-start mb-1">
            <span class="font-bold text-red-800 text-sm capitalize">${formatStageName(b.stage)} Drop-off</span>
            <span class="bg-red-200 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">${b.dropRate}</span>
          </div>
          <p class="text-xs text-red-600 mt-1">${b.recommendation}</p>
        `;
        container.appendChild(item);
      });
    }

    function renderMetricsTable(stages, conversions) {
      const tbody = document.getElementById('metrics-table-body');
      tbody.innerHTML = '';

      stages.forEach((stage, index) => {
        // Find conversion rate to next stage
        const conversion = conversions.find(c => c.from === stage.stage);
        const rate = conversion ? conversion.rate + '%' : (stage.stage === 'hired' ? '100%' : '--');
        const dropOff = conversion ? (100 - conversion.rate).toFixed(1) + '%' : '--';
        
        // Mock time for now (would come from API)
        const avgTime = stage.avgTime ? stage.avgTime + 'h' : '--';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 transition';
        tr.innerHTML = `
          <td class="px-6 py-4 font-medium text-slate-900 capitalize flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
            ${formatStageName(stage.stage)}
          </td>
          <td class="px-6 py-4 text-right font-bold text-slate-900">${stage.count}</td>
          <td class="px-6 py-4 text-right text-slate-600">${rate}</td>
          <td class="px-6 py-4 text-right text-slate-500">${avgTime}</td>
          <td class="px-6 py-4 text-right text-red-500 font-medium">${dropOff}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatStageName(slug) {
      return slug.replace(/_/g, ' ');
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function getDateRange(days) {
      if (days === 'all') return { start: new Date(0), end: new Date() };
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - parseInt(days));
      return { start, end };
    }
  </script>
</body>
</html>
