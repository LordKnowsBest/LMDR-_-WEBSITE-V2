<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Recruiter Console - VelocityMatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../theme-styles.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            lmdr: {
              blue: '#2563eb',
              dark: '#0f172a',
              yellow: '#fbbf24',
              canvas: '#f1f5f9'
            }
          }
        }
      }
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    /* ============================================
       SIDEBAR STYLES
       ============================================ */
    .sidebar-transition {
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fade-text {
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    }

    .collapsed .fade-text {
      opacity: 0;
      pointer-events: none;
      display: none;
    }

    .collapsed .sidebar-header {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }

    .collapsed .logo-text {
      display: none;
    }

    .sidebar-link {
      transition: all 0.2s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
    }

    .sidebar-link:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .sidebar-link.active {
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.2) 0%, transparent 100%);
      border-left: 4px solid #2563eb;
      color: white;
      text-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
    }

    .sidebar-link.active i {
      color: #60a5fa;
      filter: drop-shadow(0 0 5px rgba(37, 99, 235, 0.8));
    }

    /* Sidebar Chat Animations */
    .sidebar-chat-panel {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    .chat-open .sidebar-chat-panel {
      max-height: 400px;
      opacity: 1;
      padding-bottom: 1rem;
    }

    .chat-bubble-in {
      border-radius: 1.25rem 1.25rem 1.25rem 0.25rem;
    }

    .chat-bubble-out {
      border-radius: 1.25rem 1.25rem 0.25rem 1.25rem;
    }

    @keyframes subtle-pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(37, 99, 235, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
      }
    }

    .chat-pulse {
      animation: subtle-pulse 2s infinite;
    }

    .thin-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .thin-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* Glassmorphism */
    .glass-panel {
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glass-bubble-in {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Ambient Background Blobs */
    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      z-index: 0;
      opacity: 0.6;
      animation: float-blob 10s infinite ease-in-out;
    }

    .blob-1 {
      top: -10%;
      left: -20%;
      width: 300px;
      height: 300px;
      background: #2563eb;
    }

    .blob-2 {
      bottom: 10%;
      right: -20%;
      width: 250px;
      height: 250px;
      background: #6366f1;
      animation-delay: -5s;
    }

    @keyframes float-blob {

      0%,
      100% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(20px, 40px);
      }
    }

    /* Settings Panel */
    .settings-panel {
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-panel.open {
      transform: translateX(0);
    }

    .settings-backdrop {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .settings-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    /* Slider Track */
    input[type="range"].sidebar-slider {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
    }

    input[type="range"].sidebar-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
      transition: transform 0.15s ease;
    }

    input[type="range"].sidebar-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }

    .donut-segment {
      transition: stroke-dasharray 0.4s ease-out, stroke-dashoffset 0.4s ease-out;
    }

    .shadow-glow {
      box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
    }

    .shadow-glow-active {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
    }

    .kanban-column {
      min-width: 280px;
      max-width: 320px;
    }

    .card-drag:hover {
      transform: translateY(-2px);
      cursor: pointer;
    }

    .tab-btn.active {
      background: #2563eb;
      color: white;
    }

    .modal-overlay {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .status-interested {
      background: #3b82f6;
    }

    .status-applied {
      background: #8b5cf6;
    }

    .status-in_review {
      background: #f59e0b;
    }

    .status-contacted {
      background: #10b981;
    }

    .status-offer {
      background: #06b6d4;
    }

    .status-hired {
      background: #22c55e;
    }

    .carrier-dropdown {
      position: relative;
    }

    .carrier-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 280px;
      z-index: 100;
    }

    .carrier-dropdown.open .carrier-dropdown-menu {
      display: block;
    }

    /* Mobile view toggle */
    .view-toggle-btn {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      transition: all 0.2s;
    }

    .view-toggle-btn.active {
      background: #2563eb;
      color: white;
    }

    .view-toggle-btn:not(.active) {
      background: white;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }

    /* Mobile list view */
    .mobile-list-view {
      display: none;
    }

    @media (max-width: 768px) {
      .kanban-container-wrapper {
        display: none;
      }

      .mobile-list-view {
        display: block;
      }

      .mobile-list-view.hidden {
        display: none;
      }

      .kanban-container-wrapper.show-on-mobile {
        display: block;
        overflow-x: auto;
      }

      .mobile-list-view.hide-on-mobile {
        display: none;
      }
    }

    /* Status badges for list view */
    .status-badge-sm {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 9999px;
      text-transform: uppercase;
    }

    .status-badge-interested {
      background: #dbeafe;
      color: #2563eb;
    }

    .status-badge-applied {
      background: #ede9fe;
      color: #7c3aed;
    }

    .status-badge-in_review {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge-contacted {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge-offer {
      background: #cffafe;
      color: #0891b2;
    }

    .status-badge-hired {
      background: #bbf7d0;
      color: #16a34a;
    }

    /* Dark mode overrides */
    html.dark body {
      background: #0f172a;
    }

    html.dark .bg-white {
      background-color: #1e293b;
    }

    html.dark .bg-slate-100 {
      background-color: #0f172a;
    }

    html.dark .bg-slate-50 {
      background-color: #1e293b;
    }

    html.dark .text-slate-800 {
      color: #e2e8f0;
    }

    html.dark .text-slate-900 {
      color: #f1f5f9;
    }

    html.dark .text-slate-700 {
      color: #cbd5e1;
    }

    html.dark .text-slate-600 {
      color: #94a3b8;
    }

    html.dark .text-slate-500 {
      color: #94a3b8;
    }

    html.dark .text-slate-400 {
      color: #64748b;
    }

    html.dark .border-slate-200 {
      border-color: #334155;
    }

    html.dark .border-slate-100 {
      border-color: #334155;
    }

    html.dark .hover\:bg-slate-50:hover {
      background-color: #334155;
    }

    html.dark .hover\:bg-blue-50:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }

    html.dark .kanban-column {
      background-color: #1e293b;
      border-color: #334155;
    }

    html.dark .modal-overlay {
      background: rgba(0, 0, 0, 0.7);
    }

    html.dark .shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    html.dark .shadow-sm {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
  </style>
  <script src="../js/feature-tracker.js"></script>
</head>

<body class="bg-slate-100 text-slate-800 antialiased min-h-screen">

  <!-- ========================================
       SETTINGS PANEL BACKDROP
       ======================================== -->
  <div id="settingsBackdrop" class="settings-backdrop fixed inset-0 bg-black/50 z-[60]" onclick="closeSettingsPanel()">
  </div>

  <!-- ========================================
       SETTINGS SLIDE-OUT PANEL
       ======================================== -->
  <div id="settingsPanel"
    class="settings-panel fixed top-0 right-0 h-full w-80 bg-slate-900/95 backdrop-blur-xl text-white z-[70] flex flex-col shadow-2xl border-l border-white/10">
    <!-- Settings Header -->
    <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
          <i class="fa-solid fa-sliders text-white text-sm"></i>
        </div>
        <div>
          <h2 class="font-bold text-base">Match Scoring</h2>
          <p class="text-[10px] text-slate-400">Customize weight priorities</p>
        </div>
      </div>
      <button onclick="closeSettingsPanel()"
        class="w-8 h-8 rounded-lg bg-white/5 hover:bg-white/10 flex items-center justify-center transition">
        <i class="fa-solid fa-xmark text-slate-400"></i>
      </button>
    </div>

    <!-- Settings Content -->
    <div class="flex-1 overflow-y-auto thin-scroll p-5 space-y-5">
      <!-- Info Card -->
      <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-3">
        <div class="flex gap-2">
          <i class="fa-solid fa-lightbulb text-blue-400 text-xs mt-0.5"></i>
          <p class="text-[11px] text-blue-200/80 leading-relaxed">Higher weights = higher impact on match scores. Adjust
            based on your hiring priorities.</p>
        </div>
      </div>

      <!-- Donut Chart -->
      <div class="flex justify-center py-2">
        <div class="relative w-32 h-32">
          <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
            <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="10" />
            <circle id="seg-qualifications" class="donut-segment" cx="50" cy="50" r="40" fill="none" stroke="#3b82f6"
              stroke-width="10" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle id="seg-experience" class="donut-segment" cx="50" cy="50" r="40" fill="none" stroke="#8b5cf6"
              stroke-width="10" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle id="seg-location" class="donut-segment" cx="50" cy="50" r="40" fill="none" stroke="#06b6d4"
              stroke-width="10" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle id="seg-availability" class="donut-segment" cx="50" cy="50" r="40" fill="none" stroke="#10b981"
              stroke-width="10" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle id="seg-salaryFit" class="donut-segment" cx="50" cy="50" r="40" fill="none" stroke="#f59e0b"
              stroke-width="10" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle id="seg-engagement" class="donut-segment" cx="50" cy="50" r="40" fill="none" stroke="#ec4899"
              stroke-width="10" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
          </svg>
          <div class="absolute inset-0 flex items-center justify-center flex-col">
            <span class="text-xl font-bold" id="totalPercent">100%</span>
            <span class="text-[9px] text-slate-500 uppercase tracking-wider">Total</span>
          </div>
        </div>
      </div>

      <!-- Weight Sliders -->
      <div class="space-y-4">
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <div class="flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div>
              <span class="text-xs font-medium">Qualifications</span>
            </div>
            <span class="text-xs font-bold text-blue-400" id="val-qualifications">30%</span>
          </div>
          <input type="range" id="slider-qualifications" min="0" max="50" value="30" class="w-full sidebar-slider"
            oninput="updateWeight('qualifications', this.value)">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <div class="flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-purple-500"></div>
              <span class="text-xs font-medium">Experience</span>
            </div>
            <span class="text-xs font-bold text-purple-400" id="val-experience">20%</span>
          </div>
          <input type="range" id="slider-experience" min="0" max="50" value="20" class="w-full sidebar-slider"
            oninput="updateWeight('experience', this.value)">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <div class="flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-cyan-500"></div>
              <span class="text-xs font-medium">Location</span>
            </div>
            <span class="text-xs font-bold text-cyan-400" id="val-location">20%</span>
          </div>
          <input type="range" id="slider-location" min="0" max="50" value="20" class="w-full sidebar-slider"
            oninput="updateWeight('location', this.value)">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <div class="flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
              <span class="text-xs font-medium">Availability</span>
            </div>
            <span class="text-xs font-bold text-emerald-400" id="val-availability">15%</span>
          </div>
          <input type="range" id="slider-availability" min="0" max="50" value="15" class="w-full sidebar-slider"
            oninput="updateWeight('availability', this.value)">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <div class="flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-amber-500"></div>
              <span class="text-xs font-medium">Salary Fit</span>
            </div>
            <span class="text-xs font-bold text-amber-400" id="val-salaryFit">10%</span>
          </div>
          <input type="range" id="slider-salaryFit" min="0" max="50" value="10" class="w-full sidebar-slider"
            oninput="updateWeight('salaryFit', this.value)">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <div class="flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-pink-500"></div>
              <span class="text-xs font-medium">Engagement</span>
            </div>
            <span class="text-xs font-bold text-pink-400" id="val-engagement">5%</span>
          </div>
          <input type="range" id="slider-engagement" min="0" max="50" value="5" class="w-full sidebar-slider"
            oninput="updateWeight('engagement', this.value)">
        </div>
      </div>

      <!-- Quick Presets -->
      <div class="pt-3 border-t border-white/10">
        <p class="text-[10px] text-slate-500 mb-2 uppercase tracking-wider font-medium">Quick Presets</p>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="applyPreset('balanced')"
            class="px-2 py-1.5 text-[10px] font-medium bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition">
            <i class="fa-solid fa-scale-balanced mr-1"></i>Balanced
          </button>
          <button onclick="applyPreset('quality')"
            class="px-2 py-1.5 text-[10px] font-medium bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition">
            <i class="fa-solid fa-award mr-1"></i>Quality First
          </button>
          <button onclick="applyPreset('urgent')"
            class="px-2 py-1.5 text-[10px] font-medium bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition">
            <i class="fa-solid fa-bolt mr-1"></i>Urgent Hire
          </button>
          <button onclick="applyPreset('local')"
            class="px-2 py-1.5 text-[10px] font-medium bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition">
            <i class="fa-solid fa-location-dot mr-1"></i>Local Focus
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Footer -->
    <div class="px-5 py-4 border-t border-white/10 bg-black/20 flex gap-2">
      <button onclick="resetWeights()"
        class="flex-1 px-3 py-2 text-xs font-medium bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition">
        <i class="fa-solid fa-rotate-left mr-1"></i>Reset
      </button>
      <button onclick="saveWeights()" id="saveBtn"
        class="flex-1 px-3 py-2 text-xs font-bold bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-lg transition shadow-lg">
        <i class="fa-solid fa-check mr-1"></i>Save
      </button>
    </div>
  </div>

  <!-- ========================================
       LOADING STATE
       ======================================== -->
  <div id="loading-state" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-lmdr-blue border-t-transparent rounded-full animate-spin mx-auto mb-4">
      </div>
      <p class="text-slate-500 text-sm">Loading dashboard...</p>
    </div>
  </div>

  <!-- ========================================
       ADD CARRIER FLOW (Onboarding / Add More)
       ======================================== -->
  <div id="add-carrier-section"
    class="hidden fixed inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center z-40">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div
          class="w-16 h-16 bg-lmdr-blue rounded-2xl flex items-center justify-center text-white text-2xl font-black mx-auto mb-4">
          VM</div>
        <h1 class="text-2xl font-bold text-slate-900" id="add-carrier-title">Add Your First Carrier</h1>
        <p class="text-slate-500 text-sm mt-2">Enter the carrier's DOT number to add them to your portfolio</p>
      </div>

      <div id="add-carrier-form">
        <label class="block text-sm font-semibold text-slate-700 mb-2">USDOT Number</label>
        <input type="text" id="dot-input" placeholder="e.g., 123456"
          class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-lmdr-blue focus:outline-none text-lg font-mono">

        <div id="carrier-preview" class="hidden mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-lmdr-blue rounded-lg flex items-center justify-center text-white font-bold text-sm"
              id="carrier-initials">--</div>
            <div>
              <div class="font-bold text-slate-900" id="carrier-name-preview">--</div>
              <div class="text-xs text-slate-500" id="carrier-location-preview">--</div>
            </div>
          </div>
        </div>

        <div id="add-carrier-error"
          class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm"></div>

        <button id="validate-btn" onclick="validateDOT()"
          class="w-full mt-6 bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition">
          <i class="fa-solid fa-search mr-2"></i>Find Carrier
        </button>

        <button id="add-btn" onclick="addCarrier()"
          class="hidden w-full mt-3 bg-lmdr-blue text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition shadow-lg shadow-blue-200">
          <i class="fa-solid fa-plus mr-2"></i>Add to Portfolio
        </button>

        <button id="cancel-add-btn" onclick="cancelAddCarrier()"
          class="hidden w-full mt-3 text-slate-500 font-medium py-2 hover:text-slate-700 transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- ========================================
       MAIN DASHBOARD
       ======================================== -->
  <div id="dashboard" class="hidden h-screen flex overflow-hidden">

    <!-- ========================================
         GLOBAL SIDEBAR
         ======================================== -->
    <div class="relative h-full flex flex-col z-40 bg-slate-900 overflow-hidden shadow-2xl transition-all duration-300"
      id="sidebar-container">
      <!-- Background Blobs -->
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>

      <!-- Sidebar Content -->
      <aside id="sidebar"
        class="w-64 text-slate-300 flex flex-col h-full sidebar-transition group relative z-10 bg-slate-900/60 backdrop-blur-xl border-r border-white/5">

        <!-- Collapse Toggle -->
        <button onclick="toggleSidebar()"
          class="absolute -right-3 top-20 bg-lmdr-blue text-white w-6 h-6 rounded-full flex items-center justify-center shadow-lg border border-slate-900 hover:scale-110 transition-transform z-50 opacity-0 group-hover:opacity-100">
          <i class="fa-solid fa-chevron-left text-[10px]" id="toggleIcon"></i>
        </button>

        <!-- Brand Header -->
        <div class="h-16 flex items-center px-6 border-b border-white/10 sidebar-header transition-all">
          <div class="flex items-center gap-3">
            <div
              class="h-8 w-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex-none flex items-center justify-center text-white font-black text-sm shadow-lg shadow-blue-500/30 ring-1 ring-white/20">
              VM</div>
            <div class="logo-text fade-text">
              <h1 class="font-bold text-white text-sm tracking-tight drop-shadow-md">Velocity<span
                  class="text-blue-400">Match</span></h1>
              <p class="text-[10px] text-blue-200/70 uppercase font-bold tracking-wider">Recruiter OS</p>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto thin-scroll py-6 space-y-1">
          <a href="#" class="sidebar-link active flex items-center gap-4 px-6 py-3 text-sm font-bold" title="Dashboard"
            data-page="dashboard">
            <i class="fa-solid fa-table-columns w-5 text-center flex-none"></i>
            <span class="fade-text">Dashboard</span>
          </a>
          <a href="#" class="sidebar-link flex items-center gap-4 px-6 py-3 text-sm font-medium hover:text-white group"
            title="Driver Search" data-page="driver-search">
            <i
              class="fa-solid fa-magnifying-glass w-5 text-center flex-none text-slate-400 group-hover:text-white transition-colors"></i>
            <span class="fade-text group-hover:translate-x-1 transition-transform">Driver Search</span>
          </a>
          <a href="#" class="sidebar-link flex items-center gap-4 px-6 py-3 text-sm font-medium hover:text-white group"
            title="Pipeline" data-page="pipeline">
            <i
              class="fa-solid fa-layer-group w-5 text-center flex-none text-slate-400 group-hover:text-white transition-colors"></i>
            <span class="fade-text group-hover:translate-x-1 transition-transform">Pipeline</span>
          </a>
          <a href="#" class="sidebar-link flex items-center gap-4 px-6 py-3 text-sm font-medium hover:text-white group"
            title="Jobs" data-page="jobs">
            <i
              class="fa-solid fa-briefcase w-5 text-center flex-none text-slate-400 group-hover:text-white transition-colors"></i>
            <span class="fade-text group-hover:translate-x-1 transition-transform">Jobs</span>
          </a>

          <!-- Intelligence Group -->
          <div class="px-6 mt-6 mb-2 text-[10px] font-bold uppercase tracking-widest text-blue-200/50 fade-text">
            Intelligence</div>
          <a href="#" class="sidebar-link flex items-center gap-4 px-6 py-3 text-sm font-medium hover:text-white group"
            title="Ad Studio" data-page="ad-studio">
            <i
              class="fa-solid fa-wand-magic-sparkles w-5 text-center flex-none text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
            <span class="fade-text group-hover:translate-x-1 transition-transform">Ad Studio</span>
          </a>
          <!-- HEADER -->
          <header class="bg-white border-b border-slate-200 h-16 flex-none z-30 flex justify-between items-center px-6">
            <div class="flex items-center gap-4">
              <div
                class="h-9 w-9 bg-lmdr-blue rounded-lg flex items-center justify-center text-white font-black text-sm">
                VM
              </div>

              <!-- Carrier Dropdown -->
              <div class="carrier-dropdown" id="carrier-dropdown">
                <button onclick="toggleCarrierDropdown()"
                  class="flex items-center gap-2 hover:bg-slate-50 px-3 py-2 rounded-lg transition">
                  <div>
                    <h1 class="font-bold text-slate-900 text-lg text-left" id="carrier-name">Loading...</h1>
                    <span class="text-xs text-slate-500" id="carrier-dot">DOT: ---</span>
                  </div>
                  <i class="fa-solid fa-chevron-down text-slate-400 text-xs ml-2"></i>
                </button>

                <!-- Dropdown Menu -->
                <div
                  class="carrier-dropdown-menu bg-white rounded-xl shadow-xl border border-slate-200 mt-2 overflow-hidden">
                  <div class="p-2 border-b border-slate-100">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-3 py-2">Your Carriers</div>
                  </div>
                  <div id="carrier-list" class="max-h-64 overflow-y-auto">
                    <!-- Carriers rendered here -->
                  </div>
                  <div class="p-2 border-t border-slate-100">
                    <button onclick="showAddCarrierModal()"
                      class="w-full flex items-center gap-2 px-3 py-2 text-sm text-lmdr-blue font-medium hover:bg-blue-50 rounded-lg transition">
                      <i class="fa-solid fa-plus"></i>
                      Add Carrier
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-4">
              <!-- Quick Stats -->
              <div class="hidden md:flex items-center gap-6 mr-4">
                <div class="text-center">
                  <div class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Pipeline</div>
                  <div class="font-black text-slate-900 leading-none" id="stat-total">--</div>
                </div>
                <div class="text-center">
                  <div class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Response</div>
                  <div class="font-black text-slate-900 leading-none" id="stat-response">--</div>
                </div>
                <div class="text-center">
                  <div class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Hired</div>
                  <div class="font-black text-green-600 leading-none" id="stat-hired">--</div>
                </div>
              </div>

              <!-- View Toggle (mobile only) -->
              <div class="flex md:hidden gap-1 mr-3" id="view-toggle">
                <button onclick="setMobileView('list')" id="view-list-btn" class="view-toggle-btn active">
                  <i class="fa-solid fa-list"></i>
                </button>
                <button onclick="setMobileView('kanban')" id="view-kanban-btn" class="view-toggle-btn">
                  <i class="fa-solid fa-columns"></i>
                </button>
              </div>

              <!-- Unread Messages Badge -->
              <div class="relative">
                <button onclick="sendToWix('getUnreadCount')"
                  class="w-9 h-9 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-500 hover:border-lmdr-blue transition"
                  title="Unread messages">
                  <i class="fa-solid fa-envelope"></i>
                </button>
                <span id="unread-badge"
                  class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center">
                  0
                </span>
              </div>

              <!-- Theme Toggle -->
              <button id="themeToggle" onclick="toggleTheme()"
                class="w-9 h-9 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-500 hover:border-lmdr-blue transition"
                title="Toggle theme">
                <i class="fa-solid fa-sun"></i>
              </button>

              <!-- Tab Buttons -->
              <div class="flex bg-slate-100 rounded-lg p-1">
                <button onclick="switchTab('pipeline')" id="tab-pipeline"
                  class="tab-btn active px-4 py-1.5 text-xs font-bold rounded-md transition">
                  <i class="fa-solid fa-columns mr-1"></i><span class="hidden sm:inline">Pipeline</span>
                </button>
                <button onclick="switchTab('stats')" id="tab-stats"
                  class="tab-btn px-4 py-1.5 text-xs font-bold rounded-md text-slate-600 hover:bg-white transition">
                  <i class="fa-solid fa-chart-bar mr-1"></i><span class="hidden sm:inline">Stats</span>
                </button>
              </div>
            </div>
          </header>

          <!-- TAB CONTENT -->
          <main class="flex-1 overflow-hidden">

            <!-- ========================================
           PIPELINE TAB (Kanban + Mobile List)
           ======================================== -->
            <section id="pipeline-tab" class="h-full bg-slate-100 p-4 md:p-6 overflow-hidden">

              <!-- Kanban View (desktop default, can toggle on mobile) -->
              <div class="kanban-container-wrapper h-full overflow-x-auto overflow-y-hidden">
                <div id="kanban-container" class="flex h-full gap-4">
                  <!-- Columns will be rendered here by JavaScript -->
                </div>
              </div>

              <!-- Mobile List View (mobile default) -->
              <div id="mobile-list-container" class="mobile-list-view h-full overflow-y-auto pb-20">
                <!-- Status filter pills -->
                <div class="flex gap-2 overflow-x-auto pb-3 mb-4 scrollbar-hide">
                  <button onclick="filterMobileList('all')" id="filter-all"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-lmdr-blue text-white">
                    All
                  </button>
                  <button onclick="filterMobileList('interested')" id="filter-interested"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200">
                    Interested
                  </button>
                  <button onclick="filterMobileList('applied')" id="filter-applied"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200">
                    Applied
                  </button>
                  <button onclick="filterMobileList('in_review')" id="filter-in_review"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200">
                    In Review
                  </button>
                  <button onclick="filterMobileList('contacted')" id="filter-contacted"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200">
                    Contacted
                  </button>
                  <button onclick="filterMobileList('offer')" id="filter-offer"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200">
                    Offer
                  </button>
                  <button onclick="filterMobileList('hired')" id="filter-hired"
                    class="flex-none px-3 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200">
                    Hired
                  </button>
                </div>

                <!-- List of candidates -->
                <div id="mobile-list" class="space-y-3">
                  <!-- Cards rendered by JavaScript -->
                </div>
              </div>

              <!-- Empty State -->
              <div id="empty-pipeline" class="hidden h-full flex items-center justify-center">
                <div class="text-center">
                  <div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-users text-3xl text-slate-400"></i>
                  </div>
                  <h3 class="font-bold text-slate-900 text-lg">No candidates yet</h3>
                  <p class="text-slate-500 text-sm mt-2">When drivers express interest in this carrier, they'll appear
                    here.
                  </p>
                </div>
              </div>
            </section>

            <!-- ========================================
           STATS TAB
           ======================================== -->
            <section id="stats-tab" class="hidden h-full overflow-auto bg-slate-100 p-6">
              <div class="max-w-4xl mx-auto space-y-6">

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Pipeline</div>
                    <div class="text-3xl font-black text-slate-900" id="stats-total">--</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Last 7 Days</div>
                    <div class="text-3xl font-black text-lmdr-blue" id="stats-7days">--</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Avg Response</div>
                    <div class="text-3xl font-black text-slate-900" id="stats-response">--</div>
                    <div class="text-xs text-slate-500" id="stats-badge">--</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Conversion</div>
                    <div class="text-3xl font-black text-green-600" id="stats-conversion">--%</div>
                  </div>
                </div>

                <!-- Stage Breakdown -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-900 mb-4">Pipeline by Stage</h3>
                  <div id="stage-breakdown" class="space-y-3">
                    <!-- Rendered by JavaScript -->
                  </div>
                </div>

              </div>
            </section>

            <!-- ========================================
           SYSTEM HEALTH TAB
           ======================================== -->
            <section id="system-health-tab" class="hidden h-full overflow-auto bg-slate-100 p-6">
              <div class="max-w-4xl mx-auto space-y-6">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                  <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center">
                      <i class="fa-solid fa-heart-pulse text-2xl text-lmdr-blue"></i>
                    </div>
                    <div>
                      <h2 class="text-xl font-bold text-slate-900">System Status</h2>
                      <p class="text-sm text-slate-500">Real-time platform health monitoring</p>
                    </div>
                    <div class="ml-auto flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-lg">
                      <div class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse" id="health-indicator-dot"></div>
                      <span class="text-xs font-bold text-slate-700" id="health-indicator-text">Operational</span>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Database -->
                    <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <i class="fa-solid fa-database text-slate-400"></i>
                        <span class="font-medium text-slate-700">Database</span>
                      </div>
                      <span class="text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700"
                        id="status-database">Checking...</span>
                    </div>
                    <!-- AI Service -->
                    <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <i class="fa-solid fa-robot text-slate-400"></i>
                        <span class="font-medium text-slate-700">AI Matching Engine</span>
                      </div>
                      <span class="text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700"
                        id="status-ai">Checking...</span>
                    </div>
                    <!-- Enrichment -->
                    <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <i class="fa-solid fa-filter text-slate-400"></i>
                        <span class="font-medium text-slate-700">Enrichment Queue</span>
                      </div>
                      <span class="text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700"
                        id="status-enrichment">Checking...</span>
                    </div>
                    <!-- FMCSA -->
                    <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <i class="fa-solid fa-shield-halved text-slate-400"></i>
                        <span class="font-medium text-slate-700">FMCSA Gateway</span>
                      </div>
                      <span class="text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700"
                        id="status-fmcsa">Checking...</span>
                    </div>
                  </div>

                  <div class="mt-6 text-center">
                    <button onclick="requestSystemHealth()"
                      class="text-xs font-bold text-lmdr-blue hover:text-blue-700 flex items-center justify-center gap-2 mx-auto">
                      <i class="fa-solid fa-rotate"></i> Refresh Status
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2" id="health-last-updated">Last checked: Never</p>
                  </div>
                </div>

                <!-- Issues Log (Placeholder) -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 hidden" id="health-issues-panel">
                  <h3 class="font-bold text-slate-900 mb-4">Active Incidents</h3>
                  <ul class="space-y-2" id="health-issues-list"></ul>
                </div>
              </div>
            </section>

          </main>
    </div><!-- End Main Content Area -->
  </div><!-- End Dashboard -->

  <!-- ========================================
       CANDIDATE DETAIL MODAL
       ======================================== -->
  <div id="candidate-modal" class="hidden fixed inset-0 z-50">
    <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-lg bg-white shadow-2xl overflow-y-auto">

      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b border-slate-200 p-4 flex justify-between items-center z-10">
        <h2 class="font-bold text-slate-900">Candidate Details</h2>
        <button onclick="closeModal()" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center">
          <i class="fa-solid fa-xmark text-slate-400"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="p-6">
        <!-- Driver Info -->
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 rounded-full bg-lmdr-blue flex items-center justify-center text-white text-xl font-bold"
            id="modal-initials">--</div>
          <div>
            <h3 class="font-bold text-xl text-slate-900" id="modal-name">--</h3>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-xs px-2 py-0.5 rounded-full font-bold" id="modal-status-badge">--</span>
              <span class="text-xs text-slate-500" id="modal-match-score">-- Match</span>
            </div>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="bg-slate-50 rounded-xl p-4 mb-6">
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Contact</h4>
          <div class="space-y-2">
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-phone text-slate-400 w-4"></i>
              <span class="text-sm" id="modal-phone">--</span>
            </div>
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-envelope text-slate-400 w-4"></i>
              <span class="text-sm" id="modal-email">--</span>
            </div>
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-location-dot text-slate-400 w-4"></i>
              <span class="text-sm" id="modal-location">--</span>
            </div>
          </div>
        </div>

        <!-- Qualifications -->
        <div class="bg-slate-50 rounded-xl p-4 mb-6">
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Qualifications</h4>
          <div class="flex flex-wrap gap-2" id="modal-qualifications">
            <!-- Tags rendered by JS -->
          </div>
        </div>

        <!-- Driver Message -->
        <div id="modal-message-section" class="hidden bg-blue-50 rounded-xl p-4 mb-6">
          <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2">Driver's Message</h4>
          <p class="text-sm text-slate-700 italic" id="modal-message">--</p>
        </div>

        <!-- Status Change -->
        <div class="mb-6">
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Move to Stage</h4>
          <div class="grid grid-cols-3 gap-2" id="modal-status-buttons">
            <!-- Rendered by JS -->
          </div>
        </div>

        <!-- Recruiter Notes -->
        <div class="mb-6">
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Notes</h4>
          <textarea id="modal-notes" rows="3" placeholder="Add notes about this candidate..."
            class="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm focus:border-lmdr-blue focus:outline-none resize-none"></textarea>
          <button onclick="saveNotes()"
            class="mt-2 bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-slate-800">
            Save Notes
          </button>
        </div>

        <!-- Status History -->
        <div>
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">History</h4>
          <div id="modal-history" class="space-y-2 text-sm">
            <!-- Rendered by JS -->
          </div>
        </div>

      </div>
    </div>
    <!-- CHAT MODAL -->
    <div id="chat-modal"
      class="hidden fixed inset-0 z-[60] flex items-center justify-end bg-slate-900/50 backdrop-blur-sm">
      <div class="bg-white h-full w-full max-w-md shadow-2xl flex flex-col animate-slide-in-right">
        <!-- Chat Header -->
        <div class="p-6 border-b border-slate-100 flex items-center justify-between bg-slate-50">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-lmdr-blue text-white rounded-xl flex items-center justify-center font-bold text-lg"
              id="chat-driver-icon">
              D
            </div>
            <div>
              <h3 class="font-black text-slate-900" id="chat-driver-name">Driver Name</h3>
              <div class="flex items-center gap-1.5 text-xs font-bold text-emerald-500 uppercase tracking-wider">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                Driver Active
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <!-- Schedule Button -->
            <button onclick="toggleScheduleMenu()"
              class="px-4 py-2 rounded-xl bg-slate-900 text-white text-xs font-bold hover:bg-slate-800 transition">
              <i class="fa-solid fa-calendar-plus mr-2"></i>Schedule
            </button>
            <button onclick="closeChat()"
              class="w-10 h-10 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-400 transition">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>

          <!-- Schedule Popup Menu -->
          <div id="schedule-menu"
            class="hidden absolute right-6 top-20 w-48 bg-white rounded-xl shadow-2xl border border-slate-100 p-2 z-[70]">
            <button onclick="requestAvailability()"
              class="w-full text-left px-3 py-2.5 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 transition">
              <i class="fa-solid fa-clock-rotate-left mr-2 text-lmdr-blue"></i>Request Times
            </button>
            <button onclick="showProposalModal()"
              class="w-full text-left px-3 py-2.5 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 transition border-t border-slate-50">
              <i class="fa-solid fa-calendar-check mr-2 text-emerald-500"></i>Propose Specific...
            </button>
          </div>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50/50">
          <!-- Messages injected here -->
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-slate-100 bg-white">
          <form id="chat-form" class="flex gap-2">
            <input type="text" id="chat-input" placeholder="Type a message..."
              class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-lmdr-blue transition text-sm font-medium">
            <button type="submit"
              class="bg-lmdr-blue text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-blue-700 transition shadow-lg shadow-blue-200">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
    </div>

    <style>
      @keyframes slide-in-right {
        from {
          transform: translateX(100%);
        }

        to {
          transform: translateX(0);
        }
      }

      .animate-slide-in-right {
        animation: slide-in-right 0.3s ease-out;
      }

      .message-bubble {
        max-width: 85%;
        padding: 1rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
      }

      .message-recruiter {
        align-self: flex-end;
        background-color: #2563eb;
        color: white;
        border-top-right-radius: 0;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.06);
      }

      .message-driver {
        align-self: flex-start;
        background-color: white;
        border: 1px solid #f1f5f9;
        color: #334155;
        border-top-left-radius: 0;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
    </style>

    <!-- ========================================
       JAVASCRIPT
       ======================================== -->
    <script>
      // =========================================================================
      // STATE
      // =========================================================================
      let recruiterProfile = null;
      let carriers = [];
      let currentCarrierDOT = null;
      let currentCarrier = null;
      let pipelineData = { candidates: [], groupedByStatus: {}, totalCount: 0 };
      let statsData = {};
      let selectedCandidate = null;
      let validatedCarrier = null;
      let activeTab = 'pipeline';
      let isAddingFromDashboard = false;

      const STAGE_CONFIG = {
        interested: { label: 'AI Sourced', color: 'blue', icon: 'fa-robot' },
        applied: { label: 'Applied', color: 'purple', icon: 'fa-file-alt' },
        in_review: { label: 'In Review', color: 'yellow', icon: 'fa-eye' },
        contacted: { label: 'Contacted', color: 'emerald', icon: 'fa-phone' },
        offer: { label: 'Offer', color: 'cyan', icon: 'fa-file-signature' },
        hired: { label: 'Hired', color: 'green', icon: 'fa-check-circle' }
      };

      const STAGE_ORDER = ['interested', 'applied', 'in_review', 'contacted', 'offer', 'hired'];

      // =========================================================================
      // SIDEBAR STATE & FUNCTIONS
      // =========================================================================
      const sidebarWeights = {
        qualifications: 30,
        experience: 20,
        location: 20,
        availability: 15,
        salaryFit: 10,
        engagement: 5
      };

      const sidebarPresets = {
        balanced: { qualifications: 30, experience: 20, location: 20, availability: 15, salaryFit: 10, engagement: 5 },
        quality: { qualifications: 40, experience: 30, location: 10, availability: 10, salaryFit: 5, engagement: 5 },
        urgent: { qualifications: 15, experience: 10, location: 20, availability: 40, salaryFit: 10, engagement: 5 },
        local: { qualifications: 20, experience: 15, location: 40, availability: 15, salaryFit: 5, engagement: 5 }
      };

      function toggleComplianceMenu() {
        const submenu = document.getElementById('complianceSubmenu');
        const chevron = document.getElementById('complianceChevron');
        submenu.classList.toggle('hidden');
        if (submenu.classList.contains('hidden')) {
          chevron.style.transform = 'rotate(0deg)';
        } else {
          chevron.style.transform = 'rotate(180deg)';
        }
      }

      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const container = document.getElementById('sidebar-container');
        const icon = document.getElementById('toggleIcon');

        sidebar.classList.toggle('w-64');
        sidebar.classList.toggle('w-20');
        sidebar.classList.toggle('collapsed');

        if (sidebar.classList.contains('collapsed')) {
          icon.classList.remove('fa-chevron-left');
          icon.classList.add('fa-chevron-right');
          document.getElementById('sidebarChatContainer').classList.remove('chat-open');
        } else {
          icon.classList.remove('fa-chevron-right');
          icon.classList.add('fa-chevron-left');
        }
      }

      function toggleSidebarChat() {
        const sidebar = document.getElementById('sidebar');
        const container = document.getElementById('sidebarChatContainer');
        const chevron = document.getElementById('sidebarChatChevron');

        if (sidebar.classList.contains('collapsed')) {
          toggleSidebar();
          setTimeout(() => {
            container.classList.add('chat-open');
            chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
          }, 300);
        } else {
          container.classList.toggle('chat-open');
          if (container.classList.contains('chat-open')) {
            chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
          } else {
            chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
          }
        }
      }

      // Auto-expand sidebar when clicking nav links
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', (e) => {
          const sidebar = document.getElementById('sidebar');
          if (sidebar.classList.contains('collapsed')) {
            toggleSidebar();
          }
          // Handle navigation via postMessage to Wix
          const page = link.getAttribute('data-page');
          if (page) {
            sendToWix('navigateTo', { page: page });
          }
        });
      });

      // Settings Panel Functions
      function openSettingsPanel() {
        document.getElementById('settingsPanel').classList.add('open');
        document.getElementById('settingsBackdrop').classList.add('open');
        sendToWix('getWeightPreferences', {});
      }

      function closeSettingsPanel() {
        document.getElementById('settingsPanel').classList.remove('open');
        document.getElementById('settingsBackdrop').classList.remove('open');
      }

      function updateWeight(key, value) {
        sidebarWeights[key] = parseInt(value);
        const valEl = document.getElementById('val-' + key);
        if (valEl) valEl.textContent = value + '%';
        updateDonutChart();
      }

      function updateDonutChart() {
        const total = Object.values(sidebarWeights).reduce((a, b) => a + b, 0);
        const totalEl = document.getElementById('totalPercent');
        if (totalEl) totalEl.textContent = total + '%';

        const circumference = 2 * Math.PI * 40; // 251.2
        let offset = 0;

        Object.keys(sidebarWeights).forEach(key => {
          const percent = sidebarWeights[key] / 100;
          const dashLength = percent * circumference;
          const segment = document.getElementById('seg-' + key);
          if (segment) {
            segment.style.strokeDasharray = `${dashLength} ${circumference}`;
            segment.style.strokeDashoffset = -offset;
            offset += dashLength;
          }
        });
      }

      function applyPreset(presetName) {
        const preset = sidebarPresets[presetName];
        if (!preset) return;

        Object.keys(preset).forEach(key => {
          sidebarWeights[key] = preset[key];
          const slider = document.getElementById('slider-' + key);
          const valEl = document.getElementById('val-' + key);
          if (slider) slider.value = preset[key];
          if (valEl) valEl.textContent = preset[key] + '%';
        });

        updateDonutChart();
      }

      function resetWeights() {
        applyPreset('balanced');
      }

      function loadWeights(loadedWeights) {
        Object.keys(loadedWeights).forEach(key => {
          if (sidebarWeights.hasOwnProperty(key)) {
            sidebarWeights[key] = loadedWeights[key];
            const slider = document.getElementById('slider-' + key);
            const valEl = document.getElementById('val-' + key);
            if (slider) slider.value = loadedWeights[key];
            if (valEl) valEl.textContent = loadedWeights[key] + '%';
          }
        });
        updateDonutChart();
      }

      function saveWeights() {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>Saving...';
        saveBtn.disabled = true;

        sendToWix('saveWeightPreferences', {
          weight_qualifications: sidebarWeights.qualifications,
          weight_experience: sidebarWeights.experience,
          weight_location: sidebarWeights.location,
          weight_availability: sidebarWeights.availability,
          weight_salaryFit: sidebarWeights.salaryFit,
          weight_engagement: sidebarWeights.engagement
        });
      }

      function handleSaveResult(result) {
        const saveBtn = document.getElementById('saveBtn');

        if (result.success) {
          saveBtn.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Saved!';
          saveBtn.classList.remove('from-blue-600', 'to-purple-600');
          saveBtn.classList.add('from-green-600', 'to-emerald-600');

          setTimeout(() => {
            saveBtn.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Save';
            saveBtn.classList.remove('from-green-600', 'to-emerald-600');
            saveBtn.classList.add('from-blue-600', 'to-purple-600');
            saveBtn.disabled = false;
            closeSettingsPanel();
          }, 1500);
        } else {
          saveBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-1"></i>Error';
          saveBtn.classList.remove('from-blue-600', 'to-purple-600');
          saveBtn.classList.add('from-red-600', 'to-red-600');

          setTimeout(() => {
            saveBtn.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Save';
            saveBtn.classList.remove('from-red-600');
            saveBtn.classList.add('from-blue-600', 'to-purple-600');
            saveBtn.disabled = false;
          }, 2000);
        }
      }

      function updateSidebarUser(profile) {
        if (profile) {
          const name = profile.firstName || profile.name || 'Recruiter';
          const company = profile.company || currentCarrier?.carrier_name || '--';
          const initials = getInitials(name);

          const nameEl = document.getElementById('sidebar-user-name');
          const companyEl = document.getElementById('sidebar-user-company');
          const initialsEl = document.getElementById('sidebar-user-initials');

          if (nameEl) nameEl.textContent = name;
          if (companyEl) companyEl.textContent = company;
          if (initialsEl) initialsEl.textContent = initials;
        }
      }

      // Initialize donut chart on load
      document.addEventListener('DOMContentLoaded', () => {
        updateDonutChart();
      });

      // =========================================================================
      // SMART POLLING (Exponential Backoff)
      // =========================================================================
      const POLL_CONFIG = {
        baseInterval: 2000,      // Start at 2 seconds
        maxInterval: 30000,      // Max 30 seconds
        backoffMultiplier: 1.5,  // Increase 50% each idle poll
        resetOnActivity: true    // Reset to base on new message
      };

      let chatPollTimer = null;
      let chatPollInterval = POLL_CONFIG.baseInterval;
      let lastMessageTimestamp = null;

      function startChatPolling(applicationId) {
        if (chatPollTimer) clearTimeout(chatPollTimer);
        chatPollInterval = POLL_CONFIG.baseInterval;
        scheduleChatPoll(applicationId);
      }

      function scheduleChatPoll(applicationId) {
        chatPollTimer = setTimeout(() => {
          if (!activeApplicationId) return; // Chat closed
          sendToWix('getNewMessages', {
            applicationId,
            sinceTimestamp: lastMessageTimestamp
          });
          // Backoff for chat polling
          chatPollInterval = Math.min(
            chatPollInterval * POLL_CONFIG.backoffMultiplier,
            POLL_CONFIG.maxInterval
          );
          scheduleChatPoll(applicationId);
        }, chatPollInterval);
      }

      function resetChatPollInterval() {
        chatPollInterval = POLL_CONFIG.baseInterval;
        if (chatPollTimer && activeApplicationId) {
          clearTimeout(chatPollTimer);
          scheduleChatPoll(activeApplicationId);
        }
      }

      function stopChatPolling() {
        if (chatPollTimer) {
          clearTimeout(chatPollTimer);
          chatPollTimer = null;
        }
      }

      // =========================================================================
      // MESSAGE VALIDATION SYSTEM
      // =========================================================================
      const DEBUG_MESSAGES = true; // Set to false in production

      // Registry of all valid messages - single source of truth
      const MESSAGE_REGISTRY = {
        // Messages FROM Velo that HTML handles
        inbound: [
          'recruiterReady',
          'carrierValidated',
          'carrierAdded',
          'carrierRemoved',
          'carrierSwitched',
          'carriersLoaded',
          'pipelineLoaded',
          'statusUpdated',
          'statsLoaded',
          'candidateDetails',
          'notesAdded',
          'conversationData',
          'messageSent',
          'newMessagesData',   // Smart polling response
          'unreadCountData',   // Unread badge data
          'getWeightPreferencesResult', // Sidebar weights
          'saveWeightPreferencesResult', // Sidebar save result
          'error',
          'pong', // Health check response
          'systemHealthUpdate' // System Health Update
        ],
        // Messages TO Velo that HTML sends
        outbound: [
          'recruiterDashboardReady',
          'validateCarrier',
          'addCarrier',
          'removeCarrier',
          'switchCarrier',
          'getCarriers',
          'getPipeline',
          'updateCandidateStatus',
          'getStats',
          'getCandidateDetails',
          'addNotes',
          'sendMessage',
          'getConversation',
          'getNewMessages',    // Smart polling request
          'getUnreadCount',    // Unread badge request
          'markAsRead',
          'getWeightPreferences', // Sidebar weights request
          'saveWeightPreferences', // Sidebar save request
          'navigateTo', // Sidebar navigation
          'logFeatureInteraction', // Feature adoption tracking
          'ping', // Health check
          'getSystemHealth' // Request System Health
        ]
      };

      // =========================================================================
      // SECURITY HARDENING UTILITIES
      // =========================================================================

      // Origin validation - verifies message comes from trusted parent frame
      function isValidOrigin(event) {
        // In Wix HTML components, messages from Velo come from parent frame
        // We verify we're in an iframe and the source is our parent
        if (window.parent === window) {
          console.warn(' SECURITY: Not running in iframe context');
          return false;
        }
        if (event.source !== window.parent) {
          console.warn(' SECURITY: Message not from parent frame');
          return false;
        }
        return true;
      }

      // Schema validation - ensures message has required structure
      function validateMessageSchema(msg) {
        if (!msg || typeof msg !== 'object') return false;
        if (typeof msg.type !== 'string' || msg.type.length === 0) return false;
        // data can be undefined, null, or object - all valid
        if (msg.data !== undefined && msg.data !== null && typeof msg.data !== 'object') return false;
        return true;
      }

      // HTML sanitization - strips dangerous content from user-generated strings
      function stripHtml(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // Safe text content setter - use instead of innerHTML for user content
      function safeSetText(element, text) {
        if (element) element.textContent = text;
      }

      function validateInboundMessage(type) {
        if (!MESSAGE_REGISTRY.inbound.includes(type)) {
          console.warn(` UNREGISTERED INBOUND MESSAGE: "${type}" - Add to MESSAGE_REGISTRY.inbound`);
          return false;
        }
        return true;
      }

      function logMessageFlow(direction, type, data) {
        if (!DEBUG_MESSAGES) return;
        const arrow = direction === 'in' ? '' : '';
        const label = direction === 'in' ? 'VeloHTML' : 'HTMLVelo';
        console.log(`${arrow} [${label}] ${type}`, data ? Object.keys(data) : '(no data)');
      }

      // =========================================================================
      // WIX POSTMESSAGE COMMUNICATION (HARDENED)
      // =========================================================================
      function sendToWix(action, data = {}) {
        // Validate outbound message
        if (!MESSAGE_REGISTRY.outbound.includes(action)) {
          console.warn(` UNREGISTERED OUTBOUND MESSAGE: "${action}" - Add to MESSAGE_REGISTRY.outbound`);
        }
        logMessageFlow('out', action, data);

        if (window.parent) {
          window.parent.postMessage({
            type: 'recruiterDashboard',
            action: action,
            data: data
          }, '*');
        }
      }

      // Health check - verify communication with Velo
      let connectionVerified = false;
      function verifyConnection() {
        if (connectionVerified) return;
        sendToWix('ping', { timestamp: Date.now() });
        setTimeout(() => {
          if (!connectionVerified) {
            console.warn(' CONNECTION CHECK: No pong received from Velo within 3s');
          }
        }, 3000);
      }

      window.addEventListener('message', (event) => {
        // SECURITY: Validate origin - must come from parent frame
        if (!isValidOrigin(event)) return;

        const msg = event.data;

        // SECURITY: Validate message schema
        if (!validateMessageSchema(msg)) return;

        // Validate and log inbound message
        validateInboundMessage(msg.type);
        logMessageFlow('in', msg.type, msg.data);

        switch (msg.type) {
          case 'recruiterReady':
            handleRecruiterReady(msg.data);
            break;
          case 'carrierValidated':
            handleCarrierValidated(msg.data);
            break;
          case 'carrierAdded':
            handleCarrierAdded(msg.data);
            break;
          case 'carrierRemoved':
            handleCarrierRemoved(msg.data);
            break;
          case 'carrierSwitched':
            handleCarrierSwitched(msg.data);
            break;
          case 'carriersLoaded':
            handleCarriersLoaded(msg.data);
            break;
          case 'pipelineLoaded':
            handlePipelineLoaded(msg.data);
            break;
          case 'statusUpdated':
            handleStatusUpdated(msg.data);
            break;
          case 'statsLoaded':
            handleStatsLoaded(msg.data);
            break;
          case 'candidateDetails':
            handleCandidateDetails(msg.data);
            break;
          case 'notesAdded':
            showToast('Notes saved');
            break;
          case 'conversationData':
            renderMessages(msg.data.messages);
            break;
          case 'messageSent':
            if (msg.data.success) {
              sendToWix('getConversation', { applicationId: activeApplicationId });
              resetChatPollInterval();
            }
            break;
          case 'newMessagesData':
            if (msg.data.hasNew && msg.data.messages?.length > 0) {
              appendNewMessages(msg.data.messages);
              lastMessageTimestamp = msg.data.latestTimestamp;
              resetChatPollInterval();
            }
            break;
          case 'unreadCountData':
            updateUnreadBadge(msg.data.count || 0, msg.data.byApplication || {});
            break;
          case 'getWeightPreferencesResult':
            if (msg.data && msg.data.preferences) {
              loadWeights(msg.data.preferences);
            }
            break;
          case 'saveWeightPreferencesResult':
            handleSaveResult(msg.data);
            break;
          case 'error':
            showError(msg.data.message || 'An error occurred');
            break;

          case 'pong':
            connectionVerified = true;
            console.log(' CONNECTION VERIFIED: VeloHTML bridge operational', msg.data);
            break;

          // System Health
          case 'systemHealthUpdate':
            updateSystemHealthUI(msg.data);
            break;

          default:
            console.warn(' Unhandled message type:', msg.type);
        }
      });

      // =========================================================================
      // INITIALIZATION
      // =========================================================================
      window.addEventListener('DOMContentLoaded', () => {
        sendToWix('recruiterDashboardReady', {});
        sendToWix('getUnreadCount'); // Fetch initial unread count
        // Trigger connection health check after 500ms
        setTimeout(verifyConnection, 500);

        console.log('VelocityMatch Recruiter Dashboard V2 (Smart Polling) Ready');
        console.log(' Message Registry:', {
          inbound: MESSAGE_REGISTRY.inbound.length,
          outbound: MESSAGE_REGISTRY.outbound.length
        });

        // Setup Sidebar Navigation
        document.querySelectorAll('.sidebar-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = link.getAttribute('data-page');
            if (page) navigateToPage(page);
          });
        });
      });

      function navigateToPage(pageId) {
        // Update active state
        document.querySelectorAll('.sidebar-link').forEach(l => {
          const isActive = l.getAttribute('data-page') === pageId;
          l.classList.toggle('active', isActive);

          // Handle icon color
          const icon = l.querySelector('i');
          if (icon) {
            // Reset classes if needed, or rely on .active CSS if it exists
            // The existing HTML seems to use specific classes for hover, hard to generalize
            // But .active class on link generally handles text color.
          }
        });

        // Handle Page Switching
        if (pageId === 'dashboard') {
          showDashboard();
          document.getElementById('system-health-tab').classList.add('hidden');
        } else if (pageId === 'system-health') {
          // Hide Dashboard Views
          document.getElementById('dashboard').classList.remove('hidden'); // Ensure container is visible
          document.getElementById('pipeline-tab').classList.add('hidden');
          document.getElementById('stats-tab').classList.add('hidden');

          // Show health tab
          document.getElementById('system-health-tab').classList.remove('hidden');


          // Show health tab
          document.getElementById('system-health-tab').classList.remove('hidden');

          requestSystemHealth();

          // Analytics
          sendToWix('logFeatureInteraction', { feature: 'recruiter_system_health_view', type: 'view' });
        } else {
          // Placeholder for other pages
          console.log('Navigate to:', pageId);
        }
      }

      function handleRecruiterReady(data) {
        hideLoading();

        recruiterProfile = data.recruiterProfile;
        carriers = data.carriers || [];
        currentCarrierDOT = data.currentCarrierDOT;

        // Initialize feature tracker
        if (data.memberId && typeof FeatureTracker !== 'undefined' && !FeatureTracker.isInitialized()) {
          FeatureTracker.init({ userId: data.memberId, userRole: 'recruiter' });
          FeatureTracker.view('recruiter_dashboard', { entryPoint: 'page_load', carrierCount: carriers.length });
        }

        // Update sidebar user info
        updateSidebarUser(recruiterProfile);

        if (data.needsSetup || carriers.length === 0) {
          showAddCarrierSection(true);
          return;
        }

        // Find current carrier info
        currentCarrier = carriers.find(c => c.carrier_dot === currentCarrierDOT) || data.defaultCarrier;

        showDashboard();
      }

      // =========================================================================
      // ADD CARRIER FLOW
      // =========================================================================
      function showAddCarrierSection(isOnboarding = false) {
        isAddingFromDashboard = !isOnboarding;

        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('add-carrier-section').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');

        // Update title and show/hide cancel button
        document.getElementById('add-carrier-title').textContent =
          isOnboarding ? 'Add Your First Carrier' : 'Add a Carrier';
        document.getElementById('cancel-add-btn').classList.toggle('hidden', !isAddingFromDashboard);

        // Reset form
        document.getElementById('dot-input').value = '';
        document.getElementById('carrier-preview').classList.add('hidden');
        document.getElementById('add-btn').classList.add('hidden');
        hideAddCarrierError();
        validatedCarrier = null;
      }

      function showAddCarrierModal() {
        closeCarrierDropdown();
        showAddCarrierSection(false);
      }

      function cancelAddCarrier() {
        document.getElementById('add-carrier-section').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
      }

      function validateDOT() {
        const dot = document.getElementById('dot-input').value.trim();
        if (!dot) {
          showAddCarrierError('Please enter a DOT number');
          return;
        }
        if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('recruiter_validate_dot', { dotNumber: dot });

        document.getElementById('validate-btn').innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Searching...';
        document.getElementById('validate-btn').disabled = true;

        sendToWix('validateCarrier', { carrierDOT: dot });
      }

      function handleCarrierValidated(data) {
        document.getElementById('validate-btn').innerHTML = '<i class="fa-solid fa-search mr-2"></i>Find Carrier';
        document.getElementById('validate-btn').disabled = false;

        if (!data.success) {
          showAddCarrierError(data.error || 'Carrier not found');
          document.getElementById('carrier-preview').classList.add('hidden');
          document.getElementById('add-btn').classList.add('hidden');
          return;
        }

        validatedCarrier = data.carrier;
        hideAddCarrierError();

        // Show preview
        const initials = getInitials(data.carrier.legal_name);
        document.getElementById('carrier-initials').textContent = initials;
        document.getElementById('carrier-name-preview').textContent = data.carrier.legal_name;
        document.getElementById('carrier-location-preview').textContent =
          `${data.carrier.phy_city || ''}, ${data.carrier.phy_state || ''} | ${data.carrier.nbr_power_unit || 0} trucks`;

        document.getElementById('carrier-preview').classList.remove('hidden');
        document.getElementById('add-btn').classList.remove('hidden');
      }

      function addCarrier() {
        if (!validatedCarrier) return;

        document.getElementById('add-btn').innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Adding...';
        document.getElementById('add-btn').disabled = true;

        sendToWix('addCarrier', { carrierDOT: validatedCarrier.dot_number });
      }

      function handleCarrierAdded(data) {
        document.getElementById('add-btn').innerHTML = '<i class="fa-solid fa-plus mr-2"></i>Add to Portfolio';
        document.getElementById('add-btn').disabled = false;

        if (!data.success) {
          showAddCarrierError(data.error || 'Failed to add carrier');
          return;
        }

        // Update state
        carriers = data.carriers || carriers;
        currentCarrierDOT = data.currentCarrierDOT;
        currentCarrier = carriers.find(c => c.carrier_dot === currentCarrierDOT);

        showToast('Carrier added to portfolio');
        showDashboard();
      }

      function handleCarrierRemoved(data) {
        if (!data.success) {
          showError(data.error);
          return;
        }

        carriers = data.carriers || [];
        currentCarrierDOT = data.currentCarrierDOT;
        currentCarrier = carriers.find(c => c.carrier_dot === currentCarrierDOT);

        if (carriers.length === 0) {
          showAddCarrierSection(true);
        } else {
          updateCarrierDropdown();
          updateHeaderCarrier();
          sendToWix('getPipeline', {});
        }

        showToast('Carrier removed');
      }

      function showAddCarrierError(message) {
        const el = document.getElementById('add-carrier-error');
        el.textContent = message;
        el.classList.remove('hidden');
      }

      function hideAddCarrierError() {
        document.getElementById('add-carrier-error').classList.add('hidden');
      }

      // =========================================================================
      // CARRIER SWITCHING
      // =========================================================================
      function toggleCarrierDropdown() {
        const dropdown = document.getElementById('carrier-dropdown');
        dropdown.classList.toggle('open');

        // Close on outside click
        if (dropdown.classList.contains('open')) {
          setTimeout(() => {
            document.addEventListener('click', closeDropdownOnOutsideClick);
          }, 0);
        }
      }

      function closeDropdownOnOutsideClick(e) {
        const dropdown = document.getElementById('carrier-dropdown');
        if (!dropdown.contains(e.target)) {
          closeCarrierDropdown();
        }
      }

      function closeCarrierDropdown() {
        document.getElementById('carrier-dropdown').classList.remove('open');
        document.removeEventListener('click', closeDropdownOnOutsideClick);
      }

      function switchCarrier(dot) {
        if (dot === currentCarrierDOT) {
          closeCarrierDropdown();
          return;
        }

        closeCarrierDropdown();
        sendToWix('switchCarrier', { carrierDOT: dot });
      }

      function handleCarrierSwitched(data) {
        if (!data.success) {
          showError(data.error);
          return;
        }

        currentCarrierDOT = data.currentCarrierDOT;
        currentCarrier = data.carrier || carriers.find(c => c.carrier_dot === currentCarrierDOT);

        updateHeaderCarrier();
        // Pipeline will be loaded automatically by page code
      }

      function handleCarriersLoaded(data) {
        if (data.success) {
          carriers = data.carriers || [];
          currentCarrierDOT = data.currentCarrierDOT;
          updateCarrierDropdown();
        }
      }

      function updateCarrierDropdown() {
        const list = document.getElementById('carrier-list');
        list.innerHTML = '';

        carriers.forEach(carrier => {
          const isActive = carrier.carrier_dot === currentCarrierDOT;
          const item = document.createElement('div');
          item.className = `w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-50 transition ${isActive ? 'bg-blue-50' : ''}`;

          const initials = getInitials(carrier.carrier_name);
          item.innerHTML = `
          <button class="flex-1 flex items-center gap-3 text-left" onclick="switchCarrier('${carrier.carrier_dot}')">
            <div class="w-8 h-8 rounded-lg bg-${isActive ? 'lmdr-blue' : 'slate-200'} flex items-center justify-center text-${isActive ? 'white' : 'slate-600'} font-bold text-xs">${initials}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-slate-900 text-sm truncate">${stripHtml(carrier.carrier_name)}</div>
              <div class="text-xs text-slate-500">DOT: ${carrier.carrier_dot}</div>
            </div>
            ${isActive ? '<i class="fa-solid fa-check text-lmdr-blue"></i>' : ''}
          </button>
          <button
            onclick="event.stopPropagation(); removeCarrier('${carrier.carrier_dot}', '${carrier.carrier_name.replace(/'/g, "\\'")}')"
            class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"
            title="Remove carrier"
          >
            <i class="fa-solid fa-trash-can text-xs"></i>
          </button>
        `;

          list.appendChild(item);
        });

        if (carriers.length === 0) {
          list.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">No carriers yet</p>';
        }
      }

      function removeCarrier(carrierDOT, carrierName) {
        if (confirm(`Remove "${carrierName}" from your portfolio?\n\nThis will not delete any candidate data.`)) {
          sendToWix('removeCarrier', { carrierDOT: carrierDOT });
        }
      }

      function updateHeaderCarrier() {
        const name = currentCarrier?.carrier_name || currentCarrier?.legal_name || 'Select Carrier';
        document.getElementById('carrier-name').textContent = name;
        document.getElementById('carrier-dot').textContent = currentCarrierDOT ? `DOT: ${currentCarrierDOT}` : '';
      }

      // =========================================================================
      // DASHBOARD
      // =========================================================================
      function showDashboard() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('add-carrier-section').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        updateHeaderCarrier();
        updateCarrierDropdown();

        // Request pipeline data
        sendToWix('getPipeline', {});
        sendToWix('getStats', {});
      }

      function hideLoading() {
        document.getElementById('loading-state').classList.add('hidden');
      }

      // =========================================================================
      // TABS
      // =========================================================================
      function switchTab(tab) {
        if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('recruiter_switch_tab', { tab: tab });
        activeTab = tab;

        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');

        // Show/hide content
        document.getElementById('pipeline-tab').classList.toggle('hidden', tab !== 'pipeline');
        document.getElementById('stats-tab').classList.toggle('hidden', tab !== 'stats');

        // Show/hide view toggle (only on pipeline tab)
        const viewToggle = document.getElementById('view-toggle');
        if (viewToggle) {
          viewToggle.style.display = tab === 'pipeline' ? 'flex' : 'none';
        }

        if (tab === 'stats') {
          sendToWix('getStats', {});
        }

        // Hide System Health if switching to standard tabs
        document.getElementById('system-health-tab').classList.add('hidden');
      }

      // =========================================================================
      // MOBILE VIEW TOGGLE
      // =========================================================================
      let currentMobileView = 'list'; // 'list' or 'kanban'
      let currentMobileFilter = 'all';

      function setMobileView(view) {
        currentMobileView = view;

        // Update toggle buttons
        document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
        document.getElementById('view-kanban-btn').classList.toggle('active', view === 'kanban');

        // Toggle views
        const kanbanWrapper = document.querySelector('.kanban-container-wrapper');
        const mobileList = document.getElementById('mobile-list-container');

        if (view === 'kanban') {
          kanbanWrapper.classList.add('show-on-mobile');
          mobileList.classList.add('hide-on-mobile');
        } else {
          kanbanWrapper.classList.remove('show-on-mobile');
          mobileList.classList.remove('hide-on-mobile');
        }
      }

      function filterMobileList(status) {
        currentMobileFilter = status;

        // Update filter buttons
        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
          const isActive = btn.id === `filter-${status}`;
          btn.classList.toggle('bg-lmdr-blue', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('bg-white', !isActive);
          btn.classList.toggle('text-slate-600', !isActive);
          btn.classList.toggle('border', !isActive);
          btn.classList.toggle('border-slate-200', !isActive);
        });

        // Re-render list with filter
        if (pipelineData) {
          renderMobileList(pipelineData.groupedByStatus);
        }
      }

      function renderMobileList(groupedByStatus) {
        const container = document.getElementById('mobile-list');
        container.innerHTML = '';

        // Flatten all candidates with their status
        let allCandidates = [];
        STAGE_ORDER.forEach(stage => {
          const candidates = groupedByStatus[stage] || [];
          candidates.forEach(c => allCandidates.push({ ...c, status: stage }));
        });

        // Apply filter
        if (currentMobileFilter !== 'all') {
          allCandidates = allCandidates.filter(c => c.status === currentMobileFilter);
        }

        if (allCandidates.length === 0) {
          container.innerHTML = `
          <div class="text-center py-8 text-slate-400">
            <i class="fa-solid fa-filter-circle-xmark text-2xl mb-2"></i>
            <p class="text-sm">No candidates in this stage</p>
          </div>
        `;
          return;
        }

        // Render cards
        allCandidates.forEach(candidate => {
          const card = createMobileListCard(candidate);
          container.appendChild(card);
        });
      }

      function createMobileListCard(candidate) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl p-4 shadow-sm border border-slate-200 active:scale-[0.98] transition-transform';
        card.onclick = () => openCandidateModal(candidate);

        const initials = getInitials(candidate.driverName);
        const stageConfig = STAGE_CONFIG[candidate.status];
        const scoreColor = candidate.matchScore >= 80 ? 'text-green-600' :
          candidate.matchScore >= 60 ? 'text-blue-600' : 'text-slate-500';

        card.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-lmdr-blue flex items-center justify-center text-white font-bold text-sm flex-none">
            ${stripHtml(initials)}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between gap-2 mb-1">
              <span class="font-bold text-slate-900 truncate">${stripHtml(candidate.driverName)}</span>
              <span class="${scoreColor} text-sm font-black flex-none">${candidate.matchScore}%</span>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <span class="status-badge-sm status-badge-${candidate.status}">${stageConfig?.label || candidate.status}</span>
              ${candidate.cdlClass ? `<span class="text-xs text-slate-500">${stripHtml(candidate.cdlClass)}</span>` : ''}
              ${candidate.yearsExperience ? `<span class="text-xs text-slate-500">${candidate.yearsExperience} yrs</span>` : ''}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="event.stopPropagation(); openChat('${candidate.interestId}', '${candidate.driverName.replace(/'/g, "\\'")}', '${candidate.driverId}')" 
              class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition">
              <i class="fa-solid fa-message text-sm"></i>
            </button>
            <i class="fa-solid fa-chevron-right text-slate-300 flex-none"></i>
          </div>
        </div>
      `;

        return card;
      }

      // =========================================================================
      // PIPELINE / KANBAN
      // =========================================================================
      function handlePipelineLoaded(data) {
        pipelineData = data;

        // Update header stats
        document.getElementById('stat-total').textContent = data.totalCount || 0;
        document.getElementById('stat-hired').textContent =
          (data.groupedByStatus?.hired?.length || 0);

        const kanbanWrapper = document.querySelector('.kanban-container-wrapper');
        const mobileListContainer = document.getElementById('mobile-list-container');
        const emptyState = document.getElementById('empty-pipeline');

        if (data.totalCount === 0 || data.noCarrier) {
          kanbanWrapper.classList.add('hidden');
          mobileListContainer.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }

        kanbanWrapper.classList.remove('hidden');
        mobileListContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Render both views
        renderKanban(data.groupedByStatus);
        renderMobileList(data.groupedByStatus);
      }

      function renderKanban(groupedByStatus) {
        const container = document.getElementById('kanban-container');
        container.innerHTML = '';

        STAGE_ORDER.forEach(stage => {
          const config = STAGE_CONFIG[stage];
          const candidates = groupedByStatus[stage] || [];

          const column = document.createElement('div');
          column.className = 'kanban-column flex flex-col h-full rounded-2xl bg-white/50 border border-slate-200';
          column.innerHTML = `
          <div class="p-4 flex justify-between items-center bg-white rounded-t-2xl border-b border-slate-200 sticky top-0">
            <div class="flex items-center gap-2">
              <div class="status-dot status-${stage}"></div>
              <h3 class="font-bold text-slate-900 text-sm">${config.label}</h3>
              <span class="bg-slate-100 text-slate-500 text-xs font-bold px-2 rounded-full">${candidates.length}</span>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-3 space-y-3 scrollbar-hide" id="column-${stage}">
            ${candidates.length === 0 ? '<p class="text-xs text-slate-400 text-center py-4">No candidates</p>' : ''}
          </div>
        `;

          container.appendChild(column);

          // Render candidate cards
          const columnBody = document.getElementById(`column-${stage}`);
          candidates.forEach(candidate => {
            columnBody.appendChild(createCandidateCard(candidate, stage));
          });
        });
      }

      function createCandidateCard(candidate, stage) {
        const card = document.createElement('div');
        card.className = 'card-drag bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all group relative overflow-hidden';
        card.onclick = () => openCandidateModal(candidate);

        const initials = getInitials(candidate.driverName);
        const scoreColor = candidate.matchScore >= 80 ? 'text-green-600' :
          candidate.matchScore >= 60 ? 'text-blue-600' : 'text-slate-500';

        card.innerHTML = `
        <div class="absolute top-0 left-0 w-1 h-full bg-${STAGE_CONFIG[stage]?.color || 'slate'}-500"></div>
        <div class="flex justify-between items-start mb-2">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-lmdr-blue flex items-center justify-center text-white font-bold text-xs">${initials}</div>
            <span class="font-bold text-slate-900 text-sm">${stripHtml(candidate.driverName)}</span>
          </div>
          <span class="${scoreColor} text-xs font-black">${candidate.matchScore}%</span>
        </div>
        <div class="text-xs text-slate-500 mb-3 flex flex-wrap gap-1">
          ${candidate.cdlClass ? `<span class="bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${candidate.cdlClass}</span>` : ''}
          ${candidate.yearsExperience ? `<span class="bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${candidate.yearsExperience} Yrs</span>` : ''}
          ${candidate.endorsements ? `<span class="bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${candidate.endorsements}</span>` : ''}
        </div>
        <div class="flex gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
          <button class="flex-1 bg-slate-50 text-slate-600 text-xs font-bold py-1.5 rounded hover:bg-slate-100">
            <i class="fa-solid fa-eye mr-1"></i>View
          </button>
          <button onclick="event.stopPropagation(); openChat('${candidate.interestId}', '${candidate.driverName.replace(/'/g, "\\'")}', '${candidate.driverId}')" 
            class="flex-1 bg-blue-50 text-blue-600 text-xs font-bold py-1.5 rounded hover:bg-blue-100">
            <i class="fa-solid fa-message mr-1"></i>Chat
          </button>
        </div>
      `;

        return card;
      }

      // =========================================================================
      // STATS
      // =========================================================================
      function handleStatsLoaded(data) {
        statsData = data.stats || data;

        document.getElementById('stat-response').textContent =
          statsData.avgResponseTime ? `${statsData.avgResponseTime}h` : '--';

        // Stats tab content
        document.getElementById('stats-total').textContent = statsData.totalPipeline || 0;
        document.getElementById('stats-7days').textContent = statsData.last7Days || 0;
        document.getElementById('stats-response').textContent =
          statsData.avgResponseTime ? `${statsData.avgResponseTime}h` : '--';
        document.getElementById('stats-badge').textContent = statsData.responseBadge || '';
        document.getElementById('stats-conversion').textContent = `${statsData.conversionRate || 0}%`;

        renderStageBreakdown(statsData.byStage);
      }

      function renderStageBreakdown(byStage) {
        const container = document.getElementById('stage-breakdown');
        container.innerHTML = '';

        const total = Object.values(byStage || {}).reduce((a, b) => a + b, 0) || 1;

        STAGE_ORDER.forEach(stage => {
          const count = byStage?.[stage] || 0;
          const percent = Math.round((count / total) * 100);
          const config = STAGE_CONFIG[stage];

          container.innerHTML += `
          <div class="flex items-center gap-3">
            <div class="w-24 text-sm font-medium text-slate-600">${config.label}</div>
            <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div class="h-full bg-${config.color}-500 rounded-full" style="width: ${percent}%"></div>
            </div>
            <div class="w-8 text-right text-sm font-bold text-slate-900">${count}</div>
          </div>
        `;
        });
      }

      // =========================================================================
      // CANDIDATE MODAL
      // =========================================================================
      function openCandidateModal(candidate) {
        if (typeof FeatureTracker !== 'undefined') FeatureTracker.view('recruiter_candidate_detail', { candidateName: candidate.driverName, matchScore: candidate.matchScore });
        selectedCandidate = candidate;
        sendToWix('getCandidateDetails', { interestId: candidate.interestId });
      }

      function handleCandidateDetails(data) {
        if (!data.success) {
          showError(data.error);
          return;
        }

        const candidate = selectedCandidate;
        const interest = data.interest || {};
        const driver = data.driverProfile || {};

        // Populate modal
        document.getElementById('modal-initials').textContent = getInitials(candidate.driverName);
        document.getElementById('modal-name').textContent = candidate.driverName;
        document.getElementById('modal-match-score').textContent = `${candidate.matchScore}% Match`;

        // Status badge
        const statusBadge = document.getElementById('modal-status-badge');
        const stageConfig = STAGE_CONFIG[candidate.status] || { label: candidate.status, color: 'slate' };
        statusBadge.textContent = stageConfig.label;
        statusBadge.className = `text-xs px-2 py-0.5 rounded-full font-bold bg-${stageConfig.color}-100 text-${stageConfig.color}-700`;

        // Contact
        document.getElementById('modal-phone').textContent = candidate.driverPhone || candidate.contactPhone || 'Not provided';
        document.getElementById('modal-email').textContent = candidate.driverEmail || candidate.contactEmail || 'Not provided';
        document.getElementById('modal-location').textContent = candidate.homeZip || 'Not provided';

        // Qualifications
        const qualContainer = document.getElementById('modal-qualifications');
        qualContainer.innerHTML = '';
        if (driver.cdl_class) qualContainer.innerHTML += `<span class="bg-slate-100 text-slate-700 text-xs font-medium px-2 py-1 rounded">${driver.cdl_class}</span>`;
        if (driver.years_experience) qualContainer.innerHTML += `<span class="bg-slate-100 text-slate-700 text-xs font-medium px-2 py-1 rounded">${driver.years_experience} Years</span>`;
        if (driver.endorsements) qualContainer.innerHTML += `<span class="bg-slate-100 text-slate-700 text-xs font-medium px-2 py-1 rounded">${driver.endorsements}</span>`;
        if (driver.clean_mvr) qualContainer.innerHTML += `<span class="bg-green-100 text-green-700 text-xs font-medium px-2 py-1 rounded">Clean MVR</span>`;

        // Message
        if (interest.driver_message) {
          document.getElementById('modal-message-section').classList.remove('hidden');
          document.getElementById('modal-message').textContent = interest.driver_message;
        } else {
          document.getElementById('modal-message-section').classList.add('hidden');
        }

        // Notes
        document.getElementById('modal-notes').value = interest.recruiter_notes || '';

        // Status buttons
        renderStatusButtons(candidate.status);

        // History
        renderStatusHistory(interest.status_history || []);

        // Show modal
        document.getElementById('candidate-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Add chat button to modal header if not already there
        const modalHeader = document.querySelector('#candidate-modal h2').parentElement;
        if (!modalHeader.querySelector('.chat-btn')) {
          const chatBtn = document.createElement('button');
          chatBtn.className = 'chat-btn mr-4 bg-lmdr-blue text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-blue-700 transition';
          chatBtn.innerHTML = '<i class="fa-solid fa-message mr-2"></i>Open Chat';
          chatBtn.onclick = () => openChat(candidate.interestId, candidate.driverName, candidate.driverId);
          modalHeader.insertBefore(chatBtn, modalHeader.lastElementChild);
        }
      }

      // ==========================================
      // MESSAGING
      // ==========================================
      let activeApplicationId = null;

      function openChat(applicationId, driverName, driverId) {
        activeApplicationId = applicationId;
        lastMessageTimestamp = null; // Reset for this conversation
        document.getElementById('chat-driver-name').textContent = driverName;
        document.getElementById('chat-driver-icon').textContent = driverName.substring(0, 2).toUpperCase();
        document.getElementById('chat-modal').classList.remove('hidden');
        document.getElementById('chat-messages').innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-slate-300"></i></div>';

        // Initial fetch
        sendToWix('getConversation', { applicationId });
        sendToWix('markAsRead', { applicationId });

        // Start smart polling for new messages
        startChatPolling(applicationId);
      }

      function closeChat() {
        document.getElementById('chat-modal').classList.add('hidden');
        document.getElementById('schedule-menu').classList.add('hidden');
        stopChatPolling();
        activeApplicationId = null;
        // Refresh unread count after closing chat
        sendToWix('getUnreadCount');
      }

      // Append new messages without re-rendering entire conversation
      function appendNewMessages(messages) {
        const container = document.getElementById('chat-messages');
        if (!container || !messages || messages.length === 0) return;

        messages.forEach(msg => {
          const isRecruiter = msg.sender_type === 'recruiter';
          const div = document.createElement('div');
          div.className = `flex flex-col ${isRecruiter ? 'items-end' : 'items-start'}`;
          div.innerHTML = `
            <div class="message-bubble ${isRecruiter ? 'message-recruiter' : 'message-driver'}">
              ${stripHtml(msg.content)}
            </div>
            <div class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wider mx-2">
              ${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
          `;
          container.appendChild(div);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      }

      // Update unread badge in header
      function updateUnreadBadge(count, byApplication) {
        const badge = document.getElementById('unread-badge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
        // Store for card-level badges
        window.unreadByApplication = byApplication;
      }

      function toggleScheduleMenu() {
        document.getElementById('schedule-menu').classList.toggle('hidden');
      }

      function requestAvailability() {
        document.getElementById('schedule-menu').classList.add('hidden');
        sendToWix('requestAvailability', { applicationId: activeApplicationId });
      }

      function confirmSlot(index) {
        if (!confirm('Confirm this interview slot?')) return;
        sendToWix('confirmTimeSlot', { applicationId: activeApplicationId, slotIndex: index });
      }

      function showProposalModal() {
        alert('Propose Specific Times is coming in the next build. For now, please use "Request Times".');
        document.getElementById('schedule-menu').classList.add('hidden');
      }

      document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const content = input.value.trim();
        if (!content || !activeApplicationId) return;

        // The driverId was passed to openChat and should be used as receiverId
        // Find candidate in pipelineData to get driverId if not passed (though we pass it)
        let driverId = null;
        for (const stage in pipelineData.groupedByStatus) {
          const cand = pipelineData.groupedByStatus[stage].find(c => c.interestId === activeApplicationId);
          if (cand) {
            driverId = cand.driverId;
            break;
          }
        }

        sendToWix('sendMessage', {
          applicationId: activeApplicationId,
          content: content,
          receiverId: driverId || 'driver-default'
        });

        input.value = '';
      };

      function renderMessages(messages) {
        const container = document.getElementById('chat-messages');
        if (!messages || messages.length === 0) {
          container.innerHTML = `
                <div class="text-center py-10 text-slate-400 text-sm">
                    <i class="fa-solid fa-comments mb-2 block text-3xl opacity-20"></i>
                    No messages yet. Start the conversation!
                </div>
            `;
          return;
        }

        container.innerHTML = messages.map(msg => {
          const isRecruiter = msg.sender_type === 'recruiter';
          const isSystem = msg.sender_type === 'system';

          if (isSystem) {
            let metadata = {};
            try { metadata = JSON.parse(msg.metadata || '{}'); } catch (e) { }
            const isAction = metadata.subType === 'ACTION_REQUIRED';

            return `
                    <div class="flex flex-col items-center w-full my-4">
                        <div class="bg-white border-2 ${isAction ? 'border-lmdr-blue shadow-blue-50' : 'border-slate-100'} rounded-2xl p-5 w-full max-w-[90%] shadow-sm text-center">
                            <div class="w-10 h-10 ${isAction ? 'bg-blue-50 text-lmdr-blue' : 'bg-slate-50 text-slate-400'} rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fa-solid ${isAction ? 'fa-calendar-day' : 'fa-info-circle'}"></i>
                            </div>
                            <h4 class="font-black text-slate-900 text-sm mb-1">${isAction ? 'Scheduling Update' : 'System Notice'}</h4>
                            <p class="text-xs text-slate-600 font-medium leading-relaxed">${stripHtml(msg.content)}</p>
                            
                            ${isAction && metadata.payload?.action === 'REVIEW_SLOTS' ? `
                                <div class="mt-4 space-y-2">
                                    ${metadata.payload.slots.map((s, idx) => `
                                        <button onclick="confirmSlot(${idx})" class="w-full py-2 bg-slate-50 border border-slate-100 rounded-xl text-xs font-bold text-slate-700 hover:border-lmdr-blue transition">
                                            ${new Date(s.start).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
          }

          return `
                <div class="flex flex-col ${isRecruiter ? 'items-end' : 'items-start'}">
                    <div class="message-bubble ${isRecruiter ? 'message-recruiter' : 'message-driver'}">
                        ${stripHtml(msg.content)}
                    </div>
                    <div class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wider mx-2">
                        ${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
            `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      }

      function renderStatusButtons(currentStatus) {
        const container = document.getElementById('modal-status-buttons');
        container.innerHTML = '';

        STAGE_ORDER.forEach(stage => {
          if (stage === currentStatus) return;

          const config = STAGE_CONFIG[stage];
          const btn = document.createElement('button');
          btn.className = `text-xs font-medium py-2 px-3 rounded-lg border border-slate-200 hover:bg-${config.color}-50 hover:border-${config.color}-200 transition`;
          btn.innerHTML = `<i class="fa-solid ${config.icon} mr-1"></i>${config.label}`;
          btn.onclick = () => updateStatus(stage);
          container.appendChild(btn);
        });
      }

      function renderStatusHistory(history) {
        const container = document.getElementById('modal-history');
        container.innerHTML = '';

        if (!history || history.length === 0) {
          container.innerHTML = '<p class="text-slate-400 text-xs">No history yet</p>';
          return;
        }

        history.slice().reverse().forEach(entry => {
          const date = new Date(entry.timestamp);
          const config = STAGE_CONFIG[entry.status] || { label: entry.status, color: 'slate' };

          container.innerHTML += `
          <div class="flex items-start gap-3">
            <div class="status-dot status-${entry.status} mt-1.5"></div>
            <div class="flex-1">
              <div class="font-medium text-slate-900">${config.label}</div>
              <div class="text-xs text-slate-400">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
              ${entry.note ? `<div class="text-xs text-slate-500 mt-1">${entry.note}</div>` : ''}
            </div>
          </div>
        `;
        });
      }

      function updateStatus(newStatus) {
        if (!selectedCandidate) return;
        if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('recruiter_update_status', { newStatus: newStatus, candidateName: selectedCandidate.driverName });

        sendToWix('updateCandidateStatus', {
          interestId: selectedCandidate.interestId,
          newStatus: newStatus,
          notes: ''
        });
      }

      function handleStatusUpdated(data) {
        showToast(`Moved to ${STAGE_CONFIG[data.newStatus]?.label || data.newStatus}`);
        closeModal();
        sendToWix('getPipeline', {});
      }

      function saveNotes() {
        if (!selectedCandidate) return;
        if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('recruiter_save_notes', { candidateName: selectedCandidate.driverName });

        const notes = document.getElementById('modal-notes').value;
        sendToWix('addNotes', {
          interestId: selectedCandidate.interestId,
          notes: notes
        });
      }

      function closeModal() {
        document.getElementById('candidate-modal').classList.add('hidden');
        document.body.style.overflow = '';
        selectedCandidate = null;
      }

      // =========================================================================
      // UTILITIES
      // =========================================================================
      function getInitials(name) {
        if (!name) return '??';
        const parts = name.trim().split(' ');
        if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      function showError(message) {
        console.error('Error:', message);
        alert(message);
      }

      function showToast(message) {
        console.log('Toast:', message);
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // ============================================
      // THEME MANAGEMENT
      // ============================================
      const THEME_KEY = 'lmdr-recruiter-theme';

      function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        applyTheme(theme);
      }

      function applyTheme(theme) {
        if (theme === 'dark') {
          document.documentElement.classList.remove('light');
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
          document.documentElement.classList.add('light');
        }
        updateThemeIcon(theme);
      }

      function toggleTheme() {
        const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, newTheme);
        applyTheme(newTheme);
      }

      function updateThemeIcon(theme) {
        const btn = document.getElementById('themeToggle');
        if (btn) {
          btn.innerHTML = theme === 'dark' ? '<i class="fa-solid fa-moon"></i>' : '<i class="fa-solid fa-sun"></i>';
        }
      }

      // Initialize theme on load
      initTheme();

      // ============================================
      // SYSTEM HEALTH UTILS
      // ============================================
      function requestSystemHealth() {
        const dot = document.getElementById('health-indicator-dot');
        const text = document.getElementById('health-indicator-text');
        if (dot) dot.className = 'w-2.5 h-2.5 rounded-full bg-slate-300 animate-pulse';
        if (text) text.textContent = 'Refreshing...';

        sendToWix('getSystemHealth', { carrierDot: currentCarrierDOT });
        sendToWix('logFeatureInteraction', { feature: 'recruiter_system_health_refresh', type: 'click' });
      }

      function updateSystemHealthUI(data) {
        if (!data) return;

        // Main Widget Status
        const dot = document.getElementById('health-indicator-dot');
        const text = document.getElementById('health-indicator-text');

        if (dot && text) {
          if (data.status === 'outage') {
            dot.className = 'w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse';
            text.textContent = 'System Issues';
            text.className = 'text-xs font-bold text-red-600';
          } else if (data.status === 'degraded') {
            dot.className = 'w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse';
            text.textContent = 'Degraded';
            text.className = 'text-xs font-bold text-yellow-600';
          } else {
            dot.className = 'w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse';
            text.textContent = 'Operational';
            text.className = 'text-xs font-bold text-green-600';
          }
        }

        document.getElementById('health-last-updated').textContent = 'Last checked: ' + new Date().toLocaleTimeString();

        // Update Service Cards
        updateServiceWeb('database', data.checks?.database);
        updateServiceWeb('ai', data.checks?.ai);
        updateServiceWeb('enrichment', data.checks?.enrichment);
        updateServiceWeb('fmcsa', data.checks?.fmcsa);
      }

      function updateServiceWeb(id, checkData) {
        const el = document.getElementById(`status-${id}`);
        if (!el || !checkData) return;

        let colorClass = 'bg-slate-100 text-slate-700';
        if (checkData.status === 'healthy' || checkData.status === 'Active' || checkData.status === 'Reachable') {
          colorClass = 'bg-green-100 text-green-700';
        } else if (checkData.status === 'degraded') {
          colorClass = 'bg-yellow-100 text-yellow-700';
        } else {
          colorClass = 'bg-red-100 text-red-700';
        }

        el.className = `text-xs font-bold px-2 py-1 rounded ${colorClass}`;
        el.textContent = checkData.message || checkData.status;
      }
    </script>

</body>

</html>