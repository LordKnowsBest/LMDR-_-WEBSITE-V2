<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Gamification | LMDR</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            blue: '#2563eb',
                            dark: '#0f172a',
                            yellow: '#fbbf24',
                            canvas: '#f1f5f9'
                        },
                        xp: {
                            bronze: '#cd7f32',
                            silver: '#c0c0c0',
                            gold: '#ffd700',
                            platinum: '#e5e4e2',
                            diamond: '#b9f2ff'
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent;
        }

        .xp-bar {
            @apply h-3 rounded-full bg-slate-200 overflow-hidden;
        }

        .xp-bar-fill {
            @apply h-full rounded-full bg-gradient-to-r from-lmdr-blue to-blue-400 transition-all duration-500;
        }

        .streak-fire {
            @apply text-orange-500;
            filter: drop-shadow(0 0 8px rgba(249, 115, 22, 0.5));
        }

        .achievement-badge {
            @apply w-12 h-12 rounded-xl flex items-center justify-center text-lg;
        }

        .achievement-locked {
            @apply bg-slate-100 text-slate-300;
        }

        .achievement-unlocked {
            @apply bg-gradient-to-br from-lmdr-yellow to-amber-500 text-white shadow-lg;
        }

        .challenge-progress-bar {
            @apply h-2 rounded-full bg-slate-200 overflow-hidden;
        }

        .challenge-progress-fill {
            @apply h-full rounded-full transition-all duration-300;
        }

        .card {
            @apply bg-white rounded-2xl p-5 shadow-sm border border-slate-100;
        }

        .card-header {
            @apply flex items-center justify-between mb-4;
        }

        .card-title {
            @apply text-sm font-bold text-slate-400 uppercase tracking-wider;
        }

        /* Level badges */
        .level-badge {
            @apply inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold;
        }

        .level-rookie { @apply bg-slate-100 text-slate-600; }
        .level-apprentice { @apply bg-blue-100 text-blue-700; }
        .level-professional { @apply bg-purple-100 text-purple-700; }
        .level-expert { @apply bg-amber-100 text-amber-700; }
        .level-master { @apply bg-gradient-to-r from-amber-400 to-orange-500 text-white; }
        .level-legend { @apply bg-gradient-to-r from-violet-500 to-purple-600 text-white; }

        /* Challenge type badges */
        .challenge-daily { @apply bg-blue-100 text-blue-700; }
        .challenge-weekly { @apply bg-purple-100 text-purple-700; }
        .challenge-monthly { @apply bg-amber-100 text-amber-700; }
        .challenge-event { @apply bg-gradient-to-r from-pink-500 to-rose-500 text-white; }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(37, 99, 235, 0); }
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }

        .streak-active {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Dark mode */
        html.dark body { background: transparent; }
        html.dark .card { background-color: #1e293b; border-color: #334155; }
        html.dark .card-title { color: #64748b; }
        html.dark .text-slate-900 { color: #f1f5f9; }
        html.dark .text-slate-700 { color: #cbd5e1; }
        html.dark .text-slate-500 { color: #94a3b8; }
        html.dark .text-slate-400 { color: #64748b; }
        html.dark .bg-slate-50 { background-color: #0f172a; }
        html.dark .bg-slate-100 { background-color: #1e293b; }
        html.dark .bg-slate-200 { background-color: #334155; }
        html.dark .border-slate-100 { border-color: #334155; }
        html.dark .border-slate-200 { border-color: #475569; }
        html.dark .xp-bar { background-color: #334155; }
        html.dark .challenge-progress-bar { background-color: #334155; }
        html.dark .achievement-locked { background-color: #334155; color: #475569; }
        html.dark .hover\:bg-slate-50:hover { background-color: #334155; }
    </style>
</head>

<body class="text-slate-800 antialiased p-4">

    <!-- LOADING STATE -->
    <div id="loading-state" class="py-12 text-center">
        <div class="w-10 h-10 border-4 border-lmdr-blue border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
        <p class="text-slate-400 text-sm font-medium">Loading your progress...</p>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="hidden space-y-4">

        <!-- PROGRESSION WIDGET -->
        <div class="card" id="progression-widget">
            <div class="flex items-start justify-between gap-4">
                <!-- Level & XP -->
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-lmdr-blue to-blue-700 flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-200" id="level-icon">
                            1
                        </div>
                        <div>
                            <span class="level-badge level-rookie" id="level-badge">
                                <i class="fa-solid fa-star"></i>
                                <span id="level-title">Rookie</span>
                            </span>
                            <div class="text-xs text-slate-400 mt-1" id="level-label">Level 1</div>
                        </div>
                    </div>

                    <!-- XP Bar -->
                    <div class="mb-1">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-bold text-slate-600" id="xp-current">0 XP</span>
                            <span class="text-slate-400" id="xp-next">500 XP to Level 2</span>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-bar-fill" id="xp-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Streak Counter -->
                <div class="text-center px-4 py-3 bg-slate-50 rounded-xl border border-slate-100" id="streak-container">
                    <div class="flex items-center justify-center gap-1 mb-1">
                        <i class="fa-solid fa-fire streak-fire text-2xl" id="streak-icon"></i>
                        <span class="text-3xl font-black text-slate-900" id="streak-count">0</span>
                    </div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Day Streak</div>
                    <div class="flex items-center justify-center gap-1 mt-2" id="streak-freezes">
                        <!-- Freeze icons rendered by JS -->
                    </div>
                </div>
            </div>

            <!-- Streak Multiplier Banner -->
            <div class="hidden mt-4 p-3 bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-100 rounded-xl" id="multiplier-banner">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-bolt text-orange-500"></i>
                    <span class="text-sm font-bold text-orange-700" id="multiplier-text">1.5x XP Multiplier Active!</span>
                </div>
            </div>
        </div>

        <!-- ACTIVE CHALLENGES -->
        <div class="card" id="challenges-widget">
            <div class="card-header">
                <span class="card-title">
                    <i class="fa-solid fa-bullseye mr-1.5"></i>Active Challenges
                </span>
                <button onclick="viewAllChallenges()" class="text-xs font-bold text-lmdr-blue hover:underline">View All</button>
            </div>

            <div id="challenges-list" class="space-y-3">
                <!-- Challenges rendered by JS -->
                <div class="text-center py-6 text-slate-400 text-sm">
                    <i class="fa-solid fa-trophy mb-2 block text-2xl opacity-30"></i>
                    No active challenges
                </div>
            </div>
        </div>

        <!-- RECENT ACHIEVEMENTS -->
        <div class="card" id="achievements-widget">
            <div class="card-header">
                <span class="card-title">
                    <i class="fa-solid fa-medal mr-1.5"></i>Recent Achievements
                </span>
                <button onclick="viewAllAchievements()" class="text-xs font-bold text-lmdr-blue hover:underline">View All</button>
            </div>

            <div id="achievements-grid" class="grid grid-cols-4 gap-3">
                <!-- Achievements rendered by JS -->
            </div>

            <div id="achievements-empty" class="hidden text-center py-6 text-slate-400 text-sm">
                <i class="fa-solid fa-award mb-2 block text-2xl opacity-30"></i>
                Complete actions to earn achievements!
            </div>
        </div>

        <!-- WHAT'S NEXT -->
        <div class="card" id="whats-next-widget">
            <div class="card-header">
                <span class="card-title">
                    <i class="fa-solid fa-compass mr-1.5"></i>What's Next
                </span>
            </div>

            <div id="recommendations-list" class="space-y-2">
                <!-- Recommendations rendered by JS -->
            </div>
        </div>

    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2">
        <!-- Toasts rendered by JS -->
    </div>

    <!-- CELEBRATION MODAL -->
    <div id="celebration-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-8 text-center animate-bounce-in">
            <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl" id="celebration-icon">
                <!-- Icon set by JS -->
            </div>
            <h2 class="text-2xl font-black text-slate-900 mb-2" id="celebration-title">Congratulations!</h2>
            <p class="text-slate-500 mb-6" id="celebration-message">You've achieved something great!</p>
            <div class="text-sm font-bold text-lmdr-blue mb-6" id="celebration-reward">+50 XP</div>
            <button onclick="closeCelebration()" class="w-full py-3 bg-lmdr-dark text-white rounded-xl font-bold hover:bg-slate-800 transition">
                Awesome!
            </button>
        </div>
    </div>

    <style>
        @keyframes bounce-in {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in {
            animation: bounce-in 0.4s ease-out;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti 3s ease-in-out forwards;
        }
    </style>

    <script>
        // ==========================================
        // STATE
        // ==========================================
        let progression = null;
        let challenges = [];
        let achievements = [];
        let recommendations = [];

        const LEVEL_STYLES = {
            'Rookie': 'level-rookie',
            'Apprentice': 'level-apprentice',
            'Road Runner': 'level-apprentice',
            'Professional': 'level-professional',
            'Highway Pro': 'level-professional',
            'Expert': 'level-expert',
            'Expert Hauler': 'level-expert',
            'Master': 'level-master',
            'Master Driver': 'level-master',
            'Legend': 'level-legend',
            'Road Legend': 'level-legend'
        };

        const CHALLENGE_STYLES = {
            'daily': 'challenge-daily',
            'weekly': 'challenge-weekly',
            'monthly': 'challenge-monthly',
            'event': 'challenge-event',
            'one_time': 'challenge-monthly'
        };

        // ==========================================
        // MESSAGE VALIDATION
        // ==========================================
        const MESSAGE_REGISTRY = {
            inbound: [
                'gamificationData',
                'progressionUpdate',
                'challengeUpdate',
                'achievementUnlocked',
                'levelUp',
                'streakUpdate',
                'xpAwarded',
                'challengeComplete',
                'error',
                'pong'
            ],
            outbound: [
                'gamificationReady',
                'refreshGamification',
                'startChallenge',
                'claimReward',
                'viewChallenges',
                'viewAchievements',
                'ping'
            ]
        };

        function isValidOrigin(event) {
            if (window.parent === window) return false;
            if (event.source !== window.parent) return false;
            return true;
        }

        function validateMessageSchema(msg) {
            if (!msg || typeof msg !== 'object') return false;
            if (typeof msg.type !== 'string' || msg.type.length === 0) return false;
            return true;
        }

        function stripHtml(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function sendToVelo(type, data = {}) {
            console.log(`ðŸ“¤ [HTMLâ†’Velo] ${type}`, data);
            window.parent.postMessage({ type, data }, '*');
        }

        // ==========================================
        // MESSAGE HANDLER
        // ==========================================
        window.addEventListener('message', (event) => {
            if (!isValidOrigin(event)) return;
            const msg = event.data;
            if (!validateMessageSchema(msg)) return;

            console.log(`ðŸ“¥ [Veloâ†’HTML] ${msg.type}`, msg.data);

            switch (msg.type) {
                case 'gamificationData':
                    handleGamificationData(msg.data);
                    break;
                case 'progressionUpdate':
                    updateProgression(msg.data);
                    break;
                case 'challengeUpdate':
                    updateChallenge(msg.data);
                    break;
                case 'achievementUnlocked':
                    showAchievementUnlocked(msg.data);
                    break;
                case 'levelUp':
                    showLevelUp(msg.data);
                    break;
                case 'streakUpdate':
                    updateStreak(msg.data);
                    break;
                case 'xpAwarded':
                    showXPToast(msg.data);
                    break;
                case 'challengeComplete':
                    showChallengeComplete(msg.data);
                    break;
                case 'error':
                    console.error('Gamification error:', msg.data?.message);
                    break;
                case 'pong':
                    console.log('âœ… Connection verified');
                    break;
            }
        });

        // Signal ready
        console.log('LMDR Driver Gamification Widget Ready');
        sendToVelo('gamificationReady');

        // ==========================================
        // DATA HANDLERS
        // ==========================================
        function handleGamificationData(data) {
            if (!data) return;

            progression = data.progression;
            challenges = data.challenges || [];
            achievements = data.achievements || [];
            recommendations = data.recommendations || [];

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            renderProgression();
            renderChallenges();
            renderAchievements();
            renderRecommendations();
        }

        // ==========================================
        // RENDER FUNCTIONS
        // ==========================================
        function renderProgression() {
            if (!progression) return;

            const level = progression.level || 1;
            const title = progression.level_title || 'Rookie';
            const currentXP = progression.current_xp || 0;
            const xpForNextLevel = progression.xp_for_next_level || 500;
            const xpProgress = progression.xp_progress_percent || 0;
            const streak = progression.current_streak || 0;
            const freezes = progression.streak_freezes || 0;
            const multiplier = progression.streak_multiplier || 1;

            // Level icon
            document.getElementById('level-icon').textContent = level;

            // Level badge
            const badge = document.getElementById('level-badge');
            badge.className = `level-badge ${LEVEL_STYLES[title] || 'level-rookie'}`;
            document.getElementById('level-title').textContent = title;
            document.getElementById('level-label').textContent = `Level ${level}`;

            // XP bar
            document.getElementById('xp-current').textContent = `${currentXP.toLocaleString()} XP`;
            document.getElementById('xp-next').textContent = `${xpForNextLevel.toLocaleString()} XP to Level ${level + 1}`;
            document.getElementById('xp-fill').style.width = `${xpProgress}%`;

            // Streak
            document.getElementById('streak-count').textContent = streak;
            const streakIcon = document.getElementById('streak-icon');
            const streakContainer = document.getElementById('streak-container');

            if (streak >= 7) {
                streakIcon.classList.add('streak-fire');
                streakContainer.classList.add('streak-active');
            } else {
                streakIcon.classList.remove('streak-fire');
                streakContainer.classList.remove('streak-active');
            }

            // Freezes
            const freezesContainer = document.getElementById('streak-freezes');
            freezesContainer.innerHTML = Array(3).fill(0).map((_, i) => `
                <i class="fa-solid fa-snowflake text-xs ${i < freezes ? 'text-cyan-400' : 'text-slate-300'}"></i>
            `).join('');

            // Multiplier banner
            const multiplierBanner = document.getElementById('multiplier-banner');
            if (multiplier > 1) {
                multiplierBanner.classList.remove('hidden');
                document.getElementById('multiplier-text').textContent = `${multiplier}x XP Multiplier Active!`;
            } else {
                multiplierBanner.classList.add('hidden');
            }
        }

        function renderChallenges() {
            const container = document.getElementById('challenges-list');

            if (!challenges || challenges.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-slate-400 text-sm">
                        <i class="fa-solid fa-trophy mb-2 block text-2xl opacity-30"></i>
                        No active challenges
                    </div>
                `;
                return;
            }

            container.innerHTML = challenges.slice(0, 3).map(challenge => {
                const progress = challenge.progress || 0;
                const target = challenge.target || 1;
                const percent = Math.min((progress / target) * 100, 100);
                const typeStyle = CHALLENGE_STYLES[challenge.type] || 'challenge-daily';
                const isComplete = progress >= target;
                const canClaim = isComplete && !challenge.claimed;

                return `
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 ${isComplete ? 'ring-2 ring-lmdr-blue ring-opacity-50' : ''}">
                        <div class="flex items-start justify-between gap-3 mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${typeStyle} uppercase">${challenge.type}</span>
                                    ${challenge.expires_in ? `<span class="text-[10px] text-slate-400"><i class="fa-regular fa-clock mr-1"></i>${challenge.expires_in}</span>` : ''}
                                </div>
                                <h4 class="text-sm font-bold text-slate-900">${stripHtml(challenge.title)}</h4>
                                <p class="text-xs text-slate-500 mt-0.5">${stripHtml(challenge.description || '')}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-xs font-bold text-lmdr-blue">+${challenge.xp_reward} XP</div>
                                ${canClaim ? `
                                    <button onclick="claimReward('${challenge._id}')" class="mt-1 px-3 py-1 bg-lmdr-blue text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition">
                                        Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="challenge-progress-bar flex-1">
                                <div class="challenge-progress-fill ${isComplete ? 'bg-green-500' : 'bg-lmdr-blue'}" style="width: ${percent}%"></div>
                            </div>
                            <span class="text-xs font-bold ${isComplete ? 'text-green-600' : 'text-slate-500'}">${progress}/${target}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            const empty = document.getElementById('achievements-empty');

            if (!achievements || achievements.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            empty.classList.add('hidden');

            // Show up to 8 recent achievements
            grid.innerHTML = achievements.slice(0, 8).map(achievement => {
                const isUnlocked = achievement.unlocked;
                return `
                    <div class="text-center group cursor-pointer" onclick="showAchievementDetail('${achievement._id}')" title="${stripHtml(achievement.name)}">
                        <div class="achievement-badge mx-auto mb-1 ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'} group-hover:scale-110 transition-transform">
                            <i class="fa-solid ${achievement.icon || 'fa-trophy'}"></i>
                        </div>
                        <div class="text-[10px] font-bold ${isUnlocked ? 'text-slate-700' : 'text-slate-400'} truncate">${stripHtml(achievement.name)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');

            // Default recommendations if none provided
            const items = recommendations.length > 0 ? recommendations : [
                { icon: 'fa-user-pen', title: 'Complete your profile', description: 'Add your experience and certifications', action: 'profile', xp: 100 },
                { icon: 'fa-briefcase', title: 'Apply to a job', description: 'Browse carrier opportunities', action: 'jobs', xp: 50 },
                { icon: 'fa-calendar-check', title: 'Log in daily', description: 'Build your streak for bonus XP', action: 'streak', xp: 25 }
            ];

            container.innerHTML = items.slice(0, 3).map(item => `
                <button onclick="handleRecommendation('${item.action}')" class="w-full flex items-center gap-3 p-3 bg-slate-50 hover:bg-blue-50 rounded-xl border border-slate-100 hover:border-lmdr-blue transition text-left group">
                    <div class="w-10 h-10 rounded-lg bg-white border border-slate-200 flex items-center justify-center text-slate-400 group-hover:text-lmdr-blue group-hover:border-lmdr-blue transition">
                        <i class="fa-solid ${item.icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-slate-900 group-hover:text-lmdr-blue transition">${stripHtml(item.title)}</h4>
                        <p class="text-xs text-slate-500 truncate">${stripHtml(item.description)}</p>
                    </div>
                    <div class="text-xs font-bold text-lmdr-blue">+${item.xp} XP</div>
                </button>
            `).join('');
        }

        // ==========================================
        // UPDATE HANDLERS
        // ==========================================
        function updateProgression(data) {
            if (data) {
                progression = { ...progression, ...data };
                renderProgression();
            }
        }

        function updateChallenge(data) {
            if (!data || !data._id) return;
            const index = challenges.findIndex(c => c._id === data._id);
            if (index >= 0) {
                challenges[index] = { ...challenges[index], ...data };
            } else {
                challenges.unshift(data);
            }
            renderChallenges();
        }

        function updateStreak(data) {
            if (data) {
                progression = {
                    ...progression,
                    current_streak: data.streak,
                    streak_freezes: data.freezes,
                    streak_multiplier: data.multiplier
                };
                renderProgression();
            }
        }

        // ==========================================
        // CELEBRATIONS & TOASTS
        // ==========================================
        function showAchievementUnlocked(data) {
            showCelebration({
                icon: `<i class="fa-solid ${data.icon || 'fa-trophy'} text-amber-500"></i>`,
                iconBg: 'bg-amber-100',
                title: 'Achievement Unlocked!',
                message: data.name || 'You earned a new achievement!',
                reward: `+${data.xp_reward || 50} XP`
            });
            triggerConfetti();
        }

        function showLevelUp(data) {
            showCelebration({
                icon: '<i class="fa-solid fa-arrow-up text-lmdr-blue"></i>',
                iconBg: 'bg-blue-100',
                title: `Level ${data.level}!`,
                message: `You are now a ${data.title || 'Road Runner'}!`,
                reward: data.unlocks ? `Unlocked: ${data.unlocks}` : ''
            });
            triggerConfetti();
        }

        function showChallengeComplete(data) {
            showCelebration({
                icon: '<i class="fa-solid fa-check-circle text-green-500"></i>',
                iconBg: 'bg-green-100',
                title: 'Challenge Complete!',
                message: data.title || 'You completed a challenge!',
                reward: `+${data.xp_reward || 100} XP`
            });
        }

        function showCelebration({ icon, iconBg, title, message, reward }) {
            const modal = document.getElementById('celebration-modal');
            document.getElementById('celebration-icon').innerHTML = icon;
            document.getElementById('celebration-icon').className = `w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl ${iconBg}`;
            document.getElementById('celebration-title').textContent = title;
            document.getElementById('celebration-message').textContent = message;
            document.getElementById('celebration-reward').textContent = reward;
            modal.classList.remove('hidden');
        }

        function closeCelebration() {
            document.getElementById('celebration-modal').classList.add('hidden');
        }

        function showXPToast(data) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'bg-white rounded-xl shadow-lg border border-slate-100 p-4 flex items-center gap-3 animate-slide-in';
            toast.innerHTML = `
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-lmdr-blue">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <div>
                    <div class="text-sm font-bold text-slate-900">+${data.xp || 0} XP</div>
                    <div class="text-xs text-slate-500">${stripHtml(data.reason || 'Action completed')}</div>
                </div>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function triggerConfetti() {
            const colors = ['#fbbf24', '#2563eb', '#10b981', '#f43f5e', '#8b5cf6'];
            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = Math.random() * 0.5 + 's';
                piece.style.animationDuration = (2 + Math.random() * 2) + 's';
                document.body.appendChild(piece);
                setTimeout(() => piece.remove(), 4000);
            }
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        function viewAllChallenges() {
            sendToVelo('viewChallenges');
        }

        function viewAllAchievements() {
            sendToVelo('viewAchievements');
        }

        function claimReward(challengeId) {
            sendToVelo('claimReward', { challengeId });
        }

        function handleRecommendation(action) {
            sendToVelo('navigateTo', { action });
        }

        function showAchievementDetail(achievementId) {
            // Could show a modal with full achievement details
            console.log('Show achievement:', achievementId);
        }

        // ==========================================
        // THEME
        // ==========================================
        const THEME_KEY = 'lmdr-driver-theme';

        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            document.documentElement.classList.remove('light', 'dark');
            document.documentElement.classList.add(theme);
        }

        // Listen for theme changes from parent
        window.addEventListener('message', (event) => {
            if (event.data?.type === 'themeChange') {
                applyTheme(event.data.theme);
            }
        });

        initTheme();

        // ==========================================
        // TOAST ANIMATIONS
        // ==========================================
    </script>

    <style>
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-10px); }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-out forwards; }
    </style>

</body>

</html>
