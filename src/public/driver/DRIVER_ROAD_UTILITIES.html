<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Road Utilities - LMDR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            blue: '#2563eb',
                            dark: '#0f172a',
                            yellow: '#fbbf24',
                            'yellow-hover': '#f59e0b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-active {
            border-bottom: 3px solid #fbbf24;
            color: #fbbf24;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .leaflet-container {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 min-h-screen pb-20">
    <!-- Tab Navigation -->
    <!-- Tab Navigation (Segmented Control) -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-50 py-3">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-slate-100 p-1 rounded-xl flex gap-1 overflow-x-auto hide-scrollbar">
                <button id="tab-dashboard" onclick="switchTab('dashboard')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all bg-white shadow-sm text-slate-900 ring-1 ring-black/5">
                    <i class="fa-solid fa-gauge-high sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Dash
                </button>
                <button id="tab-parking" onclick="switchTab('parking')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50">
                    <i
                        class="fa-solid fa-square-parking sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Parking
                </button>
                <button id="tab-fuel" onclick="switchTab('fuel')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50">
                    <i class="fa-solid fa-gas-pump sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Fuel
                </button>
                <button id="tab-weighstation" onclick="switchTab('weighstation')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50">
                    <i
                        class="fa-solid fa-scale-balanced sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Scales
                </button>
                <button id="tab-ratings" onclick="switchTab('ratings')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50">
                    <i class="fa-solid fa-star sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Ratings
                </button>
                <button id="tab-weather" onclick="switchTab('weather')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50">
                    <i
                        class="fa-solid fa-cloud-bolt sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Weather
                </button>
                <button id="tab-conditions" onclick="switchTab('conditions')"
                    class="flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50">
                    <i
                        class="fa-solid fa-traffic-cone sm:mr-1 block sm:inline text-base sm:text-xs mb-1 sm:mb-0"></i>Conditions
                </button>
            </div>
        </div>

        <!-- Dashboard Section (Unified Home) -->
        <section id="section-dashboard" class="space-y-6">
            <!-- Welcome / Quick Actions -->
            <div
                class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
                </div>

                <div class="relative z-10">
                    <h1 class="font-black text-2xl mb-1">Road Utility Center</h1>
                    <p class="text-slate-400 text-sm mb-6">All your road tools in one place.</p>

                    <div class="grid grid-cols-4 gap-2 sm:gap-4">
                        <button onclick="switchTab('parking')"
                            class="bg-white/10 hover:bg-white/20 transition-colors p-3 rounded-xl flex flex-col items-center gap-2 group">
                            <div
                                class="w-8 h-8 rounded-full bg-lmdr-yellow text-slate-900 flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-p"></i>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Parking</span>
                        </button>
                        <button onclick="switchTab('fuel')"
                            class="bg-white/10 hover:bg-white/20 transition-colors p-3 rounded-xl flex flex-col items-center gap-2 group">
                            <div
                                class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-gas-pump"></i>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Fuel</span>
                        </button>
                        <button onclick="switchTab('weather')"
                            class="bg-white/10 hover:bg-white/20 transition-colors p-3 rounded-xl flex flex-col items-center gap-2 group">
                            <div
                                class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-cloud-bolt"></i>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Weather</span>
                        </button>
                        <button onclick="switchTab('conditions')"
                            class="bg-white/10 hover:bg-white/20 transition-colors p-3 rounded-xl flex flex-col items-center gap-2 group">
                            <div
                                class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-road"></i>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Traffic</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nearby Summary Widget -->
            <div class="grid sm:grid-cols-2 gap-4">
                <!-- Fuel Summary -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:border-lmdr-yellow transition-colors"
                    onclick="switchTab('fuel')">
                    <div>
                        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Cheapest Diesel
                        </p>
                        <p class="text-xl font-black text-slate-900" id="dash-diesel-price">--</p>
                        <p class="text-xs text-slate-500 truncate max-w-[120px]" id="dash-diesel-loc">Locating...</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                        <i class="fa-solid fa-gas-pump"></i>
                    </div>
                </div>

                <!-- Parking Summary -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:border-lmdr-yellow transition-colors"
                    onclick="switchTab('parking')">
                    <div>
                        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Nearest Parking
                        </p>
                        <p class="text-xl font-black text-slate-900" id="dash-parking-dist">-- mi</p>
                        <p class="text-xs text-green-600 font-bold" id="dash-parking-status">Checking...</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-lmdr-yellow/20 text-slate-900 flex items-center justify-center">
                        <i class="fa-solid fa-square-parking"></i>
                    </div>
                </div>
            </div>

            <!-- Route Quick Plan -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-3"><i
                        class="fa-solid fa-map-location-dot mr-1"></i> Quick Route Check</p>
                <div class="flex gap-2">
                    <input type="text" id="dash-route-input" placeholder="Enter destination (e.g. Dallas, TX)"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-lmdr-blue/50">
                    <button onclick="planRoute()"
                        class="bg-slate-900 text-white font-bold px-4 py-2 rounded-lg text-xs hover:bg-slate-800">CHECK</button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-xl px-4 py-2 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center py-2 border-b border-slate-100 mb-2">
                    <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Recent Activity</p>
                </div>
                <div id="dash-recent-activity" class="space-y-3 pb-2">
                    <p class="text-xs text-slate-400 italic py-2 text-center">No recent activity</p>
                </div>
            </div>

        </section>

        <!-- Weather Section -->
        <section id="section-weather" class="space-y-6 hidden">
            <!-- (Content from previous phase) -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center justify-between">
                <div>
                    <h2 class="font-black text-2xl text-slate-900 mb-2">Weather Alerts</h2>
                    <p class="text-slate-500 text-sm">Active alerts along your route.</p>
                </div>
                <button onclick="refreshWeather()"
                    class="bg-slate-100 text-slate-900 font-bold px-4 py-2 rounded-lg text-sm hover:bg-slate-200 transaction-colors">
                    REFRESH
                </button>
            </div>

            <!-- Active Alerts Container -->
            <div id="weather-alerts-container" class="space-y-3">
                <div class="bg-white rounded-2xl p-8 text-center border border-slate-100">
                    <i class="fa-solid fa-sun text-4xl text-lmdr-yellow mb-4"></i>
                    <p class="font-bold text-slate-900">No active alerts</p>
                    <p class="text-xs text-slate-400 mt-1">Your route looks clear.</p>
                </div>
            </div>

            <!-- Chain Laws -->
            <div>
                <h3 class="font-black text-slate-900 text-sm uppercase tracking-wider mb-4">Chain Laws (Mountain
                    Passes)</h3>
                <div id="chain-laws-list" class="grid sm:grid-cols-2 gap-4">
                    <!-- Injected via JS -->
                    <div class="text-center py-8 text-slate-400">Loading chain requirements...</div>
                </div>
            </div>
        </section>

        <!-- Road Conditions Section (New Phase 6) -->
        <section id="section-conditions" class="space-y-6 hidden">
            <!-- Route Condition Summary -->
            <div class="bg-slate-900 rounded-2xl p-6 shadow-lg text-white">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="font-black text-2xl mb-1">Route Conditions</h2>
                        <p class="text-slate-400 text-sm">Real-time incidents & restrictions.</p>
                    </div>
                    <button onclick="refreshConditions()"
                        class="bg-white/10 text-white font-bold px-4 py-2 rounded-lg text-sm hover:bg-white/20 transition-colors">
                        REFRESH
                    </button>
                </div>

                <div class="grid grid-cols-4 gap-4 text-center border-t border-white/10 pt-6">
                    <div>
                        <p class="text-3xl font-black text-white" id="stat-incidents">0</p>
                        <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider mt-1">Incidents</p>
                    </div>
                    <div>
                        <p class="text-3xl font-black text-lmdr-yellow" id="stat-construction">0</p>
                        <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider mt-1">Constr.</p>
                    </div>
                    <div>
                        <p class="text-3xl font-black text-red-500" id="stat-closures">0</p>
                        <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider mt-1">Closures</p>
                    </div>
                    <div>
                        <p class="text-3xl font-black text-slate-400" id="stat-delay">0m</p>
                        <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider mt-1">Delay</p>
                    </div>
                </div>
            </div>

            <!-- Equipment Filter -->
            <div class="bg-white rounded-xl p-4 border border-slate-200">
                <button onclick="document.getElementById('truck-specs-form').classList.toggle('hidden')"
                    class="w-full flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-truck-moving text-lmdr-blue"></i>
                        <span class="font-bold text-sm text-slate-900">Truck Specs & Restrictions</span>
                    </div>
                    <i class="fa-solid fa-chevron-down text-slate-400"></i>
                </button>

                <div id="truck-specs-form" class="hidden mt-4 pt-4 border-t border-slate-100">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-1">Height
                                (ft)</label>
                            <input type="number" id="spec-height" value="13.5" step="0.1"
                                class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold">
                        </div>
                        <div>
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-1">Weight
                                (k lbs)</label>
                            <input type="number" id="spec-weight" value="80"
                                class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold">
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="spec-hazmat"
                            class="rounded border-slate-300 text-lmdr-blue focus:ring-lmdr-blue">
                        <label for="spec-hazmat" class="text-sm font-medium text-slate-700">Carrying Hazmat</label>
                    </div>
                </div>
            </div>
            <!-- Restrictions Results -->
            <div id="restrictions-list" class="mt-4 space-y-2 hidden">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2">Active Restrictions
                    for Your Truck</h4>
            </div>

            <script>
                // Auto-update restrictions when specs change
                ['spec-height', 'spec-weight', 'spec-hazmat'].forEach(id => {
                    document.getElementById(id).addEventListener('change', updateTruckRestrictions);
                });

                function updateTruckRestrictions() {
                    const height = parseFloat(document.getElementById('spec-height').value) || 13.5;
                    const weight = parseFloat(document.getElementById('spec-weight').value) || 80;
                    const hazmat = document.getElementById('spec-hazmat').checked;

                    // Get current route (mocked/default if not navigating)
                    const routePoints = window.currentRoute || [{ lat: 39.31, lng: -120.33 }, { lat: 39.5, lng: -120.5 }];

                    // Demo Mode: If Iowa
                    if (window.demoMode === 'IA') {
                        // Ensure we check Iowa bounds
                        window.parent.postMessage({
                            type: 'getTruckRestrictions',
                            data: { routePoints: [{ lat: 41.6, lng: -93.6 }], truckSpecs: { height, weight, hazmat } }
                        }, '*');
                        return;
                    }

                    window.parent.postMessage({
                        type: 'getTruckRestrictions',
                        data: { routePoints, truckSpecs: { height, weight, hazmat } }
                    }, '*');
                }
            </script>

            <!-- Action Bar -->
            <div class="flex justify-end mb-4">
                <button onclick="openReportModal()"
                    class="bg-lmdr-yellow text-slate-900 font-black text-xs uppercase px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i> Report Incident
                </button>
            </div>

            <!-- Conditions List -->
            <div id="conditions-list" class="space-y-3">
                <!-- Injected via JS -->
            </div>
        </section>
        <!-- Head-Up Display (HUD) -->
        <div id="road-hud"
            class="bg-slate-900 rounded-2xl p-5 shadow-xl text-white flex flex-wrap sm:flex-nowrap items-center justify-between gap-6 overflow-hidden relative group">
            <!-- Background Glow -->
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-blue-600/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
            </div>

            <!-- Floating Action Buttons -->
            <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3">
                <!-- Review FAB (Visible on Parking/Ratings tabs) -->
                <button onclick="openReviewModal()" id="fab-review"
                    class="w-14 h-14 bg-lmdr-yellow text-slate-900 rounded-full shadow-lg hover:shadow-xl hover:bg-yellow-400 transition-all flex items-center justify-center transform hover:scale-110 active:scale-95 group">
                    <i class="fa-solid fa-pen-to-square text-xl"></i>
                    <span
                        class="absolute right-full mr-4 bg-slate-900 text-white text-xs font-bold px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                        Write Review
                    </span>
                </button>

                <!-- Report Condition FAB (Visible on all tabs) -->
                <button onclick="reportCondition()" id="fab-report"
                    class="w-14 h-14 bg-slate-900 text-white rounded-full shadow-lg hover:shadow-xl hover:bg-slate-800 transition-all flex items-center justify-center transform hover:scale-110 active:scale-95 group">
                    <i class="fa-solid fa-triangle-exclamation text-xl text-lmdr-yellow"></i>
                    <span
                        class="absolute right-full mr-4 bg-white text-slate-900 border border-slate-200 text-xs font-bold px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                        Report Issue
                    </span>
                </button>
            </div>

            <!-- Modals -->
            <div class="flex items-center gap-4 relative z-10 flex-grow">
                <div
                    class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center text-lmdr-yellow text-xl border border-white/5">
                    <i class="fa-solid fa-location-dot"></i>
                </div>
                <div>
                    <p class="text-[10px] uppercase font-black tracking-widest text-slate-400 mb-0.5">CURRENT
                        LOCATION
                    </p>
                    <p class="font-black text-xl leading-none" id="hud-location">
                        <span class="animate-pulse">Detecting...</span>
                    </p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div
                class="flex items-center gap-6 relative z-10 border-t sm:border-t-0 sm:border-l border-white/10 pt-4 sm:pt-0 sm:pl-6 w-full sm:w-auto">
                <div class="flex items-center gap-2.5">
                    <i class="fa-solid fa-cloud-sun text-slate-400"></i>
                    <div>
                        <p class="text-[10px] uppercase font-bold tracking-wider text-slate-500">Weather</p>
                        <p class="font-bold text-sm" id="hud-weather">--&deg;</p>
                    </div>
                </div>
                <div class="flex items-center gap-2.5">
                    <i class="fa-solid fa-scale-unbalanced text-slate-400"></i>
                    <div>
                        <p class="text-[10px] uppercase font-bold tracking-wider text-slate-500">Nrst Scale</p>
                        <p class="font-bold text-sm text-green-400" id="hud-scale">OPEN</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parking Finder Section -->
        <section id="section-parking" class="space-y-4">
            <!-- Location Search Bar -->
            <div class="bg-white rounded-2xl shadow-sm p-3 border border-slate-100">
                <div class="flex gap-2">
                    <div class="flex-grow relative">
                        <input type="text" id="location-search" placeholder="Enter zip code or city, state..."
                            class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-medium text-sm focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none focus:border-lmdr-yellow"
                            onkeypress="if(event.key === 'Enter') searchByLocation()">
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                    <button onclick="searchByLocation()"
                        class="bg-slate-900 text-white font-bold px-4 py-3 rounded-xl text-xs hover:bg-slate-800 transition-all">
                        <i class="fa-solid fa-search"></i>
                    </button>
                    <button onclick="useMyLocation()" id="my-location-btn"
                        class="bg-lmdr-yellow text-slate-900 font-bold px-4 py-3 rounded-xl text-xs hover:bg-lmdr-yellow-hover transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-location-crosshairs"></i>
                        <span class="hidden sm:inline">MY LOCATION</span>
                    </button>
                </div>
                <p id="location-status" class="text-[10px] text-slate-500 mt-2 hidden">
                    <i class="fa-solid fa-circle-info mr-1"></i>
                    <span id="location-status-text"></span>
                </p>
            </div>

            <!-- View Toggle -->
            <div class="flex justify-between items-center">
                <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Nearby Results</h2>
                <div class="bg-white rounded-lg border border-slate-200 p-1 flex">
                    <button id="view-list-btn" onclick="toggleView('list')"
                        class="px-3 py-1 text-xs font-bold rounded bg-slate-900 text-white">LIST</button>
                    <button id="view-map-btn" onclick="toggleView('map')"
                        class="px-3 py-1 text-xs font-bold rounded text-slate-500">MAP</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="parking-loading" class="hidden py-12 text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-lmdr-yellow mb-2"></i>
                <p class="text-sm text-slate-500 font-medium">Finding truck parking...</p>
            </div>

            <!-- Content Area (List and Map) -->
            <div class="relative min-h-[400px]">
                <!-- Results List -->
                <div id="parking-results" class="space-y-3">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Map Container -->
                <div id="parking-map-container"
                    class="hidden absolute inset-0 bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm min-h-[500px]">
                    <div id="map"></div>
                    <button onclick="searchThisArea()"
                        class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-white text-slate-900 font-black px-4 py-2 rounded-full text-xs shadow-xl border border-slate-200 hover:bg-slate-50 transition-all">
                        <i class="fa-solid fa-arrows-rotate mr-1"></i> SEARCH THIS AREA
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="parking-empty"
                class="hidden py-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i class="fa-solid fa-square-parking text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-slate-500 font-bold">No parking found in this area.</p>
            </div>
        </section>

        <!-- Fuel Optimizer Section (SIBLING of parking, not nested!) -->
        <section id="section-fuel" class="hidden space-y-4">
            <!-- Fuel Card Selector -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-wider">Your Fuel Card</h3>
                    <button onclick="openAddCardModal()" class="text-lmdr-blue font-bold text-xs">+ ADD NEW</button>
                </div>
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <div class="w-10 h-10 bg-slate-900 rounded-lg flex items-center justify-center text-white">
                        <i class="fa-solid fa-credit-card"></i>
                    </div>
                    <div class="flex-grow">
                        <select id="fuel-card-select" onchange="searchFuel()"
                            class="bg-transparent font-bold text-sm w-full focus:outline-none">
                            <option value="none">No Card (Retail Price)</option>
                            <option value="comdata" selected>Comdata (**** 4521)</option>
                            <option value="efs">EFS (**** 8892)</option>
                        </select>
                        <p class="text-[10px] text-slate-500 font-medium">Automatic discount applied to results</p>
                    </div>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <div class="flex gap-2 mb-4">
                    <div class="relative flex-grow">
                        <i class="fa-solid fa-gas-pump absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="fuel-search-input" placeholder="Search for cheapest diesel..."
                            class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-lmdr-yellow/50">
                    </div>
                    <button onclick="searchFuel()"
                        class="bg-lmdr-yellow text-slate-900 font-bold px-4 py-2 rounded-xl text-sm hover:shadow-md transition-all">
                        FIND FUEL
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 text-center">
                        <p class="text-[10px] font-black text-blue-400 uppercase">State Avg</p>
                        <p class="text-sm font-black text-blue-700">$3.89</p>
                    </div>
                    <div class="bg-green-50 border border-green-100 rounded-xl p-3 text-center">
                        <p class="text-[10px] font-black text-green-400 uppercase">Trend</p>
                        <p class="text-sm font-black text-green-700"><i class="fa-solid fa-caret-down mr-1"></i>
                            $0.02</p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="fuel-loading" class="hidden py-12 text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-lmdr-yellow mb-2"></i>
                <p class="text-sm text-slate-500 font-medium">Comparing diesel prices...</p>
            </div>

            <!-- Results List -->
            <div id="fuel-results" class="space-y-3">
                <!-- Cards will be injected here -->
            </div>

            <!-- Empty State -->
            <div id="fuel-empty"
                class="hidden py-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i class="fa-solid fa-gas-pump text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-slate-500 font-bold">No fuel prices found in this area.</p>
            </div>
        </section>

        <!-- Weigh Station Section (Phase 3) -->
        <section id="section-weighstation" class="hidden space-y-4">
            <!-- Bypass Service Selector -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-wider mb-3">Your Bypass Services
                </h3>
                <div class="flex gap-3">
                    <label
                        class="flex items-center gap-2 bg-slate-50 px-4 py-3 rounded-xl border border-slate-200 cursor-pointer hover:border-lmdr-yellow transition-all has-[:checked]:border-lmdr-yellow has-[:checked]:bg-yellow-50">
                        <input type="checkbox" id="prepass-checkbox" class="w-4 h-4 accent-lmdr-yellow"
                            onchange="saveBypassPreferences()">
                        <div
                            class="w-6 h-6 bg-green-500 rounded flex items-center justify-center text-white text-[10px] font-black">
                            P</div>
                        <span class="font-bold text-sm">PrePass</span>
                    </label>
                    <label
                        class="flex items-center gap-2 bg-slate-50 px-4 py-3 rounded-xl border border-slate-200 cursor-pointer hover:border-lmdr-yellow transition-all has-[:checked]:border-lmdr-yellow has-[:checked]:bg-yellow-50">
                        <input type="checkbox" id="drivewyze-checkbox" class="w-4 h-4 accent-lmdr-yellow"
                            onchange="saveBypassPreferences()">
                        <div
                            class="w-6 h-6 bg-blue-500 rounded flex items-center justify-center text-white text-[10px] font-black">
                            D</div>
                        <span class="font-bold text-sm">DriveWyze</span>
                    </label>
                </div>
                <p class="text-[10px] text-slate-500 mt-2">
                    <i class="fa-solid fa-circle-info mr-1"></i>
                    Select your bypass services to see bypass probability at each station
                </p>
            </div>

            <!-- Search Controls -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <div class="flex gap-2 mb-3">
                    <select id="weighstation-state"
                        class="flex-grow px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        <option value="">All States</option>
                        <option value="AL">Alabama</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="MD">Maryland</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select>
                    <button onclick="searchWeighStations()"
                        class="bg-lmdr-yellow text-slate-900 font-bold px-6 py-3 rounded-xl text-sm hover:shadow-md transition-all whitespace-nowrap">
                        <i class="fa-solid fa-magnifying-glass mr-1"></i> FIND SCALES
                    </button>
                </div>
                <button onclick="useMyLocationForScales()"
                    class="w-full bg-slate-900 text-white font-bold px-4 py-2 rounded-xl text-xs hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-location-crosshairs"></i>
                    USE MY LOCATION
                </button>
            </div>

            <!-- Status Legend -->
            <div class="flex flex-wrap gap-2 text-[10px] font-bold">
                <span class="bg-green-100 text-green-700 px-2.5 py-1.5 rounded-lg flex items-center gap-1">
                    <i class="fa-solid fa-circle-check"></i> OPEN
                </span>
                <span class="bg-red-100 text-red-700 px-2.5 py-1.5 rounded-lg flex items-center gap-1">
                    <i class="fa-solid fa-circle-xmark"></i> CLOSED
                </span>
                <span class="bg-yellow-100 text-yellow-700 px-2.5 py-1.5 rounded-lg flex items-center gap-1">
                    <i class="fa-solid fa-bolt"></i> BYPASS LIKELY
                </span>
                <span class="bg-slate-100 text-slate-500 px-2.5 py-1.5 rounded-lg flex items-center gap-1">
                    <i class="fa-solid fa-question"></i> UNKNOWN
                </span>
            </div>

            <!-- Loading State -->
            <div id="weighstation-loading" class="hidden py-12 text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-lmdr-yellow mb-2"></i>
                <p class="text-sm text-slate-500 font-medium">Finding weigh stations...</p>
            </div>

            <!-- Results List -->
            <div id="weighstation-results" class="space-y-3">
                <!-- Cards will be injected here -->
            </div>

            <!-- Empty State -->
            <div id="weighstation-empty"
                class="hidden py-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i class="fa-solid fa-scale-balanced text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-slate-500 font-bold">No weigh stations found in this area.</p>
                <p class="text-xs text-slate-400 mt-1">Try selecting a specific state or using your location.</p>
            </div>
        </section>

        <!-- Ratings Section (Phase 4) -->
        <section id="section-ratings" class="hidden space-y-4">
            <!-- Search & Filter -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-wider mb-3">Community Reviews</h3>
                <div class="flex gap-2">
                    <input type="text" id="ratings-search" placeholder="Search rest stops..."
                        class="flex-grow px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-medium text-sm focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                    <button onclick="searchReviews()"
                        class="bg-slate-900 text-white font-bold px-6 rounded-xl hover:bg-slate-800 transition-all">
                        SEARCH
                    </button>
                </div>
            </div>

            <!-- Recent Condition Reports -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-red-500 uppercase tracking-wider">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Active Alerts
                    </h3>
                    <button onclick="showRestStopReportModal()"
                        class="text-xs font-bold text-slate-500 hover:text-slate-900">+
                        REPORT ISSUE</button>
                </div>
                <div id="active-conditions-list" class="space-y-2">
                    <!-- Dynamic content -->
                    <div class="bg-red-50 border border-red-100 p-3 rounded-xl flex items-start gap-3">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-center min-w-[50px]">
                            <p class="text-[10px] font-black text-slate-400">I-75</p>
                            <p class="text-lg font-black text-slate-900">GA</p>
                        </div>
                        <div>
                            <p class="font-bold text-slate-900 text-sm">Georgia Welcome Center</p>
                            <p class="text-red-600 text-xs font-bold mt-1"><i class="fa-solid fa-ban mr-1"></i>Showers
                                Out of Order</p>
                            <p class="text-[10px] text-slate-400 mt-1">Reported 20m ago â€¢ 3 confirmations</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Rated Stops -->
            <h3 class="font-black text-slate-900 uppercase tracking-tight text-sm mt-6">Top Rated in Area</h3>
            <div id="top-rated-list" class="space-y-3">
                <!-- Loading State -->
                <div id="ratings-loading" class="py-8 text-center hidden">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl text-lmdr-yellow mb-2"></i>
                </div>
                <!-- Cards injected by JS -->
            </div>
        </section>

        <!-- Weather Section (Phase 5) -->
        <section id="section-weather" class="hidden space-y-4">
            <!-- Active Alerts -->
            <div id="weather-alerts-container" class="space-y-2">
                <!-- Alerts injected here -->
                <div class="bg-white rounded-2xl shadow-sm p-6 text-center border border-slate-100">
                    <i class="fa-solid fa-check-circle text-4xl text-green-500 mb-2"></i>
                    <p class="font-bold text-slate-900">No active severe weather alerts at your location.</p>
                    <p class="text-xs text-slate-500 mt-1">Updated just now</p>
                </div>
            </div>

            <!-- Chain Laws -->
            <h3 class="font-black text-slate-900 uppercase tracking-tight text-sm mt-6">Chain Laws (Mountain Passes)
            </h3>
            <div class="grid grid-cols-1 gap-3" id="chain-laws-list">
                <!-- Loading State -->
                <div class="bg-white rounded-xl p-4 animate-pulse">
                    <div class="h-4 bg-slate-200 rounded w-1/3 mb-2"></div>
                    <div class="h-3 bg-slate-100 rounded w-1/2"></div>
                </div>
            </div>

            <!-- Forecast -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100 mt-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-wider mb-3">Route Forecast</h3>
                <div class="flex items-center justify-center py-8 text-slate-400 text-sm">
                    <p><i class="fa-solid fa-route mr-2"></i> Route forecast available when navigating.</p>
                </div>
            </div>

            <button onclick="refreshWeather()"
                class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition-all">
                <i class="fa-solid fa-arrows-rotate mr-2"></i>REFRESH WEATHER
            </button>
        </section>

        <!-- Report Station Modal -->
        <div id="report-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="font-black text-xl text-slate-900">Report Station Status</h3>
                    <button onclick="closeReportModal()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <p id="report-station-name" class="text-sm text-slate-600 mb-4"></p>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Current Status</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="selectReportType('open')"
                                class="report-type-btn px-4 py-3 bg-green-50 border-2 border-green-200 rounded-xl text-green-700 font-bold hover:border-green-400 transition-all"
                                data-type="open">
                                <i class="fa-solid fa-circle-check mr-1"></i>OPEN
                            </button>
                            <button onclick="selectReportType('closed')"
                                class="report-type-btn px-4 py-3 bg-red-50 border-2 border-red-200 rounded-xl text-red-700 font-bold hover:border-red-400 transition-all"
                                data-type="closed">
                                <i class="fa-solid fa-circle-xmark mr-1"></i>CLOSED
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Wait Time
                            (optional)</label>
                        <select id="wait-time-select"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                            <option value="">Skip</option>
                            <option value="5">Quick (~5 min)</option>
                            <option value="15">Moderate (~15 min)</option>
                            <option value="30">Long (~30 min)</option>
                            <option value="60">Very Long (60+ min)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Additional Details
                            (optional)</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="toggleReportDetail('scales_only')"
                                class="report-detail-btn px-3 py-1.5 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 transition-all"
                                data-detail="scales_only">
                                Scales Only
                            </button>
                            <button onclick="toggleReportDetail('full_inspection')"
                                class="report-detail-btn px-3 py-1.5 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 transition-all"
                                data-detail="full_inspection">
                                Full Inspection
                            </button>
                            <button onclick="toggleReportDetail('bypass_working')"
                                class="report-detail-btn px-3 py-1.5 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 transition-all"
                                data-detail="bypass_working">
                                Bypass Working
                            </button>
                        </div>
                    </div>

                    <button onclick="submitStationReport()"
                        class="w-full bg-lmdr-yellow text-slate-900 font-black py-3 rounded-xl hover:shadow-lg transition-all">
                        <i class="fa-solid fa-paper-plane mr-2"></i>SUBMIT REPORT
                    </button>
                </div>
            </div>
        </div>

        <script>
            let map;
            let markers = [];
            let currentView = 'list';

            function initMap() {
                if (map) return;
                map = L.map('map').setView([35.1495, -90.0490], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
            }

            function toggleView(view) {
                currentView = view;
                const list = document.getElementById('parking-results');
                const mapContainer = document.getElementById('parking-map-container');
                const listBtn = document.getElementById('view-list-btn');
                const mapBtn = document.getElementById('view-map-btn');

                if (view === 'map') {
                    list.classList.add('hidden');
                    mapContainer.classList.remove('hidden');
                    listBtn.classList.remove('bg-slate-900', 'text-white');
                    listBtn.classList.add('text-slate-500');
                    mapBtn.classList.add('bg-slate-900', 'text-white');
                    mapBtn.classList.remove('text-slate-500');

                    setTimeout(() => {
                        initMap();
                        map.invalidateSize();
                    }, 100);
                } else {
                    list.classList.remove('hidden');
                    mapContainer.classList.add('hidden');
                    mapBtn.classList.remove('bg-slate-900', 'text-white');
                    mapBtn.classList.add('text-slate-500');
                    listBtn.classList.add('bg-slate-900', 'text-white');
                    listBtn.classList.remove('text-slate-500');
                }
            }

            function renderParkingResults(items) {
                const container = document.getElementById('parking-results');
                container.innerHTML = '';

                if (map) {
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];
                }

                if (!items || items.length === 0) {
                    container.classList.add('hidden');
                    document.getElementById('parking-empty').classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                document.getElementById('parking-empty').classList.add('hidden');

                items.forEach(item => {
                    // Render List Card
                    const statusColor = getStatusColor(item);
                    const dataSourceBadge = getDataSourceBadge(item);
                    const card = document.createElement('div');
                    card.className = 'parking-card opacity-0 translate-y-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:border-lmdr-yellow hover:shadow-md transition-all cursor-pointer';
                    card.onclick = () => showParkingDetails(JSON.stringify(item).replace(/"/g, '&quot;'));

                    card.innerHTML = `
                    <div class="p-4 sm:p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-black text-lg text-slate-900 group-hover:text-lmdr-blue transition-colors mb-1">${item.name}</h3>
                                <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
                                    <i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>
                                    ${(item.distance_miles || 0).toFixed(1)} MILES AWAY
                                </p>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border border-slate-200">
                                    ${item.total_spaces || '??'} SPOTS
                                </span>
                                <div class="${statusColor.bg} ${statusColor.text} px-2 py-1 rounded text-[10px] font-black uppercase">
                                    ${statusColor.label}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex-grow bg-gray-100 h-2 rounded-full overflow-hidden">
                                <div class="${statusColor.bar} h-full" style="width: ${item.total_spaces > 0 ? (item.available_spaces / item.total_spaces * 100) : 0}%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-700">${item.available_spaces ?? '?'} / ${item.total_spaces || '?'}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex gap-2 text-gray-400 text-sm">
                                ${renderAmenityIcons(item.amenities)}
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Distance</p>
                                <p class="text-sm font-black text-slate-900">${item.distance_miles} mi</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 flex gap-2">
                        <button onclick="navigate('${item.location.lat}', '${item.location.lng}')" class="flex-grow bg-slate-900 text-white font-bold py-2 rounded-lg text-xs hover:bg-slate-800 transition-all">NAVIGATE</button>
                        <button onclick="showDetails('${item._id}')" class="bg-white border border-slate-200 text-slate-700 font-bold px-4 py-2 rounded-lg text-xs hover:bg-gray-50 transition-all">DETAILS</button>
                    </div>
                `;
                    container.appendChild(card);

                    // Add Marker to Map
                    if (map) {
                        const marker = L.circleMarker([item.location.lat, item.location.lng], {
                            radius: 8,
                            fillColor: statusColor.hex,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);

                        marker.bindPopup(`<b>${item.name}</b><br>${item.available_spaces} spaces available`);
                        markers.push(marker);
                    }
                }); // End forEach

                // GSAP Stagger Animation
                gsap.to(".parking-card", {
                    opacity: 1,
                    y: 0,
                    duration: 0.5,
                    stagger: 0.05,
                    ease: "power2.out"
                });

                if (map && items.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            function getStatusColor(item) {
                const ratio = item.available_spaces / item.total_spaces;
                if (item.available_spaces === 0) return { bg: 'bg-red-100', text: 'text-red-700', bar: 'bg-red-500', hex: '#ef4444', label: 'Full' };
                if (ratio < 0.1 || item.available_spaces < 5) return { bg: 'bg-yellow-100', text: 'text-yellow-700', bar: 'bg-yellow-500', hex: '#eab308', label: 'Limited' };
                return { bg: 'bg-green-100', text: 'text-green-700', bar: 'bg-green-500', hex: '#22c55e', label: 'Available' };
            }

            function getDataSourceBadge(item) {
                // Show badge indicating data source reliability
                if (item.data_confidence === 'sensor') {
                    return `<span class="bg-blue-100 text-blue-700 text-[9px] font-black px-1.5 py-0.5 rounded uppercase" title="Real-time sensor data from TPIMS">
                    <i class="fa-solid fa-signal mr-0.5"></i>LIVE
                </span>`;
                }
                if (item.data_confidence === 'reported') {
                    return `<span class="bg-purple-100 text-purple-700 text-[9px] font-black px-1.5 py-0.5 rounded uppercase" title="Reported by drivers">
                    <i class="fa-solid fa-users mr-0.5"></i>REPORTED
                </span>`;
                }
                if (item.source_label) {
                    return `<span class="bg-slate-100 text-slate-500 text-[9px] font-medium px-1.5 py-0.5 rounded">${item.source_label}</span>`;
                }
                return '';
            }

            function navigate(lat, lng) {
                // Open in Google Maps or Apple Maps based on device
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const url = isIOS
                    ? `maps://maps.apple.com/?daddr=${lat},${lng}`
                    : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(url, '_blank');
            }

            function showDetails(locationId) {
                if (!locationId) return;
                window.parent.postMessage({
                    type: 'getParkingDetails',
                    data: { locationId }
                }, '*');
            }

            function renderAmenityIcons(amenities) {
                if (!amenities) return '';
                const map = {
                    'shower': 'fa-shower',
                    'wifi': 'fa-wifi',
                    'food': 'fa-utensils',
                    'fuel': 'fa-gas-pump'
                };
                return amenities.map(a => `<i class="fa-solid ${map[a] || 'fa-circle-info'}"></i>`).join('');
            }

            function searchThisArea() {
                const center = map.getCenter();
                const bounds = map.getBounds();
                const radius = map.distance(center, bounds.getNorthWest()) / 1609.34; // meters to miles

                document.getElementById('parking-loading').classList.remove('hidden');
                window.parent.postMessage({
                    type: 'searchParking',
                    data: { lat: center.lat, lng: center.lng, radius: radius }
                }, '*');
            }

            // ==========================================
            // LOCATION SEARCH & GEOLOCATION
            // ==========================================
            function showLocationStatus(message, isError = false) {
                const statusEl = document.getElementById('location-status');
                const textEl = document.getElementById('location-status-text');
                statusEl.classList.remove('hidden', 'text-red-500', 'text-green-600', 'text-slate-500');
                statusEl.classList.add(isError ? 'text-red-500' : 'text-green-600');
                textEl.textContent = message;

                // Auto-hide success messages after 5 seconds
                if (!isError) {
                    setTimeout(() => statusEl.classList.add('hidden'), 5000);
                }
            }

            // ==========================================
            // CONDITIONS FUNCTIONS (Phase 6)
            // ==========================================
            function refreshConditions() {
                const list = document.getElementById('conditions-list');
                list.innerHTML = '<div class="text-center py-8 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><p>Checking road conditions...</p></div>';

                // Get route from HUD or input (mocked for now)
                let routePoints = [{ lat: 39.31, lng: -120.33 }]; // Donner Pass

                // Demo Mode Override (Iowa)
                if (window.demoMode === 'IA') {
                    routePoints = [{ lat: 41.6, lng: -93.6 }, { lat: 42.0, lng: -93.6 }]; // Des Moines
                }

                // Send request
                window.parent.postMessage({
                    type: 'getRoadConditions',
                    data: { routePoints }
                }, '*');

                // Standalone mock
                if (window.parent === window) {
                    setTimeout(() => {
                        const mockData = {
                            conditions: [
                                { type: 'closure', highway: 'I-80', location: { lat: 0, lng: 0 }, description: 'Westbound closed due to spin-outs.', severity: 'major', delay_minutes: 120 },
                                { type: 'construction', highway: 'I-5', location: { lat: 0, lng: 0 }, description: 'Bridge work. 1 lane open.', severity: 'moderate', delay_minutes: 20 }
                            ],
                            summary: { total_incidents: 2, total_delay_minutes: 140, counts: { closure: 1, construction: 1 } }
                        };
                        renderConditions(mockData.conditions);
                        renderConditionSummary(mockData.summary);
                    }, 800);
                }
            }

            function renderConditions(conditions) {
                const container = document.getElementById('conditions-list');
                container.innerHTML = '';

                // Demo Button
                const demoBtn = document.createElement('div');
                demoBtn.className = 'flex justify-center mb-4';
                demoBtn.innerHTML = `<button onclick="window.demoMode='IA'; refreshConditions();" class="text-xs border border-slate-200 text-slate-500 hover:text-lmdr-blue px-3 py-1 rounded-full transition-colors"><i class="fa-solid fa-bolt mr-1"></i> Live Demo: Iowa Open Data</button>`;
                container.appendChild(demoBtn);

                if (!conditions || conditions.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl p-8 text-center border border-slate-100">
                             <i class="fa-solid fa-check-circle text-4xl text-green-500 mb-4"></i>
                             <p class="font-bold text-slate-900">Roads Clear</p>
                             <p class="text-xs text-slate-400 mt-1">No incidents reported on your route.</p>
                        </div>
                    `;
                    return;
                }

                conditions.forEach(cond => {
                    const style = getConditionStyle(cond.type, cond.severity);
                    const card = document.createElement('div');
                    card.className = `bg-white rounded-2xl shadow-sm border border-slate-100 p-4 relative overflow-hidden group hover:border-${style.color} transition-all`;
                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-1 h-full bg-${style.color}"></div>
                        <div class="pl-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="bg-${style.bg} text-${style.color} w-8 h-8 rounded-lg flex items-center justify-center text-sm">
                                        <i class="fa-solid ${style.icon}"></i>
                                    </span>
                                    <div>
                                        <h3 class="font-black text-slate-900 text-sm">${cond.highway} ${cond.type.toUpperCase()}</h3>
                                        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">${cond.severity}</p>
                                    </div>
                                </div>
                                ${cond.delay_minutes ? `<span class="bg-red-50 text-red-600 px-2 py-1 rounded text-[10px] font-bold">+${cond.delay_minutes} MIN</span>` : ''}
                            </div>
                            <p class="text-sm text-slate-600 font-medium leading-relaxed">${cond.description}</p>
                            <p class="text-xs text-slate-400 mt-2 flex items-center gap-1">
                                <i class="fa-regular fa-clock"></i> Expires: ${new Date(cond.expected_end || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function renderConditionSummary(summary) {
                if (!summary) return;
                document.getElementById('stat-incidents').textContent = summary.total_incidents || 0;
                document.getElementById('stat-construction').textContent = summary.counts?.construction || 0;
                document.getElementById('stat-closures').textContent = summary.counts?.closure || 0;
                document.getElementById('stat-delay').textContent = (summary.total_delay_minutes || 0) + 'm';
            }

            function getConditionStyle(type, severity) {
                switch (type) {
                    case 'closure': return { icon: 'fa-road-barrier', color: 'red-500', bg: 'red-100' };
                    case 'accident': return { icon: 'fa-car-burst', color: 'orange-500', bg: 'orange-100' };
                    case 'construction': return { icon: 'fa-person-digging', color: 'lmdr-yellow', bg: 'yellow-100' };
                    case 'weather': return { icon: 'fa-snowflake', color: 'blue-500', bg: 'blue-100' };
                    default: return { icon: 'fa-triangle-exclamation', color: 'slate-500', bg: 'slate-100' };
                }
            }

            async function searchByLocation() {
                const input = document.getElementById('location-search').value.trim();
                if (!input) {
                    showLocationStatus('Please enter a zip code or city, state', true);
                    return;
                }

                showLocationStatus('Searching for location...');

                try {
                    // Use Nominatim (OpenStreetMap) for free geocoding
                    const query = encodeURIComponent(input + ', USA');
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1&countrycodes=us`,
                        { headers: { 'Accept': 'application/json' } }
                    );

                    const results = await response.json();

                    if (!results || results.length === 0) {
                        showLocationStatus('Location not found. Try a different zip code or city.', true);
                        return;
                    }

                    const { lat, lon, display_name } = results[0];
                    const latitude = parseFloat(lat);
                    const longitude = parseFloat(lon);

                    // Short name for display (first 2-3 parts)
                    const shortName = display_name.split(',').slice(0, 2).join(',').trim();
                    showLocationStatus(`Found: ${shortName}`);

                    // Pan map and search
                    goToLocationAndSearch(latitude, longitude, 25);

                } catch (error) {
                    console.error('Geocoding error:', error);
                    showLocationStatus('Error searching location. Please try again.', true);
                }
            }

            function useMyLocation() {
                const btn = document.getElementById('my-location-btn');
                const originalContent = btn.innerHTML;

                if (!navigator.geolocation) {
                    showLocationStatus('Geolocation is not supported by your browser', true);
                    return;
                }

                // Show loading state
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
                btn.disabled = true;
                showLocationStatus('Getting your location...');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        showLocationStatus('Location found! Searching nearby parking...');

                        // Update input with approximate location
                        document.getElementById('location-search').value = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;

                        // Pan map and search
                        goToLocationAndSearch(latitude, longitude, 25);

                        // Reset button
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    },
                    (error) => {
                        let message = 'Unable to get your location. ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Location access was denied.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Location unavailable.';
                                break;
                            case error.TIMEOUT:
                                message += 'Request timed out.';
                                break;
                            default:
                                message += 'Please try entering a zip code instead.';
                        }
                        showLocationStatus(message, true);

                        // Reset button
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000 // Cache for 5 minutes
                    }
                );
            }

            function goToLocationAndSearch(lat, lng, radius = 25) {
                // Initialize map if needed
                if (!map) {
                    initMap();
                }

                // Switch to map view
                toggleView('map');

                // Pan to location with animation
                setTimeout(() => {
                    map.setView([lat, lng], 10, { animate: true });
                    map.invalidateSize();

                    // Auto-search after pan completes
                    setTimeout(() => {
                        searchThisArea();
                    }, 500);
                }, 200);
            }

            // ==========================================
            // TAB NAVIGATION
            // ==========================================

            let currentTab = 'dashboard';

            function switchTab(tabId) {
                // List of all tabs
                const tabs = ['dashboard', 'parking', 'fuel', 'weighstation', 'ratings', 'weather', 'conditions'];

                tabs.forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    const section = document.getElementById(`section-${t}`);

                    if (t === tabId) {
                        // Active Style: White bg, shadow
                        if (btn) {
                            btn.className = 'flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all bg-white shadow-sm text-slate-900 ring-1 ring-black/5';
                        }
                        if (section) section.classList.remove('hidden');

                        // Tab Specific Init
                        if (tabId === 'dashboard') initDashboard();
                        if (tabId === 'parking' && map) setTimeout(() => map.invalidateSize(), 100);
                        if (tabId === 'fuel' && !fuelDataLoaded) searchFuel();
                        if (tabId === 'weighstation' && !weighStationDataLoaded) searchWeighStations();
                        if (tabId === 'ratings') loadTopRated();
                        if (tabId === 'weather') refreshWeather();
                        if (tabId === 'conditions') refreshConditions();

                    } else {
                        // Inactive Style
                        if (btn) {
                            btn.className = 'flex-1 py-2.5 px-3 min-w-[80px] text-center font-black text-xs uppercase tracking-wider rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50';
                        }
                        if (section) section.classList.add('hidden');
                    }
                });

                currentTab = tabId;

                // Animate Section Entrance
                const activeSection = document.getElementById(`section-${tabId}`);
                if (activeSection) {
                    gsap.fromTo(activeSection,
                        { opacity: 0, y: 10 },
                        { opacity: 1, y: 0, duration: 0.3, ease: 'power2.out' }
                    );
                }

                if (window.parent) {
                    window.parent.postMessage({ type: 'tabChanged', data: tabId }, '*');
                }
            }

            function initDashboard() {
                // Simulate loading dashboard data
                setTimeout(() => {
                    const die = document.getElementById('dash-diesel-price');
                    if (die) die.innerHTML = '$3.45';

                    const dist = document.getElementById('dash-parking-dist');
                    if (dist) dist.innerHTML = '2.4 mi';

                    const status = document.getElementById('dash-parking-status');
                    if (status) status.innerHTML = '12 SPOTS LEFT';

                    const loc = document.getElementById('dash-diesel-loc');
                    if (loc) loc.innerHTML = 'Speedway (1.2mi)';
                }, 500);

                renderRecentActivity();
            }

            function renderRecentActivity() {
                const activityDiv = document.getElementById('dash-recent-activity');
                if (!activityDiv) return;

                // For now, mock some data or read from localStorage
                let recent = [];
                try {
                    recent = JSON.parse(localStorage.getItem('lmdr_recent_activity') || '[]');
                } catch (e) { console.error('Error reading recent activity', e); }

                if (recent.length === 0) {
                    // Add some mock data for the demo if empty
                    const mockData = [
                        { type: 'parking', icon: 'fa-square-parking', color: 'text-lmdr-yellow', text: 'Checked parking in Memphis, TN', time: '10 mins ago' },
                        { type: 'fuel', icon: 'fa-gas-pump', color: 'text-blue-500', text: 'Found diesel at $3.45/gal', time: '2 hours ago' }
                    ];
                    // Only save if specific demo flag or just display mock without saving to persist empty state
                    recent = mockData;
                }

                activityDiv.innerHTML = recent.map(item => `
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg transition-colors cursor-pointer">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center ${item.color || 'text-slate-500'}">
                            <i class="fa-solid ${item.icon || 'fa-circle-info'}"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="text-xs font-bold text-slate-900">${item.text}</p>
                            <p class="text-[10px] text-slate-400">${item.time}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xs text-slate-300"></i>
                    </div>
                `).join('');
            }

            function planRoute() {
                const input = document.getElementById('dash-route-input');
                if (!input || !input.value) return;

                // Save intent or pass data (mocking the handoff)
                console.log('Planning route to:', input.value);

                // Switch to conditions
                switchTab('conditions');

                // Trigger search logic on next tick if needed, or save to 'recent'
                const newActivity = {
                    type: 'route',
                    icon: 'fa-route',
                    color: 'text-red-500',
                    text: `Planned route to ${input.value}`,
                    time: 'Just now'
                };

                try {
                    const recent = JSON.parse(localStorage.getItem('lmdr_recent_activity') || '[]');
                    recent.unshift(newActivity);
                    if (recent.length > 5) recent.pop();
                    localStorage.setItem('lmdr_recent_activity', JSON.stringify(recent));
                } catch (e) { }
            }

            // ==========================================
            // FUEL OPTIMIZER FUNCTIONS
            // ==========================================
            let fuelDataLoaded = false;
            let fuelMarkers = [];
            let driverFuelCards = [];
            let currentFuelResults = [];

            function searchFuel() {
                const loadingEl = document.getElementById('fuel-loading');
                const resultsEl = document.getElementById('fuel-results');
                const emptyEl = document.getElementById('fuel-empty');

                loadingEl.classList.remove('hidden');
                resultsEl.innerHTML = '';
                emptyEl.classList.add('hidden');

                const selectedCard = document.getElementById('fuel-card-select').value;
                const searchQuery = document.getElementById('fuel-search-input').value;

                // Get current location or use default
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            window.parent.postMessage({
                                type: 'searchFuel',
                                data: {
                                    lat: pos.coords.latitude,
                                    lng: pos.coords.longitude,
                                    radius: 50,
                                    fuelCardType: selectedCard,
                                    query: searchQuery
                                }
                            }, '*');
                        },
                        () => {
                            // Default to Memphis if location denied
                            window.parent.postMessage({
                                type: 'searchFuel',
                                data: {
                                    lat: 35.1495,
                                    lng: -90.0490,
                                    radius: 50,
                                    fuelCardType: selectedCard,
                                    query: searchQuery
                                }
                            }, '*');
                        }
                    );
                } else {
                    window.parent.postMessage({
                        type: 'searchFuel',
                        data: {
                            lat: 35.1495,
                            lng: -90.0490,
                            radius: 50,
                            fuelCardType: selectedCard,
                            query: searchQuery
                        }
                    }, '*');
                }
            }

            function renderFuelResults(items) {
                console.log('[HTML] renderFuelResults called with:', items?.length, 'items', items);
                fuelDataLoaded = true;
                currentFuelResults = items;

                const loadingEl = document.getElementById('fuel-loading');
                const resultsEl = document.getElementById('fuel-results');
                const emptyEl = document.getElementById('fuel-empty');

                console.log('[HTML] Elements found:', { loadingEl: !!loadingEl, resultsEl: !!resultsEl, emptyEl: !!emptyEl });

                loadingEl.classList.add('hidden');

                if (!items || items.length === 0) {
                    console.log('[HTML] No items, showing empty state');
                    resultsEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                    return;
                }

                emptyEl.classList.add('hidden');
                resultsEl.innerHTML = '';

                items.forEach((station, index) => {
                    const savingsClass = station.savings > 0 ? 'text-green-600' : 'text-slate-500';
                    const savingsText = station.savings > 0 ? `-$${station.savings.toFixed(2)}/gal` : 'Retail';
                    const priceColor = index === 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-700';

                    const card = document.createElement('div');
                    card.className = 'fuel-card opacity-0 translate-y-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:border-lmdr-yellow transition-all';
                    card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    ${index === 0 ? '<span class="bg-lmdr-yellow text-slate-900 text-[10px] font-black px-2 py-0.5 rounded uppercase">Best Price</span>' : ''}
                                    <span class="text-[10px] font-bold text-slate-400 uppercase">${station.brand || 'Independent'}</span>
                                </div>
                                <h3 class="font-black text-slate-900 group-hover:text-lmdr-blue transition-colors">${station.name}</h3>
                                <p class="text-xs text-slate-500">${typeof station.address === 'object' ? `${station.address.street}, ${station.address.city}` : (station.address || '')}</p>
                            </div>
                            <div class="text-right">
                                <p class="${priceColor} px-3 py-2 rounded-xl text-lg font-black">$${station.diesel_price.toFixed(2)}</p>
                                <p class="${savingsClass} text-[10px] font-bold mt-1">${savingsText}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-xs">
                            <div class="flex items-center gap-1 text-slate-500">
                                <i class="fa-solid fa-location-dot"></i>
                                <span class="font-bold">${station.distance_miles?.toFixed(1) || '?'} mi</span>
                            </div>
                            ${station.has_def ? '<div class="flex items-center gap-1 text-blue-500"><i class="fa-solid fa-droplet"></i><span class="font-bold">DEF</span></div>' : ''}
                            ${station.has_scales ? '<div class="flex items-center gap-1 text-purple-500"><i class="fa-solid fa-weight-scale"></i><span class="font-bold">Scales</span></div>' : ''}
                            ${station.accepts_card ? `<div class="flex items-center gap-1 text-green-500"><i class="fa-solid fa-credit-card"></i><span class="font-bold">${station.card_type || 'Card'}</span></div>` : ''}
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 flex gap-2">
                        <button onclick="navigateToFuel('${station.location?.lat}', '${station.location?.lng}')" class="flex-grow bg-slate-900 text-white font-bold py-2 rounded-lg text-xs hover:bg-slate-800 transition-all">
                            <i class="fa-solid fa-diamond-turn-right mr-1"></i> NAVIGATE
                        </button>
                        <button onclick="calculateRouteSavings('${station._id}')" class="bg-lmdr-yellow text-slate-900 font-bold px-4 py-2 rounded-lg text-xs hover:shadow-md transition-all">
                            <i class="fa-solid fa-calculator mr-1"></i> SAVINGS
                        </button>
                    </div>
                `;
                    resultsEl.appendChild(card);
                });

                console.log('[HTML] Created', resultsEl.children.length, 'fuel cards');

                // GSAP Stagger Animation for fuel results
                gsap.to(".fuel-card", {
                    opacity: 1,
                    y: 0,
                    duration: 0.5,
                    stagger: 0.05,
                    ease: "power2.out"
                });

                // Update fuel map markers if map is initialized
                updateFuelMarkers(items);
            }

            function updateFuelMarkers(items) {
                if (!map) return;

                // Clear existing fuel markers
                fuelMarkers.forEach(m => map.removeLayer(m));
                fuelMarkers = [];

                items.forEach((station, index) => {
                    if (!station.location) return;

                    const color = index === 0 ? '#22c55e' : '#3b82f6';
                    const marker = L.circleMarker([station.location.lat, station.location.lng], {
                        radius: index === 0 ? 12 : 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);

                    marker.bindPopup(`
                    <b>${station.name}</b><br>
                    <span style="font-size: 18px; font-weight: bold; color: ${index === 0 ? '#16a34a' : '#1e40af'}">$${station.diesel_price.toFixed(2)}</span><br>
                    <small>${station.distance_miles?.toFixed(1)} miles away</small>
                `);
                    fuelMarkers.push(marker);
                });
            }

            function navigateToFuel(lat, lng) {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
            }

            function calculateRouteSavings(stationId) {
                const station = currentFuelResults.find(s => s._id === stationId);
                if (!station) return;

                // Show savings modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                modal.id = 'savings-modal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-black text-xl text-slate-900">Fuel Savings Calculator</h3>
                        <button onclick="document.getElementById('savings-modal').remove()" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <p class="text-xs font-black text-green-500 uppercase mb-1">Selected Station</p>
                            <p class="font-bold text-slate-900">${station.name}</p>
                            <p class="text-2xl font-black text-green-700">$${station.diesel_price.toFixed(2)}/gal</p>
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Gallons Needed</label>
                            <input type="number" id="gallons-input" value="100" min="1" max="500" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-50 rounded-xl p-3">
                                <p class="text-[10px] font-black text-slate-400 uppercase">State Avg</p>
                                <p class="text-lg font-black text-slate-700">$3.89/gal</p>
                            </div>
                            <div class="bg-green-50 rounded-xl p-3">
                                <p class="text-[10px] font-black text-green-500 uppercase">You Save</p>
                                <p class="text-lg font-black text-green-700" id="savings-display">$${((3.89 - station.diesel_price) * 100).toFixed(2)}</p>
                            </div>
                        </div>
                        <button onclick="navigateToFuel('${station.location?.lat}', '${station.location?.lng}')" class="w-full bg-lmdr-yellow text-slate-900 font-black py-3 rounded-xl hover:shadow-lg transition-all">
                            <i class="fa-solid fa-diamond-turn-right mr-2"></i>NAVIGATE TO STATION
                        </button>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                // GSAP Modal Animation
                gsap.fromTo(modal.firstElementChild,
                    { scale: 0.9, opacity: 0 },
                    { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
                );

                // Update savings on input change
                const gallonsInput = document.getElementById('gallons-input');
                const savingsDisplay = document.getElementById('savings-display');
                gallonsInput.addEventListener('input', () => {
                    const gallons = parseFloat(gallonsInput.value) || 0;
                    const savings = (3.89 - station.diesel_price) * gallons;
                    savingsDisplay.textContent = `$${savings.toFixed(2)}`;
                });
            }

            function openAddCardModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                modal.id = 'add-card-modal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-black text-xl text-slate-900">Add Fuel Card</h3>
                        <button onclick="document.getElementById('add-card-modal').remove()" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Card Provider</label>
                            <select id="card-provider" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                                <option value="comdata">Comdata</option>
                                <option value="efs">EFS (Electronic Funds Source)</option>
                                <option value="tchek">T-Chek</option>
                                <option value="fleetone">Fleet One</option>
                                <option value="wex">WEX</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Card Number (Last 4 Digits)</label>
                            <input type="text" id="card-last4" maxlength="4" pattern="[0-9]{4}" placeholder="1234" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg tracking-widest focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Nickname (Optional)</label>
                            <input type="text" id="card-nickname" placeholder="My Fleet Card" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-3">
                            <p class="text-xs text-blue-700"><i class="fa-solid fa-info-circle mr-1"></i> Adding your fuel card lets us show you discounted prices at participating locations.</p>
                        </div>
                        <button onclick="submitFuelCard()" class="w-full bg-lmdr-yellow text-slate-900 font-black py-3 rounded-xl hover:shadow-lg transition-all">
                            <i class="fa-solid fa-plus mr-2"></i>ADD CARD
                        </button>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                // GSAP Modal Animation
                gsap.fromTo(modal.firstElementChild,
                    { scale: 0.9, opacity: 0 },
                    { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
                );
            }

            function submitFuelCard() {
                const provider = document.getElementById('card-provider').value;
                const last4 = document.getElementById('card-last4').value;
                const nickname = document.getElementById('card-nickname').value;

                if (!last4 || last4.length !== 4) {
                    alert('Please enter the last 4 digits of your card.');
                    return;
                }

                window.parent.postMessage({
                    type: 'linkFuelCard',
                    data: {
                        cardType: provider,
                        cardLast4: last4,
                        nickname: nickname || `${provider.charAt(0).toUpperCase() + provider.slice(1)} Card`
                    }
                }, '*');

                // Close modal and update dropdown
                document.getElementById('add-card-modal').remove();

                // Add to dropdown
                const select = document.getElementById('fuel-card-select');
                const option = document.createElement('option');
                option.value = provider;
                option.textContent = `${provider.charAt(0).toUpperCase() + provider.slice(1)} (**** ${last4})`;
                option.selected = true;
                select.appendChild(option);

                // Re-search with new card
                searchFuel();
            }

            function loadDriverFuelCards() {
                window.parent.postMessage({ type: 'getDriverFuelCards' }, '*');
            }

            function updateFuelCardDropdown(cards) {
                driverFuelCards = cards || [];
                const select = document.getElementById('fuel-card-select');

                // Keep the "No Card" option
                select.innerHTML = '<option value="none">No Card (Retail Price)</option>';

                cards.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.card_type;
                    option.textContent = `${card.nickname || card.card_type} (**** ${card.card_last4})`;
                    select.appendChild(option);
                });

                // Select first card if available
                if (cards.length > 0) {
                    select.value = cards[0].card_type;
                }
            }

            // ==========================================
            // WEIGH STATION FUNCTIONS (Phase 3)
            // ==========================================
            let weighStationDataLoaded = false;
            let currentWeighStationResults = [];
            let currentReportStationId = null;
            let selectedReportType = null;
            let selectedReportDetails = [];
            let driverBypassServices = { prepass: false, drivewyze: false };

            function searchWeighStations() {
                const loadingEl = document.getElementById('weighstation-loading');
                const resultsEl = document.getElementById('weighstation-results');
                const emptyEl = document.getElementById('weighstation-empty');

                loadingEl.classList.remove('hidden');
                resultsEl.innerHTML = '';
                emptyEl.classList.add('hidden');

                const state = document.getElementById('weighstation-state').value;
                const prepass = document.getElementById('prepass-checkbox').checked;
                const drivewyze = document.getElementById('drivewyze-checkbox').checked;

                // Get current location or use default
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            sendWeighStationSearch(pos.coords.latitude, pos.coords.longitude, state, { prepass, drivewyze });
                        },
                        () => {
                            // Default to Memphis if location denied
                            sendWeighStationSearch(35.1495, -90.0490, state, { prepass, drivewyze });
                        }
                    );
                } else {
                    sendWeighStationSearch(35.1495, -90.0490, state, { prepass, drivewyze });
                }
            }

            function sendWeighStationSearch(lat, lng, state, bypassServices) {
                window.parent.postMessage({
                    type: 'searchWeighStations',
                    data: { lat, lng, radius: 100, state, bypassServices }
                }, '*');
            }

            function useMyLocationForScales() {
                const loadingEl = document.getElementById('weighstation-loading');

                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser');
                    return;
                }

                loadingEl.classList.remove('hidden');

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const state = document.getElementById('weighstation-state').value;
                        const prepass = document.getElementById('prepass-checkbox').checked;
                        const drivewyze = document.getElementById('drivewyze-checkbox').checked;
                        sendWeighStationSearch(pos.coords.latitude, pos.coords.longitude, state, { prepass, drivewyze });
                    },
                    (error) => {
                        loadingEl.classList.add('hidden');
                        alert('Unable to get your location. Please try selecting a state instead.');
                    },
                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
                );
            }

            function renderWeighStationResults(items) {
                weighStationDataLoaded = true;
                currentWeighStationResults = items || [];

                const loadingEl = document.getElementById('weighstation-loading');
                const resultsEl = document.getElementById('weighstation-results');
                const emptyEl = document.getElementById('weighstation-empty');

                loadingEl.classList.add('hidden');

                if (!items || items.length === 0) {
                    resultsEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                    return;
                }

                emptyEl.classList.add('hidden');
                resultsEl.innerHTML = '';

                const prepassEnabled = document.getElementById('prepass-checkbox').checked;
                const drivewyzeEnabled = document.getElementById('drivewyze-checkbox').checked;

                items.forEach((station, index) => {
                    const statusInfo = getStationStatusInfo(station);
                    const bypassInfo = getBypassInfo(station, prepassEnabled, drivewyzeEnabled);

                    const card = document.createElement('div');
                    card.className = 'weighstation-card opacity-0 translate-y-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:border-lmdr-yellow hover:shadow-md transition-all';
                    card.innerHTML = `
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-grow">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h3 class="font-black text-slate-900 group-hover:text-lmdr-blue transition-colors">${station.name}</h3>
                                            ${getConfidenceBadge(station.status_confidence)}
                                        </div>
                                        <p class="text-xs text-slate-500">
                                            ${station.highway || ''} ${station.direction || ''}
                                            ${station.mile_marker ? 'â€¢ MM ' + station.mile_marker : ''}
                                            ${station.state ? 'â€¢ ' + station.state : ''}
                                        </p>
                                    </div>
                                    <div class="${statusInfo.bg} ${statusInfo.text} px-3 py-1.5 rounded-lg text-xs font-black uppercase">
                                        ${statusInfo.label}
                                    </div>
                                </div>

                                <!-- Bypass Probability -->
                                ${bypassInfo}

                                <!-- Wait Time Estimate -->
                                ${station.wait_estimate ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 mb-3 text-xs">
                                        <i class="fa-solid fa-clock text-yellow-600 mr-1"></i>
                                        <span class="font-bold text-yellow-800">Est. wait: ${station.wait_estimate} min</span>
                                        ${station.report_count ? `<span class="text-yellow-600 ml-2">(${station.report_count} reports)</span>` : ''}
                                    </div>
                                ` : ''}

                                <!-- Distance -->
                                <div class="flex items-center justify-between text-xs">
                                    <div class="flex items-center gap-1 text-slate-500">
                                        <i class="fa-solid fa-location-dot"></i>
                                        <span class="font-bold">${station.distance_miles?.toFixed(1) || '?'} mi away</span>
                                    </div>
                                    ${station.last_status_update ? `
                                        <span class="text-slate-400">
                                            Updated ${formatTimeAgo(station.last_status_update)}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="bg-slate-50 px-4 py-3 flex gap-2">
                                <button onclick="navigateToStation('${station.location?.lat}', '${station.location?.lng}')"
                                    class="flex-grow bg-slate-900 text-white font-bold py-2 rounded-lg text-xs hover:bg-slate-800 transition-all">
                                    <i class="fa-solid fa-diamond-turn-right mr-1"></i> NAVIGATE
                                </button>
                                <button onclick="openReportModal('${station._id}', '${escapeHtml(station.name)}')"
                                    class="bg-lmdr-yellow text-slate-900 font-bold px-4 py-2 rounded-lg text-xs hover:shadow-md transition-all">
                                    <i class="fa-solid fa-bullhorn mr-1"></i>REPORT
                                </button>
                            </div>
                        `;
                    resultsEl.appendChild(card);
                });

                // GSAP Stagger Animation
                gsap.to(".weighstation-card", {
                    opacity: 1,
                    y: 0,
                    duration: 0.5,
                    stagger: 0.05,
                    ease: "power2.out"
                });
            }

            function getStationStatusInfo(station) {
                const status = station.status?.toLowerCase() || 'unknown';
                switch (status) {
                    case 'open':
                        return { bg: 'bg-green-100', text: 'text-green-700', label: 'Open' };
                    case 'closed':
                        return { bg: 'bg-red-100', text: 'text-red-700', label: 'Closed' };
                    default:
                        return { bg: 'bg-slate-100', text: 'text-slate-500', label: 'Unknown' };
                }
            }

            function getConfidenceBadge(confidence) {
                switch (confidence) {
                    case 'sensor':
                        return `<span class="bg-blue-100 text-blue-700 text-[9px] font-black px-1.5 py-0.5 rounded uppercase" title="Real-time sensor data">
                                <i class="fa-solid fa-signal mr-0.5"></i>LIVE
                            </span>`;
                    case 'reported':
                        return `<span class="bg-purple-100 text-purple-700 text-[9px] font-black px-1.5 py-0.5 rounded uppercase" title="Reported by drivers">
                                <i class="fa-solid fa-users mr-0.5"></i>REPORTED
                            </span>`;
                    case 'historical':
                        return `<span class="bg-slate-100 text-slate-500 text-[9px] font-medium px-1.5 py-0.5 rounded" title="Based on typical hours">
                                <i class="fa-solid fa-clock mr-0.5"></i>HISTORICAL
                            </span>`;
                    default:
                        return '';
                }
            }

            function getBypassInfo(station, prepassEnabled, drivewyzeEnabled) {
                const badges = [];

                if (station.prepass_enabled) {
                    const rate = station.prepass_bypass_rate || 0;
                    const active = prepassEnabled;
                    badges.push(`
                            <div class="flex items-center gap-1.5 text-xs ${active ? '' : 'opacity-50'}">
                                <span class="w-6 h-6 bg-green-500 text-white rounded flex items-center justify-center text-[10px] font-black">P</span>
                                <span class="font-bold ${active ? 'text-green-700' : 'text-slate-500'}">${rate}% bypass</span>
                            </div>
                        `);
                }

                if (station.drivewyze_enabled) {
                    const rate = station.drivewyze_bypass_rate || 0;
                    const active = drivewyzeEnabled;
                    badges.push(`
                            <div class="flex items-center gap-1.5 text-xs ${active ? '' : 'opacity-50'}">
                                <span class="w-6 h-6 bg-blue-500 text-white rounded flex items-center justify-center text-[10px] font-black">D</span>
                                <span class="font-bold ${active ? 'text-blue-700' : 'text-slate-500'}">${rate}% bypass</span>
                            </div>
                        `);
                }

                if (badges.length === 0) {
                    return `<div class="text-xs text-slate-400 mb-3"><i class="fa-solid fa-ban mr-1"></i>No bypass services available</div>`;
                }

                return `<div class="flex items-center gap-4 mb-3">${badges.join('')}</div>`;
            }

            function formatTimeAgo(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);

                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${Math.floor(diffHours / 24)}d ago`;
            }

            function escapeHtml(str) {
                if (!str) return '';
                return str.replace(/[&<>"']/g, (m) => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m]));
            }

            function navigateToStation(lat, lng) {
                if (!lat || !lng) return;
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const url = isIOS
                    ? `maps://maps.apple.com/?daddr=${lat},${lng}`
                    : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(url, '_blank');
            }

            // Report Modal Functions
            function openReportModal(stationId, stationName) {
                currentReportStationId = stationId;
                selectedReportType = null;
                selectedReportDetails = [];

                document.getElementById('report-station-name').textContent = stationName;
                document.getElementById('wait-time-select').value = '';

                // Reset button states
                document.querySelectorAll('.report-type-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-lmdr-yellow');
                });
                document.querySelectorAll('.report-detail-btn').forEach(btn => {
                    btn.classList.remove('bg-lmdr-yellow', 'text-slate-900');
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                });

                const modal = document.getElementById('report-modal');
                modal.classList.remove('hidden');

                // GSAP Modal Animation
                gsap.fromTo(modal.querySelector('.bg-white'),
                    { scale: 0.9, opacity: 0 },
                    { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
                );
            }

            function closeReportModal() {
                const modal = document.getElementById('report-modal');
                gsap.to(modal.querySelector('.bg-white'), {
                    scale: 0.9,
                    opacity: 0,
                    duration: 0.2,
                    ease: "power2.in",
                    onComplete: () => {
                        modal.classList.add('hidden');
                        currentReportStationId = null;
                    }
                });
            }

            function selectReportType(type) {
                selectedReportType = type;

                // Update button states
                document.querySelectorAll('.report-type-btn').forEach(btn => {
                    if (btn.dataset.type === type) {
                        btn.classList.add('ring-2', 'ring-offset-2', 'ring-lmdr-yellow');
                    } else {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-lmdr-yellow');
                    }
                });
            }

            function toggleReportDetail(detail) {
                const btn = document.querySelector(`.report-detail-btn[data-detail="${detail}"]`);
                const idx = selectedReportDetails.indexOf(detail);

                if (idx > -1) {
                    selectedReportDetails.splice(idx, 1);
                    btn.classList.remove('bg-lmdr-yellow', 'text-slate-900');
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    selectedReportDetails.push(detail);
                    btn.classList.add('bg-lmdr-yellow', 'text-slate-900');
                    btn.classList.remove('bg-slate-100', 'text-slate-600');
                }
            }

            function submitStationReport() {
                if (!selectedReportType) {
                    alert('Please select whether the station is open or closed.');
                    return;
                }

                if (!currentReportStationId) {
                    alert('Error: No station selected.');
                    return;
                }

                const waitMinutes = document.getElementById('wait-time-select').value;

                window.parent.postMessage({
                    type: 'reportStationStatus',
                    data: {
                        stationId: currentReportStationId,
                        reportType: selectedReportType,
                        waitMinutes: waitMinutes ? parseInt(waitMinutes) : null,
                        details: selectedReportDetails
                    }
                }, '*');

                closeReportModal();
            }

            function saveBypassPreferences() {
                const prepass = document.getElementById('prepass-checkbox').checked;
                const drivewyze = document.getElementById('drivewyze-checkbox').checked;

                driverBypassServices = { prepass, drivewyze };

                window.parent.postMessage({
                    type: 'saveDriverBypassServices',
                    data: { prepass, drivewyze }
                }, '*');

                // Re-render results with new bypass highlighting
                if (currentWeighStationResults.length > 0) {
                    renderWeighStationResults(currentWeighStationResults);
                }
            }

            function loadDriverBypassServices() {
                window.parent.postMessage({ type: 'getDriverBypassServices' }, '*');
            }

            function updateBypassCheckboxes(services) {
                if (!services) return;
                driverBypassServices = services;
                document.getElementById('prepass-checkbox').checked = services.prepass || false;
                document.getElementById('drivewyze-checkbox').checked = services.drivewyze || false;
            }

            // ==========================================
            // POSTMESSAGE HANDLER
            // ==========================================
            window.addEventListener('message', (event) => {
                const { type, data } = event.data || {};

                switch (type) {
                    case 'parkingResults':
                        document.getElementById('parking-loading')?.classList.add('hidden');
                        console.log('[HTML] parkingResults received:', data);
                        renderParkingResults(data.items || data);
                        break;

                    case 'fuelResults':
                        renderFuelResults(data.items || data);
                        break;

                    case 'fuelCardsLoaded':
                        updateFuelCardDropdown(data.cards || data);
                        break;

                    case 'fuelCardLinked':
                        if (data.success) {
                            console.log('Fuel card linked successfully');
                        }
                        break;

                    case 'fuelSavingsCalculated':
                        // Handle savings calculation result if needed
                        break;

                    case 'weatherResults':
                        console.log('[HTML] weatherResults received:', data);
                        renderAlerts(data.alerts || []);
                        renderChainLaws(data.chainLaws || []);
                        break;

                    case 'conditionsResults':
                        console.log('[HTML] conditionsResults received:', data);
                        renderConditions(data.conditions || []);
                        renderConditionSummary(data.summary || {});
                        break;

                    // Weigh Station Messages (Phase 3)
                    case 'weighStationResults':
                        console.log('[HTML] weighStationResults received:', data);
                        renderWeighStationResults(data.items || data);
                        break;

                    case 'stationStatusResult':
                        if (data.success) {
                            console.log('Station status reported successfully');
                            // Show success toast
                            showToast('Thanks for your report!', 'success');
                            // Refresh results
                            searchWeighStations();
                        } else {
                            showToast(data.message || 'Failed to submit report', 'error');
                        }
                        break;

                    case 'restrictionResults':
                        renderRestrictions(data.restrictions || []);
                        break;

                    case 'roadConditionReported':
                        if (data.success) {
                            showToast('Road condition reported. Thank you!', 'success');
                            closeReportModal(); // Assuming generic close or specific
                        } else {
                            showToast('Failed to report condition', 'error');
                        }
                        break;

                    case 'bypassServicesLoaded':
                        updateBypassCheckboxes(data.services || data);
                        break;

                    case 'bypassServicesSaved':
                        if (data.success) {
                            console.log('Bypass services saved successfully');
                        }
                        break;

                    case 'error':
                        console.error('Error from Wix:', data);
                        document.getElementById('parking-loading')?.classList.add('hidden');
                        document.getElementById('fuel-loading')?.classList.add('hidden');
                        document.getElementById('weighstation-loading')?.classList.add('hidden');
                        break;
                }
            });

            // Toast notification helper
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
                toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg text-sm font-bold z-50`;
                toast.textContent = message;
                document.body.appendChild(toast);

                gsap.fromTo(toast,
                    { opacity: 0, y: 20 },
                    { opacity: 1, y: 0, duration: 0.3, ease: "power2.out" }
                );

                setTimeout(() => {
                    gsap.to(toast, {
                        opacity: 0,
                        y: -20,
                        duration: 0.3,
                        ease: "power2.in",
                        onComplete: () => toast.remove()
                    });
                }, 3000);
            }

            // Initialize on load
            document.addEventListener('DOMContentLoaded', () => {
                loadDriverFuelCards();
                loadDriverBypassServices();

                // Standalone Debug Mode
                if (window.parent === window) {
                    console.warn('Running in standalone mode - Simulating Backend Data');

                    // Simulate Fuel Cards
                    setTimeout(() => {
                        updateFuelCardDropdown([
                            { card_type: 'comdata', card_last4: '4521', nickname: 'Comdata' },
                            { card_type: 'efs', card_last4: '8892', nickname: 'EFS' }
                        ]);
                    }, 500);

                    // Simulate Bypass Services
                    setTimeout(() => {
                        updateBypassCheckboxes({ prepass: true, drivewyze: false });
                    }, 500);

                    // Simulate Parking Results
                    setTimeout(() => {
                        renderParkingResults([
                            { _id: '1', name: 'Loves Travel Stop #452', available_spaces: 12, total_spaces: 80, distance_miles: 2.4, address: { city: 'Memphis', state: 'TN' }, amenities: ['shower', 'food', 'wifi'], location: { lat: 35.1495, lng: -90.0490 }, data_confidence: 'sensor' },
                            { _id: '2', name: 'Pilot Travel Center', available_spaces: 5, total_spaces: 120, distance_miles: 15.1, address: { city: 'West Memphis', state: 'AR' }, amenities: ['shower', 'fuel'], location: { lat: 35.1595, lng: -90.1490 }, data_confidence: 'reported' },
                            { _id: '3', name: 'Rest Area I-40', available_spaces: 0, total_spaces: 25, distance_miles: 34.2, address: { city: 'Arlington', state: 'TN' }, amenities: [], location: { lat: 35.2495, lng: -89.9490 } }
                        ]);
                    }, 800);

                    // Override postMessage to loop back for standalone testing
                    window.addEventListener('message', (event) => {
                        // Ensure we only process our own messages in standalone mode
                        if (event.source !== window) return;

                        const { type, data } = event.data || {};

                        if (type === 'searchFuel') {
                            console.log('[Standalone] Intercepted searchFuel request');
                            setTimeout(() => {
                                renderFuelResults([
                                    { _id: 'f1', name: 'Speedway', diesel_price: 3.45, savings: 0.44, distance_miles: 1.2, brand: 'Speedway', address: '123 Main St', has_def: true, location: { lat: 35.14, lng: -90.05 } },
                                    { _id: 'f2', name: 'Maverick', diesel_price: 3.52, savings: 0.37, distance_miles: 3.5, brand: 'Maverick', address: '456 Oak Ave', has_scales: true, location: { lat: 35.12, lng: -90.03 } },
                                    { _id: 'f3', name: 'Chevron', diesel_price: 3.89, savings: 0.00, distance_miles: 0.5, brand: 'Chevron', address: '789 Pine Ln', location: { lat: 35.15, lng: -90.05 } }
                                ]);
                            }, 1000);
                        }

                        if (type === 'searchWeighStations') {
                            console.log('[Standalone] Intercepted searchWeighStations request', data);
                            setTimeout(() => {
                                renderWeighStationResults([
                                    {
                                        _id: 'ws1',
                                        name: 'I-40 Weigh Station',
                                        state: 'TN',
                                        highway: 'I-40',
                                        direction: 'EB',
                                        mile_marker: 125,
                                        status: 'open',
                                        status_confidence: 'sensor',
                                        prepass_enabled: true,
                                        prepass_bypass_rate: 82,
                                        drivewyze_enabled: true,
                                        drivewyze_bypass_rate: 78,
                                        distance_miles: 5.2,
                                        location: { lat: 35.15, lng: -90.05 },
                                        last_status_update: new Date().toISOString()
                                    },
                                    {
                                        _id: 'ws2',
                                        name: 'I-55 Scale House',
                                        state: 'TN',
                                        highway: 'I-55',
                                        direction: 'SB',
                                        mile_marker: 12,
                                        status: 'closed',
                                        status_confidence: 'reported',
                                        prepass_enabled: true,
                                        prepass_bypass_rate: 75,
                                        drivewyze_enabled: false,
                                        distance_miles: 12.8,
                                        location: { lat: 35.08, lng: -90.12 },
                                        wait_estimate: 15,
                                        report_count: 3,
                                        last_status_update: new Date(Date.now() - 1800000).toISOString()
                                    },
                                    {
                                        _id: 'ws3',
                                        name: 'Arkansas Welcome Center Scale',
                                        state: 'AR',
                                        highway: 'I-40',
                                        direction: 'WB',
                                        mile_marker: 280,
                                        status: 'unknown',
                                        status_confidence: 'historical',
                                        prepass_enabled: false,
                                        drivewyze_enabled: true,
                                        drivewyze_bypass_rate: 68,
                                        distance_miles: 18.5,
                                        location: { lat: 35.16, lng: -90.25 }
                                    }
                                ]);
                                console.log('[Standalone] Rendered mock weigh station results');
                            }, 1000);
                        }

                        if (type === 'reportStationStatus') {
                            console.log('[Standalone] Intercepted reportStationStatus request', data);
                            setTimeout(() => {
                                window.postMessage({ type: 'stationStatusResult', data: { success: true } }, '*');
                            }, 500);
                        }
                    });
                }
            });
        </script>
        <!-- Rest Stop Report Modal -->
        <div id="rest-stop-report-modal"
            class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="font-black text-xl text-slate-900">Report Rest Stop Issue</h3>
                    <button onclick="closeRestStopReportModal()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Issue Type</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="submitCondition('shower_wait', 'High Wait Time')"
                            class="p-3 bg-red-50 text-red-700 font-bold rounded-xl border border-red-100 hover:bg-red-100">Shower
                            Wait</button>
                        <button onclick="submitCondition('lot_full', 'Parking Lot Full')"
                            class="p-3 bg-red-50 text-red-700 font-bold rounded-xl border border-red-100 hover:bg-red-100">Lot
                            Full</button>
                        <button onclick="submitCondition('hazard', 'Safety Hazard')"
                            class="p-3 bg-red-50 text-red-700 font-bold rounded-xl border border-red-100 hover:bg-red-100">Hazard</button>
                        <button onclick="submitCondition('cleanliness', 'Dirty Facilities')"
                            class="p-3 bg-red-50 text-red-700 font-bold rounded-xl border border-red-100 hover:bg-red-100">Dirty</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Only adding Phase 4 functions to global scope
            function loadTopRated() {
                document.getElementById('ratings-loading').classList.remove('hidden');
                setTimeout(() => {
                    window.parent.postMessage({ type: 'getReviews', data: { options: { sort: 'rating' } } }, '*');
                    document.getElementById('ratings-loading').classList.add('hidden');
                }, 500);
            }

            function searchReviews() {
                const query = document.getElementById('ratings-search').value;
                // Implement search
            }

            function showRestStopReportModal() {
                document.getElementById('rest-stop-report-modal').classList.remove('hidden');
            }

            function closeRestStopReportModal() {
                document.getElementById('rest-stop-report-modal').classList.add('hidden');
            }

            function submitCondition(type, details) {
                window.parent.postMessage({
                    type: 'reportCondition',
                    data: { locationId: 'current', reportData: { type, details } }
                }, '*');
                closeRestStopReportModal();
                // We need a showToast function globally available
                if (typeof showToast === 'function') {
                    showToast('Report submitted', 'success');
                }
            }

            // Phase 5: Weather
            function refreshWeather() {
                const list = document.getElementById('chain-laws-list');
                list.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</div>';

                // Default route (Donner Pass area)
                let routePoints = [{ lat: 39.31, lng: -120.33 }, { lat: 39.5, lng: -120.5 }];

                // Demo Mode Override (NWS Live Data)
                if (window.demoWeather === 'ACTIVE') {
                    // Redirect to Memphis area to show live alerts if any, or just to prove connection
                    routePoints = [{ lat: 35.14, lng: -90.04 }, { lat: 35.2, lng: -90.0 }];
                    document.getElementById('weather-alerts-container').innerHTML += '<div class="text-xs text-center text-blue-500 mb-2">Fetching LIVE data from National Weather Service...</div>';
                }

                window.parent.postMessage({ type: 'getWeather', data: { routePoints } }, '*');

                // Standalone mock
                if (window.parent === window) {
                    setTimeout(() => {
                        renderChainLaws([
                            { name: 'Donner Pass (I-80)', status: 'Requirement 1 (Chains Required)', color: 'red' },
                            { name: 'Snoqualmie Pass (I-90)', status: 'Clear', color: 'green' }
                        ]);
                        renderAlerts([]);
                    }, 1000);
                }
            }

            function renderChainLaws(items) {
                const list = document.getElementById('chain-laws-list');
                list.innerHTML = '';
                items.forEach(item => {
                    const colorClass = item.status === 'Clear' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200';
                    const icon = item.status === 'Clear' ? 'fa-check' : 'fa-link';

                    list.innerHTML += `
                        <div class="${colorClass} border p-3 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="font-bold text-sm">${item.name}</p>
                                <p class="text-xs font-medium opacity-80">${item.status}</p>
                            </div>
                            <i class="fa-solid ${icon} text-lg"></i>
                        </div>
                    `;
                });
            }

            function renderAlerts(alerts) {
                const container = document.getElementById('weather-alerts-container');
                container.innerHTML = '';

                // Demo Button
                const demoBtn = document.createElement('div');
                demoBtn.className = 'flex justify-center mb-4';
                demoBtn.innerHTML = `<button onclick="window.demoWeather='ACTIVE'; refreshWeather();" class="text-xs border border-slate-200 text-slate-500 hover:text-lmdr-blue px-3 py-1 rounded-full transition-colors"><i class="fa-solid fa-cloud-bolt mr-1"></i> Live Demo: National Weather Service</button>`;
                container.appendChild(demoBtn);
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl shadow-sm p-6 text-center border border-slate-100">
                            <i class="fa-solid fa-check-circle text-4xl text-green-500 mb-2"></i>
                            <p class="font-bold text-slate-900">No active alerts</p>
                            <p class="text-xs text-slate-500 mt-1">Safe travels!</p>
                        </div>`;
                    return;
                }

                container.innerHTML = alerts.map(a => `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl shadow-sm">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-black text-red-700 uppercase text-xs tracking-wider">${a.event}</h4>
                                <p class="text-sm font-bold text-slate-900 mt-1">${a.headline}</p>
                                <p class="text-xs text-slate-500 mt-2">${a.description ? a.description.substring(0, 100) + '...' : ''}</p>
                            </div>
                            <i class="fa-solid fa-triangle-exclamation text-red-500 text-xl"></i>
                        </div>
                    </div>
                `).join('');
            }

            window.addEventListener('message', (event) => {
                const { type, data } = event.data || {};

                if (type === 'init') {
                    if (data.initialTab && data.initialTab !== currentTab) {
                        switchTab(data.initialTab);
                    }
                }

                if (type === 'weatherResults') {
                    if (data.chainLaws) renderChainLaws(data.chainLaws);
                    if (data.alerts) renderAlerts(data.alerts);
                }
            });
        </script>
        </main>
</body>

</html>

<script>
    // Phase 6: Restrictions Rendering
    function renderRestrictions(items) {
        const list = document.getElementById('restrictions-list');
        if (!list) return; // Guard 

        if (!items || items.length === 0) {
            list.classList.add('hidden');
            return;
        }

        list.classList.remove('hidden');
        list.innerHTML = '<h4 class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2">Active Restrictions for Your Truck</h4>';

        items.forEach(r => {
            list.innerHTML += `
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-3">
                    <div class="bg-white p-1.5 rounded-md shadow-sm text-red-600 font-bold text-xs border border-red-100">
                        ${r.value}${r.unit}
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-900">${r.restriction_type.toUpperCase()} RESTRICTION</p>
                        <p class="text-[10px] text-slate-500">${r.details}</p>
                        <p class="text-[9px] text-slate-400 mt-1"><i class="fa-solid fa-location-dot mr-1"></i>${r.highway} ${r.state}</p>
                    </div>
                </div>
            `;
        });
    }

    // Phase 6: Condition Cards & Summary
    function renderConditions(conditions) {
        const list = document.getElementById('conditions-list');
        list.innerHTML = '';

        if (!conditions || conditions.length === 0) {
            list.innerHTML = `
                <div class="bg-white rounded-2xl shadow-sm p-6 text-center border border-slate-100">
                    <div class="bg-green-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fa-solid fa-road text-2xl text-green-500"></i>
                    </div>
                    <p class="font-bold text-slate-900">Roads Look Clear</p>
                    <p class="text-xs text-slate-500 mt-1">No major incidents reported on your route.</p>
                </div>`;
            return;
        }

        conditions.forEach(c => {
            const severityColor = getSeverityColor(c.severity);
            const icon = getConditionIcon(c.type);

            list.innerHTML += `
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 transition-all hover:shadow-md">
                <div class="flex items-start gap-3">
                    <div class="${severityColor.bg} ${severityColor.text} w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid ${icon} text-lg"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-sm text-slate-900">${c.highway} ${c.state}</h4>
                            <span class="${severityColor.badgeBg} ${severityColor.badgeText} text-[10px] font-black uppercase px-2 py-0.5 rounded-full border ${severityColor.badgeBorder}">
                                ${c.severity || 'Notice'}
                            </span>
                        </div>
                        <p class="text-xs font-medium text-slate-500 mt-1 uppercase tracking-wide flex items-center">
                           ${c.type.toUpperCase()} <span class="mx-1">â€¢</span> ${c.delay_minutes > 0 ? `<span class="text-red-500 font-bold">+${c.delay_minutes} MIN DELAY</span>` : 'NO DELAY'}
                        </p>
                        <p class="text-sm text-slate-700 mt-2 leading-relaxed">${c.description}</p>
                        ${c.expected_end ? `<p class="text-[10px] text-slate-400 mt-2 italic"><i class="fa-regular fa-clock mr-1"></i>Clearing by ${new Date(c.expected_end).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>` : ''}
                        
                        <!-- Phase 6.2: Alternate Route Suggestion -->
                        ${c.alternate_routes && c.alternate_routes.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-slate-100">
                             <button onclick="document.getElementById('alt-route-${c._id}').classList.toggle('hidden')" class="w-full text-left flex justify-between items-center group">
                                <span class="text-xs font-black text-lmdr-blue uppercase tracking-wider group-hover:underline"><i class="fa-solid fa-route mr-1"></i> Alternate Route Available</span>
                                <i class="fa-solid fa-chevron-down text-slate-400 text-xs"></i>
                             </button>
                             <div id="alt-route-${c._id}" class="hidden mt-2 bg-blue-50 border border-blue-100 rounded-lg p-3">
                                ${c.alternate_routes.map(r => `
                                    <div class="mb-2 last:mb-0">
                                        <div class="flex justify-between items-start">
                                            <p class="font-bold text-sm text-blue-900">${r.name}</p>
                                            <span class="bg-green-100 text-green-700 text-[10px] font-bold px-1.5 py-0.5 rounded border border-green-200">SAVE ${r.savings_minutes}m</span>
                                        </div>
                                        <p class="text-xs text-blue-800 mt-1">${r.description}</p>
                                        <p class="text-[10px] text-blue-500 mt-1"><i class="fa-solid fa-person-walking-dashed-line-arrow-right mr-1"></i>+${r.distance_diff_miles} miles â€¢ +${r.time_diff_minutes} min vs normal</p>
                                    </div>
                                `).join('')}
                                <button onclick="window.parent.postMessage({ type: 'tabSwitch', data: 'parking' }, '*')" class="w-full mt-2 bg-blue-600 text-white font-bold text-xs py-2 rounded hover:bg-blue-700 transition-colors">
                                    FIND PARKING ON THIS ROUTE
                                </button>
                             </div>
                        </div>
                        ` : ''}

                    </div>
                </div>
            </div>`;
        });
    }

    function renderConditionSummary(summary) {
        if (summary && summary.total_delay_minutes > 0) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'bg-slate-900 text-white p-4 rounded-xl shadow-lg mb-4 flex justify-between items-center';
            summaryDiv.innerHTML = `
                <div>
                    <p class="text-[10px] uppercase font-bold text-slate-400">Total Route Delay</p>
                    <p class="text-2xl font-black text-lmdr-yellow">+${summary.total_delay_minutes} <span class="text-sm text-white">MIN</span></p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold">${summary.total_incidents} INCIDENTS</p>
                    <p class="text-[10px] text-slate-400">${summary.counts.closure} CLOSURES â€¢ ${summary.counts.accident} CRASHES</p>
                </div>
             `;
            const list = document.getElementById('conditions-list');
            list.insertBefore(summaryDiv, list.firstChild);
        }
    }

    function getSeverityColor(severity) {
        switch (severity) {
            case 'major': return { bg: 'bg-red-50', text: 'text-red-600', badgeBg: 'bg-red-100', badgeText: 'text-red-700', badgeBorder: 'border-red-200' };
            case 'moderate': return { bg: 'bg-orange-50', text: 'text-orange-600', badgeBg: 'bg-orange-100', badgeText: 'text-orange-700', badgeBorder: 'border-orange-200' };
            default: return { bg: 'bg-slate-50', text: 'text-slate-600', badgeBg: 'bg-slate-100', badgeText: 'text-slate-600', badgeBorder: 'border-slate-200' };
        }
    }

    function getConditionIcon(type) {
        switch (type) {
            case 'closure': return 'fa-ban';
            case 'accident': return 'fa-car-burst';
            case 'construction': return 'fa-screwdriver-wrench';
            case 'weather': return 'fa-cloud-showers-heavy';
            default: return 'fa-triangle-exclamation';
        }
    }
</script>