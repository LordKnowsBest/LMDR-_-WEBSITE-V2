<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Road Utilities - LMDR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            blue: '#2563eb',
                            dark: '#0f172a',
                            yellow: '#fbbf24',
                            'yellow-hover': '#f59e0b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-active {
            border-bottom: 3px solid #fbbf24;
            color: #fbbf24;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .leaflet-container {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 min-h-screen pb-20">
    <!-- Tab Navigation -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex">
            <button id="tab-parking" onclick="switchTab('parking')"
                class="flex-1 py-4 text-center font-black text-sm uppercase tracking-wider border-b-3 tab-active">
                <i class="fa-solid fa-square-parking mr-2"></i>Parking
            </button>
            <button id="tab-fuel" onclick="switchTab('fuel')"
                class="flex-1 py-4 text-center font-black text-sm uppercase tracking-wider text-slate-400 border-b-3 border-transparent hover:text-slate-600 transition-colors">
                <i class="fa-solid fa-gas-pump mr-2"></i>Fuel
            </button>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4">
        <!-- Parking Finder Section -->
        <section id="section-parking" class="space-y-4">
            <!-- View Toggle -->
            <div class="flex justify-between items-center">
                <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Nearby Results</h2>
                <div class="bg-white rounded-lg border border-slate-200 p-1 flex">
                    <button id="view-list-btn" onclick="toggleView('list')"
                        class="px-3 py-1 text-xs font-bold rounded bg-slate-900 text-white">LIST</button>
                    <button id="view-map-btn" onclick="toggleView('map')"
                        class="px-3 py-1 text-xs font-bold rounded text-slate-500">MAP</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="parking-loading" class="hidden py-12 text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-lmdr-yellow mb-2"></i>
                <p class="text-sm text-slate-500 font-medium">Finding truck parking...</p>
            </div>

            <!-- Content Area (List and Map) -->
            <div class="relative min-h-[400px]">
                <!-- Results List -->
                <div id="parking-results" class="space-y-3">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Map Container -->
                <div id="parking-map-container"
                    class="hidden absolute inset-0 bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm min-h-[500px]">
                    <div id="map"></div>
                    <button onclick="searchThisArea()"
                        class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-white text-slate-900 font-black px-4 py-2 rounded-full text-xs shadow-xl border border-slate-200 hover:bg-slate-50 transition-all">
                        <i class="fa-solid fa-arrows-rotate mr-1"></i> SEARCH THIS AREA
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="parking-empty"
                class="hidden py-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i class="fa-solid fa-square-parking text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-slate-500 font-bold">No parking found in this area.</p>
            </div>
        </section>

        <!-- Fuel Optimizer Section (SIBLING of parking, not nested!) -->
        <section id="section-fuel" class="hidden space-y-4">
            <!-- Fuel Card Selector -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-wider">Your Fuel Card</h3>
                    <button onclick="openAddCardModal()" class="text-lmdr-blue font-bold text-xs">+ ADD NEW</button>
                </div>
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <div class="w-10 h-10 bg-slate-900 rounded-lg flex items-center justify-center text-white">
                        <i class="fa-solid fa-credit-card"></i>
                    </div>
                    <div class="flex-grow">
                        <select id="fuel-card-select" onchange="searchFuel()"
                            class="bg-transparent font-bold text-sm w-full focus:outline-none">
                            <option value="none">No Card (Retail Price)</option>
                            <option value="comdata" selected>Comdata (**** 4521)</option>
                            <option value="efs">EFS (**** 8892)</option>
                        </select>
                        <p class="text-[10px] text-slate-500 font-medium">Automatic discount applied to results</p>
                    </div>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                <div class="flex gap-2 mb-4">
                    <div class="relative flex-grow">
                        <i class="fa-solid fa-gas-pump absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="fuel-search-input" placeholder="Search for cheapest diesel..."
                            class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-lmdr-yellow/50">
                    </div>
                    <button onclick="searchFuel()"
                        class="bg-lmdr-yellow text-slate-900 font-bold px-4 py-2 rounded-xl text-sm hover:shadow-md transition-all">
                        FIND FUEL
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 text-center">
                        <p class="text-[10px] font-black text-blue-400 uppercase">State Avg</p>
                        <p class="text-sm font-black text-blue-700">$3.89</p>
                    </div>
                    <div class="bg-green-50 border border-green-100 rounded-xl p-3 text-center">
                        <p class="text-[10px] font-black text-green-400 uppercase">Trend</p>
                        <p class="text-sm font-black text-green-700"><i class="fa-solid fa-caret-down mr-1"></i>
                            $0.02</p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="fuel-loading" class="hidden py-12 text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-lmdr-yellow mb-2"></i>
                <p class="text-sm text-slate-500 font-medium">Comparing diesel prices...</p>
            </div>

            <!-- Results List -->
            <div id="fuel-results" class="space-y-3">
                <!-- Cards will be injected here -->
            </div>

            <!-- Empty State -->
            <div id="fuel-empty"
                class="hidden py-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i class="fa-solid fa-gas-pump text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-slate-500 font-bold">No fuel prices found in this area.</p>
            </div>
        </section>

        <script>
                let map;
                let markers = [];
                let currentView = 'list';

                function initMap() {
                    if (map) return;
                    map = L.map('map').setView([35.1495, -90.0490], 11);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
                }

                function toggleView(view) {
                    currentView = view;
                    const list = document.getElementById('parking-results');
                    const mapContainer = document.getElementById('parking-map-container');
                    const listBtn = document.getElementById('view-list-btn');
                    const mapBtn = document.getElementById('view-map-btn');

                    if (view === 'map') {
                        list.classList.add('hidden');
                        mapContainer.classList.remove('hidden');
                        listBtn.classList.remove('bg-slate-900', 'text-white');
                        listBtn.classList.add('text-slate-500');
                        mapBtn.classList.add('bg-slate-900', 'text-white');
                        mapBtn.classList.remove('text-slate-500');

                        setTimeout(() => {
                            initMap();
                            map.invalidateSize();
                        }, 100);
                    } else {
                        list.classList.remove('hidden');
                        mapContainer.classList.add('hidden');
                        mapBtn.classList.remove('bg-slate-900', 'text-white');
                        mapBtn.classList.add('text-slate-500');
                        listBtn.classList.add('bg-slate-900', 'text-white');
                        listBtn.classList.remove('text-slate-500');
                    }
                }

                function renderParkingResults(items) {
                    const container = document.getElementById('parking-results');
                    container.innerHTML = '';

                    if (map) {
                        markers.forEach(m => map.removeLayer(m));
                        markers = [];
                    }

                    if (!items || items.length === 0) {
                        container.classList.add('hidden');
                        document.getElementById('parking-empty').classList.remove('hidden');
                        return;
                    }

                    container.classList.remove('hidden');
                    document.getElementById('parking-empty').classList.add('hidden');

                    items.forEach(item => {
                        // Render List Card
                        const statusColor = getStatusColor(item);
                        const dataSourceBadge = getDataSourceBadge(item);
                        const card = document.createElement('div');
                        card.className = 'parking-card opacity-0 translate-y-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:border-lmdr-yellow transition-all';
                        card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-black text-slate-900 group-hover:text-lmdr-blue transition-colors">${item.name}</h3>
                                    ${dataSourceBadge}
                                </div>
                                <p class="text-xs text-slate-500">${item.highway || ''} ${item.address?.city ? 'â€¢ ' + item.address.city : ''}, ${item.address?.state || ''}</p>
                            </div>
                            <div class="${statusColor.bg} ${statusColor.text} px-2 py-1 rounded text-[10px] font-black uppercase">
                                ${statusColor.label}
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex-grow bg-gray-100 h-2 rounded-full overflow-hidden">
                                <div class="${statusColor.bar} h-full" style="width: ${item.total_spaces > 0 ? (item.available_spaces / item.total_spaces * 100) : 0}%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-700">${item.available_spaces ?? '?'} / ${item.total_spaces || '?'}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex gap-2 text-gray-400 text-sm">
                                ${renderAmenityIcons(item.amenities)}
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Distance</p>
                                <p class="text-sm font-black text-slate-900">${item.distance_miles} mi</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 flex gap-2">
                        <button onclick="navigate('${item.location.lat}', '${item.location.lng}')" class="flex-grow bg-slate-900 text-white font-bold py-2 rounded-lg text-xs hover:bg-slate-800 transition-all">NAVIGATE</button>
                        <button onclick="showDetails('${item._id}')" class="bg-white border border-slate-200 text-slate-700 font-bold px-4 py-2 rounded-lg text-xs hover:bg-gray-50 transition-all">DETAILS</button>
                    </div>
                `;
                        container.appendChild(card);

                        // Add Marker to Map
                        if (map) {
                            const marker = L.circleMarker([item.location.lat, item.location.lng], {
                                radius: 8,
                                fillColor: statusColor.hex,
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);

                            marker.bindPopup(`<b>${item.name}</b><br>${item.available_spaces} spaces available`);
                            markers.push(marker);
                        }
                    }); // End forEach

                    // GSAP Stagger Animation
                    gsap.to(".parking-card", {
                        opacity: 1,
                        y: 0,
                        duration: 0.5,
                        stagger: 0.05,
                        ease: "power2.out"
                    });

                    if (map && items.length > 0) {
                        const group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                }

                function getStatusColor(item) {
                    const ratio = item.available_spaces / item.total_spaces;
                    if (item.available_spaces === 0) return { bg: 'bg-red-100', text: 'text-red-700', bar: 'bg-red-500', hex: '#ef4444', label: 'Full' };
                    if (ratio < 0.1 || item.available_spaces < 5) return { bg: 'bg-yellow-100', text: 'text-yellow-700', bar: 'bg-yellow-500', hex: '#eab308', label: 'Limited' };
                    return { bg: 'bg-green-100', text: 'text-green-700', bar: 'bg-green-500', hex: '#22c55e', label: 'Available' };
                }

                function getDataSourceBadge(item) {
                    // Show badge indicating data source reliability
                    if (item.data_confidence === 'sensor') {
                        return `<span class="bg-blue-100 text-blue-700 text-[9px] font-black px-1.5 py-0.5 rounded uppercase" title="Real-time sensor data from TPIMS">
                    <i class="fa-solid fa-signal mr-0.5"></i>LIVE
                </span>`;
                    }
                    if (item.data_confidence === 'reported') {
                        return `<span class="bg-purple-100 text-purple-700 text-[9px] font-black px-1.5 py-0.5 rounded uppercase" title="Reported by drivers">
                    <i class="fa-solid fa-users mr-0.5"></i>REPORTED
                </span>`;
                    }
                    if (item.source_label) {
                        return `<span class="bg-slate-100 text-slate-500 text-[9px] font-medium px-1.5 py-0.5 rounded">${item.source_label}</span>`;
                    }
                    return '';
                }

                function navigate(lat, lng) {
                    // Open in Google Maps or Apple Maps based on device
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    const url = isIOS
                        ? `maps://maps.apple.com/?daddr=${lat},${lng}`
                        : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                    window.open(url, '_blank');
                }

                function showDetails(locationId) {
                    if (!locationId) return;
                    window.parent.postMessage({
                        type: 'getParkingDetails',
                        data: { locationId }
                    }, '*');
                }

                function renderAmenityIcons(amenities) {
                    if (!amenities) return '';
                    const map = {
                        'shower': 'fa-shower',
                        'wifi': 'fa-wifi',
                        'food': 'fa-utensils',
                        'fuel': 'fa-gas-pump'
                    };
                    return amenities.map(a => `<i class="fa-solid ${map[a] || 'fa-circle-info'}"></i>`).join('');
                }

                function searchThisArea() {
                    const center = map.getCenter();
                    const bounds = map.getBounds();
                    const radius = map.distance(center, bounds.getNorthWest()) / 1609.34; // meters to miles

                    document.getElementById('parking-loading').classList.remove('hidden');
                    window.parent.postMessage({
                        type: 'searchParking',
                        data: { lat: center.lat, lng: center.lng, radius: radius }
                    }, '*');
                }

                // ==========================================
                // TAB NAVIGATION
                // ==========================================
                let currentTab = 'parking';

                function switchTab(tab) {
                    if (currentTab === tab) return;

                    const parkingSection = document.getElementById('section-parking');
                    const fuelSection = document.getElementById('section-fuel');
                    const parkingTab = document.getElementById('tab-parking');
                    const fuelTab = document.getElementById('tab-fuel');

                    // Reset any GSAP props
                    gsap.set([parkingSection, fuelSection], { clearProps: "all" });

                    if (tab === 'fuel') {
                        parkingSection.classList.add('hidden');
                        fuelSection.classList.remove('hidden');

                        // Simple fade in
                        gsap.fromTo(fuelSection,
                            { opacity: 0, y: 10 },
                            { opacity: 1, y: 0, duration: 0.4, ease: "power2.out" }
                        );

                        parkingTab.classList.remove('tab-active');
                        parkingTab.classList.add('text-slate-400', 'border-transparent');
                        fuelTab.classList.add('tab-active');
                        fuelTab.classList.remove('text-slate-400', 'border-transparent');

                        // Auto-search fuel on tab switch
                        if (!fuelDataLoaded) {
                            searchFuel();
                        }
                    } else {
                        fuelSection.classList.add('hidden');
                        parkingSection.classList.remove('hidden');

                        // Simple fade in
                        gsap.fromTo(parkingSection,
                            { opacity: 0, y: 10 },
                            { opacity: 1, y: 0, duration: 0.4, ease: "power2.out" }
                        );

                        fuelTab.classList.remove('tab-active');
                        fuelTab.classList.add('text-slate-400', 'border-transparent');
                        parkingTab.classList.add('tab-active');
                        parkingTab.classList.remove('text-slate-400', 'border-transparent');
                    }
                    currentTab = tab;
                }

                // ==========================================
                // FUEL OPTIMIZER FUNCTIONS
                // ==========================================
                let fuelDataLoaded = false;
                let fuelMarkers = [];
                let driverFuelCards = [];
                let currentFuelResults = [];

                function searchFuel() {
                    const loadingEl = document.getElementById('fuel-loading');
                    const resultsEl = document.getElementById('fuel-results');
                    const emptyEl = document.getElementById('fuel-empty');

                    loadingEl.classList.remove('hidden');
                    resultsEl.innerHTML = '';
                    emptyEl.classList.add('hidden');

                    const selectedCard = document.getElementById('fuel-card-select').value;
                    const searchQuery = document.getElementById('fuel-search-input').value;

                    // Get current location or use default
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                window.parent.postMessage({
                                    type: 'searchFuel',
                                    data: {
                                        lat: pos.coords.latitude,
                                        lng: pos.coords.longitude,
                                        radius: 50,
                                        fuelCardType: selectedCard,
                                        query: searchQuery
                                    }
                                }, '*');
                            },
                            () => {
                                // Default to Memphis if location denied
                                window.parent.postMessage({
                                    type: 'searchFuel',
                                    data: {
                                        lat: 35.1495,
                                        lng: -90.0490,
                                        radius: 50,
                                        fuelCardType: selectedCard,
                                        query: searchQuery
                                    }
                                }, '*');
                            }
                        );
                    } else {
                        window.parent.postMessage({
                            type: 'searchFuel',
                            data: {
                                lat: 35.1495,
                                lng: -90.0490,
                                radius: 50,
                                fuelCardType: selectedCard,
                                query: searchQuery
                            }
                        }, '*');
                    }
                }

                function renderFuelResults(items) {
                    console.log('[HTML] renderFuelResults called with:', items?.length, 'items', items);
                    fuelDataLoaded = true;
                    currentFuelResults = items;

                    const loadingEl = document.getElementById('fuel-loading');
                    const resultsEl = document.getElementById('fuel-results');
                    const emptyEl = document.getElementById('fuel-empty');

                    console.log('[HTML] Elements found:', { loadingEl: !!loadingEl, resultsEl: !!resultsEl, emptyEl: !!emptyEl });

                    loadingEl.classList.add('hidden');

                    if (!items || items.length === 0) {
                        console.log('[HTML] No items, showing empty state');
                        resultsEl.innerHTML = '';
                        emptyEl.classList.remove('hidden');
                        return;
                    }

                    emptyEl.classList.add('hidden');
                    resultsEl.innerHTML = '';

                    items.forEach((station, index) => {
                        const savingsClass = station.savings > 0 ? 'text-green-600' : 'text-slate-500';
                        const savingsText = station.savings > 0 ? `-$${station.savings.toFixed(2)}/gal` : 'Retail';
                        const priceColor = index === 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-700';

                        const card = document.createElement('div');
                        card.className = 'fuel-card opacity-0 translate-y-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:border-lmdr-yellow transition-all';
                        card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    ${index === 0 ? '<span class="bg-lmdr-yellow text-slate-900 text-[10px] font-black px-2 py-0.5 rounded uppercase">Best Price</span>' : ''}
                                    <span class="text-[10px] font-bold text-slate-400 uppercase">${station.brand || 'Independent'}</span>
                                </div>
                                <h3 class="font-black text-slate-900 group-hover:text-lmdr-blue transition-colors">${station.name}</h3>
                                <p class="text-xs text-slate-500">${typeof station.address === 'object' ? `${station.address.street}, ${station.address.city}` : (station.address || '')}</p>
                            </div>
                            <div class="text-right">
                                <p class="${priceColor} px-3 py-2 rounded-xl text-lg font-black">$${station.diesel_price.toFixed(2)}</p>
                                <p class="${savingsClass} text-[10px] font-bold mt-1">${savingsText}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-xs">
                            <div class="flex items-center gap-1 text-slate-500">
                                <i class="fa-solid fa-location-dot"></i>
                                <span class="font-bold">${station.distance_miles?.toFixed(1) || '?'} mi</span>
                            </div>
                            ${station.has_def ? '<div class="flex items-center gap-1 text-blue-500"><i class="fa-solid fa-droplet"></i><span class="font-bold">DEF</span></div>' : ''}
                            ${station.has_scales ? '<div class="flex items-center gap-1 text-purple-500"><i class="fa-solid fa-weight-scale"></i><span class="font-bold">Scales</span></div>' : ''}
                            ${station.accepts_card ? `<div class="flex items-center gap-1 text-green-500"><i class="fa-solid fa-credit-card"></i><span class="font-bold">${station.card_type || 'Card'}</span></div>` : ''}
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 flex gap-2">
                        <button onclick="navigateToFuel('${station.location?.lat}', '${station.location?.lng}')" class="flex-grow bg-slate-900 text-white font-bold py-2 rounded-lg text-xs hover:bg-slate-800 transition-all">
                            <i class="fa-solid fa-diamond-turn-right mr-1"></i> NAVIGATE
                        </button>
                        <button onclick="calculateRouteSavings('${station._id}')" class="bg-lmdr-yellow text-slate-900 font-bold px-4 py-2 rounded-lg text-xs hover:shadow-md transition-all">
                            <i class="fa-solid fa-calculator mr-1"></i> SAVINGS
                        </button>
                    </div>
                `;
                        resultsEl.appendChild(card);
                    });

                    console.log('[HTML] Created', resultsEl.children.length, 'fuel cards');

                    // GSAP Stagger Animation for fuel results
                    gsap.to(".fuel-card", {
                        opacity: 1,
                        y: 0,
                        duration: 0.5,
                        stagger: 0.05,
                        ease: "power2.out"
                    });

                    // Update fuel map markers if map is initialized
                    updateFuelMarkers(items);
                }

                function updateFuelMarkers(items) {
                    if (!map) return;

                    // Clear existing fuel markers
                    fuelMarkers.forEach(m => map.removeLayer(m));
                    fuelMarkers = [];

                    items.forEach((station, index) => {
                        if (!station.location) return;

                        const color = index === 0 ? '#22c55e' : '#3b82f6';
                        const marker = L.circleMarker([station.location.lat, station.location.lng], {
                            radius: index === 0 ? 12 : 8,
                            fillColor: color,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(map);

                        marker.bindPopup(`
                    <b>${station.name}</b><br>
                    <span style="font-size: 18px; font-weight: bold; color: ${index === 0 ? '#16a34a' : '#1e40af'}">$${station.diesel_price.toFixed(2)}</span><br>
                    <small>${station.distance_miles?.toFixed(1)} miles away</small>
                `);
                        fuelMarkers.push(marker);
                    });
                }

                function navigateToFuel(lat, lng) {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
                }

                function calculateRouteSavings(stationId) {
                    const station = currentFuelResults.find(s => s._id === stationId);
                    if (!station) return;

                    // Show savings modal
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                    modal.id = 'savings-modal';
                    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                    modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-black text-xl text-slate-900">Fuel Savings Calculator</h3>
                        <button onclick="document.getElementById('savings-modal').remove()" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <p class="text-xs font-black text-green-500 uppercase mb-1">Selected Station</p>
                            <p class="font-bold text-slate-900">${station.name}</p>
                            <p class="text-2xl font-black text-green-700">$${station.diesel_price.toFixed(2)}/gal</p>
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Gallons Needed</label>
                            <input type="number" id="gallons-input" value="100" min="1" max="500" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-50 rounded-xl p-3">
                                <p class="text-[10px] font-black text-slate-400 uppercase">State Avg</p>
                                <p class="text-lg font-black text-slate-700">$3.89/gal</p>
                            </div>
                            <div class="bg-green-50 rounded-xl p-3">
                                <p class="text-[10px] font-black text-green-500 uppercase">You Save</p>
                                <p class="text-lg font-black text-green-700" id="savings-display">$${((3.89 - station.diesel_price) * 100).toFixed(2)}</p>
                            </div>
                        </div>
                        <button onclick="navigateToFuel('${station.location?.lat}', '${station.location?.lng}')" class="w-full bg-lmdr-yellow text-slate-900 font-black py-3 rounded-xl hover:shadow-lg transition-all">
                            <i class="fa-solid fa-diamond-turn-right mr-2"></i>NAVIGATE TO STATION
                        </button>
                    </div>
                </div>
            `;

                    document.body.appendChild(modal);

                    // GSAP Modal Animation
                    gsap.fromTo(modal.firstElementChild,
                        { scale: 0.9, opacity: 0 },
                        { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
                    );

                    // Update savings on input change
                    const gallonsInput = document.getElementById('gallons-input');
                    const savingsDisplay = document.getElementById('savings-display');
                    gallonsInput.addEventListener('input', () => {
                        const gallons = parseFloat(gallonsInput.value) || 0;
                        const savings = (3.89 - station.diesel_price) * gallons;
                        savingsDisplay.textContent = `$${savings.toFixed(2)}`;
                    });
                }

                function openAddCardModal() {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                    modal.id = 'add-card-modal';
                    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                    modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-black text-xl text-slate-900">Add Fuel Card</h3>
                        <button onclick="document.getElementById('add-card-modal').remove()" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Card Provider</label>
                            <select id="card-provider" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                                <option value="comdata">Comdata</option>
                                <option value="efs">EFS (Electronic Funds Source)</option>
                                <option value="tchek">T-Chek</option>
                                <option value="fleetone">Fleet One</option>
                                <option value="wex">WEX</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Card Number (Last 4 Digits)</label>
                            <input type="text" id="card-last4" maxlength="4" pattern="[0-9]{4}" placeholder="1234" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg tracking-widest focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase mb-2 block">Nickname (Optional)</label>
                            <input type="text" id="card-nickname" placeholder="My Fleet Card" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-lmdr-yellow/50 focus:outline-none">
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-3">
                            <p class="text-xs text-blue-700"><i class="fa-solid fa-info-circle mr-1"></i> Adding your fuel card lets us show you discounted prices at participating locations.</p>
                        </div>
                        <button onclick="submitFuelCard()" class="w-full bg-lmdr-yellow text-slate-900 font-black py-3 rounded-xl hover:shadow-lg transition-all">
                            <i class="fa-solid fa-plus mr-2"></i>ADD CARD
                        </button>
                    </div>
                </div>
            `;

                    document.body.appendChild(modal);

                    // GSAP Modal Animation
                    gsap.fromTo(modal.firstElementChild,
                        { scale: 0.9, opacity: 0 },
                        { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
                    );
                }

                function submitFuelCard() {
                    const provider = document.getElementById('card-provider').value;
                    const last4 = document.getElementById('card-last4').value;
                    const nickname = document.getElementById('card-nickname').value;

                    if (!last4 || last4.length !== 4) {
                        alert('Please enter the last 4 digits of your card.');
                        return;
                    }

                    window.parent.postMessage({
                        type: 'linkFuelCard',
                        data: {
                            cardType: provider,
                            cardLast4: last4,
                            nickname: nickname || `${provider.charAt(0).toUpperCase() + provider.slice(1)} Card`
                        }
                    }, '*');

                    // Close modal and update dropdown
                    document.getElementById('add-card-modal').remove();

                    // Add to dropdown
                    const select = document.getElementById('fuel-card-select');
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = `${provider.charAt(0).toUpperCase() + provider.slice(1)} (**** ${last4})`;
                    option.selected = true;
                    select.appendChild(option);

                    // Re-search with new card
                    searchFuel();
                }

                function loadDriverFuelCards() {
                    window.parent.postMessage({ type: 'getDriverFuelCards' }, '*');
                }

                function updateFuelCardDropdown(cards) {
                    driverFuelCards = cards || [];
                    const select = document.getElementById('fuel-card-select');

                    // Keep the "No Card" option
                    select.innerHTML = '<option value="none">No Card (Retail Price)</option>';

                    cards.forEach(card => {
                        const option = document.createElement('option');
                        option.value = card.card_type;
                        option.textContent = `${card.nickname || card.card_type} (**** ${card.card_last4})`;
                        select.appendChild(option);
                    });

                    // Select first card if available
                    if (cards.length > 0) {
                        select.value = cards[0].card_type;
                    }
                }

                // ==========================================
                // POSTMESSAGE HANDLER
                // ==========================================
                window.addEventListener('message', (event) => {
                    const { type, data } = event.data || {};

                    switch (type) {
                        case 'parkingResults':
                            document.getElementById('parking-loading')?.classList.add('hidden');
                            renderParkingResults(data);
                            break;

                        case 'fuelResults':
                            renderFuelResults(data.items || data);
                            break;

                        case 'fuelCardsLoaded':
                            updateFuelCardDropdown(data.cards || data);
                            break;

                        case 'fuelCardLinked':
                            if (data.success) {
                                console.log('Fuel card linked successfully');
                            }
                            break;

                        case 'fuelSavingsCalculated':
                            // Handle savings calculation result if needed
                            break;

                        case 'error':
                            console.error('Error from Wix:', data);
                            document.getElementById('parking-loading')?.classList.add('hidden');
                            document.getElementById('fuel-loading')?.classList.add('hidden');
                            break;
                    }
                });

                // Initialize on load
                // Initialize on load
                document.addEventListener('DOMContentLoaded', () => {
                    loadDriverFuelCards();

                    // Standalone Debug Mode
                    if (window.parent === window) {
                        console.warn('Running in standalone mode - Simulating Backend Data');

                        // Simulate Fuel Cards
                        setTimeout(() => {
                            updateFuelCardDropdown([
                                { card_type: 'comdata', card_last4: '4521', nickname: 'Comdata' },
                                { card_type: 'efs', card_last4: '8892', nickname: 'EFS' }
                            ]);
                        }, 500);

                        // Simulate Parking Results
                        setTimeout(() => {
                            renderParkingResults([
                                { _id: '1', name: 'Loves Travel Stop #452', available_spaces: 12, total_spaces: 80, distance_miles: 2.4, address: { city: 'Memphis', state: 'TN' }, amenities: ['shower', 'food', 'wifi'], location: { lat: 35.1495, lng: -90.0490 }, data_confidence: 'sensor' },
                                { _id: '2', name: 'Pilot Travel Center', available_spaces: 5, total_spaces: 120, distance_miles: 15.1, address: { city: 'West Memphis', state: 'AR' }, amenities: ['shower', 'fuel'], location: { lat: 35.1595, lng: -90.1490 }, data_confidence: 'reported' },
                                { _id: '3', name: 'Rest Area I-40', available_spaces: 0, total_spaces: 25, distance_miles: 34.2, address: { city: 'Arlington', state: 'TN' }, amenities: [], location: { lat: 35.2495, lng: -89.9490 } }
                            ]);
                        }, 800);

                        // Override postMessage to loop back
                        // We attach a listener for messages we send to ourselves (window -> window)

                        window.addEventListener('message', (event) => {
                            // Ensure we only process our own messages in standalone mode
                            if (event.source !== window) return;

                            const { type } = event.data || {};
                            if (type === 'searchFuel') {
                                console.log('[Standalone] Intercepted searchFuel request');
                                setTimeout(() => {
                                    renderFuelResults([
                                        { _id: 'f1', name: 'Speedway', diesel_price: 3.45, savings: 0.44, distance_miles: 1.2, brand: 'Speedway', address: '123 Main St', has_def: true, location: { lat: 35.14, lng: -90.05 } },
                                        { _id: 'f2', name: 'Maverick', diesel_price: 3.52, savings: 0.37, distance_miles: 3.5, brand: 'Maverick', address: '456 Oak Ave', has_scales: true, location: { lat: 35.12, lng: -90.03 } },
                                        { _id: 'f3', name: 'Chevron', diesel_price: 3.89, savings: 0.00, distance_miles: 0.5, brand: 'Chevron', address: '789 Pine Ln', location: { lat: 35.15, lng: -90.05 } }
                                    ]);
                                    console.log('[Standalone] Rendered mock fuel results');
                                }, 1000);
                            }
                        });
                    }
                });
            </script>
    </main>
</body>

</html>