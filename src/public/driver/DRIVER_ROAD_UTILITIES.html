<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Road Utilities - LMDR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        tailwind.config = {
// ... existing config ...
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 3px solid #fbbf24; color: #fbbf24; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .leaflet-container { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 min-h-screen pb-20">
<!-- ... existing header and nav ... -->
    <main class="max-w-4xl mx-auto p-4">
        <!-- Parking Finder Section -->
        <section id="section-parking" class="space-y-4">
            <!-- Search & Filters (keep as is) -->
            <!-- ... -->

            <!-- View Toggle -->
            <div class="flex justify-between items-center">
                <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Nearby Results</h2>
                <div class="bg-white rounded-lg border border-slate-200 p-1 flex">
                    <button id="view-list-btn" onclick="toggleView('list')" class="px-3 py-1 text-xs font-bold rounded bg-slate-900 text-white">LIST</button>
                    <button id="view-map-btn" onclick="toggleView('map')" class="px-3 py-1 text-xs font-bold rounded text-slate-500">MAP</button>
                </div>
            </div>

            <!-- Content Area (List and Map) -->
            <div class="relative min-h-[400px]">
                <!-- Results List -->
                <div id="parking-results" class="space-y-3">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Map Container -->
                <div id="parking-map-container" class="hidden absolute inset-0 bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm min-h-[500px]">
                    <div id="map"></div>
                    <button onclick="searchThisArea()" class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-white text-slate-900 font-black px-4 py-2 rounded-full text-xs shadow-xl border border-slate-200 hover:bg-slate-50 transition-all">
                        <i class="fa-solid fa-arrows-rotate mr-1"></i> SEARCH THIS AREA
                    </button>
                </div>
            </div>
<!-- ... -->
    <script>
        let map;
        let markers = [];
        let currentView = 'list';

        function initMap() {
            if (map) return;
            map = L.map('map').setView([35.1495, -90.0490], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        function toggleView(view) {
            currentView = view;
            const list = document.getElementById('parking-results');
            const mapContainer = document.getElementById('parking-map-container');
            const listBtn = document.getElementById('view-list-btn');
            const mapBtn = document.getElementById('view-map-btn');

            if (view === 'map') {
                list.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                listBtn.classList.remove('bg-slate-900', 'text-white');
                listBtn.classList.add('text-slate-500');
                mapBtn.classList.add('bg-slate-900', 'text-white');
                mapBtn.classList.remove('text-slate-500');
                
                setTimeout(() => {
                    initMap();
                    map.invalidateSize();
                }, 100);
            } else {
                list.classList.remove('hidden');
                mapContainer.classList.add('hidden');
                mapBtn.classList.remove('bg-slate-900', 'text-white');
                mapBtn.classList.add('text-slate-500');
                listBtn.classList.add('bg-slate-900', 'text-white');
                listBtn.classList.remove('text-slate-500');
            }
        }

        function renderParkingResults(items) {
            const container = document.getElementById('parking-results');
            container.innerHTML = '';
            
            if (map) {
                markers.forEach(m => map.removeLayer(m));
                markers = [];
            }

            if (!items || items.length === 0) {
                container.classList.add('hidden');
                document.getElementById('parking-empty').classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            document.getElementById('parking-empty').classList.add('hidden');

            items.forEach(item => {
                // Render List Card
                const statusColor = getStatusColor(item);
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:border-lmdr-yellow transition-all';
                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-black text-slate-900 group-hover:text-lmdr-blue transition-colors">${item.name}</h3>
                                <p class="text-xs text-slate-500">${item.address?.city || ''}, ${item.address?.state || ''}</p>
                            </div>
                            <div class="${statusColor.bg} ${statusColor.text} px-2 py-1 rounded text-[10px] font-black uppercase">
                                ${statusColor.label}
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex-grow bg-gray-100 h-2 rounded-full overflow-hidden">
                                <div class="${statusColor.bar} h-full" style="width: ${item.total_spaces > 0 ? (item.available_spaces / item.total_spaces * 100) : 0}%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-700">${item.available_spaces || 0} / ${item.total_spaces || '?'}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex gap-2 text-gray-400 text-sm">
                                ${renderAmenityIcons(item.amenities)}
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Distance</p>
                                <p class="text-sm font-black text-slate-900">${item.distance_miles} mi</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 flex gap-2">
                        <button onclick="navigate('${item.location.lat}', '${item.location.lng}')" class="flex-grow bg-slate-900 text-white font-bold py-2 rounded-lg text-xs hover:bg-slate-800 transition-all">NAVIGATE</button>
                        <button onclick="showDetails('${item._id}')" class="bg-white border border-slate-200 text-slate-700 font-bold px-4 py-2 rounded-lg text-xs hover:bg-gray-50 transition-all">DETAILS</button>
                    </div>
                `;
                container.appendChild(card);

                // Add Marker to Map
                if (map) {
                    const marker = L.circleMarker([item.location.lat, item.location.lng], {
                        radius: 8,
                        fillColor: statusColor.hex,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(`<b>${item.name}</b><br>${item.available_spaces} spaces available`);
                    markers.push(marker);
                }
            });

            if (map && items.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function getStatusColor(item) {
            const ratio = item.available_spaces / item.total_spaces;
            if (item.available_spaces === 0) return { bg: 'bg-red-100', text: 'text-red-700', bar: 'bg-red-500', hex: '#ef4444', label: 'Full' };
            if (ratio < 0.1 || item.available_spaces < 5) return { bg: 'bg-yellow-100', text: 'text-yellow-700', bar: 'bg-yellow-500', hex: '#eab308', label: 'Limited' };
            return { bg: 'bg-green-100', text: 'text-green-700', bar: 'bg-green-500', hex: '#22c55e', label: 'Available' };
        }

        function renderAmenityIcons(amenities) {
            if (!amenities) return '';
            const map = {
                'shower': 'fa-shower',
                'wifi': 'fa-wifi',
                'food': 'fa-utensils',
                'fuel': 'fa-gas-pump'
            };
            return amenities.map(a => `<i class="fa-solid ${map[a] || 'fa-circle-info'}"></i>`).join('');
        }

        function searchThisArea() {
            const center = map.getCenter();
            const bounds = map.getBounds();
            const radius = map.distance(center, bounds.getNorthWest()) / 1609.34; // meters to miles
            
            document.getElementById('parking-loading').classList.remove('hidden');
            window.parent.postMessage({ 
                type: 'searchParking', 
                data: { lat: center.lat, lng: center.lng, radius: radius } 
            }, '*');
        }
    </script>
</body>
</html>
