<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Community Forums | LMDR</title>
    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            blue: '#2563eb',
                            dark: '#0f172a',
                            yellow: '#fbbf24',
                            canvas: '#f1f5f9'
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        /* Dark mode background override */
        html.dark body { background: #0f172a; }
        html.dark .bg-white { background-color: #1e293b; }
        html.dark .text-slate-900 { color: #f1f5f9; }
        html.dark .text-slate-800 { color: #e2e8f0; }
        html.dark .text-slate-600 { color: #cbd5e1; }
        html.dark .text-slate-500 { color: #94a3b8; }
        html.dark .text-slate-400 { color: #64748b; }
        html.dark .border-slate-100, html.dark .border-slate-200 { border-color: #334155; }
        html.dark .hover\:bg-slate-50:hover { background-color: #334155; }

        .markdown-body p { margin-bottom: 0.75rem; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-body blockquote { border-left: 4px solid #cbd5e1; padding-left: 1rem; color: #64748b; font-style: italic; }
        .markdown-body code { background-color: #f1f5f9; padding: 0.2rem 0.4rem; rounded: 0.25rem; font-size: 0.875em; font-family: monospace; }
        html.dark .markdown-body code { background-color: #334155; color: #e2e8f0; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
            <div class="flex items-center gap-4">
                <button id="back-btn" onclick="goBack()" class="hidden w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-lmdr-blue hover:border-lmdr-blue transition shadow-sm">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div>
                    <h1 id="page-title" class="text-3xl font-black text-slate-900 mb-1">Community Forums</h1>
                    <p id="page-subtitle" class="text-slate-500 font-medium">Connect with other drivers and share advice.</p>
                </div>
            </div>

            <div class="flex gap-3 items-center">
                <!-- Search -->
                <div class="relative hidden md:block">
                    <input type="text" placeholder="Search discussions..." 
                        class="pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl w-64 focus:ring-2 focus:ring-lmdr-blue focus:border-transparent transition text-sm">
                    <i class="fa-solid fa-search absolute left-3.5 top-3.5 text-slate-400 text-sm"></i>
                </div>

                <!-- Theme Toggle -->
                <button id="themeToggle" onclick="toggleTheme()"
                    class="w-10 h-10 bg-white rounded-xl border border-slate-200 text-slate-500 hover:border-lmdr-blue transition shadow-sm flex items-center justify-center">
                    <i class="fa-solid fa-sun"></i>
                </button>

                <!-- New Thread Button -->
                <button onclick="openCreateThread()" 
                    class="bg-lmdr-blue text-white px-5 py-2.5 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">New Thread</span>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="main-content" class="min-h-[400px]">
            <!-- Views will be injected here -->
            <div id="loading-spinner" class="flex justify-center items-center py-20">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-lmdr-blue"></i>
            </div>
        </main>
    </div>

    <!-- CREATE THREAD MODAL -->
    <div id="create-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh] animate-fade-in">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900">Start a New Discussion</h3>
                <button onclick="closeCreateThread()" class="text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Category</label>
                    <select id="new-thread-category" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-lmdr-blue outline-none transition font-medium">
                        <!-- Options injected -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Title</label>
                    <input type="text" id="new-thread-title" placeholder="What's on your mind?" 
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-lmdr-blue outline-none transition font-bold text-lg">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Content</label>
                    <textarea id="new-thread-content" rows="6" placeholder="Share your thoughts... (Markdown supported)"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-lmdr-blue outline-none transition font-medium resize-none"></textarea>
                    <p class="text-xs text-slate-400 mt-1 text-right">Markdown supported **bold** *italic*</p>
                </div>
            </div>

            <div class="p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-2xl">
                <button onclick="closeCreateThread()" class="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">Cancel</button>
                <button onclick="submitNewThread()" class="px-6 py-2.5 bg-lmdr-blue text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100">
                    Post Discussion
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE & CONFIG
        // ==========================================
        let currentState = {
            view: 'categories', // categories, threadList, threadDetail
            categoryId: null,
            categorySlug: null,
            threadId: null,
            threadSlug: null,
            categories: [], // Cache
            threads: [],    // Cache for current category
            posts: []       // Cache for current thread
        };

        // ==========================================
        // COMMUNICATION BRIDGE
        // ==========================================
        function sendToVelo(type, payload = {}) {
            if (window.parent) {
                window.parent.postMessage({ type, payload }, '*');
            }
        }

        window.onmessage = (event) => {
            const { type, payload } = event.data || {};
            if (!type) return;

            // console.log(`ðŸ“© Received: ${type}`, payload);

            switch (type) {
                case 'categoriesData':
                    currentState.categories = payload.items;
                    if(currentState.view === 'categories') renderCategories();
                    updateCategorySelect();
                    break;
                
                case 'threadsData':
                    currentState.threads = payload.items;
                    renderThreadList(payload.category);
                    break;
                
                case 'threadDetailData':
                    currentState.posts = payload.posts;
                    renderThreadDetail(payload.thread, payload.posts);
                    break;

                case 'postCreated':
                    // Optimistic update was likely done, but here we can refresh
                    // fetchPosts(currentState.threadId);
                    break;

                case 'threadCreated':
                    closeCreateThread();
                    // Navigate to new thread
                    navigateTo('threadDetail', { threadSlug: payload.slug });
                    break;
                
                case 'xpAwarded':
                    showToast(`+${payload.xp} XP: ${payload.action}`);
                    break;
            }
        };

        // ==========================================
        // NAVIGATION & ROUTING
        // ==========================================
        function navigateTo(view, params = {}) {
            currentState.view = view;
            const backBtn = document.getElementById('back-btn');
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            const mainContent = document.getElementById('main-content');
            
            mainContent.innerHTML = '<div class="flex justify-center items-center py-20"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-lmdr-blue"></i></div>';

            if (view === 'categories') {
                backBtn.classList.add('hidden');
                pageTitle.textContent = 'Community Forums';
                pageSubtitle.textContent = 'Connect with other drivers and share advice.';
                sendToVelo('getCategories');
            } 
            else if (view === 'threadList') {
                backBtn.classList.remove('hidden');
                currentState.categoryId = params.categoryId;
                currentState.categorySlug = params.categorySlug; // Optional
                sendToVelo('getThreads', { categoryId: params.categoryId });
            } 
            else if (view === 'threadDetail') {
                backBtn.classList.remove('hidden');
                currentState.threadId = params.threadId; // Might need to fetch by slug if coming from url
                currentState.threadSlug = params.threadSlug;
                
                if (params.threadId) {
                    sendToVelo('getPosts', { threadId: params.threadId });
                } else if (params.threadSlug) {
                    sendToVelo('getThreadBySlug', { slug: params.threadSlug });
                }
            }
        }

        function goBack() {
            if (currentState.view === 'threadDetail') {
                // If we have category info, go there, else home
                if (currentState.categoryId) {
                    navigateTo('threadList', { categoryId: currentState.categoryId });
                } else {
                    navigateTo('categories');
                }
            } else {
                navigateTo('categories');
            }
        }

        // ==========================================
        // RENDERERS
        // ==========================================

        function renderCategories() {
            const container = document.getElementById('main-content');
            const cats = currentState.categories;
            
            if (!cats || cats.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-10">No categories found.</div>`;
                return;
            }

            let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">`;
            
            cats.forEach(cat => {
                html += `
                    <div onclick="navigateTo('threadList', {categoryId: '${cat._id}'})" 
                        class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:border-lmdr-blue hover:shadow-md transition cursor-pointer group flex items-start gap-5">
                        <div class="w-14 h-14 rounded-xl bg-blue-50 text-lmdr-blue flex items-center justify-center text-2xl flex-none group-hover:scale-110 transition">
                            <i class="${cat.icon || 'fa-solid fa-comments'}"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-slate-900 mb-1 group-hover:text-lmdr-blue transition">${cat.title}</h3>
                            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${cat.description}</p>
                            <div class="flex items-center gap-4 text-xs font-bold text-slate-400 uppercase tracking-wide">
                                <span>${cat.threadCount || 0} Threads</span>
                                <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                <span>${cat.postCount || 0} Posts</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderThreadList(category) {
            const container = document.getElementById('main-content');
            
            // Update Header
            document.getElementById('page-title').textContent = category.title;
            document.getElementById('page-subtitle').textContent = category.description;
            
            currentState.categoryId = category._id; // Ensure state sync

            const threads = currentState.threads;

            if (!threads || threads.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-200">
                        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                            <i class="fa-solid fa-comment-slash"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900">No discussions yet</h3>
                        <p class="text-slate-500 mb-6">Be the first to start a conversation in ${category.title}!</p>
                        <button onclick="openCreateThread('${category._id}')" class="text-lmdr-blue font-bold hover:underline">Start a Thread</button>
                    </div>
                `;
                return;
            }

            let html = `<div class="space-y-4 animate-fade-in">`;
            
            threads.forEach(thread => {
                const date = new Date(thread.lastActivityAt || thread.createdAt);
                const timeAgo = getTimeAgo(date);

                html += `
                    <div onclick="navigateTo('threadDetail', {threadId: '${thread._id}', threadSlug: '${thread.slug}'})"
                        class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:border-lmdr-blue transition cursor-pointer group">
                        <div class="flex items-start gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    ${thread.isPinned ? `<span class="bg-yellow-100 text-yellow-700 text-[10px] font-black px-1.5 py-0.5 rounded uppercase tracking-wide"><i class="fa-solid fa-thumbtack mr-1"></i>Pinned</span>` : ''}
                                    <h3 class="text-lg font-bold text-slate-900 group-hover:text-lmdr-blue transition line-clamp-1">${thread.title}</h3>
                                </div>
                                <p class="text-sm text-slate-500 line-clamp-2 mb-3">${thread.contentPreview || 'No preview available...'}</p>
                                <div class="flex items-center gap-3 text-xs text-slate-400">
                                    <span class="flex items-center gap-1.5"><img src="https://ui-avatars.com/api/?name=User&background=random" class="w-5 h-5 rounded-full"> Author</span>
                                    <span>â€¢</span>
                                    <span>${timeAgo}</span>
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-end gap-2 text-right pl-4 border-l border-slate-50">
                                <div class="flex items-center gap-1.5 text-slate-600 font-bold">
                                    <i class="fa-regular fa-comment-dots"></i> ${thread.replyCount || 0}
                                </div>
                                <div class="text-xs text-slate-400">replies</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderThreadDetail(thread, posts) {
            const container = document.getElementById('main-content');
            
            // Update Header
            document.getElementById('page-title').textContent = thread.title;
            document.getElementById('page-subtitle').textContent = `Posted in ${currentState.categories.find(c => c._id === thread.categoryId)?.title || 'Forum'}`;
            
            currentState.threadId = thread._id;
            currentState.categoryId = thread.categoryId; // Sync back

            let html = `<div class="space-y-6 animate-fade-in pb-20">`;
            
            // Posts
            posts.forEach((post, index) => {
                const isOP = index === 0; // First post is OP
                const date = new Date(post.createdAt);
                
                html += `
                    <div class="bg-white rounded-2xl border ${isOP ? 'border-blue-100 shadow-md' : 'border-slate-100 shadow-sm'} overflow-hidden" id="post-${post._id}">
                        <div class="p-6 flex gap-6">
                            <!-- Author Side -->
                            <div class="hidden md:flex flex-col items-center w-32 flex-none space-y-2">
                                <img src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-16 h-16 rounded-full border-4 border-slate-50">
                                <div class="text-center">
                                    <div class="font-bold text-slate-900 text-sm">Driver Name</div>
                                    <div class="text-xs text-lmdr-blue font-bold">Road Legend</div>
                                    <div class="text-[10px] text-slate-400 mt-1">Level 10</div>
                                </div>
                            </div>

                            <!-- Content Side -->
                            <div class="flex-1 min-w-0">
                                <!-- Mobile Author Header -->
                                <div class="md:hidden flex items-center gap-3 mb-4 pb-3 border-b border-slate-50">
                                    <img src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full">
                                    <div>
                                        <div class="font-bold text-slate-900 text-sm">Driver Name</div>
                                        <div class="text-xs text-slate-400">Road Legend</div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-start mb-4">
                                    <div class="text-xs text-slate-400 font-bold uppercase tracking-wide">
                                        ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                    ${post.isBestAnswer ? `<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold"><i class="fa-solid fa-check mr-1"></i>Best Answer</span>` : ''}
                                </div>

                                <div class="markdown-body text-slate-700 text-sm md:text-base">
                                    ${marked.parse(post.content || '')}
                                </div>

                                <div class="mt-6 pt-4 border-t border-slate-50 flex items-center justify-between">
                                    <button onclick="likePost('${post._id}')" class="text-slate-400 hover:text-red-500 transition flex items-center gap-1.5 text-sm font-bold group">
                                        <i class="fa-regular fa-heart group-hover:fa-solid"></i> <span>${post.likeCount || 0}</span>
                                    </button>
                                    
                                    <div class="flex gap-3">
                                        <button onclick="reportPost('${post._id}')" class="text-slate-300 hover:text-slate-500 text-xs font-bold">Report</button>
                                        <button onclick="replyTo('${post._id}')" class="text-lmdr-blue hover:text-blue-700 text-xs font-bold">Reply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Reply Box
            html += `
                <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6 mt-6">
                    <h3 class="text-sm font-bold text-slate-900 mb-3">Leave a Reply</h3>
                    <textarea id="reply-content" rows="4" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-lmdr-blue outline-none transition font-medium resize-none mb-3" placeholder="Write your response..."></textarea>
                    <div class="flex justify-end">
                        <button onclick="submitReply()" class="bg-lmdr-blue text-white px-6 py-2.5 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100">
                            Post Reply
                        </button>
                    </div>
                </div>
            `;
            
            html += `</div>`;
            container.innerHTML = html;
        }

        // ==========================================
        // ACTIONS
        // ==========================================

        function openCreateThread(preselectCatId) {
            document.getElementById('create-modal').classList.remove('hidden');
            if (preselectCatId) {
                const select = document.getElementById('new-thread-category');
                select.value = preselectCatId;
            }
        }

        function closeCreateThread() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        function updateCategorySelect() {
            const select = document.getElementById('new-thread-category');
            if (!select) return;
            
            select.innerHTML = currentState.categories.map(cat => 
                `<option value="${cat._id}">${cat.title}</option>`
            ).join('');
        }

        function submitNewThread() {
            const title = document.getElementById('new-thread-title').value.trim();
            const content = document.getElementById('new-thread-content').value.trim();
            const categoryId = document.getElementById('new-thread-category').value;

            if (!title || !content || !categoryId) {
                alert('Please fill in all fields');
                return;
            }

            // UI Feedback
            const btn = document.querySelector('#create-modal button:last-child');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Posting...';
            btn.disabled = true;

            sendToVelo('createThread', { title, content, categoryId });
            
            // Wait for response 'threadCreated'
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 5000); // Timeout fallback
        }

        function submitReply() {
            const content = document.getElementById('reply-content').value.trim();
            if (!content) return;

            const btn = document.querySelector('button[onclick="submitReply()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            sendToVelo('createPost', { 
                threadId: currentState.threadId, 
                content 
            });

            // Optimistic UI update
            setTimeout(() => {
                document.getElementById('reply-content').value = '';
                btn.innerHTML = 'Post Reply';
                btn.disabled = false;
                // Add dummy post or wait for refresh
                sendToVelo('getPosts', { threadId: currentState.threadId });
            }, 500);
        }

        function likePost(postId) {
            sendToVelo('likePost', { postId });
            // Optimistic update
            // const countEl = document.querySelector(`#post-${postId} .fa-heart`).nextElementSibling;
            // countEl.textContent = parseInt(countEl.textContent) + 1;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return "Just now";
        }

        // ==========================================
        // THEME (Shared Logic)
        // ==========================================
        const THEME_KEY = 'lmdr-driver-theme';
        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light'); // Default to dark for gamers/drivers
            if (theme === 'dark') document.documentElement.classList.add('dark');
            updateThemeIcon(theme);
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            const theme = isDark ? 'dark' : 'light';
            localStorage.setItem(THEME_KEY, theme);
            updateThemeIcon(theme);
        }
        function updateThemeIcon(theme) {
            const icon = document.querySelector('#themeToggle i');
            if (icon) icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        // Init
        initTheme();
        window.onload = () => {
            // Initial Data Load
            sendToVelo('ready');
            sendToVelo('getCategories');
        };

    </script>
</body>
</html>