<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenges | LMDR</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            blue: '#2563eb',
                            dark: '#0f172a',
                            yellow: '#fbbf24',
                            canvas: '#f1f5f9'
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .tab-btn {
            @apply px-4 py-2.5 text-sm font-bold rounded-xl transition relative;
        }
        .tab-btn.active {
            @apply bg-white text-lmdr-blue shadow-sm;
        }
        .tab-btn:not(.active) {
            @apply text-slate-500 hover:text-slate-700;
        }
        .tab-btn .badge {
            @apply absolute -top-1 -right-1 w-5 h-5 bg-lmdr-blue text-white text-[10px] font-bold rounded-full flex items-center justify-center;
        }

        .challenge-type-daily { @apply bg-blue-100 text-blue-700 border-blue-200; }
        .challenge-type-weekly { @apply bg-purple-100 text-purple-700 border-purple-200; }
        .challenge-type-monthly { @apply bg-amber-100 text-amber-700 border-amber-200; }
        .challenge-type-event { @apply bg-gradient-to-r from-pink-500 to-rose-500 text-white border-pink-300; }
        .challenge-type-one_time { @apply bg-emerald-100 text-emerald-700 border-emerald-200; }

        .progress-bar {
            @apply h-2.5 rounded-full bg-slate-200 overflow-hidden;
        }
        .progress-fill {
            @apply h-full rounded-full transition-all duration-500;
        }
        .progress-fill-active { @apply bg-lmdr-blue; }
        .progress-fill-complete { @apply bg-green-500; }

        .challenge-card {
            @apply bg-white rounded-2xl p-5 border border-slate-100 transition;
        }
        .challenge-card:hover {
            @apply border-lmdr-blue shadow-md;
        }
        .challenge-card.complete {
            @apply bg-green-50 border-green-200;
        }
        .challenge-card.expired {
            @apply bg-slate-50 border-slate-200 opacity-60;
        }

        .reward-badge {
            @apply inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold;
        }
        .reward-xp { @apply bg-blue-100 text-blue-700; }
        .reward-points { @apply bg-purple-100 text-purple-700; }
        .reward-special { @apply bg-gradient-to-r from-amber-400 to-orange-500 text-white; }

        .time-badge {
            @apply inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium;
        }
        .time-urgent { @apply bg-red-100 text-red-600; }
        .time-normal { @apply bg-slate-100 text-slate-500; }

        /* Dark mode */
        html.dark body { background: #0f172a; }
        html.dark .bg-white { background-color: #1e293b; }
        html.dark .bg-slate-50 { background-color: #0f172a; }
        html.dark .bg-slate-100 { background-color: #1e293b; }
        html.dark .text-slate-900 { color: #f1f5f9; }
        html.dark .text-slate-700 { color: #cbd5e1; }
        html.dark .text-slate-500 { color: #94a3b8; }
        html.dark .text-slate-400 { color: #64748b; }
        html.dark .border-slate-100 { border-color: #334155; }
        html.dark .border-slate-200 { border-color: #475569; }
        html.dark .challenge-card { background-color: #1e293b; border-color: #334155; }
        html.dark .challenge-card:hover { border-color: #3b82f6; }
        html.dark .challenge-card.complete { background-color: rgba(34, 197, 94, 0.1); border-color: #22c55e; }
        html.dark .progress-bar { background-color: #334155; }
        html.dark .tab-btn.active { background-color: #1e293b; color: #60a5fa; }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen p-4 md:p-8">

    <div class="max-w-3xl mx-auto">

        <!-- HEADER -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-slate-900 mb-1">Challenges</h1>
                    <p class="text-slate-500 text-sm font-medium">Complete challenges to earn bonus XP</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-black text-lmdr-blue" id="total-completed">0</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Completed</div>
                </div>
            </div>

            <!-- TABS -->
            <div class="flex gap-2 p-1.5 bg-slate-100 rounded-xl overflow-x-auto">
                <button onclick="setTab('active')" class="tab-btn active flex-1 min-w-[80px]" data-tab="active">
                    <i class="fa-solid fa-bullseye mr-1.5"></i>Active
                    <span class="badge hidden" id="active-count">0</span>
                </button>
                <button onclick="setTab('available')" class="tab-btn flex-1 min-w-[80px]" data-tab="available">
                    <i class="fa-solid fa-plus mr-1.5"></i>Available
                </button>
                <button onclick="setTab('completed')" class="tab-btn flex-1 min-w-[80px]" data-tab="completed">
                    <i class="fa-solid fa-check mr-1.5"></i>Completed
                </button>
            </div>
        </header>

        <!-- LOADING STATE -->
        <div id="loading-state" class="py-20 text-center">
            <div class="w-12 h-12 border-4 border-lmdr-blue border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-400 font-medium">Loading challenges...</p>
        </div>

        <!-- ACTIVE CHALLENGES -->
        <div id="active-section" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-slate-900">Your Active Challenges</h2>
                <span class="text-sm text-slate-400" id="active-subtitle">0 in progress</span>
            </div>

            <div id="active-list" class="space-y-4">
                <!-- Cards rendered by JS -->
            </div>

            <div id="active-empty" class="hidden py-16 text-center">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                    <i class="fa-solid fa-bullseye"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 mb-2">No active challenges</h3>
                <p class="text-slate-500 text-sm mb-4">Start a challenge from the Available tab</p>
                <button onclick="setTab('available')" class="px-4 py-2 bg-lmdr-blue text-white font-bold rounded-xl hover:bg-blue-700 transition">
                    Browse Challenges
                </button>
            </div>
        </div>

        <!-- AVAILABLE CHALLENGES -->
        <div id="available-section" class="hidden">
            <!-- Filter by type -->
            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                <button onclick="filterType('all')" class="filter-btn active" data-filter="all">All</button>
                <button onclick="filterType('daily')" class="filter-btn" data-filter="daily">Daily</button>
                <button onclick="filterType('weekly')" class="filter-btn" data-filter="weekly">Weekly</button>
                <button onclick="filterType('monthly')" class="filter-btn" data-filter="monthly">Monthly</button>
                <button onclick="filterType('event')" class="filter-btn" data-filter="event">Events</button>
            </div>

            <div id="available-list" class="space-y-4">
                <!-- Cards rendered by JS -->
            </div>

            <div id="available-empty" class="hidden py-16 text-center">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                    <i class="fa-solid fa-trophy"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 mb-2">No challenges available</h3>
                <p class="text-slate-500 text-sm">Check back later for new challenges!</p>
            </div>
        </div>

        <!-- COMPLETED CHALLENGES -->
        <div id="completed-section" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-slate-900">Completed Challenges</h2>
                <span class="text-sm text-slate-400" id="completed-subtitle">0 total</span>
            </div>

            <div id="completed-list" class="space-y-4">
                <!-- Cards rendered by JS -->
            </div>

            <div id="completed-empty" class="hidden py-16 text-center">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                    <i class="fa-solid fa-check-circle"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 mb-2">No completed challenges yet</h3>
                <p class="text-slate-500 text-sm">Complete your first challenge to see it here!</p>
            </div>
        </div>

    </div>

    <!-- CLAIM REWARD MODAL -->
    <div id="claim-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-8 text-center animate-bounce-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-check text-green-500 text-4xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-900 mb-2">Challenge Complete!</h2>
            <p class="text-slate-500 mb-2" id="claim-challenge-title">You completed a challenge</p>
            <div class="text-3xl font-black text-lmdr-blue mb-6" id="claim-reward">+100 XP</div>
            <button onclick="confirmClaim()" class="w-full py-3 bg-lmdr-dark text-white rounded-xl font-bold hover:bg-slate-800 transition">
                Claim Reward
            </button>
        </div>
    </div>

    <!-- CHALLENGE DETAIL MODAL -->
    <div id="detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6 animate-slide-up">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-lmdr-blue text-white flex items-center justify-center text-xl" id="detail-icon">
                        <i class="fa-solid fa-bullseye"></i>
                    </div>
                    <div>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full challenge-type-daily uppercase" id="detail-type">Daily</span>
                        <h3 class="text-lg font-bold text-slate-900 mt-1" id="detail-title">Challenge Title</h3>
                    </div>
                </div>
                <button onclick="closeDetail()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <p class="text-slate-500 mb-4" id="detail-description">Challenge description goes here.</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-50 rounded-xl p-3 text-center">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Reward</div>
                    <div class="text-lg font-black text-lmdr-blue" id="detail-reward">+100 XP</div>
                </div>
                <div class="bg-slate-50 rounded-xl p-3 text-center">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Time Left</div>
                    <div class="text-lg font-black text-slate-900" id="detail-time">23h 45m</div>
                </div>
            </div>

            <!-- Progress (for active challenges) -->
            <div id="detail-progress-section" class="mb-6">
                <div class="flex justify-between text-sm mb-2">
                    <span class="font-bold text-slate-700">Progress</span>
                    <span class="text-slate-500" id="detail-progress-text">0/5</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill progress-fill-active" id="detail-progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <button id="detail-action-btn" onclick="handleDetailAction()" class="w-full py-3 bg-lmdr-blue text-white rounded-xl font-bold hover:bg-blue-700 transition">
                Start Challenge
            </button>
        </div>
    </div>

    <style>
        .filter-btn {
            @apply px-3 py-1.5 text-xs font-bold rounded-lg transition whitespace-nowrap;
        }
        .filter-btn.active {
            @apply bg-lmdr-blue text-white;
        }
        .filter-btn:not(.active) {
            @apply bg-slate-100 text-slate-600 hover:bg-slate-200;
        }

        @keyframes bounce-in {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in { animation: bounce-in 0.4s ease-out; }

        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
    </style>

    <script>
        // ==========================================
        // STATE
        // ==========================================
        let currentTab = 'active';
        let currentFilter = 'all';
        let activeChallenges = [];
        let availableChallenges = [];
        let completedChallenges = [];
        let selectedChallenge = null;
        let pendingClaimId = null;
        let userType = 'driver'; // Will be set from Velo

        // ==========================================
        // MESSAGE HANDLING
        // ==========================================
        function isValidOrigin(event) {
            if (window.parent === window) return false;
            if (event.source !== window.parent) return false;
            return true;
        }

        function validateMessageSchema(msg) {
            if (!msg || typeof msg !== 'object') return false;
            if (typeof msg.type !== 'string' || msg.type.length === 0) return false;
            return true;
        }

        function stripHtml(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function sendToVelo(type, data = {}) {
            console.log(`ðŸ“¤ [HTMLâ†’Velo] ${type}`, data);
            window.parent.postMessage({ type, data }, '*');
        }

        window.addEventListener('message', (event) => {
            if (!isValidOrigin(event)) return;
            const msg = event.data;
            if (!validateMessageSchema(msg)) return;

            console.log(`ðŸ“¥ [Veloâ†’HTML] ${msg.type}`, msg.data);

            switch (msg.type) {
                case 'challengesData':
                    handleChallengesData(msg.data);
                    break;
                case 'challengeStarted':
                    handleChallengeStarted(msg.data);
                    break;
                case 'challengeProgress':
                    handleChallengeProgress(msg.data);
                    break;
                case 'challengeComplete':
                    handleChallengeComplete(msg.data);
                    break;
                case 'rewardClaimed':
                    handleRewardClaimed(msg.data);
                    break;
                case 'error':
                    console.error('Challenge error:', msg.data?.message);
                    break;
            }
        });

        console.log('LMDR Challenges Hub Ready');
        sendToVelo('challengesReady');

        // ==========================================
        // DATA HANDLERS
        // ==========================================
        function handleChallengesData(data) {
            if (!data) return;

            userType = data.userType || 'driver';
            activeChallenges = data.active || [];
            availableChallenges = data.available || [];
            completedChallenges = data.completed || [];

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('total-completed').textContent = completedChallenges.length;

            // Update active count badge
            const activeCountBadge = document.getElementById('active-count');
            if (activeChallenges.length > 0) {
                activeCountBadge.textContent = activeChallenges.length;
                activeCountBadge.classList.remove('hidden');
            } else {
                activeCountBadge.classList.add('hidden');
            }

            renderCurrentTab();
        }

        function handleChallengeStarted(data) {
            if (!data) return;

            // Move from available to active
            const index = availableChallenges.findIndex(c => c._id === data._id);
            if (index >= 0) {
                const challenge = { ...availableChallenges[index], ...data, progress: 0 };
                availableChallenges.splice(index, 1);
                activeChallenges.unshift(challenge);
            }

            closeDetail();
            setTab('active');
            renderCurrentTab();
        }

        function handleChallengeProgress(data) {
            if (!data) return;

            const challenge = activeChallenges.find(c => c._id === data._id);
            if (challenge) {
                challenge.progress = data.progress;

                // Check if complete
                if (data.progress >= challenge.target) {
                    showClaimModal(challenge);
                }
            }

            renderCurrentTab();
        }

        function handleChallengeComplete(data) {
            if (!data) return;
            showClaimModal(data);
        }

        function handleRewardClaimed(data) {
            if (!data) return;

            // Move from active to completed
            const index = activeChallenges.findIndex(c => c._id === data._id);
            if (index >= 0) {
                const challenge = { ...activeChallenges[index], completed_at: new Date().toISOString() };
                activeChallenges.splice(index, 1);
                completedChallenges.unshift(challenge);
            }

            closeClaimModal();
            document.getElementById('total-completed').textContent = completedChallenges.length;
            renderCurrentTab();
        }

        // ==========================================
        // RENDER FUNCTIONS
        // ==========================================
        function renderCurrentTab() {
            // Hide all sections
            document.getElementById('active-section').classList.add('hidden');
            document.getElementById('available-section').classList.add('hidden');
            document.getElementById('completed-section').classList.add('hidden');

            // Show current section
            document.getElementById(`${currentTab}-section`).classList.remove('hidden');

            switch (currentTab) {
                case 'active':
                    renderActiveChallenges();
                    break;
                case 'available':
                    renderAvailableChallenges();
                    break;
                case 'completed':
                    renderCompletedChallenges();
                    break;
            }
        }

        function renderActiveChallenges() {
            const list = document.getElementById('active-list');
            const empty = document.getElementById('active-empty');
            const subtitle = document.getElementById('active-subtitle');

            subtitle.textContent = `${activeChallenges.length} in progress`;

            if (activeChallenges.length === 0) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            empty.classList.add('hidden');

            list.innerHTML = activeChallenges.map(challenge => renderChallengeCard(challenge, 'active')).join('');
        }

        function renderAvailableChallenges() {
            const list = document.getElementById('available-list');
            const empty = document.getElementById('available-empty');

            let filtered = availableChallenges;
            if (currentFilter !== 'all') {
                filtered = availableChallenges.filter(c => c.type === currentFilter);
            }

            if (filtered.length === 0) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            empty.classList.add('hidden');

            list.innerHTML = filtered.map(challenge => renderChallengeCard(challenge, 'available')).join('');
        }

        function renderCompletedChallenges() {
            const list = document.getElementById('completed-list');
            const empty = document.getElementById('completed-empty');
            const subtitle = document.getElementById('completed-subtitle');

            subtitle.textContent = `${completedChallenges.length} total`;

            if (completedChallenges.length === 0) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            empty.classList.add('hidden');

            list.innerHTML = completedChallenges.slice(0, 20).map(challenge => renderChallengeCard(challenge, 'completed')).join('');
        }

        function renderChallengeCard(challenge, section) {
            const progress = challenge.progress || 0;
            const target = challenge.target || 1;
            const percent = Math.min((progress / target) * 100, 100);
            const isComplete = progress >= target;
            const canClaim = isComplete && !challenge.claimed && section === 'active';
            const typeClass = `challenge-type-${challenge.type || 'daily'}`;
            const rewardLabel = userType === 'driver' ? 'XP' : 'pts';
            const reward = challenge.xp_reward || challenge.points_reward || 0;

            // Time remaining
            let timeHtml = '';
            if (challenge.expires_at && section !== 'completed') {
                const timeLeft = getTimeRemaining(challenge.expires_at);
                const isUrgent = timeLeft.hours < 2;
                timeHtml = `
                    <span class="time-badge ${isUrgent ? 'time-urgent' : 'time-normal'}">
                        <i class="fa-regular fa-clock"></i>
                        ${timeLeft.text}
                    </span>
                `;
            }

            let cardClass = 'challenge-card';
            if (section === 'completed') cardClass += ' complete';

            let actionHtml = '';
            if (section === 'available') {
                actionHtml = `
                    <button onclick="startChallenge('${challenge._id}')" class="px-4 py-2 bg-lmdr-blue text-white text-sm font-bold rounded-lg hover:bg-blue-700 transition">
                        Start
                    </button>
                `;
            } else if (canClaim) {
                actionHtml = `
                    <button onclick="openClaimModal('${challenge._id}')" class="px-4 py-2 bg-green-500 text-white text-sm font-bold rounded-lg hover:bg-green-600 transition animate-pulse">
                        Claim!
                    </button>
                `;
            }

            let progressHtml = '';
            if (section === 'active') {
                progressHtml = `
                    <div class="mt-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500">Progress</span>
                            <span class="font-bold ${isComplete ? 'text-green-600' : 'text-slate-700'}">${progress}/${target}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${isComplete ? 'progress-fill-complete' : 'progress-fill-active'}" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="${cardClass}" onclick="showDetail('${challenge._id}', '${section}')">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${typeClass} uppercase">${challenge.type}</span>
                                ${timeHtml}
                            </div>
                            <h3 class="text-base font-bold text-slate-900 mb-1">${stripHtml(challenge.title)}</h3>
                            <p class="text-sm text-slate-500 line-clamp-2">${stripHtml(challenge.description || '')}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="reward-badge ${userType === 'driver' ? 'reward-xp' : 'reward-points'} mb-2">
                                <i class="fa-solid fa-bolt"></i>
                                +${reward} ${rewardLabel}
                            </div>
                            ${actionHtml}
                        </div>
                    </div>
                    ${progressHtml}
                </div>
            `;
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function getTimeRemaining(expiresAt) {
            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = expires - now;

            if (diff <= 0) {
                return { hours: 0, text: 'Expired' };
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return { hours, text: `${days}d ${hours % 24}h` };
            }

            return { hours, text: `${hours}h ${minutes}m` };
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        function setTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            renderCurrentTab();
        }

        function filterType(type) {
            currentFilter = type;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === type);
            });

            renderAvailableChallenges();
        }

        function startChallenge(challengeId) {
            event.stopPropagation();
            sendToVelo('startChallenge', { challengeId });
        }

        function showDetail(challengeId, section) {
            const lists = { active: activeChallenges, available: availableChallenges, completed: completedChallenges };
            const challenge = lists[section].find(c => c._id === challengeId);

            if (!challenge) return;
            selectedChallenge = { ...challenge, section };

            const modal = document.getElementById('detail-modal');
            const typeClass = `challenge-type-${challenge.type || 'daily'}`;
            const rewardLabel = userType === 'driver' ? 'XP' : 'pts';
            const reward = challenge.xp_reward || challenge.points_reward || 0;

            document.getElementById('detail-type').className = `text-[10px] font-bold px-2 py-0.5 rounded-full ${typeClass} uppercase`;
            document.getElementById('detail-type').textContent = challenge.type;
            document.getElementById('detail-title').textContent = challenge.title;
            document.getElementById('detail-description').textContent = challenge.description || 'No description available.';
            document.getElementById('detail-reward').textContent = `+${reward} ${rewardLabel}`;

            // Time
            if (challenge.expires_at) {
                const timeLeft = getTimeRemaining(challenge.expires_at);
                document.getElementById('detail-time').textContent = timeLeft.text;
            } else {
                document.getElementById('detail-time').textContent = 'No limit';
            }

            // Progress section
            const progressSection = document.getElementById('detail-progress-section');
            if (section === 'active') {
                progressSection.classList.remove('hidden');
                const progress = challenge.progress || 0;
                const target = challenge.target || 1;
                const percent = Math.min((progress / target) * 100, 100);
                document.getElementById('detail-progress-text').textContent = `${progress}/${target}`;
                document.getElementById('detail-progress-bar').style.width = `${percent}%`;
            } else {
                progressSection.classList.add('hidden');
            }

            // Action button
            const actionBtn = document.getElementById('detail-action-btn');
            if (section === 'available') {
                actionBtn.textContent = 'Start Challenge';
                actionBtn.classList.remove('hidden', 'bg-green-500');
                actionBtn.classList.add('bg-lmdr-blue');
            } else if (section === 'active' && (challenge.progress || 0) >= (challenge.target || 1)) {
                actionBtn.textContent = 'Claim Reward';
                actionBtn.classList.remove('hidden', 'bg-lmdr-blue');
                actionBtn.classList.add('bg-green-500');
            } else {
                actionBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('detail-modal').classList.add('hidden');
            selectedChallenge = null;
        }

        function handleDetailAction() {
            if (!selectedChallenge) return;

            if (selectedChallenge.section === 'available') {
                sendToVelo('startChallenge', { challengeId: selectedChallenge._id });
            } else if (selectedChallenge.section === 'active') {
                openClaimModal(selectedChallenge._id);
            }

            closeDetail();
        }

        function openClaimModal(challengeId) {
            event?.stopPropagation();
            const challenge = activeChallenges.find(c => c._id === challengeId);
            if (!challenge) return;

            pendingClaimId = challengeId;
            const rewardLabel = userType === 'driver' ? 'XP' : 'pts';
            const reward = challenge.xp_reward || challenge.points_reward || 0;

            document.getElementById('claim-challenge-title').textContent = challenge.title;
            document.getElementById('claim-reward').textContent = `+${reward} ${rewardLabel}`;
            document.getElementById('claim-modal').classList.remove('hidden');
        }

        function showClaimModal(challenge) {
            pendingClaimId = challenge._id;
            const rewardLabel = userType === 'driver' ? 'XP' : 'pts';
            const reward = challenge.xp_reward || challenge.points_reward || 0;

            document.getElementById('claim-challenge-title').textContent = challenge.title;
            document.getElementById('claim-reward').textContent = `+${reward} ${rewardLabel}`;
            document.getElementById('claim-modal').classList.remove('hidden');
        }

        function closeClaimModal() {
            document.getElementById('claim-modal').classList.add('hidden');
            pendingClaimId = null;
        }

        function confirmClaim() {
            if (!pendingClaimId) return;
            sendToVelo('claimReward', { challengeId: pendingClaimId });
        }

        // ==========================================
        // THEME
        // ==========================================
        const THEME_KEY = 'lmdr-driver-theme';

        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            document.documentElement.classList.remove('light', 'dark');
            document.documentElement.classList.add(theme);
        }

        window.addEventListener('message', (event) => {
            if (event.data?.type === 'themeChange') {
                applyTheme(event.data.theme);
            }
        });

        initTheme();
    </script>

</body>

</html>
