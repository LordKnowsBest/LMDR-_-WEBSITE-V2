<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LMDR | Mentor Profile</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CDN + Inline config (required for Wix iframes) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'lmdr-blue': '#2563eb',
                        'lmdr-deep': '#1e40af',
                        'lmdr-yellow': '#fbbf24',
                        'lmdr-dark': '#0f172a'
                    },
                    fontFamily: { d: ['Inter', 'sans-serif'] }
                }
            }
        };
    </script>

    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .badge-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .star-filled {
            color: #fbbf24;
        }

        .star-empty {
            color: #334155;
        }

        .specialty-tag {
            background: rgba(99, 102, 241, 0.12);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.25);
            padding: 3px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .request-btn {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            box-shadow: 0 8px 24px -6px rgba(37, 99, 235, 0.5);
            transition: all 0.2s;
        }

        .request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px -6px rgba(37, 99, 235, 0.6);
        }

        .request-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 font-d antialiased min-h-screen">

    <!-- ── LOADING STATE ── -->
    <div id="loadingState" class="flex flex-col items-center justify-center min-h-screen gap-4">
        <div class="w-16 h-16 rounded-full border-4 border-indigo-500/30 border-t-indigo-500 animate-spin"></div>
        <p class="text-slate-400 text-sm">Loading mentor profile…</p>
    </div>

    <!-- ── ERROR STATE ── -->
    <div id="errorState" class="hidden flex flex-col items-center justify-center min-h-screen gap-4 px-6 text-center">
        <div class="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center mb-2">
            <i class="fas fa-user-slash text-red-400 text-3xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-white">Profile Not Found</h2>
        <p class="text-slate-400 max-w-sm">This mentor profile doesn't exist or is no longer active.</p>
        <button onclick="sendToVelo({ action: 'navigate', page: 'mentor-program' })"
            class="mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-semibold transition-colors">
            Browse Mentors
        </button>
    </div>

    <!-- ── MAIN PROFILE ── -->
    <div id="profileContent" class="hidden max-w-4xl mx-auto px-4 sm:px-6 py-8 space-y-6 fade-in">

        <!-- Back Nav -->
        <button onclick="sendToVelo({ action: 'navigate', page: 'mentor-program' })"
            class="flex items-center gap-2 text-slate-400 hover:text-white text-sm font-medium transition-colors group">
            <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
            Back to Mentors
        </button>

        <!-- Hero Card -->
        <div class="glass rounded-2xl overflow-hidden">
            <!-- Banner gradient -->
            <div class="h-28 bg-gradient-to-r from-indigo-900 via-blue-900 to-slate-900 relative">
                <div class="absolute inset-0 opacity-30"
                    style="background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,0.03) 20px, rgba(255,255,255,0.03) 40px);">
                </div>
            </div>

            <div class="px-6 pb-6">
                <!-- Avatar + name row -->
                <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 -mt-10 mb-6">
                    <div class="flex items-end gap-4">
                        <img id="mentorPhoto"
                            src="https://ui-avatars.com/api/?name=Mentor&background=4f46e5&color=fff&size=128"
                            alt="Mentor photo"
                            class="w-24 h-24 rounded-full border-4 border-slate-900 object-cover shadow-xl">
                        <div class="pb-1">
                            <h1 id="mentorName" class="text-2xl font-bold text-white leading-tight">Loading…</h1>
                            <p id="mentorTitle" class="text-indigo-400 text-sm font-medium mt-0.5"></p>
                        </div>
                    </div>

                    <!-- CTA -->
                    <div id="ctaArea" class="flex gap-3 pb-1">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Stats row -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-800/60 rounded-xl p-4 text-center">
                        <p id="statMentees" class="text-2xl font-bold text-white">—</p>
                        <p class="text-xs text-slate-400 mt-1">Mentees Helped</p>
                    </div>
                    <div class="bg-slate-800/60 rounded-xl p-4 text-center">
                        <div id="statRating" class="flex justify-center gap-0.5 mb-1">
                            <!-- Stars rendered by JS -->
                        </div>
                        <p id="statRatingNum" class="text-xs text-slate-400">—</p>
                    </div>
                    <div class="bg-slate-800/60 rounded-xl p-4 text-center">
                        <p id="statYears" class="text-2xl font-bold text-white">—</p>
                        <p class="text-xs text-slate-400 mt-1">Years Experience</p>
                    </div>
                </div>

                <!-- Bio -->
                <div class="mb-6">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">About</h2>
                    <p id="mentorBio" class="text-slate-300 leading-relaxed text-sm"></p>
                </div>

                <!-- Specialties -->
                <div class="mb-6">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Specialties</h2>
                    <div id="specialtiesList" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- Availability & Languages -->
                <div class="grid sm:grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-800/40 rounded-xl p-4">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                            <i class="fas fa-calendar-check mr-1 text-emerald-400"></i> Availability
                        </h3>
                        <div id="availabilityList" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="bg-slate-800/40 rounded-xl p-4">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                            <i class="fas fa-language mr-1 text-blue-400"></i> Languages
                        </h3>
                        <div id="languagesList" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Badges -->
                <div id="badgesSection" class="hidden mb-6">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Earned Badges</h2>
                    <div id="badgesList" class="flex flex-wrap gap-3"></div>
                </div>
            </div>
        </div>

        <!-- Mentorship History -->
        <div class="glass rounded-2xl p-6">
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-history text-indigo-400"></i>
                Mentorship History
            </h2>
            <div id="historyContent">
                <div class="text-center py-8 text-slate-500">
                    <i class="fas fa-handshake text-3xl mb-3 block opacity-30"></i>
                    <p class="text-sm">No completed mentorships yet.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- ── REQUEST MODAL ── -->
    <div id="requestModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" id="modalBackdrop"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg px-4">
            <div class="glass rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-white">Request Mentorship</h3>
                        <p id="modalSubtitle" class="text-sm text-slate-400 mt-0.5"></p>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Introduction Message <span
                                class="text-red-400">*</span></label>
                        <textarea id="introMessage" rows="4" placeholder="Hi, I'm looking for guidance on…"
                            class="w-full p-4 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Primary Goal</label>
                        <select id="primaryGoal"
                            class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="Career Advice">Career Advice</option>
                            <option value="Business Skills">Business Skills (Owner Operator)</option>
                            <option value="Technical Skills">Technical Skills</option>
                            <option value="Safety & Compliance">Safety &amp; Compliance</option>
                            <option value="Health & Wellness">Health &amp; Wellness</option>
                        </select>
                    </div>
                </div>
                <div class="p-6 bg-slate-800/50 border-t border-slate-700 flex justify-end gap-3">
                    <button onclick="closeModal()"
                        class="px-5 py-2 text-slate-300 hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
                    <button id="sendRequestBtn" class="request-btn px-6 py-2 text-white font-semibold rounded-lg">
                        Send Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── BOOTSTRAP ── -->
    <script>
        // ── State ──────────────────────────────────────────────────────────────
        let mentorProfile = null;
        let currentUser = null;
        let myMatches = { active: [], pending: [] };
        let mentorId = null; // driverId of the mentor

        // ── Velo Bridge ────────────────────────────────────────────────────────
        function sendToVelo(data) {
            window.parent.postMessage(data, '*');
        }

        window.onmessage = (event) => {
            const { action, payload } = event.data || {};
            switch (action) {
                case 'init':
                    sendToVelo({ action: 'loadMentorProfile' });
                    break;
                case 'profileLoaded':
                    currentUser = payload.currentUser;
                    mentorProfile = payload.mentor;
                    myMatches = payload.matches || { active: [], pending: [] };
                    mentorId = mentorProfile ? mentorProfile.driverId : null;
                    if (!mentorProfile) { showError(); return; }
                    renderProfile(mentorProfile, payload.history || []);
                    break;
                case 'requestSent':
                    closeModal();
                    showToast('Request sent! The mentor will be notified.', 'success');
                    sendToVelo({ action: 'loadMentorProfile' });
                    break;
                case 'error':
                    showToast(payload?.message || 'Something went wrong.', 'error');
                    break;
            }
        };

        // ── Rendering ──────────────────────────────────────────────────────────
        function renderProfile(m, history) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('profileContent').classList.remove('hidden');

            // Photo
            const photo = document.getElementById('mentorPhoto');
            if (m.photoUrl) photo.src = m.photoUrl;
            else photo.src = `https://ui-avatars.com/api/?name=${encodeURIComponent((m.firstName || 'M') + ' ' + (m.lastName || ''))}&background=4f46e5&color=fff&size=128`;

            // Name & title
            document.getElementById('mentorName').textContent = `${m.firstName || ''} ${m.lastName || ''}`.trim() || 'Mentor';
            document.getElementById('mentorTitle').textContent = `${m.yearsExperience || '?'} Years Experience · ${(m.specialties || [])[0] || 'CDL Driver'}`;

            // Stats
            document.getElementById('statMentees').textContent = m.totalMenteesHelped || 0;
            document.getElementById('statYears').textContent = m.yearsExperience || '—';
            renderStars(m.rating || 5.0, m.ratingCount || 0);

            // Bio
            document.getElementById('mentorBio').textContent = m.bio || 'Experienced driver ready to help the next generation.';

            // Specialties
            const specEl = document.getElementById('specialtiesList');
            specEl.innerHTML = (m.specialties || []).map(s =>
                `<span class="specialty-tag">${s}</span>`
            ).join('') || '<span class="text-slate-500 text-sm">Not specified</span>';

            // Availability
            const avEl = document.getElementById('availabilityList');
            avEl.innerHTML = (m.availability || []).map(a =>
                `<span class="badge-pill bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"><i class="fas fa-clock text-[10px]"></i>${a}</span>`
            ).join('') || '<span class="text-slate-500 text-sm">Flexible</span>';

            // Languages
            const langEl = document.getElementById('languagesList');
            langEl.innerHTML = (m.languages || ['English']).map(l =>
                `<span class="badge-pill bg-blue-500/10 text-blue-400 border border-blue-500/20"><i class="fas fa-globe text-[10px]"></i>${l}</span>`
            ).join('');

            // Badges
            if (m.badges && m.badges.length > 0) {
                document.getElementById('badgesSection').classList.remove('hidden');
                const BADGE_META = {
                    'mentor_bronze': { icon: 'medal', color: 'text-amber-600', label: 'Mentor Bronze' },
                    'mentor_silver': { icon: 'medal', color: 'text-slate-300', label: 'Mentor Silver' },
                    'mentor_gold': { icon: 'medal', color: 'text-yellow-400', label: 'Mentor Gold' },
                    'verified_driver': { icon: 'shield-check', color: 'text-blue-400', label: 'Verified Driver' },
                    'top_contributor': { icon: 'star', color: 'text-indigo-400', label: 'Top Contributor' }
                };
                document.getElementById('badgesList').innerHTML = m.badges.map(b => {
                    const meta = BADGE_META[b] || { icon: 'award', color: 'text-slate-400', label: b };
                    return `
            <div class="flex items-center gap-2 bg-slate-800/60 border border-slate-700 rounded-xl px-4 py-2">
              <i class="fas fa-${meta.icon} ${meta.color}"></i>
              <span class="text-sm font-medium text-slate-200">${meta.label}</span>
            </div>`;
                }).join('');
            }

            // CTA
            renderCTA(m);

            // History
            renderHistory(history, m);
        }

        function renderStars(rating, count) {
            const container = document.getElementById('statRating');
            const full = Math.round(rating);
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<i class="fas fa-star text-sm ${i <= full ? 'star-filled' : 'star-empty'}"></i>`;
            }
            container.innerHTML = html;
            document.getElementById('statRatingNum').textContent = `${Number(rating).toFixed(1)} / 5 (${count} ratings)`;
        }

        function renderCTA(m) {
            const area = document.getElementById('ctaArea');
            const userId = currentUser?.profile?.driverId || currentUser?.id;
            const isSelf = userId && userId === m.driverId;

            if (isSelf) {
                area.innerHTML = `<span class="px-4 py-2 bg-slate-700 text-slate-400 rounded-lg text-sm font-medium">Your Profile</span>`;
                return;
            }

            const isActive = myMatches.active.some(x => x.mentorId === m.driverId);
            const isPending = myMatches.pending.some(x => x.mentorId === m.driverId);
            const isFull = (m.currentMentees || 0) >= (m.maxMentees || 2);

            if (isActive) {
                area.innerHTML = `<span class="px-5 py-2 bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 rounded-lg text-sm font-semibold"><i class="fas fa-check mr-2"></i>Connected</span>`;
            } else if (isPending) {
                area.innerHTML = `<span class="px-5 py-2 bg-amber-500/20 text-amber-400 border border-amber-500/30 rounded-lg text-sm font-semibold"><i class="fas fa-clock mr-2"></i>Request Pending</span>`;
            } else if (isFull) {
                area.innerHTML = `<span class="px-5 py-2 bg-slate-700 text-slate-400 rounded-lg text-sm font-medium"><i class="fas fa-users mr-2"></i>Fully Booked</span>`;
            } else {
                area.innerHTML = `
          <button onclick="openRequestModal()"
            class="request-btn px-6 py-2 text-white font-semibold rounded-lg text-sm">
            <i class="fas fa-handshake mr-2"></i>Request Mentorship
          </button>`;
            }
        }

        function renderHistory(history, mentor) {
            const el = document.getElementById('historyContent');
            if (!history || history.length === 0) return; // keep default empty state

            const rated = history.filter(h => h.rating_of_mentor);
            const avgRating = rated.length
                ? (rated.reduce((s, h) => s + h.rating_of_mentor, 0) / rated.length).toFixed(1)
                : null;

            let html = `
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-slate-800/50 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-white">${history.length}</p>
            <p class="text-xs text-slate-400 mt-1">Completed Programs</p>
          </div>
          <div class="bg-slate-800/50 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-white">${avgRating || '—'}</p>
            <p class="text-xs text-slate-400 mt-1">Avg Rating</p>
          </div>
        </div>`;

            // Show up to 3 testimonials (feedback from mentees)
            const testimonials = history.filter(h => h.feedback_mentee).slice(0, 3);
            if (testimonials.length > 0) {
                html += `<h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Mentee Testimonials</h3>
          <div class="space-y-3">`;
                testimonials.forEach(t => {
                    const stars = '★'.repeat(Math.round(t.rating_of_mentor || 5)) + '☆'.repeat(5 - Math.round(t.rating_of_mentor || 5));
                    const date = t.completedAt ? new Date(t.completedAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : '';
                    html += `
            <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-amber-400 text-sm tracking-wider">${stars}</span>
                <span class="text-xs text-slate-500">${date}</span>
              </div>
              <p class="text-slate-300 text-sm italic">"${t.feedback_mentee}"</p>
            </div>`;
                });
                html += `</div>`;
            }

            el.innerHTML = html;
        }

        // ── Modal ──────────────────────────────────────────────────────────────
        function openRequestModal() {
            if (!mentorProfile) return;
            document.getElementById('modalSubtitle').textContent =
                `Requesting from ${mentorProfile.firstName} ${mentorProfile.lastName}`;
            document.getElementById('requestModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('requestModal').classList.add('hidden');
            document.getElementById('introMessage').value = '';
        }

        document.getElementById('modalBackdrop').addEventListener('click', closeModal);

        document.getElementById('sendRequestBtn').addEventListener('click', () => {
            const intro = document.getElementById('introMessage').value.trim();
            const goal = document.getElementById('primaryGoal').value;
            if (!intro) { showToast('Please add a short introduction.', 'error'); return; }
            if (!mentorId) return;

            sendToVelo({
                action: 'requestMentor',
                payload: { mentorId, introMessage: intro, goals: [goal] }
            });
        });

        // ── Helpers ────────────────────────────────────────────────────────────
        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        function showToast(msg, type = 'info') {
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', info: 'bg-indigo-600' };
            const toast = document.createElement('div');
            toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] px-5 py-3 rounded-xl text-white text-sm font-medium shadow-xl ${colors[type]} transition-all`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }
    </script>
</body>

</html>