<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Upload | LMDR Onboarding</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: {
                            blue: '#2563eb',
                            dark: '#0f172a',
                            yellow: '#fbbf24',
                            'yellow-hover': '#f59e0b',
                            canvas: '#f1f5f9'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            min-height: 100vh;
        }

        /* Drag and Drop Zone */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .upload-zone.dragover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.2);
        }

        /* Document Status Pills */
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-uploaded {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-verified {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* File Preview */
        .file-preview {
            position: relative;
            width: 100%;
            height: 120px;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-preview .pdf-icon {
            font-size: 48px;
            color: #ef4444;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Modal */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .doc-card {
                padding: 16px !important;
            }
        }
    </style>
</head>

<body class="bg-lmdr-canvas">
    <!-- Main Container -->
    <div class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-slate-200">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 rounded-xl bg-lmdr-blue flex items-center justify-center">
                    <i class="fas fa-folder-open text-2xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-lmdr-dark">Document Center</h1>
                    <p class="text-slate-500" id="welcomeText">Upload your documents to complete onboarding</p>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="bg-slate-50 rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold text-slate-700">Overall Progress</span>
                    <span class="text-sm font-bold text-lmdr-blue" id="progressText">0 of 0 Complete</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="mt-4 flex items-center gap-2 text-sm text-slate-500" id="recruiterContact">
                <i class="fas fa-headset"></i>
                <span>Questions? Contact your recruiter.</span>
            </div>
        </div>

        <!-- Document Checklist -->
        <div id="documentList" class="space-y-4">
            <!-- Documents will be rendered here -->
            <div class="text-center py-12 text-slate-400">
                <i class="fas fa-spinner animate-spin text-3xl mb-4"></i>
                <p>Loading documents...</p>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
            <h3 class="font-bold text-lg text-lmdr-dark mb-4">
                <i class="fas fa-question-circle text-lmdr-blue mr-2"></i>
                Need Help?
            </h3>
            <div class="grid sm:grid-cols-2 gap-4">
                <a href="#" onclick="showHelpModal('mvr')"
                    class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-car text-lmdr-blue"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-700">How to get your MVR</p>
                        <p class="text-xs text-slate-400">Motor Vehicle Record guide</p>
                    </div>
                </a>
                <a href="#" onclick="showHelpModal('psp')"
                    class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fas fa-shield-alt text-green-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-700">How to get your PSP</p>
                        <p class="text-xs text-slate-400">Pre-Employment Screening guide</p>
                    </div>
                </a>
                <a href="#" onclick="showHelpModal('medical')"
                    class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition">
                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                        <i class="fas fa-heartbeat text-red-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-700">DOT Medical Card</p>
                        <p class="text-xs text-slate-400">Requirements & locations</p>
                    </div>
                </a>
                <a href="#" onclick="showHelpModal('cdl')"
                    class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition">
                    <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                        <i class="fas fa-id-card text-amber-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-700">CDL Photo Tips</p>
                        <p class="text-xs text-slate-400">Get a clear, readable scan</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0" onclick="closeUploadModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-fade-in">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="fas fa-times text-xl"></i>
            </button>

            <h3 class="text-xl font-bold text-lmdr-dark mb-2" id="modalTitle">Upload Document</h3>
            <p class="text-slate-500 text-sm mb-6" id="modalDescription">Select or drag a file to upload.</p>

            <!-- Drop Zone -->
            <div id="dropZone" class="upload-zone mb-6" ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png"
                    onchange="handleFileSelect(event)">
                <i class="fas fa-cloud-upload-alt text-4xl text-slate-300 mb-3"></i>
                <p class="font-semibold text-slate-600">Drop your file here</p>
                <p class="text-sm text-slate-400 mt-1">or click to browse</p>
                <p class="text-xs text-slate-400 mt-3">PDF, JPG, PNG (max 10MB)</p>
            </div>

            <!-- File Preview (hidden until file selected) -->
            <div id="filePreviewContainer" class="hidden mb-6">
                <div class="file-preview mb-3" id="filePreview"></div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-slate-700 truncate max-w-xs" id="fileName"></p>
                        <p class="text-xs text-slate-400" id="fileSize"></p>
                    </div>
                    <button onclick="clearFileSelection()" class="text-red-500 hover:text-red-700 text-sm">
                        <i class="fas fa-trash-alt mr-1"></i> Remove
                    </button>
                </div>
            </div>

            <!-- Upload Progress (hidden until uploading) -->
            <div id="uploadProgress" class="hidden mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold text-slate-600">Uploading...</span>
                    <span class="text-sm text-lmdr-blue" id="uploadPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="uploadProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="closeUploadModal()"
                    class="flex-1 px-4 py-3 rounded-xl border border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition">
                    Cancel
                </button>
                <button id="uploadBtn" onclick="uploadFile()" disabled
                    class="flex-1 px-4 py-3 rounded-xl bg-lmdr-blue text-white font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i> Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0" onclick="closeHelpModal()"></div>
        <div
            class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-fade-in max-h-[80vh] overflow-y-auto">
            <button onclick="closeHelpModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div id="helpContent"></div>
        </div>
    </div>

    <script>
        // =========================================================================
        // STATE MANAGEMENT
        // =========================================================================
        const state = {
            documents: [],
            currentDocumentType: null,
            selectedFile: null,
            workflowId: null,
            uploadToken: null,
            driverName: '',
            recruiterName: '',
            recruiterEmail: '',
            carrierName: ''
        };

        // =========================================================================
        // MESSAGE REGISTRY (for debugging)
        // =========================================================================
        const MESSAGE_REGISTRY = {
            inbound: [
                'initDocumentUpload',
                'documentList',
                'uploadResult',
                'verificationUpdate'
            ],
            outbound: [
                'documentUploadReady',
                'uploadDocument',
                'requestDocumentList'
            ]
        };

        // =========================================================================
        // POSTMESSAGE HANDLERS
        // =========================================================================
        function isValidOrigin(event) {
            if (window.parent === window) {
                console.warn('[DOCS] Not running in iframe context');
                return false;
            }
            if (event.source !== window.parent) {
                return false;
            }
            return true;
        }

        function logMessageFlow(direction, type, data) {
            const icon = direction === 'in' ? 'ðŸ“¥' : 'ðŸ“¤';
            console.log(`[DOCS] ${icon} ${type}`, data || '');
        }

        function sendToWix(type, data = {}) {
            if (!MESSAGE_REGISTRY.outbound.includes(type)) {
                console.warn(`[DOCS] UNREGISTERED OUTBOUND MESSAGE: "${type}"`);
            }
            logMessageFlow('out', type, data);
            if (window.parent) {
                window.parent.postMessage({ type, data }, '*');
            }
        }

        window.addEventListener('message', function (event) {
            if (!isValidOrigin(event)) return;
            if (!event.data || typeof event.data !== 'object') return;

            const { type, data } = event.data;
            logMessageFlow('in', type, data);

            switch (type) {
                case 'initDocumentUpload':
                    handleInit(data);
                    break;
                case 'documentList':
                    handleDocumentList(data);
                    break;
                case 'uploadResult':
                    handleUploadResult(data);
                    break;
                case 'verificationUpdate':
                    handleVerificationUpdate(data);
                    break;
            }
        });

        // =========================================================================
        // HANDLERS
        // =========================================================================
        function handleInit(data) {
            state.workflowId = data.workflowId;
            state.uploadToken = data.uploadToken;
            state.driverName = data.driverName || 'Driver';
            state.recruiterName = data.recruiterName || '';
            state.recruiterEmail = data.recruiterEmail || '';
            state.carrierName = data.carrierName || '';

            document.getElementById('welcomeText').textContent =
                `Welcome, ${state.driverName}! Upload your documents for ${state.carrierName || 'your carrier'}.`;

            if (state.recruiterName && state.recruiterEmail) {
                document.getElementById('recruiterContact').innerHTML = `
                    <i class="fas fa-headset"></i>
                    <span>Questions? Contact ${state.recruiterName} at
                        <a href="mailto:${state.recruiterEmail}" class="text-lmdr-blue hover:underline">${state.recruiterEmail}</a>
                    </span>
                `;
            }

            // Request document list
            sendToWix('requestDocumentList', { workflowId: state.workflowId });
        }

        function handleDocumentList(data) {
            state.documents = data.documents || [];
            renderDocuments();
            updateProgress();
        }

        function handleUploadResult(data) {
            const { documentType, success, error, documentId } = data;

            // Hide progress
            document.getElementById('uploadProgress').classList.add('hidden');

            if (success) {
                // Update local state
                const doc = state.documents.find(d => d.documentType === documentType);
                if (doc) {
                    doc.status = 'uploaded';
                    doc.documentId = documentId;
                }
                renderDocuments();
                updateProgress();
                closeUploadModal();
                showToast('Document uploaded successfully!', 'success');
            } else {
                showToast(error || 'Upload failed. Please try again.', 'error');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function handleVerificationUpdate(data) {
            const { documentType, status, rejectionReason } = data;
            const doc = state.documents.find(d => d.documentType === documentType);
            if (doc) {
                doc.status = status;
                doc.rejectionReason = rejectionReason;
                renderDocuments();
                updateProgress();
            }
        }

        // =========================================================================
        // RENDERING
        // =========================================================================
        function renderDocuments() {
            const container = document.getElementById('documentList');

            if (state.documents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i class="fas fa-inbox text-3xl mb-4"></i>
                        <p>No documents required at this time.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.documents.map(doc => renderDocumentCard(doc)).join('');

            // GSAP Stagger Animation
            gsap.fromTo(".doc-card",
                { opacity: 0, y: 20 },
                { opacity: 1, y: 0, duration: 0.4, stagger: 0.1, ease: "power2.out" }
            );
        }

        function renderDocumentCard(doc) {
            const statusConfig = getStatusConfig(doc.status);
            const isActionable = doc.status === 'requested' || doc.status === 'rejected';

            return `
                <div class="doc-card bg-white rounded-2xl shadow-lg p-6 border border-slate-200 ${doc.status === 'rejected' ? 'border-l-4 border-l-red-500' : ''}">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex items-start gap-4 flex-1 min-w-0">
                            <div class="w-12 h-12 rounded-xl ${statusConfig.iconBg} flex items-center justify-center flex-shrink-0">
                                <i class="${statusConfig.icon} text-xl ${statusConfig.iconColor}"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <h3 class="font-bold text-lg text-lmdr-dark">${doc.displayName}</h3>
                                    ${doc.isRequired ? '<span class="text-xs text-red-500 font-medium">Required</span>' : '<span class="text-xs text-slate-400">Optional</span>'}
                                </div>
                                <p class="text-sm text-slate-500 mt-1">${doc.description || ''}</p>

                                ${doc.status === 'rejected' && doc.rejectionReason ? `
                                    <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                                        <p class="text-sm text-red-700">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>
                                            <strong>Rejected:</strong> ${doc.rejectionReason}
                                        </p>
                                    </div>
                                ` : ''}

                                ${doc.submittedDate ? `
                                    <p class="text-xs text-slate-400 mt-2">
                                        <i class="fas fa-clock mr-1"></i> Submitted ${formatDate(doc.submittedDate)}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-3">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${statusConfig.pillClass}">
                                ${statusConfig.label}
                            </span>
                            ${isActionable ? `
                                <button onclick="openUploadModal('${doc.documentType}', '${doc.displayName}', '${doc.description || ''}')"
                                    class="px-4 py-2 rounded-lg bg-lmdr-blue text-white text-sm font-semibold hover:bg-blue-700 transition">
                                    <i class="fas fa-upload mr-1"></i> ${doc.status === 'rejected' ? 'Re-upload' : 'Upload'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusConfig(status) {
            const configs = {
                requested: {
                    label: 'Pending',
                    pillClass: 'status-pending',
                    icon: 'fas fa-clock',
                    iconBg: 'bg-amber-100',
                    iconColor: 'text-amber-600'
                },
                uploaded: {
                    label: 'Uploaded',
                    pillClass: 'status-uploaded',
                    icon: 'fas fa-hourglass-half',
                    iconBg: 'bg-blue-100',
                    iconColor: 'text-lmdr-blue'
                },
                verified: {
                    label: 'Verified',
                    pillClass: 'status-verified',
                    icon: 'fas fa-check-circle',
                    iconBg: 'bg-green-100',
                    iconColor: 'text-green-600'
                },
                rejected: {
                    label: 'Rejected',
                    pillClass: 'status-rejected',
                    icon: 'fas fa-times-circle',
                    iconBg: 'bg-red-100',
                    iconColor: 'text-red-600'
                }
            };
            return configs[status] || configs.requested;
        }

        function updateProgress() {
            const required = state.documents.filter(d => d.isRequired);
            const verified = required.filter(d => d.status === 'verified');
            const percent = required.length > 0 ? Math.round((verified.length / required.length) * 100) : 0;

            document.getElementById('progressText').textContent = `${verified.length} of ${required.length} Complete`;
            gsap.to(document.getElementById('progressFill'), { width: `${percent}%`, duration: 0.5, ease: "power2.out" });
        }

        // =========================================================================
        // UPLOAD MODAL
        // =========================================================================
        function openUploadModal(documentType, displayName, description) {
            state.currentDocumentType = documentType;
            state.selectedFile = null;

            document.getElementById('modalTitle').textContent = `Upload ${displayName}`;
            document.getElementById('modalDescription').textContent = description || 'Select or drag a file to upload.';

            // Reset modal state
            document.getElementById('dropZone').classList.remove('hidden');
            document.getElementById('filePreviewContainer').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('fileInput').value = '';

            document.getElementById('uploadModal').classList.remove('hidden');
            document.getElementById('uploadModal').classList.add('flex');

            // GSAP Modal Animation
            const modalContent = document.getElementById('uploadModal').querySelector('.relative');
            gsap.fromTo(modalContent,
                { scale: 0.9, opacity: 0 },
                { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
            );
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
            state.currentDocumentType = null;
            state.selectedFile = null;
        }

        // =========================================================================
        // FILE HANDLING
        // =========================================================================
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function processFile(file) {
            // Validate file type
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showToast('Invalid file type. Please upload PDF, JPG, or PNG.', 'error');
                return;
            }

            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('File too large. Maximum size is 10MB.', 'error');
                return;
            }

            state.selectedFile = file;

            // Show file preview
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('filePreviewContainer').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);

            const previewEl = document.getElementById('filePreview');
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewEl.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                previewEl.innerHTML = `<i class="fas fa-file-pdf pdf-icon"></i>`;
            }

            document.getElementById('uploadBtn').disabled = false;
        }

        function clearFileSelection() {
            state.selectedFile = null;
            document.getElementById('dropZone').classList.remove('hidden');
            document.getElementById('filePreviewContainer').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('fileInput').value = '';
        }

        function uploadFile() {
            if (!state.selectedFile || !state.currentDocumentType) return;

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;

            // Show progress
            document.getElementById('filePreviewContainer').classList.add('hidden');
            document.getElementById('uploadProgress').classList.remove('hidden');

            // Read file as base64
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64Data = e.target.result.split(',')[1];

                sendToWix('uploadDocument', {
                    workflowId: state.workflowId,
                    documentType: state.currentDocumentType,
                    token: state.uploadToken,
                    fileName: state.selectedFile.name,
                    fileType: state.selectedFile.type,
                    fileSize: state.selectedFile.size,
                    fileData: base64Data
                });

                // Simulate progress (actual progress would come from backend)
                simulateProgress();
            };
            reader.onerror = function () {
                showToast('Error reading file. Please try again.', 'error');
                btn.disabled = false;
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('filePreviewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(state.selectedFile);
        }

        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 90) {
                    progress = 90; // Cap at 90% until complete response
                    clearInterval(interval);
                }
                document.getElementById('uploadProgressFill').style.width = `${progress}%`;
                document.getElementById('uploadPercent').textContent = `${Math.round(progress)}%`;
            }, 200);
        }

        // =========================================================================
        // HELP MODAL
        // =========================================================================
        const helpContent = {
            mvr: {
                title: 'How to Get Your MVR (Motor Vehicle Record)',
                content: `
                    <div class="space-y-4">
                        <p class="text-slate-600">Your MVR shows your driving history for the past 3-10 years, depending on your state.</p>

                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-map-marker-alt mr-2"></i>Request from Your State DMV</h4>
                            <p class="text-sm text-slate-600">Visit your state's DMV website or office. Most states allow online requests for a fee of $5-20.</p>
                        </div>

                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-clock mr-2"></i>Processing Time</h4>
                            <p class="text-sm text-slate-600">Online: Usually instant to 3 business days. In-person: Same day.</p>
                        </div>

                        <div class="mt-4 p-4 border border-slate-200 rounded-lg">
                            <h4 class="font-bold text-sm text-slate-700 mb-2">Common State Links:</h4>
                            <ul class="text-sm text-lmdr-blue space-y-1">
                                <li><i class="fas fa-external-link-alt mr-2"></i>Texas: txdps.state.tx.us</li>
                                <li><i class="fas fa-external-link-alt mr-2"></i>California: dmv.ca.gov</li>
                                <li><i class="fas fa-external-link-alt mr-2"></i>Florida: flhsmv.gov</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            psp: {
                title: 'How to Get Your PSP Report',
                content: `
                    <div class="space-y-4">
                        <p class="text-slate-600">Your PSP (Pre-Employment Screening Program) report shows your FMCSA safety record.</p>

                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-globe mr-2"></i>Official FMCSA Website</h4>
                            <p class="text-sm text-slate-600">Visit <strong>psp.fmcsa.dot.gov</strong> to request your report.</p>
                        </div>

                        <div class="bg-amber-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-dollar-sign mr-2"></i>Cost</h4>
                            <p class="text-sm text-slate-600">~$10 per report. You'll need a credit/debit card.</p>
                        </div>

                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-file-download mr-2"></i>Delivery</h4>
                            <p class="text-sm text-slate-600">Your report is available for instant download after payment.</p>
                        </div>
                    </div>
                `
            },
            medical: {
                title: 'DOT Medical Card Information',
                content: `
                    <div class="space-y-4">
                        <p class="text-slate-600">Your DOT Medical Examiner's Certificate is required to drive a CMV.</p>

                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-user-md mr-2"></i>Find a Certified Medical Examiner</h4>
                            <p class="text-sm text-slate-600">Use FMCSA's National Registry: <strong>nationalregistry.fmcsa.dot.gov</strong></p>
                        </div>

                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-calendar-check mr-2"></i>Validity</h4>
                            <p class="text-sm text-slate-600">Cards are valid for up to 2 years, depending on your health conditions.</p>
                        </div>

                        <div class="bg-amber-50 rounded-lg p-4">
                            <h4 class="font-bold text-lmdr-dark mb-2"><i class="fas fa-clipboard-list mr-2"></i>What to Bring</h4>
                            <ul class="text-sm text-slate-600 list-disc list-inside">
                                <li>Photo ID</li>
                                <li>List of current medications</li>
                                <li>Glasses/contacts if you wear them</li>
                                <li>Previous medical card (if renewing)</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            cdl: {
                title: 'CDL Photo Tips',
                content: `
                    <div class="space-y-4">
                        <p class="text-slate-600">For fast verification, upload clear photos of both sides of your CDL.</p>

                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-bold text-green-700 mb-2"><i class="fas fa-check mr-2"></i>Do This</h4>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Use good lighting</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Capture the entire card</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Keep the camera steady</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Make sure text is readable</li>
                            </ul>
                        </div>

                        <div class="bg-red-50 rounded-lg p-4">
                            <h4 class="font-bold text-red-700 mb-2"><i class="fas fa-times mr-2"></i>Don't Do This</h4>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li><i class="fas fa-times text-red-500 mr-2"></i>Blurry or dark photos</li>
                                <li><i class="fas fa-times text-red-500 mr-2"></i>Cropped edges</li>
                                <li><i class="fas fa-times text-red-500 mr-2"></i>Glare covering text</li>
                                <li><i class="fas fa-times text-red-500 mr-2"></i>Expired CDL</li>
                            </ul>
                        </div>
                    </div>
                `
            }
        };

        function showHelpModal(type) {
            const content = helpContent[type];
            if (!content) return;

            document.getElementById('helpContent').innerHTML = `
                <h3 class="text-xl font-bold text-lmdr-dark mb-4">
                    <i class="fas fa-question-circle text-lmdr-blue mr-2"></i>
                    ${content.title}
                </h3>
                ${content.content}
            `;

            document.getElementById('helpModal').classList.remove('hidden');
            document.getElementById('helpModal').classList.add('flex');

            // GSAP Modal Animation
            const modalContent = document.getElementById('helpModal').querySelector('.relative');
            gsap.fromTo(modalContent,
                { scale: 0.9, opacity: 0 },
                { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
            );
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
            document.getElementById('helpModal').classList.remove('flex');
        }

        // =========================================================================
        // UTILITIES
        // =========================================================================
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-[100] animate-fade-in ${type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                    'bg-slate-800 text-white'
                }`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        if (window.parent) {
            window.parent.postMessage({ type: 'documentUploadReady' }, '*');
            console.log('[DOCS] Ready signal sent to Wix');
        }

        // For development/testing without Wix
        if (window.parent === window) {
            console.log('[DOCS] Running in standalone mode - loading test data');
            setTimeout(() => {
                handleInit({
                    workflowId: 'test-workflow-123',
                    uploadToken: 'test-token-abc',
                    driverName: 'John Smith',
                    recruiterName: 'Sarah Johnson',
                    recruiterEmail: 'sarah@abctransport.com',
                    carrierName: 'ABC Transport'
                });
                handleDocumentList({
                    documents: [
                        { documentType: 'cdl_front', displayName: 'CDL - Front', description: 'Clear photo of the front of your CDL', isRequired: true, status: 'verified', submittedDate: '2026-01-18' },
                        { documentType: 'cdl_back', displayName: 'CDL - Back', description: 'Clear photo of the back of your CDL', isRequired: true, status: 'verified', submittedDate: '2026-01-18' },
                        { documentType: 'mvr', displayName: 'Motor Vehicle Record (MVR)', description: 'Request from your state DMV (past 3 years)', isRequired: true, status: 'requested' },
                        { documentType: 'medical_card', displayName: 'DOT Medical Card', description: 'Current, unexpired DOT medical certificate', isRequired: true, status: 'uploaded', submittedDate: '2026-01-20' },
                        { documentType: 'psp', displayName: 'PSP Report', description: 'Pre-Employment Screening Program report from FMCSA', isRequired: true, status: 'rejected', submittedDate: '2026-01-19', rejectionReason: 'Document is expired. Please upload a current PSP report.' },
                        { documentType: 'employment_history', displayName: 'Employment History', description: '10-year employment history (optional)', isRequired: false, status: 'requested' }
                    ]
                });
            }, 500);
        }
    </script>
</body>

</html>