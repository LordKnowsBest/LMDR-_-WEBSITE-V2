<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Your Perfect Carrier | LMDR</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">

  <style>
    /* =========================================
       CORE VARIABLES & RESET - LMDR BRAND
       ========================================= */
    :root {
      /* LMDR Brand Colors */
      --lmdr-dark: #0f172a;
      --lmdr-blue: #2563eb;
      --lmdr-yellow: #fbbf24;
      --lmdr-canvas: #f1f5f9;
      --lmdr-content: #ffffff;
      --lmdr-body: #475569;
      /* Functional Colors */
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;
      --color-info: #3b82f6;
      /* FMCSA Rating Colors */
      --fmcsa-satisfactory: #059669;
      --fmcsa-conditional: #d97706;
      --fmcsa-unsatisfactory: #dc2626;
      --fmcsa-not-rated: #64748b;

      /* Premium Design Tokens */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-full: 9999px;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-premium: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.3);
      --glass-blur: blur(8px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--lmdr-canvas);
      background-image:
        radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.05) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(251, 191, 36, 0.05) 0px, transparent 50%);
      color: var(--lmdr-dark);
      line-height: 1.6;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* =========================================
       FORM SECTION
       ========================================= */
    .form-section {
      background: var(--lmdr-content);
      border: 1px solid #e2e8f0;
      border-radius: var(--radius-lg);
      padding: 48px;
      box-shadow: var(--shadow-premium);
      position: relative;
      z-index: 1;
    }

    .form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 100%);
      border-radius: inherit;
      pointer-events: none;
      z-index: -1;
    }

    .form-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .form-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--lmdr-dark);
      color: var(--lmdr-yellow);
      padding: 8px 20px;
      font-weight: 800;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-radius: var(--radius-full);
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .form-title {
      font-size: 56px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-bottom: 16px;
      color: var(--lmdr-dark);
    }

    .form-subtitle {
      color: var(--lmdr-body);
      font-size: 20px;
      font-weight: 500;
      max-width: 600px;
      margin: 0 auto;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    @media (max-width: 768px) {
      body {
        padding: 24px 12px;
      }

      .form-section {
        padding: 24px 16px;
      }

      .form-title {
        font-size: 32px;
      }

      .form-subtitle {
        font-size: 16px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--lmdr-dark);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .form-label .hint {
      font-weight: 500;
      color: #94a3b8;
      font-size: 11px;
      text-transform: none;
      letter-spacing: normal;
    }

    .form-input,
    .form-select {
      background: var(--lmdr-content);
      border: 1px solid #e2e8f0;
      padding: 16px 20px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: var(--lmdr-dark);
      border-radius: var(--radius-md);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--lmdr-blue);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), var(--shadow-md);
      transform: translateY(-1px);
    }

    .radio-group {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    @media (max-width: 640px) {
      .radio-group {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 400px) {
      .radio-group {
        grid-template-columns: 1fr;
      }

      .radio-option label {
        min-height: 80px;
      }
    }

    @media (max-width: 640px) {
      .radio-group {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .radio-option input {
      display: none;
    }

    .radio-option label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      /* Enforces vertical centering */
      text-align: center;
      /* Enforces text centering */
      min-height: 100px;
      width: 100%;
      /* Ensures full width of grid cell */
      padding: 10px;
      /* Adds padding for safety */
      background: var(--lmdr-content);
      border: 1px solid #e2e8f0;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 700;
      font-size: 14px;
      box-shadow: var(--shadow-sm);
    }

    .radio-option label i {
      font-size: 24px;
      margin-bottom: 12px;
      color: #94a3b8;
      transition: transform 0.3s ease;
    }

    .radio-option label:hover {
      border-color: var(--lmdr-blue);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .radio-option label:hover i {
      transform: scale(1.1);
      color: var(--lmdr-blue);
    }

    .radio-option input:checked+label {
      background: var(--lmdr-yellow);
      border-color: var(--lmdr-dark);
      box-shadow: var(--shadow-premium);
      transform: translateY(-4px) scale(1.02);
    }

    .radio-option input:checked+label i {
      color: var(--lmdr-dark);
    }

    .submit-btn {
      grid-column: 1 / -1;
      background: var(--lmdr-dark);
      color: var(--lmdr-content);
      border: none;
      padding: 24px 32px;
      font-size: 18px;
      font-family: 'Inter', sans-serif;
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
    }

    .submit-btn:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-premium);
      background: #1e293b;
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    /* =========================================
       LOADING SECTION
       ========================================= */
    .loading-section {
      display: none;
      text-align: center;
      padding: 80px 20px;
    }

    .loading-section.active {
      display: block;
    }

    .loading-spinner {
      width: 64px;
      height: 64px;
      border: 4px solid #e2e8f0;
      border-top-color: var(--lmdr-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 32px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-title {
      font-size: 28px;
      font-weight: 900;
      margin-bottom: 8px;
    }

    .loading-steps {
      list-style: none;
      max-width: 320px;
      margin: 32px auto 0;
      text-align: left;
      background: var(--lmdr-content);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .loading-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      color: #94a3b8;
      font-weight: 600;
      font-size: 14px;
    }

    .loading-step.active {
      color: var(--lmdr-blue);
    }

    .loading-step.complete {
      color: var(--color-success);
    }

    /* =========================================
       RESULTS SECTION
       ========================================= */
    .results-section {
      display: none;
      margin-top: 0;
    }

    .results-section.active {
      display: block;
    }

    .results-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding: 32px;
      background: var(--lmdr-content);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      flex-wrap: wrap;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .results-header {
        flex-direction: column;
        text-align: center;
        padding: 24px 16px;
      }

      .results-header-left {
        justify-content: center;
      }

      .results-header-right {
        width: 100%;
        justify-content: center;
      }
    }

    .results-title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 8px;
      color: var(--lmdr-dark);
      letter-spacing: -0.01em;
    }

    .results-meta {
      color: var(--lmdr-body);
      font-size: 16px;
      font-weight: 500;
      opacity: 0.8;
    }

    .reset-btn {
      background: var(--lmdr-content);
      border: 2px solid #e2e8f0;
      padding: 10px 20px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reset-btn:hover {
      border-color: var(--lmdr-dark);
      background: #f8fafc;
    }

    /* =========================================
       UPSELL BANNER
       ========================================= */
    /* =========================================
       PREMIUM TIER BADGES & BANNERS
       ========================================= */
    .premium-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #0f172a;
      padding: 8px 16px;
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .free-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #e2e8f0;
      color: #475569;
      padding: 8px 16px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: 8px;
    }

    .premium-success-banner {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      border-radius: 16px;
      padding: 20px 28px;
      margin-bottom: 24px;
      color: white;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 8px 30px rgba(5, 150, 105, 0.3);
    }

    .premium-success-banner i {
      font-size: 24px;
    }

    .premium-success-text {
      flex: 1;
    }

    .premium-success-text strong {
      display: block;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .premium-success-text span {
      font-size: 14px;
      opacity: 0.9;
    }

    /* =========================================
       UPSELL BANNER - ENHANCED
       ========================================= */
    .upsell-banner {
      background: linear-gradient(135deg, var(--lmdr-blue) 0%, #1e40af 100%);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      box-shadow: 0 8px 30px rgba(37, 99, 235, 0.3);
      flex-wrap: wrap;
    }

    @media (max-width: 600px) {
      .upsell-banner {
        padding: 20px;
        flex-direction: column;
        align-items: flex-start;
      }

      .upsell-actions {
        width: 100%;
      }

      .upsell-btn {
        width: 100%;
        justify-content: center;
      }
    }

    .upsell-content {
      flex: 1;
      min-width: 250px;
    }

    .upsell-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .upsell-text {
      font-size: 14px;
      opacity: 0.9;
    }

    .upsell-stats {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }

    .upsell-stat {
      text-align: center;
    }

    .upsell-stat-value {
      font-size: 28px;
      font-weight: 900;
      color: #fbbf24;
    }

    .upsell-stat-label {
      font-size: 11px;
      opacity: 0.8;
      text-transform: uppercase;
    }

    .upsell-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .upsell-btn {
      background: var(--lmdr-yellow);
      color: var(--lmdr-dark);
      border: none;
      padding: 14px 28px;
      font-weight: 800;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 8px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upsell-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .upsell-btn.secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .upsell-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: white;
    }

    .results-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .results-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .results-grid {
        grid-template-columns: 1fr;
      }
    }

    .matches-list {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    /* =========================================
       MATCH CARD - FMCSA-FIRST DESIGN
       ========================================= */
    .match-card {
      background: var(--lmdr-content);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .match-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
    }

    /* Entry Animation */
    @keyframes cardEntry {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .match-card {
      animation: cardEntry 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      opacity: 0;
    }

    .match-card:nth-child(1) {
      animation-delay: 0.05s;
    }

    .match-card:nth-child(2) {
      animation-delay: 0.1s;
    }

    .match-card:nth-child(3) {
      animation-delay: 0.15s;
    }

    .match-card:nth-child(4) {
      animation-delay: 0.2s;
    }

    .match-card:nth-child(5) {
      animation-delay: 0.25s;
    }

    .match-card:nth-child(6) {
      animation-delay: 0.3s;
    }

    .match-card:nth-child(7) {
      animation-delay: 0.35s;
    }

    .match-card:nth-child(8) {
      animation-delay: 0.4s;
    }

    .match-card:nth-child(n+9) {
      animation-delay: 0.45s;
    }

    /* Card Header with Match Score */
    .match-card-header {
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px solid #f1f5f9;
      position: relative;
    }

    .match-rank {
      position: absolute;
      top: -1px;
      left: -1px;
      width: 48px;
      height: 48px;
      background: var(--lmdr-dark);
      color: var(--lmdr-yellow);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 900;
      border-radius: 20px 0 16px 0;
    }

    .match-info {
      padding-left: 56px;
      flex: 1;
    }

    .match-name {
      font-size: 22px;
      font-weight: 900;
      text-transform: uppercase;
      line-height: 1.2;
      margin-bottom: 6px;
      color: var(--lmdr-dark);
    }

    .match-location {
      font-weight: 600;
      color: var(--lmdr-body);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .match-dot-number {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
      margin-top: 4px;
    }

    .match-score-block {
      text-align: center;
    }

    .match-score-value {
      font-size: 36px;
      font-weight: 900;
      color: var(--color-success);
      line-height: 1;
    }

    .match-score-label {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--lmdr-body);
      margin-top: 4px;
    }

    /* =========================================
       FMCSA SAFETY SECTION - FEDERAL TRUST ANCHOR
       ========================================= */
    .fmcsa-section {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border-left: 4px solid var(--fmcsa-satisfactory);
      padding: 20px 24px;
    }

    .fmcsa-section.conditional {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border-left-color: var(--fmcsa-conditional);
    }

    .fmcsa-section.unsatisfactory {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-left-color: var(--fmcsa-unsatisfactory);
    }

    .fmcsa-section.not-rated {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-left-color: var(--fmcsa-not-rated);
    }

    .fmcsa-section.unknown {
      background: #f8fafc;
      border-left-color: #94a3b8;
    }

    .fmcsa-section.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 100%);
      border-left-color: #f97316;
    }

    .fmcsa-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .fmcsa-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 800;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .fmcsa-badge.satisfactory {
      background: var(--fmcsa-satisfactory);
      color: white;
    }

    .fmcsa-badge.conditional {
      background: var(--fmcsa-conditional);
      color: white;
    }

    .fmcsa-badge.unsatisfactory {
      background: var(--fmcsa-unsatisfactory);
      color: white;
    }

    .fmcsa-badge.not-rated {
      background: var(--fmcsa-not-rated);
      color: white;
    }

    .fmcsa-badge.unknown {
      background: #64748b;
      color: white;
    }

    .fmcsa-auth-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
    }

    .fmcsa-auth-status.authorized {
      background: #dcfce7;
      color: #166534;
    }

    .fmcsa-auth-status.not-authorized {
      background: #fee2e2;
      color: #991b1b;
    }

    .fmcsa-source {
      font-size: 11px;
      color: #64748b;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .fmcsa-source a {
      color: var(--lmdr-blue);
      text-decoration: none;
    }

    .fmcsa-source a:hover {
      text-decoration: underline;
    }

    .fmcsa-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    @media (max-width: 600px) {
      .fmcsa-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .fmcsa-stat {
      background: white;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .fmcsa-stat-value {
      font-size: 20px;
      font-weight: 900;
      color: var(--lmdr-dark);
      line-height: 1;
    }

    .fmcsa-stat-value.good {
      color: var(--color-success);
    }

    .fmcsa-stat-value.warning {
      color: var(--color-warning);
    }

    .fmcsa-stat-value.danger {
      color: var(--color-danger);
    }

    .fmcsa-stat-value.neutral {
      color: var(--lmdr-body);
    }

    .fmcsa-stat-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-top: 4px;
    }

    .fmcsa-stat-compare {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 2px;
    }

    .fmcsa-stat-compare.better {
      color: var(--color-success);
    }

    .fmcsa-stat-compare.worse {
      color: var(--color-danger);
    }

    /* BASIC Alerts Section */
    .basic-alerts {
      margin-top: 16px;
      padding: 14px 16px;
      background: #fef2f2;
      border: 2px solid var(--color-danger);
      border-radius: 10px;
    }

    .basic-alerts-title {
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--color-danger);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .basic-alert-item {
      font-size: 13px;
      font-weight: 600;
      color: #7f1d1d;
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* =========================================
       CARRIER METRICS (Database Data)
       ========================================= */
    .carrier-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      border-bottom: 1px solid #f1f5f9;
    }

    @media (max-width: 600px) {
      .carrier-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .carrier-metric {
      text-align: center;
      padding: 16px;
      border-right: 1px solid #f1f5f9;
    }

    .carrier-metric:last-child {
      border-right: none;
    }

    .carrier-metric-value {
      font-size: 18px;
      font-weight: 900;
      color: var(--lmdr-dark);
    }

    .carrier-metric-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
      margin-top: 2px;
    }

    /* Tags Row */
    .match-tags {
      padding: 14px 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #f1f5f9;
    }

    .match-tag {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .match-tag.operation {
      background: #dbeafe;
      color: #1e40af;
    }

    .match-tag.fleet {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .match-tag.cached {
      background: #fef3c7;
      color: #92400e;
    }

    .match-tag.client {
      background: var(--lmdr-yellow);
      color: var(--lmdr-dark);
    }

    .match-tag.inferred {
      background: #e0e7ff;
      color: #4338ca;
    }

    /* =========================================
       AI INTEL SECTION - ENHANCED STATES
       ========================================= */
    .ai-intel-section {
      padding: 24px;
      background: #fafbfc;
    }

    /* Loading State */
    .ai-intel-loading {
      padding: 32px;
      text-align: center;
      border: 2px dashed #e2e8f0;
      border-radius: 12px;
      background: white;
    }

    .ai-intel-loading i {
      font-size: 28px;
      margin-bottom: 12px;
      color: var(--lmdr-blue);
    }

    .ai-intel-loading-text {
      font-weight: 800;
      text-transform: uppercase;
      margin-top: 8px;
      font-size: 14px;
    }

    .ai-intel-loading-sub {
      font-size: 13px;
      color: #64748b;
      margin-top: 8px;
    }

    .ai-intel-loading-progress {
      margin-top: 16px;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }

    .ai-intel-loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--lmdr-blue), var(--lmdr-yellow));
      animation: loading-progress 2s ease-in-out infinite;
      width: 30%;
    }

    @keyframes loading-progress {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(400%);
      }
    }

    /* Success State */
    .ai-intel-content {
      background: white;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }

    .ai-intel-header {
      background: var(--lmdr-dark);
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .ai-intel-title {
      font-weight: 800;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .confidence-pill {
      font-size: 10px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 4px;
    }

    .confidence-pill.high {
      background: #bbf7d0;
      color: #166534;
    }

    .confidence-pill.medium {
      background: #fef08a;
      color: #854d0e;
    }

    .confidence-pill.low {
      background: #fed7aa;
      color: #9a3412;
    }

    .confidence-pill.none {
      background: #e2e8f0;
      color: #64748b;
    }

    .ai-intel-body {
      padding: 20px;
    }

    /* Pay Highlight */
    .pay-highlight-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
      border: 2px solid var(--lmdr-yellow);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pay-highlight-icon {
      width: 48px;
      height: 48px;
      background: var(--lmdr-yellow);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .pay-highlight-value {
      font-size: 24px;
      font-weight: 900;
      color: var(--lmdr-dark);
    }

    .pay-highlight-bonus {
      font-size: 13px;
      color: #92400e;
      font-weight: 600;
      margin-top: 2px;
    }

    .ai-intel-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      margin-bottom: 16px;
    }

    @media (max-width: 500px) {
      .ai-intel-grid {
        grid-template-columns: 1fr;
      }
    }

    .ai-intel-item {
      font-size: 13px;
      line-height: 1.4;
    }

    .ai-intel-item strong {
      display: block;
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 2px;
    }

    .ai-intel-item .inferred-tag {
      font-size: 9px;
      background: #e0e7ff;
      color: #4338ca;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 6px;
      font-weight: 700;
    }

    .ai-summary {
      border-top: 1px solid #e2e8f0;
      padding-top: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--lmdr-body);
    }

    /* Sentiment Pills */
    .sentiment-row {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .sentiment-title {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sentiment-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .sentiment-pill {
      font-size: 11px;
      font-weight: 700;
      padding: 5px 10px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sentiment-pill.pro {
      background: #dcfce7;
      color: #166534;
    }

    .sentiment-pill.con {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Sources Container */
    .ai-sources-container {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed #e2e8f0;
    }

    .ai-sources-label {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-sources-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .source-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #475569;
      text-decoration: none;
      transition: all 0.2s ease;
      max-width: 100%;
    }

    .source-badge:hover {
      background: white;
      border-color: var(--lmdr-blue);
      color: var(--lmdr-blue);
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .source-badge i {
      font-size: 10px;
      opacity: 0.7;
    }

    .source-text-only {
      font-size: 11px;
      color: #64748b;
      background: #f8fafc;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    /* =========================================
       PARTIAL SUCCESS STATE - NEW
       ========================================= */
    .ai-intel-partial {
      background: white;
      border-radius: 14px;
      border: 2px solid #fbbf24;
      overflow: hidden;
    }

    .ai-intel-partial .ai-intel-header {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: var(--lmdr-dark);
    }

    .ai-intel-partial-notice {
      background: #fffbeb;
      border-bottom: 1px solid #fef3c7;
      padding: 12px 20px;
      font-size: 13px;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* =========================================
       ERROR STATE - IMPROVED
       ========================================= */
    .ai-intel-error {
      background: white;
      border-radius: 14px;
      border: 2px solid #f97316;
      overflow: hidden;
    }

    .ai-intel-error .ai-intel-header {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
    }

    .ai-intel-error-body {
      padding: 20px;
    }

    .ai-intel-error-message {
      background: #fff7ed;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .ai-intel-error-title {
      font-weight: 800;
      font-size: 14px;
      color: #9a3412;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-intel-error-text {
      font-size: 13px;
      color: #c2410c;
      line-height: 1.5;
    }

    .ai-intel-error-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .ai-intel-error-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 2px solid;
    }

    .ai-intel-error-btn.primary {
      background: var(--lmdr-dark);
      border-color: var(--lmdr-dark);
      color: white;
    }

    .ai-intel-error-btn.primary:hover {
      background: #1e293b;
    }

    .ai-intel-error-btn.secondary {
      background: white;
      border-color: #e2e8f0;
      color: var(--lmdr-dark);
    }

    .ai-intel-error-btn.secondary:hover {
      border-color: var(--lmdr-dark);
    }

    /* Fallback Info Card */
    .fallback-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
    }

    .fallback-info-title {
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .fallback-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width: 500px) {
      .fallback-info-grid {
        grid-template-columns: 1fr;
      }
    }

    .fallback-info-item {
      font-size: 13px;
    }

    .fallback-info-item strong {
      display: block;
      font-size: 10px;
      color: #94a3b8;
      margin-bottom: 2px;
    }

    /* =========================================
       ACTIONS ROW
       ========================================= */
    .match-actions {
      padding: 20px 24px;
      display: flex;
      gap: 12px;
      background: white;
      flex-wrap: wrap;
    }

    .match-btn {
      flex: 1;
      min-width: 140px;
      padding: 14px 20px;
      border-radius: 10px;
      font-weight: 800;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: 2px solid transparent;
    }

    .match-btn.primary {
      background: var(--lmdr-yellow);
      color: var(--lmdr-dark);
      border-color: var(--lmdr-dark);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .match-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    .match-btn.primary:disabled {
      background: #10b981;
      border-color: #10b981;
      color: white;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .match-btn.secondary {
      background: white;
      color: var(--lmdr-dark);
      border-color: #e2e8f0;
    }

    .match-btn.secondary:hover {
      border-color: var(--lmdr-dark);
      background: #f8fafc;
    }

    /* =========================================
       COMING SOON SIDEBAR WIDGET - Light & Colorful
       ========================================= */
    .coming-soon-sidebar {
      background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 50%, #e0f2fe 100%);
      border-radius: 16px;
      padding: 16px;
      position: sticky;
      top: 20px;
      overflow: hidden;
      border: 1px solid #bae6fd;
      box-shadow: 0 4px 20px rgba(6, 182, 212, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .coming-soon-sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(6, 182, 212, 0.1) 0%, transparent 70%);
      pointer-events: none;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #bae6fd;
      position: relative;
      flex-shrink: 0;
    }

    .sidebar-header-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    .sidebar-header h3 {
      font-size: 14px;
      font-weight: 800;
      background: linear-gradient(135deg, #0891b2, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin: 0;
    }

    .sidebar-features-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow-y: auto;
      flex: 1;
      padding-right: 4px;
    }

    /* Custom scrollbar for sidebar */
    .sidebar-features-list::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-features-list::-webkit-scrollbar-track {
      background: #e0f2fe;
      border-radius: 2px;
    }

    .sidebar-features-list::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #06b6d4, #3b82f6);
      border-radius: 2px;
    }

    /* Category Headers */
    .sidebar-category {
      margin-bottom: 4px;
    }

    .sidebar-category:not(:first-child) {
      margin-top: 8px;
    }

    .sidebar-category-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .sidebar-category-header:hover {
      transform: translateX(2px);
    }

    .sidebar-category-header.utility {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.12) 0%, rgba(6, 182, 212, 0.06) 100%);
      border-left: 3px solid #06b6d4;
    }

    .sidebar-category-header.road {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(59, 130, 246, 0.06) 100%);
      border-left: 3px solid #3b82f6;
    }

    .sidebar-category-header.compliance {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(99, 102, 241, 0.06) 100%);
      border-left: 3px solid #6366f1;
    }

    .sidebar-category-header.financial {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(139, 92, 246, 0.06) 100%);
      border-left: 3px solid #8b5cf6;
    }

    .sidebar-category-header.community {
      background: linear-gradient(135deg, rgba(8, 145, 178, 0.12) 0%, rgba(8, 145, 178, 0.06) 100%);
      border-left: 3px solid #0891b2;
    }

    .sidebar-category-icon {
      font-size: 12px;
    }

    .sidebar-category-header.utility .sidebar-category-icon { color: #06b6d4; }
    .sidebar-category-header.road .sidebar-category-icon { color: #3b82f6; }
    .sidebar-category-header.compliance .sidebar-category-icon { color: #6366f1; }
    .sidebar-category-header.financial .sidebar-category-icon { color: #8b5cf6; }
    .sidebar-category-header.community .sidebar-category-icon { color: #0891b2; }

    .sidebar-category-title {
      font-size: 11px;
      font-weight: 700;
      color: #0f172a;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      flex: 1;
    }

    .sidebar-category-toggle {
      font-size: 10px;
      color: #64748b;
      transition: transform 0.2s ease;
    }

    .sidebar-category.collapsed .sidebar-category-toggle {
      transform: rotate(-90deg);
    }

    .sidebar-category-items {
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding-left: 12px;
      margin-top: 6px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      max-height: 500px;
      opacity: 1;
    }

    .sidebar-category.collapsed .sidebar-category-items {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
    }

    .sidebar-feature-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(203, 213, 225, 0.5);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .sidebar-feature-item:hover {
      background: #ffffff;
      border-color: #bae6fd;
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.1);
    }

    .sidebar-feature-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: white;
      flex-shrink: 0;
    }

    /* Feature icon colors - LMDR brand colors only (no green/yellow) */
    .sidebar-feature-icon.cyan { background: linear-gradient(135deg, #06b6d4, #22d3ee); }
    .sidebar-feature-icon.blue { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
    .sidebar-feature-icon.indigo { background: linear-gradient(135deg, #6366f1, #818cf8); }
    .sidebar-feature-icon.purple { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
    .sidebar-feature-icon.teal { background: linear-gradient(135deg, #0891b2, #06b6d4); }

    .sidebar-feature-content {
      flex: 1;
      min-width: 0;
    }

    .sidebar-feature-name {
      font-size: 11px;
      font-weight: 600;
      color: #1e293b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-coming-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
      border: 1px solid #bae6fd;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 8px;
      font-weight: 700;
      color: #0891b2;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      flex-shrink: 0;
    }

    .sidebar-coming-badge i {
      font-size: 7px;
      animation: sparkle 2s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.15); }
    }

    /* Responsive - hide sidebar on mobile */
    @media (max-width: 1024px) {
      .coming-soon-sidebar {
        display: none;
      }
    }

    .no-results {
      background: white;
      border-radius: 20px;
      padding: 60px 40px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
    }

    .no-results i {
      font-size: 48px;
      color: #cbd5e1;
      margin-bottom: 20px;
    }

    .no-results h3 {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 12px;
    }

    .no-results p {
      color: var(--lmdr-body);
    }

    /* Applied Status Styles */
    .match-tag.applied {
      background: var(--color-success);
      color: white;
      font-weight: 700;
    }

    .match-btn.applied-btn {
      background: #e2e8f0;
      color: var(--color-success);
      cursor: default;
      font-weight: 700;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .modal-container {
      background: white;
      border-radius: 20px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      animation: modalSlideIn 0.3s ease-out;
    }

    @media (max-width: 600px) {
      .modal-container {
        border-radius: 12px;
      }
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .modal-success-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 28px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 800;
      margin: 0 0 8px 0;
    }

    .modal-subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }

    .modal-subtitle span {
      font-weight: 700;
    }

    .modal-body {
      padding: 25px 30px;
      overflow-y: auto;
      flex: 1;
    }

    @media (max-width: 600px) {
      .modal-body {
        padding: 20px;
      }
    }

    .modal-carrier-info {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .modal-info-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
      color: var(--lmdr-dark);
    }

    .modal-info-row:not(:last-child) {
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-info-row i {
      width: 20px;
      color: var(--lmdr-blue);
    }

    .modal-info-row a {
      color: var(--lmdr-blue);
      text-decoration: none;
      font-weight: 600;
    }

    .modal-info-row a:hover {
      text-decoration: underline;
    }

    .modal-next-steps {
      background: #eff6ff;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid var(--lmdr-blue);
    }

    .modal-next-steps h4 {
      font-size: 14px;
      font-weight: 700;
      color: var(--lmdr-dark);
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-next-steps ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .modal-next-steps li {
      font-size: 13px;
      color: #475569;
      padding: 6px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-next-steps li i {
      color: var(--color-success);
      font-size: 12px;
    }

    .modal-actions {
      padding: 0 30px 25px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-btn {
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
    }

    .modal-btn.primary {
      background: var(--lmdr-blue);
      color: white;
    }

    .modal-btn.primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .modal-btn.secondary {
      background: #f1f5f9;
      color: var(--lmdr-dark);
    }

    .modal-btn.secondary:hover {
      background: #e2e8f0;
    }

    .modal-btn.tertiary {
      background: transparent;
      color: #64748b;
    }

    .modal-btn.tertiary:hover {
      color: var(--lmdr-dark);
      background: #f8fafc;
    }

    /* Application Form Modal */
    .modal-container.application-form {
      max-width: 520px;
    }

    .modal-header.apply-header {
      background: linear-gradient(135deg, var(--lmdr-blue) 0%, #1d4ed8 100%);
    }

    .modal-form {
      padding: 25px 30px;
      overflow-y: auto;
      flex: 1;
    }

    @media (max-width: 600px) {
      .modal-form {
        padding: 20px;
      }
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: var(--lmdr-dark);
      margin-bottom: 6px;
    }

    .form-group label .required {
      color: #ef4444;
      margin-left: 2px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--lmdr-blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group input.error,
    .form-group select.error {
      border-color: #ef4444;
    }

    .form-group .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    .form-group .error-message.show {
      display: block;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
        gap: 0;
      }

      .form-row .form-group:not(:last-child) {
        margin-bottom: 18px;
      }
    }

    .form-row .form-group {
      margin-bottom: 0;
    }

    .contact-preference {
      display: flex;
      gap: 15px;
      margin-top: 6px;
    }

    .contact-preference label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      cursor: pointer;
    }

    .contact-preference input[type="radio"] {
      width: auto;
      margin: 0;
    }

    /* Chip-style inputs for radio and checkbox groups */
    .radio-group, .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .radio-chip, .checkbox-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .radio-chip:hover, .checkbox-chip:hover {
      border-color: var(--lmdr-blue);
      background: #f1f5f9;
    }

    .radio-chip input, .checkbox-chip input {
      width: auto;
      margin: 0;
      accent-color: var(--lmdr-blue);
    }

    .radio-chip:has(input:checked), .checkbox-chip:has(input:checked) {
      background: #2563eb15;
      border-color: var(--lmdr-blue);
      color: var(--lmdr-blue);
    }

    .cdl-class-group .radio-chip {
      min-width: 90px;
      justify-content: center;
    }

    .endorsements-group, .equipment-group, .routes-group {
      max-width: 100%;
    }

    .form-group .hint {
      font-weight: 400;
      color: #94a3b8;
      font-size: 12px;
    }

    /* Employer Section Styling */
    .employer-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 18px;
    }

    .employer-section .form-row {
      margin-bottom: 0;
    }

    .employer-section .form-group {
      margin-bottom: 0;
    }

    /* Number Input Styling */
    .form-group input[type="number"] {
      -moz-appearance: textfield;
    }

    .form-group input[type="number"]::-webkit-outer-spin-button,
    .form-group input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .form-carrier-badge {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-carrier-badge i {
      color: var(--lmdr-blue);
      font-size: 18px;
    }

    .form-carrier-badge .carrier-info {
      flex: 1;
    }

    .form-carrier-badge .carrier-name {
      font-weight: 700;
      color: var(--lmdr-dark);
      font-size: 14px;
    }

    .form-carrier-badge .carrier-dot {
      font-size: 12px;
      color: #64748b;
    }

    .form-actions {
      padding: 0 30px 25px;
      display: flex;
      gap: 10px;
    }

    .form-actions .modal-btn {
      flex: 1;
    }

    .form-loading {
      display: none;
      text-align: center;
      padding: 40px 30px;
    }

    .form-loading.show {
      display: block;
    }

    .form-loading i {
      font-size: 32px;
      color: var(--lmdr-blue);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .form-loading p {
      margin-top: 12px;
      color: #64748b;
      font-size: 14px;
    }

    .form-success {
      display: none;
      text-align: center;
      padding: 30px;
    }

    .form-success.show {
      display: block;
    }

    .form-success i {
      font-size: 48px;
      color: var(--color-success);
      margin-bottom: 15px;
    }

    .form-success h3 {
      font-size: 20px;
      font-weight: 800;
      color: var(--lmdr-dark);
      margin: 0 0 8px 0;
    }

    .form-success p {
      color: #64748b;
      font-size: 14px;
      margin: 0;
    }

    /* File Upload Styles */
    .file-upload-section {
      margin-bottom: 20px;
    }

    .file-upload-section h4 {
      font-size: 14px;
      font-weight: 700;
      color: var(--lmdr-dark);
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-upload-section h4 i {
      color: var(--lmdr-blue);
    }

    .file-upload-section h4 .required {
      color: #ef4444;
      font-size: 12px;
    }

    .file-upload-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .file-upload-grid {
        grid-template-columns: 1fr;
      }
    }

    .file-upload-box {
      border: 2px dashed #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #f8fafc;
      position: relative;
    }

    .file-upload-box:hover {
      border-color: var(--lmdr-blue);
      background: #eff6ff;
    }

    .file-upload-box.has-file {
      border-color: var(--color-success);
      background: #f0fdf4;
    }

    .file-upload-box.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .file-upload-box.ocr-processing {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      animation: ocr-pulse 1.5s ease-in-out infinite;
    }

    .file-upload-box.ocr-processing .upload-icon {
      color: #3b82f6;
    }

    .file-upload-box.ocr-success {
      border-color: var(--color-success);
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    @keyframes ocr-pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }

      50% {
        box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
      }
    }

    /* Auto-filled field highlight */
    .form-group input.auto-filled,
    .form-group select.auto-filled {
      border-color: var(--color-success) !important;
      background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%) !important;
    }

    .file-upload-box input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-upload-box .upload-icon {
      font-size: 24px;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    .file-upload-box.has-file .upload-icon {
      color: var(--color-success);
    }

    .file-upload-box .upload-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--lmdr-dark);
      display: block;
      margin-bottom: 4px;
    }

    .file-upload-box .upload-hint {
      font-size: 11px;
      color: #94a3b8;
    }

    .file-upload-box .file-name {
      font-size: 12px;
      color: var(--color-success);
      font-weight: 600;
      margin-top: 6px;
      word-break: break-all;
    }

    .file-upload-box .remove-file {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .file-upload-box.has-file .remove-file {
      display: flex;
    }

    .upload-requirements {
      background: #fffbeb;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 12px;
      font-size: 12px;
      color: #92400e;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .upload-requirements i {
      color: #f59e0b;
      margin-top: 2px;
    }

    /* =========================================
       ADVANCED MATCHING UI
       ========================================= */
    .advanced-priorities {
      margin-top: 32px;
      padding: 32px;
      background: white;
      border-radius: var(--radius-lg);
      border: 1px solid #e2e8f0;
      box-shadow: var(--shadow-lg);
      display: none;
    }

    .priorities-header {
      margin-bottom: 24px;
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 16px;
    }

    .priorities-title {
      font-size: 16px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--lmdr-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .priorities-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    @media (max-width: 640px) {
      .priorities-grid {
        grid-template-columns: 1fr;
      }
    }

    .priority-item {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .priority-item:hover {
      background: white;
      border-color: var(--lmdr-blue);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .priority-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 800;
      color: var(--lmdr-dark);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .weight-value-badge {
      padding: 4px 8px;
      background: var(--lmdr-dark);
      color: white;
      border-radius: 6px;
      font-size: 10px;
    }

    .priority-item input[type="range"] {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      margin: 10px 0;
    }

    .priority-item input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: var(--lmdr-blue);
      border-radius: 50%;
      cursor: pointer;
      border: 4px solid white;
      box-shadow: var(--shadow-md);
    }

    .priority-item input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: var(--shadow-lg);
    }


    .highlight-pulse {
      animation: fieldPulse 2s cubic-bezier(0.4, 0, 0.2, 1);
      border-color: var(--lmdr-blue) !important;
      z-index: 10;
    }

    @keyframes fieldPulse {
      0% {
        box-shadow: 0 0 0 0px rgba(37, 99, 235, 0);
      }

      30% {
        box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.2);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.2);
      }

      100% {
        box-shadow: 0 0 0 0px rgba(37, 99, 235, 0);
      }
    }

    .match-card {
      background: var(--lmdr-content);
      border: 1px solid #e2e8f0;
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-bottom: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .match-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-premium);
      border-color: var(--lmdr-blue);
    }

    .match-card-header {
      padding: 24px;
      display: flex;
      align-items: flex-start;
      gap: 20px;
      background: linear-gradient(to bottom, #f8fafc, white);
      border-bottom: 1px solid #f1f5f9;
    }

    .match-rank {
      width: 48px;
      height: 48px;
      background: var(--lmdr-dark);
      color: var(--lmdr-yellow);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 900;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    .match-info {
      flex: 1;
    }

    .match-name {
      font-size: 24px;
      font-weight: 900;
      color: var(--lmdr-dark);
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }

    .match-location {
      font-size: 14px;
      color: var(--lmdr-body);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .match-score-block {
      text-align: right;
    }

    .match-score-value {
      font-size: 32px;
      font-weight: 900;
      color: var(--lmdr-blue);
      line-height: 1;
      margin-bottom: 4px;
    }

    @media (max-width: 600px) {
      .match-card-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 24px 20px;
        gap: 16px;
      }

      .match-rank {
        margin-bottom: 4px;
      }

      .match-info {
        width: 100%;
        padding-left: 0;
      }

      .match-score-block {
        text-align: center;
        margin-top: 8px;
        width: 100%;
        padding: 12px;
        background: #f1f5f9;
        border-radius: 12px;
      }

      .match-name {
        font-size: 22px;
        margin-bottom: 8px;
      }

      .match-score-value {
        font-size: 32px;
      }

      .carrier-metrics {
        grid-template-columns: repeat(2, 1fr);
        padding: 16px;
        gap: 12px;
      }

      .match-actions {
        padding: 20px;
        gap: 12px;
      }

      .interested-btn,
      .analysis-btn,
      .match-btn.secondary {
        width: 100%;
        flex: none;
      }
    }

    .match-score-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #94a3b8;
    }

    /* Carrier Metrics */
    .carrier-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      padding: 24px;
      gap: 16px;
      background: #f8fafc;
    }

    .carrier-metric {
      text-align: center;
      padding: 16px;
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      box-shadow: var(--shadow-sm);
    }

    .carrier-metric-value {
      font-size: 18px;
      font-weight: 900;
      color: var(--lmdr-dark);
      margin-bottom: 2px;
    }

    .carrier-metric-label {
      font-size: 10px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Tags */
    .match-tags {
      padding: 0 24px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .match-tag {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .match-tag.operation {
      background: #eff6ff;
      color: #3b82f6;
    }

    .match-tag.fleet {
      background: #f0fdf4;
      color: #22c55e;
    }

    .match-tag.client {
      background: #fefce8;
      color: #ca8a04;
      border: 1px solid #fde047;
    }

    .match-tag.cached {
      background: #faf5ff;
      color: #a855f7;
    }

    /* AI Intel Section */
    .ai-intel-section {
      background: #f8fafc;
      border-top: 1px solid #f1f5f9;
      padding: 24px;
    }

    .ai-intel-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 32px;
      background: white;
      border-radius: 16px;
      border: 1px dashed #cbd5e1;
    }

    .ai-intel-loading i {
      font-size: 32px;
      color: var(--lmdr-blue);
    }

    .ai-intel-loading-text {
      font-weight: 800;
      font-size: 14px;
      color: var(--lmdr-dark);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .ai-intel-loading-sub {
      font-size: 12px;
      color: var(--lmdr-body);
      text-align: center;
    }

    .ai-intel-loading-progress {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .ai-intel-loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--lmdr-blue), #60a5fa);
      width: 30%;
      border-radius: 3px;
      animation: progressIndeterminate 2s infinite linear;
    }

    @keyframes progressIndeterminate {
      0% {
        margin-left: -30%;
      }

      100% {
        margin-left: 100%;
      }
    }

    .ai-intel-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .ai-intel-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ai-intel-item strong {
      font-size: 10px;
      font-weight: 800;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .ai-intel-item span {
      font-size: 14px;
      font-weight: 600;
      color: var(--lmdr-dark);
    }

    /* Rationale UI */
    .match-rationale {
      margin: 0 24px 24px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 16px;
      display: none;
      animation: slideDown 0.3s ease;
      border: 1px dashed #cbd5e1;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .rationale-header {
      font-size: 13px;
      font-weight: 800;
      color: var(--lmdr-dark);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rationale-list {
      list-style: none;
    }

    .rationale-item {
      font-size: 14px;
      color: var(--lmdr-body);
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      line-height: 1.4;
    }

    .rationale-item i {
      color: var(--color-success);
      margin-top: 3px;
    }

    .analysis-btn {
      background: transparent;
      border: 1px solid #e2e8f0;
      color: #64748b;
      font-size: 11px;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 6px;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .analysis-btn:hover {
      background: #f8fafc;
      color: var(--lmdr-blue);
      border-color: var(--lmdr-blue);
    }

    .analysis-btn.active {
      background: var(--lmdr-dark);
      color: white;
      border-color: var(--lmdr-dark);
    }

    /* Match Action Buttons */
    .match-actions {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      /* Handle smaller screens gracefully */
    }

    .interested-btn,
    .analysis-btn,
    .match-btn.secondary {
      height: 48px;
      padding: 0 20px;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
      white-space: nowrap;
      flex: 1;
      /* Default flex grow */
    }

    /* Primary Style - Interested */
    .interested-btn {
      background: var(--lmdr-blue);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.25);
      flex: 1.5;
      /* Give more prominence to primary action */
      border: none;
    }

    .interested-btn:hover {
      background: #1d4ed8;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }

    .interested-btn:active {
      transform: translateY(0);
    }

    .interested-btn i {
      font-size: 14px;
      transition: transform 0.3s ease;
    }

    .interested-btn:hover i {
      transform: scale(1.2);
    }

    /* Analysis Button Styling */
    .analysis-btn {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      color: var(--lmdr-body);
      flex: 1;
    }

    .analysis-btn:hover {
      background: white;
      border-color: var(--lmdr-blue);
      color: var(--lmdr-blue);
    }

    .analysis-btn.active {
      background: var(--lmdr-dark);
      color: white;
      border-color: var(--lmdr-dark);
    }

    /* Secondary Style - FMCSA */
    .match-btn.secondary {
      background: white;
      border: 1px solid #e2e8f0;
      color: var(--lmdr-dark);
      flex: 1;
    }

    .match-btn.secondary:hover {
      background: #f8fafc;
      border-color: var(--lmdr-dark);
    }

    /* Applied State */
    .applied-btn {
      background: #ecfdf5 !important;
      color: #059669 !important;
      border: 1px solid #d1fae5 !important;
      box-shadow: none !important;
      cursor: default !important;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .match-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .interested-btn,
      .analysis-btn,
      .match-btn.secondary {
        width: 100%;
        flex: none;
      }
    }

    /* =========================================
       ACCORDION SYSTEM - Mobile-First UX
       ========================================= */
    .accordion-progress {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      overflow-x: auto;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .accordion-progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
      text-align: center;
    }

    .accordion-progress-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .accordion-progress-step.active .accordion-progress-dot {
      background: var(--lmdr-blue);
      color: white;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
    }

    .accordion-progress-step.complete .accordion-progress-dot {
      background: var(--color-success);
      color: white;
    }

    .accordion-progress-step.complete .accordion-progress-dot::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
    }

    .accordion-progress-label {
      font-size: 10px;
      font-weight: 600;
      color: #64748b;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .accordion-progress-step.active .accordion-progress-label {
      color: var(--lmdr-blue);
    }

    .accordion-progress-step.complete .accordion-progress-label {
      color: var(--color-success);
    }

    @media (max-width: 600px) {
      .accordion-progress {
        padding: 12px;
        gap: 4px;
      }

      .accordion-progress-step {
        min-width: 56px;
      }

      .accordion-progress-dot {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }

      .accordion-progress-label {
        font-size: 8px;
      }
    }

    /* Accordion Section Container */
    .accordion-section {
      margin-bottom: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      transition: all 0.3s ease;
    }

    .accordion-section.expanded {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border-color: var(--lmdr-blue);
    }

    .accordion-section.complete {
      border-color: var(--color-success);
    }

    .accordion-section.complete .accordion-header {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }

    /* Accordion Header */
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #f8fafc;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .accordion-header:hover {
      background: #f1f5f9;
    }

    .accordion-section.expanded .accordion-header {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-bottom: 1px solid #e2e8f0;
    }

    .accordion-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .accordion-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .accordion-section.expanded .accordion-number {
      background: var(--lmdr-blue);
      color: white;
    }

    .accordion-section.complete .accordion-number {
      background: var(--color-success);
      color: white;
    }

    .accordion-section.complete .accordion-number::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 12px;
    }

    .accordion-section.complete .accordion-number span {
      display: none;
    }

    .accordion-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--lmdr-dark);
    }

    .accordion-section.expanded .accordion-title {
      color: var(--lmdr-blue);
    }

    .accordion-section.complete .accordion-title {
      color: var(--color-success);
    }

    .accordion-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .accordion-status {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: #94a3b8;
    }

    .accordion-section.complete .accordion-status {
      color: var(--color-success);
    }

    .accordion-section.complete .accordion-status::before {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-right: 4px;
    }

    .accordion-chevron {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      transition: transform 0.3s ease;
    }

    .accordion-section.expanded .accordion-chevron {
      transform: rotate(180deg);
      color: var(--lmdr-blue);
    }

    /* Accordion Content */
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, padding 0.3s ease;
      padding: 0 20px;
    }

    .accordion-section.expanded .accordion-content {
      max-height: 2000px;
      padding: 20px;
      transition: max-height 0.5s ease-in, padding 0.3s ease;
    }

    @media (max-width: 600px) {
      .accordion-header {
        padding: 12px 16px;
      }

      .accordion-title {
        font-size: 13px;
      }

      .accordion-number {
        width: 24px;
        height: 24px;
        font-size: 11px;
      }

      .accordion-section.expanded .accordion-content {
        padding: 16px;
      }
    }

    /* Accordion Next Button */
    .accordion-next-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 24px;
      margin-top: 16px;
      background: var(--lmdr-blue);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .accordion-next-btn:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .accordion-next-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    /* Section-specific styling */
    .accordion-section .file-upload-section {
      margin-bottom: 16px;
    }

    .accordion-section .form-row {
      margin-bottom: 16px;
    }

    .accordion-section .form-group {
      margin-bottom: 16px;
    }

    .accordion-section .form-group:last-child {
      margin-bottom: 0;
    }
  </style>
  <script src="../js/feature-tracker.js"></script>
</head>

<body>
  <div class="container">

    <section class="form-section" id="formSection">
      <div class="form-header">
        <span class="form-badge"><i class="fa-solid fa-shield-halved"></i> FMCSA Verified  AI-Powered</span>
        <h1 class="form-title">Find Your Carrier</h1>
        <p class="form-subtitle">Real safety data. Real driver reviews. Real matches.</p>
      </div>

      <form id="driverForm" class="form-grid">
        <div class="form-group">
          <label class="form-label" for="homeZip">
            <i class="fa-solid fa-location-dot"></i> Home Zip Code
          </label>
          <input type="text" id="homeZip" class="form-input" placeholder="e.g., 75001" maxlength="5" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxDistance">
            <i class="fa-solid fa-route"></i> Max Commute
          </label>
          <select id="maxDistance" class="form-select">
            <option value="50">50 miles</option>
            <option value="100">100 miles</option>
            <option value="250">250 miles</option>
            <option value="500">500 miles</option>
            <option value="1000">Nationwide</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="minCPM">
            <i class="fa-solid fa-money-bill-wave"></i> Min Pay (CPM)
          </label>
          <input type="number" id="minCPM" class="form-input" placeholder="e.g., 0.55" step="0.01" min="0" max="2">
        </div>

        <div class="form-group">
          <label class="form-label" for="operationType">
            <i class="fa-solid fa-truck-ramp-box"></i> Run Type
          </label>
          <select id="operationType" class="form-select">
            <option value="any">No preference</option>
            <option value="OTR">OTR (Long Haul)</option>
            <option value="Regional">Regional</option>
            <option value="Local">Local / Home Daily</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxTurnover">
            <i class="fa-solid fa-users-gear"></i> Max Turnover
          </label>
          <select id="maxTurnover" class="form-select">
            <option value="90" selected>Under 90% (Average)</option>
            <option value="50">Under 50% (High Retention)</option>
            <option value="25">Under 25% (Elite)</option>
            <option value="200">No Limit</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxTruckAge">
            <i class="fa-solid fa-truck-front"></i> Max Truck Age
          </label>
          <select id="maxTruckAge" class="form-select">
            <option value="5" selected>5 years or newer</option>
            <option value="3">3 years or newer</option>
            <option value="10">Under 10 years</option>
            <option value="99">Any age</option>
          </select>
        </div>

        <div class="form-group full-width">
          <label class="form-label" for="driverName">
            <i class="fa-solid fa-user"></i>
            Your Name
            <span class="hint">(Optional)</span>
          </label>
          <input type="text" id="driverName" class="form-input" placeholder="Enter your full name">
        </div>

        <div class="form-group full-width">
          <label class="form-label">
            <i class="fa-solid fa-boxes-stacked"></i> Fleet Size Preference
          </label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetSmall" value="small">
              <label for="fleetSmall">
                <i class="fa-solid fa-truck"></i>
                <span>Small</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetMedium" value="medium">
              <label for="fleetMedium">
                <i class="fa-solid fa-truck-moving"></i>
                <span>Medium</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetLarge" value="large">
              <label for="fleetLarge">
                <i class="fa-solid fa-warehouse"></i>
                <span>Large</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetAny" value="any" checked>
              <label for="fleetAny">
                <i class="fa-solid fa-check-double"></i>
                <span>Any</span>
              </label>
            </div>
          </div>
        </div>

        <div class="form-group full-width" style="margin-top: 12px;">
          <button type="button" id="togglePriorities" class="reset-btn"
            style="width: 100%; justify-content: center; border-style: dashed; background: #f8fafc;">
            <i class="fa-solid fa-sliders"></i> Customize Match Priorities
          </button>
        </div>

        <div class="advanced-priorities full-width" id="advancedPriorities">
          <div class="priorities-header">
            <div class="priorities-title"><i class="fa-solid fa-weight-hanging"></i> Adjust Match Importance</div>
            <button type="button" id="resetWeights" class="modal-btn tertiary"
              style="width: auto; padding: 4px 8px; font-size: 10px;">Reset to Default</button>
          </div>
          <div class="priorities-grid">
            <div class="priority-item">
              <label class="priority-label" for="weight-location">
                <span>Home Location</span>
                <span class="weight-value-badge" id="weight-val-location">Standard</span>
              </label>
              <input type="range" id="weight-location" min="0" max="100" value="25">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-pay">
                <span>Driver Pay</span>
                <span class="weight-value-badge" id="weight-val-pay">Standard</span>
              </label>
              <input type="range" id="weight-pay" min="0" max="100" value="20">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-operationType">
                <span>Route Match</span>
                <span class="weight-value-badge" id="weight-val-operationType">Standard</span>
              </label>
              <input type="range" id="weight-operationType" min="0" max="100" value="15">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-safety">
                <span>Safety Record</span>
                <span class="weight-value-badge" id="weight-val-safety">Standard</span>
              </label>
              <input type="range" id="weight-safety" min="0" max="100" value="10">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-turnover">
                <span>Driver Retention</span>
                <span class="weight-value-badge" id="weight-val-turnover">Standard</span>
              </label>
              <input type="range" id="weight-turnover" min="0" max="100" value="12">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-truckAge">
                <span>Fleet Age</span>
                <span class="weight-value-badge" id="weight-val-truckAge">Standard</span>
              </label>
              <input type="range" id="weight-truckAge" min="0" max="100" value="8">
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          <i class="fa-solid fa-magnifying-glass"></i> Find My Matches
        </button>
      </form>
    </section>

    <section class="loading-section" id="loadingSection">
      <div class="loading-spinner"></div>
      <h2 class="loading-title">Finding Your Matches</h2>
      <p style="color: var(--lmdr-body); font-weight: 500;">Analyzing carriers with verified safety data...</p>

      <ul class="loading-steps">
        <li class="loading-step" id="step1"><i class="fa-solid fa-circle-notch fa-spin"></i> <span>Searching by
            location...</span></li>
        <li class="loading-step" id="step2"><i class="fa-regular fa-circle"></i> <span>Pulling FMCSA safety
            records...</span></li>
        <li class="loading-step" id="step3"><i class="fa-regular fa-circle"></i> <span>Scoring matches...</span></li>
        <li class="loading-step" id="step4"><i class="fa-regular fa-circle"></i> <span>Building your report...</span>
        </li>
      </ul>
    </section>


    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <div class="results-header-left">
          <div>
            <h2 class="results-title">Your Top Matches</h2>
            <p class="results-meta">Scored <span id="totalScored">0</span> carriers  Showing top <span
                id="matchCount">0</span></p>
          </div>
          <div id="userTierBadge"></div>
        </div>
        <div class="results-header-right">
          <button class="reset-btn" id="resetBtn">
            <i class="fa-solid fa-rotate-left"></i> New Search
          </button>
        </div>
      </div>

      <!-- Premium Success Banner (shown to logged in users) -->
      <div class="premium-success-banner" id="premiumBanner" style="display: none;">
        <i class="fa-solid fa-crown"></i>
        <div class="premium-success-text">
          <strong>Premium Access Active</strong>
          <span>You're seeing all 10 of your top carrier matches with full AI intelligence.</span>
        </div>
      </div>

      <!-- Upsell Banner (shown to free users with more matches available) -->
      <div class="upsell-banner" id="upsellBanner" style="display: none;">
        <div class="upsell-content">
          <div class="upsell-title"><i class="fa-solid fa-lock-open"></i> Unlock Your Full Match List</div>
          <div class="upsell-text" id="upsellText">You're seeing 2 of your matches. Sign up free to see all carriers
            that fit your criteria.</div>
          <div class="upsell-stats">
            <div class="upsell-stat">
              <div class="upsell-stat-value" id="hiddenMatchCount">8</div>
              <div class="upsell-stat-label">More Matches</div>
            </div>
            <div class="upsell-stat">
              <div class="upsell-stat-value">10</div>
              <div class="upsell-stat-label">Premium Limit</div>
            </div>
          </div>
        </div>
        <div class="upsell-actions">
          <button class="upsell-btn" id="signupBtn">
            <i class="fa-solid fa-user-plus"></i> Sign Up Free
          </button>
          <button class="upsell-btn secondary" id="loginBtn">
            <i class="fa-solid fa-right-to-bracket"></i> Log In
          </button>
        </div>
      </div>

      <div class="results-grid">
        <div class="matches-list" id="matchesList"></div>

        <!-- Coming Soon Sidebar Widget -->
        <aside class="coming-soon-sidebar">
          <div class="sidebar-header">
            <div class="sidebar-header-icon">
              <i class="fa-solid fa-rocket"></i>
            </div>
            <h3>Coming Soon</h3>
          </div>

          <div class="sidebar-features-list">
            <!-- Driver Utility Expansion -->
            <div class="sidebar-category" data-category="utility">
              <div class="sidebar-category-header utility" onclick="toggleCategory(this)">
                <i class="fa-solid fa-wrench sidebar-category-icon"></i>
                <span class="sidebar-category-title">Utility Expansion</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-gauge-high"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Profile Strength Meter</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-reply-all"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Quick Response Templates</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-bell"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Reverse Alerts</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-chart-line"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Insights Panel</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Road Utilities -->
            <div class="sidebar-category" data-category="road">
              <div class="sidebar-category-header road" onclick="toggleCategory(this)">
                <i class="fa-solid fa-road sidebar-category-icon"></i>
                <span class="sidebar-category-title">Road Utilities</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-square-parking"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Parking Finder</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-gas-pump"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Fuel Optimizer</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-scale-balanced"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Weigh Station Status</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-cloud-sun-rain"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Weather & Road Alerts</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Compliance Tools -->
            <div class="sidebar-category" data-category="compliance">
              <div class="sidebar-category-header compliance" onclick="toggleCategory(this)">
                <i class="fa-solid fa-clipboard-check sidebar-category-icon"></i>
                <span class="sidebar-category-title">Compliance Tools</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-clock"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">HOS Tracker</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-folder-open"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Document Wallet</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-calendar-xmark"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Expiration Alerts</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-graduation-cap"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Training Tracker</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Financial Tools -->
            <div class="sidebar-category" data-category="financial">
              <div class="sidebar-category-header financial" onclick="toggleCategory(this)">
                <i class="fa-solid fa-dollar-sign sidebar-category-icon"></i>
                <span class="sidebar-category-title">Financial Tools</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Settlement Viewer</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-receipt"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Expense Tracker</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-calculator"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Trip Pay Calculator</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-piggy-bank"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Tax Deduction Helper</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Community -->
            <div class="sidebar-category" data-category="community">
              <div class="sidebar-category-header community" onclick="toggleCategory(this)">
                <i class="fa-solid fa-users sidebar-category-icon"></i>
                <span class="sidebar-category-title">Driver Community</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-comments"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Forums</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-handshake"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Mentor Matching</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-paw"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Pet-Friendly Database</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-heart-pulse"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Trucker Health Resources</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

  </div>

  <!-- Interest Confirmation Modal -->
  <div id="interestModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-success-icon">
          <i class="fa-solid fa-check-circle"></i>
        </div>
        <h2 class="modal-title">Interest Logged!</h2>
        <p class="modal-subtitle">We've notified <span id="modalCarrierName">the carrier</span> that you're interested.
        </p>
      </div>

      <div class="modal-body">
        <div class="modal-carrier-info">
          <div class="modal-info-row">
            <i class="fa-solid fa-building"></i>
            <span id="modalCarrierFullName">Carrier Name</span>
          </div>
          <div class="modal-info-row" id="modalPhoneRow">
            <i class="fa-solid fa-phone"></i>
            <a href="#" id="modalCarrierPhone">Contact Phone</a>
          </div>
          <div class="modal-info-row" id="modalEmailRow">
            <i class="fa-solid fa-envelope"></i>
            <a href="#" id="modalCarrierEmail">Contact Email</a>
          </div>
          <div class="modal-info-row">
            <i class="fa-solid fa-hashtag"></i>
            <span>DOT: <span id="modalCarrierDOT">000000</span></span>
          </div>
        </div>

        <div class="modal-next-steps">
          <h4><i class="fa-solid fa-arrow-right"></i> What's Next?</h4>
          <ul>
            <li><i class="fa-solid fa-circle-check"></i> The carrier has been notified of your interest</li>
            <li><i class="fa-solid fa-file-arrow-up"></i> Complete your application to stand out</li>
            <li><i class="fa-solid fa-chart-line"></i> Track your status in the Application Dashboard</li>
          </ul>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn primary" id="modalApplyBtn">
          <i class="fa-solid fa-file-arrow-up"></i> Complete Application
        </button>
        <button class="modal-btn secondary" id="modalDashboardBtn">
          <i class="fa-solid fa-list-check"></i> View My Applications
        </button>
        <button class="modal-btn tertiary" id="modalCloseBtn">
          Keep Browsing
        </button>
      </div>
    </div>
  </div>

  <!-- Application Form Modal -->
  <div id="applicationModal" class="modal-overlay" style="display: none;">
    <div class="modal-container application-form">
      <div class="modal-header apply-header">
        <div class="modal-success-icon">
          <i class="fa-solid fa-file-arrow-up"></i>
        </div>
        <h2 class="modal-title">Complete Your Application</h2>
        <p class="modal-subtitle">Stand out to <span id="appModalCarrierName">the carrier</span></p>
      </div>

      <!-- Form Content -->
      <div id="applicationFormContent">
        <div class="modal-form">
          <div class="form-carrier-badge">
            <i class="fa-solid fa-building"></i>
            <div class="carrier-info">
              <div class="carrier-name" id="appFormCarrierName">Carrier Name</div>
              <div class="carrier-dot">DOT: <span id="appFormCarrierDOT">000000</span></div>
            </div>
          </div>

          <form id="applicationForm">
            <!-- Progress Indicator -->
            <div class="accordion-progress" id="accordionProgress">
              <div class="accordion-progress-step active" data-section="1">
                <div class="accordion-progress-dot">1</div>
                <div class="accordion-progress-label">Documents</div>
              </div>
              <div class="accordion-progress-step" data-section="2">
                <div class="accordion-progress-dot">2</div>
                <div class="accordion-progress-label">Personal</div>
              </div>
              <div class="accordion-progress-step" data-section="3">
                <div class="accordion-progress-dot">3</div>
                <div class="accordion-progress-label">CDL Info</div>
              </div>
              <div class="accordion-progress-step" data-section="4">
                <div class="accordion-progress-dot">4</div>
                <div class="accordion-progress-label">Safety</div>
              </div>
              <div class="accordion-progress-step" data-section="5">
                <div class="accordion-progress-dot">5</div>
                <div class="accordion-progress-label">History</div>
              </div>
              <div class="accordion-progress-step" data-section="6">
                <div class="accordion-progress-dot">6</div>
                <div class="accordion-progress-label">Preferences</div>
              </div>
            </div>

            <!-- Section 1: Document Upload (Starts OPEN) -->
            <div class="accordion-section expanded" data-section="1" id="accordionSection1">
              <div class="accordion-header" onclick="toggleAccordion(1)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>1</span></div>
                  <div class="accordion-title">Document Upload</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="file-upload-section">
                  <h4><i class="fa-solid fa-id-card"></i> CDL License <span class="required">*</span></h4>
                  <div class="file-upload-grid">
                    <div class="file-upload-box" id="cdlFrontBox">
                      <input type="file" id="cdlFront" accept="image/*" />
                      <button type="button" class="remove-file" onclick="removeFile('cdlFront')"><i
                          class="fa-solid fa-times"></i></button>
                      <div class="upload-icon"><i class="fa-solid fa-id-card"></i></div>
                      <span class="upload-label">CDL Front</span>
                      <span class="upload-hint">Click to upload</span>
                      <span class="file-name" id="cdlFrontName"></span>
                    </div>
                    <div class="file-upload-box" id="cdlBackBox">
                      <input type="file" id="cdlBack" accept="image/*" />
                      <button type="button" class="remove-file" onclick="removeFile('cdlBack')"><i
                          class="fa-solid fa-times"></i></button>
                      <div class="upload-icon"><i class="fa-solid fa-id-card-clip"></i></div>
                      <span class="upload-label">CDL Back</span>
                      <span class="upload-hint">Click to upload</span>
                      <span class="file-name" id="cdlBackName"></span>
                    </div>
                  </div>
                  <div class="error-message" id="cdlError">Please upload both sides of your CDL</div>
                </div>

                <div class="file-upload-section">
                  <h4><i class="fa-solid fa-file-medical"></i> Medical Card <span class="required">*</span></h4>
                  <div class="file-upload-grid" style="grid-template-columns: 1fr;">
                    <div class="file-upload-box" id="medCardBox">
                      <input type="file" id="medCard" accept="image/*,.pdf" />
                      <button type="button" class="remove-file" onclick="removeFile('medCard')"><i
                          class="fa-solid fa-times"></i></button>
                      <div class="upload-icon"><i class="fa-solid fa-file-medical"></i></div>
                      <span class="upload-label">DOT Medical Card</span>
                      <span class="upload-hint">Image or PDF</span>
                      <span class="file-name" id="medCardName"></span>
                    </div>
                  </div>
                  <div class="error-message" id="medCardError">Please upload your medical card</div>
                </div>

                <div class="upload-requirements">
                  <i class="fa-solid fa-circle-info"></i>
                  <span>Files must be clear, readable images (JPG, PNG) or PDF. Max 5MB each.</span>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(2)">
                  Continue to Personal Info <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 2: Personal Information -->
            <div class="accordion-section" data-section="2" id="accordionSection2">
              <div class="accordion-header" onclick="toggleAccordion(2)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>2</span></div>
                  <div class="accordion-title">Personal Information</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="appFirstName">First Name <span class="required">*</span></label>
                    <input type="text" id="appFirstName" name="firstName" placeholder="First name" required>
                    <div class="error-message" id="firstNameError">Please enter your first name</div>
                  </div>
                  <div class="form-group">
                    <label for="appLastName">Last Name <span class="required">*</span></label>
                    <input type="text" id="appLastName" name="lastName" placeholder="Last name" required>
                    <div class="error-message" id="lastNameError">Please enter your last name</div>
                  </div>
                </div>

                <div class="form-group" style="max-width: 200px;">
                  <label for="appDOB">Date of Birth <span class="required">*</span></label>
                  <input type="date" id="appDOB" name="dob" required>
                  <div class="error-message" id="dobError">Please enter your date of birth</div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(3)">
                  Continue to CDL Info <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 3: CDL Information -->
            <div class="accordion-section" data-section="3" id="accordionSection3">
              <div class="accordion-header" onclick="toggleAccordion(3)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>3</span></div>
                  <div class="accordion-title">CDL Information</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="cdlNumber">CDL Number <span class="required">*</span></label>
                    <input type="text" id="cdlNumber" name="cdlNumber" placeholder="Enter CDL number" required>
                    <div class="error-message" id="cdlNumberError">Please enter your CDL number</div>
                  </div>
                  <div class="form-group">
                    <label for="cdlExpiration">CDL Expiration <span class="required">*</span></label>
                    <input type="date" id="cdlExpiration" name="cdlExpiration" required>
                    <div class="error-message" id="cdlExpirationError">Please enter CDL expiration date</div>
                  </div>
                </div>

                <div class="form-group">
                  <label>CDL Class <span class="required">*</span></label>
                  <div class="radio-group cdl-class-group">
                    <label class="radio-chip">
                      <input type="radio" name="cdlClass" value="A" required>
                      <span>Class A</span>
                    </label>
                    <label class="radio-chip">
                      <input type="radio" name="cdlClass" value="B">
                      <span>Class B</span>
                    </label>
                    <label class="radio-chip">
                      <input type="radio" name="cdlClass" value="C">
                      <span>Class C</span>
                    </label>
                  </div>
                  <div class="error-message" id="cdlClassError">Please select your CDL class</div>
                </div>

                <div class="form-group">
                  <label>Endorsements <span class="hint">(Select all that apply)</span></label>
                  <div class="checkbox-group endorsements-group">
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="H">
                      <span>H - Hazmat</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="N">
                      <span>N - Tank</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="P">
                      <span>P - Passenger</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="S">
                      <span>S - School Bus</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="T">
                      <span>T - Doubles/Triples</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="X">
                      <span>X - Hazmat + Tank</span>
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label for="medCardExpiration">Medical Card Expiration <span class="required">*</span></label>
                  <input type="date" id="medCardExpiration" name="medCardExpiration" required>
                  <div class="error-message" id="medCardExpirationError">Please enter medical card expiration date</div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="appCity">City <span class="required">*</span></label>
                    <input type="text" id="appCity" name="city" placeholder="City" required>
                  </div>
                  <div class="form-group" style="flex: 0.5;">
                    <label for="appState">State <span class="required">*</span></label>
                    <select id="appState" name="state" required>
                      <option value="">--</option>
                      <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option>
                      <option value="AR">AR</option><option value="CA">CA</option><option value="CO">CO</option>
                      <option value="CT">CT</option><option value="DE">DE</option><option value="FL">FL</option>
                      <option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
                      <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option>
                      <option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option>
                      <option value="ME">ME</option><option value="MD">MD</option><option value="MA">MA</option>
                      <option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                      <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option>
                      <option value="NV">NV</option><option value="NH">NH</option><option value="NJ">NJ</option>
                      <option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option>
                      <option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
                      <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
                      <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option>
                      <option value="TX">TX</option><option value="UT">UT</option><option value="VT">VT</option>
                      <option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
                      <option value="WI">WI</option><option value="WY">WY</option>
                    </select>
                  </div>
                  <div class="form-group" style="flex: 0.7;">
                    <label for="appZip">ZIP Code <span class="required">*</span></label>
                    <input type="text" id="appZip" name="homeZip" placeholder="ZIP" maxlength="5" pattern="[0-9]{5}" required>
                  </div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(4)">
                  Continue to Safety Record <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 4: Safety Record -->
            <div class="accordion-section" data-section="4" id="accordionSection4">
              <div class="accordion-header" onclick="toggleAccordion(4)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>4</span></div>
                  <div class="accordion-title">Safety Record</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="appYearsExperience">Years of CDL Experience <span class="required">*</span></label>
                    <select id="appYearsExperience" name="yearsExperience" required>
                      <option value="">Select...</option>
                      <option value="0">Less than 1 year</option>
                      <option value="1">1-2 years</option>
                      <option value="3">3-5 years</option>
                      <option value="6">6-10 years</option>
                      <option value="11">11-15 years</option>
                      <option value="16">16+ years</option>
                    </select>
                    <div class="error-message" id="yearsExperienceError">Please select your experience</div>
                  </div>
                  <div class="form-group">
                    <label for="appMvrStatus">Driving Record</label>
                    <select id="appMvrStatus" name="mvrStatus">
                      <option value="clean">Clean MVR</option>
                      <option value="minor_violations">Minor Violations</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="appAccidents">Accidents in Last 3 Years</label>
                    <input type="number" id="appAccidents" name="accidents_last_3_years" min="0" max="10" value="0" placeholder="0">
                  </div>
                  <div class="form-group">
                    <label for="appViolations">Moving Violations in Last 3 Years</label>
                    <input type="number" id="appViolations" name="violations_last_3_years" min="0" max="10" value="0" placeholder="0">
                  </div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(5)">
                  Continue to Work History <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 5: Work History -->
            <div class="accordion-section" data-section="5" id="accordionSection5">
              <div class="accordion-header" onclick="toggleAccordion(5)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>5</span></div>
                  <div class="accordion-title">Work History</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-group">
                  <label for="appCompaniesCount">How many trucking companies have you worked for in the past 3 years? <span class="required">*</span></label>
                  <select id="appCompaniesCount" name="companies_last_3_years" required>
                    <option value="">Select...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10+</option>
                  </select>
                  <div class="error-message" id="companiesCountError">Please select the number of companies</div>
                </div>

                <div id="employer1Section" class="employer-section" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="appEmployer1Name">Most Recent Employer <span class="required">*</span></label>
                      <input type="text" id="appEmployer1Name" name="employer_1_name" placeholder="Company name">
                      <div class="error-message" id="employer1NameError">Please enter employer name</div>
                    </div>
                    <div class="form-group">
                      <label for="appEmployer1Duration">Duration <span class="required">*</span></label>
                      <select id="appEmployer1Duration" name="employer_1_duration">
                        <option value="">Select...</option>
                        <option value="less_than_6_months">Less than 6 months</option>
                        <option value="6_months">6 months</option>
                        <option value="1_year">1 year</option>
                        <option value="2_years">2 years</option>
                        <option value="3_plus_years">3+ years</option>
                      </select>
                      <div class="error-message" id="employer1DurationError">Please select duration</div>
                    </div>
                  </div>
                </div>

                <div id="employer2Section" class="employer-section" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="appEmployer2Name">Previous Employer <span class="hint">(Optional)</span></label>
                      <input type="text" id="appEmployer2Name" name="employer_2_name" placeholder="Company name">
                    </div>
                    <div class="form-group">
                      <label for="appEmployer2Duration">Duration</label>
                      <select id="appEmployer2Duration" name="employer_2_duration">
                        <option value="">Select...</option>
                        <option value="less_than_6_months">Less than 6 months</option>
                        <option value="6_months">6 months</option>
                        <option value="1_year">1 year</option>
                        <option value="2_years">2 years</option>
                        <option value="3_plus_years">3+ years</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div id="employer3Section" class="employer-section" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="appEmployer3Name">Prior Employer <span class="hint">(Optional)</span></label>
                      <input type="text" id="appEmployer3Name" name="employer_3_name" placeholder="Company name">
                    </div>
                    <div class="form-group">
                      <label for="appEmployer3Duration">Duration</label>
                      <select id="appEmployer3Duration" name="employer_3_duration">
                        <option value="">Select...</option>
                        <option value="less_than_6_months">Less than 6 months</option>
                        <option value="6_months">6 months</option>
                        <option value="1_year">1 year</option>
                        <option value="2_years">2 years</option>
                        <option value="3_plus_years">3+ years</option>
                      </select>
                    </div>
                  </div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(6)">
                  Continue to Job Preferences <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 6: Job Preferences -->
            <div class="accordion-section" data-section="6" id="accordionSection6">
              <div class="accordion-header" onclick="toggleAccordion(6)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>6</span></div>
                  <div class="accordion-title">Job Preferences</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-group">
                  <label>Equipment Experience <span class="required">*</span> <span class="hint">(Select all that apply)</span></label>
                  <div class="checkbox-group equipment-group">
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Dry Van">
                      <span>Dry Van</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Reefer">
                      <span>Reefer</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Flatbed">
                      <span>Flatbed</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Tanker">
                      <span>Tanker</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Hazmat">
                      <span>Hazmat</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Auto Hauler">
                      <span>Auto Hauler</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Step Deck">
                      <span>Step Deck</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Lowboy">
                      <span>Lowboy</span>
                    </label>
                  </div>
                  <div class="error-message" id="equipmentError">Please select at least one equipment type</div>
                </div>

                <div class="form-group">
                  <label>Preferred Routes <span class="required">*</span></label>
                  <div class="checkbox-group routes-group">
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="Local">
                      <span>Local</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="Regional">
                      <span>Regional</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="OTR">
                      <span>OTR</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="Dedicated">
                      <span>Dedicated</span>
                    </label>
                  </div>
                  <div class="error-message" id="routesError">Please select at least one route type</div>
                </div>

                <div class="form-group">
                  <label for="appHomeTime">Home Time Preference</label>
                  <select id="appHomeTime" name="homeTimePreference">
                    <option value="Daily">Daily</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Bi-weekly">Bi-weekly</option>
                    <option value="Monthly">Monthly</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="appPhone">Phone Number <span class="required">*</span></label>
                    <input type="tel" id="appPhone" name="phone" placeholder="(555) 123-4567" required>
                    <div class="error-message" id="phoneError">Please enter a valid phone number</div>
                  </div>
                  <div class="form-group">
                    <label for="appEmail">Email Address <span class="required">*</span></label>
                    <input type="email" id="appEmail" name="email" placeholder="driver@email.com" required>
                    <div class="error-message" id="emailError">Please enter a valid email address</div>
                  </div>
                </div>

                <div class="form-group">
                  <label>Preferred Contact Method</label>
                  <div class="contact-preference">
                    <label>
                      <input type="radio" name="preferredContact" value="phone" checked>
                      <span>Phone</span>
                    </label>
                    <label>
                      <input type="radio" name="preferredContact" value="email">
                      <span>Email</span>
                    </label>
                    <label>
                      <input type="radio" name="preferredContact" value="either">
                      <span>Either</span>
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label for="appAvailability">When can you start?</label>
                  <select id="appAvailability" name="availability">
                    <option value="immediately">Immediately</option>
                    <option value="1_week">Within 1 week</option>
                    <option value="2_weeks">Within 2 weeks</option>
                    <option value="1_month">Within 1 month</option>
                    <option value="flexible">Flexible</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="appMessage">Message to Recruiter (Optional)</label>
                  <textarea id="appMessage" name="message"
                    placeholder="Introduce yourself, highlight your experience, or ask questions about the position..."></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="form-actions">
          <button type="button" class="modal-btn secondary" id="appCancelBtn">
            <i class="fa-solid fa-arrow-left"></i> Back
          </button>
          <button type="button" class="modal-btn primary" id="appSubmitBtn">
            <i class="fa-solid fa-paper-plane"></i> Submit Application
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="applicationFormLoading" class="form-loading">
        <i class="fa-solid fa-spinner"></i>
        <p id="applicationLoadingText">Submitting your application...</p>
      </div>

      <!-- Success State -->
      <div id="applicationFormSuccess" class="form-success">
        <i class="fa-solid fa-circle-check"></i>
        <h3>Application Submitted!</h3>
        <p>The carrier has been notified. They'll reach out using your preferred contact method.</p>
        <div style="margin-top: 20px;">
          <button type="button" class="modal-btn primary" id="appSuccessCloseBtn">
            <i class="fa-solid fa-check"></i> Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Coming Soon Sidebar - Category Toggle -->
  <script>
    function toggleCategory(headerElement) {
      if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('matching_filter_category', { category: headerElement.textContent.trim() });
      const category = headerElement.closest('.sidebar-category');
      if (category) {
        category.classList.toggle('collapsed');
      }
    }
  </script>

  <!-- Accordion System - Mobile-First Collapsible Form Sections -->
  <script>
    (function(global) {
      'use strict';

      // =========================================================================
      // ACCORDION SYSTEM - Collapsible Form Sections with Completion Tracking
      // =========================================================================

      const ACCORDION_CONFIG = {
        totalSections: 6,
        sectionLabels: ['Documents', 'Personal', 'CDL Info', 'Safety', 'History', 'Preferences'],
        // Required fields per section for completion detection
        sectionRequirements: {
          1: { files: ['cdlFront', 'cdlBack', 'medCard'] },
          2: { fields: ['appFirstName', 'appLastName', 'appDOB'] },
          3: { fields: ['cdlNumber', 'cdlExpiration', 'medCardExpiration', 'appCity', 'appState', 'appZip'], radio: ['cdlClass'] },
          4: { fields: ['appYearsExperience'] },
          5: { fields: ['appCompaniesCount'] },
          6: { checkboxGroups: ['equipmentExperience', 'preferredRoutes'], fields: ['appPhone', 'appEmail'] }
        }
      };

      let _currentSection = 1;
      let _sectionCompletion = { 1: false, 2: false, 3: false, 4: false, 5: false, 6: false };

      // Toggle accordion section expand/collapse
      function toggleAccordion(sectionNum) {
        const section = document.getElementById('accordionSection' + sectionNum);
        if (!section) return;

        const wasExpanded = section.classList.contains('expanded');

        // Collapse all sections first
        for (let i = 1; i <= ACCORDION_CONFIG.totalSections; i++) {
          const sec = document.getElementById('accordionSection' + i);
          if (sec) sec.classList.remove('expanded');
        }

        // If it was collapsed, expand it
        if (!wasExpanded) {
          section.classList.add('expanded');
          _currentSection = sectionNum;
          updateProgressIndicator();

          // Scroll section into view within modal container
          setTimeout(() => {
            scrollSectionIntoView(section);
          }, 100);
        }
      }

      // Smart scroll that works within modal containers
      function scrollSectionIntoView(section) {
        const modalForm = section.closest('.modal-form');
        if (modalForm) {
          // Scroll within modal
          const sectionTop = section.offsetTop - modalForm.offsetTop;
          modalForm.scrollTo({ top: sectionTop - 10, behavior: 'smooth' });
        } else {
          // Fallback to regular scroll
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Advance to next section (called by "Continue" buttons)
      function advanceToSection(nextSectionNum) {
        const currentSection = nextSectionNum - 1;

        // Mark current section as complete if requirements are met
        if (currentSection >= 1 && currentSection <= ACCORDION_CONFIG.totalSections) {
          checkSectionCompletion(currentSection);
        }

        // Collapse current section
        const current = document.getElementById('accordionSection' + currentSection);
        if (current) current.classList.remove('expanded');

        // Expand next section
        if (nextSectionNum <= ACCORDION_CONFIG.totalSections) {
          const next = document.getElementById('accordionSection' + nextSectionNum);
          if (next) {
            next.classList.add('expanded');
            _currentSection = nextSectionNum;
            updateProgressIndicator();

            // Scroll next section into view within modal
            setTimeout(() => {
              scrollSectionIntoView(next);
            }, 100);
          }
        }
      }

      // Check if a section's required fields are filled
      function checkSectionCompletion(sectionNum) {
        const requirements = ACCORDION_CONFIG.sectionRequirements[sectionNum];
        if (!requirements) return false;

        let isComplete = true;

        // Check file uploads
        if (requirements.files) {
          for (const fileId of requirements.files) {
            const box = document.getElementById(fileId + 'Box');
            if (!box || !box.classList.contains('has-file')) {
              isComplete = false;
              break;
            }
          }
        }

        // Check regular fields
        if (isComplete && requirements.fields) {
          for (const fieldId of requirements.fields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value || field.value.trim() === '') {
              isComplete = false;
              break;
            }
          }
        }

        // Check radio groups
        if (isComplete && requirements.radio) {
          for (const radioName of requirements.radio) {
            const checked = document.querySelector('input[name="' + radioName + '"]:checked');
            if (!checked) {
              isComplete = false;
              break;
            }
          }
        }

        // Check checkbox groups (at least one selected)
        if (isComplete && requirements.checkboxGroups) {
          for (const groupName of requirements.checkboxGroups) {
            const checked = document.querySelector('input[name="' + groupName + '"]:checked');
            if (!checked) {
              isComplete = false;
              break;
            }
          }
        }

        // Update completion state
        _sectionCompletion[sectionNum] = isComplete;
        updateSectionStatus(sectionNum, isComplete);
        updateProgressIndicator();

        return isComplete;
      }

      // Update the visual status of a section header
      function updateSectionStatus(sectionNum, isComplete) {
        const section = document.getElementById('accordionSection' + sectionNum);
        if (!section) return;

        const statusEl = section.querySelector('.accordion-status');

        if (isComplete) {
          section.classList.add('complete');
          if (statusEl) statusEl.textContent = 'Complete';
        } else {
          section.classList.remove('complete');
          if (statusEl) statusEl.textContent = '';
        }
      }

      // Update the top progress indicator
      function updateProgressIndicator() {
        const progressSteps = document.querySelectorAll('.accordion-progress-step');

        progressSteps.forEach((step, index) => {
          const sectionNum = index + 1;
          step.classList.remove('active', 'complete');

          if (_sectionCompletion[sectionNum]) {
            step.classList.add('complete');
          } else if (sectionNum === _currentSection) {
            step.classList.add('active');
          }
        });
      }

      // Check all sections for completion (called periodically)
      function checkAllSections() {
        for (let i = 1; i <= ACCORDION_CONFIG.totalSections; i++) {
          checkSectionCompletion(i);
        }
      }

      // Setup change listeners for real-time completion detection
      function setupCompletionListeners() {
        // Listen to all inputs and selects in the form
        const form = document.getElementById('applicationForm');
        if (!form) return;

        form.addEventListener('input', debounce(function(e) {
          // Find which section this input belongs to
          const section = e.target.closest('.accordion-section');
          if (section) {
            const sectionNum = parseInt(section.dataset.section);
            if (sectionNum) {
              checkSectionCompletion(sectionNum);
            }
          }
        }, 300));

        form.addEventListener('change', function(e) {
          const section = e.target.closest('.accordion-section');
          if (section) {
            const sectionNum = parseInt(section.dataset.section);
            if (sectionNum) {
              checkSectionCompletion(sectionNum);
            }
          }
        });

        // Watch for file upload changes via MutationObserver on file boxes
        const fileBoxes = ['cdlFrontBox', 'cdlBackBox', 'medCardBox'];
        fileBoxes.forEach(boxId => {
          const box = document.getElementById(boxId);
          if (box) {
            const observer = new MutationObserver(() => {
              checkSectionCompletion(1);
            });
            observer.observe(box, { attributes: true, attributeFilter: ['class'] });
          }
        });
      }

      // Debounce helper
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Reset accordion to initial state (for when modal reopens)
      function resetAccordion() {
        _currentSection = 1;
        _sectionCompletion = { 1: false, 2: false, 3: false, 4: false, 5: false, 6: false };

        // Collapse all and expand section 1
        for (let i = 1; i <= ACCORDION_CONFIG.totalSections; i++) {
          const section = document.getElementById('accordionSection' + i);
          if (section) {
            section.classList.remove('expanded', 'complete');
            const statusEl = section.querySelector('.accordion-status');
            if (statusEl) statusEl.textContent = '';
          }
        }

        const firstSection = document.getElementById('accordionSection1');
        if (firstSection) firstSection.classList.add('expanded');

        updateProgressIndicator();
      }

      // Initialize accordion system
      function initAccordion() {
        console.log('[Accordion] Initializing mobile-first accordion system');

        setupCompletionListeners();
        updateProgressIndicator();

        // Check initial completion state after a short delay (for pre-filled data)
        setTimeout(checkAllSections, 500);

        console.log('[Accordion] Accordion system ready');
      }

      // Expose functions globally
      global.toggleAccordion = toggleAccordion;
      global.advanceToSection = advanceToSection;
      global.resetAccordion = resetAccordion;
      global.checkAllSections = checkAllSections;

      // Initialize on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAccordion);
      } else {
        initAccordion();
      }

    })(window);
  </script>

  <!-- OCR Handler Module (compression + auto-fill) - Inlined for Wix compatibility -->
  <script>
    (function (global) {
      'use strict';

      const DEFAULT_CONFIG = {
        compression: { maxWidth: 1200, maxHeight: 1600, quality: 0.85, format: 'image/jpeg' },
        validation: { maxFileSizeMB: 5, supportedTypes: ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'] },
        timing: { ocrTimeoutMs: 30000, successDisplayMs: 2500 },
        ui: {
          processingHtml: '<i class="fa-solid fa-spinner fa-spin"></i> AI extracting data...',
          successHtml: '<i class="fa-solid fa-check-circle" style="color: var(--color-success);"></i> Data extracted!',
          fileTooLargeMsg: 'File too large. Maximum size is {maxSize}MB.',
          unsupportedTypeMsg: 'Unsupported file type. Please upload a JPG, PNG, or PDF.'
        },
        cssClasses: { hasFile: 'has-file', processing: 'ocr-processing', success: 'ocr-success', error: 'error', autoFilled: 'auto-filled' }
      };

      let _config = null, _sendMessage = null, _fileStorage = null, _ocrTimeouts = {}, _initialized = false;

      // ============================================================================
      // OCR QUEUE SYSTEM - Prevents 429 rate limiting by spacing out requests
      // ============================================================================
      const _ocrQueue = [];
      let _ocrProcessing = false;
      const OCR_DELAY_MS = 6000; // 6 seconds between OCR requests (increased due to Gemini rate limits)
      const OCR_PRIORITY = { 'CDL_FRONT': 1, 'CDL_BACK': 3, 'MED_CARD': 2 }; // Lower = higher priority

      function init(options) {
        if (!options || typeof options.sendMessage !== 'function' || typeof options.fileStorage !== 'object' || typeof options.documents !== 'object') {
          console.error('OCRHandler: Invalid configuration'); return false;
        }
        _config = {
          compression: { ...DEFAULT_CONFIG.compression, ...(options.compression || {}) },
          validation: { ...DEFAULT_CONFIG.validation, ...(options.validation || {}) },
          timing: { ...DEFAULT_CONFIG.timing, ...(options.timing || {}) },
          ui: { ...DEFAULT_CONFIG.ui, ...(options.ui || {}) },
          cssClasses: { ...DEFAULT_CONFIG.cssClasses, ...(options.cssClasses || {}) },
          documents: options.documents, formFields: options.formFields || {},
          onExtracted: options.onExtracted || null, onError: options.onError || null, onFileSelected: options.onFileSelected || null
        };
        _sendMessage = options.sendMessage; _fileStorage = options.fileStorage; _initialized = true;
        console.log(' OCR Handler initialized (max ' + _config.compression.maxWidth + 'px, ' + Object.keys(_config.documents).length + ' document types)');
        return true;
      }

      function isInitialized() { return _initialized; }

      function compressImageForOCR(file) {
        return new Promise(function (resolve, reject) {
          if (!_config) { reject(new Error('OCRHandler not initialized')); return; }
          if (file.type === 'application/pdf') {
            if (file.size > 1024 * 1024) console.warn(' PDF file is large, OCR may fail.');
            var reader = new FileReader();
            reader.onload = function () { resolve(reader.result); }; reader.onerror = reject;
            reader.readAsDataURL(file); return;
          }
          var img = new Image(), canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'), c = _config.compression;
          img.onload = function () {
            var w = img.width, h = img.height;
            if (w > c.maxWidth) { h = Math.round(h * (c.maxWidth / w)); w = c.maxWidth; }
            if (h > c.maxHeight) { w = Math.round(w * (c.maxHeight / h)); h = c.maxHeight; }
            canvas.width = w; canvas.height = h;
            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, w, h); ctx.drawImage(img, 0, 0, w, h);
            var compressed = canvas.toDataURL(c.format, c.quality);
            var origKB = Math.round(file.size / 1024), compKB = Math.round((compressed.length * 3) / 4 / 1024);
            console.log(' Image compressed: ' + origKB + 'KB  ' + compKB + 'KB (' + Math.round((1 - compKB / origKB) * 100) + '% reduction)');
            resolve(compressed);
          };
          img.onerror = function () { reject(new Error('Failed to load image')); };
          var reader = new FileReader();
          reader.onload = function (e) { img.src = e.target.result; }; reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function fileToBase64(file) {
        return new Promise(function (resolve, reject) {
          if (!file) { resolve(null); return; }
          var reader = new FileReader();
          reader.onload = function () { resolve(reader.result); }; reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function getDocConfigByInputId(id) { return _config && _config.documents ? _config.documents[id] || null : null; }
      function getInputIdByDocType(type) { if (!_config || !_config.documents) return null; for (var id in _config.documents) { if (_config.documents[id].type === type) return id; } return null; }
      function getElement(id) { return id ? document.getElementById(id) : null; }
      function truncateFilename(name, max) { max = max || 20; if (!name || name.length <= max) return name || ''; return name.substring(0, max - 3) + '...'; }
      function flashField(field) { if (!field) return; field.style.transition = 'background-color 0.3s ease'; field.style.backgroundColor = '#10b98130'; setTimeout(function () { field.style.backgroundColor = ''; }, 1500); }

      function handleFileChange(inputId) {
        if (!_initialized) { console.error('OCRHandler: Not initialized'); return; }
        var docConfig = getDocConfigByInputId(inputId); if (!docConfig) { console.warn('OCRHandler: Unknown input:', inputId); return; }
        var input = getElement(docConfig.input || inputId), box = getElement(docConfig.box), nameEl = getElement(docConfig.nameDisplay);
        if (!input || !input.files || !input.files[0]) return;
        var file = input.files[0], v = _config.validation, cls = _config.cssClasses, ui = _config.ui;
        if (file.size > v.maxFileSizeMB * 1024 * 1024) { alert(ui.fileTooLargeMsg.replace('{maxSize}', v.maxFileSizeMB)); input.value = ''; return; }
        var isValid = v.supportedTypes.indexOf(file.type) !== -1 || file.type.indexOf('image/') === 0;
        if (!isValid) { alert(ui.unsupportedTypeMsg); input.value = ''; return; }
        if (_fileStorage) _fileStorage[inputId] = file;
        if (box) { box.classList.add(cls.hasFile); box.classList.remove(cls.error, cls.success); }
        if (nameEl) nameEl.textContent = truncateFilename(file.name);
        if (_config.onFileSelected) _config.onFileSelected(inputId, file);
        if (docConfig.type) triggerOCR(inputId, file, docConfig, box, nameEl);
      }

      // Queue an OCR request instead of firing immediately
      function queueOCRRequest(inputId, file, docConfig, box, nameEl) {
        var cls = _config.cssClasses, ui = _config.ui;

        // Show processing state immediately
        if (box) box.classList.add(cls.processing);
        if (nameEl) nameEl.innerHTML = ui.processingHtml + ' <span style="font-size:10px;opacity:0.7">(queued)</span>';

        // Compress image first, then add to queue
        compressImageForOCR(file).then(function (compressed) {
          const queueItem = {
            inputId: inputId,
            file: file,
            docConfig: docConfig,
            box: box,
            nameEl: nameEl,
            compressed: compressed,
            priority: OCR_PRIORITY[docConfig.type] || 99,
            addedAt: Date.now()
          };

          // Add to queue and sort by priority
          _ocrQueue.push(queueItem);
          _ocrQueue.sort((a, b) => a.priority - b.priority);

          console.log(` OCR queued: ${docConfig.type} (priority ${queueItem.priority}, queue length: ${_ocrQueue.length})`);

          // Update UI to show queue position
          if (nameEl) {
            const position = _ocrQueue.findIndex(item => item.inputId === inputId) + 1;
            nameEl.innerHTML = ui.processingHtml + ` <span style="font-size:10px;opacity:0.7">(#${position} in queue)</span>`;
          }

          // Start processing if not already running
          processOCRQueue();
        }).catch(function (err) {
          console.error('Error preparing file for OCR:', err);
          if (box) box.classList.remove(cls.processing);
          if (nameEl) nameEl.textContent = truncateFilename(file.name);
          if (_config.onError) _config.onError(docConfig.type, err.message);
        });
      }

      // Process OCR queue with delays between requests
      function processOCRQueue() {
        if (_ocrProcessing || _ocrQueue.length === 0) return;

        _ocrProcessing = true;
        const item = _ocrQueue.shift();
        var cls = _config.cssClasses, ui = _config.ui, timing = _config.timing;

        // Update UI to show active processing
        if (item.nameEl) item.nameEl.innerHTML = ui.processingHtml + ' <span style="font-size:10px;opacity:0.7">(scanning...)</span>';

        console.log(` Processing OCR: ${item.docConfig.type} (${_ocrQueue.length} remaining in queue)`);

        // Send OCR request
        _sendMessage('extractDocumentOCR', {
          base64Data: item.compressed,
          docType: item.docConfig.type,
          inputId: item.inputId
        });

        // Set timeout for this request
        _ocrTimeouts[item.inputId] = setTimeout(function () {
          if (item.box) item.box.classList.remove(cls.processing);
          if (item.nameEl) item.nameEl.textContent = truncateFilename(item.file.name);
          console.warn(' OCR timeout for ' + item.inputId);
          if (_config.onError) _config.onError(item.docConfig.type, 'OCR request timed out');

          // Continue processing queue after timeout
          scheduleNextOCR();
        }, timing.ocrTimeoutMs);
      }

      // Schedule next OCR request with delay
      function scheduleNextOCR() {
        _ocrProcessing = false;
        if (_ocrQueue.length > 0) {
          console.log(` Waiting ${OCR_DELAY_MS}ms before next OCR request...`);
          setTimeout(function () {
            processOCRQueue();
          }, OCR_DELAY_MS);
        }
      }

      // Original triggerOCR now uses the queue
      function triggerOCR(inputId, file, docConfig, box, nameEl) {
        if (_ocrTimeouts[inputId]) clearTimeout(_ocrTimeouts[inputId]);
        queueOCRRequest(inputId, file, docConfig, box, nameEl);
      }

      function handleOCRResult(data) {
        if (!_initialized) { console.error('OCRHandler: Not initialized'); return; }
        console.log(' OCR Result received:', data);
        var inputId = getInputIdByDocType(data.docType); if (!inputId) { console.warn('OCRHandler: Unknown docType:', data.docType); return; }
        var docConfig = getDocConfigByInputId(inputId); if (!docConfig) return;
        if (_ocrTimeouts[inputId]) { clearTimeout(_ocrTimeouts[inputId]); delete _ocrTimeouts[inputId]; }
        var box = getElement(docConfig.box), nameEl = getElement(docConfig.nameDisplay), file = _fileStorage ? _fileStorage[inputId] : null, cls = _config.cssClasses;
        if (box) box.classList.remove(cls.processing);
        if (data.success && data.extracted) {
          if (box) box.classList.add(cls.success);
          if (nameEl) nameEl.innerHTML = _config.ui.successHtml;
          autoFillFormFields(data.docType, data.extracted);
          if (data.confidence) console.log(' OCR Confidence: ' + data.confidence + ' (' + (data.consensusMethod || 'single_pass') + ')');
          if (_config.onExtracted) _config.onExtracted(data.docType, data.extracted, data);
          setTimeout(function () { if (nameEl && file) nameEl.textContent = truncateFilename(file.name); }, _config.timing.successDisplayMs);
        } else {
          if (nameEl && file) nameEl.textContent = truncateFilename(file.name);
          var errMsg = data.error || data.userMessage || 'Unknown error';
          console.warn(' OCR extraction failed:', errMsg);
          if (_config.onError) _config.onError(data.docType, errMsg, data);
        }

        // Continue processing queue after this result
        scheduleNextOCR();
      }

      function autoFillFormFields(docType, ext) {
        if (!_config.formFields || !ext) return;
        var f = _config.formFields, cls = _config.cssClasses;
        if (docType === 'CDL_FRONT' || docType === 'CDL_BACK') {
          if (ext.licenseNumber && f.cdlNumber) { var el = getElement(f.cdlNumber); if (el && !el.value) { el.value = ext.licenseNumber; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.expirationDate && f.cdlExpiration) { var el = getElement(f.cdlExpiration); if (el && !el.value) { el.value = ext.expirationDate; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.state && f.cdlState) { var el = getElement(f.cdlState); if (el && !el.value) { el.value = ext.state; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.cdlClass && f.cdlClass) { var el = getElement(f.cdlClass); if (el && !el.value) { el.value = ext.cdlClass; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.fullName && f.driverName) { var el = getElement(f.driverName); if (el && !el.value) { el.value = ext.fullName; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.dob && f.driverDOB) { var el = getElement(f.driverDOB); if (el && !el.value) { el.value = ext.dob; el.classList.add(cls.autoFilled); flashField(el); } }
          console.log(' CDL data auto-filled:', { licenseNumber: ext.licenseNumber, expiration: ext.expirationDate, state: ext.state, 'class': ext.cdlClass });
        }
        if (docType === 'MED_CARD') {
          if (ext.certificateExpirationDate && f.medCardExpiration) { var el = getElement(f.medCardExpiration); if (el && !el.value) { el.value = ext.certificateExpirationDate; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.examinerName && f.examinerName) { var el = getElement(f.examinerName); if (el && !el.value) { el.value = ext.examinerName; el.classList.add(cls.autoFilled); flashField(el); } }
          if (ext.registryNumber && f.registryNumber) { var el = getElement(f.registryNumber); if (el && !el.value) { el.value = ext.registryNumber; el.classList.add(cls.autoFilled); flashField(el); } }
          console.log(' Med Card data auto-filled:', { expiration: ext.certificateExpirationDate });
        }
      }

      function removeFile(inputId) {
        if (!_initialized) return; var docConfig = getDocConfigByInputId(inputId); if (!docConfig) return;
        var input = getElement(docConfig.input || inputId), box = getElement(docConfig.box), nameEl = getElement(docConfig.nameDisplay), cls = _config.cssClasses;
        if (input) input.value = ''; if (_fileStorage) _fileStorage[inputId] = null;
        if (box) box.classList.remove(cls.hasFile, cls.success, cls.processing); if (nameEl) nameEl.textContent = '';
        if (_ocrTimeouts[inputId]) { clearTimeout(_ocrTimeouts[inputId]); delete _ocrTimeouts[inputId]; }
      }

      function resetFileUploads() { if (!_initialized || !_config.documents) return; Object.keys(_config.documents).forEach(function (id) { removeFile(id); }); }
      function clearOCRTimeouts() { Object.keys(_ocrTimeouts).forEach(function (k) { clearTimeout(_ocrTimeouts[k]); delete _ocrTimeouts[k]; }); }

      function setupFileInputListeners() {
        if (!_initialized || !_config.documents) { console.error('OCRHandler: Cannot setup listeners - not initialized'); return; }
        var count = 0;
        Object.keys(_config.documents).forEach(function (inputId) {
          var docConfig = _config.documents[inputId], input = getElement(docConfig.input || inputId);
          if (input) { input.addEventListener('change', function () { handleFileChange(inputId); }); count++; }
        });
        console.log(' File input listeners attached (' + count + ' inputs)');
      }

      function getConfig() { return _config ? JSON.parse(JSON.stringify(_config)) : null; }
      function updateConfig(u) {
        if (!_initialized) return false;
        if (u.compression) _config.compression = { ..._config.compression, ...u.compression };
        if (u.validation) _config.validation = { ..._config.validation, ...u.validation };
        if (u.timing) _config.timing = { ..._config.timing, ...u.timing };
        if (u.ui) _config.ui = { ..._config.ui, ...u.ui };
        if (u.formFields) _config.formFields = { ..._config.formFields, ...u.formFields };
        if (u.onExtracted) _config.onExtracted = u.onExtracted;
        if (u.onError) _config.onError = u.onError;
        if (u.onFileSelected) _config.onFileSelected = u.onFileSelected;
        return true;
      }

      global.OCRHandler = {
        init: init, isInitialized: isInitialized, handleFileChange: handleFileChange, handleOCRResult: handleOCRResult,
        removeFile: removeFile, resetFileUploads: resetFileUploads, clearOCRTimeouts: clearOCRTimeouts,
        setupFileInputListeners: setupFileInputListeners, fileToBase64: fileToBase64, compressImageForOCR: compressImageForOCR,
        getConfig: getConfig, updateConfig: updateConfig, DEFAULT_CONFIG: DEFAULT_CONFIG
      };
    })(window);
  </script>

  <script>
    // =========================================================================
    // STATE MANAGEMENT
    // =========================================================================
    let currentMatches = [];
    let driverPrefs = {};
    let userStatus = { loggedIn: false, isPremium: false, tier: 'free' };
    let appliedCarrierDOTs = new Set();
    let pendingInterestCarrier = null; // Stores carrier data while waiting for interest confirmation
    let driverProfile = null; // Phase 4H: Store profile for pre-fill

    const formSection = document.getElementById('formSection');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');
    const driverForm = document.getElementById('driverForm');
    const matchesList = document.getElementById('matchesList');
    const totalScoredEl = document.getElementById('totalScored');
    const matchCountEl = document.getElementById('matchCount');
    const resetBtn = document.getElementById('resetBtn');
    const upsellBanner = document.getElementById('upsellBanner');
    const premiumBanner = document.getElementById('premiumBanner');
    const upsellText = document.getElementById('upsellText');
    const hiddenMatchCount = document.getElementById('hiddenMatchCount');
    const userTierBadge = document.getElementById('userTierBadge');

    // =========================================================================
    // FORM SUBMIT HANDLER
    // =========================================================================
    driverForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const customWeights = {
        location: parseInt(document.getElementById('weight-location').value),
        pay: parseInt(document.getElementById('weight-pay').value),
        operationType: parseInt(document.getElementById('weight-operationType').value),
        safety: parseInt(document.getElementById('weight-safety').value),
        turnover: parseInt(document.getElementById('weight-turnover').value),
        truckAge: parseInt(document.getElementById('weight-truckAge').value),
        fleetSize: 5, // Keep small
        qualityScore: 5 // Keep small
      };

      driverPrefs = {
        homeZip: document.getElementById('homeZip').value.trim(),
        maxDistance: parseInt(document.getElementById('maxDistance').value),
        minCPM: parseFloat(document.getElementById('minCPM').value) || 0,
        operationType: document.getElementById('operationType').value,
        maxTurnover: parseInt(document.getElementById('maxTurnover').value),
        maxTruckAge: parseInt(document.getElementById('maxTruckAge').value),
        fleetSize: document.querySelector('input[name="fleetSize"]:checked').value,
        driverName: document.getElementById('driverName').value.trim() || 'Driver',
        customWeights: customWeights
      };

      if (!driverPrefs.homeZip || driverPrefs.homeZip.length < 5) {
        alert('Please enter a valid ZIP code');
        return;
      }

      showLoading();
      sendToWix('findMatches', driverPrefs);
    });

    // =========================================================================
    // ADVANCED UI LOGIC
    // =========================================================================

    // Toggle Priorities
    document.getElementById('togglePriorities').onclick = () => {
      const advanced = document.getElementById('advancedPriorities');
      const isHidden = window.getComputedStyle(advanced).display === 'none';
      advanced.style.display = isHidden ? 'block' : 'none';
      document.getElementById('togglePriorities').classList.toggle('active', isHidden);
    };

    // Weight Labels
    const weightInputs = ['location', 'pay', 'operationType', 'safety', 'turnover', 'truckAge'];
    weightInputs.forEach(id => {
      const input = document.getElementById(`weight-${id}`);
      const valLabel = document.getElementById(`weight-val-${id}`);

      const updateLabel = () => {
        const val = parseInt(input.value);
        let text = 'Normal';
        if (val >= 40) text = 'Critical';
        else if (val >= 30) text = 'High';
        else if (val >= 15) text = 'Standard';
        else if (val >= 5) text = 'Low';
        else text = 'Ignored';
        valLabel.textContent = text;
      };

      input.addEventListener('input', updateLabel);
      updateLabel();
    });

    // Reset Weights
    document.getElementById('resetWeights').onclick = () => {
      const defaults = { location: 25, pay: 20, operationType: 15, safety: 10, turnover: 12, truckAge: 8 };
      Object.entries(defaults).forEach(([id, val]) => {
        const input = document.getElementById(`weight-${id}`);
        input.value = val;
        input.dispatchEvent(new Event('input'));
      });
    };

    // Toggle Rationale (Global for onclick)
    window.toggleRationale = function (dot) {
      const div = document.getElementById(`rationale-${dot}`);
      const btn = document.getElementById(`analysis-btn-${dot}`);
      const isHidden = window.getComputedStyle(div).display === 'none';

      div.style.display = isHidden ? 'block' : 'none';
      btn.classList.toggle('active', isHidden);

      if (isHidden) {
        btn.innerHTML = '<i class="fa-solid fa-chevron-up"></i> Hide Analysis';
        btn.style.background = 'var(--lmdr-dark)';
        btn.style.color = 'white';
      } else {
        btn.innerHTML = '<i class="fa-solid fa-magnifying-glass-chart"></i> Match Analysis';
        btn.style.background = '#f1f5f9';
        btn.style.color = 'var(--lmdr-body)';
      }
    };

    // =========================================================================
    // LOADING ANIMATION
    // =========================================================================
    function showLoading() {
      formSection.style.display = 'none';
      loadingSection.classList.add('active');
      resultsSection.classList.remove('active');

      const steps = ['step1', 'step2', 'step3', 'step4'];
      steps.forEach((id, i) => {
        setTimeout(() => {
          for (let j = 0; j < i; j++) {
            const prev = document.getElementById(steps[j]);
            prev.classList.remove('active');
            prev.classList.add('complete');
            prev.querySelector('i').className = 'fa-solid fa-check';
          }
          const curr = document.getElementById(id);
          curr.classList.add('active');
          curr.querySelector('i').className = 'fa-solid fa-circle-notch fa-spin';
        }, i * 800);
      });
    }

    function hideLoading() {
      loadingSection.classList.remove('active');
    }

    // =========================================================================
    // SHOW RESULTS - PREMIUM TIER AWARE
    // =========================================================================
    function showResults(data) {
      hideLoading();
      resultsSection.classList.add('active');

      currentMatches = data.matches || [];
      totalScoredEl.textContent = data.totalScored || 0;
      matchCountEl.textContent = currentMatches.length;

      // Update tier status from response
      const isPremium = data.isPremium || false;
      userStatus.isPremium = isPremium;
      userStatus.tier = isPremium ? 'premium' : 'free';

      // Update tier badge
      if (userTierBadge) {
        if (isPremium) {
          userTierBadge.innerHTML = '<span class="premium-badge"><i class="fa-solid fa-crown"></i> Premium</span>';
        } else {
          userTierBadge.innerHTML = '<span class="free-badge"><i class="fa-solid fa-user"></i> Free Tier</span>';
        }
      }

      // Show appropriate banner
      if (isPremium) {
        if (upsellBanner) upsellBanner.style.display = 'none';
        if (premiumBanner) premiumBanner.style.display = 'flex';
      } else {
        if (premiumBanner) premiumBanner.style.display = 'none';

        // Show upsell if more matches available
        const totalMatches = data.totalMatches || data.totalScored || 0;
        const hiddenCount = Math.max(0, Math.min(totalMatches - currentMatches.length, 8));

        if (data.upsellMessage || hiddenCount > 0) {
          if (upsellBanner) upsellBanner.style.display = 'flex';
          if (hiddenMatchCount) hiddenMatchCount.textContent = hiddenCount;
          if (upsellText && data.upsellMessage) {
            upsellText.textContent = data.upsellMessage;
          }
        } else {
          if (upsellBanner) upsellBanner.style.display = 'none';
        }
      }

      if (currentMatches.length === 0) {
        matchesList.innerHTML = `
          <div class="no-results">
            <i class="fa-solid fa-truck-ramp-box"></i>
            <h3>No Matches Found</h3>
            <p>Try expanding your search criteriaincrease commute distance or adjust your filters.</p>
         </div>
        `;
        return;
      }

      matchesList.innerHTML = currentMatches.map((match, index) =>
        renderMatchCard(match, index + 1)
      ).join('');

      document.querySelectorAll('.interested-btn').forEach(btn => {
        btn.addEventListener('click', handleInterestClick);
      });

      // Wire up signup/login buttons
      const signupBtn = document.getElementById('signupBtn');
      const loginBtn = document.getElementById('loginBtn');

      if (signupBtn) {
        signupBtn.onclick = () => sendToWix('navigateToSignup', {});
      }
      if (loginBtn) {
        loginBtn.onclick = () => sendToWix('navigateToLogin', {});
      }
    }
    // =========================================================================
    // RENDER MATCH CARD - FMCSA-FIRST ARCHITECTURE
    // =========================================================================
    function renderMatchCard(match, rank) {
      const carrier = match.carrier || {};
      const enrichment = match.enrichment || {};
      const fmcsa = enrichment.fmcsa || match.fmcsa || {};
      const fromCache = match.fromCache;

      const carrierName = carrier.LEGAL_NAME || carrier.DBA_NAME || 'Unknown Carrier';
      const location = `${carrier.PHY_CITY || ''}, ${carrier.PHY_STATE || ''}`.replace(/^, |, $/g, '') || 'Location Unknown';
      const dotNumber = carrier.DOT_NUMBER || 'N/A';
      const payDisplay = carrier.PAY_CPM ? `$${carrier.PAY_CPM.toFixed(2)}` : 'N/A';
      const fleetDisplay = carrier.NBR_POWER_UNIT || 'N/A';
      const turnoverDisplay = carrier.TURNOVER_PERCENT ? `${carrier.TURNOVER_PERCENT.toFixed(0)}%` : 'N/A';
      const truckAgeDisplay = carrier.AVG_TRUCK_AGE ? `${carrier.AVG_TRUCK_AGE.toFixed(1)} yr` : 'N/A';

      const fmcsaHTML = renderFMCSASection(fmcsa, dotNumber);

      let aiIntelHTML = '';
      if (enrichment && !enrichment.error && enrichment.ai_summary) {
        aiIntelHTML = renderAIIntelBlock(enrichment);
      } else if (match.needsEnrichment) {
        aiIntelHTML = `
          <div class="ai-intel-section">
            <div class="ai-intel-loading" id="loading-${dotNumber}">
              <i class="fa-solid fa-robot fa-bounce"></i>
              <div class="ai-intel-loading-text">AI Researching...</div>
              <div class="ai-intel-loading-sub">Searching job boards & driver reviews</div>
              <div class="ai-intel-loading-progress">
                <div class="ai-intel-loading-progress-bar"></div>
             </div>
           </div>
         </div>
        `;
      }

      const tags = [];

      // Add "Applied" tag if driver has already applied
      if (appliedCarrierDOTs.has(String(dotNumber))) {
        tags.push(`<span class="match-tag applied" style="background: #10b98115; color: #10b981; border: 1px solid #10b98130; font-weight: 800;"><i class="fa-solid fa-check-circle"></i> Applied</span>`);
      }

      tags.push(`<span class="match-tag operation">${match.inferredOpType || 'Regional'}</span>`);
      tags.push(`<span class="match-tag fleet">${categorizeFleet(carrier.NBR_POWER_UNIT)}</span>`);
      if (fromCache) {
        tags.push(`<span class="match-tag cached"><i class="fa-solid fa-bolt"></i> Instant</span>`);
      }
      if (carrier.isClient) {
        tags.push(`<span class="match-tag client"><i class="fa-solid fa-star"></i> Partner</span>`);
      }

      // Add Responsiveness Signal
      const stats = match.recruiterStats;
      if (stats && stats.badge) {
        tags.push(`<span class="match-tag" style="background: ${stats.badge_color}15; color: ${stats.badge_color}; border: 1px solid ${stats.badge_color}30; font-weight: 800;"><i class="fa-solid fa-bolt-lightning"></i> ${stats.badge}</span>`);
      }

      return `
        <div class="match-card" data-dot="${dotNumber}">
          
          <div class="match-card-header">
            <div class="match-rank">${rank}</div>
            <div class="match-info">
              <div class="match-name">${escapeHtml(carrierName)}</div>
              <div class="match-location">
                <i class="fa-solid fa-location-dot"></i> ${escapeHtml(location)}
             </div>
              <div class="match-dot-number">DOT: ${dotNumber}</div>
           </div>
            <div class="match-score-block">
              <div class="match-score-value">${match.overallScore || 0}%</div>
              <div class="match-score-label">Match Score</div>
           </div>
         </div>
          
          ${fmcsaHTML}
          
          <div class="carrier-metrics">
            <div class="carrier-metric">
              <div class="carrier-metric-value">${payDisplay}</div>
              <div class="carrier-metric-label">CPM</div>
           </div>
            <div class="carrier-metric">
              <div class="carrier-metric-value">${fleetDisplay}</div>
              <div class="carrier-metric-label">Fleet Size</div>
           </div>
            <div class="carrier-metric">
              <div class="carrier-metric-value">${turnoverDisplay}</div>
              <div class="carrier-metric-label">Turnover</div>
           </div>
            <div class="carrier-metric">
              <div class="carrier-metric-value">${truckAgeDisplay}</div>
              <div class="carrier-metric-label">Truck Age</div>
           </div>
         </div>
          
          <div class="match-tags">
            ${tags.join('')}
         </div>
          
          ${aiIntelHTML}

          ${match.rationale && match.rationale.length > 0 ? `
            <div class="match-rationale" id="rationale-${dotNumber}">
              <div class="rationale-header"><i class="fa-solid fa-list-check"></i> Why this is a match</div>
              <ul class="rationale-list">
                ${match.rationale.map(r => `
                  <li class="rationale-item"><i class="fa-solid fa-check"></i> ${escapeHtml(r)}</li>
                `).join('')}
              </ul>
           </div>
          ` : ''}
          
          <div class="match-actions">
            <button class="${appliedCarrierDOTs.has(String(dotNumber)) ? 'interested-btn applied' : 'interested-btn'}" 
              data-dot="${dotNumber}" 
              data-name="${escapeHtml(carrierName)}"
              data-score="${match.overallScore || 0}"
              onclick="handleInterestClick(event)"
              ${appliedCarrierDOTs.has(String(dotNumber)) ? 'disabled' : ''}>
              <i class="fa-solid ${appliedCarrierDOTs.has(String(dotNumber)) ? 'fa-check' : 'fa-heart'}"></i> 
              ${appliedCarrierDOTs.has(String(dotNumber)) ? 'Application Sent' : "I'm Interested"}
            </button>
            <button class="analysis-btn" id="analysis-btn-${dotNumber}" onclick="toggleRationale('${dotNumber}')">
              <i class="fa-solid fa-magnifying-glass-chart"></i> Match Analysis
            </button>
            <button class="match-btn secondary" 
                    onclick="window.open('https://safer.fmcsa.dot.gov/query.asp?searchtype=ANY&query_type=queryCarrierSnapshot&query_param=USDOT&query_string=${dotNumber}', '_blank')">
              <i class="fa-solid fa-shield-halved"></i> FMCSA
            </button>
         </div>
       </div>
      `;
    }

    // =========================================================================
    // RENDER FMCSA SECTION
    // =========================================================================
    function renderFMCSASection(fmcsa, dotNumber) {
      if (!fmcsa || fmcsa.error) {
        return `
          <div class="fmcsa-section error">
            <div class="fmcsa-header">
              <div class="fmcsa-badge unknown">
                <i class="fa-solid fa-question-circle"></i>
                FMCSA: Verification Pending
             </div>
              <div class="fmcsa-source">
                <a href="https://safer.fmcsa.dot.gov/query.asp?searchtype=ANY&query_type=queryCarrierSnapshot&query_param=USDOT&query_string=${fmcsa?.dot_number || dotNumber}" target="_blank">
                  <i class="fa-solid fa-external-link-alt"></i> Check FMCSA Directly
                </a>
             </div>
           </div>
            <p style="font-size: 13px; color: #92400e; margin: 0;">
              ${fmcsa?.error_message || 'Safety data is being retrieved. Check back shortly or verify directly with FMCSA.'}
            </p>
         </div>
        `;
      }

      const rating = (fmcsa.safety_rating || 'UNKNOWN').toUpperCase();
      let sectionClass = 'unknown';
      let badgeClass = 'unknown';
      let ratingDisplay = 'Not Rated';
      let ratingIcon = 'fa-question-circle';

      if (rating === 'SATISFACTORY') {
        sectionClass = '';
        badgeClass = 'satisfactory';
        ratingDisplay = 'Satisfactory';
        ratingIcon = 'fa-shield-check';
      } else if (rating === 'CONDITIONAL') {
        sectionClass = 'conditional';
        badgeClass = 'conditional';
        ratingDisplay = 'Conditional';
        ratingIcon = 'fa-triangle-exclamation';
      } else if (rating === 'UNSATISFACTORY') {
        sectionClass = 'unsatisfactory';
        badgeClass = 'unsatisfactory';
        ratingDisplay = 'Unsatisfactory';
        ratingIcon = 'fa-times-circle';
      } else if (rating === 'NOT RATED' || rating === 'N') {
        sectionClass = 'not-rated';
        badgeClass = 'not-rated';
        ratingDisplay = 'Not Rated';
        ratingIcon = 'fa-minus-circle';
      }

      const inspections = fmcsa.inspections_24mo || {};
      const driverOOS = inspections.driver_oos_rate;
      const vehicleOOS = inspections.vehicle_oos_rate;
      const nationalDriverOOS = inspections.national_avg_driver_oos || 5.51;
      const nationalVehicleOOS = inspections.national_avg_vehicle_oos || 20.72;
      const totalInspections = inspections.total || 0;

      const crashes = fmcsa.crashes_24mo || {};
      const totalCrashes = crashes.total || 0;
      const fatalCrashes = crashes.fatal || 0;

      const isAuthorized = fmcsa.is_authorized !== false && fmcsa.operating_status !== 'NOT AUTHORIZED';

      const basics = fmcsa.basics || {};
      const alerts = [];
      Object.entries(basics).forEach(([key, value]) => {
        if (value && value.alert) {
          alerts.push(formatBasicName(key));
        }
      });

      const driverOOSClass = driverOOS !== null && driverOOS !== undefined
        ? (driverOOS < nationalDriverOOS ? 'good' : driverOOS > nationalDriverOOS * 1.5 ? 'danger' : 'warning')
        : 'neutral';
      const driverOOSCompare = driverOOS !== null && driverOOS !== undefined
        ? (driverOOS < nationalDriverOOS ? 'better' : 'worse')
        : '';

      const vehicleOOSClass = vehicleOOS !== null && vehicleOOS !== undefined
        ? (vehicleOOS < nationalVehicleOOS ? 'good' : vehicleOOS > nationalVehicleOOS * 1.5 ? 'danger' : 'warning')
        : 'neutral';
      const vehicleOOSCompare = vehicleOOS !== null && vehicleOOS !== undefined
        ? (vehicleOOS < nationalVehicleOOS ? 'better' : 'worse')
        : '';

      const crashClass = totalCrashes === 0 ? 'good' : totalCrashes > 5 ? 'danger' : 'warning';

      return `
        <div class="fmcsa-section ${sectionClass}">
          <div class="fmcsa-header">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
              <div class="fmcsa-badge ${badgeClass}">
                <i class="fa-solid ${ratingIcon}"></i>
                FMCSA: ${ratingDisplay}
             </div>
              ${isAuthorized
          ? `<div class="fmcsa-auth-status authorized"><i class="fa-solid fa-check"></i> Authorized</div>`
          : `<div class="fmcsa-auth-status not-authorized"><i class="fa-solid fa-ban"></i> Not Authorized</div>`
        }
           </div>
            <div class="fmcsa-source">
              <i class="fa-solid fa-check-circle"></i> Federal Safety Data
              <a href="https://safer.fmcsa.dot.gov/query.asp?searchtype=ANY&query_type=queryCarrierSnapshot&query_param=USDOT&query_string=${fmcsa.dot_number || dotNumber}" target="_blank" style="margin-left: 8px;">
                View Full Report
              </a>
           </div>
         </div>
          
          <div class="fmcsa-grid">
            <div class="fmcsa-stat">
              <div class="fmcsa-stat-value ${driverOOSClass}">
                ${driverOOS !== null && driverOOS !== undefined ? driverOOS.toFixed(1) + '%' : 'N/A'}
             </div>
              <div class="fmcsa-stat-label">Driver OOS Rate</div>
              <div class="fmcsa-stat-compare ${driverOOSCompare}">
                ${driverOOS !== null && driverOOS !== undefined
          ? (driverOOS < nationalDriverOOS ? ' Below' : ' Above') + ` ${nationalDriverOOS}% avg`
          : 'Nat\'l avg: ' + nationalDriverOOS + '%'}
             </div>
           </div>
            <div class="fmcsa-stat">
              <div class="fmcsa-stat-value ${vehicleOOSClass}">
                ${vehicleOOS !== null && vehicleOOS !== undefined ? vehicleOOS.toFixed(1) + '%' : 'N/A'}
             </div>
              <div class="fmcsa-stat-label">Vehicle OOS Rate</div>
              <div class="fmcsa-stat-compare ${vehicleOOSCompare}">
                ${vehicleOOS !== null && vehicleOOS !== undefined
          ? (vehicleOOS < nationalVehicleOOS ? ' Below' : ' Above') + ` ${nationalVehicleOOS}% avg`
          : 'Nat\'l avg: ' + nationalVehicleOOS + '%'}
             </div>
           </div>
            <div class="fmcsa-stat">
              <div class="fmcsa-stat-value ${crashClass}">
                ${totalCrashes}
             </div>
              <div class="fmcsa-stat-label">Crashes (24mo)</div>
              <div class="fmcsa-stat-compare">
                ${fatalCrashes > 0 ? `<span style="color: var(--color-danger);">${fatalCrashes} fatal</span>` : 'No fatalities'}
             </div>
           </div>
            <div class="fmcsa-stat">
              <div class="fmcsa-stat-value neutral">${totalInspections || 'N/A'}</div>
              <div class="fmcsa-stat-label">Inspections</div>
              <div class="fmcsa-stat-compare">Last 24 months</div>
           </div>
         </div>
          
          ${alerts.length > 0 ? `
            <div class="basic-alerts">
              <div class="basic-alerts-title">
                <i class="fa-solid fa-triangle-exclamation"></i> BASIC Score Alerts
             </div>
              ${alerts.map(a => `
                <div class="basic-alert-item">
                  <i class="fa-solid fa-exclamation-circle"></i> ${a}
               </div>
              `).join('')}
           </div>
          ` : ''}
          
          ${fmcsa.fromCache ? `
            <div style="margin-top: 12px; font-size: 11px; color: #94a3b8;">
              <i class="fa-solid fa-clock"></i> Data cached ${fmcsa.cache_age_days ? fmcsa.cache_age_days + ' days ago' : 'recently'}
           </div>
          ` : ''}
       </div>
      `;
    }

    function formatBasicName(key) {
      const names = {
        'unsafe_driving': 'Unsafe Driving',
        'hours_of_service': 'Hours of Service',
        'driver_fitness': 'Driver Fitness',
        'drugs_alcohol': 'Controlled Substances/Alcohol',
        'vehicle_maintenance': 'Vehicle Maintenance',
        'hazmat': 'Hazardous Materials',
        'crash_indicator': 'Crash Indicator'
      };
      return names[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // =========================================================================
    // RENDER AI INTEL BLOCK - WITH PARTIAL STATE SUPPORT
    // =========================================================================
    function renderAIIntelBlock(data) {
      const confidence = data.data_confidence || 'Low';
      const confidenceClass = confidence.toLowerCase();
      const isLowConfidence = confidence === 'Low' || confidence === 'None';

      const pros = safeJsonParse(data.sentiment_pros);
      const cons = safeJsonParse(data.sentiment_cons);
      const sources = safeJsonParse(data.sources_found);

      const hasPayData = checkValidData(data.pay_cpm_range);
      const hasSignOnBonus = checkValidData(data.sign_on_bonus);
      const hasAnyIntel = hasPayData || checkValidData(data.freight_types) || checkValidData(data.home_time);

      // Use partial styling for low confidence
      const containerClass = isLowConfidence && hasAnyIntel ? 'ai-intel-partial' : 'ai-intel-content';

      return `
        <div class="ai-intel-section">
          <div class="${containerClass}">
            <div class="ai-intel-header">
              <span class="ai-intel-title">
                <i class="fa-solid fa-brain"></i> AI Market Intel
              </span>
              <span class="confidence-pill ${confidenceClass}">${confidence} Confidence</span>
           </div>
            
            ${isLowConfidence ? `
              <div class="ai-intel-partial-notice">
                <i class="fa-solid fa-info-circle"></i>
                Limited data available. Some details inferred from industry standards.
             </div>
            ` : ''}

            <div class="ai-intel-body">
              
              ${hasPayData ? `
                <div class="pay-highlight-box">
                  <div class="pay-highlight-icon"><i class="fa-solid fa-dollar-sign"></i></div>
                  <div>
                    <div class="pay-highlight-value">${escapeHtml(data.pay_cpm_range)}</div>
                    <div class="pay-highlight-bonus">
                      ${hasSignOnBonus ? 'Sign-on: ' + escapeHtml(data.sign_on_bonus) : 'Based on 2025 market data'}
                   </div>
                 </div>
               </div>
              ` : ''}
              
              <div class="ai-intel-grid">
                ${renderIntelItem('Freight', data.freight_types, isLowConfidence)}
                ${renderIntelItem('Routes', data.route_types, isLowConfidence)}
                ${renderIntelItem('Home Time', data.home_time, isLowConfidence)}
                ${renderIntelItem('Benefits', data.benefits, isLowConfidence)}
                ${renderIntelItem('Hiring Status', data.hiring_status, false)}
                ${renderIntelItem('Driver Sentiment', data.driver_sentiment, false)}
             </div>
              
              ${(pros.length > 0 || cons.length > 0) ? `
                <div class="sentiment-row">
                  <div class="sentiment-title"><i class="fa-solid fa-comments"></i> Driver Consensus</div>
                  <div class="sentiment-pills">
                    ${pros.slice(0, 3).map(p => `<span class="sentiment-pill pro"><i class="fa-solid fa-thumbs-up"></i> ${escapeHtml(p)}</span>`).join('')}
                    ${cons.slice(0, 3).map(c => `<span class="sentiment-pill con"><i class="fa-solid fa-thumbs-down"></i> ${escapeHtml(c)}</span>`).join('')}
                 </div>
               </div>
              ` : ''}
              
              ${data.ai_summary ? `<div class="ai-summary">${escapeHtml(data.ai_summary)}</div>` : ''}
              
              ${sources.length > 0 ? `
                <div class="ai-sources-container">
                  <div class="ai-sources-label"><i class="fa-solid fa-link"></i> Sources</div>
                  <div class="ai-sources-list">
                    ${sources.map(src => {
        const domain = extractDomain(src);
        const isUrl = src.startsWith('http');
        return isUrl
          ? `<a href="${src}" target="_blank" class="source-badge">
                             <i class="fa-solid fa-arrow-up-right-from-square"></i> ${domain}
                           </a>`
          : `<span class="source-text-only">${escapeHtml(src)}</span>`;
      }).join('')}
                 </div>
               </div>
              ` : ''}

           </div>
         </div>
       </div>
      `;
    }

    // =========================================================================
    // RENDER ERROR STATE - IMPROVED WITH FALLBACK INFO
    // =========================================================================
    function renderErrorState(data, dotNumber, carrier) {
      return `
        <div class="ai-intel-partial error">
          <i class="fa-solid fa-triangle-exclamation"></i>
          AI Research is currently building a fresh profile for <strong>${carrier.LEGAL_NAME || 'this carrier'}</strong>. 
          Please check back in a few minutes.
       </div>
      `;
    }

    // =========================================================================
    // UPDATE ENRICHMENT (Real-time updates from backend)
    // =========================================================================
    function updateCardEnrichment(data) {
      const dotNumber = data.dot_number;
      const card = document.querySelector(`[data-dot="${dotNumber}"]`);
      if (!card) {
        console.log('Card not found for DOT:', dotNumber);
        return;
      }

      // Find the matching carrier data
      const matchData = currentMatches.find(m => String(m.carrier?.DOT_NUMBER) === String(dotNumber));
      const carrier = matchData?.carrier || {};

      let container = card.querySelector('.ai-intel-section');
      if (!container) {
        const actionsDiv = card.querySelector('.match-actions');
        if (actionsDiv) {
          container = document.createElement('div');
          container.className = 'ai-intel-section';
          actionsDiv.parentNode.insertBefore(container, actionsDiv);
        }
      }

      if (!container) return;

      // Handle loading state
      if (data.status === 'loading') {
        container.innerHTML = `
          <div class="ai-intel-loading">
            <i class="fa-solid fa-robot fa-bounce"></i>
            <div class="ai-intel-loading-text">${data.message || 'AI Researching...'}</div>
            <div class="ai-intel-loading-sub">
              ${data.position ? `Carrier ${data.position} of ${data.total}` : 'Searching job boards & reviews...'}
           </div>
            <div class="ai-intel-loading-progress">
              <div class="ai-intel-loading-progress-bar"></div>
           </div>
         </div>
        `;
        return;
      }

      // Handle error state - use improved error renderer
      if (data.error || data.status === 'error') {
        container.innerHTML = renderErrorState(data, dotNumber, carrier).replace('<div class="ai-intel-section">', '').replace('</div><!-- end -->', '');
        return;
      }

      // Update FMCSA section if present in the enrichment
      if (data.fmcsa && !data.fmcsa.error) {
        const fmcsaContainer = card.querySelector('.fmcsa-section');
        if (fmcsaContainer) {
          const newFmcsaHTML = renderFMCSASection(data.fmcsa, dotNumber);
          const temp = document.createElement('div');
          temp.innerHTML = newFmcsaHTML;
          const newSection = temp.querySelector('.fmcsa-section');
          if (newSection) {
            fmcsaContainer.outerHTML = newSection.outerHTML;
          }
        }
      }

      // Success - render full AI intel
      const aiIntelHTML = renderAIIntelBlock(data);
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = aiIntelHTML;
      const innerContent = tempDiv.querySelector('.ai-intel-content, .ai-intel-partial');

      if (innerContent) {
        container.innerHTML = innerContent.outerHTML;
      } else {
        container.innerHTML = aiIntelHTML;
      }
    }

    // =========================================================================
    // HELPER UTILITIES
    // =========================================================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function categorizeFleet(units) {
      if (!units) return 'Unknown';
      if (units < 50) return 'Small Fleet';
      if (units < 500) return 'Mid-Size';
      return 'Large Fleet';
    }

    function extractDomain(url) {
      if (!url || !url.startsWith('http')) return url;
      try {
        const hostname = new URL(url).hostname;
        return hostname.replace('www.', '');
      } catch (e) {
        return 'External Source';
      }
    }

    function safeJsonParse(val) {
      if (Array.isArray(val)) return val;
      if (typeof val === 'string') {
        try { return JSON.parse(val); } catch (e) { return []; }
      }
      return [];
    }

    function checkValidData(val) {
      if (!val) return false;
      const invalid = ['not found', 'n/a', 'none found', 'contact carrier', 'unknown', 'market rate'];
      return !invalid.includes(val.toLowerCase());
    }

    function renderIntelItem(label, value) {
      if (!value) return '';
      const isGeneric = !checkValidData(value);

      // Don't show items that are clearly just placeholders
      if (isGeneric && ['Contact Carrier', 'Unknown', 'N/A'].includes(value)) {
        return '';
      }

      return `
        <div class="ai-intel-item">
          <strong>${label}</strong>
          <span>${escapeHtml(value)}</span>
       </div>
        `;
    }

    function handleInterestClick(e) {
      const btn = e.currentTarget;
      const dotNumber = btn.dataset.dot;

      // Find full carrier data from currentMatches
      const matchData = currentMatches.find(m => String(m.carrier?.DOT_NUMBER) === String(dotNumber));
      const carrier = matchData?.carrier || {};

      // Store carrier data for modal
      pendingInterestCarrier = {
        dotNumber: dotNumber,
        name: btn.dataset.name || carrier.LEGAL_NAME || 'Unknown Carrier',
        phone: carrier.TELEPHONE || null,
        email: carrier.EMAIL_ADDRESS || null,
        location: `${carrier.PHY_CITY || ''}, ${carrier.PHY_STATE || ''} `.replace(/^, |, $/g, ''),
        matchScore: parseInt(btn.dataset.score) || 0
      };

      sendToWix('logInterest', {
        carrierDOT: dotNumber,
        carrierName: pendingInterestCarrier.name,
        driverZip: driverPrefs.homeZip,
        driverName: driverPrefs.driverName,
        matchScore: pendingInterestCarrier.matchScore,
        action: 'interested'
      });

      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
      btn.disabled = true;
    }

    window.retryEnrichment = function (dot) {
      sendToWix('retryEnrichment', { dot: dot });
      const card = document.querySelector(`[data-dot="${dot}"]`);
      if (card) {
        const container = card.querySelector('.ai-intel-section');
        if (container) {
          container.innerHTML = `
        <div class="ai-intel-loading">
              <i class="fa-solid fa-rotate-right fa-spin"></i>
              <div class="ai-intel-loading-text">Retrying...</div>
              <div class="ai-intel-loading-progress">
                <div class="ai-intel-loading-progress-bar"></div>
             </div>
           </div>
        `;
        }
      }
    };

    window.toggleRationale = function (dot) {
      const rationaleId = `rationale-${dot}`;
      const el = document.getElementById(rationaleId);
      const btn = document.getElementById(`analysis-btn-${dot}`);
      if (!el || !btn) return;

      const isHidden = window.getComputedStyle(el).display === 'none';

      if (isHidden) {
        el.style.display = 'block';
        btn.classList.add('active');
        btn.innerHTML = '<i class="fa-solid fa-chevron-up"></i> Hide Analysis';
      } else {
        el.style.display = 'none';
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fa-solid fa-magnifying-glass-chart"></i> Match Analysis';
      }
    };


    // =========================================================================
    // PREMIUM TIER HANDLERS
    // =========================================================================
    // =========================================================================
    // PREMIUM TIER & PROFILE HANDLERS
    // =========================================================================
    function handlePageReady(data) {
      console.log(' Page ready with user status:', data.userStatus);

      if (data.userStatus) {
        userStatus = data.userStatus;
        updateUserUIState();
      }

      if (data.driverProfile) {
        prefillForm(data.driverProfile);
      }
    }

    function handleLoginSuccess(data) {
      console.log(' Login success:', data);
      userStatus = data.userStatus || { loggedIn: true, isPremium: true, tier: 'premium' };

      updateUserUIState();

      if (data.driverProfile) {
        prefillForm(data.driverProfile);
      }

      // Notify user
      const name = data.driverProfile?.displayName || '';
      const welcome = name ? `, ${name} ` : '';
      alert(`Welcome back${welcome} !You now have Premium access.Click "Find My Matches" to see all 10 results.`);
    }

    function updateUserUIState() {
      // Update form badge for premium users
      const formBadge = document.querySelector('.form-badge');
      if (formBadge && userStatus.isPremium) {
        formBadge.innerHTML = '<i class="fa-solid fa-crown"></i> Premium Member  FMCSA Verified';
        formBadge.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
        formBadge.style.color = '#0f172a';
      }

      // Set body class for CSS targeting
      if (userStatus.loggedIn) {
        document.body.classList.add('user-logged-in');
      } else {
        document.body.classList.remove('user-logged-in');
      }
    }

    function prefillForm(profile, isAI = false) {
      console.log(' Pre-filling form with ' + (isAI ? 'AI' : 'profile') + ' data');

      // Store globally for application pre-fill (Phase 4H)
      if (!isAI) driverProfile = profile;

      if (profile.homeZip) {
        const el = document.getElementById('homeZip');
        el.value = profile.homeZip;
        if (isAI) highlightField(el);
      }
      if (profile.maxDistance) {
        const el = document.getElementById('maxDistance');
        el.value = profile.maxDistance;
        if (isAI) highlightField(el);
      }
      if (profile.minCPM) {
        const el = document.getElementById('minCPM');
        el.value = profile.minCPM;
        if (isAI) highlightField(el);
      }
      if (profile.operationType) {
        const el = document.getElementById('operationType');
        el.value = profile.operationType;
        if (isAI) highlightField(el);
      }
      if (profile.maxTurnover) {
        const el = document.getElementById('maxTurnover');
        el.value = profile.maxTurnover;
        if (isAI) highlightField(el);
      }
      if (profile.maxTruckAge) {
        const el = document.getElementById('maxTruckAge');
        el.value = profile.maxTruckAge;
        if (isAI) highlightField(el);
      }
      if (profile.displayName || profile.driverName) {
        const el = document.getElementById('driverName');
        el.value = profile.displayName || profile.driverName;
        if (isAI) highlightField(el);
      }

      if (profile.fleetSize) {
        const radio = document.querySelector(`input[name="fleetSize"][value="${profile.fleetSize}"]`);
        if (radio) {
          radio.checked = true;
          if (isAI) highlightField(radio.parentElement);
        }
      }

      // Update header if name is present
      const name = profile.displayName || profile.driverName;
      if (name) {
        const title = document.querySelector('.form-title');
        if (title) title.innerText = (isAI ? `Okay, ${name}` : `Welcome Back, ${name}`);

        const subtitle = document.querySelector('.form-subtitle');
        if (subtitle) subtitle.innerText = isAI ? "I've adjusted your filters based on your request." : "We've loaded your preferences for a quick match.";
      }

      // Auto-trigger search if the profile is complete (Phase 2 Requirement)
      if (profile.isComplete === true) {
        console.log(' Profile is complete - auto-triggering search');
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          setTimeout(() => submitBtn.click(), 500);
        }
      }
    }

    function highlightField(el) {
      if (!el) return;
      el.classList.add('highlight-pulse');
      setTimeout(() => el.classList.remove('highlight-pulse'), 2000);
    }

    resetBtn.addEventListener('click', () => {
      resultsSection.classList.remove('active');
      formSection.style.display = 'block';
      driverForm.reset();
      document.getElementById('fleetAny').checked = true;
      if (upsellBanner) upsellBanner.style.display = 'none';
      if (premiumBanner) premiumBanner.style.display = 'none';
      currentMatches = [];
    });

    // =========================================================================
    // MESSAGE VALIDATION SYSTEM
    // =========================================================================
    const DEBUG_MESSAGES = true; // Set to false in production

    // Registry of all valid messages - single source of truth
    const MESSAGE_REGISTRY = {
      // Messages FROM Velo that HTML handles
      inbound: [
        'pageReady',
        'matchResults',
        'matchError',
        'enrichmentUpdate',
        'enrichmentComplete',
        'interestLogged',
        'userStatusUpdate',
        'loginSuccess',
        'loginCancelled',
        'applicationSubmitted',
        'driverProfileLoaded',
        'savedCarriersLoaded',
        'discoverabilityUpdated',
        'pong' // Health check response
      ],
      // Messages TO Velo that HTML sends
      outbound: [
        'carrierMatchingReady',
        'findMatches',
        'logInterest',
        'retryEnrichment',
        'navigateToSignup',
        'navigateToLogin',
        'checkUserStatus',
        'getDriverProfile',
        'navigateToSavedCarriers',
        'submitApplication',
        'logFeatureInteraction', // Feature adoption tracking
        'ping' // Health check
      ]
    };

    // =========================================================================
    // SECURITY HARDENING UTILITIES
    // =========================================================================

    // Origin validation - verifies message comes from trusted parent frame
    function isValidOrigin(event) {
      // In Wix HTML components, messages from Velo come from parent frame
      // We verify we're in an iframe and the source is our parent
      if (window.parent === window) {
        console.warn(' SECURITY: Not running in iframe context');
        return false;
      }
      if (event.source !== window.parent) {
        console.warn(' SECURITY: Message not from parent frame');
        return false;
      }
      return true;
    }

    // Schema validation - ensures message has required structure
    function validateMessageSchema(msg) {
      if (!msg || typeof msg !== 'object') return false;
      if (typeof msg.type !== 'string' || msg.type.length === 0) return false;
      // data can be undefined, null, or object - all valid
      if (msg.data !== undefined && msg.data !== null && typeof msg.data !== 'object') return false;
      return true;
    }

    // HTML sanitization - strips dangerous content from user-generated strings
    function stripHtml(str) {
      if (typeof str !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Safe text content setter - use instead of innerHTML for user content
    function safeSetText(element, text) {
      if (element) element.textContent = text;
    }

    function validateInboundMessage(type) {
      if (!MESSAGE_REGISTRY.inbound.includes(type)) {
        console.warn(` UNREGISTERED INBOUND MESSAGE: "${type}" - Add to MESSAGE_REGISTRY.inbound`);
        return false;
      }
      return true;
    }

    function logMessageFlow(direction, type, data) {
      if (!DEBUG_MESSAGES) return;
      const arrow = direction === 'in' ? '' : '';
      const label = direction === 'in' ? 'VeloHTML' : 'HTMLVelo';
      console.log(`${arrow} [${label}] ${type}`, data ? Object.keys(data) : '(no data)');
    }

    function sendToWix(action, data) {
      // Validate outbound message
      if (!MESSAGE_REGISTRY.outbound.includes(action)) {
        console.warn(` UNREGISTERED OUTBOUND MESSAGE: "${action}" - Add to MESSAGE_REGISTRY.outbound`);
      }
      logMessageFlow('out', action, data);

      if (window.parent) {
        window.parent.postMessage({
          type: 'carrierMatching',
          action: action,
          data: data
        }, '*');
      }
    }

    // Health check - verify communication with Velo
    let connectionVerified = false;
    function verifyConnection() {
      if (connectionVerified) return;
      sendToWix('ping', { timestamp: Date.now() });
      setTimeout(() => {
        if (!connectionVerified) {
          console.warn(' CONNECTION CHECK: No pong received from Velo within 3s');
        }
      }, 3000);
    }

    // =========================================================================
    // MESSAGE LISTENER - ENHANCED FOR PREMIUM (HARDENED)
    // =========================================================================
    window.addEventListener('message', (event) => {
      // SECURITY: Validate origin - must come from parent frame
      if (!isValidOrigin(event)) return;

      const msg = event.data;

      // SECURITY: Validate message schema
      if (!validateMessageSchema(msg)) return;

      // Validate and log inbound message
      validateInboundMessage(msg.type);
      logMessageFlow('in', msg.type, msg.data);

      switch (msg.type) {
        case 'matchResults':
          showResults(msg.data);
          break;

        case 'enrichmentUpdate':
          updateCardEnrichment(msg.data);
          break;

        case 'enrichmentComplete':
          console.log(' All enrichments complete:', msg.data);
          break;

        case 'interestLogged':
          console.log(' Interest response for:', msg.data?.carrierDOT, 'success:', msg.data?.success);
          if (msg.data?.carrierDOT) {
            const card = document.querySelector(`.match-card[data-dot="${msg.data.carrierDOT}"]`);
            const btn = card?.querySelector('.interested-btn, [disabled]');

            if (msg.data.success) {
              // SUCCESS - Add to applied set and update UI
              appliedCarrierDOTs.add(String(msg.data.carrierDOT));

              // Update the button in the UI
              if (btn) {
                btn.classList.remove('primary', 'interested-btn');
                btn.classList.add('applied-btn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Interest Saved';
              }
              // Add the applied tag if not present
              const tagsContainer = card?.querySelector('.match-tags');
              if (tagsContainer && !tagsContainer.querySelector('.match-tag.applied')) {
                tagsContainer.insertAdjacentHTML('afterbegin',
                  '<span class="match-tag applied"><i class="fa-solid fa-check-circle"></i> Applied</span>');
              }

              // Show the confirmation modal
              showInterestModal(pendingInterestCarrier);
            } else {
              // FAILURE - Reset button state and show error
              console.error(' Interest save failed:', msg.data.error);
              if (btn) {
                btn.classList.remove('applied-btn');
                btn.classList.add('primary', 'interested-btn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-heart"></i> I\'M INTERESTED';
              }
              // Show a toast/alert for the error
              alert('Could not save interest: ' + (msg.data.error || 'Please try again'));
            }
          }
          break;

        case 'matchError':
          hideLoading();
          alert('Error finding matches: ' + (msg.data?.error || 'Unknown error'));
          formSection.style.display = 'block';
          break;

        case 'pageReady':
          console.log(' Page code ready - initial state received');
          userStatus = msg.data.userStatus || userStatus;

          // Initialize feature tracker
          if (msg.data.memberId && typeof FeatureTracker !== 'undefined' && !FeatureTracker.isInitialized()) {
            FeatureTracker.init({ userId: msg.data.memberId, userRole: 'driver' });
            FeatureTracker.view('ai_matching', { entryPoint: 'page_load' });
          }

          // Populate applied DOTs
          if (msg.data.appliedCarriers) {
            appliedCarrierDOTs.clear();
            msg.data.appliedCarriers.forEach(c => {
              if (c.carrierDOT) appliedCarrierDOTs.add(String(c.carrierDOT));
            });
            console.log(' Applied carriers loaded:', appliedCarrierDOTs.size);
          }
          break;

        case 'userStatusUpdate':
          userStatus = msg.data;
          console.log('User status updated:', userStatus);
          break;

        case 'loginSuccess':
          handleLoginSuccess(msg.data);
          break;

        case 'loginCancelled':
          console.log('Login cancelled by user');
          break;

        case 'applicationSubmitted':
          handleApplicationSubmitted(msg.data);
          break;

        // Health check response
        case 'pong':
          connectionVerified = true;
          console.log(' CONNECTION VERIFIED: VeloHTML bridge operational', msg.data);
          break;

        // Profile-related messages
        case 'driverProfileLoaded':
          console.log(' Driver profile loaded:', msg.data?.success ? 'success' : 'failed');
          if (msg.data?.success && msg.data?.profile) {
            prefillForm(msg.data.profile);
          }
          break;

        case 'savedCarriersLoaded':
          console.log(' Saved carriers loaded:', msg.data?.totalCount || 0);
          // Future: populate saved carriers list
          break;

        case 'discoverabilityUpdated':
          console.log(' Discoverability updated:', msg.data?.isDiscoverable);
          // Future: update UI toggle state
          break;

        // Real-time OCR result for form auto-fill
        case 'ocrResult':
          handleOCRResult(msg.data);
          break;

        default:
          console.warn(' Unhandled message type:', msg.type);
      }
    });

    // =========================================================================
    // INTEREST CONFIRMATION MODAL
    // =========================================================================
    const interestModal = document.getElementById('interestModal');
    const modalApplyBtn = document.getElementById('modalApplyBtn');
    const modalDashboardBtn = document.getElementById('modalDashboardBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    function showInterestModal(carrierData) {
      if (!carrierData) return;
      if (typeof FeatureTracker !== 'undefined') FeatureTracker.view('matching_carrier_interest', { carrierName: carrierData.name, dotNumber: carrierData.dotNumber });

      // Populate modal with carrier data
      document.getElementById('modalCarrierName').textContent = carrierData.name;
      document.getElementById('modalCarrierFullName').textContent = carrierData.name;
      document.getElementById('modalCarrierDOT').textContent = carrierData.dotNumber;

      // Handle phone
      const phoneRow = document.getElementById('modalPhoneRow');
      const phoneLink = document.getElementById('modalCarrierPhone');
      if (carrierData.phone) {
        phoneRow.style.display = 'flex';
        phoneLink.href = `tel:${carrierData.phone}`;
        phoneLink.textContent = carrierData.phone;
      } else {
        phoneRow.style.display = 'none';
      }

      // Handle email
      const emailRow = document.getElementById('modalEmailRow');
      const emailLink = document.getElementById('modalCarrierEmail');
      if (carrierData.email) {
        emailRow.style.display = 'flex';
        emailLink.href = `mailto:${carrierData.email}`;
        emailLink.textContent = carrierData.email;
      } else {
        emailRow.style.display = 'none';
      }

      // Show modal
      interestModal.style.display = 'flex';
    }

    function hideInterestModal() {
      interestModal.style.display = 'none';
      pendingInterestCarrier = null;
    }

    // Modal button handlers
    if (modalApplyBtn) {
      modalApplyBtn.addEventListener('click', () => {
        // Open the application form modal
        showApplicationModal(pendingInterestCarrier);
        hideInterestModal();
      });
    }

    if (modalDashboardBtn) {
      modalDashboardBtn.addEventListener('click', () => {
        // TODO: Phase 4D - Navigate to dashboard
        sendToWix('navigateToSavedCarriers', {});
        hideInterestModal();
      });
    }

    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', hideInterestModal);
    }

    // Close modal when clicking outside
    if (interestModal) {
      interestModal.addEventListener('click', (e) => {
        if (e.target === interestModal) {
          hideInterestModal();
        }
      });
    }

    // =========================================================================
    // APPLICATION FORM MODAL
    // =========================================================================
    const applicationModal = document.getElementById('applicationModal');
    const applicationForm = document.getElementById('applicationForm');
    const applicationFormContent = document.getElementById('applicationFormContent');
    const applicationFormLoading = document.getElementById('applicationFormLoading');
    const applicationFormSuccess = document.getElementById('applicationFormSuccess');
    const appCancelBtn = document.getElementById('appCancelBtn');
    const appSubmitBtn = document.getElementById('appSubmitBtn');
    const appSuccessCloseBtn = document.getElementById('appSuccessCloseBtn');

    let currentApplicationCarrier = null;

    // OCR animation timeouts (global so they can be cleared on response)
    let appOcrTimeout = null;
    let appProfileTimeout = null;

    // File upload storage
    let uploadedFiles = {
      cdlFront: null,
      cdlBack: null,
      medCard: null,
      resume: null
    };

    // =========================================================================
    // OCR HANDLER INITIALIZATION - Fully Configurable
    // =========================================================================

    // Initialize OCR Handler with full configuration
    if (window.OCRHandler) {
      window.OCRHandler.init({
        // Required: message sending function
        sendMessage: sendToWix,

        // Required: file storage object
        fileStorage: uploadedFiles,

        // Required: document type configurations
        documents: {
          cdlFront: {
            type: 'CDL_FRONT',
            input: 'cdlFront',
            box: 'cdlFrontBox',
            nameDisplay: 'cdlFrontName'
          },
          cdlBack: {
            type: 'CDL_BACK',
            input: 'cdlBack',
            box: 'cdlBackBox',
            nameDisplay: 'cdlBackName'
          },
          medCard: {
            type: 'MED_CARD',
            input: 'medCard',
            box: 'medCardBox',
            nameDisplay: 'medCardName'
          }
        },

        // Optional: form field mappings for auto-fill
        formFields: {
          cdlNumber: 'cdlNumber',
          cdlExpiration: 'cdlExpiration',
          medCardExpiration: 'medCardExpiration'
        },

        // Optional: callback when OCR data is extracted
        onExtracted: (docType, extracted, fullResult) => {
          // Store additional data globally for profile use
          if (docType === 'CDL_FRONT' || docType === 'CDL_BACK') {
            if (extracted.fullName) window.extractedDriverName = extracted.fullName;
            if (extracted.cdlClass) window.extractedCdlClass = extracted.cdlClass;
            if (extracted.endorsements) window.extractedEndorsements = extracted.endorsements;
            if (extracted.state) window.extractedCdlState = extracted.state;
            if (extracted.dob) window.extractedDriverDOB = extracted.dob;
            // Store restrictions - "NONE" means no restrictions (favorable), empty/undefined means unknown
            window.extractedRestrictions = extracted.restrictionsString || 'NONE';
            console.log(' Restrictions captured from OCR:', window.extractedRestrictions);

            // Auto-fill new form fields from OCR
            // Parse fullName - CDLs use "LAST FIRST MIDDLE" format (last name first)
            if (extracted.fullName) {
              const fullName = extracted.fullName.trim();
              const firstNameField = document.getElementById('appFirstName');
              const lastNameField = document.getElementById('appLastName');
              let firstName = '', lastName = '';

              if (fullName.includes(',')) {
                // Format: "LAST, FIRST MIDDLE" (comma-separated)
                const [lastPart, firstPart] = fullName.split(',').map(s => s.trim());
                lastName = lastPart;
                // First part may be "FIRST MIDDLE" - take first word as first name
                const firstWords = firstPart.split(/\s+/);
                firstName = firstWords[0] || '';
                console.log(' Parsed name (comma format):', { lastName, firstName, raw: fullName });
              } else {
                // Format: "LAST FIRST MIDDLE" (space-separated, CDL standard - last name first!)
                const nameParts = fullName.split(/\s+/);
                if (nameParts.length >= 2) {
                  // CDL format: LAST FIRST MIDDLE
                  lastName = nameParts[0];        // First word = LAST name
                  firstName = nameParts[1];       // Second word = FIRST name
                  // nameParts[2+] would be middle name(s) - we don't capture those
                } else {
                  // Only one name - assume it's the last name
                  lastName = nameParts[0] || '';
                }
                console.log(' Parsed name (CDL space format):', { lastName, firstName, raw: fullName });
              }

              // Capitalize properly (GEORGE -> George)
              const capitalize = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
              firstName = capitalize(firstName);
              lastName = capitalize(lastName);

              if (firstNameField && !firstNameField.value && firstName) {
                firstNameField.value = firstName;
                firstNameField.style.backgroundColor = '#10b98120';
                setTimeout(() => firstNameField.style.backgroundColor = '', 1500);
              }
              if (lastNameField && !lastNameField.value && lastName) {
                lastNameField.value = lastName;
                lastNameField.style.backgroundColor = '#10b98120';
                setTimeout(() => lastNameField.style.backgroundColor = '', 1500);
              }
              console.log(' Name auto-filled:', { firstName, lastName });
            }

            // Auto-fill city/state/zip from OCR (if extracted from CDL address)
            if (extracted.city) {
              const cityField = document.getElementById('appCity');
              if (cityField && !cityField.value) {
                cityField.value = extracted.city;
                cityField.style.backgroundColor = '#10b98120';
                setTimeout(() => cityField.style.backgroundColor = '', 1500);
                console.log(' City auto-filled:', extracted.city);
              }
            }
            if (extracted.zip) {
              const zipField = document.getElementById('appZip');
              if (zipField && !zipField.value) {
                zipField.value = extracted.zip;
                zipField.style.backgroundColor = '#10b98120';
                setTimeout(() => zipField.style.backgroundColor = '', 1500);
                console.log(' ZIP auto-filled:', extracted.zip);
              }
            }
            if (extracted.state && !document.getElementById('appState').value) {
              const stateField = document.getElementById('appState');
              if (stateField) {
                stateField.value = extracted.state;
                stateField.style.backgroundColor = '#10b98120';
                setTimeout(() => stateField.style.backgroundColor = '', 1500);
                console.log(' State auto-filled:', extracted.state);
              }
            }
            // Auto-fill Date of Birth from OCR
            if (extracted.dob) {
              const dobField = document.getElementById('appDOB');
              if (dobField && !dobField.value) {
                dobField.value = extracted.dob; // Already in YYYY-MM-DD format from OCR
                dobField.style.backgroundColor = '#10b98120';
                setTimeout(() => dobField.style.backgroundColor = '', 1500);
                console.log(' DOB auto-filled:', extracted.dob);
              }
            }

            // Auto-fill CDL Class radio
            if (extracted.cdlClass) {
              const cdlClassRadio = document.querySelector(`input[name="cdlClass"][value="${extracted.cdlClass}"]`);
              if (cdlClassRadio && !document.querySelector('input[name="cdlClass"]:checked')) {
                cdlClassRadio.checked = true;
                cdlClassRadio.closest('.radio-chip').style.backgroundColor = '#10b98120';
                setTimeout(() => cdlClassRadio.closest('.radio-chip').style.backgroundColor = '', 1500);
                console.log(' CDL Class auto-filled:', extracted.cdlClass);
              }
            }

            // Auto-fill endorsements checkboxes
            if (extracted.endorsements && Array.isArray(extracted.endorsements)) {
              extracted.endorsements.forEach(endorsement => {
                const checkbox = document.querySelector(`input[name="endorsements"][value="${endorsement}"]`);
                if (checkbox && !checkbox.checked) {
                  checkbox.checked = true;
                  checkbox.closest('.checkbox-chip').style.backgroundColor = '#10b98120';
                  setTimeout(() => checkbox.closest('.checkbox-chip').style.backgroundColor = '', 1500);
                }
              });
              console.log(' Endorsements auto-filled:', extracted.endorsements);
            }

            // Auto-fill state dropdown
            if (extracted.state) {
              const stateSelect = document.getElementById('appState');
              if (stateSelect && !stateSelect.value) {
                stateSelect.value = extracted.state;
                stateSelect.style.backgroundColor = '#10b98120';
                setTimeout(() => stateSelect.style.backgroundColor = '', 1500);
                console.log(' State auto-filled:', extracted.state);
              }
            }
          }
          if (docType === 'MED_CARD') {
            if (extracted.examinerName) window.extractedExaminerName = extracted.examinerName;
            if (extracted.registryNumber) window.extractedRegistryNumber = extracted.registryNumber;
          }
        },

        // Optional: callback when OCR fails
        onError: (docType, error) => {
          console.warn(`OCR failed for ${docType}:`, error);
        }
      });

      // Set up file input listeners
      window.OCRHandler.setupFileInputListeners();
    }

    // =========================================================================
    // OCR FUNCTIONS - Wrapper functions for compatibility
    // =========================================================================

    // Compress image for upload (reduces payload size to avoid 413 errors)
    function compressImageForUpload(file) {
      return new Promise(function(resolve, reject) {
        if (!file) { resolve(null); return; }

        // Skip compression for non-images (PDFs)
        if (file.type === 'application/pdf') {
          var reader = new FileReader();
          reader.onload = function() { resolve(reader.result); };
          reader.onerror = reject;
          reader.readAsDataURL(file);
          return;
        }

        // Compression settings for upload (more aggressive than OCR)
        var maxWidth = 800, maxHeight = 1000, quality = 0.6;

        var img = new Image();
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');

        img.onload = function() {
          var w = img.width, h = img.height;

          // Scale down if needed
          if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
          if (h > maxHeight) { w = Math.round(w * (maxHeight / h)); h = maxHeight; }

          canvas.width = w;
          canvas.height = h;

          // White background for transparency
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, w, h);
          ctx.drawImage(img, 0, 0, w, h);

          var compressed = canvas.toDataURL('image/jpeg', quality);
          var origKB = Math.round(file.size / 1024);
          var compKB = Math.round((compressed.length * 3) / 4 / 1024);
          console.log(' Upload compression: ' + origKB + 'KB  ' + compKB + 'KB (' + Math.round((1 - compKB / origKB) * 100) + '% reduction)');
          resolve(compressed);
        };

        img.onerror = function() { reject(new Error('Failed to load image for compression')); };

        var reader = new FileReader();
        reader.onload = function(e) { img.src = e.target.result; };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Convert file to base64 (delegates to OCRHandler or fallback)
    function fileToBase64(file) {
      if (window.OCRHandler && window.OCRHandler.isInitialized()) {
        return window.OCRHandler.fileToBase64(file);
      }
      // Fallback if OCRHandler not loaded
      return new Promise((resolve, reject) => {
        if (!file) { resolve(null); return; }
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Handle file input change - delegates to OCRHandler
    function handleFileChange(inputId) {
      if (window.OCRHandler && window.OCRHandler.isInitialized()) {
        window.OCRHandler.handleFileChange(inputId);
      }
    }

    // Handle OCR result - delegates to OCRHandler
    function handleOCRResult(data) {
      if (window.OCRHandler && window.OCRHandler.isInitialized()) {
        window.OCRHandler.handleOCRResult(data);
      }
    }

    // Remove uploaded file - delegates to OCRHandler
    function removeFile(inputId) {
      if (window.OCRHandler && window.OCRHandler.isInitialized()) {
        window.OCRHandler.removeFile(inputId);
      } else {
        // Fallback
        const input = document.getElementById(inputId);
        const box = document.getElementById(inputId + 'Box');
        const nameEl = document.getElementById(inputId + 'Name');
        if (input) input.value = '';
        uploadedFiles[inputId] = null;
        if (box) box.classList.remove('has-file');
        if (nameEl) nameEl.textContent = '';
      }
    }

    // Reset all file uploads - delegates to OCRHandler
    function resetFileUploads() {
      if (window.OCRHandler && window.OCRHandler.isInitialized()) {
        window.OCRHandler.resetFileUploads();
      } else {
        ['cdlFront', 'cdlBack', 'medCard'].forEach(id => removeFile(id));
      }
    }

    function showApplicationModal(carrierData) {
      if (!carrierData) return;

      currentApplicationCarrier = carrierData;

      // Populate carrier info in form
      document.getElementById('appModalCarrierName').textContent = carrierData.name;
      document.getElementById('appFormCarrierName').textContent = carrierData.name;
      document.getElementById('appFormCarrierDOT').textContent = carrierData.dotNumber;

      // Reset form state
      applicationForm.reset();
      resetFileUploads();

      // Auto-populate from Profile (Phase 4H)
      if (driverProfile) {
        console.log(' Auto-populating application from profile');

        // CDL Details
        if (driverProfile.cdl_number) document.getElementById('cdlNumber').value = driverProfile.cdl_number;
        if (driverProfile.cdl_expiration) document.getElementById('cdlExpiration').value = driverProfile.cdl_expiration;
        if (driverProfile.med_card_expiration) document.getElementById('medCardExpiration').value = driverProfile.med_card_expiration;

        // Contact
        if (driverProfile.phone) document.getElementById('appPhone').value = driverProfile.phone;
        if (driverProfile.email) document.getElementById('appEmail').value = driverProfile.email;

        // Documents - Show "Attached" status if URLs exist
        checkPreFilledDocs();
      }

      applicationFormContent.style.display = 'block';
      applicationFormLoading.classList.remove('show');
      applicationFormSuccess.classList.remove('show');

      // Clear any error states
      document.querySelectorAll('.form-group input.error, .form-group select.error').forEach(el => {
        el.classList.remove('error');
      });
      document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
      });
      document.querySelectorAll('.file-upload-box').forEach(el => {
        el.classList.remove('error');
      });

      // Reset accordion to initial state and check for pre-filled completions
      if (typeof resetAccordion === 'function') {
        resetAccordion();
        // Check completion states after a delay to account for pre-filled data
        setTimeout(() => {
          if (typeof checkAllSections === 'function') {
            checkAllSections();
          }
        }, 300);
      }

      // Show modal
      applicationModal.style.display = 'flex';
    }

    function hideApplicationModal() {
      applicationModal.style.display = 'none';
      currentApplicationCarrier = null;
    }

    function validateApplicationForm() {
      let isValid = true;
      const phone = document.getElementById('appPhone');
      const email = document.getElementById('appEmail');
      const phoneError = document.getElementById('phoneError');
      const emailError = document.getElementById('emailError');
      const cdlError = document.getElementById('cdlError');
      const medCardError = document.getElementById('medCardError');

      // Reset errors
      phone.classList.remove('error');
      email.classList.remove('error');
      phoneError.classList.remove('show');
      emailError.classList.remove('show');
      cdlError.classList.remove('show');
      medCardError.classList.remove('show');
      document.querySelectorAll('.file-upload-box').forEach(el => el.classList.remove('error'));

      // Reset DOB and name field errors
      const appDOB = document.getElementById('appDOB');
      const dobErrorEl = document.getElementById('dobError');
      const appFirstName = document.getElementById('appFirstName');
      const firstNameError = document.getElementById('firstNameError');
      const appLastName = document.getElementById('appLastName');
      const lastNameError = document.getElementById('lastNameError');
      if (appDOB) appDOB.classList.remove('error');
      if (dobErrorEl) dobErrorEl.classList.remove('show');
      if (appFirstName) appFirstName.classList.remove('error');
      if (firstNameError) firstNameError.classList.remove('show');
      if (appLastName) appLastName.classList.remove('error');
      if (lastNameError) lastNameError.classList.remove('show');

      // CDL validation (both front and back required)
      const hasCdlFront = uploadedFiles.cdlFront || (driverProfile && driverProfile.cdl_front_image);
      const hasCdlBack = uploadedFiles.cdlBack || (driverProfile && driverProfile.cdl_back_image);

      if (!hasCdlFront || !hasCdlBack) {
        if (!hasCdlFront) document.getElementById('cdlFrontBox').classList.add('error');
        if (!hasCdlBack) document.getElementById('cdlBackBox').classList.add('error');
        cdlError.classList.add('show');
        isValid = false;
      }

      // Medical card validation
      const hasMedCard = uploadedFiles.medCard || (driverProfile && driverProfile.med_card_image);
      if (!hasMedCard) {
        document.getElementById('medCardBox').classList.add('error');
        medCardError.classList.add('show');
        isValid = false;
      }

      // First name validation
      const firstName = document.getElementById('appFirstName');
      const firstNameErr = document.getElementById('firstNameError');
      if (!firstName.value.trim()) {
        firstName.classList.add('error');
        firstNameErr.classList.add('show');
        isValid = false;
      } else {
        firstName.classList.remove('error');
        firstNameErr.classList.remove('show');
      }

      // Last name validation
      const lastName = document.getElementById('appLastName');
      const lastNameErr = document.getElementById('lastNameError');
      if (!lastName.value.trim()) {
        lastName.classList.add('error');
        lastNameErr.classList.add('show');
        isValid = false;
      } else {
        lastName.classList.remove('error');
        lastNameErr.classList.remove('show');
      }

      // Date of Birth validation (required for driver profiles)
      const dob = document.getElementById('appDOB');
      const dobError = document.getElementById('dobError');
      if (!dob.value) {
        dob.classList.add('error');
        dobError.classList.add('show');
        isValid = false;
        console.log(' DOB validation failed - field is empty');
      } else {
        dob.classList.remove('error');
        dobError.classList.remove('show');
        console.log(' DOB validation passed:', dob.value);
      }

      // CDL number validation
      const cdlNumber = document.getElementById('cdlNumber');
      const cdlNumberError = document.getElementById('cdlNumberError');
      if (!cdlNumber.value.trim()) {
        cdlNumber.classList.add('error');
        cdlNumberError.classList.add('show');
        isValid = false;
      } else {
        cdlNumber.classList.remove('error');
        cdlNumberError.classList.remove('show');
      }

      // CDL expiration validation
      const cdlExpiration = document.getElementById('cdlExpiration');
      const cdlExpirationError = document.getElementById('cdlExpirationError');
      if (!cdlExpiration.value) {
        cdlExpiration.classList.add('error');
        cdlExpirationError.classList.add('show');
        isValid = false;
      } else {
        cdlExpiration.classList.remove('error');
        cdlExpirationError.classList.remove('show');
      }

      // Medical card expiration validation
      const medCardExpiration = document.getElementById('medCardExpiration');
      const medCardExpirationError = document.getElementById('medCardExpirationError');
      if (!medCardExpiration.value) {
        medCardExpiration.classList.add('error');
        medCardExpirationError.classList.add('show');
        isValid = false;
      } else {
        medCardExpiration.classList.remove('error');
        medCardExpirationError.classList.remove('show');
      }

      // Phone validation
      const phoneValue = phone.value.trim();
      if (!phoneValue || phoneValue.length < 10) {
        phone.classList.add('error');
        phoneError.classList.add('show');
        isValid = false;
      }

      // Email validation
      const emailValue = email.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailValue || !emailRegex.test(emailValue)) {
        email.classList.add('error');
        emailError.classList.add('show');
        isValid = false;
      }

      // Companies count validation
      const companiesCount = document.getElementById('appCompaniesCount');
      const companiesCountError = document.getElementById('companiesCountError');
      if (!companiesCount.value) {
        companiesCount.classList.add('error');
        companiesCountError.classList.add('show');
        isValid = false;
      } else {
        companiesCount.classList.remove('error');
        companiesCountError.classList.remove('show');
      }

      // Employer 1 validation (required when companies >= 1)
      const companiesCountVal = parseInt(companiesCount.value) || 0;
      if (companiesCountVal >= 1) {
        const employer1Name = document.getElementById('appEmployer1Name');
        const employer1NameError = document.getElementById('employer1NameError');
        const employer1Duration = document.getElementById('appEmployer1Duration');
        const employer1DurationError = document.getElementById('employer1DurationError');

        if (!employer1Name.value.trim()) {
          employer1Name.classList.add('error');
          employer1NameError.classList.add('show');
          isValid = false;
        } else {
          employer1Name.classList.remove('error');
          employer1NameError.classList.remove('show');
        }

        if (!employer1Duration.value) {
          employer1Duration.classList.add('error');
          employer1DurationError.classList.add('show');
          isValid = false;
        } else {
          employer1Duration.classList.remove('error');
          employer1DurationError.classList.remove('show');
        }
      }

      return isValid;
    }

    async function submitApplication() {
      if (!validateApplicationForm()) return;
      if (!currentApplicationCarrier) return;
      if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('matching_submit_application', { carrierName: currentApplicationCarrier.name, dotNumber: currentApplicationCarrier.dotNumber });

      // Show loading state
      applicationFormContent.style.display = 'none';
      applicationFormLoading.classList.add('show');

      // Get loading text element
      const loadingText = document.getElementById('applicationLoadingText');
      if (loadingText) loadingText.textContent = 'Submitting your application...';

      // Show OCR processing message after 2 seconds (documents are uploaded first, then OCR runs)
      appOcrTimeout = setTimeout(() => {
        if (loadingText) loadingText.textContent = 'Gemini AI is extracting your document data...';
      }, 2000);

      // Show profile update message after 5 seconds
      appProfileTimeout = setTimeout(() => {
        if (loadingText) loadingText.textContent = 'Updating your driver profile...';
      }, 5000);

      try {
        // Compress and convert files to base64 (prevents 413 Payload Too Large errors)
        const [cdlFrontData, cdlBackData, medCardData] = await Promise.all([
          compressImageForUpload(uploadedFiles.cdlFront),
          compressImageForUpload(uploadedFiles.cdlBack),
          compressImageForUpload(uploadedFiles.medCard)
        ]);

        // Collect multi-select values
        const getCheckedValues = (name) => {
          return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
        };

        // Get form data with all fields matching seeded driver schema
        const formData = {
          // Carrier info
          carrierDOT: currentApplicationCarrier.dotNumber,
          carrierName: currentApplicationCarrier.name,
          matchScore: currentApplicationCarrier.matchScore || 0,

          // Driver identity (NEW - from OCR or manual)
          firstName: document.getElementById('appFirstName').value.trim(),
          lastName: document.getElementById('appLastName').value.trim(),
          dob: document.getElementById('appDOB')?.value || null, // Date of Birth from OCR

          // Contact info
          phone: document.getElementById('appPhone').value.trim(),
          email: document.getElementById('appEmail').value.trim(),
          preferredContact: document.querySelector('input[name="preferredContact"]:checked')?.value || 'phone',

          // Location (NEW)
          city: document.getElementById('appCity').value.trim(),
          state: document.getElementById('appState').value,
          homeZip: document.getElementById('appZip').value.trim(),

          // CDL info
          cdlNumber: document.getElementById('cdlNumber').value.trim(),
          cdlExpiration: document.getElementById('cdlExpiration').value,
          cdlClass: document.querySelector('input[name="cdlClass"]:checked')?.value || '', // NEW
          endorsements: getCheckedValues('endorsements'), // NEW - array
          cdlRestrictions: window.extractedRestrictions || 'NONE', // From OCR - "NONE" = no restrictions (favorable)
          medCardExpiration: document.getElementById('medCardExpiration').value,

          // Experience (NEW)
          yearsExperience: parseInt(document.getElementById('appYearsExperience').value) || 0,
          equipmentExperience: getCheckedValues('equipmentExperience'), // NEW - array
          mvrStatus: document.getElementById('appMvrStatus').value, // NEW

          // Safety Record (NEW) - Use camelCase to match page code expectations
          accidentsLast3Years: parseInt(document.getElementById('appAccidents').value) || 0,
          violationsLast3Years: parseInt(document.getElementById('appViolations').value) || 0,

          // Work History (NEW) - Use camelCase to match page code expectations
          companiesLast3Years: parseInt(document.getElementById('appCompaniesCount').value) || 0,
          employer1Name: document.getElementById('appEmployer1Name').value.trim(),
          employer1Duration: document.getElementById('appEmployer1Duration').value,
          employer2Name: document.getElementById('appEmployer2Name').value.trim(),
          employer2Duration: document.getElementById('appEmployer2Duration').value,
          employer3Name: document.getElementById('appEmployer3Name').value.trim(),
          employer3Duration: document.getElementById('appEmployer3Duration').value,

          // Preferences (NEW)
          preferredRoutes: getCheckedValues('preferredRoutes'), // NEW - array
          homeTimePreference: document.getElementById('appHomeTime').value, // NEW
          availability: document.getElementById('appAvailability').value,

          // Message
          message: document.getElementById('appMessage').value.trim(),

          // Documents
          documents: {
            cdlFront: uploadedFiles.cdlFront ? { data: cdlFrontData, name: uploadedFiles.cdlFront.name, type: uploadedFiles.cdlFront.type } : null,
            cdlBack: uploadedFiles.cdlBack ? { data: cdlBackData, name: uploadedFiles.cdlBack.name, type: uploadedFiles.cdlBack.type } : null,
            medCard: uploadedFiles.medCard ? { data: medCardData, name: uploadedFiles.medCard.name, type: uploadedFiles.medCard.type } : null
          },
          existingProfileDocs: {
            cdl_front_image: driverProfile?.cdl_front_image,
            cdl_back_image: driverProfile?.cdl_back_image,
            med_card_image: driverProfile?.med_card_image,
            resume_file: driverProfile?.resume_file
          }
        };

        // DEBUG: Log all collected form data
        console.log('=== APPLICATION FORM DATA DEBUG ===');
        console.log('firstName:', formData.firstName);
        console.log('lastName:', formData.lastName);
        console.log('dob:', formData.dob);
        console.log('dob element exists:', !!document.getElementById('appDOB'));
        console.log('dob element value:', document.getElementById('appDOB')?.value);
        console.log('city:', formData.city);
        console.log('state:', formData.state);
        console.log('homeZip:', formData.homeZip);
        console.log('cdlClass:', formData.cdlClass);
        console.log('endorsements:', formData.endorsements);
        console.log('cdlRestrictions:', formData.cdlRestrictions);
        console.log('yearsExperience:', formData.yearsExperience);
        console.log('equipmentExperience:', formData.equipmentExperience);
        console.log('mvrStatus:', formData.mvrStatus);
        console.log('accidentsLast3Years:', formData.accidentsLast3Years);
        console.log('violationsLast3Years:', formData.violationsLast3Years);
        console.log('companiesLast3Years:', formData.companiesLast3Years);
        console.log('employer1Name:', formData.employer1Name);
        console.log('employer1Duration:', formData.employer1Duration);
        console.log('employer2Name:', formData.employer2Name);
        console.log('employer2Duration:', formData.employer2Duration);
        console.log('employer3Name:', formData.employer3Name);
        console.log('employer3Duration:', formData.employer3Duration);
        console.log('preferredRoutes:', formData.preferredRoutes);
        console.log('homeTimePreference:', formData.homeTimePreference);
        console.log('=== END DEBUG ===');

        console.log('Submitting application with documents');
        sendToWix('submitApplication', formData);
      } catch (error) {
        // Clear OCR animation timeouts
        if (appOcrTimeout) clearTimeout(appOcrTimeout);
        if (appProfileTimeout) clearTimeout(appProfileTimeout);

        console.error('Error processing files:', error);
        applicationFormLoading.classList.remove('show');
        applicationFormContent.style.display = 'block';
        alert('Error processing files. Please try again.');
      }
    }

    function checkPreFilledDocs() {
      if (!driverProfile) return;

      const docs = [
        { id: 'cdlFront', url: driverProfile.cdl_front_image },
        { id: 'cdlBack', url: driverProfile.cdl_back_image },
        { id: 'medCard', url: driverProfile.med_card_image }
      ];

      docs.forEach(doc => {
        if (doc.url) {
          const box = document.getElementById(doc.id + 'Box');
          const nameEl = document.getElementById(doc.id + 'Name');
          if (box && nameEl) {
            box.classList.add('has-file');
            box.style.borderColor = 'var(--color-success)';
            nameEl.innerHTML = `<i class="fa-solid fa-check-circle" style="color: var(--color-success)"></i> Attached from Profile`;
          }
        }
      });
    }

    function handleApplicationSubmitted(data) {
      // Clear OCR animation timeouts
      if (appOcrTimeout) clearTimeout(appOcrTimeout);
      if (appProfileTimeout) clearTimeout(appProfileTimeout);

      // Hide loading
      applicationFormLoading.classList.remove('show');

      if (data.success) {
        // Show success state
        applicationFormSuccess.classList.add('show');

        // Update the card to show "Applied" status
        updateCardToApplied(data.carrierDOT);
      } else if (data.isDuplicate) {
        // Handle duplicate submission - show friendly message and update card
        console.log(' Duplicate application detected:', data.existingStatus);

        // Still update the card since they already applied
        updateCardToApplied(currentApplicationCarrier?.dot);

        // Show success state with modified message
        applicationFormSuccess.classList.add('show');
        const successTitle = applicationFormSuccess.querySelector('h3');
        const successMsg = applicationFormSuccess.querySelector('p');
        if (successTitle) successTitle.textContent = 'Already Applied!';
        if (successMsg) successMsg.textContent = `You've already applied to this carrier. Your application is currently "${formatStatus(data.existingStatus)}". Check your dashboard to track progress.`;
      } else {
        // Show form again with error
        applicationFormContent.style.display = 'block';
        alert('Error submitting application: ' + (data.error || 'Unknown error'));
      }
    }

    // Helper to update a match card to "Applied" status
    function updateCardToApplied(carrierDOT) {
      if (!carrierDOT) return;

      const dotStr = String(carrierDOT);
      appliedCarrierDOTs.add(dotStr);
      const card = document.querySelector(`.match-card[data-dot="${dotStr}"]`);
      if (card) {
        // Add the tag
        const tagsContainer = card.querySelector('.match-tags');
        if (tagsContainer && !tagsContainer.querySelector('.match-tag.applied')) {
          tagsContainer.insertAdjacentHTML('afterbegin',
            '<span class="match-tag applied" style="background: #10b98115; color: #10b981; border: 1px solid #10b98130; font-weight: 800;"><i class="fa-solid fa-check-circle"></i> Applied</span>');
        }
        // Update the button
        const btn = card.querySelector('.interested-btn');
        if (btn) {
          btn.classList.add('applied');
          btn.disabled = true;
          btn.innerHTML = '<i class="fa-solid fa-check"></i> Application Sent';
        }
      }
    }

    // Helper to format status for display
    function formatStatus(status) {
      const labels = {
        'applied': 'Applied',
        'in_review': 'In Review',
        'contacted': 'Contacted',
        'offer': 'Offer Received',
        'hired': 'Hired'
      };
      return labels[status] || status;
    }

    // Application form button handlers
    if (appCancelBtn) {
      appCancelBtn.addEventListener('click', () => {
        // Store carrier data before hiding
        const carrierToRestore = currentApplicationCarrier;
        hideApplicationModal();
        // Re-show the interest modal
        if (carrierToRestore) {
          pendingInterestCarrier = carrierToRestore;
          showInterestModal(carrierToRestore);
        }
      });
    }

    if (appSubmitBtn) {
      appSubmitBtn.addEventListener('click', submitApplication);
    }

    // Work History: Show/hide employer sections based on companies count
    const companiesCountSelect = document.getElementById('appCompaniesCount');
    if (companiesCountSelect) {
      companiesCountSelect.addEventListener('change', function() {
        const count = parseInt(this.value) || 0;
        const employer1Section = document.getElementById('employer1Section');
        const employer2Section = document.getElementById('employer2Section');
        const employer3Section = document.getElementById('employer3Section');

        // Show employer 1 if at least 1 company selected
        if (employer1Section) {
          employer1Section.style.display = count >= 1 ? 'block' : 'none';
        }

        // Show employer 2 if at least 2 companies selected
        if (employer2Section) {
          employer2Section.style.display = count >= 2 ? 'block' : 'none';
        }

        // Show employer 3 if at least 3 companies selected
        if (employer3Section) {
          employer3Section.style.display = count >= 3 ? 'block' : 'none';
        }
      });
    }

    if (appSuccessCloseBtn) {
      appSuccessCloseBtn.addEventListener('click', hideApplicationModal);
    }

    // Close application modal when clicking outside
    if (applicationModal) {
      applicationModal.addEventListener('click', (e) => {
        if (e.target === applicationModal) {
          hideApplicationModal();
        }
      });
    }

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    if (window.parent) {
      window.parent.postMessage({ type: 'carrierMatchingReady' }, '*');
      // Trigger connection health check after 500ms
      setTimeout(verifyConnection, 500);
    }

    console.log('LMDR Carrier Matching V7 (Message Validation) Ready');
    console.log(' Message Registry:', {
      inbound: MESSAGE_REGISTRY.inbound.length,
      outbound: MESSAGE_REGISTRY.outbound.length
    });

    // Initialize secure connection audit
    document.addEventListener('DOMContentLoaded', verifyConnection);

  </script>

</body>

</html>