<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Find Your Perfect Carrier | LMDR</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@b8c63d6/src/public/driver/css/ai-matching.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/theme-styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">

  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/js/feature-tracker.js"></script>
</head>

<body>
  <!-- Guest banner — shown when user is not logged in, hidden after login -->
  <div class="guest-banner" id="guestBanner" style="display:none;">
    <div class="guest-banner-left">
      <i class="fa-solid fa-user-slash"></i>
      <span>You're browsing as a guest. <strong>Sign up free</strong> to save matches, apply to carriers, and unlock all results.</span>
    </div>
    <div class="guest-banner-actions">
      <button class="guest-btn-signup" id="guestSignupBtn"><i class="fa-solid fa-user-plus"></i> Sign Up Free</button>
      <button class="guest-btn-login" id="guestLoginBtn"><i class="fa-solid fa-right-to-bracket"></i> Log In</button>
    </div>
  </div>

  <div class="container">
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="find">Find Matches</button>
      <button class="nav-tab" data-tab="applications">My Applications <span id="appCountBadge"
          style="display:none; background:var(--lmdr-blue); color:white; padding:2px 6px; border-radius:10px; font-size:10px;">0</span></button>
    </div>

    <section class="form-section" id="formSection">
      <div class="form-header">
        <span class="form-badge"><i class="fa-solid fa-shield-halved"></i> FMCSA Verified • AI-Powered</span>
        <h1 class="form-title">Find Your Carrier</h1>
        <p class="form-subtitle">Real safety data. Real driver reviews. Real matches.</p>
      </div>

      <form id="driverForm" class="form-grid">
        <div class="form-group">
          <label class="form-label" for="homeZip">
            <i class="fa-solid fa-location-dot"></i> Home Zip Code
          </label>
          <input type="text" id="homeZip" class="form-input" placeholder="e.g., 75001" maxlength="5" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxDistance">
            <i class="fa-solid fa-route"></i> Max Commute
          </label>
          <select id="maxDistance" class="form-select">
            <option value="50">50 miles</option>
            <option value="100">100 miles</option>
            <option value="250">250 miles</option>
            <option value="500">500 miles</option>
            <option value="1000">Nationwide</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="minCPM">
            <i class="fa-solid fa-money-bill-wave"></i> Min Pay (CPM)
          </label>
          <input type="number" id="minCPM" class="form-input" placeholder="e.g., 0.55" step="0.01" min="0" max="2">
        </div>

        <div class="form-group">
          <label class="form-label" for="operationType">
            <i class="fa-solid fa-truck-ramp-box"></i> Run Type
          </label>
          <select id="operationType" class="form-select">
            <option value="any">No preference</option>
            <option value="OTR">OTR (Long Haul)</option>
            <option value="Regional">Regional</option>
            <option value="Local">Local / Home Daily</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxTurnover">
            <i class="fa-solid fa-users-gear"></i> Max Turnover
          </label>
          <select id="maxTurnover" class="form-select">
            <option value="90" selected>Under 90% (Average)</option>
            <option value="50">Under 50% (High Retention)</option>
            <option value="25">Under 25% (Elite)</option>
            <option value="200">No Limit</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxTruckAge">
            <i class="fa-solid fa-truck-front"></i> Max Truck Age
          </label>
          <select id="maxTruckAge" class="form-select">
            <option value="5" selected>5 years or newer</option>
            <option value="3">3 years or newer</option>
            <option value="10">Under 10 years</option>
            <option value="99">Any age</option>
          </select>
        </div>

        <div class="form-group full-width">
          <label class="form-label" for="driverName">
            <i class="fa-solid fa-user"></i>
            Your Name
            <span class="hint">(Optional)</span>
          </label>
          <input type="text" id="driverName" class="form-input" placeholder="Enter your full name">
        </div>

        <div class="form-group full-width">
          <label class="form-label">
            <i class="fa-solid fa-boxes-stacked"></i> Fleet Size Preference
          </label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetSmall" value="small">
              <label for="fleetSmall">
                <i class="fa-solid fa-truck"></i>
                <span>Small</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetMedium" value="medium">
              <label for="fleetMedium">
                <i class="fa-solid fa-truck-moving"></i>
                <span>Medium</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetLarge" value="large">
              <label for="fleetLarge">
                <i class="fa-solid fa-warehouse"></i>
                <span>Large</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="fleetSize" id="fleetAny" value="any" checked>
              <label for="fleetAny">
                <i class="fa-solid fa-check-double"></i>
                <span>Any</span>
              </label>
            </div>
          </div>
        </div>

        <div class="form-group full-width" style="margin-top: 8px;">
          <div class="checkbox-group">
            <label class="checkbox-chip"
              style="width: 100%; justify-content: center; background: #f3e8ff; color: #6d28d9; border: 1px solid #d8b4fe;">
              <input type="checkbox" id="showMutualOnly">
              <i class="fa-solid fa-handshake"></i>
              <span>Show only carriers with mutual interest</span>
            </label>
          </div>
        </div>

        <div class="form-group full-width" style="margin-top: 12px;">
          <button type="button" id="togglePriorities" class="reset-btn"
            style="width: 100%; justify-content: center; border-style: dashed; background: #f8fafc;">
            <i class="fa-solid fa-sliders"></i> Customize Match Priorities
          </button>
        </div>

        <div class="advanced-priorities full-width" id="advancedPriorities">
          <div class="priorities-header">
            <div class="priorities-title"><i class="fa-solid fa-weight-hanging"></i> Adjust Match Importance</div>
            <button type="button" id="resetWeights" class="modal-btn tertiary"
              style="width: auto; padding: 4px 8px; font-size: 10px;">Reset to Default</button>
          </div>
          <div class="priorities-grid">
            <div class="priority-item">
              <label class="priority-label" for="weight-location">
                <span>Home Location</span>
                <span class="weight-value-badge" id="weight-val-location">Standard</span>
              </label>
              <input type="range" id="weight-location" min="0" max="100" value="25">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-pay">
                <span>Driver Pay</span>
                <span class="weight-value-badge" id="weight-val-pay">Standard</span>
              </label>
              <input type="range" id="weight-pay" min="0" max="100" value="20">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-operationType">
                <span>Route Match</span>
                <span class="weight-value-badge" id="weight-val-operationType">Standard</span>
              </label>
              <input type="range" id="weight-operationType" min="0" max="100" value="15">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-safety">
                <span>Safety Record</span>
                <span class="weight-value-badge" id="weight-val-safety">Standard</span>
              </label>
              <input type="range" id="weight-safety" min="0" max="100" value="10">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-turnover">
                <span>Driver Retention</span>
                <span class="weight-value-badge" id="weight-val-turnover">Standard</span>
              </label>
              <input type="range" id="weight-turnover" min="0" max="100" value="12">
            </div>
            <div class="priority-item">
              <label class="priority-label" for="weight-truckAge">
                <span>Fleet Age</span>
                <span class="weight-value-badge" id="weight-val-truckAge">Standard</span>
              </label>
              <input type="range" id="weight-truckAge" min="0" max="100" value="8">
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          <i class="fa-solid fa-magnifying-glass"></i> Find My Matches
        </button>
      </form>
    </section>

    <section class="loading-section" id="loadingSection">
      <div class="loading-spinner"></div>
      <h2 class="loading-title">Finding Your Matches</h2>
      <p style="color: var(--lmdr-body); font-weight: 500;">Analyzing carriers with verified safety data...</p>

      <ul class="loading-steps">
        <li class="loading-step" id="step1"><i class="fa-solid fa-circle-notch fa-spin"></i> <span>Searching by
            location...</span></li>
        <li class="loading-step" id="step2"><i class="fa-regular fa-circle"></i> <span>Pulling FMCSA safety
            records...</span></li>
        <li class="loading-step" id="step3"><i class="fa-regular fa-circle"></i> <span>Scoring matches...</span></li>
        <li class="loading-step" id="step4"><i class="fa-regular fa-circle"></i> <span>Building your report...</span>
        </li>
      </ul>
    </section>


    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <div class="results-header-left">
          <div>
            <h2 class="results-title">Your Top Matches</h2>
            <p class="results-meta">Scored <span id="totalScored">0</span> carriers • Showing top <span
                id="matchCount">0</span></p>
          </div>
          <div id="userTierBadge"></div>
        </div>
        <div class="results-header-right" style="gap: 8px;">
          <div class="sort-control">
            <i class="fa-solid fa-sort"></i>
            <select id="sortMatches" class="sort-select"
              style="border: none; background: transparent; font-weight: 600; font-size: 13px; color: var(--lmdr-body); cursor: pointer; outline: none;">
              <option value="score">Best Match Score</option>
              <option value="mutual">Mutual Interest First</option>
              <option value="pay">Highest Pay</option>
            </select>
          </div>
          <button class="reset-btn" id="resetBtn">
            <i class="fa-solid fa-rotate-left"></i> New Search
          </button>
        </div>
      </div>

      <!-- Premium Success Banner (shown to logged in users) -->
      <div class="premium-success-banner" id="premiumBanner" style="display: none;">
        <i class="fa-solid fa-crown"></i>
        <div class="premium-success-text">
          <strong>Premium Access Active</strong>
          <span>You're seeing all 10 of your top carrier matches with full AI intelligence.</span>
        </div>
      </div>

      <!-- Upsell Banner (shown to free users with more matches available) -->
      <div class="upsell-banner" id="upsellBanner" style="display: none;">
        <div class="upsell-content">
          <div class="upsell-title"><i class="fa-solid fa-lock-open"></i> Unlock Your Full Match List</div>
          <div class="upsell-text" id="upsellText">You're seeing 2 of your matches. Sign up free to see all carriers
            that fit your criteria.</div>
          <div class="upsell-stats">
            <div class="upsell-stat">
              <div class="upsell-stat-value" id="hiddenMatchCount">8</div>
              <div class="upsell-stat-label">More Matches</div>
            </div>
            <div class="upsell-stat">
              <div class="upsell-stat-value">10</div>
              <div class="upsell-stat-label">Premium Limit</div>
            </div>
          </div>
        </div>
        <div class="upsell-actions">
          <button class="upsell-btn" id="signupBtn">
            <i class="fa-solid fa-user-plus"></i> Sign Up Free
          </button>
          <button class="upsell-btn secondary" id="loginBtn">
            <i class="fa-solid fa-right-to-bracket"></i> Log In
          </button>
        </div>
      </div>

      <div class="results-grid">
        <div class="matches-list" id="matchesList"></div>

        <!-- Coming Soon Sidebar Widget -->
        <aside class="coming-soon-sidebar">
          <div class="sidebar-header">
            <div class="sidebar-header-icon">
              <i class="fa-solid fa-rocket"></i>
            </div>
            <h3>Coming Soon</h3>
          </div>

          <div class="sidebar-features-list">
            <!-- Driver Utility Expansion -->
            <div class="sidebar-category" data-category="utility">
              <div class="sidebar-category-header utility" onclick="toggleCategory(this)">
                <i class="fa-solid fa-wrench sidebar-category-icon"></i>
                <span class="sidebar-category-title">Utility Expansion</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-gauge-high"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Profile Strength Meter</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-reply-all"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Quick Response Templates</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-bell"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Reverse Alerts</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon cyan"><i class="fa-solid fa-chart-line"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Insights Panel</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Road Utilities -->
            <div class="sidebar-category" data-category="road">
              <div class="sidebar-category-header road" onclick="toggleCategory(this)">
                <i class="fa-solid fa-road sidebar-category-icon"></i>
                <span class="sidebar-category-title">Road Utilities</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-square-parking"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Parking Finder</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-gas-pump"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Fuel Optimizer</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-scale-balanced"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Weigh Station Status</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon blue"><i class="fa-solid fa-cloud-sun-rain"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Weather & Road Alerts</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Compliance Tools -->
            <div class="sidebar-category" data-category="compliance">
              <div class="sidebar-category-header compliance" onclick="toggleCategory(this)">
                <i class="fa-solid fa-clipboard-check sidebar-category-icon"></i>
                <span class="sidebar-category-title">Compliance Tools</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-clock"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">HOS Tracker</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-folder-open"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Document Wallet</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-calendar-xmark"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Expiration Alerts</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon indigo"><i class="fa-solid fa-graduation-cap"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Training Tracker</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Financial Tools -->
            <div class="sidebar-category" data-category="financial">
              <div class="sidebar-category-header financial" onclick="toggleCategory(this)">
                <i class="fa-solid fa-dollar-sign sidebar-category-icon"></i>
                <span class="sidebar-category-title">Financial Tools</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Settlement Viewer</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-receipt"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Expense Tracker</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-calculator"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Trip Pay Calculator</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon purple"><i class="fa-solid fa-piggy-bank"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Tax Deduction Helper</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Driver Community -->
            <div class="sidebar-category" data-category="community">
              <div class="sidebar-category-header community" onclick="toggleCategory(this)">
                <i class="fa-solid fa-users sidebar-category-icon"></i>
                <span class="sidebar-category-title">Driver Community</span>
                <i class="fa-solid fa-chevron-down sidebar-category-toggle"></i>
              </div>
              <div class="sidebar-category-items">
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-comments"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Forums</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-handshake"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Mentor Matching</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-paw"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Pet-Friendly Database</div>
                  </div>
                </div>
                <div class="sidebar-feature-item">
                  <div class="sidebar-feature-icon teal"><i class="fa-solid fa-heart-pulse"></i></div>
                  <div class="sidebar-feature-content">
                    <div class="sidebar-feature-name">Trucker Health Resources</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- APPLICATIONS SECTION (Hidden by default) -->
    <section class="applications-section" id="applicationsSection">
      <div class="form-section">
        <div class="form-header"
          style="margin-bottom: 32px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 class="form-title" style="font-size: 32px; margin-bottom: 8px;">My Applications</h2>
            <p class="form-subtitle" style="margin: 0; max-width: none; font-size: 16px;">Track real-time status updates
              from carriers.</p>
          </div>
          <button class="reset-btn" id="refreshAppsBtn">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
        </div>

        <div id="applicationsList">
          <div class="loading-spinner" style="margin: 40px auto;"></div>
        </div>
      </div>
    </section>

  </div>

  <!-- Interest Confirmation Modal -->
  <div id="interestModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-success-icon">
          <i class="fa-solid fa-check-circle"></i>
        </div>
        <h2 class="modal-title">Interest Logged!</h2>
        <p class="modal-subtitle">We've notified <span id="modalCarrierName">the carrier</span> that you're interested.
        </p>
      </div>

      <div class="modal-body">
        <div class="modal-carrier-info">
          <div class="modal-info-row">
            <i class="fa-solid fa-building"></i>
            <span id="modalCarrierFullName">Carrier Name</span>
          </div>
          <div class="modal-info-row" id="modalPhoneRow">
            <i class="fa-solid fa-phone"></i>
            <a href="#" id="modalCarrierPhone">Contact Phone</a>
          </div>
          <div class="modal-info-row" id="modalEmailRow">
            <i class="fa-solid fa-envelope"></i>
            <a href="#" id="modalCarrierEmail">Contact Email</a>
          </div>
          <div class="modal-info-row">
            <i class="fa-solid fa-hashtag"></i>
            <span>DOT: <span id="modalCarrierDOT">000000</span></span>
          </div>
        </div>

        <div class="modal-next-steps">
          <h4><i class="fa-solid fa-arrow-right"></i> What's Next?</h4>
          <ul>
            <li><i class="fa-solid fa-circle-check"></i> The carrier has been notified of your interest</li>
            <li><i class="fa-solid fa-file-arrow-up"></i> Complete your application to stand out</li>
            <li><i class="fa-solid fa-chart-line"></i> Track your status in the Application Dashboard</li>
          </ul>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn primary" id="modalApplyBtn">
          <i class="fa-solid fa-file-arrow-up"></i> Complete Application
        </button>
        <button class="modal-btn secondary" id="modalDashboardBtn">
          <i class="fa-solid fa-list-check"></i> View My Applications
        </button>
        <button class="modal-btn tertiary" id="modalCloseBtn">
          Keep Browsing
        </button>
      </div>
    </div>
  </div>

  <!-- Application Form Modal -->
  <div id="applicationModal" class="modal-overlay" style="display: none;">
    <div class="modal-container application-form">
      <div class="modal-header apply-header">
        <div class="modal-success-icon">
          <i class="fa-solid fa-file-arrow-up"></i>
        </div>
        <h2 class="modal-title">Complete Your Application</h2>
        <p class="modal-subtitle">Stand out to <span id="appModalCarrierName">the carrier</span></p>
      </div>

      <!-- Form Content -->
      <div id="applicationFormContent">
        <div class="modal-form">
          <div class="form-carrier-badge">
            <i class="fa-solid fa-building"></i>
            <div class="carrier-info">
              <div class="carrier-name" id="appFormCarrierName">Carrier Name</div>
              <div class="carrier-dot">DOT: <span id="appFormCarrierDOT">000000</span></div>
            </div>
          </div>

          <form id="applicationForm">
            <!-- Progress Indicator -->
            <div class="accordion-progress" id="accordionProgress">
              <div class="accordion-progress-step active" data-section="1">
                <div class="accordion-progress-dot">1</div>
                <div class="accordion-progress-label">Documents</div>
              </div>
              <div class="accordion-progress-step" data-section="2">
                <div class="accordion-progress-dot">2</div>
                <div class="accordion-progress-label">Personal</div>
              </div>
              <div class="accordion-progress-step" data-section="3">
                <div class="accordion-progress-dot">3</div>
                <div class="accordion-progress-label">CDL Info</div>
              </div>
              <div class="accordion-progress-step" data-section="4">
                <div class="accordion-progress-dot">4</div>
                <div class="accordion-progress-label">Safety</div>
              </div>
              <div class="accordion-progress-step" data-section="5">
                <div class="accordion-progress-dot">5</div>
                <div class="accordion-progress-label">History</div>
              </div>
              <div class="accordion-progress-step" data-section="6">
                <div class="accordion-progress-dot">6</div>
                <div class="accordion-progress-label">Preferences</div>
              </div>
            </div>

            <!-- Section 1: Document Upload (Starts OPEN) -->
            <div class="accordion-section expanded" data-section="1" id="accordionSection1">
              <div class="accordion-header" onclick="toggleAccordion(1)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>1</span></div>
                  <div class="accordion-title">Document Upload</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="file-upload-section">
                  <h4><i class="fa-solid fa-id-card"></i> CDL License <span class="required">*</span></h4>
                  <div class="file-upload-grid">
                    <div class="file-upload-box" id="cdlFrontBox">
                      <input type="file" id="cdlFront" accept="image/*" />
                      <button type="button" class="remove-file" onclick="removeFile('cdlFront')"><i
                          class="fa-solid fa-times"></i></button>
                      <div class="upload-icon"><i class="fa-solid fa-id-card"></i></div>
                      <span class="upload-label">CDL Front</span>
                      <span class="upload-hint">Click to upload</span>
                      <span class="file-name" id="cdlFrontName"></span>
                    </div>
                    <div class="file-upload-box" id="cdlBackBox">
                      <input type="file" id="cdlBack" accept="image/*" />
                      <button type="button" class="remove-file" onclick="removeFile('cdlBack')"><i
                          class="fa-solid fa-times"></i></button>
                      <div class="upload-icon"><i class="fa-solid fa-id-card-clip"></i></div>
                      <span class="upload-label">CDL Back</span>
                      <span class="upload-hint">Click to upload</span>
                      <span class="file-name" id="cdlBackName"></span>
                    </div>
                  </div>
                  <div class="error-message" id="cdlError">Please upload both sides of your CDL</div>
                </div>

                <div class="file-upload-section">
                  <h4><i class="fa-solid fa-file-medical"></i> Medical Card <span class="required">*</span></h4>
                  <div class="file-upload-grid" style="grid-template-columns: 1fr;">
                    <div class="file-upload-box" id="medCardBox">
                      <input type="file" id="medCard" accept="image/*,.pdf" />
                      <button type="button" class="remove-file" onclick="removeFile('medCard')"><i
                          class="fa-solid fa-times"></i></button>
                      <div class="upload-icon"><i class="fa-solid fa-file-medical"></i></div>
                      <span class="upload-label">DOT Medical Card</span>
                      <span class="upload-hint">Image or PDF</span>
                      <span class="file-name" id="medCardName"></span>
                    </div>
                  </div>
                  <div class="error-message" id="medCardError">Please upload your medical card</div>
                </div>

                <div class="upload-requirements">
                  <i class="fa-solid fa-circle-info"></i>
                  <span>Files must be clear, readable images (JPG, PNG) or PDF. Max 5MB each.</span>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(2)">
                  Continue to Personal Info <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 2: Personal Information -->
            <div class="accordion-section" data-section="2" id="accordionSection2">
              <div class="accordion-header" onclick="toggleAccordion(2)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>2</span></div>
                  <div class="accordion-title">Personal Information</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="appFirstName">First Name <span class="required">*</span></label>
                    <input type="text" id="appFirstName" name="firstName" placeholder="First name" required>
                    <div class="error-message" id="firstNameError">Please enter your first name</div>
                  </div>
                  <div class="form-group">
                    <label for="appLastName">Last Name <span class="required">*</span></label>
                    <input type="text" id="appLastName" name="lastName" placeholder="Last name" required>
                    <div class="error-message" id="lastNameError">Please enter your last name</div>
                  </div>
                </div>

                <div class="form-group" style="max-width: 200px;">
                  <label for="appDOB">Date of Birth <span class="required">*</span></label>
                  <input type="date" id="appDOB" name="dob" required>
                  <div class="error-message" id="dobError">Please enter your date of birth</div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(3)">
                  Continue to CDL Info <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 3: CDL Information -->
            <div class="accordion-section" data-section="3" id="accordionSection3">
              <div class="accordion-header" onclick="toggleAccordion(3)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>3</span></div>
                  <div class="accordion-title">CDL Information</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="cdlNumber">CDL Number <span class="required">*</span></label>
                    <input type="text" id="cdlNumber" name="cdlNumber" placeholder="Enter CDL number" required>
                    <div class="error-message" id="cdlNumberError">Please enter your CDL number</div>
                  </div>
                  <div class="form-group">
                    <label for="cdlExpiration">CDL Expiration <span class="required">*</span></label>
                    <input type="date" id="cdlExpiration" name="cdlExpiration" required>
                    <div class="error-message" id="cdlExpirationError">Please enter CDL expiration date</div>
                  </div>
                </div>

                <div class="form-group">
                  <label>CDL Class <span class="required">*</span></label>
                  <div class="radio-group cdl-class-group">
                    <label class="radio-chip">
                      <input type="radio" name="cdlClass" value="A" required>
                      <span>Class A</span>
                    </label>
                    <label class="radio-chip">
                      <input type="radio" name="cdlClass" value="B">
                      <span>Class B</span>
                    </label>
                    <label class="radio-chip">
                      <input type="radio" name="cdlClass" value="C">
                      <span>Class C</span>
                    </label>
                  </div>
                  <div class="error-message" id="cdlClassError">Please select your CDL class</div>
                </div>

                <div class="form-group">
                  <label>Endorsements <span class="hint">(Select all that apply)</span></label>
                  <div class="checkbox-group endorsements-group">
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="H">
                      <span>H - Hazmat</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="N">
                      <span>N - Tank</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="P">
                      <span>P - Passenger</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="S">
                      <span>S - School Bus</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="T">
                      <span>T - Doubles/Triples</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="endorsements" value="X">
                      <span>X - Hazmat + Tank</span>
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label for="medCardExpiration">Medical Card Expiration <span class="required">*</span></label>
                  <input type="date" id="medCardExpiration" name="medCardExpiration" required>
                  <div class="error-message" id="medCardExpirationError">Please enter medical card expiration date</div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="appCity">City <span class="required">*</span></label>
                    <input type="text" id="appCity" name="city" placeholder="City" required>
                  </div>
                  <div class="form-group" style="flex: 0.5;">
                    <label for="appState">State <span class="required">*</span></label>
                    <select id="appState" name="state" required>
                      <option value="">--</option>
                      <option value="AL">AL</option>
                      <option value="AK">AK</option>
                      <option value="AZ">AZ</option>
                      <option value="AR">AR</option>
                      <option value="CA">CA</option>
                      <option value="CO">CO</option>
                      <option value="CT">CT</option>
                      <option value="DE">DE</option>
                      <option value="FL">FL</option>
                      <option value="GA">GA</option>
                      <option value="HI">HI</option>
                      <option value="ID">ID</option>
                      <option value="IL">IL</option>
                      <option value="IN">IN</option>
                      <option value="IA">IA</option>
                      <option value="KS">KS</option>
                      <option value="KY">KY</option>
                      <option value="LA">LA</option>
                      <option value="ME">ME</option>
                      <option value="MD">MD</option>
                      <option value="MA">MA</option>
                      <option value="MI">MI</option>
                      <option value="MN">MN</option>
                      <option value="MS">MS</option>
                      <option value="MO">MO</option>
                      <option value="MT">MT</option>
                      <option value="NE">NE</option>
                      <option value="NV">NV</option>
                      <option value="NH">NH</option>
                      <option value="NJ">NJ</option>
                      <option value="NM">NM</option>
                      <option value="NY">NY</option>
                      <option value="NC">NC</option>
                      <option value="ND">ND</option>
                      <option value="OH">OH</option>
                      <option value="OK">OK</option>
                      <option value="OR">OR</option>
                      <option value="PA">PA</option>
                      <option value="RI">RI</option>
                      <option value="SC">SC</option>
                      <option value="SD">SD</option>
                      <option value="TN">TN</option>
                      <option value="TX">TX</option>
                      <option value="UT">UT</option>
                      <option value="VT">VT</option>
                      <option value="VA">VA</option>
                      <option value="WA">WA</option>
                      <option value="WV">WV</option>
                      <option value="WI">WI</option>
                      <option value="WY">WY</option>
                    </select>
                  </div>
                  <div class="form-group" style="flex: 0.7;">
                    <label for="appZip">ZIP Code <span class="required">*</span></label>
                    <input type="text" id="appZip" name="homeZip" placeholder="ZIP" maxlength="5" pattern="[0-9]{5}"
                      required>
                  </div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(4)">
                  Continue to Safety Record <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 4: Safety Record -->
            <div class="accordion-section" data-section="4" id="accordionSection4">
              <div class="accordion-header" onclick="toggleAccordion(4)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>4</span></div>
                  <div class="accordion-title">Safety Record</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="appYearsExperience">Years of CDL Experience <span class="required">*</span></label>
                    <select id="appYearsExperience" name="yearsExperience" required>
                      <option value="">Select...</option>
                      <option value="0">Less than 1 year</option>
                      <option value="1">1-2 years</option>
                      <option value="3">3-5 years</option>
                      <option value="6">6-10 years</option>
                      <option value="11">11-15 years</option>
                      <option value="16">16+ years</option>
                    </select>
                    <div class="error-message" id="yearsExperienceError">Please select your experience</div>
                  </div>
                  <div class="form-group">
                    <label for="appMvrStatus">Driving Record</label>
                    <select id="appMvrStatus" name="mvrStatus">
                      <option value="clean">Clean MVR</option>
                      <option value="minor_violations">Minor Violations</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="appAccidents">Accidents in Last 3 Years</label>
                    <input type="number" id="appAccidents" name="accidents_last_3_years" min="0" max="10" value="0"
                      placeholder="0">
                  </div>
                  <div class="form-group">
                    <label for="appViolations">Moving Violations in Last 3 Years</label>
                    <input type="number" id="appViolations" name="violations_last_3_years" min="0" max="10" value="0"
                      placeholder="0">
                  </div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(5)">
                  Continue to Work History <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 5: Work History -->
            <div class="accordion-section" data-section="5" id="accordionSection5">
              <div class="accordion-header" onclick="toggleAccordion(5)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>5</span></div>
                  <div class="accordion-title">Work History</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-group">
                  <label for="appCompaniesCount">How many trucking companies have you worked for in the past 3 years?
                    <span class="required">*</span></label>
                  <select id="appCompaniesCount" name="companies_last_3_years" required>
                    <option value="">Select...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10+</option>
                  </select>
                  <div class="error-message" id="companiesCountError">Please select the number of companies</div>
                </div>

                <div id="employer1Section" class="employer-section" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="appEmployer1Name">Most Recent Employer <span class="required">*</span></label>
                      <input type="text" id="appEmployer1Name" name="employer_1_name" placeholder="Company name">
                      <div class="error-message" id="employer1NameError">Please enter employer name</div>
                    </div>
                    <div class="form-group">
                      <label for="appEmployer1Duration">Duration <span class="required">*</span></label>
                      <select id="appEmployer1Duration" name="employer_1_duration">
                        <option value="">Select...</option>
                        <option value="less_than_6_months">Less than 6 months</option>
                        <option value="6_months">6 months</option>
                        <option value="1_year">1 year</option>
                        <option value="2_years">2 years</option>
                        <option value="3_plus_years">3+ years</option>
                      </select>
                      <div class="error-message" id="employer1DurationError">Please select duration</div>
                    </div>
                  </div>
                </div>

                <div id="employer2Section" class="employer-section" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="appEmployer2Name">Previous Employer <span class="hint">(Optional)</span></label>
                      <input type="text" id="appEmployer2Name" name="employer_2_name" placeholder="Company name">
                    </div>
                    <div class="form-group">
                      <label for="appEmployer2Duration">Duration</label>
                      <select id="appEmployer2Duration" name="employer_2_duration">
                        <option value="">Select...</option>
                        <option value="less_than_6_months">Less than 6 months</option>
                        <option value="6_months">6 months</option>
                        <option value="1_year">1 year</option>
                        <option value="2_years">2 years</option>
                        <option value="3_plus_years">3+ years</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div id="employer3Section" class="employer-section" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="appEmployer3Name">Prior Employer <span class="hint">(Optional)</span></label>
                      <input type="text" id="appEmployer3Name" name="employer_3_name" placeholder="Company name">
                    </div>
                    <div class="form-group">
                      <label for="appEmployer3Duration">Duration</label>
                      <select id="appEmployer3Duration" name="employer_3_duration">
                        <option value="">Select...</option>
                        <option value="less_than_6_months">Less than 6 months</option>
                        <option value="6_months">6 months</option>
                        <option value="1_year">1 year</option>
                        <option value="2_years">2 years</option>
                        <option value="3_plus_years">3+ years</option>
                      </select>
                    </div>
                  </div>
                </div>

                <button type="button" class="accordion-next-btn" onclick="advanceToSection(6)">
                  Continue to Job Preferences <i class="fa-solid fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- Section 6: Job Preferences -->
            <div class="accordion-section" data-section="6" id="accordionSection6">
              <div class="accordion-header" onclick="toggleAccordion(6)">
                <div class="accordion-header-left">
                  <div class="accordion-number"><span>6</span></div>
                  <div class="accordion-title">Job Preferences</div>
                </div>
                <div class="accordion-header-right">
                  <span class="accordion-status"></span>
                  <div class="accordion-chevron"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-group">
                  <label>Equipment Experience <span class="required">*</span> <span class="hint">(Select all that
                      apply)</span></label>
                  <div class="checkbox-group equipment-group">
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Dry Van">
                      <span>Dry Van</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Reefer">
                      <span>Reefer</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Flatbed">
                      <span>Flatbed</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Tanker">
                      <span>Tanker</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Hazmat">
                      <span>Hazmat</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Auto Hauler">
                      <span>Auto Hauler</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Step Deck">
                      <span>Step Deck</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="equipmentExperience" value="Lowboy">
                      <span>Lowboy</span>
                    </label>
                  </div>
                  <div class="error-message" id="equipmentError">Please select at least one equipment type</div>
                </div>

                <div class="form-group">
                  <label>Preferred Routes <span class="required">*</span></label>
                  <div class="checkbox-group routes-group">
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="Local">
                      <span>Local</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="Regional">
                      <span>Regional</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="OTR">
                      <span>OTR</span>
                    </label>
                    <label class="checkbox-chip">
                      <input type="checkbox" name="preferredRoutes" value="Dedicated">
                      <span>Dedicated</span>
                    </label>
                  </div>
                  <div class="error-message" id="routesError">Please select at least one route type</div>
                </div>

                <div class="form-group">
                  <label for="appHomeTime">Home Time Preference</label>
                  <select id="appHomeTime" name="homeTimePreference">
                    <option value="Daily">Daily</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Bi-weekly">Bi-weekly</option>
                    <option value="Monthly">Monthly</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="appPhone">Phone Number <span class="required">*</span></label>
                    <input type="tel" id="appPhone" name="phone" placeholder="(555) 123-4567" required>
                    <div class="error-message" id="phoneError">Please enter a valid phone number</div>
                  </div>
                  <div class="form-group">
                    <label for="appEmail">Email Address <span class="required">*</span></label>
                    <input type="email" id="appEmail" name="email" placeholder="driver@email.com" required>
                    <div class="error-message" id="emailError">Please enter a valid email address</div>
                  </div>
                </div>

                <div class="form-group">
                  <label>Preferred Contact Method</label>
                  <div class="contact-preference">
                    <label>
                      <input type="radio" name="preferredContact" value="phone" checked>
                      <span>Phone</span>
                    </label>
                    <label>
                      <input type="radio" name="preferredContact" value="email">
                      <span>Email</span>
                    </label>
                    <label>
                      <input type="radio" name="preferredContact" value="either">
                      <span>Either</span>
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label for="appAvailability">When can you start?</label>
                  <select id="appAvailability" name="availability">
                    <option value="immediately">Immediately</option>
                    <option value="1_week">Within 1 week</option>
                    <option value="2_weeks">Within 2 weeks</option>
                    <option value="1_month">Within 1 month</option>
                    <option value="flexible">Flexible</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="appMessage">Message to Recruiter (Optional)</label>
                  <textarea id="appMessage" name="message"
                    placeholder="Introduce yourself, highlight your experience, or ask questions about the position..."></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="form-actions">
          <button type="button" class="modal-btn secondary" id="appCancelBtn">
            <i class="fa-solid fa-arrow-left"></i> Back
          </button>
          <button type="button" class="modal-btn primary" id="appSubmitBtn">
            <i class="fa-solid fa-paper-plane"></i> Submit Application
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="applicationFormLoading" class="form-loading">
        <i class="fa-solid fa-spinner"></i>
        <p id="applicationLoadingText">Submitting your application...</p>
      </div>

      <!-- Success State -->
      <div id="applicationFormSuccess" class="form-success">
        <i class="fa-solid fa-circle-check"></i>
        <h3>Application Submitted!</h3>
        <p>The carrier has been notified. They'll reach out using your preferred contact method.</p>
        <div style="margin-top: 20px;">
          <button type="button" class="modal-btn primary" id="appSuccessCloseBtn">
            <i class="fa-solid fa-check"></i> Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Prompt Modal (shown when anonymous user tries to submit application) -->
  <div id="loginPromptOverlay" class="login-prompt-overlay">
    <div class="login-prompt-card" style="position: relative;">
      <button type="button" class="login-prompt-close" id="loginPromptClose">&times;</button>

      <!-- Default state: prompt to sign up / log in -->
      <div id="loginPromptContent">
        <div class="login-prompt-icon">
          <i class="fa-solid fa-user-plus"></i>
        </div>
        <h3>Create a Free Account to Apply</h3>
        <p class="prompt-subtitle">
          Sign up in seconds to submit your application. It's completely free and unlocks premium matching features.
        </p>
        <div class="login-prompt-actions">
          <button type="button" class="btn-signup" id="loginPromptSignup">
            <i class="fa-solid fa-user-plus"></i> Sign Up Free
          </button>
          <button type="button" class="btn-login" id="loginPromptLogin">
            <i class="fa-solid fa-right-to-bracket"></i> I Already Have an Account
          </button>
        </div>
        <div class="login-prompt-reassurance">
          <i class="fa-solid fa-shield-check"></i> Your form data is saved &mdash; nothing will be lost
        </div>
      </div>

      <!-- Loading state: waiting for Wix auth -->
      <div id="loginPromptLoading" class="login-prompt-loading">
        <i class="fa-solid fa-spinner"></i>
        <p id="loginPromptLoadingText">Waiting for sign-in...</p>
      </div>
    </div>
  </div>

  <!-- Coming Soon Sidebar - Category Toggle -->
  <script>
    function toggleCategory(headerElement) {
      if (typeof FeatureTracker !== 'undefined') FeatureTracker.click('matching_filter_category', { category: headerElement.textContent.trim() });
      const category = headerElement.closest('.sidebar-category');
      if (category) {
        category.classList.toggle('collapsed');
      }
    }
  </script>

  <!-- External JS modules (loaded synchronously, order matters) -->
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@b8c63d6/src/public/driver/js/ai-matching-helpers.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@d21fe4c/src/public/driver/js/ai-matching-bridge.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@b8c63d6/src/public/driver/js/ai-matching-accordion.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/js/ocr-handler.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@b8c63d6/src/public/driver/js/ai-matching-renderers.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@b8c63d6/src/public/driver/js/ai-matching-modals.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@b8c63d6/src/public/driver/js/ai-matching-results.js"></script>

  <script>
    let currentMatches = [];
    let driverPrefs = {};
    let userStatus = { loggedIn: false, isPremium: false, tier: 'free' };
    let appliedCarrierDOTs = new Set();
    let mutualInterestMap = new Map(); // Phase 1: Store mutual interests
    let pendingInterestCarrier = null; // Stores carrier data while waiting for interest confirmation
    let driverProfile = null; // Phase 4H: Store profile for pre-fill
    let pendingApplicationData = null; // Stashes carrier data while login is in progress

    // Sort & Filter State
    let currentSort = 'score';
    let filterMutualOnly = false;
    let allMatches = []; // Store all original matches

    // =========================================================================
    // "WHY THIS JOB?" — Event delegation (runs before any DOM lookups)
    // =========================================================================
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.expand-explanation-btn');
      if (!btn) return;

      const carrierDot = btn.dataset.carrierDot;
      const driverId = btn.dataset.driverId || 'CURRENT_USER';
      if (!carrierDot) return;

      const card = btn.closest('.match-card');
      if (!card) return;

      const panel = card.querySelector('.explanation-panel');
      if (!panel) return;

      const isExpanded = panel.classList.contains('expanded');

      if (isExpanded) {
        panel.classList.remove('expanded');
        btn.classList.remove('active');
        btn.innerHTML = '<span>Why this job?</span> <i class="fa-solid fa-chevron-down"></i>';
      } else {
        panel.classList.add('expanded');
        btn.classList.add('active');
        btn.innerHTML = '<span>Close explanation</span> <i class="fa-solid fa-chevron-up"></i>';

        if (!panel.dataset.loaded) {
          panel.querySelector('.explanation-content').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #94a3b8;">
              <i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing match...
            </div>
          `;
          sendToWix('getMatchExplanation', { carrierDot, driverId });
        }
      }
    });

    const formSection = document.getElementById('formSection');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');
    const driverForm = document.getElementById('driverForm');
    const matchesList = document.getElementById('matchesList');
    const totalScoredEl = document.getElementById('totalScored');
    const matchCountEl = document.getElementById('matchCount');
    const resetBtn = document.getElementById('resetBtn');
    const upsellBanner = document.getElementById('upsellBanner');
    const premiumBanner = document.getElementById('premiumBanner');
    const upsellText = document.getElementById('upsellText');
    const hiddenMatchCount = document.getElementById('hiddenMatchCount');
    const userTierBadge = document.getElementById('userTierBadge');
    const sortSelect = document.getElementById('sortMatches');
    const mutualOnlyCheckbox = document.getElementById('showMutualOnly');

    // Event Listeners for Sort/Filter
    if (sortSelect) {
      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        renderFilteredResults();
      });
    }

    if (mutualOnlyCheckbox) {
      mutualOnlyCheckbox.addEventListener('change', (e) => {
        filterMutualOnly = e.target.checked;
        renderFilteredResults();
      });
    }


    // =========================================================================
    // FORM SUBMIT HANDLER
    // =========================================================================
    driverForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const customWeights = {
        location: parseInt(document.getElementById('weight-location').value),
        pay: parseInt(document.getElementById('weight-pay').value),
        operationType: parseInt(document.getElementById('weight-operationType').value),
        safety: parseInt(document.getElementById('weight-safety').value),
        turnover: parseInt(document.getElementById('weight-turnover').value),
        truckAge: parseInt(document.getElementById('weight-truckAge').value),
        fleetSize: 5, // Keep small
        qualityScore: 5 // Keep small
      };

      driverPrefs = {
        homeZip: document.getElementById('homeZip').value.trim(),
        maxDistance: parseInt(document.getElementById('maxDistance').value),
        minCPM: parseFloat(document.getElementById('minCPM').value) || 0,
        operationType: document.getElementById('operationType').value,
        maxTurnover: parseInt(document.getElementById('maxTurnover').value),
        maxTruckAge: parseInt(document.getElementById('maxTruckAge').value),
        fleetSize: document.querySelector('input[name="fleetSize"]:checked').value,
        driverName: document.getElementById('driverName').value.trim() || 'Driver',
        customWeights: customWeights,
        // Pass filter preference to backend if needed, or handle locally (we handle locally for now)
      };

      // Reset filters on new search
      filterMutualOnly = document.getElementById('showMutualOnly')?.checked || false;


      if (!driverPrefs.homeZip || driverPrefs.homeZip.length < 5) {
        showToast('Please enter a valid ZIP code');
        return;
      }

      showLoading();
      sendToWix('findMatches', driverPrefs);
    });

    // =========================================================================
    // ADVANCED UI LOGIC
    // =========================================================================

    // Toggle Priorities
    document.getElementById('togglePriorities').onclick = () => {
      const advanced = document.getElementById('advancedPriorities');
      const isHidden = window.getComputedStyle(advanced).display === 'none';
      advanced.style.display = isHidden ? 'block' : 'none';
      document.getElementById('togglePriorities').classList.toggle('active', isHidden);
    };

    // Weight Labels
    const weightInputs = ['location', 'pay', 'operationType', 'safety', 'turnover', 'truckAge'];
    weightInputs.forEach(id => {
      const input = document.getElementById(`weight-${id}`);
      const valLabel = document.getElementById(`weight-val-${id}`);

      const updateLabel = () => {
        const val = parseInt(input.value);
        let text = 'Normal';
        if (val >= 40) text = 'Critical';
        else if (val >= 30) text = 'High';
        else if (val >= 15) text = 'Standard';
        else if (val >= 5) text = 'Low';
        else text = 'Ignored';
        valLabel.textContent = text;
      };

      input.addEventListener('input', updateLabel);
      updateLabel();
    });

    // Reset Weights
    document.getElementById('resetWeights').onclick = () => {
      const defaults = { location: 25, pay: 20, operationType: 15, safety: 10, turnover: 12, truckAge: 8 };
      Object.entries(defaults).forEach(([id, val]) => {
        const input = document.getElementById(`weight-${id}`);
        input.value = val;
        input.dispatchEvent(new Event('input'));
      });
    };

    resetBtn.addEventListener('click', () => {
      resultsSection.classList.remove('active');
      formSection.style.display = 'block';
      driverForm.reset();
      document.getElementById('fleetAny').checked = true;
      if (upsellBanner) upsellBanner.style.display = 'none';
      if (premiumBanner) premiumBanner.style.display = 'none';
      currentMatches = [];
    });
    // =========================================================================
    // MESSAGE LISTENER - ENHANCED FOR PREMIUM (HARDENED)
    // =========================================================================
    window.addEventListener('message', (event) => {
      // SECURITY: Validate origin - must come from parent frame
      if (!isValidOrigin(event)) return;

      const msg = event.data;

      // SECURITY: Validate message schema
      if (!validateMessageSchema(msg)) return;

      // Validate and log inbound message
      validateInboundMessage(msg.type);
      logMessageFlow('in', msg.type, msg.data);

      switch (msg.type) {
        case 'matchResults':
          // Covers both sync (Airtable) and async (Option B) result delivery
          stopAsyncPolling && stopAsyncPolling();
          if (window._asyncStepTimer) { clearInterval(window._asyncStepTimer); window._asyncStepTimer = null; }
          showResults(msg.data);
          break;

        case 'searchJobStarted':
          // Option B async search kicked off — start polling loop
          if (window._handleSearchJobStarted) window._handleSearchJobStarted(msg.data);
          break;

        case 'searchJobStatus':
          // Option B poll response — FAILED or still PROCESSING
          if (window._handleSearchJobStatus) window._handleSearchJobStatus(msg.data);
          break;

        case 'enrichmentUpdate':
          updateCardEnrichment(msg.data);
          break;

        case 'enrichmentComplete':
          console.log('✅ All enrichments complete:', msg.data);
          // Clean up any cards still stuck in loading state — show on-demand button
          document.querySelectorAll('.ai-intel-loading').forEach(el => {
            const card = el.closest('[data-dot]');
            if (card) {
              const dot = card.getAttribute('data-dot');
              const container = card.querySelector('.ai-intel-section');
              if (container) {
                container.innerHTML = `
                  <div class="ai-intel-ondemand" id="ondemand-${dot}">
                    <button class="btn-get-ai-profile" onclick="window.retryEnrichment('${dot}')">
                      <i class="fa-solid fa-brain"></i> Get AI Profile
                    </button>
                    <div class="ai-intel-ondemand-sub">Pay data, driver reviews & hiring intel</div>
                  </div>
                `;
              }
            }
          });
          break;

        case 'interestLogged':
          console.log('📝 Interest response for:', msg.data?.carrierDOT, 'success:', msg.data?.success);
          if (msg.data?.carrierDOT) {
            const card = document.querySelector(`.match-card[data-dot="${msg.data.carrierDOT}"]`);
            const btn = card?.querySelector('.interested-btn, [disabled]');

            if (msg.data.success) {
              // SUCCESS - Add to applied set and update UI
              appliedCarrierDOTs.add(String(msg.data.carrierDOT));

              // Update the button in the UI
              if (btn) {
                btn.classList.remove('primary', 'interested-btn');
                btn.classList.add('applied-btn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Interest Saved';
              }
              // Add the applied tag if not present
              const tagsContainer = card?.querySelector('.match-tags');
              if (tagsContainer && !tagsContainer.querySelector('.match-tag.applied')) {
                tagsContainer.insertAdjacentHTML('afterbegin',
                  '<span class="match-tag applied"><i class="fa-solid fa-check-circle"></i> Applied</span>');
              }

              // Show the confirmation modal
              showInterestModal(pendingInterestCarrier);
            } else {
              // FAILURE - Reset button state and show error
              console.error('❌ Interest save failed:', msg.data.error);
              if (btn) {
                btn.classList.remove('applied-btn');
                btn.classList.add('primary', 'interested-btn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-heart"></i> I\'M INTERESTED';
              }
              showToast('Could not save interest: ' + (msg.data.error || 'Please try again'));
            }
          }
          break;

        case 'matchError':
          hideLoading();
          const errorMsg = msg.data?.error || 'Unknown error';
          // Show error in formSection — do NOT destroy resultsSection DOM
          const existingError = document.getElementById('searchErrorBanner');
          if (existingError) existingError.remove();
          formSection.style.display = 'block';
          const errorBanner = document.createElement('div');
          errorBanner.id = 'searchErrorBanner';
          errorBanner.style.cssText = 'text-align:center; padding:20px; margin-bottom:20px; background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:12px;';
          errorBanner.innerHTML = `
            <i class="fa-solid fa-triangle-exclamation" style="font-size:28px; color:#f59e0b; margin-bottom:8px;"></i>
            <h3 style="color:#f1f5f9; margin:0 0 4px; font-size:16px;">Search Unavailable</h3>
            <p style="color:#94a3b8; margin:0; font-size:13px;">${errorMsg}</p>
          `;
          formSection.insertBefore(errorBanner, formSection.firstChild);
          break;

        case 'pageReady':
          console.log('✅ Page code ready - initial state received');
          userStatus = msg.data.userStatus || userStatus;

          // Pre-fill zip or full profile from landing page redirect / saved profile
          if (msg.data.driverProfile && typeof prefillForm === 'function') {
            prefillForm(msg.data.driverProfile);
          } else if (msg.data.prefillZip) {
            const zipEl = document.getElementById('homeZip');
            if (zipEl) {
              zipEl.value = msg.data.prefillZip;
              zipEl.dispatchEvent(new Event('input'));
            }
          }

          // Initialize feature tracker
          if (msg.data.memberId && typeof FeatureTracker !== 'undefined' && !FeatureTracker.isInitialized()) {
            FeatureTracker.init({ userId: msg.data.memberId, userRole: 'driver' });
            FeatureTracker.view('ai_matching', { entryPoint: 'page_load' });
          }

          // Populate applied DOTs
          if (msg.data.appliedCarriers) {
            appliedCarrierDOTs.clear();
            msg.data.appliedCarriers.forEach(c => {
              if (c.carrierDOT) appliedCarrierDOTs.add(String(c.carrierDOT));
            });
            console.log('📋 Applied carriers loaded:', appliedCarrierDOTs.size);
          }
          break;

        case 'userStatusUpdate':
          userStatus = msg.data;
          console.log('User status updated:', userStatus);
          break;

        case 'loginSuccess':
          handleLoginSuccess(msg.data);
          break;

        case 'loginCancelled':
          console.log('Login cancelled by user');
          if (pendingApplicationData) {
            console.log('📋 Restoring application form after login cancel');
            pendingApplicationData = null;
            hideLoginPrompt();
            // Form data stays in DOM - user sees their filled-out form
          }
          break;

        case 'applicationSubmitted':
          handleApplicationSubmitted(msg.data);
          break;

        // Health check response
        case 'pong':
          connectionVerified = true;
          console.log('✅ CONNECTION VERIFIED: Velo↔HTML bridge operational', msg.data);
          break;

        // Profile-related messages
        case 'driverProfileLoaded':
          console.log('👤 Driver profile loaded:', msg.data?.success ? 'success' : 'failed');
          if (msg.data?.success && msg.data?.profile) {
            prefillForm(msg.data.profile);
          }
          break;

        case 'savedCarriersLoaded':
          console.log('📋 Saved carriers loaded:', msg.data?.totalCount || 0);
          // Future: populate saved carriers list
          break;

        case 'discoverabilityUpdated':
          console.log('👁️ Discoverability updated:', msg.data?.isDiscoverable);
          // Future: update UI toggle state
          break;

        // Real-time OCR result for form auto-fill
        case 'ocrResult':
          handleOCRResult(msg.data);
          break;

        case 'mutualInterestData':
          console.log('🤝 Mutual interest data received:', msg.data);
          if (msg.data && msg.data.interests) {
            mutualInterestMap.clear();
            msg.data.interests.forEach(i => {
              mutualInterestMap.set(String(i.carrierDOT), i);
            });

            // Update existing matches if they are already loaded
            if (allMatches.length > 0) {
              console.log('♻️ Merging mutual interests into existing matches...');
              allMatches.forEach(m => {
                const interest = mutualInterestMap.get(String(m.carrier?.DOT_NUMBER));
                if (interest) {
                  m.isMutualMatch = true;
                  m.mutualStrength = interest.strength || 'weak';
                  m.mutualSignals = interest.signals || ['viewed'];
                }
              });
              // Re-render
              renderFilteredResults();
            }
          }
          break;

        case 'matchExplanation':
          handleMatchExplanationResult(msg.data);
          break;

        default:
          console.warn('⚠️ Unhandled message type:', msg.type);
      }
    });

    // =========================================================================
    // INTEREST CONFIRMATION MODAL
    // =========================================================================
    const interestModal = document.getElementById('interestModal');
    const modalApplyBtn = document.getElementById('modalApplyBtn');
    const modalDashboardBtn = document.getElementById('modalDashboardBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    // Modal button handlers (showInterestModal/hideInterestModal defined in ai-matching-modals.js)
    if (modalApplyBtn) {
      modalApplyBtn.addEventListener('click', () => {
        // Open the application form modal
        showApplicationModal(pendingInterestCarrier);
        hideInterestModal();
      });
    }

    if (modalDashboardBtn) {
      modalDashboardBtn.addEventListener('click', () => {
        // TODO: Phase 4D - Navigate to dashboard
        sendToWix('navigateToSavedCarriers', {});
        hideInterestModal();
      });
    }

    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', hideInterestModal);
    }

    // Close modal when clicking outside
    if (interestModal) {
      interestModal.addEventListener('click', (e) => {
        if (e.target === interestModal) {
          hideInterestModal();
        }
      });
    }

    // =========================================================================
    // APPLICATION FORM MODAL
    // =========================================================================
    const applicationModal = document.getElementById('applicationModal');
    const applicationForm = document.getElementById('applicationForm');
    const applicationFormContent = document.getElementById('applicationFormContent');
    const applicationFormLoading = document.getElementById('applicationFormLoading');
    const applicationFormSuccess = document.getElementById('applicationFormSuccess');
    const appCancelBtn = document.getElementById('appCancelBtn');
    const appSubmitBtn = document.getElementById('appSubmitBtn');
    const appSuccessCloseBtn = document.getElementById('appSuccessCloseBtn');

    let currentApplicationCarrier = null;

    // OCR animation timeouts (global so they can be cleared on response)
    let appOcrTimeout = null;
    let appProfileTimeout = null;

    // File upload storage
    let uploadedFiles = {
      cdlFront: null,
      cdlBack: null,
      medCard: null,
      resume: null
    };

    // =========================================================================
    // OCR HANDLER INITIALIZATION - Fully Configurable
    // =========================================================================

    // Initialize OCR Handler with full configuration
    if (window.OCRHandler) {
      window.OCRHandler.init({
        // Required: message sending function
        sendMessage: sendToWix,

        // Required: file storage object
        fileStorage: uploadedFiles,

        // Required: document type configurations
        documents: {
          cdlFront: {
            type: 'CDL_FRONT',
            input: 'cdlFront',
            box: 'cdlFrontBox',
            nameDisplay: 'cdlFrontName'
          },
          cdlBack: {
            type: 'CDL_BACK',
            input: 'cdlBack',
            box: 'cdlBackBox',
            nameDisplay: 'cdlBackName'
          },
          medCard: {
            type: 'MED_CARD',
            input: 'medCard',
            box: 'medCardBox',
            nameDisplay: 'medCardName'
          }
        },

        // Optional: form field mappings for auto-fill
        formFields: {
          cdlNumber: 'cdlNumber',
          cdlExpiration: 'cdlExpiration',
          medCardExpiration: 'medCardExpiration'
        },

        // Optional: callback when OCR data is extracted
        onExtracted: (docType, extracted, fullResult) => {
          // Store additional data globally for profile use
          if (docType === 'CDL_FRONT' || docType === 'CDL_BACK') {
            if (extracted.fullName) window.extractedDriverName = extracted.fullName;
            if (extracted.cdlClass) window.extractedCdlClass = extracted.cdlClass;
            if (extracted.endorsements) window.extractedEndorsements = extracted.endorsements;
            if (extracted.state) window.extractedCdlState = extracted.state;
            if (extracted.dob) window.extractedDriverDOB = extracted.dob;
            // Store restrictions - "NONE" means no restrictions (favorable), empty/undefined means unknown
            window.extractedRestrictions = extracted.restrictionsString || 'NONE';
            console.log('✅ Restrictions captured from OCR:', window.extractedRestrictions);

            // Auto-fill new form fields from OCR
            // Parse fullName - CDLs use "LAST FIRST MIDDLE" format (last name first)
            if (extracted.fullName) {
              const fullName = extracted.fullName.trim();
              const firstNameField = document.getElementById('appFirstName');
              const lastNameField = document.getElementById('appLastName');
              let firstName = '', lastName = '';

              if (fullName.includes(',')) {
                // Format: "LAST, FIRST MIDDLE" (comma-separated)
                const [lastPart, firstPart] = fullName.split(',').map(s => s.trim());
                lastName = lastPart;
                // First part may be "FIRST MIDDLE" - take first word as first name
                const firstWords = firstPart.split(/\s+/);
                firstName = firstWords[0] || '';
                console.log('📋 Parsed name (comma format):', { lastName, firstName, raw: fullName });
              } else {
                // Format: "LAST FIRST MIDDLE" (space-separated, CDL standard - last name first!)
                const nameParts = fullName.split(/\s+/);
                if (nameParts.length >= 2) {
                  // CDL format: LAST FIRST MIDDLE
                  lastName = nameParts[0];        // First word = LAST name
                  firstName = nameParts[1];       // Second word = FIRST name
                  // nameParts[2+] would be middle name(s) - we don't capture those
                } else {
                  // Only one name - assume it's the last name
                  lastName = nameParts[0] || '';
                }
                console.log('📋 Parsed name (CDL space format):', { lastName, firstName, raw: fullName });
              }

              // Capitalize properly (GEORGE -> George)
              const capitalize = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
              firstName = capitalize(firstName);
              lastName = capitalize(lastName);

              if (firstNameField && !firstNameField.value && firstName) {
                firstNameField.value = firstName;
                firstNameField.style.backgroundColor = '#10b98120';
                setTimeout(() => firstNameField.style.backgroundColor = '', 1500);
              }
              if (lastNameField && !lastNameField.value && lastName) {
                lastNameField.value = lastName;
                lastNameField.style.backgroundColor = '#10b98120';
                setTimeout(() => lastNameField.style.backgroundColor = '', 1500);
              }
              console.log('✅ Name auto-filled:', { firstName, lastName });
            }

            // Auto-fill city/state/zip from OCR (if extracted from CDL address)
            if (extracted.city) {
              const cityField = document.getElementById('appCity');
              if (cityField && !cityField.value) {
                cityField.value = extracted.city;
                cityField.style.backgroundColor = '#10b98120';
                setTimeout(() => cityField.style.backgroundColor = '', 1500);
                console.log('✅ City auto-filled:', extracted.city);
              }
            }
            if (extracted.zip) {
              const zipField = document.getElementById('appZip');
              if (zipField && !zipField.value) {
                zipField.value = extracted.zip;
                zipField.style.backgroundColor = '#10b98120';
                setTimeout(() => zipField.style.backgroundColor = '', 1500);
                console.log('✅ ZIP auto-filled:', extracted.zip);
              }
            }
            if (extracted.state && !document.getElementById('appState').value) {
              const stateField = document.getElementById('appState');
              if (stateField) {
                stateField.value = extracted.state;
                stateField.style.backgroundColor = '#10b98120';
                setTimeout(() => stateField.style.backgroundColor = '', 1500);
                console.log('✅ State auto-filled:', extracted.state);
              }
            }
            // Auto-fill Date of Birth from OCR
            if (extracted.dob) {
              const dobField = document.getElementById('appDOB');
              if (dobField && !dobField.value) {
                dobField.value = extracted.dob; // Already in YYYY-MM-DD format from OCR
                dobField.style.backgroundColor = '#10b98120';
                setTimeout(() => dobField.style.backgroundColor = '', 1500);
                console.log('✅ DOB auto-filled:', extracted.dob);
              }
            }

            // Auto-fill CDL Class radio
            if (extracted.cdlClass) {
              const cdlClassRadio = document.querySelector(`input[name="cdlClass"][value="${extracted.cdlClass}"]`);
              if (cdlClassRadio && !document.querySelector('input[name="cdlClass"]:checked')) {
                cdlClassRadio.checked = true;
                cdlClassRadio.closest('.radio-chip').style.backgroundColor = '#10b98120';
                setTimeout(() => cdlClassRadio.closest('.radio-chip').style.backgroundColor = '', 1500);
                console.log('✅ CDL Class auto-filled:', extracted.cdlClass);
              }
            }

            // Auto-fill endorsements checkboxes
            if (extracted.endorsements && Array.isArray(extracted.endorsements)) {
              extracted.endorsements.forEach(endorsement => {
                const checkbox = document.querySelector(`input[name="endorsements"][value="${endorsement}"]`);
                if (checkbox && !checkbox.checked) {
                  checkbox.checked = true;
                  checkbox.closest('.checkbox-chip').style.backgroundColor = '#10b98120';
                  setTimeout(() => checkbox.closest('.checkbox-chip').style.backgroundColor = '', 1500);
                }
              });
              console.log('✅ Endorsements auto-filled:', extracted.endorsements);
            }

            // Auto-fill state dropdown
            if (extracted.state) {
              const stateSelect = document.getElementById('appState');
              if (stateSelect && !stateSelect.value) {
                stateSelect.value = extracted.state;
                stateSelect.style.backgroundColor = '#10b98120';
                setTimeout(() => stateSelect.style.backgroundColor = '', 1500);
                console.log('✅ State auto-filled:', extracted.state);
              }
            }
          }
          if (docType === 'MED_CARD') {
            if (extracted.examinerName) window.extractedExaminerName = extracted.examinerName;
            if (extracted.registryNumber) window.extractedRegistryNumber = extracted.registryNumber;
          }
        },

        // Optional: callback when OCR fails
        onError: (docType, error) => {
          console.warn(`OCR failed for ${docType}:`, error);
        }
      });

      // Set up file input listeners
      window.OCRHandler.setupFileInputListeners();
    }


    // =========================================================================
    // LOGIN PROMPT MODAL (for anonymous application submissions)
    // =========================================================================
    const loginPromptOverlay = document.getElementById('loginPromptOverlay');
    const loginPromptContent = document.getElementById('loginPromptContent');
    const loginPromptLoading = document.getElementById('loginPromptLoading');

    // Login prompt functions defined in ai-matching-modals.js

    // Login prompt button handlers
    const loginPromptSignup = document.getElementById('loginPromptSignup');
    const loginPromptLogin = document.getElementById('loginPromptLogin');
    const loginPromptClose = document.getElementById('loginPromptClose');

    if (loginPromptSignup) {
      loginPromptSignup.addEventListener('click', () => triggerLoginForApplication('signup'));
    }
    if (loginPromptLogin) {
      loginPromptLogin.addEventListener('click', () => triggerLoginForApplication('login'));
    }
    if (loginPromptClose) {
      loginPromptClose.addEventListener('click', () => {
        pendingApplicationData = null;
        hideLoginPrompt();
      });
    }

    // Close login prompt when clicking outside
    if (loginPromptOverlay) {
      loginPromptOverlay.addEventListener('click', (e) => {
        if (e.target === loginPromptOverlay) {
          pendingApplicationData = null;
          hideLoginPrompt();
        }
      });
    }

    // Application form button handlers
    if (appCancelBtn) {
      appCancelBtn.addEventListener('click', () => {
        // Store carrier data before hiding
        const carrierToRestore = currentApplicationCarrier;
        hideApplicationModal();
        // Re-show the interest modal
        if (carrierToRestore) {
          pendingInterestCarrier = carrierToRestore;
          showInterestModal(carrierToRestore);
        }
      });
    }

    if (appSubmitBtn) {
      appSubmitBtn.addEventListener('click', submitApplication);
    }

    // Work History: Show/hide employer sections based on companies count
    const companiesCountSelect = document.getElementById('appCompaniesCount');
    if (companiesCountSelect) {
      companiesCountSelect.addEventListener('change', function () {
        const count = parseInt(this.value) || 0;
        const employer1Section = document.getElementById('employer1Section');
        const employer2Section = document.getElementById('employer2Section');
        const employer3Section = document.getElementById('employer3Section');

        // Show employer 1 if at least 1 company selected
        if (employer1Section) {
          employer1Section.style.display = count >= 1 ? 'block' : 'none';
        }

        // Show employer 2 if at least 2 companies selected
        if (employer2Section) {
          employer2Section.style.display = count >= 2 ? 'block' : 'none';
        }

        // Show employer 3 if at least 3 companies selected
        if (employer3Section) {
          employer3Section.style.display = count >= 3 ? 'block' : 'none';
        }
      });
    }

    if (appSuccessCloseBtn) {
      appSuccessCloseBtn.addEventListener('click', hideApplicationModal);
    }

    // Close application modal when clicking outside
    if (applicationModal) {
      applicationModal.addEventListener('click', (e) => {
        if (e.target === applicationModal) {
          hideApplicationModal();
        }
      });
    }


    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    if (window.parent) {
      window.parent.postMessage({ type: 'carrierMatchingReady' }, '*');
      // Trigger connection health check after 500ms
      setTimeout(verifyConnection, 500);
    }

    console.log('LMDR Carrier Matching V7 (Message Validation) Ready');
    console.log('📋 Message Registry:', {
      inbound: MESSAGE_REGISTRY.inbound.length,
      outbound: MESSAGE_REGISTRY.outbound.length
    });

    // Initialize secure connection audit
    document.addEventListener('DOMContentLoaded', verifyConnection);

    // =========================================================================
    // APPLICATION STATUS TRACKER
    // =========================================================================

    // Tab Switching Logic
    const tabs = document.querySelectorAll('.nav-tab');
    // Existing variables (formSection, loadingSection, resultsSection) are used from existing scope
    const applicationsSection = document.getElementById('applicationsSection');
    const refreshAppsBtn = document.getElementById('refreshAppsBtn');

    if (tabs.length > 0) {
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Update active tab styling
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const tabName = tab.dataset.tab;
          if (tabName === 'find') {
            applicationsSection.classList.remove('active');

            // Restore visibility based on component state
            // formSection/loadingSection/resultsSection are defined in upper scope
            if (resultsSection && resultsSection.classList.contains('active')) {
              resultsSection.style.display = 'block';
              if (formSection) formSection.style.display = 'none';
            } else if (loadingSection && loadingSection.classList.contains('active')) {
              loadingSection.style.display = 'block';
              if (formSection) formSection.style.display = 'none';
            } else {
              if (formSection) formSection.style.display = 'block';
              // Ensure others are hidden
              if (resultsSection) resultsSection.style.display = 'none';
              if (loadingSection) loadingSection.style.display = 'none';
            }
          } else if (tabName === 'applications') {
            // Hide all find match elements but preserve 'active' class state
            if (formSection) formSection.style.display = 'none';
            if (loadingSection) loadingSection.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'none';

            applicationsSection.classList.add('active');
            loadApplications();
          }
        });
      });
    }

    // Listen for messages from parent page
    window.addEventListener('message', (event) => {
      const message = event.data;

      if (message.type === 'driverApplications') {
        console.log('✅ Received driver applications:', message.data);

        // Clear timeout if it exists
        if (window.appLoadTimeout) {
          clearTimeout(window.appLoadTimeout);
          window.appLoadTimeout = null;
        }

        renderApplications(message.data);
      }
    });

    if (refreshAppsBtn) {
      refreshAppsBtn.addEventListener('click', loadApplications);
    }


  </script>

  <!-- ═══ Voice & Agent Modules ═══ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/css/voice-agent.css">
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/js/voice-agent-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/js/voice-agent-bridge.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/driver/js/ai-matching-agent.js"></script>

</body>

</html>
