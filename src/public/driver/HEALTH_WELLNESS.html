<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trucker Health & Wellness | LMDR</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        lmdr: { blue: '#2563eb', dark: '#0f172a', yellow: '#fbbf24' }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        html.dark body { background: #0f172a; }
        .category-tab.active { @apply bg-lmdr-blue text-white shadow-md shadow-blue-200; }
        html.dark .category-tab.active { @apply bg-lmdr-blue text-white shadow-none; }
        .resource-card { @apply bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition overflow-hidden flex flex-col; }
        .tip-card { @apply bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-100 dark:border-yellow-700/30 rounded-xl p-4; }
    </style>
</head>

<body class="text-slate-800 dark:text-slate-200 antialiased min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-900 dark:text-white mb-1">Health & Wellness</h1>
                <p class="text-slate-500 dark:text-slate-400 font-medium">Stay fit, eat well, and live better on the road.</p>
            </div>
            <div class="flex gap-3 items-center">
                <button id="themeToggle" onclick="toggleTheme()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-sun"></i>
                </button>
                <button onclick="openSubmitTip()" class="bg-lmdr-blue text-white px-5 py-2.5 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 flex items-center gap-2">
                    <i class="fa-solid fa-lightbulb"></i> Add Tip
                </button>
            </div>
        </header>

        <!-- CATEGORIES -->
        <div class="flex flex-wrap gap-2 mb-8 overflow-x-auto pb-2">
            <button onclick="filterCategory('all')" class="category-tab active px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">All</button>
            <button onclick="filterCategory('exercise')" class="category-tab px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Exercise</button>
            <button onclick="filterCategory('nutrition')" class="category-tab px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Nutrition</button>
            <button onclick="filterCategory('mental_health')" class="category-tab px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Mental Health</button>
            <button onclick="filterCategory('sleep')" class="category-tab px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Sleep</button>
            <button onclick="filterCategory('telemedicine')" class="category-tab px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Telemedicine</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- MAIN CONTENT -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Featured (Hero) -->
                <div id="featured-section" class="hidden">
                    <!-- Injected -->
                </div>

                <!-- Resources Grid -->
                <div>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-lmdr-blue"></i> Latest Resources
                    </h2>
                    <div id="resources-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Injected -->
                        <div class="text-center py-10 col-span-full">
                            <i class="fa-solid fa-circle-notch fa-spin text-lmdr-blue text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIDEBAR -->
            <div class="space-y-8">
                <!-- Community Tips -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-slate-900 dark:text-white">Community Tips</h3>
                        <i class="fa-solid fa-users text-slate-300"></i>
                    </div>
                    <div id="tips-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <!-- Injected -->
                    </div>
                </div>

                <!-- Telemedicine Partners -->
                <div id="partners-container" class="space-y-4">
                     <!-- Injected -->
                </div>
            </div>
        </div>
    </div>

    <!-- ADD TIP MODAL -->
    <div id="tip-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full p-6 animate-fade-in">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Share a Health Tip</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Category</label>
                    <select id="tip-category" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-2.5">
                        <option value="exercise">Exercise</option>
                        <option value="nutrition">Nutrition</option>
                        <option value="mental_health">Mental Health</option>
                        <option value="sleep">Sleep</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Title</label>
                    <input type="text" id="tip-title" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-2.5" placeholder="Short title...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Your Tip</label>
                    <textarea id="tip-text" rows="4" maxlength="500" oninput="updateCharCount(this)" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-2.5" placeholder="Share your advice..."></textarea>
                    <div class="text-right text-xs text-slate-400 mt-1"><span id="char-count">0</span>/500</div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="document.getElementById('tip-modal').classList.add('hidden')" class="px-4 py-2 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700">Cancel</button>
                <button onclick="submitTip()" class="px-5 py-2 bg-lmdr-blue text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200/50">Submit</button>
            </div>
        </div>
    </div>

    <!-- RESOURCE MODAL -->
    <div id="resource-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col md:flex-row animate-fade-in overflow-hidden">
            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-start">
                    <div>
                        <span id="res-category" class="text-xs font-bold uppercase tracking-wider text-lmdr-blue mb-1 block">Category</span>
                        <h2 id="res-title" class="text-2xl font-black text-slate-900 dark:text-white">Title</h2>
                    </div>
                    <button onclick="closeResource()" class="md:hidden text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 overflow-y-auto markdown-body dark:prose-invert flex-1" id="res-content">
                    <!-- Content -->
                </div>
                <div class="p-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <button onclick="markHelpful()" class="flex items-center gap-2 text-slate-500 hover:text-lmdr-blue font-bold transition">
                        <i class="fa-regular fa-thumbs-up"></i> Helpful
                    </button>
                    <div class="flex gap-2">
                        <button onclick="shareResource('twitter')" class="text-slate-400 hover:text-[#1DA1F2]"><i class="fa-brands fa-twitter text-xl"></i></button>
                        <button onclick="shareResource('facebook')" class="text-slate-400 hover:text-[#4267B2]"><i class="fa-brands fa-facebook text-xl"></i></button>
                        <button onclick="shareResource('copy')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-link text-xl"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar (Related) -->
            <div class="w-full md:w-80 bg-slate-50 dark:bg-slate-900 border-l border-slate-100 dark:border-slate-700 p-6 overflow-y-auto hidden md:block">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-900 dark:text-white">Related</h3>
                    <button onclick="closeResource()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="related-resources" class="space-y-4">
                    <!-- Injected -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE & BRIDGE
        // ==========================================
        let currentCategory = 'all';
        let currentResource = null;
        let allResources = []; // Cache for related suggestions

        function sendToVelo(type, data = {}) {
            if (window.parent) window.parent.postMessage({ type, data }, '*');
        }

        window.onmessage = (event) => {
            const { type, data } = event.data || {};
            if (type === 'resourcesData') {
                allResources = data; // Cache
                renderResources(data);
            }
            if (type === 'tipsData') renderTips(data);
            if (type === 'resourceDetail') openResourceModal(data);
            if (type === 'partnersData') renderPartners(data);
        };

        // ==========================================
        // RENDER LOGIC
        // ==========================================
        
        function filterCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('resources-grid').innerHTML = '<div class="text-center py-10 col-span-full"><i class="fa-solid fa-circle-notch fa-spin text-lmdr-blue text-2xl"></i></div>';
            
            sendToVelo('getResources', { category: cat });
        }

        function renderResources(items) {
            const grid = document.getElementById('resources-grid');
            if(!items || items.length === 0) {
                grid.innerHTML = '<div class="text-center py-10 col-span-full text-slate-400">No resources found.</div>';
                return;
            }

            grid.innerHTML = items.map(item => `
                <div class="resource-card group cursor-pointer" onclick="viewResource('${item.slug}')">
                    <div class="h-40 bg-slate-200 overflow-hidden relative">
                        <img src="${item.thumbnail?.url || 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=500'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                        <div class="absolute top-2 left-2 bg-black/60 backdrop-blur-sm text-white px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">
                            ${item.category?.replace('_', ' ') || 'Health'}
                        </div>
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <h3 class="font-bold text-lg text-slate-900 dark:text-white mb-2 line-clamp-2 group-hover:text-lmdr-blue transition">${item.title}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 line-clamp-3 mb-4 flex-1">${item.summary || ''}</p>
                        <div class="flex justify-between items-center text-xs text-slate-400 border-t border-slate-50 dark:border-slate-700 pt-3 mt-auto">
                            <span><i class="fa-regular fa-clock mr-1"></i> 5 min read</span>
                            <span><i class="fa-regular fa-thumbs-up mr-1"></i> ${item.helpful_count || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTips(items) {
            const list = document.getElementById('tips-list');
            if(!items || items.length === 0) {
                list.innerHTML = '<div class="text-center py-4 text-slate-400 text-sm">No tips yet. Add one!</div>';
                return;
            }

            list.innerHTML = items.map(tip => `
                <div class="tip-card">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-quote-left text-yellow-400 text-xl flex-none"></i>
                        <div>
                            <p class="text-sm text-slate-700 dark:text-slate-300 italic mb-2">"${tip.tip_text}"</p>
                            <div class="flex justify-between items-center text-xs">
                                <div class="flex items-center gap-1.5">
                                    <span class="font-bold text-slate-900 dark:text-white">${tip.author_name || 'Driver'}</span>
                                    ${tip.author_level ? `<span class="bg-lmdr-yellow/20 text-yellow-700 dark:text-yellow-400 px-1.5 py-0.5 rounded text-[10px] font-black uppercase tracking-widest">Lvl ${tip.author_level}</span>` : ''}
                                </div>
                                <span class="text-slate-400 bg-white dark:bg-slate-800 px-2 py-0.5 rounded-full border border-slate-100 dark:border-slate-700">
                                    <i class="fa-solid fa-heart text-red-400 mr-1"></i> ${tip.helpful_count || 0}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPartners(partners) {
            const container = document.getElementById('partners-container');
            if (!partners || partners.length === 0) return;

            container.innerHTML = partners.map(partner => `
                <div class="bg-gradient-to-br from-${partner.color || 'blue'}-500 to-${partner.color || 'blue'}-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                    <i class="fa-solid fa-${partner.icon || 'star'} absolute -bottom-4 -right-4 text-8xl opacity-20"></i>
                    <h3 class="font-bold text-lg mb-2 relative z-10">${partner.name}</h3>
                    <p class="text-white/80 text-sm mb-4 relative z-10">${partner.description}</p>
                    <a href="${partner.url}" target="_blank" class="block w-full bg-white text-${partner.color || 'blue'}-600 text-center py-2.5 rounded-xl font-bold text-sm hover:bg-opacity-90 transition relative z-10">
                        Visit ${partner.name}
                    </a>
                </div>
            `).join('');
        }

        // ==========================================
        // MODAL LOGIC
        // ==========================================

        function viewResource(slug) {
            sendToVelo('getResourceDetail', { slug });
        }

        function openResourceModal(resource) {
            currentResource = resource;
            document.getElementById('res-category').textContent = resource.category?.replace('_', ' ');
            document.getElementById('res-title').textContent = resource.title;
            document.getElementById('res-content').innerHTML = marked.parse(resource.content || '');
            
            // Render related (simple suggestion: same category, not current)
            const related = allResources
                .filter(r => r.category === resource.category && r.slug !== resource.slug)
                .slice(0, 3);
                
            document.getElementById('related-resources').innerHTML = related.map(r => `
                <div class="cursor-pointer group" onclick="viewResource('${r.slug}')">
                    <div class="h-24 bg-slate-200 rounded-lg overflow-hidden mb-2">
                         <img src="${r.thumbnail?.url || 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=500'}" class="w-full h-full object-cover group-hover:scale-105 transition">
                    </div>
                    <h4 class="font-bold text-sm text-slate-900 dark:text-white line-clamp-2 group-hover:text-lmdr-blue transition">${r.title}</h4>
                </div>
            `).join('');
            
            document.getElementById('resource-modal').classList.remove('hidden');
        }

        function closeResource() {
            document.getElementById('resource-modal').classList.add('hidden');
            currentResource = null;
        }

        function markHelpful() {
            if(currentResource) {
                sendToVelo('markHelpful', { id: currentResource._id });
                // Optimistic UI update could go here
            }
        }
        
        function shareResource(platform) {
            const url = window.location.href; // In real Velo, this would be the dynamic page URL
            const text = `Check out this resource on LMDR: ${currentResource.title}`;
            
            if (platform === 'twitter') {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            } else if (platform === 'facebook') {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
            } else if (platform === 'copy') {
                navigator.clipboard.writeText(url).then(() => alert('Link copied!'));
            }
        }

        function openSubmitTip() {
            document.getElementById('tip-modal').classList.remove('hidden');
        }
        
        function updateCharCount(textarea) {
            document.getElementById('char-count').textContent = textarea.value.length;
        }

        function submitTip() {
            const category = document.getElementById('tip-category').value;
            const title = document.getElementById('tip-title').value;
            const text = document.getElementById('tip-text').value;

            if(!title || !text) return alert('Please fill in all fields');
            if(text.length > 500) return alert('Tip is too long (max 500 chars)');

            sendToVelo('submitTip', { category, title, tip_text: text });
            document.getElementById('tip-modal').classList.add('hidden');
            
            // Reset form
            document.getElementById('tip-title').value = '';
            document.getElementById('tip-text').value = '';
            document.getElementById('char-count').textContent = '0';
        }

        // ==========================================
        // THEME
        // ==========================================
        const THEME_KEY = 'lmdr-driver-theme';
        function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const theme = saved || 'light';
            if (theme === 'dark') document.documentElement.classList.add('dark');
            updateThemeIcon(theme);
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
            updateThemeIcon(isDark ? 'dark' : 'light');
        }
        function updateThemeIcon(theme) {
            const icon = document.querySelector('#themeToggle i');
            if (icon) icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        initTheme();
        window.onload = () => {
            sendToVelo('ready');
            sendToVelo('getResources', { category: 'all' });
            sendToVelo('getTips', { category: 'all' });
            sendToVelo('getPartners');
        };
    </script>
</body>
</html>