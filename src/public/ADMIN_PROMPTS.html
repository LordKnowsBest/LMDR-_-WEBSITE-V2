<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>LMDR Prompt Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8b5cf6",
                        "primary-dark": "#7c3aed",
                        "background-dark": "#0f172a",
                        "background-light": "#f8fafc",
                        "surface-dark": "#1e293b",
                        "surface-light": "#ffffff",
                        "surface-darker": "#0f172a",
                        "border-dark": "#334155",
                        "border-light": "#e2e8f0",
                        "text-muted": "#94a3b8",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"]
                    },
                },
            },
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .prompt-card { transition: all 0.2s; }
        .prompt-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(139, 92, 246, 0.2); }

        /* Code editor styling */
        .code-editor {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            tab-size: 2;
        }

        /* Light mode overrides */
        html.light .bg-surface-dark { background-color: #ffffff; }
        html.light .bg-surface-darker { background-color: #f1f5f9; }
        html.light .border-border-dark { border-color: #e2e8f0; }
        html.light .text-text-muted { color: #64748b; }
        html.light .bg-background-dark { background-color: #f8fafc; }
        html.light .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        html.light .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; }
    </style>
</head>
<body class="font-display antialiased transition-colors duration-300 bg-background-dark text-white">

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

<!-- Main Container -->
<div class="flex flex-col h-full">

    <!-- Header -->
    <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-primary text-[28px]">psychology</span>
                <div>
                    <h1 class="text-xl md:text-2xl font-black tracking-tight">Prompt Library</h1>
                    <p class="text-xs md:text-sm text-text-muted">Manage AI prompts (Super Admin)</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" class="flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark hover:bg-slate-700 transition-colors" title="Toggle theme">
                    <span id="themeIconSun" class="material-symbols-outlined text-[20px] text-amber-400 hidden">light_mode</span>
                    <span id="themeIconMoon" class="material-symbols-outlined text-[20px] text-slate-400">dark_mode</span>
                </button>
                <button onclick="openCreateModal()" class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg font-medium text-sm transition-colors">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    New Prompt
                </button>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="flex-shrink-0 px-4 md:px-6 py-3 border-b border-border-dark bg-surface-dark">
        <div class="flex flex-wrap items-center gap-3">
            <!-- Category Filter -->
            <select id="categoryFilter" onchange="filterPrompts()" class="bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                <option value="">All Categories</option>
            </select>

            <!-- Status Filter -->
            <select id="statusFilter" onchange="filterPrompts()" class="bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>

            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" placeholder="Search prompts..."
                    class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary"
                    oninput="debounceSearch()">
            </div>

            <!-- Seed Defaults Button -->
            <button onclick="seedDefaults()" class="flex items-center gap-2 px-3 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg font-medium text-sm transition-colors">
                <span class="material-symbols-outlined text-[16px]">download</span>
                Seed Defaults
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto scrollbar-thin">
        <div class="px-4 md:px-6 py-4 md:py-6">

            <!-- Prompts Grid -->
            <div id="promptsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center py-12 col-span-full text-text-muted">
                    Loading prompts...
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Edit/Create Modal -->
<div id="promptModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="absolute inset-4 md:inset-8 lg:inset-16 bg-surface-dark rounded-2xl border border-border-dark overflow-hidden flex flex-col">
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-border-dark">
            <h2 id="modalTitle" class="text-lg font-bold">Create Prompt</h2>
            <button onclick="closeModal()" class="text-text-muted hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto scrollbar-thin p-6">
            <form id="promptForm" class="space-y-4">
                <input type="hidden" id="editingPromptId" value="">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Prompt ID -->
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-1">Prompt ID</label>
                        <input type="text" id="promptIdInput" placeholder="carrier_synthesis"
                            class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary font-mono">
                    </div>

                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-1">Name</label>
                        <input type="text" id="promptNameInput" placeholder="Carrier Synthesis"
                            class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Category -->
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-1">Category</label>
                        <select id="promptCategoryInput" class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                        </select>
                    </div>

                    <!-- Provider -->
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-1">Provider</label>
                        <select id="promptProviderInput" class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="groq">Groq</option>
                            <option value="perplexity">Perplexity</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="mistral">Mistral</option>
                            <option value="cohere">Cohere</option>
                        </select>
                    </div>

                    <!-- Model -->
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-1">Model</label>
                        <input type="text" id="promptModelInput" placeholder="claude-sonnet-4-20250514"
                            class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary font-mono">
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-text-muted mb-1">Description</label>
                    <input type="text" id="promptDescInput" placeholder="What this prompt does..."
                        class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                </div>

                <!-- System Prompt -->
                <div>
                    <label class="block text-sm font-medium text-text-muted mb-1">System Prompt</label>
                    <textarea id="systemPromptInput" rows="8" placeholder="You are a..."
                        class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary code-editor resize-y"></textarea>
                </div>

                <!-- User Prompt Template -->
                <div>
                    <label class="block text-sm font-medium text-text-muted mb-1">
                        User Prompt Template
                        <span class="text-xs text-violet-400">(Use {{variable}} for placeholders)</span>
                    </label>
                    <textarea id="userPromptInput" rows="6" placeholder="Analyze {{carrierName}} with DOT {{dotNumber}}..."
                        class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary code-editor resize-y"></textarea>
                </div>

                <!-- Variables -->
                <div>
                    <label class="block text-sm font-medium text-text-muted mb-1">Variables (comma-separated)</label>
                    <input type="text" id="promptVarsInput" placeholder="carrierName, dotNumber, location"
                        class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary font-mono">
                </div>

                <!-- Change Note (for updates) -->
                <div id="changeNoteWrapper" class="hidden">
                    <label class="block text-sm font-medium text-text-muted mb-1">Change Note</label>
                    <input type="text" id="changeNoteInput" placeholder="Describe what changed..."
                        class="w-full bg-surface-darker border border-border-dark rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary">
                </div>
            </form>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-border-dark">
            <button onclick="closeModal()" class="px-4 py-2 text-text-muted hover:text-white font-medium text-sm transition-colors">
                Cancel
            </button>
            <button onclick="savePrompt()" class="px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg font-medium text-sm transition-colors">
                Save Prompt
            </button>
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div id="versionModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeVersionModal()"></div>
    <div class="absolute inset-8 md:inset-16 bg-surface-dark rounded-2xl border border-border-dark overflow-hidden flex flex-col">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border-dark">
            <h2 class="text-lg font-bold">Version History</h2>
            <button onclick="closeVersionModal()" class="text-text-muted hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="versionList" class="flex-1 overflow-y-auto scrollbar-thin p-6">
            Loading versions...
        </div>
    </div>
</div>

<script>
    // ============================================
    // STATE
    // ============================================
    let state = {
        prompts: [],
        categories: [],
        selectedPrompt: null,
        isEditing: false
    };

    const VALID_ACTIONS = [
        'promptsLoaded', 'promptLoaded', 'promptCreated', 'promptUpdated',
        'promptDeleted', 'promptRestored', 'promptRolledBack',
        'categoriesLoaded', 'seedComplete', 'actionError', 'init'
    ];

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('message', handleMessage);

    document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        sendToVelo({ action: 'getCategories' });
        sendToVelo({ action: 'getPrompts' });
    });

    function sendToVelo(message) {
        window.parent.postMessage(message, '*');
    }

    // ============================================
    // THEME
    // ============================================
    const THEME_KEY = 'lmdr-admin-theme';

    function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        applyTheme(saved || 'dark');
    }

    function applyTheme(theme) {
        const html = document.documentElement;
        const body = document.body;
        if (theme === 'dark') {
            html.classList.add('dark');
            html.classList.remove('light');
            body.classList.add('bg-background-dark', 'text-white');
            body.classList.remove('bg-background-light', 'text-slate-800');
            document.getElementById('themeIconSun').classList.remove('hidden');
            document.getElementById('themeIconMoon').classList.add('hidden');
        } else {
            html.classList.remove('dark');
            html.classList.add('light');
            body.classList.remove('bg-background-dark', 'text-white');
            body.classList.add('bg-background-light', 'text-slate-800');
            document.getElementById('themeIconSun').classList.add('hidden');
            document.getElementById('themeIconMoon').classList.remove('hidden');
        }
    }

    function toggleTheme() {
        const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, newTheme);
        applyTheme(newTheme);
    }

    // ============================================
    // MESSAGE HANDLING
    // ============================================
    function handleMessage(event) {
        const data = event.data;
        if (!data || !VALID_ACTIONS.includes(data.action)) return;

        switch (data.action) {
            case 'init':
                sendToVelo({ action: 'getPrompts' });
                break;
            case 'categoriesLoaded':
                state.categories = data.payload;
                renderCategoryFilters();
                break;
            case 'promptsLoaded':
                state.prompts = data.payload.items;
                state.categories = data.payload.categories;
                renderCategoryFilters();
                renderPrompts();
                break;
            case 'promptLoaded':
                state.selectedPrompt = data.payload.prompt;
                showVersions(data.payload.versions);
                break;
            case 'promptCreated':
            case 'promptUpdated':
            case 'promptRestored':
                showToast('Prompt saved successfully', 'success');
                closeModal();
                break;
            case 'promptDeleted':
                showToast('Prompt deactivated', 'success');
                break;
            case 'seedComplete':
                showToast(`Seeded ${data.payload.created} prompts (${data.payload.skipped} skipped)`, 'success');
                break;
            case 'actionError':
                showToast(data.message || 'An error occurred', 'error');
                break;
        }
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderCategoryFilters() {
        const select = document.getElementById('categoryFilter');
        const modalSelect = document.getElementById('promptCategoryInput');

        const options = state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

        select.innerHTML = `<option value="">All Categories</option>${options}`;
        modalSelect.innerHTML = options;
    }

    function renderPrompts() {
        const container = document.getElementById('promptsGrid');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;

        let filtered = state.prompts;

        if (search) {
            filtered = filtered.filter(p =>
                p.name.toLowerCase().includes(search) ||
                p.promptId.toLowerCase().includes(search) ||
                p.description?.toLowerCase().includes(search)
            );
        }

        if (category) {
            filtered = filtered.filter(p => p.category === category);
        }

        if (status === 'active') {
            filtered = filtered.filter(p => p.isActive);
        } else if (status === 'inactive') {
            filtered = filtered.filter(p => !p.isActive);
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 col-span-full text-text-muted">
                    <span class="material-symbols-outlined text-4xl mb-2 block">search_off</span>
                    No prompts found
                </div>
            `;
            return;
        }

        container.innerHTML = filtered.map(prompt => {
            const categoryInfo = state.categories.find(c => c.id === prompt.category) || { name: prompt.category };
            const statusColor = prompt.isActive ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400';
            const statusText = prompt.isActive ? 'Active' : 'Inactive';

            return `
                <div class="prompt-card bg-surface-dark border border-border-dark rounded-xl p-4 cursor-pointer" onclick="openEditModal('${prompt.promptId}')">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold truncate">${prompt.name}</h3>
                            <p class="text-xs text-text-muted font-mono">${prompt.promptId}</p>
                        </div>
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${statusColor}">${statusText}</span>
                    </div>

                    <p class="text-sm text-text-muted mb-3 line-clamp-2">${prompt.description || 'No description'}</p>

                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-2 py-0.5 bg-violet-500/20 text-violet-400 rounded text-[10px] font-medium">${categoryInfo.name}</span>
                        <span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded text-[10px] font-medium">${prompt.provider}</span>
                    </div>

                    <div class="flex items-center justify-between text-xs text-text-muted">
                        <span>v${prompt.version}</span>
                        <span>${formatDate(prompt.updatedAt)}</span>
                    </div>

                    <div class="flex items-center gap-2 mt-3 pt-3 border-t border-border-dark">
                        <button onclick="event.stopPropagation(); viewVersions('${prompt.promptId}')" class="flex-1 py-1.5 text-xs font-medium text-violet-400 hover:bg-violet-500/10 rounded transition-colors">
                            <span class="material-symbols-outlined text-[14px] align-middle mr-1">history</span>
                            History
                        </button>
                        ${prompt.isActive ? `
                            <button onclick="event.stopPropagation(); deletePrompt('${prompt.promptId}')" class="flex-1 py-1.5 text-xs font-medium text-rose-400 hover:bg-rose-500/10 rounded transition-colors">
                                <span class="material-symbols-outlined text-[14px] align-middle mr-1">delete</span>
                                Deactivate
                            </button>
                        ` : `
                            <button onclick="event.stopPropagation(); restorePrompt('${prompt.promptId}')" class="flex-1 py-1.5 text-xs font-medium text-emerald-400 hover:bg-emerald-500/10 rounded transition-colors">
                                <span class="material-symbols-outlined text-[14px] align-middle mr-1">restore</span>
                                Restore
                            </button>
                        `}
                    </div>
                </div>
            `;
        }).join('');
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openCreateModal() {
        state.isEditing = false;
        document.getElementById('modalTitle').textContent = 'Create Prompt';
        document.getElementById('editingPromptId').value = '';
        document.getElementById('promptIdInput').disabled = false;
        document.getElementById('changeNoteWrapper').classList.add('hidden');

        // Clear form
        document.getElementById('promptForm').reset();

        document.getElementById('promptModal').classList.remove('hidden');
    }

    function openEditModal(promptId) {
        const prompt = state.prompts.find(p => p.promptId === promptId);
        if (!prompt) return;

        state.isEditing = true;
        state.selectedPrompt = prompt;

        document.getElementById('modalTitle').textContent = 'Edit Prompt';
        document.getElementById('editingPromptId').value = promptId;
        document.getElementById('promptIdInput').value = prompt.promptId;
        document.getElementById('promptIdInput').disabled = true;
        document.getElementById('promptNameInput').value = prompt.name;
        document.getElementById('promptCategoryInput').value = prompt.category;
        document.getElementById('promptProviderInput').value = prompt.provider;
        document.getElementById('promptModelInput').value = prompt.model;
        document.getElementById('promptDescInput').value = prompt.description || '';
        document.getElementById('systemPromptInput').value = prompt.systemPrompt;
        document.getElementById('userPromptInput').value = prompt.userPromptTemplate || '';
        document.getElementById('promptVarsInput').value = (prompt.variables || []).join(', ');
        document.getElementById('changeNoteWrapper').classList.remove('hidden');
        document.getElementById('changeNoteInput').value = '';

        document.getElementById('promptModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('promptModal').classList.add('hidden');
    }

    function savePrompt() {
        const promptData = {
            promptId: document.getElementById('promptIdInput').value.trim(),
            name: document.getElementById('promptNameInput').value.trim(),
            category: document.getElementById('promptCategoryInput').value,
            provider: document.getElementById('promptProviderInput').value,
            model: document.getElementById('promptModelInput').value.trim(),
            description: document.getElementById('promptDescInput').value.trim(),
            systemPrompt: document.getElementById('systemPromptInput').value.trim(),
            userPromptTemplate: document.getElementById('userPromptInput').value.trim(),
            variables: document.getElementById('promptVarsInput').value.split(',').map(v => v.trim()).filter(Boolean)
        };

        if (!promptData.promptId || !promptData.name || !promptData.systemPrompt) {
            showToast('Please fill in required fields', 'error');
            return;
        }

        if (state.isEditing) {
            const changeNote = document.getElementById('changeNoteInput').value.trim();
            sendToVelo({
                action: 'updatePrompt',
                promptId: document.getElementById('editingPromptId').value,
                updates: promptData,
                changeNote
            });
        } else {
            sendToVelo({ action: 'createPrompt', promptData });
        }
    }

    // ============================================
    // VERSION HISTORY
    // ============================================
    function viewVersions(promptId) {
        sendToVelo({ action: 'getPrompt', promptId });
        document.getElementById('versionModal').classList.remove('hidden');
    }

    function showVersions(versions) {
        const container = document.getElementById('versionList');

        if (!versions || versions.length === 0) {
            container.innerHTML = '<p class="text-text-muted">No version history</p>';
            return;
        }

        container.innerHTML = versions.map(v => `
            <div class="p-4 bg-surface-darker rounded-lg mb-3 border border-border-dark">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold text-violet-400">Version ${v.version}</span>
                    <span class="text-xs text-text-muted">${formatDate(v.createdAt)}</span>
                </div>
                <p class="text-sm text-text-muted mb-2">${v.changeNote || 'No change note'}</p>
                <p class="text-xs text-text-muted">By: ${v.createdBy}</p>
                <button onclick="rollbackTo('${v.promptId}', ${v.version})" class="mt-2 px-3 py-1 bg-amber-600 hover:bg-amber-700 rounded text-xs font-medium transition-colors">
                    Rollback to this version
                </button>
            </div>
        `).join('');
    }

    function closeVersionModal() {
        document.getElementById('versionModal').classList.add('hidden');
    }

    function rollbackTo(promptId, version) {
        if (confirm(`Rollback to version ${version}?`)) {
            sendToVelo({ action: 'rollbackPrompt', promptId, version });
            closeVersionModal();
        }
    }

    // ============================================
    // ACTIONS
    // ============================================
    function filterPrompts() {
        renderPrompts();
    }

    let searchTimeout;
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterPrompts, 300);
    }

    function deletePrompt(promptId) {
        if (confirm('Deactivate this prompt?')) {
            sendToVelo({ action: 'deletePrompt', promptId });
        }
    }

    function restorePrompt(promptId) {
        sendToVelo({ action: 'restorePrompt', promptId });
    }

    function seedDefaults() {
        if (confirm('Seed default prompts? (Existing prompts will not be overwritten)')) {
            sendToVelo({ action: 'seedDefaults' });
        }
    }

    // ============================================
    // HELPERS
    // ============================================
    function formatDate(date) {
        if (!date) return '';
        return new Date(date).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const id = 'toast-' + Date.now();
        const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-rose-600' : 'bg-primary';
        const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';

        const toast = document.createElement('div');
        toast.id = id;
        toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-lg ${bgColor} shadow-lg`;
        toast.innerHTML = `
            <span class="material-symbols-outlined text-[20px]">${icon}</span>
            <span class="text-sm font-medium flex-1">${message}</span>
            <button onclick="document.getElementById('${id}').remove()" class="text-white/80 hover:text-white">
                <span class="material-symbols-outlined text-[18px]">close</span>
            </button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }
</script>
</body>
</html>
