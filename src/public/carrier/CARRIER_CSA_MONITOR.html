<!DOCTYPE html>
<!--
================================================================================
CARRIER CSA MONITOR
================================================================================
-->
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSA Monitor | VelocityMatch</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lmdr: {
                            dark: '#0f172a',
                            blue: '#2563eb',
                            yellow: '#fbbf24',
                            canvas: '#f8fafc',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/gh/LordKnowsBest/LMDR-_-WEBSITE-V2@main/src/public/theme-utils.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Carrier Sidebar */
        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-text {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .collapsed .fade-text {
            opacity: 0;
            pointer-events: none;
            display: none;
        }

        .collapsed .sidebar-header {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        .collapsed .logo-text {
            display: none;
        }

        .sidebar-link {
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .sidebar-link.active {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.2) 0%, transparent 100%);
            border-left: 4px solid #2563eb;
            color: white;
            text-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        .sidebar-link.active i {
            color: #60a5fa;
            filter: drop-shadow(0 0 5px rgba(37, 99, 235, 0.8));
        }

        .thin-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .thin-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            z-index: 0;
            opacity: 0.6;
            animation: float-blob 10s infinite ease-in-out;
        }

        .blob-1 {
            top: -10%;
            left: -20%;
            width: 200px;
            height: 200px;
            background: #2563eb;
        }

        .blob-2 {
            bottom: 10%;
            right: -20%;
            width: 180px;
            height: 180px;
            background: #6366f1;
            animation-delay: -5s;
        }

        @keyframes float-blob {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(15px, 30px);
            }
        }
    </style>
</head>

<body class="bg-lmdr-canvas h-screen flex overflow-hidden">

    <!-- CARRIER SIDEBAR -->
    <div class="relative h-full flex flex-col z-50 bg-slate-900 overflow-hidden shadow-2xl sidebar-transition"
        id="sidebar-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <aside id="sidebar"
            class="w-56 text-slate-300 flex flex-col h-full sidebar-transition group relative z-10 bg-slate-900/60 backdrop-blur-xl border-r border-white/5">
            <button onclick="toggleSidebar()"
                class="absolute -right-3 top-16 bg-lmdr-blue text-white w-6 h-6 rounded-full flex items-center justify-center shadow-lg border border-slate-900 hover:scale-110 transition-transform z-50 opacity-0 group-hover:opacity-100">
                <i class="fa-solid fa-chevron-left text-[10px]" id="toggleIcon"></i>
            </button>
            <div class="h-14 flex items-center px-5 border-b border-white/10 sidebar-header transition-all">
                <div class="flex items-center gap-3">
                    <div
                        class="h-8 w-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex-none flex items-center justify-center text-white font-black text-sm shadow-lg shadow-blue-500/30 ring-1 ring-white/20">
                        VM</div>
                    <div class="logo-text fade-text">
                        <h1 class="font-bold text-white text-sm tracking-tight">Velocity<span
                                class="text-blue-400">Match</span></h1>
                        <p class="text-[10px] text-blue-200/70 uppercase font-bold tracking-wider">Carrier OS</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto thin-scroll py-4 space-y-1">
                <a href="#"
                    class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
                    data-page="dashboard">
                    <i
                        class="fa-solid fa-table-columns w-5 text-center flex-none text-slate-400 group-hover:text-white transition-colors"></i>
                    <span class="fade-text">Dashboard</span>
                </a>
                <div class="px-5 mt-4 mb-2 text-[10px] font-bold uppercase tracking-widest text-blue-200/50 fade-text">
                    Compliance</div>
                <a href="#"
                    class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
                    data-page="compliance-calendar">
                    <i
                        class="fa-solid fa-calendar-check w-5 text-center flex-none text-slate-400 group-hover:text-green-400 transition-colors"></i>
                    <span class="fade-text">Calendar</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
                    data-page="document-vault">
                    <i
                        class="fa-solid fa-vault w-5 text-center flex-none text-slate-400 group-hover:text-blue-400 transition-colors"></i>
                    <span class="fade-text">Document Vault</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
                    data-page="dq-tracker">
                    <i
                        class="fa-solid fa-folder-open w-5 text-center flex-none text-slate-400 group-hover:text-amber-400 transition-colors"></i>
                    <span class="fade-text">DQ Tracker</span>
                </a>
                <a href="#"
                    class="sidebar-link active flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
                    data-page="csa-monitor">
                    <i class="fa-solid fa-gauge w-5 text-center flex-none transition-colors"></i>
                    <span class="fade-text">CSA Monitor</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
                    data-page="incident-reporting">
                    <i
                        class="fa-solid fa-triangle-exclamation w-5 text-center flex-none text-slate-400 group-hover:text-red-400 transition-colors"></i>
                    <span class="fade-text">Incidents</span>
                </a>
            </nav>
            <div class="p-3 border-t border-white/10 bg-black/30 backdrop-blur-md">
                <div class="flex items-center gap-3 p-2">
                    <div
                        class="h-8 w-8 rounded-full bg-slate-800/50 flex-none flex items-center justify-center border border-slate-600/50 text-white font-bold text-xs">
                        <i class="fa-solid fa-building text-slate-400 text-xs"></i>
                    </div>
                    <div class="flex-1 overflow-hidden fade-text">
                        <p class="text-xs font-bold text-white truncate" id="sidebarCarrierName">Carrier Portal</p>
                        <p class="text-[10px] text-slate-400 truncate">Compliance Suite</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- PAGE CONTENT -->
    <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">

        <!-- HEADER -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
            <div>
                <h1 class="text-xl font-bold text-slate-800">CSA Score Monitor</h1>
                <p class="text-sm text-slate-500">FMCSA Safety Measurement System</p>
            </div>
            <div class="flex gap-3 text-sm text-slate-500">
                <span>Last Updated: <strong class="text-slate-800" id="lastUpdated">--</strong></span>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-6">

            <!-- TOP ROW: BASIC SCORES -->
            <h2 class="text-xs font-bold text-slate-400 uppercase mb-4">BASIC Scores Overview</h2>
            <div id="basicGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8">
                <!-- Injected via JS -->
                <div class="animate-pulse bg-white p-4 rounded-xl h-32"></div>
                <div class="animate-pulse bg-white p-4 rounded-xl h-32"></div>
                <div class="animate-pulse bg-white p-4 rounded-xl h-32"></div>
                <div class="animate-pulse bg-white p-4 rounded-xl h-32"></div>
            </div>

            <!-- MIDDLE ROW: TRENDS & RECS -->
            <div class="grid lg:grid-cols-3 gap-6">

                <!-- TREND CHART -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-slate-800">12-Month Trend</h3>
                        <select id="trendMetric" class="text-sm border-gray-300 rounded-lg">
                            <option value="all">All BASICs</option>
                            <option value="unsafe_driving">Unsafe Driving</option>
                            <option value="hours_of_service">HOS Compliance</option>
                            <option value="vehicle_maintenance">Vehicle Maint.</option>
                        </select>
                    </div>
                    <div class="h-64">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- RECOMMENDATIONS -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Recommendations</h3>
                    <div id="recsList" class="space-y-4">
                        <div class="text-center text-slate-400 py-4">No active recommendations.</div>
                    </div>
                </div>
            </div>

        </main>

    </div><!-- /PAGE CONTENT -->

    <!-- SCRIPT -->
    <script>
            (function () {
                let chartInstance = null;
                let currentData = null;
                let dataReceived = false;
                const DATA_TIMEOUT_MS = 5000;

                // --- API BRIDGE ---
                function sendToVelo(action, payload = {}) {
                    window.parent.postMessage({ type: action, action, data: payload }, '*');
                }

                window.addEventListener('message', (event) => {
                    const msg = event.data;
                    if (!msg || !msg.type) return;

                    if (msg.type === 'setCSAData') {
                        dataReceived = true;
                        currentData = msg.data;
                        render();
                    }
                });

                // --- RENDER ---
                function render() {
                    if (!currentData) return;

                    const basics = currentData.basics || {};
                    const history = currentData.history || [];
                    const recs = currentData.recommendations || [];

                    document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();

                    // 1. BASIC Grid
                    const grid = document.getElementById('basicGrid');
                    grid.innerHTML = '';

                    // Define standard BASICs
                    const categories = [
                        { key: 'unsafe_driving', label: 'Unsafe Driving', threshold: 65 },
                        { key: 'hours_of_service', label: 'HOS Compliance', threshold: 65 },
                        { key: 'driver_fitness', label: 'Driver Fitness', threshold: 80 },
                        { key: 'drugs_alcohol', label: 'Drugs/Alcohol', threshold: 80 },
                        { key: 'vehicle_maintenance', label: 'Vehicle Maint.', threshold: 80 },
                        { key: 'crash_indicator', label: 'Crash Indicator', threshold: 65 }
                    ];

                    categories.forEach(cat => {
                        const score = basics[cat.key]?.percentile || 0;
                        const alert = basics[cat.key]?.alert || false;
                        const trend = basics[cat.key]?.change || 0;

                        const div = document.createElement('div');
                        div.className = 'bg-white p-5 rounded-xl border border-gray-200 shadow-sm';

                        let statusColor = 'bg-green-500';
                        let statusIcon = 'fa-check-circle text-green-500';
                        let statusText = 'Good';

                        if (score > cat.threshold * 0.8) { statusColor = 'bg-yellow-500'; statusIcon = 'fa-exclamation-circle text-yellow-500'; statusText = 'Warning'; }
                        if (alert || score > cat.threshold) { statusColor = 'bg-red-500'; statusIcon = 'fa-triangle-exclamation text-red-500'; statusText = 'Alert'; }

                        div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-slate-700 text-sm">${cat.label}</h4>
                            <i class="fa-solid ${statusIcon}"></i>
                        </div>
                        <div class="flex items-baseline gap-2 mb-2">
                            <span class="text-3xl font-black text-slate-900">${score}%</span>
                            <span class="text-xs text-slate-400">/ ${cat.threshold}% limit</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-3">
                            <div class="${statusColor} h-2 rounded-full transition-all duration-1000" style="width: ${score}%"></div>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="font-semibold ${score > cat.threshold ? 'text-red-600' : 'text-slate-500'}">${statusText}</span>
                            <span class="${trend > 0 ? 'text-red-500' : 'text-green-500'}">
                                ${trend > 0 ? '▲' : '▼'} ${Math.abs(trend)}% vs last mo
                            </span>
                        </div>
                    `;
                        grid.appendChild(div);
                    });

                    // 2. Recommendations
                    const recList = document.getElementById('recsList');
                    recList.innerHTML = '';

                    if (recs.length === 0) {
                        recList.innerHTML = '<div class="text-center text-slate-400 py-4">No active recommendations.</div>';
                    } else {
                        recs.forEach(rec => {
                            const item = document.createElement('div');
                            item.className = 'p-3 bg-blue-50 rounded-lg border border-blue-100';
                            item.innerHTML = `
                            <div class="flex gap-3">
                                <div class="mt-1"><i class="fa-solid fa-lightbulb text-lmdr-blue"></i></div>
                                <div>
                                    <h5 class="font-bold text-sm text-slate-800">${rec.category}</h5>
                                    <p class="text-xs text-slate-600">${rec.action}</p>
                                </div>
                            </div>
                        `;
                            recList.appendChild(item);
                        });
                    }

                    // 3. Chart
                    renderChart(history);
                }

                function renderChart(history) {
                    const ctx = document.getElementById('trendChart').getContext('2d');

                    if (chartInstance) chartInstance.destroy();

                    // Mock data if empty
                    if (!history || history.length === 0) {
                        history = Array.from({ length: 6 }, (_, i) => ({
                            snapshot_date: new Date(2025, i, 1),
                            basics: {
                                unsafe_driving: { percentile: 40 + Math.random() * 10 },
                                vehicle_maintenance: { percentile: 30 + Math.random() * 10 },
                                hours_of_service: { percentile: 20 + Math.random() * 5 }
                            }
                        }));
                    }

                    const labels = history.map(h => new Date(h.snapshot_date).toLocaleDateString('en-US', { month: 'short' }));

                    const datasets = [
                        {
                            label: 'Unsafe Driving',
                            data: history.map(h => h.basics.unsafe_driving?.percentile || 0),
                            borderColor: '#ef4444',
                            tension: 0.4
                        },
                        {
                            label: 'Vehicle Maint.',
                            data: history.map(h => h.basics.vehicle_maintenance?.percentile || 0),
                            borderColor: '#3b82f6',
                            tension: 0.4
                        },
                        {
                            label: 'HOS Compliance',
                            data: history.map(h => h.basics.hours_of_service?.percentile || 0),
                            borderColor: '#f59e0b',
                            tension: 0.4
                        }
                    ];

                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { intersect: false, mode: 'index' },
                            plugins: { legend: { position: 'bottom' } },
                            scales: { y: { min: 0, max: 100 } }
                        }
                    });
                }

                // Empty state fallback if Velo never responds
                function showEmptyState() {
                    if (dataReceived) return;
                    const grid = document.getElementById('basicGrid');
                    grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                        <i class="fa-solid fa-gauge text-4xl mb-4 text-slate-300"></i>
                        <p class="font-medium text-slate-500">No CSA score data available yet</p>
                        <p class="text-sm mt-1">Data will appear once your compliance profile is configured</p>
                    </div>`;
                }

                // INIT
                sendToVelo('getCSAData');
                setTimeout(showEmptyState, DATA_TIMEOUT_MS);
                window.parent.postMessage({ type: 'csaMonitorReady', action: 'csaMonitorReady' }, '*');

            })();
    </script>

    <!-- SIDEBAR JS -->
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('toggleIcon');
            sidebar.classList.toggle('w-56');
            sidebar.classList.toggle('w-16');
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        }

        document.querySelectorAll('.sidebar-link[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('collapsed')) toggleSidebar();
                const page = link.getAttribute('data-page');
                if (page) {
                    window.parent.postMessage({ type: 'navigateTo', action: 'navigateTo', data: { page } }, '*');
                }
            });
        });

        // Auto-collapse on mobile
        if (window.innerWidth < 768) {
            const sidebar = document.getElementById('sidebar');
            // Check if not already collapsed to avoid double toggle if class logic changes
            if (!sidebar.classList.contains('collapsed')) {
                toggleSidebar();
            }
        }
    </script>
</body>

</html>