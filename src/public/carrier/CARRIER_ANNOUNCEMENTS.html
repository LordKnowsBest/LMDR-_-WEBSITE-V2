<!DOCTYPE html>
<!--
================================================================================
CARRIER ANNOUNCEMENTS DASHBOARD (VelocityMatch)
================================================================================
PostMessage protocol (HTML -> Wix page code):
- { type: 'carrierAnnouncementsReady' }
- { type: 'getCarrierAnnouncements', data: { status, limit, offset } }
- { type: 'createAnnouncement', data: { carrier_id, title, content, priority, target_audience, allow_comments, scheduled_at, expires_at, status } }
- { type: 'updateAnnouncement', data: { announcementId, updates } }
- { type: 'publishAnnouncement', data: { announcementId } }
- { type: 'scheduleAnnouncement', data: { announcementId, scheduledAt } }
- { type: 'archiveAnnouncement', data: { announcementId } }
- { type: 'previewRecipients', data: { carrierId, targetAudience } }
- { type: 'uploadAnnouncementAttachment', data: { base64Data, fileName, mimeType, carrierId } }

Wix -> HTML responses:
- { type: 'carrierAnnouncementsData', data: { success, announcements, totalCount } }
- { type: 'announcementActionResult', data: { success, announcement, error } }
- { type: 'recipientPreviewResult', data: { success, total } }
- { type: 'announcementAttachmentResult', data: { success, attachment, error } }
- { type: 'carrierContext', data: { carrierId } }
================================================================================
-->
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Announcements | VelocityMatch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            vm: {
              ink: '#0b1220',
              slate: '#0f172a',
              steel: '#1f2937',
              mist: '#eef2f7',
              sky: '#38bdf8',
              teal: '#14b8a6',
              amber: '#f59e0b',
              rose: '#f43f5e'
            }
          },
          boxShadow: {
            glow: '0 0 30px rgba(56, 189, 248, 0.25)'
          }
        }
      }
    };
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .glass {
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(12px);
    }

    .thin-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .thin-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.4);
      border-radius: 999px;
    }

    .tab-active {
      color: #38bdf8;
      border-bottom: 2px solid #38bdf8;
    }

    .tab-inactive {
      color: #94a3b8;
      border-bottom: 2px solid transparent;
    }

    .tab-inactive:hover {
      color: #e2e8f0;
    }

    .modal {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* Sidebar styles (match carrier pages) */
    .sidebar-transition {
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fade-text {
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    }

    .collapsed .fade-text {
      opacity: 0;
      pointer-events: none;
      display: none;
    }

    .collapsed .sidebar-header {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }

    .collapsed .logo-text {
      display: none;
    }

    .sidebar-link {
      transition: all 0.2s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
    }

    .sidebar-link:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .sidebar-link.active {
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.2) 0%, transparent 100%);
      border-left: 4px solid #38bdf8;
      color: white;
      text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
    }

    .sidebar-link.active i {
      color: #7dd3fc;
      filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.8));
    }

    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      z-index: 0;
      opacity: 0.6;
      animation: float-blob 10s infinite ease-in-out;
    }

    .blob-1 {
      top: -10%;
      left: -20%;
      width: 200px;
      height: 200px;
      background: #38bdf8;
    }

    .blob-2 {
      bottom: 10%;
      right: -20%;
      width: 180px;
      height: 180px;
      background: #6366f1;
      animation-delay: -5s;
    }

    @keyframes float-blob {

      0%,
      100% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(15px, 30px);
      }
    }

    /* Light mode overrides */
    body.light-mode {
      background: #f8fafc;
      color: #0f172a;
    }

    body.light-mode .glass {
      background: rgba(255, 255, 255, 0.8);
      color: #0f172a;
    }

    body.light-mode .tab-inactive {
      color: #64748b;
    }

    body.light-mode .tab-inactive:hover {
      color: #0f172a;
    }

    body.light-mode .sidebar-shell {
      background: #ffffff;
      color: #0f172a;
    }

    body.light-mode .sidebar-link {
      color: #334155;
    }

    body.light-mode .sidebar-link:hover {
      background-color: rgba(15, 23, 42, 0.06);
    }

    body.light-mode .sidebar-link.active {
      color: #0f172a;
    }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-vm-ink via-vm-slate to-black text-white flex overflow-hidden">
  <div class="relative h-full flex flex-col z-50 bg-slate-900 overflow-hidden shadow-2xl sidebar-transition"
    id="sidebar-container">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <aside id="sidebar"
      class="w-56 text-slate-300 flex flex-col h-full sidebar-transition group relative z-10 bg-slate-900/60 backdrop-blur-xl border-r border-white/5 sidebar-shell">
      <button onclick="toggleSidebar()"
        class="absolute -right-3 top-16 bg-vm-sky text-vm-ink w-6 h-6 rounded-full flex items-center justify-center shadow-lg border border-slate-900 hover:scale-110 transition-transform z-50 opacity-0 group-hover:opacity-100">
        <i class="fa-solid fa-chevron-left text-[10px]" id="toggleIcon"></i>
      </button>
      <div class="h-14 flex items-center px-5 border-b border-white/10 sidebar-header transition-all">
        <div class="flex items-center gap-3">
          <div
            class="h-8 w-8 bg-gradient-to-br from-sky-400 to-teal-400 rounded-lg flex-none flex items-center justify-center text-vm-ink font-black text-sm shadow-lg shadow-sky-500/30 ring-1 ring-white/20">
            VM</div>
          <div class="logo-text fade-text">
            <h1 class="font-bold text-white text-sm tracking-tight">Velocity<span class="text-sky-300">Match</span></h1>
            <p class="text-[10px] text-blue-200/70 uppercase font-bold tracking-wider">Carrier OS</p>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto thin-scroll py-4 space-y-1">
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="dashboard">
          <i
            class="fa-solid fa-table-columns w-5 text-center flex-none text-slate-400 group-hover:text-white transition-colors"></i>
          <span class="fade-text">Dashboard</span>
        </a>
        <div class="px-5 mt-4 mb-2 text-[10px] font-bold uppercase tracking-widest text-blue-200/50 fade-text">
          Communication</div>
        <a href="#"
          class="sidebar-link active flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="announcements">
          <i class="fa-solid fa-bullhorn w-5 text-center flex-none"></i>
          <span class="fade-text">Announcements</span>
        </a>
        <div class="px-5 mt-4 mb-2 text-[10px] font-bold uppercase tracking-widest text-blue-200/50 fade-text">
          Compliance</div>
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="compliance-calendar">
          <i
            class="fa-solid fa-calendar-check w-5 text-center flex-none text-slate-400 group-hover:text-blue-400 transition-colors"></i>
          <span class="fade-text">Calendar</span>
        </a>
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="document-vault">
          <i
            class="fa-solid fa-vault w-5 text-center flex-none text-slate-400 group-hover:text-blue-400 transition-colors"></i>
          <span class="fade-text">Document Vault</span>
        </a>
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="dq-tracker">
          <i
            class="fa-solid fa-file-shield w-5 text-center flex-none text-slate-400 group-hover:text-blue-400 transition-colors"></i>
          <span class="fade-text">DQ Tracker</span>
        </a>
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="csa-monitor">
          <i
            class="fa-solid fa-chart-line w-5 text-center flex-none text-slate-400 group-hover:text-blue-400 transition-colors"></i>
          <span class="fade-text">CSA Monitor</span>
        </a>
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium hover:text-white group"
          data-page="incident-reporting">
          <i
            class="fa-solid fa-triangle-exclamation w-5 text-center flex-none text-slate-400 group-hover:text-blue-400 transition-colors"></i>
          <span class="fade-text">Incidents</span>
        </a>
      </nav>
      <div class="border-t border-white/10 p-4">
        <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-xs text-slate-200 hover:bg-white/20"
          onclick="toggleTheme()">
          <i class="fa-solid fa-sun mr-2" id="themeIcon"></i><span class="fade-text" id="themeLabel">Light mode</span>
        </button>
      </div>
    </aside>
  </div>

  <main class="flex-1 min-w-0 overflow-y-auto">
    <div class="min-h-screen p-4 md:p-6">
      <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div
            class="h-12 w-12 rounded-2xl bg-gradient-to-br from-vm-sky to-vm-teal flex items-center justify-center shadow-glow">
            <span class="font-black text-white">VM</span>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold">Announcements</h1>
            <p class="text-sm text-slate-300">Broadcast updates, track reads, and keep drivers aligned.</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button class="px-3 py-2 rounded-lg bg-vm-steel text-sm text-slate-200 hover:bg-slate-700"
            onclick="refreshAnnouncements()">
            <i class="fa-solid fa-rotate-right mr-2"></i>Refresh
          </button>
          <button class="px-4 py-2 rounded-lg bg-vm-sky text-vm-ink font-semibold hover:bg-sky-300"
            onclick="openModal()">
            <i class="fa-solid fa-plus mr-2"></i>New Announcement
          </button>
        </div>
      </header>

      <section class="mt-6 grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Published</div>
          <div class="text-2xl font-bold mt-2" id="statPublished">--</div>
        </div>
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Scheduled</div>
          <div class="text-2xl font-bold mt-2" id="statScheduled">--</div>
        </div>
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Drafts</div>
          <div class="text-2xl font-bold mt-2" id="statDrafts">--</div>
        </div>
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Avg Read Rate</div>
          <div class="text-2xl font-bold mt-2" id="statReadRate">--%</div>
        </div>
      </section>

      <section class="mt-6">
        <div class="flex flex-wrap gap-4 border-b border-white/10 text-sm font-semibold">
          <button class="pb-3 tab-active" id="tabPublished" onclick="setTab('published')">Published</button>
          <button class="pb-3 tab-inactive" id="tabScheduled" onclick="setTab('scheduled')">Scheduled</button>
          <button class="pb-3 tab-inactive" id="tabDraft" onclick="setTab('draft')">Drafts</button>
          <button class="pb-3 tab-inactive" id="tabArchived" onclick="setTab('archived')">Archived</button>
        </div>

        <div class="mt-4 grid lg:grid-cols-[2.2fr_1fr] gap-4">
          <div class="glass rounded-2xl border border-white/10 p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <h2 class="text-lg font-semibold">Announcement Feed</h2>
                <p class="text-xs text-slate-400">Status: <span id="currentStatus">Published</span></p>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <select id="priorityFilter"
                  class="bg-vm-steel text-white text-sm rounded-lg px-3 py-2 border border-white/10 flex-grow md:flex-grow-0"
                  onchange="applyFilters()">
                  <option value="all">All priorities</option>
                  <option value="urgent">Urgent</option>
                  <option value="important">Important</option>
                  <option value="normal">Normal</option>
                </select>
                <input id="dateFromFilter" type="date"
                  class="bg-vm-steel text-white text-sm rounded-lg px-3 py-2 border border-white/10 flex-grow md:flex-grow-0"
                  onchange="applyFilters()" />
                <input id="dateToFilter" type="date"
                  class="bg-vm-steel text-white text-sm rounded-lg px-3 py-2 border border-white/10 flex-grow md:flex-grow-0"
                  onchange="applyFilters()" />
                <input id="searchInput" type="text" placeholder="Search title..."
                  class="bg-vm-steel text-white text-sm rounded-lg px-3 py-2 border border-white/10 flex-grow md:flex-grow-0 w-full md:w-auto"
                  oninput="applyFilters()" />
              </div>
            </div>
            <div class="mt-4 space-y-3 max-h-[520px] overflow-y-auto thin-scroll" id="announcementList">
              <div class="p-4 rounded-xl bg-white/5 border border-white/10 animate-pulse">
                <div class="h-4 w-40 bg-white/10 rounded"></div>
                <div class="h-3 w-64 bg-white/10 rounded mt-2"></div>
              </div>
            </div>
          </div>
          <aside class="glass rounded-2xl border border-white/10 p-4 space-y-4">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-widest text-slate-400">Actions</h3>
              <div class="mt-3 grid gap-2">
                <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-sm hover:bg-white/20"
                  onclick="sendReminder()">
                  <i class="fa-solid fa-bell mr-2"></i>Send Reminder
                </button>
                <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-sm hover:bg-white/20" onclick="openModal()">
                  <i class="fa-solid fa-pen-to-square mr-2"></i>Draft Announcement
                </button>
                <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-sm hover:bg-white/20"
                  onclick="refreshAnnouncements()">
                  <i class="fa-solid fa-rotate-right mr-2"></i>Refresh List
                </button>
              </div>
            </div>
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-widest text-slate-400">Targeting Snapshot</h3>
              <p class="text-xs text-slate-400 mt-2">Preview audience reach before publishing.</p>
              <button class="mt-3 w-full px-3 py-2 rounded-lg bg-vm-teal text-vm-ink text-sm font-semibold"
                onclick="previewAudience()">
                Preview Recipients
              </button>
              <div class="mt-3 text-sm" id="previewResult">-- drivers</div>
            </div>
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-widest text-slate-400">Tips</h3>
              <ul class="mt-2 text-xs text-slate-400 space-y-2">
                <li>Use urgent only for safety or time-critical updates.</li>
                <li>Add a clear CTA in the first sentence.</li>
                <li>Set an expiry date for short-term notices.</li>
              </ul>
            </div>
          </aside>
        </div>
      </section>
    </div>
  </main>

  <div class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4" id="announcementModal">
    <div class="bg-vm-slate border border-white/10 rounded-2xl w-full max-w-3xl p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Create Announcement</h3>
        <button class="text-slate-300 hover:text-white" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Title</label>
          <input id="annTitle" type="text"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" />
        </div>
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Priority</label>
          <select id="annPriority"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10">
            <option value="normal">Normal</option>
            <option value="important">Important</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs uppercase tracking-widest text-slate-400">Content</label>
          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" class="px-2 py-1 rounded bg-white/10 text-xs"
              onclick="insertContentToken('<strong></strong>')"><i class="fa-solid fa-bold"></i></button>
            <button type="button" class="px-2 py-1 rounded bg-white/10 text-xs"
              onclick="insertContentToken('<em></em>')"><i class="fa-solid fa-italic"></i></button>
            <button type="button" class="px-2 py-1 rounded bg-white/10 text-xs"
              onclick="insertContentToken('<ul><li></li></ul>')"><i class="fa-solid fa-list"></i></button>
            <button type="button" class="px-2 py-1 rounded bg-white/10 text-xs" onclick="insertContentToken('<a href=\"
              https://www.lastmiledr.app\" target=\"_blank\">link</a>')"><i class="fa-solid fa-link"></i></button>
          </div>
          <textarea id="annContent" rows="6"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10"></textarea>
        </div>
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Schedule (optional)</label>
          <input id="annSchedule" type="datetime-local"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" />
        </div>
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Expires (optional)</label>
          <input id="annExpiry" type="datetime-local"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs uppercase tracking-widest text-slate-400">Audience Preset</label>
          <select id="annAudiencePreset"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10"
            onchange="setAudiencePreset()">
            <option value="all">All Drivers</option>
            <option value="state">State Segment (sample)</option>
            <option value="experience">Experience Segment (sample)</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs uppercase tracking-widest text-slate-400">Target Audience (JSON)</label>
          <textarea id="annAudience" rows="3"
            class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10"
            placeholder='{"type":"all","segments":[]}'></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs uppercase tracking-widest text-slate-400">Attachments</label>
          <div class="mt-2 flex flex-wrap gap-2">
            <input id="annAttachmentFile" type="file"
              class="bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10 text-xs" />
            <button type="button" class="px-3 py-2 rounded-lg bg-white/10 text-xs"
              onclick="uploadAttachmentFromModal()">Upload</button>
          </div>
          <ul id="annAttachmentList" class="mt-2 text-xs text-slate-300 space-y-1"></ul>
        </div>
        <div class="md:col-span-2 flex items-center gap-3">
          <input id="annComments" type="checkbox" class="h-4 w-4" checked />
          <label for="annComments" class="text-sm text-slate-300">Allow driver comments</label>
        </div>
      </div>
      <div class="mt-5 flex flex-wrap justify-end gap-2">
        <button class="px-4 py-2 rounded-lg bg-white/10 text-sm" onclick="closeModal()">Cancel</button>
        <button class="px-4 py-2 rounded-lg bg-white/10 text-sm" onclick="previewAnnouncement()">Preview</button>
        <button class="px-4 py-2 rounded-lg bg-vm-teal text-vm-ink font-semibold" onclick="submitAnnouncement()">Save
          Draft</button>
        <button class="px-4 py-2 rounded-lg bg-vm-sky text-vm-ink font-semibold"
          onclick="submitAnnouncement(true)">Publish Now</button>
      </div>
    </div>
  </div>

  <div class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4" id="announcementDetailModal">
    <div class="bg-vm-slate border border-white/10 rounded-2xl w-full max-w-5xl p-5 max-h-[92vh] overflow-y-auto">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Announcement Detail</h3>
        <button class="text-slate-300 hover:text-white" onclick="closeDetailModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div id="detailBody" class="mt-4 text-sm text-slate-300">Loading...</div>
    </div>
  </div>

  <script>
    const state = {
      status: 'published',
      announcements: [],
      filtered: [],
      carrierId: null,
      selectedAnnouncementId: null,
      pendingAttachments: []
    };

    function postToParent(type, data) {
      window.parent.postMessage({ type, data }, '*');
    }

    function setTab(status) {
      state.status = status;
      document.getElementById('currentStatus').textContent = status[0].toUpperCase() + status.slice(1);
      ['published', 'scheduled', 'draft', 'archived'].forEach(key => {
        const tab = document.getElementById(`tab${key[0].toUpperCase()}${key.slice(1)}`);
        tab.className = key === status ? 'pb-3 tab-active' : 'pb-3 tab-inactive';
      });
      refreshAnnouncements();
    }

    function openModal() {
      document.getElementById('announcementModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('announcementModal').classList.remove('active');
    }

    function insertContentToken(token) {
      const field = document.getElementById('annContent');
      const start = field.selectionStart || field.value.length;
      const end = field.selectionEnd || field.value.length;
      const before = field.value.slice(0, start);
      const selected = field.value.slice(start, end);
      const after = field.value.slice(end);
      field.value = `${before}${token.replace('</', `${selected}</`)}${after}`;
      field.focus();
    }

    function setAudiencePreset() {
      const preset = document.getElementById('annAudiencePreset').value;
      if (preset === 'all') {
        document.getElementById('annAudience').value = JSON.stringify({ type: 'all', segments: [] });
      } else if (preset === 'state') {
        document.getElementById('annAudience').value = JSON.stringify({ type: 'segment', segments: [{ field: 'state', operator: 'equals', value: 'TX' }] });
      } else if (preset === 'experience') {
        document.getElementById('annAudience').value = JSON.stringify({ type: 'segment', segments: [{ field: 'years_experience', operator: 'greater_than_or_equal', value: 3 }] });
      }
    }

    function renderPendingAttachments() {
      const list = document.getElementById('annAttachmentList');
      list.innerHTML = state.pendingAttachments.map(a => `<li>${a.name} <span class="text-slate-500">(${a.type})</span></li>`).join('');
    }

    function uploadAttachmentFromModal() {
      const input = document.getElementById('annAttachmentFile');
      const file = input.files && input.files[0];
      if (!file) {
        alert('Select a file first.');
        return;
      }

      const maxBytes = 8 * 1024 * 1024;
      if (file.size > maxBytes) {
        alert('Attachment must be <= 8MB.');
        return;
      }

      const allowed = ['application/pdf', 'image/png', 'image/jpeg', 'image/webp', 'text/plain'];
      if (!allowed.includes(file.type)) {
        alert('Supported files: PDF, PNG, JPG, WEBP, TXT.');
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        postToParent('uploadAnnouncementAttachment', {
          base64Data: reader.result,
          fileName: file.name,
          mimeType: file.type,
          carrierId: state.carrierId
        });
      };
      reader.readAsDataURL(file);
    }

    function previewAnnouncement() {
      const title = document.getElementById('annTitle').value.trim();
      const content = document.getElementById('annContent').value.trim();
      const priority = document.getElementById('annPriority').value;
      const preview = `${title || '(untitled)'}\nPriority: ${priority}\n\n${content || '(no content)'}`;
      alert(preview);
    }

    function refreshAnnouncements() {
      postToParent('getCarrierAnnouncements', { status: state.status, limit: 100, offset: 0 });
    }

    function applyFilters() {
      const priority = document.getElementById('priorityFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateTo = document.getElementById('dateToFilter').value;

      state.filtered = state.announcements.filter(item => {
        const matchesPriority = priority === 'all' || item.priority === priority;
        const matchesSearch = !search || (item.title || '').toLowerCase().includes(search);
        const published = item.published_at ? new Date(item.published_at) : null;
        const fromOk = !dateFrom || !published || published >= new Date(`${dateFrom}T00:00:00`);
        const toOk = !dateTo || !published || published <= new Date(`${dateTo}T23:59:59`);
        return matchesPriority && matchesSearch && fromOk && toOk;
      });
      renderAnnouncements();
    }

    function renderAnnouncements() {
      const list = document.getElementById('announcementList');
      if (!state.filtered.length) {
        list.innerHTML = '<div class="p-6 rounded-xl bg-white/5 border border-white/10 text-sm text-slate-300">No announcements yet for this view.</div>';
        return;
      }

      list.innerHTML = state.filtered.map(item => {
        const badgeColor = item.priority === 'urgent' ? 'bg-red-500/20 text-red-200' : item.priority === 'important' ? 'bg-amber-500/20 text-amber-200' : 'bg-emerald-500/20 text-emerald-200';
        const published = item.published_at ? new Date(item.published_at).toLocaleString() : 'Not published';
        const reads = Number(item.read_count || 0);
        const total = Number(item.total_recipients || 0);
        const rate = total ? Math.round((reads / total) * 100) : 0;
        return `
          <div class="p-4 rounded-xl bg-white/5 border border-white/10 hover:border-vm-sky/40 transition">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold">${item.title || 'Untitled'}</span>
                  <span class="text-xs px-2 py-0.5 rounded-full ${badgeColor}">${item.priority || 'normal'}</span>
                </div>
                <p class="text-xs text-slate-400 mt-1">${published}</p>
              </div>
              <div class="flex items-center gap-3">
                <div class="text-xs text-slate-300">Read ${rate}%</div>
                <button class="px-3 py-1.5 rounded-lg bg-white/10 text-xs" onclick="publishAnnouncement('${item._id}')">Publish</button>
                <button class="px-3 py-1.5 rounded-lg bg-white/10 text-xs" onclick="archiveAnnouncement('${item._id}')">Archive</button>
                <button class="px-3 py-1.5 rounded-lg bg-white/10 text-xs" onclick="openAnnouncementDetail('${item._id}')">Details</button>
              </div>
            </div>
            <div class="mt-2 h-2 rounded-full bg-white/10 overflow-hidden">
              <div class="h-full bg-sky-400" style="width:${Math.max(0, Math.min(100, rate))}%"></div>
            </div>
            <p class="text-sm text-slate-200 mt-2">${(item.content_plain || '').slice(0, 140)}...</p>
          </div>
        `;
      }).join('');
    }

    function updateStats() {
      const published = state.announcements.filter(a => a.status === 'published').length;
      const scheduled = state.announcements.filter(a => a.status === 'scheduled').length;
      const drafts = state.announcements.filter(a => a.status === 'draft').length;
      const readRates = state.announcements
        .filter(a => a.total_recipients)
        .map(a => Math.round((Number(a.read_count || 0) / Number(a.total_recipients || 1)) * 100));
      const avgRate = readRates.length ? Math.round(readRates.reduce((a, b) => a + b, 0) / readRates.length) : 0;

      document.getElementById('statPublished').textContent = published;
      document.getElementById('statScheduled').textContent = scheduled;
      document.getElementById('statDrafts').textContent = drafts;
      document.getElementById('statReadRate').textContent = `${avgRate}%`;
    }

    function submitAnnouncement(publishNow = false) {
      const title = document.getElementById('annTitle').value.trim();
      const content = document.getElementById('annContent').value.trim();
      if (!title || !content) {
        alert('Title and content are required.');
        return;
      }

      let targetAudience = { type: 'all', segments: [] };
      const audienceValue = document.getElementById('annAudience').value.trim();
      if (audienceValue) {
        try { targetAudience = JSON.parse(audienceValue); } catch (err) { alert('Target audience JSON is invalid.'); return; }
      }

      const payload = {
        carrier_id: state.carrierId,
        title,
        content,
        priority: document.getElementById('annPriority').value,
        target_audience: targetAudience,
        allow_comments: document.getElementById('annComments').checked,
        scheduled_at: document.getElementById('annSchedule').value || null,
        expires_at: document.getElementById('annExpiry').value || null,
        status: publishNow ? 'published' : 'draft'
      };
      payload.attachments = state.pendingAttachments;

      postToParent('createAnnouncement', payload);
      closeModal();
    }

    function publishAnnouncement(id) {
      postToParent('publishAnnouncement', { announcementId: id });
    }

    function archiveAnnouncement(id) {
      postToParent('archiveAnnouncement', { announcementId: id });
    }

    function previewAudience() {
      const audienceValue = document.getElementById('annAudience').value.trim();
      let targetAudience = { type: 'all', segments: [] };
      if (audienceValue) {
        try { targetAudience = JSON.parse(audienceValue); } catch (err) { alert('Target audience JSON is invalid.'); return; }
      }
      postToParent('previewRecipients', { carrierId: state.carrierId, targetAudience });
    }

    function sendReminder() {
      if (!state.selectedAnnouncementId) {
        alert('Open an announcement detail first, then send reminder.');
        return;
      }
      postToParent('sendAnnouncementReminder', {
        announcementId: state.selectedAnnouncementId,
        carrierId: state.carrierId
      });
    }

    function openAnnouncementDetail(announcementId) {
      state.selectedAnnouncementId = announcementId;
      document.getElementById('announcementDetailModal').classList.add('active');
      document.getElementById('detailBody').innerHTML = 'Loading...';
      postToParent('getAnnouncementDetail', {
        announcementId,
        carrierId: state.carrierId,
        includeHiddenComments: true,
        limit: 50,
        offset: 0
      });
    }

    function closeDetailModal() {
      document.getElementById('announcementDetailModal').classList.remove('active');
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const icon = document.getElementById('toggleIcon');
      sidebar.classList.toggle('w-56');
      sidebar.classList.toggle('w-16');
      sidebar.classList.toggle('collapsed');
      if (sidebar.classList.contains('collapsed')) {
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
      } else {
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
      }
    }

    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('light-mode');
      const icon = document.getElementById('themeIcon');
      const label = document.getElementById('themeLabel');
      const isLight = body.classList.contains('light-mode');
      icon.className = isLight ? 'fa-solid fa-moon mr-2' : 'fa-solid fa-sun mr-2';
      label.textContent = isLight ? 'Dark mode' : 'Light mode';
    }

    document.querySelectorAll('.sidebar-link[data-page]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('collapsed')) toggleSidebar();
        const page = link.getAttribute('data-page');
        if (page) {
          window.parent.postMessage({ type: 'navigateTo', action: 'navigateTo', data: { page } }, '*');
        }
      });
    });

    window.addEventListener('message', event => {
      const { type, data } = event.data || {};
      if (type === 'carrierAnnouncementsData') {
        state.announcements = data?.announcements || [];
        state.filtered = [...state.announcements];
        updateStats();
        applyFilters();
      }
      if (type === 'recipientPreviewResult') {
        const total = data?.total ?? '--';
        document.getElementById('previewResult').textContent = `${total} drivers`;
      }
      if (type === 'announcementActionResult') {
        state.pendingAttachments = [];
        renderPendingAttachments();
        refreshAnnouncements();
      }
      if (type === 'carrierContext') {
        state.carrierId = data?.carrierId || state.carrierId;
      }
      if (type === 'announcementDetailData') {
        const detail = data || {};
        if (!detail.success) {
          document.getElementById('detailBody').innerHTML = `<div class="text-rose-300">${detail.error || 'Failed to load detail'}</div>`;
          return;
        }

        const stats = detail.stats || {};
        const readReceipts = detail.readReceipts || [];
        const unreadDrivers = detail.unreadDrivers || [];
        const comments = detail.comments || [];
        const listRead = readReceipts.slice(0, 20).map(r => `<li>${r.driver_id || 'driver'} - ${new Date(r.read_at).toLocaleString()}</li>`).join('');
        const listUnread = unreadDrivers.slice(0, 20).map(d => `<li>${d.display_name || d.first_name || d._id || 'driver'}</li>`).join('');
        const listComments = comments.slice(0, 20).map(c => `
          <li class="border border-white/10 rounded-lg p-2">
            <div class="font-semibold">${c.driver_name || 'Driver'}</div>
            <div class="text-slate-300">${c.comment_text || ''}</div>
            <div class="mt-2">
              <button class="px-2 py-1 rounded bg-white/10 text-xs" onclick="toggleCommentVisibility('${c._id}', ${c.is_hidden ? 'false' : 'true'})">
                ${c.is_hidden ? 'Unhide' : 'Hide'}
              </button>
            </div>
          </li>
        `).join('');

        document.getElementById('detailBody').innerHTML = `
          <div class="grid md:grid-cols-3 gap-3">
            <div class="rounded-xl border border-white/10 p-3"><div class="text-xs text-slate-400">Read Rate</div><div class="text-xl font-bold">${stats.readRate || 0}%</div></div>
            <div class="rounded-xl border border-white/10 p-3"><div class="text-xs text-slate-400">Reads</div><div class="text-xl font-bold">${stats.readCount || 0}/${stats.totalRecipients || 0}</div></div>
            <div class="rounded-xl border border-white/10 p-3"><div class="text-xs text-slate-400">Avg Time</div><div class="text-xl font-bold">${stats.avgTimeSpentSeconds || 0}s</div></div>
          </div>
          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold mb-2">Read Receipts</h4>
              <ul class="space-y-1 text-xs">${listRead || '<li>No reads yet</li>'}</ul>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Unread Drivers</h4>
              <ul class="space-y-1 text-xs">${listUnread || '<li>No unread drivers</li>'}</ul>
            </div>
          </div>
          <div class="mt-4">
            <h4 class="font-semibold mb-2">Comments</h4>
            <ul class="space-y-2 text-xs">${listComments || '<li>No comments</li>'}</ul>
          </div>
        `;
      }
      if (type === 'announcementReminderResult') {
        if (!data?.success) {
          alert(data?.error || 'Failed to send reminders');
        } else {
          alert(`Reminders sent: ${data.remindersSent || 0} (Unread: ${data.unreadCount || 0})`);
        }
      }
      if (type === 'announcementCommentModerationResult') {
        if (state.selectedAnnouncementId) {
          openAnnouncementDetail(state.selectedAnnouncementId);
        }
      }
      if (type === 'announcementAttachmentResult') {
        if (!data?.success || !data?.attachment) {
          alert(data?.error || 'Attachment upload failed');
          return;
        }
        state.pendingAttachments.push(data.attachment);
        renderPendingAttachments();
      }
    });

    function toggleCommentVisibility(commentId, hidden) {
      postToParent('setAnnouncementCommentVisibility', { commentId, hidden });
    }

    postToParent('carrierAnnouncementsReady');
    refreshAnnouncements();
  </script>
</body>

</html>