<!DOCTYPE html>
<!--
================================================================================
LMDR CARRIER INTAKE QUESTIONNAIRE
================================================================================
Mid-length intake form (~18 fields) for dispatch partner referrals.
Dual-write: carrierStaffingRequests + CarrierHiringPreferences

URL Params:
  ?ref=ashton  → Pre-fills referral source, shows partner badge

PostMessage Protocol:
  1. submitCarrierStaffingRequest → carrierLeadsService.jsw
  2. submitCarrierIntakePreferences → carrierLeadsService.jsw (public wrapper)

Page Code:
  import { submitCarrierStaffingRequest, submitCarrierIntakePreferences } from 'backend/carrierLeadsService';

  $w.onReady(function() {
    const html = $w('#html1');
    html.onMessage(async (event) => {
      if (event.data.type === 'submitCarrierStaffingRequest') {
        const result = await submitCarrierStaffingRequest(event.data.data);
        html.postMessage({ type: 'staffingRequestResult', data: result });
      }
      if (event.data.type === 'submitCarrierIntakePreferences') {
        const result = await submitCarrierIntakePreferences(event.data.data);
        html.postMessage({ type: 'intakePreferencesResult', data: result });
      }
    });
  });
================================================================================
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrier Intake Questionnaire | LMDR</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            lmdr: {
              dark: '#0f172a',
              blue: '#2563eb',
              'blue-deep': '#1e40af',
              yellow: '#fbbf24',
              canvas: '#f8fafc',
            }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }

    .hero-gradient-text {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Chip select styles */
    .chip-select { cursor: pointer; user-select: none; }
    .chip-select .chip-label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      text-align: center;
      transition: all 0.15s;
      background: white;
      color: #475569;
    }
    .chip-select:hover .chip-label {
      border-color: #2563eb;
      color: #2563eb;
    }
    .chip-select input:checked + .chip-label {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    /* Radio card styles */
    .radio-card { cursor: pointer; }
    .radio-card .card-body {
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      transition: all 0.15s;
      background: white;
    }
    .radio-card:hover .card-body {
      border-color: #2563eb;
    }
    .radio-card input:checked + .card-body {
      border-color: #2563eb;
      background: #eff6ff;
    }
    .radio-card input:checked + .card-body .radio-dot {
      background: #2563eb;
      border-color: #2563eb;
    }
    .radio-card input:checked + .card-body .radio-dot::after {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      width: 6px; height: 6px;
      background: white;
      border-radius: 50%;
    }

    /* Section number badge */
    .section-num {
      width: 28px; height: 28px;
      background: #2563eb;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 800;
      flex-shrink: 0;
    }

    /* Pay range inline */
    .pay-range-group {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 8px;
      align-items: center;
    }
    .pay-range-group .separator {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
    }
  </style>
</head>

<body class="bg-lmdr-canvas text-slate-900 antialiased">

  <!-- Header (minimal — lives inside iframe) -->
  <div class="bg-lmdr-dark text-white px-6 py-4">
    <div class="max-w-3xl mx-auto flex items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-lmdr-blue rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-truck-fast text-sm"></i>
        </div>
        <span class="font-bold text-sm">Last Mile <span class="text-blue-400">Driver Recruiting</span></span>
      </div>
    </div>
  </div>

  <!-- Hero -->
  <div class="bg-white border-b border-slate-200 px-6 py-8">
    <div class="max-w-3xl mx-auto text-center">
      <div class="inline-block bg-blue-50 text-lmdr-blue text-xs font-bold px-3 py-1 rounded-full mb-3">
        CARRIER INTAKE
      </div>
      <h1 class="text-2xl md:text-3xl font-black text-lmdr-dark mb-2">
        Tell Us About Your <span class="hero-gradient-text">Driver Needs</span>
      </h1>
      <p class="text-slate-500 text-sm max-w-lg mx-auto">
        Complete this short questionnaire and we'll match pre-qualified CDL drivers to your fleet within 24-48 hours.
      </p>
    </div>
  </div>

  <!-- Form -->
  <div class="px-4 py-8">
    <div class="max-w-3xl mx-auto">
      <form id="carrierIntakeForm" class="space-y-8">

        <!-- ================================ -->
        <!-- SECTION 1: Company Information   -->
        <!-- ================================ -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center gap-3">
            <div class="section-num">1</div>
            <div>
              <h2 class="font-bold text-slate-900 text-sm">Company Information</h2>
              <p class="text-xs text-slate-500">Basic contact details for your carrier</p>
            </div>
          </div>
          <div class="p-6 space-y-5">
            <!-- Company + Contact -->
            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label for="companyName" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Company Name <span class="text-red-500">*</span>
                </label>
                <input type="text" id="companyName" name="companyName" required
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="Your Company Name">
              </div>
              <div>
                <label for="contactName" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Contact Name <span class="text-red-500">*</span>
                </label>
                <input type="text" id="contactName" name="contactName" required
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="Your Name">
              </div>
            </div>
            <!-- Email + Phone -->
            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label for="email" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Email <span class="text-red-500">*</span>
                </label>
                <input type="email" id="email" name="email" required
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="you@company.com">
              </div>
              <div>
                <label for="phone" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Phone <span class="text-red-500">*</span>
                </label>
                <input type="tel" id="phone" name="phone" required
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="(555) 123-4567">
              </div>
            </div>
            <!-- DOT Number -->
            <div>
              <label for="dotNumber" class="block text-xs font-semibold text-slate-700 mb-1.5">
                DOT Number <span class="text-slate-400 font-normal">(Optional)</span>
              </label>
              <input type="text" id="dotNumber" name="dotNumber"
                class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                placeholder="e.g., 1234567">
            </div>
          </div>
        </div>

        <!-- ================================ -->
        <!-- SECTION 2: Driver Needs          -->
        <!-- ================================ -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center gap-3">
            <div class="section-num">2</div>
            <div>
              <h2 class="font-bold text-slate-900 text-sm">Driver Needs</h2>
              <p class="text-xs text-slate-500">What kind of drivers are you looking for?</p>
            </div>
          </div>
          <div class="p-6 space-y-5">
            <!-- Drivers Needed + Urgency -->
            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label for="driversNeeded" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  How Many Drivers? <span class="text-red-500">*</span>
                </label>
                <select id="driversNeeded" name="driversNeeded" required
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm bg-white">
                  <option value="">Select...</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6-10">6-10</option>
                  <option value="10+">10+</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Hiring Urgency <span class="text-red-500">*</span>
                </label>
                <div class="space-y-2">
                  <label class="radio-card block">
                    <input type="radio" name="urgency" value="immediate" required class="sr-only">
                    <div class="card-body flex items-center gap-3">
                      <div class="radio-dot relative w-4 h-4 rounded-full border-2 border-slate-300 flex-shrink-0"></div>
                      <div>
                        <span class="font-semibold text-xs text-slate-800">Immediate</span>
                        <span class="text-xs text-slate-400 ml-1">(&lt;48 hrs)</span>
                      </div>
                    </div>
                  </label>
                  <label class="radio-card block">
                    <input type="radio" name="urgency" value="30_day" class="sr-only">
                    <div class="card-body flex items-center gap-3">
                      <div class="radio-dot relative w-4 h-4 rounded-full border-2 border-slate-300 flex-shrink-0"></div>
                      <div>
                        <span class="font-semibold text-xs text-slate-800">Within 30 Days</span>
                      </div>
                    </div>
                  </label>
                  <label class="radio-card block">
                    <input type="radio" name="urgency" value="ongoing" class="sr-only">
                    <div class="card-body flex items-center gap-3">
                      <div class="radio-dot relative w-4 h-4 rounded-full border-2 border-slate-300 flex-shrink-0"></div>
                      <div>
                        <span class="font-semibold text-xs text-slate-800">Ongoing Need</span>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <!-- CDL Type -->
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-2">
                CDL Type Needed <span class="text-red-500">*</span>
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="chip-select">
                  <input type="checkbox" name="cdlTypes" value="A" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-truck text-xs"></i> Class A</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="cdlTypes" value="B" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-truck-moving text-xs"></i> Class B</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="cdlTypes" value="C" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-van-shuttle text-xs"></i> Class C</span>
                </label>
              </div>
            </div>

            <!-- Endorsements -->
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-2">
                Endorsements Needed <span class="text-slate-400 font-normal">(Select all that apply)</span>
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="chip-select">
                  <input type="checkbox" name="endorsements" value="Hazmat" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-flask text-xs"></i> Hazmat</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="endorsements" value="Tanker" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-truck-droplet text-xs"></i> Tanker</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="endorsements" value="Doubles/Triples" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-trailer text-xs"></i> Doubles/Triples</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="endorsements" value="TWIC" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-id-card text-xs"></i> TWIC</span>
                </label>
              </div>
            </div>

            <!-- Equipment Type -->
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-2">
                Equipment Type <span class="text-slate-400 font-normal">(Select all that apply)</span>
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="chip-select">
                  <input type="checkbox" name="equipmentTypes" value="Dry Van" class="sr-only">
                  <span class="chip-label">Dry Van</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="equipmentTypes" value="Reefer" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-snowflake text-xs"></i> Reefer</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="equipmentTypes" value="Flatbed" class="sr-only">
                  <span class="chip-label">Flatbed</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="equipmentTypes" value="Tanker" class="sr-only">
                  <span class="chip-label">Tanker</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="equipmentTypes" value="Box Truck" class="sr-only">
                  <span class="chip-label">Box Truck</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="equipmentTypes" value="Step Deck" class="sr-only">
                  <span class="chip-label">Step Deck</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- ================================ -->
        <!-- SECTION 3: Route & Schedule      -->
        <!-- ================================ -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center gap-3">
            <div class="section-num">3</div>
            <div>
              <h2 class="font-bold text-slate-900 text-sm">Route & Schedule</h2>
              <p class="text-xs text-slate-500">Where and how do your drivers operate?</p>
            </div>
          </div>
          <div class="p-6 space-y-5">
            <!-- Route Type -->
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-2">
                Route Type <span class="text-red-500">*</span>
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="chip-select">
                  <input type="checkbox" name="routeTypes" value="OTR" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-road text-xs"></i> OTR</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="routeTypes" value="Regional" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-map text-xs"></i> Regional</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="routeTypes" value="Local" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-city text-xs"></i> Local</span>
                </label>
                <label class="chip-select">
                  <input type="checkbox" name="routeTypes" value="Dedicated" class="sr-only">
                  <span class="chip-label"><i class="fa-solid fa-route text-xs"></i> Dedicated</span>
                </label>
              </div>
            </div>

            <!-- Lanes/States + Home Time -->
            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label for="primaryLanes" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Primary Lanes / States
                </label>
                <input type="text" id="primaryLanes" name="primaryLanes"
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="e.g., TX, OK, AR or Dallas to Houston">
              </div>
              <div>
                <label for="homeTime" class="block text-xs font-semibold text-slate-700 mb-1.5">
                  Home Time Preference
                </label>
                <select id="homeTime" name="homeTime"
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm bg-white">
                  <option value="">Select...</option>
                  <option value="Daily">Daily</option>
                  <option value="Weekly">Weekly</option>
                  <option value="Bi-weekly">Bi-weekly</option>
                  <option value="Flexible">Flexible</option>
                </select>
              </div>
            </div>

            <!-- Schedule -->
            <div>
              <label for="schedule" class="block text-xs font-semibold text-slate-700 mb-1.5">
                Schedule
              </label>
              <select id="schedule" name="schedule"
                class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm bg-white">
                <option value="">Select...</option>
                <option value="Full-time">Full-time</option>
                <option value="Part-time">Part-time</option>
                <option value="Team Drivers">Team Drivers</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ================================ -->
        <!-- SECTION 4: Comp & Experience     -->
        <!-- ================================ -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center gap-3">
            <div class="section-num">4</div>
            <div>
              <h2 class="font-bold text-slate-900 text-sm">Compensation & Experience</h2>
              <p class="text-xs text-slate-500">What are you offering and what do you require?</p>
            </div>
          </div>
          <div class="p-6 space-y-5">
            <!-- Pay Range -->
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1.5">
                Pay Range <span class="text-slate-400 font-normal">(CPM or weekly)</span>
              </label>
              <div class="pay-range-group">
                <input type="text" id="payMin" name="payMin"
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="Min (e.g., $0.55 or $1,200)">
                <span class="separator">to</span>
                <input type="text" id="payMax" name="payMax"
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                  placeholder="Max (e.g., $0.70 or $1,800)">
              </div>
            </div>

            <!-- Experience -->
            <div>
              <label for="minExperience" class="block text-xs font-semibold text-slate-700 mb-1.5">
                Minimum Experience Required
              </label>
              <select id="minExperience" name="minExperience"
                class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm bg-white">
                <option value="">Select...</option>
                <option value="0">No minimum</option>
                <option value="0.5">6 months</option>
                <option value="1">1 year</option>
                <option value="2">2+ years</option>
                <option value="3">3+ years</option>
                <option value="5">5+ years</option>
              </select>
            </div>

            <!-- Notes -->
            <div>
              <label for="additionalNotes" class="block text-xs font-semibold text-slate-700 mb-1.5">
                Additional Details <span class="text-slate-400 font-normal">(Optional)</span>
              </label>
              <textarea id="additionalNotes" name="additionalNotes" rows="3"
                class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm resize-none"
                placeholder="Any other details about your fleet, requirements, or preferences..."></textarea>
            </div>

            <!-- Referral Source -->
            <div>
              <label for="referredBy" class="block text-xs font-semibold text-slate-700 mb-1.5">
                Referred By <span class="text-slate-400 font-normal">(Optional)</span>
              </label>
              <input type="text" id="referredBy" name="referredBy"
                class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:border-lmdr-blue focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                placeholder="Dispatch company or referral source">
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="pt-2">
          <button type="submit" id="submitBtn"
            class="w-full bg-lmdr-dark text-white font-bold text-sm py-4 rounded-xl hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span id="submitBtnText">Submit Carrier Intake</span>
            <i class="fa-solid fa-arrow-right text-sm"></i>
            <i class="fa-solid fa-spinner fa-spin hidden text-sm" id="submitSpinner"></i>
          </button>
          <p class="text-center text-xs text-slate-400 mt-3">
            <i class="fa-solid fa-lock mr-1"></i> Your information is secure and will only be used for driver matching.
          </p>
        </div>

        <!-- Success Message -->
        <div id="formSuccess" class="hidden">
          <div class="bg-green-50 border border-green-200 rounded-2xl p-6 text-center">
            <div class="w-14 h-14 bg-green-100 rounded-full mx-auto flex items-center justify-center mb-3">
              <i class="fa-solid fa-circle-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="font-black text-lg text-slate-900 mb-1">Intake Submitted!</h3>
            <p class="text-sm text-slate-600">We'll match pre-qualified drivers to your fleet within <strong>24-48 hours</strong>.</p>
            <p class="text-xs text-slate-400 mt-2">A placement specialist will reach out to confirm your requirements.</p>
            <div class="mt-5 space-y-2">
              <button onclick="navigateParent('navigateToPreferences')"
                class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition text-sm">
                <i class="fa-solid fa-sliders mr-2"></i>Set Up Matching Preferences
              </button>
              <button onclick="navigateParent('navigateToDashboard')"
                class="w-full bg-white border border-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl hover:bg-slate-50 transition text-sm">
                <i class="fa-solid fa-gauge-high mr-2"></i>Go to Dashboard
              </button>
            </div>
          </div>
        </div>

        <!-- Error Message -->
        <div id="formError" class="hidden p-4 rounded-xl bg-red-50 border border-red-200 text-red-800">
          <div class="flex items-center gap-3">
            <i class="fa-solid fa-circle-exclamation text-red-600 text-xl"></i>
            <div>
              <p class="font-bold text-sm">Submission Error</p>
              <p class="text-xs" id="formErrorMessage">There was a problem submitting your request. Please try again.</p>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- FORM HANDLER (PostMessage Bridge)                                 -->
  <!-- ================================================================ -->
  <script>
    // Navigation helper - must be in global scope for onclick handlers
    function navigateParent(action) {
      window.parent.postMessage({ type: action, action: action }, '*');
    }
  </script>
  <script>
    (function() {
      'use strict';

      const DEBUG = true;
      const VELO_TIMEOUT = 30000;

      function log(...args) { if (DEBUG) console.log('[CarrierIntake]', ...args); }

      // ---- URL Param: Referral Source ----
      const urlParams = new URLSearchParams(window.location.search);
      const refParam = urlParams.get('ref');

      const REFERRAL_MAP = {
        'ashton': 'Ashton Logistics',
        'ashton-logistics': 'Ashton Logistics',
        'ashtonlogistics': 'Ashton Logistics'
      };

      if (refParam) {
        const refName = REFERRAL_MAP[refParam.toLowerCase()] || refParam;
        document.getElementById('referredBy').value = refName;
        log('Referral pre-filled:', refName);
      }

      // ---- Form Elements ----
      const form = document.getElementById('carrierIntakeForm');
      const submitBtn = document.getElementById('submitBtn');
      const submitBtnText = document.getElementById('submitBtnText');
      const submitSpinner = document.getElementById('submitSpinner');
      const formSuccess = document.getElementById('formSuccess');
      const formError = document.getElementById('formError');
      const formErrorMessage = document.getElementById('formErrorMessage');

      let pendingCallbacks = {};

      // ---- PostMessage Listener ----
      window.addEventListener('message', function(event) {
        const msg = event.data;
        if (!msg || !msg.type) return;
        log('Received:', msg.type);

        if (msg.type === 'staffingRequestResult' && pendingCallbacks.staffing) {
          pendingCallbacks.staffing(msg.data);
          delete pendingCallbacks.staffing;
        }
        if (msg.type === 'intakePreferencesResult' && pendingCallbacks.preferences) {
          pendingCallbacks.preferences(msg.data);
          delete pendingCallbacks.preferences;
        }
      });

      function sendToVelo(action, data) {
        return new Promise((resolve, reject) => {
          const callbackKey = action === 'submitCarrierStaffingRequest' ? 'staffing' : 'preferences';
          const timeoutId = setTimeout(() => {
            delete pendingCallbacks[callbackKey];
            reject(new Error('Request timed out. Please try again.'));
          }, VELO_TIMEOUT);

          pendingCallbacks[callbackKey] = (result) => {
            clearTimeout(timeoutId);
            resolve(result);
          };

          log('Sending:', action, data);
          window.parent.postMessage({ type: action, action: action, data: data }, '*');
        });
      }

      // ---- Collect Checked Values ----
      function getCheckedValues(name) {
        return Array.from(form.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
      }

      // ---- Parse Pay to Number ----
      function parsePay(str) {
        if (!str) return null;
        const cleaned = str.replace(/[^0-9.]/g, '');
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num;
      }

      // ---- Parse Experience to Years ----
      function parseExperience(val) {
        if (!val || val === '') return null;
        return parseFloat(val);
      }

      // ---- Build Form Data ----
      function getFormData() {
        const urgencyEl = form.querySelector('input[name="urgency"]:checked');
        const cdlTypes = getCheckedValues('cdlTypes');
        const endorsements = getCheckedValues('endorsements');
        const equipmentTypes = getCheckedValues('equipmentTypes');
        const routeTypes = getCheckedValues('routeTypes');

        return {
          // Company info
          companyName: form.querySelector('#companyName').value.trim(),
          contactName: form.querySelector('#contactName').value.trim(),
          email: form.querySelector('#email').value.trim(),
          phone: form.querySelector('#phone').value.trim(),
          dotNumber: form.querySelector('#dotNumber').value.trim(),

          // Driver needs
          driversNeeded: form.querySelector('#driversNeeded').value,
          urgency: urgencyEl ? urgencyEl.value : '',
          cdlTypes: cdlTypes,
          endorsements: endorsements,
          equipmentTypes: equipmentTypes,

          // Route & schedule
          routeTypes: routeTypes,
          primaryLanes: form.querySelector('#primaryLanes').value.trim(),
          homeTime: form.querySelector('#homeTime').value,
          schedule: form.querySelector('#schedule').value,

          // Compensation & experience
          payMin: parsePay(form.querySelector('#payMin').value),
          payMax: parsePay(form.querySelector('#payMax').value),
          minExperience: parseExperience(form.querySelector('#minExperience').value),

          // Notes & referral
          additionalNotes: form.querySelector('#additionalNotes').value.trim(),
          referredBy: form.querySelector('#referredBy').value.trim(),
          sourceUrl: window.location.href
        };
      }

      // ---- UI Helpers ----
      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        if (isLoading) {
          submitBtnText.textContent = 'Submitting...';
          submitSpinner.classList.remove('hidden');
          submitBtn.querySelector('.fa-arrow-right').classList.add('hidden');
        } else {
          submitBtnText.textContent = 'Submit Carrier Intake';
          submitSpinner.classList.add('hidden');
          submitBtn.querySelector('.fa-arrow-right').classList.remove('hidden');
        }
      }

      function showSuccess() {
        formSuccess.classList.remove('hidden');
        formError.classList.add('hidden');
        form.reset();
        submitBtn.closest('.pt-2').classList.add('hidden');
        formSuccess.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function showError(message) {
        formError.classList.remove('hidden');
        formSuccess.classList.add('hidden');
        formErrorMessage.textContent = message || 'There was a problem submitting your request. Please try again.';
        formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function hideMessages() {
        formSuccess.classList.add('hidden');
        formError.classList.add('hidden');
      }

      // ---- Parse States from Lanes Input ----
      function parseLanesToStates(lanesStr) {
        if (!lanesStr) return [];
        const stateAbbrevs = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
        const found = [];
        const upper = lanesStr.toUpperCase();
        stateAbbrevs.forEach(st => {
          if (upper.includes(st)) found.push(st);
        });
        return found;
      }

      // ---- Submit Handler ----
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        hideMessages();

        const data = getFormData();
        log('Form data:', data);

        // Validation
        if (!data.companyName) { showError('Please enter your company name.'); return; }
        if (!data.contactName) { showError('Please enter your name.'); return; }
        if (!data.email) { showError('Please enter your email address.'); return; }
        if (!data.phone) { showError('Please enter your phone number.'); return; }
        if (!data.driversNeeded) { showError('Please select how many drivers you need.'); return; }
        if (!data.urgency) { showError('Please select hiring urgency.'); return; }
        if (data.cdlTypes.length === 0) { showError('Please select at least one CDL type.'); return; }
        if (data.routeTypes.length === 0) { showError('Please select at least one route type.'); return; }

        setLoading(true);

        try {
          // === Message 1: Staffing Request (Lead) ===
          const staffingData = {
            companyName: data.companyName,
            contactName: data.contactName,
            email: data.email,
            phone: data.phone,
            dotNumber: data.dotNumber,
            staffingType: data.urgency === 'immediate' ? 'Emergency' : 'Strategic',
            driversNeeded: data.driversNeeded,
            driverTypes: [...data.cdlTypes.map(t => 'Class ' + t), ...data.endorsements],
            additionalNotes: [
              data.additionalNotes,
              data.routeTypes.length ? 'Routes: ' + data.routeTypes.join(', ') : '',
              data.primaryLanes ? 'Lanes: ' + data.primaryLanes : '',
              data.homeTime ? 'Home time: ' + data.homeTime : '',
              data.schedule ? 'Schedule: ' + data.schedule : '',
              data.payMin || data.payMax ? 'Pay: ' + (data.payMin || '?') + ' - ' + (data.payMax || '?') : '',
              data.referredBy ? 'Referred by: ' + data.referredBy : ''
            ].filter(Boolean).join(' | '),
            sourceUrl: data.sourceUrl
          };

          log('Sending staffing request:', staffingData);
          const staffingResult = await sendToVelo('submitCarrierStaffingRequest', staffingData);
          log('Staffing result:', staffingResult);

          if (!staffingResult || !staffingResult.success) {
            showError(staffingResult?.error || 'Failed to submit request.');
            setLoading(false);
            return;
          }

          // === Message 2: Carrier Preferences (Matching Criteria) ===
          if (data.dotNumber) {
            const prefsData = {
              carrier_dot: data.dotNumber,
              required_cdl_types: data.cdlTypes,
              required_endorsements: data.endorsements,
              target_radius_miles: 100,
              target_states: parseLanesToStates(data.primaryLanes),
              route_types: data.routeTypes,
              equipment_types: data.equipmentTypes,
              offered_pay_min: data.payMin,
              offered_pay_max: data.payMax,
              min_experience_years: data.minExperience,
              positions_open: parseInt(data.driversNeeded) || null,
              urgency: data.urgency,
              is_active: true
            };

            log('Sending preferences:', prefsData);
            try {
              const prefsResult = await sendToVelo('submitCarrierIntakePreferences', prefsData);
              log('Preferences result:', prefsResult);
            } catch (prefErr) {
              log('Preferences save failed (non-blocking):', prefErr);
              // Non-blocking: lead was already saved
            }
          }

          showSuccess();

        } catch (error) {
          log('Submit error:', error);
          showError(error.message || 'There was a problem submitting your request. Please try again.');
        } finally {
          setLoading(false);
        }
      });

      log('Carrier Intake Form initialized');
      window.parent.postMessage({ type: 'carrierIntakeReady', action: 'carrierIntakeReady' }, '*');
    })();
  </script>

</body>
</html>