<!DOCTYPE html>
<!--
================================================================================
CARRIER POLICY REPOSITORY (VelocityMatch)
================================================================================
PostMessage protocol (HTML -> Wix page code):
- { type: 'carrierPoliciesReady' }
- { type: 'getCarrierPolicies', data: { carrierId, status, limit, offset } }
- { type: 'createPolicy', data: { carrier_id, title, category, description, content_type, content, external_url, requires_acknowledgment, acknowledgment_deadline, target_audience, is_mandatory, status } }
- { type: 'updatePolicy', data: { policyId, updates } }
- { type: 'publishPolicyVersion', data: { policyId, changeSummary } }
- { type: 'archivePolicy', data: { policyId } }
- { type: 'uploadPolicyFile', data: { base64Data, fileName, mimeType, carrierId } }
- { type: 'getComplianceStatus', data: { carrierId } }

Wix -> HTML responses:
- { type: 'carrierPoliciesData', data: { success, policies, totalCount } }
- { type: 'policyActionResult', data: { success, policy, error } }
- { type: 'policyUploadResult', data: { success, fileUrl, error } }
- { type: 'complianceStatusData', data: { success, policies, error } }
- { type: 'carrierContext', data: { carrierId } }
================================================================================
-->
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Policy Repository | VelocityMatch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            vm: {
              ink: '#0b1220',
              slate: '#0f172a',
              steel: '#1f2937',
              sky: '#38bdf8',
              teal: '#14b8a6'
            }
          }
        }
      }
    };
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); }
    .thin-scroll::-webkit-scrollbar { width: 6px; }
    .thin-scroll::-webkit-scrollbar-thumb { background-color: rgba(148, 163, 184, 0.4); border-radius: 999px; }
    .tab-active { color: #38bdf8; border-bottom: 2px solid #38bdf8; }
    .tab-inactive { color: #94a3b8; border-bottom: 2px solid transparent; }
    .tab-inactive:hover { color: #e2e8f0; }
    .modal { opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
    .modal.active { opacity: 1; pointer-events: auto; }

    /* Sidebar styles */
    .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .fade-text { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
    .collapsed .fade-text { opacity: 0; pointer-events: none; display: none; }
    .collapsed .sidebar-header { justify-content: center; padding-left: 0; padding-right: 0; }
    .collapsed .logo-text { display: none; }
    .sidebar-link { transition: all 0.2s ease-in-out; white-space: nowrap; overflow: hidden; }
    .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.08); }
    .sidebar-link.active { background: linear-gradient(90deg, rgba(56, 189, 248, 0.2) 0%, transparent 100%); border-left: 4px solid #38bdf8; color: white; }
    .blob { position: absolute; border-radius: 50%; filter: blur(60px); z-index: 0; opacity: 0.6; animation: float-blob 10s infinite ease-in-out; }
    .blob-1 { top: -10%; left: -20%; width: 200px; height: 200px; background: #38bdf8; }
    .blob-2 { bottom: 10%; right: -20%; width: 180px; height: 180px; background: #6366f1; animation-delay: -5s; }
    @keyframes float-blob { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(15px, 30px); } }

    body.light-mode { background: #f8fafc; color: #0f172a; }
    body.light-mode .glass { background: rgba(255, 255, 255, 0.85); color: #0f172a; }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-vm-ink via-vm-slate to-black text-white flex overflow-hidden">
  <div class="relative h-full flex flex-col z-50 bg-slate-900 overflow-hidden shadow-2xl sidebar-transition" id="sidebar-container">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <aside id="sidebar" class="w-56 text-slate-300 flex flex-col h-full sidebar-transition group relative z-10 bg-slate-900/60 backdrop-blur-xl border-r border-white/5">
      <button onclick="toggleSidebar()" class="absolute -right-3 top-16 bg-vm-sky text-vm-ink w-6 h-6 rounded-full flex items-center justify-center shadow-lg border border-slate-900 hover:scale-110 transition-transform z-50 opacity-0 group-hover:opacity-100">
        <i class="fa-solid fa-chevron-left text-[10px]" id="toggleIcon"></i>
      </button>
      <div class="h-14 flex items-center px-5 border-b border-white/10 sidebar-header transition-all">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 bg-gradient-to-br from-sky-400 to-teal-400 rounded-lg flex-none flex items-center justify-center text-vm-ink font-black text-sm">VM</div>
          <div class="logo-text fade-text">
            <h1 class="font-bold text-white text-sm tracking-tight">Velocity<span class="text-sky-300">Match</span></h1>
            <p class="text-[10px] text-blue-200/70 uppercase font-bold tracking-wider">Carrier OS</p>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto thin-scroll py-4 space-y-1">
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium" data-page="dashboard">
          <i class="fa-solid fa-table-columns w-5 text-center flex-none text-slate-400"></i>
          <span class="fade-text">Dashboard</span>
        </a>
        <div class="px-5 mt-4 mb-2 text-[10px] font-bold uppercase tracking-widest text-blue-200/50 fade-text">Communication</div>
        <a href="#" class="sidebar-link flex items-center gap-3 px-5 py-2.5 text-sm font-medium" data-page="announcements">
          <i class="fa-solid fa-bullhorn w-5 text-center flex-none text-slate-400"></i>
          <span class="fade-text">Announcements</span>
        </a>
        <a href="#" class="sidebar-link active flex items-center gap-3 px-5 py-2.5 text-sm font-medium" data-page="policies">
          <i class="fa-solid fa-file-shield w-5 text-center flex-none"></i>
          <span class="fade-text">Policies</span>
        </a>
      </nav>
      <div class="border-t border-white/10 p-4">
        <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-xs text-slate-200 hover:bg-white/20" onclick="toggleTheme()">
          <i class="fa-solid fa-sun mr-2" id="themeIcon"></i><span class="fade-text" id="themeLabel">Light mode</span>
        </button>
      </div>
    </aside>
  </div>

  <main class="flex-1 min-w-0 overflow-y-auto">
    <div class="min-h-screen p-4 md:p-6">
      <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">Policy Repository</h1>
          <p class="text-sm text-slate-300">Manage handbooks, safety policies, and acknowledgments.</p>
        </div>
        <div class="flex items-center gap-3">
          <button class="px-3 py-2 rounded-lg bg-vm-steel text-sm text-slate-200 hover:bg-slate-700" onclick="refreshPolicies()">
            <i class="fa-solid fa-rotate-right mr-2"></i>Refresh
          </button>
          <button class="px-4 py-2 rounded-lg bg-vm-sky text-vm-ink font-semibold" onclick="openModal()">
            <i class="fa-solid fa-plus mr-2"></i>New Policy
          </button>
        </div>
      </header>

      <section class="mt-6 grid md:grid-cols-3 gap-4">
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Published</div>
          <div class="text-2xl font-bold mt-2" id="statPublished">--</div>
        </div>
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Drafts</div>
          <div class="text-2xl font-bold mt-2" id="statDrafts">--</div>
        </div>
        <div class="glass rounded-xl p-4 border border-white/10">
          <div class="text-xs uppercase tracking-widest text-slate-400">Compliance Avg</div>
          <div class="text-2xl font-bold mt-2" id="statCompliance">--%</div>
        </div>
      </section>

      <section class="mt-6">
        <div class="flex flex-wrap gap-4 border-b border-white/10 text-sm font-semibold">
          <button class="pb-3 tab-active" id="tabPublished" onclick="setTab('published')">Published</button>
          <button class="pb-3 tab-inactive" id="tabDraft" onclick="setTab('draft')">Drafts</button>
          <button class="pb-3 tab-inactive" id="tabArchived" onclick="setTab('archived')">Archived</button>
        </div>

        <div class="mt-4 grid lg:grid-cols-[2.2fr_1fr] gap-4">
          <div class="glass rounded-2xl border border-white/10 p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <h2 class="text-lg font-semibold">Policies</h2>
                <p class="text-xs text-slate-400">Status: <span id="currentStatus">Published</span></p>
              </div>
              <div class="flex items-center gap-2">
                <select id="categoryFilter" class="bg-vm-steel text-white text-sm rounded-lg px-3 py-2 border border-white/10" onchange="applyFilters()">
                  <option value="all">All categories</option>
                  <option value="handbook">Handbook</option>
                  <option value="safety">Safety</option>
                  <option value="sop">SOP</option>
                  <option value="compliance">Compliance</option>
                  <option value="hr">HR</option>
                </select>
                <input id="searchInput" type="text" placeholder="Search title..." class="bg-vm-steel text-white text-sm rounded-lg px-3 py-2 border border-white/10" oninput="applyFilters()" />
              </div>
            </div>
            <div class="mt-4 space-y-3 max-h-[520px] overflow-y-auto thin-scroll" id="policyList">
              <div class="p-4 rounded-xl bg-white/5 border border-white/10 animate-pulse">
                <div class="h-4 w-40 bg-white/10 rounded"></div>
                <div class="h-3 w-64 bg-white/10 rounded mt-2"></div>
              </div>
            </div>
          </div>
          <aside class="glass rounded-2xl border border-white/10 p-4 space-y-4">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-widest text-slate-400">Compliance</h3>
              <div class="text-sm text-slate-300" id="complianceSummary">-- policies tracked</div>
            </div>
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-widest text-slate-400">Actions</h3>
              <div class="mt-3 grid gap-2">
                <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-sm hover:bg-white/20" onclick="refreshCompliance()">
                  <i class="fa-solid fa-chart-simple mr-2"></i>Refresh Compliance
                </button>
                <button class="w-full px-3 py-2 rounded-lg bg-white/10 text-sm hover:bg-white/20" onclick="openModal()">
                  <i class="fa-solid fa-pen-to-square mr-2"></i>Create Policy
                </button>
              </div>
            </div>
          </aside>
        </div>
      </section>
    </div>
  </main>

  <div class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4" id="policyModal">
    <div class="bg-vm-slate border border-white/10 rounded-2xl w-full max-w-3xl p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Create Policy</h3>
        <button class="text-slate-300 hover:text-white" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Title</label>
          <input id="policyTitle" type="text" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" />
        </div>
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Category</label>
          <select id="policyCategory" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10">
            <option value="handbook">Handbook</option>
            <option value="safety">Safety</option>
            <option value="sop">SOP</option>
            <option value="compliance">Compliance</option>
            <option value="hr">HR</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs uppercase tracking-widest text-slate-400">Description</label>
          <textarea id="policyDescription" rows="3" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10"></textarea>
        </div>
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Content Type</label>
          <select id="policyContentType" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" onchange="toggleContentInputs()">
            <option value="markdown">Markdown</option>
            <option value="pdf">PDF Upload</option>
            <option value="external_link">External Link</option>
          </select>
        </div>
        <div>
          <label class="text-xs uppercase tracking-widest text-slate-400">Acknowledgment Deadline</label>
          <input id="policyDeadline" type="date" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" />
        </div>
        <div class="md:col-span-2" id="markdownWrapper">
          <label class="text-xs uppercase tracking-widest text-slate-400">Markdown Content</label>
          <textarea id="policyContent" rows="6" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10"></textarea>
        </div>
        <div class="md:col-span-2 hidden" id="pdfWrapper">
          <label class="text-xs uppercase tracking-widest text-slate-400">PDF (base64)</label>
          <textarea id="policyPdf" rows="4" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" placeholder="Paste base64 data URL here"></textarea>
        </div>
        <div class="md:col-span-2 hidden" id="linkWrapper">
          <label class="text-xs uppercase tracking-widest text-slate-400">External URL</label>
          <input id="policyExternalUrl" type="url" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" />
        </div>
        <div class="md:col-span-2 flex items-center gap-3">
          <input id="policyRequiresAck" type="checkbox" class="h-4 w-4" />
          <label for="policyRequiresAck" class="text-sm text-slate-300">Requires acknowledgment</label>
        </div>
        <div class="md:col-span-2 flex items-center gap-3">
          <input id="policyMandatory" type="checkbox" class="h-4 w-4" />
          <label for="policyMandatory" class="text-sm text-slate-300">Mandatory (cannot skip)</label>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs uppercase tracking-widest text-slate-400">Target Audience (JSON)</label>
          <textarea id="policyAudience" rows="3" class="mt-2 w-full bg-vm-steel text-white rounded-lg px-3 py-2 border border-white/10" placeholder='{"type":"all","segments":[]}'></textarea>
        </div>
      </div>
      <div class="mt-5 flex flex-wrap justify-end gap-2">
        <button class="px-4 py-2 rounded-lg bg-white/10 text-sm" onclick="closeModal()">Cancel</button>
        <button class="px-4 py-2 rounded-lg bg-vm-teal text-vm-ink font-semibold" onclick="submitPolicy()">Save Draft</button>
        <button class="px-4 py-2 rounded-lg bg-vm-sky text-vm-ink font-semibold" onclick="submitPolicy(true)">Publish</button>
      </div>
    </div>
  </div>

  <script>
    const state = { status: 'published', policies: [], filtered: [], carrierId: null };

    function postToParent(type, data) {
      window.parent.postMessage({ type, data }, '*');
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const icon = document.getElementById('toggleIcon');
      sidebar.classList.toggle('w-56');
      sidebar.classList.toggle('w-16');
      sidebar.classList.toggle('collapsed');
      icon.className = sidebar.classList.contains('collapsed') ? 'fa-solid fa-chevron-right text-[10px]' : 'fa-solid fa-chevron-left text-[10px]';
    }

    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('light-mode');
      const icon = document.getElementById('themeIcon');
      const label = document.getElementById('themeLabel');
      const isLight = body.classList.contains('light-mode');
      icon.className = isLight ? 'fa-solid fa-moon mr-2' : 'fa-solid fa-sun mr-2';
      label.textContent = isLight ? 'Dark mode' : 'Light mode';
    }

    function setTab(status) {
      state.status = status;
      document.getElementById('currentStatus').textContent = status[0].toUpperCase() + status.slice(1);
      ['published', 'draft', 'archived'].forEach(key => {
        const tab = document.getElementById(`tab${key[0].toUpperCase()}${key.slice(1)}`);
        tab.className = key === status ? 'pb-3 tab-active' : 'pb-3 tab-inactive';
      });
      refreshPolicies();
    }

    function refreshPolicies() {
      postToParent('getCarrierPolicies', { status: state.status, limit: 200, offset: 0 });
    }

    function refreshCompliance() {
      postToParent('getComplianceStatus', { carrierId: state.carrierId });
    }

    function openModal() {
      document.getElementById('policyModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('policyModal').classList.remove('active');
    }

    function toggleContentInputs() {
      const type = document.getElementById('policyContentType').value;
      document.getElementById('markdownWrapper').classList.toggle('hidden', type !== 'markdown');
      document.getElementById('pdfWrapper').classList.toggle('hidden', type !== 'pdf');
      document.getElementById('linkWrapper').classList.toggle('hidden', type !== 'external_link');
    }

    function applyFilters() {
      const category = document.getElementById('categoryFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      state.filtered = state.policies.filter(item => {
        const matchesCategory = category === 'all' || item.category === category;
        const matchesSearch = !search || (item.title || '').toLowerCase().includes(search);
        return matchesCategory && matchesSearch;
      });
      renderPolicies();
    }

    function renderPolicies() {
      const list = document.getElementById('policyList');
      if (!state.filtered.length) {
        list.innerHTML = '<div class="p-6 rounded-xl bg-white/5 border border-white/10 text-sm text-slate-300">No policies yet.</div>';
        return;
      }
      list.innerHTML = state.filtered.map(item => {
        const published = item.published_at ? new Date(item.published_at).toLocaleDateString() : 'Not published';
        return `
          <div class="p-4 rounded-xl bg-white/5 border border-white/10">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">${item.title || 'Untitled'}</div>
                <div class="text-xs text-slate-400">${item.category || 'category'} • v${item.current_version || 1} • ${published}</div>
              </div>
              <div class="flex items-center gap-2">
                <button class="px-3 py-1.5 rounded-lg bg-white/10 text-xs" onclick="publishPolicy('${item._id}')">Publish</button>
                <button class="px-3 py-1.5 rounded-lg bg-white/10 text-xs" onclick="archivePolicy('${item._id}')">Archive</button>
              </div>
            </div>
            <p class="text-sm text-slate-200 mt-2">${(item.description || '').slice(0, 120)}</p>
          </div>
        `;
      }).join('');
    }

    function updateStats() {
      const published = state.policies.filter(p => p.status === 'published').length;
      const drafts = state.policies.filter(p => p.status === 'draft').length;
      document.getElementById('statPublished').textContent = published;
      document.getElementById('statDrafts').textContent = drafts;
    }

    function submitPolicy(publishNow = false) {
      const title = document.getElementById('policyTitle').value.trim();
      if (!title) { alert('Title is required'); return; }

      let targetAudience = { type: 'all', segments: [] };
      const audienceValue = document.getElementById('policyAudience').value.trim();
      if (audienceValue) {
        try { targetAudience = JSON.parse(audienceValue); } catch (err) { alert('Invalid audience JSON'); return; }
      }

      const contentType = document.getElementById('policyContentType').value;
      let content = document.getElementById('policyContent').value.trim();
      let externalUrl = document.getElementById('policyExternalUrl').value.trim();
      if (contentType === 'pdf') {
        content = document.getElementById('policyPdf').value.trim();
      }

      const payload = {
        carrier_id: state.carrierId,
        title,
        category: document.getElementById('policyCategory').value,
        description: document.getElementById('policyDescription').value.trim(),
        content_type: contentType,
        content: content,
        external_url: externalUrl,
        requires_acknowledgment: document.getElementById('policyRequiresAck').checked,
        acknowledgment_deadline: document.getElementById('policyDeadline').value || null,
        target_audience: targetAudience,
        is_mandatory: document.getElementById('policyMandatory').checked,
        status: publishNow ? 'published' : 'draft'
      };

      postToParent('createPolicy', payload);
      closeModal();
    }

    function publishPolicy(id) {
      postToParent('publishPolicyVersion', { policyId: id, changeSummary: '' });
    }

    function archivePolicy(id) {
      postToParent('archivePolicy', { policyId: id });
    }

    document.querySelectorAll('.sidebar-link[data-page]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = link.getAttribute('data-page');
        if (page) window.parent.postMessage({ type: 'navigateTo', action: 'navigateTo', data: { page } }, '*');
      });
    });

    window.addEventListener('message', event => {
      const { type, data } = event.data || {};
      if (type === 'carrierPoliciesData') {
        state.policies = data?.policies || [];
        state.filtered = [...state.policies];
        updateStats();
        applyFilters();
      }
      if (type === 'complianceStatusData') {
        const policies = data?.policies || [];
        const avg = policies.length
          ? Math.round(policies.reduce((sum, p) => sum + (p.completionRate || 0), 0) / policies.length)
          : 0;
        document.getElementById('statCompliance').textContent = `${avg}%`;
        document.getElementById('complianceSummary').textContent = `${policies.length} policies tracked`;
      }
      if (type === 'policyActionResult') {
        refreshPolicies();
      }
      if (type === 'carrierContext') {
        state.carrierId = data?.carrierId || state.carrierId;
      }
    });

    postToParent('carrierPoliciesReady');
    refreshPolicies();
  </script>
</body>
</html>
