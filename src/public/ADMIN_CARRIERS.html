<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>LMDR Admin - Carriers Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2563eb",
                        "primary-dark": "#1d4ed8",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        "surface-dark": "#1e293b",
                        "surface-darker": "#0f172a",
                        "border-dark": "#334155",
                        "text-muted": "#94a3b8",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }

        /* Scrollbar styling */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loading skeleton */
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Row highlight on selection */
        tr.selected { background-color: rgba(37, 99, 235, 0.1) !important; }

        /* Dropdown menu */
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; z-index: 50; min-width: 180px; }
        .dropdown-menu.open { display: block; }

        /* Toast notifications */
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Modal backdrop */
        .modal-backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }

        /* Filter dropdown */
        .filter-dropdown { display: none; position: absolute; top: calc(100% + 4px); left: 0; z-index: 40; min-width: 200px; }
        .filter-dropdown.open { display: block; }

        /* Mobile card view */
        .carrier-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .carrier-card.selected {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.1);
        }

        /* Touch-friendly buttons */
        .touch-target { min-height: 44px; min-width: 44px; }

        /* Mobile-specific adjustments */
        @media (max-width: 767px) {
            .filter-dropdown {
                position: fixed;
                left: 16px;
                right: 16px;
                top: auto;
                bottom: 0;
                border-radius: 16px 16px 0 0;
                max-height: 60vh;
                overflow-y: auto;
            }
            .filter-dropdown::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #475569;
                border-radius: 2px;
                margin: 8px auto 16px;
            }
            .dropdown-menu {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: 0;
                top: auto;
                border-radius: 16px 16px 0 0;
            }
        }

        /* Bottom sheet overlay for mobile */
        .mobile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 39;
            display: none;
        }
        .mobile-overlay.open { display: block; }

        /* Swipe indicator */
        .swipe-hint {
            width: 40px;
            height: 4px;
            background: #475569;
            border-radius: 2px;
            margin: 8px auto;
        }

        /* Safe area padding for notched devices */
        @supports (padding: max(0px)) {
            .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
            .safe-top { padding-top: max(16px, env(safe-area-inset-top)); }
        }

        /* Prevent text selection on touch */
        .no-select { -webkit-user-select: none; user-select: none; }

        /* Active state for touch */
        .touch-active:active { opacity: 0.7; transform: scale(0.98); }

        /* Enrichment status badge */
        .enrichment-fresh { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .enrichment-stale { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .enrichment-expired { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .enrichment-none { background: rgba(100, 116, 139, 0.2); color: #64748b; }

        /* Safety rating colors */
        .safety-satisfactory { color: #22c55e; }
        .safety-conditional { color: #eab308; }
        .safety-unsatisfactory { color: #ef4444; }
        .safety-not-rated { color: #64748b; }

        /* Light mode overrides */
        html.light body { background-color: #f1f5f9; color: #1e293b; }
        html.light .bg-background-dark { background-color: #f1f5f9; }
        html.light .bg-surface-dark { background-color: #ffffff; }
        html.light .bg-surface-darker { background-color: #f8fafc; }
        html.light .bg-surface-darker\/50 { background-color: rgba(248, 250, 252, 0.5); }
        html.light .border-border-dark { border-color: #e2e8f0; }
        html.light .text-white { color: #1e293b; }
        html.light .text-text-muted { color: #64748b; }
        html.light .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); }
        html.light .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        html.light .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; }
        html.light tr.selected { background-color: rgba(37, 99, 235, 0.05) !important; }
    </style>
</head>
<body class="bg-background-dark font-display text-white antialiased selection:bg-primary selection:text-white">

<!-- Mobile Overlay -->
<div id="mobileOverlay" class="mobile-overlay" onclick="closeAllMenus()"></div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 left-4 md:left-auto z-[100] space-y-2"></div>

<!-- Main Container -->
<div class="flex flex-col h-full">

    <!-- Page Header - Mobile Optimized -->
    <header class="flex-shrink-0 border-b border-border-dark bg-surface-darker px-4 md:px-6 py-3 md:py-4 safe-top">
        <!-- Mobile Header -->
        <div class="flex items-center justify-between md:hidden mb-3">
            <h1 class="text-xl font-black tracking-tight">Carriers</h1>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" id="themeToggleMobile" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark">
                    <span class="material-symbols-outlined text-[20px]">dark_mode</span>
                </button>
                <button onclick="exportCarriers()" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-surface-dark border border-border-dark">
                    <span class="material-symbols-outlined text-[20px]">download</span>
                </button>
                <button onclick="openAddCarrierModal()" class="touch-target touch-active flex items-center justify-center w-10 h-10 rounded-lg bg-primary">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                </button>
            </div>
        </div>

        <!-- Desktop Header -->
        <div class="hidden md:flex flex-wrap justify-between gap-4">
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2 text-sm text-text-muted mb-1">
                    <span>Dashboard</span>
                    <span>/</span>
                    <span>Supply Management</span>
                    <span>/</span>
                    <span class="text-white">Carriers</span>
                </div>
                <h1 class="text-2xl font-black tracking-tight">Carriers Management</h1>
                <p class="text-sm text-text-muted">Manage carrier profiles, enrichment status, and FMCSA data.</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" id="themeToggleDesktop" class="flex h-10 w-10 items-center justify-center rounded-lg bg-surface-dark border border-border-dark hover:bg-[#2d3a4f] transition-colors" title="Toggle theme">
                    <span class="material-symbols-outlined text-[18px]">dark_mode</span>
                </button>
                <button onclick="exportCarriers()" class="flex h-10 items-center justify-center gap-2 rounded-lg bg-surface-dark border border-border-dark px-4 text-sm font-medium hover:bg-[#2d3a4f] transition-colors">
                    <span class="material-symbols-outlined text-[18px]">download</span>
                    <span>Export</span>
                </button>
                <button onclick="openAddCarrierModal()" class="flex h-10 items-center justify-center gap-2 rounded-lg bg-primary px-4 text-sm font-bold hover:bg-primary-dark transition-colors shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                    <span>Add Carrier</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Stats Cards - Mobile Scrollable -->
    <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 border-b border-border-dark bg-surface-darker/50">
        <!-- Mobile: Horizontal scroll -->
        <div class="flex md:hidden gap-3 overflow-x-auto scrollbar-hide pb-1 -mx-4 px-4">
            <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-text-muted text-[10px] font-medium uppercase">Total</span>
                    <div class="w-6 h-6 bg-primary/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-[14px]">local_shipping</span>
                    </div>
                </div>
                <div class="text-xl font-bold" id="statTotalCarriersMobile">--</div>
                <div class="text-[10px] text-emerald-400" id="statTotalCarriersTrendMobile">--</div>
            </div>
            <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-text-muted text-[10px] font-medium uppercase">Active</span>
                    <div class="w-6 h-6 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-emerald-400 text-[14px]">check_circle</span>
                    </div>
                </div>
                <div class="text-xl font-bold" id="statActiveCarriersMobile">--</div>
                <div class="text-[10px] text-text-muted" id="statActiveCarriersPercentMobile">--</div>
            </div>
            <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-text-muted text-[10px] font-medium uppercase">Flagged</span>
                    <div class="w-6 h-6 bg-amber-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-amber-400 text-[14px]">flag</span>
                    </div>
                </div>
                <div class="text-xl font-bold" id="statFlaggedCarriersMobile">--</div>
                <div class="text-[10px] text-amber-400">Needs review</div>
            </div>
            <div class="flex-shrink-0 w-36 bg-surface-dark border border-border-dark rounded-xl p-3">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-text-muted text-[10px] font-medium uppercase">Enriched</span>
                    <div class="w-6 h-6 bg-violet-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-violet-400 text-[14px]">auto_awesome</span>
                    </div>
                </div>
                <div class="text-xl font-bold" id="statEnrichedCarriersMobile">--</div>
                <div class="text-[10px] text-violet-400" id="statEnrichedPercentMobile">--</div>
            </div>
        </div>

        <!-- Desktop: Grid layout -->
        <div class="hidden md:grid grid-cols-4 gap-4">
            <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Total Carriers</span>
                    <div class="w-8 h-8 bg-primary/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-[18px]">local_shipping</span>
                    </div>
                </div>
                <div class="text-2xl font-bold" id="statTotalCarriers">--</div>
                <div class="text-xs text-emerald-400 mt-1" id="statTotalCarriersTrend">--</div>
            </div>
            <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Active</span>
                    <div class="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-emerald-400 text-[18px]">check_circle</span>
                    </div>
                </div>
                <div class="text-2xl font-bold" id="statActiveCarriers">--</div>
                <div class="text-xs text-text-muted mt-1" id="statActiveCarriersPercent">--</div>
            </div>
            <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Flagged for Review</span>
                    <div class="w-8 h-8 bg-amber-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-amber-400 text-[18px]">flag</span>
                    </div>
                </div>
                <div class="text-2xl font-bold" id="statFlaggedCarriers">--</div>
                <div class="text-xs text-amber-400 mt-1">Requires attention</div>
            </div>
            <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs font-medium uppercase tracking-wide">Enriched</span>
                    <div class="w-8 h-8 bg-violet-500/20 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-violet-400 text-[18px]">auto_awesome</span>
                    </div>
                </div>
                <div class="text-2xl font-bold" id="statEnrichedCarriers">--</div>
                <div class="text-xs text-violet-400 mt-1" id="statEnrichedPercent">--</div>
            </div>
        </div>
    </div>

    <!-- Toolbar & Filters - Mobile Optimized -->
    <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 bg-surface-darker border-b border-border-dark">
        <div class="flex flex-col gap-3">
            <!-- Search - Full width on mobile -->
            <div class="flex items-center gap-2 rounded-lg border border-border-dark bg-surface-dark px-3 py-2.5">
                <span class="material-symbols-outlined text-text-muted text-[20px]">search</span>
                <input id="searchInput" class="w-full bg-transparent text-sm placeholder-text-muted focus:outline-none" placeholder="Search carrier name, DOT, or city..." type="text" oninput="handleSearch()"/>
                <button id="clearSearchBtn" onclick="clearSearch()" class="hidden text-text-muted hover:text-white">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            </div>

            <!-- Filter chips row -->
            <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0">
                <!-- Status Filter -->
                <div class="relative flex-shrink-0">
                    <button onclick="toggleFilterDropdown('statusFilter')" class="filter-chip touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[16px]">toggle_on</span>
                        <span id="statusFilterLabel">Status</span>
                        <span class="material-symbols-outlined text-[16px]">expand_more</span>
                    </button>
                    <div id="statusFilter" class="filter-dropdown bg-surface-dark border border-border-dark rounded-xl shadow-xl p-2">
                        <button onclick="setFilter('status', 'all')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">All Statuses</button>
                        <button onclick="setFilter('status', 'active')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Active</button>
                        <button onclick="setFilter('status', 'inactive')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Inactive</button>
                        <button onclick="setFilter('status', 'pending_review')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Pending Review</button>
                        <button onclick="setFilter('status', 'suspended')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Suspended</button>
                    </div>
                </div>

                <!-- Fleet Size Filter -->
                <div class="relative flex-shrink-0">
                    <button onclick="toggleFilterDropdown('fleetFilter')" class="filter-chip touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[16px]">directions_bus</span>
                        <span id="fleetFilterLabel">Fleet Size</span>
                        <span class="material-symbols-outlined text-[16px]">expand_more</span>
                    </button>
                    <div id="fleetFilter" class="filter-dropdown bg-surface-dark border border-border-dark rounded-xl shadow-xl p-2">
                        <button onclick="setFilter('fleetSize', 'all')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">All Sizes</button>
                        <button onclick="setFilter('fleetSize', 'small')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Small (&lt; 50)</button>
                        <button onclick="setFilter('fleetSize', 'medium')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Medium (50-200)</button>
                        <button onclick="setFilter('fleetSize', 'large')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">Large (200+)</button>
                    </div>
                </div>

                <!-- Safety Rating Filter -->
                <div class="relative flex-shrink-0">
                    <button onclick="toggleFilterDropdown('safetyFilter')" class="filter-chip touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-surface-dark border border-border-dark text-sm hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[16px]">verified_user</span>
                        <span id="safetyFilterLabel">Safety</span>
                        <span class="material-symbols-outlined text-[16px]">expand_more</span>
                    </button>
                    <div id="safetyFilter" class="filter-dropdown bg-surface-dark border border-border-dark rounded-xl shadow-xl p-2">
                        <button onclick="setFilter('safetyRating', 'all')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target">All Ratings</button>
                        <button onclick="setFilter('safetyRating', 'SATISFACTORY')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target text-emerald-400">Satisfactory</button>
                        <button onclick="setFilter('safetyRating', 'CONDITIONAL')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target text-amber-400">Conditional</button>
                        <button onclick="setFilter('safetyRating', 'UNSATISFACTORY')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target text-rose-400">Unsatisfactory</button>
                        <button onclick="setFilter('safetyRating', 'NOT RATED')" class="w-full text-left px-3 py-2.5 text-sm rounded-lg hover:bg-[#2d3a4f] touch-target text-text-muted">Not Rated</button>
                    </div>
                </div>

                <!-- Bulk Actions (shown when selection exists) -->
                <div id="bulkActionsContainer" class="hidden ml-auto flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-text-muted"><span id="selectedCount">0</span> selected</span>
                        <button onclick="bulkActivate()" class="touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-emerald-600/20 text-emerald-400 text-sm font-medium hover:bg-emerald-600/30 transition-colors">
                            <span class="material-symbols-outlined text-[16px]">check_circle</span>
                            <span class="hidden sm:inline">Activate</span>
                        </button>
                        <button onclick="bulkFlag()" class="touch-target flex items-center gap-1.5 h-9 px-3 rounded-lg bg-amber-600/20 text-amber-400 text-sm font-medium hover:bg-amber-600/30 transition-colors">
                            <span class="material-symbols-outlined text-[16px]">flag</span>
                            <span class="hidden sm:inline">Flag</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area - Scrollable -->
    <div class="flex-1 overflow-hidden relative">
        <!-- Mobile Card View -->
        <div id="mobileCardView" class="md:hidden h-full overflow-y-auto scrollbar-thin px-4 py-3">
            <div id="mobileCarrierCards" class="space-y-3">
                <!-- Cards rendered here -->
            </div>
            <!-- Mobile Load More / Pagination -->
            <div id="mobilePagination" class="py-4 text-center">
                <div class="text-xs text-text-muted mb-3">
                    <span id="mobileResultCount">0</span> carriers
                </div>
                <button onclick="loadMore()" id="loadMoreBtn" class="hidden touch-active w-full py-3 bg-surface-dark border border-border-dark rounded-lg text-sm font-medium">
                    Load More
                </button>
            </div>
        </div>

        <!-- Desktop Table View -->
        <div id="desktopTableView" class="hidden md:block h-full px-6 py-4">
            <div class="h-full flex flex-col rounded-xl border border-border-dark bg-surface-darker overflow-hidden">
                <div class="flex-1 overflow-auto scrollbar-thin">
                    <table class="min-w-full">
                        <thead class="sticky top-0 z-10">
                            <tr class="bg-surface-dark border-b border-border-dark">
                                <th class="w-12 px-4 py-3">
                                    <input id="selectAllCheckbox" type="checkbox" class="h-4 w-4 rounded border-border-dark bg-surface-dark text-primary focus:ring-primary cursor-pointer" onchange="toggleSelectAll()"/>
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                    <button onclick="sortBy('name')" class="flex items-center gap-1 hover:text-primary transition-colors">
                                        Carrier
                                        <span class="material-symbols-outlined text-[16px]" id="sortIconName">unfold_more</span>
                                    </button>
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">DOT / MC</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Location</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">
                                    <button onclick="sortBy('fleetSize')" class="flex items-center gap-1 hover:text-primary transition-colors">
                                        Fleet
                                        <span class="material-symbols-outlined text-[16px]" id="sortIconFleet">unfold_more</span>
                                    </button>
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Safety</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Enrichment</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-text-muted">Status</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-text-muted">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="carriersTableBody" class="divide-y divide-border-dark">
                            <!-- Loading skeleton -->
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                        <span class="text-text-muted text-sm">Loading carriers...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-3 border-t border-border-dark bg-surface-dark px-4 py-3">
                    <div class="text-xs text-text-muted">
                        Showing <span id="paginationFrom" class="font-medium text-white">0</span> to <span id="paginationTo" class="font-medium text-white">0</span> of <span id="paginationTotal" class="font-medium text-white">0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="pageSizeSelect" onchange="changePageSize()" class="h-8 rounded-lg border border-border-dark bg-surface-dark px-2 text-xs focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <div class="flex gap-1">
                            <button onclick="goToPage('prev')" id="prevPageBtn" disabled class="touch-target flex h-8 items-center justify-center rounded-lg border border-border-dark bg-surface-dark px-3 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined text-[18px]">chevron_left</span>
                            </button>
                            <button onclick="goToPage('next')" id="nextPageBtn" class="touch-target flex h-8 items-center justify-center rounded-lg border border-border-dark bg-surface-dark px-3 text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Carrier Detail Modal - Full screen on mobile -->
<div id="carrierDetailModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeCarrierModal()"></div>
    <div class="absolute inset-0 md:inset-auto md:right-0 md:top-0 md:h-full md:w-full md:max-w-2xl bg-surface-darker md:border-l border-border-dark shadow-2xl overflow-y-auto safe-bottom">
        <div id="carrierDetailContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Mobile Action Sheet -->
<div id="mobileActionSheet" class="fixed inset-x-0 bottom-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeMobileActionSheet()"></div>
    <div class="absolute inset-x-0 bottom-0 bg-surface-dark border-t border-border-dark rounded-t-2xl safe-bottom">
        <div class="swipe-hint"></div>
        <div id="mobileActionSheetContent" class="px-4 pb-4">
            <!-- Actions rendered here -->
        </div>
    </div>
</div>

<script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let state = {
        carriers: [],
        selectedIds: new Set(),
        currentPage: 1,
        pageSize: 25,
        totalCount: 0,
        sortField: 'lastUpdated',
        sortDirection: 'desc',
        filters: {
            status: 'all',
            fleetSize: 'all',
            safetyRating: 'all',
            search: ''
        },
        isLoading: false,
        viewMode: 'card',
        isMobile: window.innerWidth < 768
    };

    const VALID_ACTIONS = [
        'carriersLoaded', 'carrierDetail', 'statsLoaded',
        'actionSuccess', 'actionError', 'init', 'exportReady',
        'stateDistribution'
    ];

    function isValidMessage(data) {
        return data && typeof data === 'object' &&
               typeof data.action === 'string' &&
               VALID_ACTIONS.includes(data.action);
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('message', handleMessage);
    window.addEventListener('resize', handleResize);

    document.addEventListener('DOMContentLoaded', () => {
        handleResize();
        sendToVelo({ action: 'getCarriers', filters: state.filters, page: 1, pageSize: state.pageSize });
        sendToVelo({ action: 'getStats' });
    });

    function handleResize() {
        const wasMobile = state.isMobile;
        state.isMobile = window.innerWidth < 768;

        if (wasMobile !== state.isMobile) {
            renderContent();
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-chip') && !e.target.closest('.filter-dropdown')) {
            document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
            document.getElementById('mobileOverlay').classList.remove('open');
        }
        if (!e.target.closest('.action-btn') && !e.target.closest('.dropdown-menu')) {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('open'));
        }
    });

    // ============================================
    // MESSAGE HANDLING
    // ============================================
    function handleMessage(event) {
        const data = event.data;
        if (!isValidMessage(data)) return;

        switch (data.action) {
            case 'init':
                sendToVelo({ action: 'getCarriers', filters: state.filters, page: 1, pageSize: state.pageSize });
                sendToVelo({ action: 'getStats' });
                break;
            case 'carriersLoaded':
                handleCarriersLoaded(data.payload);
                break;
            case 'carrierDetail':
                showCarrierDetail(data.payload);
                break;
            case 'statsLoaded':
                updateStats(data.payload);
                break;
            case 'actionSuccess':
                showToast(data.message || 'Action completed successfully', 'success');
                refreshData();
                break;
            case 'actionError':
                showToast(data.message || 'An error occurred', 'error');
                break;
            case 'exportReady':
                downloadCSV(data.payload);
                break;
        }
    }

    function sendToVelo(message) {
        window.parent.postMessage(message, '*');
    }

    // ============================================
    // DATA HANDLERS
    // ============================================
    function handleCarriersLoaded(payload) {
        state.carriers = payload.carriers || [];
        state.totalCount = payload.totalCount || 0;
        state.currentPage = payload.currentPage || 1;
        state.pageSize = payload.pageSize || 25;
        state.isLoading = false;

        renderContent();
        updatePagination();
    }

    function refreshData() {
        state.isLoading = true;
        state.selectedIds.clear();
        updateBulkActionsVisibility();
        sendToVelo({
            action: 'getCarriers',
            filters: state.filters,
            page: state.currentPage,
            pageSize: state.pageSize,
            sortField: state.sortField,
            sortDirection: state.sortDirection
        });
        sendToVelo({ action: 'getStats' });
    }

    function updateStats(stats) {
        // Desktop
        document.getElementById('statTotalCarriers').textContent = stats.total?.toLocaleString() || '0';
        document.getElementById('statActiveCarriers').textContent = stats.active?.toLocaleString() || '0';
        document.getElementById('statActiveCarriersPercent').textContent = `${stats.activePercent || 0}% of total`;
        document.getElementById('statFlaggedCarriers').textContent = stats.flagged?.toLocaleString() || '0';
        document.getElementById('statEnrichedCarriers').textContent = stats.enriched?.toLocaleString() || '0';
        document.getElementById('statEnrichedPercent').textContent = `${stats.enrichedPercent || 0}% coverage`;
        document.getElementById('statTotalCarriersTrend').textContent = `+${stats.newThisWeek || 0} this week`;

        // Mobile
        document.getElementById('statTotalCarriersMobile').textContent = stats.total?.toLocaleString() || '0';
        document.getElementById('statActiveCarriersMobile').textContent = stats.active?.toLocaleString() || '0';
        document.getElementById('statActiveCarriersPercentMobile').textContent = `${stats.activePercent || 0}%`;
        document.getElementById('statFlaggedCarriersMobile').textContent = stats.flagged?.toLocaleString() || '0';
        document.getElementById('statEnrichedCarriersMobile').textContent = stats.enriched?.toLocaleString() || '0';
        document.getElementById('statEnrichedPercentMobile').textContent = `${stats.enrichedPercent || 0}%`;
        document.getElementById('statTotalCarriersTrendMobile').textContent = `+${stats.newThisWeek || 0}`;
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderContent() {
        if (state.isMobile) {
            renderMobileCards();
        } else {
            renderDesktopTable();
        }
    }

    function renderMobileCards() {
        const container = document.getElementById('mobileCarrierCards');
        document.getElementById('mobileResultCount').textContent = state.totalCount;

        if (state.carriers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-4xl text-text-muted mb-3 block">local_shipping</span>
                    <p class="text-text-muted">No carriers found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = state.carriers.map(carrier => renderCarrierCard(carrier)).join('');
    }

    function renderCarrierCard(carrier) {
        const isSelected = state.selectedIds.has(carrier._id);
        const safetyClass = getSafetyClass(carrier.safetyRating);
        const enrichmentClass = getEnrichmentClass(carrier.enrichmentStatus);

        return `
            <div class="carrier-card ${isSelected ? 'selected' : ''}" data-id="${carrier._id}">
                <div class="flex items-start gap-3">
                    <input type="checkbox" ${isSelected ? 'checked' : ''}
                        class="h-5 w-5 rounded border-border-dark bg-surface-dark text-primary mt-1"
                        onchange="toggleSelection('${carrier._id}')"/>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="viewCarrier('${carrier._id}')" class="font-semibold text-white hover:text-primary truncate text-left">
                                ${carrier.legalName}
                            </button>
                            ${carrier.isFlagged ? '<span class="material-symbols-outlined text-amber-400 text-[16px]">flag</span>' : ''}
                        </div>
                        <div class="text-xs text-text-muted mb-2">DOT: ${carrier.dotNumber}${carrier.mcNumber ? ` | MC: ${carrier.mcNumber}` : ''}</div>

                        <div class="flex flex-wrap gap-2 mb-3">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-medium ${safetyClass}">
                                <span class="material-symbols-outlined text-[12px]">verified_user</span>
                                ${carrier.safetyRating || 'Not Rated'}
                            </span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-medium ${enrichmentClass}">
                                <span class="material-symbols-outlined text-[12px]">auto_awesome</span>
                                ${carrier.enrichmentStatus || 'None'}
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-text-muted">Location:</span>
                                <span class="ml-1">${carrier.city}, ${carrier.state}</span>
                            </div>
                            <div>
                                <span class="text-text-muted">Fleet:</span>
                                <span class="ml-1">${carrier.fleetSize} trucks</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="showMobileActions('${carrier._id}')" class="touch-target flex items-center justify-center w-10 h-10 -mr-2 text-text-muted">
                        <span class="material-symbols-outlined">more_vert</span>
                    </button>
                </div>
            </div>
        `;
    }

    function renderDesktopTable() {
        const tbody = document.getElementById('carriersTableBody');

        if (state.carriers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-4 py-12 text-center">
                        <span class="material-symbols-outlined text-4xl text-text-muted mb-3 block">local_shipping</span>
                        <p class="text-text-muted">No carriers found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = state.carriers.map(carrier => {
            const isSelected = state.selectedIds.has(carrier._id);
            const safetyClass = getSafetyClass(carrier.safetyRating);
            const enrichmentClass = getEnrichmentClass(carrier.enrichmentStatus);
            const statusClass = getStatusClass(carrier.status);

            return `
                <tr class="${isSelected ? 'selected' : ''} hover:bg-surface-dark/50 transition-colors">
                    <td class="px-4 py-3">
                        <input type="checkbox" ${isSelected ? 'checked' : ''}
                            class="h-4 w-4 rounded border-border-dark bg-surface-dark text-primary cursor-pointer"
                            onchange="toggleSelection('${carrier._id}')"/>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-primary text-[20px]">local_shipping</span>
                            </div>
                            <div class="min-w-0">
                                <button onclick="viewCarrier('${carrier._id}')" class="font-medium text-white hover:text-primary text-left block truncate max-w-[200px]">
                                    ${carrier.legalName}
                                </button>
                                ${carrier.dbaName ? `<div class="text-xs text-text-muted truncate">DBA: ${carrier.dbaName}</div>` : ''}
                            </div>
                            ${carrier.isFlagged ? '<span class="material-symbols-outlined text-amber-400 text-[16px]">flag</span>' : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${carrier.dotNumber}</div>
                        ${carrier.mcNumber ? `<div class="text-xs text-text-muted">MC: ${carrier.mcNumber}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 text-sm">${carrier.city}, ${carrier.state}</td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium">${carrier.fleetSize}</div>
                        <div class="text-xs text-text-muted">${carrier.driverCount} drivers</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium ${safetyClass}">
                            ${carrier.safetyRating || 'Not Rated'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium ${enrichmentClass}">
                            <span class="material-symbols-outlined text-[14px]">auto_awesome</span>
                            ${capitalizeFirst(carrier.enrichmentStatus) || 'None'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-block px-2 py-1 rounded-md text-xs font-medium ${statusClass}">
                            ${capitalizeFirst(carrier.status)}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="relative inline-block">
                            <button onclick="toggleActionMenu('menu-${carrier._id}')" class="action-btn touch-target flex items-center justify-center w-8 h-8 rounded-lg hover:bg-surface-dark transition-colors">
                                <span class="material-symbols-outlined text-[20px]">more_horiz</span>
                            </button>
                            <div id="menu-${carrier._id}" class="dropdown-menu bg-surface-dark border border-border-dark rounded-xl shadow-xl py-2">
                                <button onclick="viewCarrier('${carrier._id}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-[#2d3a4f] flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[18px]">visibility</span>
                                    View Details
                                </button>
                                <button onclick="viewFMCSA('${carrier.dotNumber}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-[#2d3a4f] flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[18px]">open_in_new</span>
                                    View FMCSA
                                </button>
                                <button onclick="refreshEnrichment('${carrier._id}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-[#2d3a4f] flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[18px]">refresh</span>
                                    Refresh Enrichment
                                </button>
                                <div class="border-t border-border-dark my-1"></div>
                                ${carrier.status === 'active' ? `
                                    <button onclick="flagCarrier('${carrier._id}')" class="w-full text-left px-4 py-2.5 text-sm text-amber-400 hover:bg-[#2d3a4f] flex items-center gap-2">
                                        <span class="material-symbols-outlined text-[18px]">flag</span>
                                        Flag for Review
                                    </button>
                                    <button onclick="deactivateCarrier('${carrier._id}')" class="w-full text-left px-4 py-2.5 text-sm text-rose-400 hover:bg-[#2d3a4f] flex items-center gap-2">
                                        <span class="material-symbols-outlined text-[18px]">block</span>
                                        Deactivate
                                    </button>
                                ` : `
                                    <button onclick="activateCarrier('${carrier._id}')" class="w-full text-left px-4 py-2.5 text-sm text-emerald-400 hover:bg-[#2d3a4f] flex items-center gap-2">
                                        <span class="material-symbols-outlined text-[18px]">check_circle</span>
                                        Activate
                                    </button>
                                `}
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function getSafetyClass(rating) {
        switch (rating?.toUpperCase()) {
            case 'SATISFACTORY': return 'bg-emerald-500/20 text-emerald-400';
            case 'CONDITIONAL': return 'bg-amber-500/20 text-amber-400';
            case 'UNSATISFACTORY': return 'bg-rose-500/20 text-rose-400';
            default: return 'bg-slate-500/20 text-slate-400';
        }
    }

    function getEnrichmentClass(status) {
        switch (status) {
            case 'fresh': return 'enrichment-fresh';
            case 'stale': return 'enrichment-stale';
            case 'expired': return 'enrichment-expired';
            default: return 'enrichment-none';
        }
    }

    function getStatusClass(status) {
        switch (status) {
            case 'active': return 'bg-emerald-500/20 text-emerald-400';
            case 'inactive': return 'bg-slate-500/20 text-slate-400';
            case 'pending_review': return 'bg-amber-500/20 text-amber-400';
            case 'suspended': return 'bg-rose-500/20 text-rose-400';
            default: return 'bg-slate-500/20 text-slate-400';
        }
    }

    function capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1).replace(/_/g, ' ');
    }

    // ============================================
    // SELECTION & BULK ACTIONS
    // ============================================
    function toggleSelection(id) {
        if (state.selectedIds.has(id)) {
            state.selectedIds.delete(id);
        } else {
            state.selectedIds.add(id);
        }
        updateBulkActionsVisibility();
        renderContent();
    }

    function toggleSelectAll() {
        const checkbox = document.getElementById('selectAllCheckbox');
        if (checkbox.checked) {
            state.carriers.forEach(c => state.selectedIds.add(c._id));
        } else {
            state.selectedIds.clear();
        }
        updateBulkActionsVisibility();
        renderContent();
    }

    function updateBulkActionsVisibility() {
        const container = document.getElementById('bulkActionsContainer');
        document.getElementById('selectedCount').textContent = state.selectedIds.size;
        if (state.selectedIds.size > 0) {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    }

    function bulkActivate() {
        if (state.selectedIds.size === 0) return;
        sendToVelo({ action: 'bulkActivate', carrierIds: Array.from(state.selectedIds) });
    }

    function bulkFlag() {
        if (state.selectedIds.size === 0) return;
        sendToVelo({ action: 'bulkFlag', carrierIds: Array.from(state.selectedIds) });
    }

    // ============================================
    // ACTIONS
    // ============================================
    function viewCarrier(id) {
        closeAllMenus();
        sendToVelo({ action: 'getCarrierDetail', carrierId: id });
    }

    function viewFMCSA(dotNumber) {
        closeAllMenus();
        sendToVelo({ action: 'viewFMCSA', dotNumber: dotNumber });
    }

    function activateCarrier(id) {
        closeAllMenus();
        sendToVelo({ action: 'updateStatus', carrierId: id, status: 'active', reason: 'Admin activated' });
    }

    function deactivateCarrier(id) {
        closeAllMenus();
        sendToVelo({ action: 'updateStatus', carrierId: id, status: 'inactive', reason: 'Admin deactivated' });
    }

    function flagCarrier(id) {
        closeAllMenus();
        sendToVelo({ action: 'flagCarrier', carrierId: id, reason: 'Flagged via admin panel' });
    }

    function unflagCarrier(id) {
        closeAllMenus();
        sendToVelo({ action: 'unflagCarrier', carrierId: id });
    }

    function refreshEnrichment(id) {
        closeAllMenus();
        sendToVelo({ action: 'refreshEnrichment', carrierId: id });
    }

    function exportCarriers() {
        sendToVelo({ action: 'exportCarriers', filters: state.filters });
    }

    function openAddCarrierModal() {
        sendToVelo({ action: 'openAddCarrierModal' });
    }

    function downloadCSV(csvContent) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `carriers_export_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(url);
        showToast('Export downloaded', 'success');
    }

    // ============================================
    // FILTERING & SEARCH
    // ============================================
    let searchTimeout;
    function handleSearch() {
        const input = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearchBtn');

        clearBtn.classList.toggle('hidden', !input.value);

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            state.filters.search = input.value;
            state.currentPage = 1;
            refreshData();
        }, 300);
    }

    function clearSearch() {
        const input = document.getElementById('searchInput');
        input.value = '';
        document.getElementById('clearSearchBtn').classList.add('hidden');
        state.filters.search = '';
        state.currentPage = 1;
        refreshData();
    }

    function setFilter(filterName, value) {
        state.filters[filterName] = value;
        state.currentPage = 1;

        // Update filter label
        const labelMap = {
            status: { all: 'Status', active: 'Active', inactive: 'Inactive', pending_review: 'Pending', suspended: 'Suspended' },
            fleetSize: { all: 'Fleet Size', small: 'Small', medium: 'Medium', large: 'Large' },
            safetyRating: { all: 'Safety', SATISFACTORY: 'Satisfactory', CONDITIONAL: 'Conditional', UNSATISFACTORY: 'Unsatisfactory', 'NOT RATED': 'Not Rated' }
        };

        if (filterName === 'status') {
            document.getElementById('statusFilterLabel').textContent = labelMap.status[value] || 'Status';
        } else if (filterName === 'fleetSize') {
            document.getElementById('fleetFilterLabel').textContent = labelMap.fleetSize[value] || 'Fleet Size';
        } else if (filterName === 'safetyRating') {
            document.getElementById('safetyFilterLabel').textContent = labelMap.safetyRating[value] || 'Safety';
        }

        closeAllMenus();
        refreshData();
    }

    function toggleFilterDropdown(id) {
        const dropdown = document.getElementById(id);
        const wasOpen = dropdown.classList.contains('open');

        closeAllMenus();

        if (!wasOpen) {
            dropdown.classList.add('open');
            if (state.isMobile) {
                document.getElementById('mobileOverlay').classList.add('open');
            }
        }
    }

    // ============================================
    // PAGINATION & SORTING
    // ============================================
    function updatePagination() {
        const from = state.totalCount === 0 ? 0 : (state.currentPage - 1) * state.pageSize + 1;
        const to = Math.min(state.currentPage * state.pageSize, state.totalCount);
        const totalPages = Math.ceil(state.totalCount / state.pageSize);

        document.getElementById('paginationFrom').textContent = from;
        document.getElementById('paginationTo').textContent = to;
        document.getElementById('paginationTotal').textContent = state.totalCount;

        document.getElementById('prevPageBtn').disabled = state.currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = state.currentPage >= totalPages;

        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (state.currentPage < totalPages) {
            loadMoreBtn.classList.remove('hidden');
        } else {
            loadMoreBtn.classList.add('hidden');
        }
    }

    function goToPage(direction) {
        if (direction === 'prev' && state.currentPage > 1) {
            state.currentPage--;
        } else if (direction === 'next') {
            state.currentPage++;
        }
        refreshData();
    }

    function changePageSize() {
        state.pageSize = parseInt(document.getElementById('pageSizeSelect').value);
        state.currentPage = 1;
        refreshData();
    }

    function loadMore() {
        state.currentPage++;
        sendToVelo({
            action: 'getCarriers',
            filters: state.filters,
            page: state.currentPage,
            pageSize: state.pageSize,
            sortField: state.sortField,
            sortDirection: state.sortDirection
        });
    }

    function sortBy(field) {
        if (state.sortField === field) {
            state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortField = field;
            state.sortDirection = 'desc';
        }

        // Update sort icons
        document.querySelectorAll('[id^="sortIcon"]').forEach(el => {
            el.textContent = 'unfold_more';
        });
        const activeIcon = document.getElementById('sortIcon' + capitalizeFirst(field));
        if (activeIcon) {
            activeIcon.textContent = state.sortDirection === 'asc' ? 'expand_less' : 'expand_more';
        }

        state.currentPage = 1;
        refreshData();
    }

    // ============================================
    // MODALS & ACTION SHEETS
    // ============================================
    function showCarrierDetail(carrier) {
        const modal = document.getElementById('carrierDetailModal');
        const content = document.getElementById('carrierDetailContent');

        const safetyHtml = carrier.safetyData ? `
            <div class="bg-surface-dark rounded-xl p-4 mb-4">
                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">verified_user</span>
                    FMCSA Safety Data
                </h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-text-muted">Rating:</span>
                        <span class="ml-2 font-medium ${getSafetyClass(carrier.safetyData.safetyRating).split(' ')[1]}">${carrier.safetyData.safetyRating}</span>
                    </div>
                    <div>
                        <span class="text-text-muted">Authorized:</span>
                        <span class="ml-2 ${carrier.safetyData.isAuthorized ? 'text-emerald-400' : 'text-rose-400'}">${carrier.safetyData.isAuthorized ? 'Yes' : 'No'}</span>
                    </div>
                </div>
                ${carrier.safetyData.lastFetched ? `<div class="text-xs text-text-muted mt-3">Last updated: ${new Date(carrier.safetyData.lastFetched).toLocaleDateString()}</div>` : ''}
            </div>
        ` : '';

        const enrichmentHtml = carrier.enrichment?.hasEnrichment ? `
            <div class="bg-surface-dark rounded-xl p-4 mb-4">
                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">auto_awesome</span>
                    AI Enrichment
                </h4>
                <div class="text-sm space-y-2">
                    <div class="flex justify-between">
                        <span class="text-text-muted">Cache Age:</span>
                        <span>${carrier.enrichment.cacheAge} days</span>
                    </div>
                    ${carrier.enrichment.socialScore ? `
                        <div class="flex justify-between">
                            <span class="text-text-muted">Social Score:</span>
                            <span>${carrier.enrichment.socialScore}/100</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        ` : '';

        content.innerHTML = `
            <div class="sticky top-0 z-10 bg-surface-darker border-b border-border-dark px-4 md:px-6 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold truncate pr-4">${carrier.legal_name || carrier.legalName}</h2>
                <button onclick="closeCarrierModal()" class="touch-target flex items-center justify-center w-10 h-10 rounded-lg hover:bg-surface-dark transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="px-4 md:px-6 py-4">
                <!-- Basic Info -->
                <div class="bg-surface-dark rounded-xl p-4 mb-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-text-muted block text-xs mb-1">DOT Number</span>
                            <span class="font-medium">${carrier.dot_number || carrier.dotNumber}</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">MC Number</span>
                            <span class="font-medium">${carrier.mc_number || carrier.mcNumber || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Location</span>
                            <span class="font-medium">${carrier.phy_city || carrier.city}, ${carrier.phy_state || carrier.state}</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Phone</span>
                            <span class="font-medium">${carrier.telephone || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Fleet Size</span>
                            <span class="font-medium">${carrier.nbr_power_unit || carrier.fleetSize || 0} trucks</span>
                        </div>
                        <div>
                            <span class="text-text-muted block text-xs mb-1">Drivers</span>
                            <span class="font-medium">${carrier.driver_total || carrier.driverCount || 0}</span>
                        </div>
                    </div>
                </div>

                ${safetyHtml}
                ${enrichmentHtml}

                <!-- Stats -->
                <div class="bg-surface-dark rounded-xl p-4 mb-4">
                    <h4 class="text-sm font-semibold mb-3">Match Activity</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-center p-3 bg-surface-darker rounded-lg">
                            <div class="text-2xl font-bold text-primary">${carrier.stats?.totalMatches || 0}</div>
                            <div class="text-xs text-text-muted">Total Matches</div>
                        </div>
                        <div class="text-center p-3 bg-surface-darker rounded-lg">
                            <div class="text-2xl font-bold text-violet-400">${carrier.stats?.driverInterests || 0}</div>
                            <div class="text-xs text-text-muted">Driver Interests</div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col gap-2">
                    <button onclick="viewFMCSA('${carrier.dot_number || carrier.dotNumber}')" class="touch-target w-full flex items-center justify-center gap-2 h-12 rounded-lg bg-surface-dark border border-border-dark text-sm font-medium hover:bg-[#2d3a4f] transition-colors">
                        <span class="material-symbols-outlined text-[18px]">open_in_new</span>
                        View on FMCSA SAFER
                    </button>
                    <button onclick="refreshEnrichment('${carrier._id}')" class="touch-target w-full flex items-center justify-center gap-2 h-12 rounded-lg bg-violet-600/20 text-violet-400 text-sm font-medium hover:bg-violet-600/30 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">refresh</span>
                        Refresh Enrichment
                    </button>
                    ${carrier.isFlagged ? `
                        <button onclick="unflagCarrier('${carrier._id}')" class="touch-target w-full flex items-center justify-center gap-2 h-12 rounded-lg bg-emerald-600/20 text-emerald-400 text-sm font-medium hover:bg-emerald-600/30 transition-colors">
                            <span class="material-symbols-outlined text-[18px]">flag_off</span>
                            Remove Flag
                        </button>
                    ` : `
                        <button onclick="flagCarrier('${carrier._id}')" class="touch-target w-full flex items-center justify-center gap-2 h-12 rounded-lg bg-amber-600/20 text-amber-400 text-sm font-medium hover:bg-amber-600/30 transition-colors">
                            <span class="material-symbols-outlined text-[18px]">flag</span>
                            Flag for Review
                        </button>
                    `}
                </div>
            </div>
        `;

        modal.classList.remove('hidden');
    }

    function closeCarrierModal() {
        document.getElementById('carrierDetailModal').classList.add('hidden');
    }

    function showMobileActions(carrierId) {
        const carrier = state.carriers.find(c => c._id === carrierId);
        if (!carrier) return;

        const sheet = document.getElementById('mobileActionSheet');
        const content = document.getElementById('mobileActionSheetContent');

        content.innerHTML = `
            <div class="text-sm font-semibold text-text-muted mb-3 truncate">${carrier.legalName}</div>
            <div class="space-y-2">
                <button onclick="viewCarrier('${carrierId}')" class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-darker text-left">
                    <span class="material-symbols-outlined text-[20px]">visibility</span>
                    <span>View Details</span>
                </button>
                <button onclick="viewFMCSA('${carrier.dotNumber}')" class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-darker text-left">
                    <span class="material-symbols-outlined text-[20px]">open_in_new</span>
                    <span>View on FMCSA</span>
                </button>
                <button onclick="refreshEnrichment('${carrierId}')" class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-darker text-left">
                    <span class="material-symbols-outlined text-[20px]">refresh</span>
                    <span>Refresh Enrichment</span>
                </button>
                <div class="border-t border-border-dark my-2"></div>
                ${carrier.status === 'active' ? `
                    <button onclick="flagCarrier('${carrierId}')" class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-darker text-amber-400 text-left">
                        <span class="material-symbols-outlined text-[20px]">flag</span>
                        <span>Flag for Review</span>
                    </button>
                    <button onclick="deactivateCarrier('${carrierId}')" class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-darker text-rose-400 text-left">
                        <span class="material-symbols-outlined text-[20px]">block</span>
                        <span>Deactivate</span>
                    </button>
                ` : `
                    <button onclick="activateCarrier('${carrierId}')" class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-darker text-emerald-400 text-left">
                        <span class="material-symbols-outlined text-[20px]">check_circle</span>
                        <span>Activate</span>
                    </button>
                `}
            </div>
        `;

        sheet.classList.remove('hidden');
    }

    function closeMobileActionSheet() {
        document.getElementById('mobileActionSheet').classList.add('hidden');
    }

    function toggleActionMenu(menuId) {
        const menu = document.getElementById(menuId);
        const wasOpen = menu.classList.contains('open');

        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('open'));

        if (!wasOpen) {
            menu.classList.add('open');
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
        document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('open'));
        document.getElementById('mobileOverlay').classList.remove('open');
        closeMobileActionSheet();
    }

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const id = 'toast-' + Date.now();

        const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-rose-600' : 'bg-primary';
        const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';

        const toast = document.createElement('div');
        toast.id = id;
        toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-lg ${bgColor} shadow-lg`;
        toast.innerHTML = `
            <span class="material-symbols-outlined text-[20px]">${icon}</span>
            <span class="text-sm font-medium flex-1">${message}</span>
            <button onclick="document.getElementById('${id}').remove()" class="text-white/80 hover:text-white">
                <span class="material-symbols-outlined text-[18px]">close</span>
            </button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    // ============================================
    // THEME MANAGEMENT
    // ============================================
    const THEME_KEY = 'lmdr-admin-theme';

    function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'dark');
        applyTheme(theme);
    }

    function applyTheme(theme) {
        if (theme === 'light') {
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.add('light');
        } else {
            document.documentElement.classList.remove('light');
            document.documentElement.classList.add('dark');
        }
        updateThemeIcons(theme);
    }

    function toggleTheme() {
        const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, newTheme);
        applyTheme(newTheme);
    }

    function updateThemeIcons(theme) {
        const icon = theme === 'dark' ? 'dark_mode' : 'light_mode';
        const mobileBtn = document.getElementById('themeToggleMobile');
        const desktopBtn = document.getElementById('themeToggleDesktop');
        if (mobileBtn) mobileBtn.querySelector('.material-symbols-outlined').textContent = icon;
        if (desktopBtn) desktopBtn.querySelector('.material-symbols-outlined').textContent = icon;
    }

    // Initialize theme on load
    initTheme();
</script>
</body>
</html>
