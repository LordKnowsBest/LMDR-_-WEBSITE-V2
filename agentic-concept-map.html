<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LMDR Agentic Architecture — Router-Tool Concept Map</title>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #242836;
    --border: #2e3348; --text: #e2e8f0; --dim: #8892b0;
    --blue: #60a5fa; --green: #34d399; --yellow: #fbbf24;
    --red: #f87171; --purple: #a78bfa; --cyan: #22d3ee;
    --orange: #fb923c; --pink: #f472b6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; height: 100vh; }
  .app { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 56px 1fr 180px; height: 100vh; }
  .header { grid-column: 1 / -1; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 16px; z-index: 10; }
  .header h1 { font-size: 15px; font-weight: 700; letter-spacing: -0.5px; white-space: nowrap; }
  .header h1 span { color: var(--blue); }
  .header .arch-tag { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: var(--purple); color: #fff; font-weight: 600; letter-spacing: .5px; }
  .sidebar { background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 12px; }
  .canvas-wrap { position: relative; overflow: hidden; background: var(--bg); }
  .prompt-bar { grid-column: 1 / -1; background: var(--surface); border-top: 1px solid var(--border); padding: 12px 20px; display: flex; flex-direction: column; gap: 6px; }
  .sb-section { margin-bottom: 14px; }
  .sb-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--dim); margin-bottom: 6px; }
  .preset-btn { display: block; width: 100%; padding: 7px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px; cursor: pointer; text-align: left; margin-bottom: 3px; transition: all .15s; }
  .preset-btn:hover { border-color: var(--blue); background: #1e2640; }
  .preset-btn.active { border-color: var(--blue); background: #1e2640; box-shadow: 0 0 0 1px var(--blue); }
  .preset-btn .badge { float: right; font-size: 10px; padding: 1px 6px; border-radius: 8px; background: var(--border); color: var(--dim); }
  .toggle-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; font-size: 11px; }
  .toggle-row input { accent-color: var(--blue); width: 13px; height: 13px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .legend-item { display: flex; align-items: center; gap: 8px; padding: 2px 0; font-size: 10px; color: var(--dim); }
  .legend-line { width: 18px; height: 2px; border-radius: 1px; }
  .legend-dash { width: 18px; height: 0; border-top: 2px dashed; }
  .legend-rect { width: 14px; height: 10px; border-radius: 3px; border: 1.5px solid; }
  canvas { display: block; }

  /* Action panel (right sidebar on click) */
  .action-panel { position: absolute; top: 0; right: 0; width: 320px; height: 100%; background: var(--surface); border-left: 1px solid var(--border); overflow-y: auto; padding: 16px; z-index: 50; transform: translateX(100%); transition: transform .2s ease; }
  .action-panel.open { transform: translateX(0); }
  .ap-close { position: absolute; top: 12px; right: 12px; background: var(--surface2); border: 1px solid var(--border); color: var(--dim); width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
  .ap-close:hover { color: var(--text); border-color: var(--text); }
  .ap-title { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
  .ap-subtitle { font-size: 10px; text-transform: uppercase; letter-spacing: .8px; color: var(--dim); margin-bottom: 8px; }
  .ap-desc { font-size: 11px; color: var(--dim); line-height: 1.5; margin-bottom: 12px; }
  .ap-stats { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .ap-stat { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--surface2); border: 1px solid var(--border); }
  .ap-stat b { color: var(--text); }
  .action-list { list-style: none; }
  .action-list li { display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 11px; font-family: 'JetBrains Mono', monospace, monospace; border-bottom: 1px solid var(--border); }
  .action-list li:last-child { border: none; }
  .action-list .risk-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .action-list .approval-tag { font-size: 8px; padding: 1px 4px; border-radius: 3px; background: var(--red); color: #fff; font-weight: 600; margin-left: auto; flex-shrink: 0; }

  /* Tooltip */
  .tooltip { position: absolute; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; max-width: 340px; font-size: 12px; pointer-events: none; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,.5); display: none; }
  .tooltip .tt-title { font-weight: 700; font-size: 13px; margin-bottom: 3px; }
  .tooltip .tt-type { font-size: 10px; text-transform: uppercase; letter-spacing: .5px; color: var(--dim); margin-bottom: 6px; }
  .tooltip .tt-desc { color: var(--dim); line-height: 1.5; }
  .tooltip .tt-actions { margin-top: 8px; font-size: 10px; color: var(--cyan); font-family: monospace; }
  .tooltip .tt-file { font-family: monospace; font-size: 10px; color: var(--cyan); margin-top: 6px; }

  .prompt-bar label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--dim); }
  .prompt-output { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; font-size: 11px; line-height: 1.6; color: var(--text); overflow-y: auto; font-family: 'JetBrains Mono', monospace, monospace; }
  .copy-btn { align-self: flex-end; padding: 5px 14px; background: var(--blue); border: none; border-radius: 6px; color: #fff; font-size: 11px; font-weight: 600; cursor: pointer; }
  .copy-btn:hover { filter: brightness(1.15); }
  .hdr-search { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; color: var(--text); font-size: 12px; width: 200px; outline: none; }
  .hdr-search:focus { border-color: var(--blue); }
  .hdr-stat { font-size: 11px; color: var(--dim); margin-left: auto; }
  .hdr-stat b { color: var(--text); }
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1><span>VM</span> Agentic Architecture</h1>
    <span class="arch-tag">ROUTER-TOOL PATTERN</span>
    <input class="hdr-search" id="search" type="text" placeholder="Search routers, actions..."/>
    <div class="hdr-stat" id="stats"></div>
  </div>

  <div class="sidebar">
    <div class="sb-section">
      <div class="sb-title">Presets</div>
      <button class="preset-btn active" data-preset="full">Full Architecture <span class="badge">29 routers</span></button>
      <button class="preset-btn" data-preset="driver">Driver Surface <span class="badge">7 + 83 actions</span></button>
      <button class="preset-btn" data-preset="recruiter">Recruiter Surface <span class="badge">6 + 65 actions</span></button>
      <button class="preset-btn" data-preset="admin">Admin Surface <span class="badge">9 + 147 actions</span></button>
      <button class="preset-btn" data-preset="carrier">Carrier / B2B <span class="badge">7 + 93 actions</span></button>
      <button class="preset-btn" data-preset="workflow">Data Flow</button>
      <button class="preset-btn" data-preset="voice">Voice Pipeline</button>
      <button class="preset-btn" data-preset="selfheal">Self-Healing Loop</button>
      <button class="preset-btn" data-preset="legacy">Legacy 36 (Flat)</button>
    </div>
    <div class="sb-section">
      <div class="sb-title">Surfaces</div>
      <label class="toggle-row"><input type="checkbox" checked data-surface="driver"/><span class="dot" style="background:var(--green)"></span> Driver (7 routers)</label>
      <label class="toggle-row"><input type="checkbox" checked data-surface="recruiter"/><span class="dot" style="background:var(--purple)"></span> Recruiter (6 routers)</label>
      <label class="toggle-row"><input type="checkbox" checked data-surface="admin"/><span class="dot" style="background:var(--blue)"></span> Admin (9 routers)</label>
      <label class="toggle-row"><input type="checkbox" checked data-surface="carrier"/><span class="dot" style="background:var(--orange)"></span> Carrier / B2B (7 routers)</label>
      <label class="toggle-row"><input type="checkbox" checked data-surface="shared"/><span class="dot" style="background:var(--cyan)"></span> Shared Core</label>
      <label class="toggle-row"><input type="checkbox" checked data-surface="legacy"/><span class="dot" style="background:var(--dim)"></span> Legacy Flat Tools</label>
    </div>
    <div class="sb-section">
      <div class="sb-title">Show</div>
      <label class="toggle-row"><input type="checkbox" checked id="showEdges"/> Connections</label>
      <label class="toggle-row"><input type="checkbox" checked id="showLabels"/> Edge Labels</label>
      <label class="toggle-row"><input type="checkbox" id="showActions"/> Action Counts</label>
    </div>
    <div class="sb-section">
      <div class="sb-title">Legend</div>
      <div class="legend-item"><span class="legend-rect" style="border-color:var(--green);background:var(--green)20"></span> Driver router</div>
      <div class="legend-item"><span class="legend-rect" style="border-color:var(--purple);background:var(--purple)20"></span> Recruiter router</div>
      <div class="legend-item"><span class="legend-rect" style="border-color:var(--blue);background:var(--blue)20"></span> Admin router</div>
      <div class="legend-item"><span class="legend-rect" style="border-color:var(--orange);background:var(--orange)20"></span> Carrier/B2B router</div>
      <div class="legend-item"><span class="dot" style="background:var(--cyan)"></span> Shared service</div>
      <div class="legend-item"><span class="dot" style="background:var(--dim)"></span> Legacy flat tool</div>
      <div class="legend-item"><div class="legend-line" style="background:var(--dim)"></div> Data flow</div>
      <div class="legend-item"><div class="legend-dash" style="border-color:var(--yellow)"></div> Router dispatch</div>
      <div class="legend-item"><div class="legend-dash" style="border-color:var(--red)"></div> Approval gate</div>
    </div>
  </div>

  <div class="canvas-wrap" id="canvasWrap">
    <canvas id="canvas"></canvas>
    <div class="tooltip" id="tooltip"></div>
    <div class="action-panel" id="actionPanel">
      <button class="ap-close" id="apClose">&times;</button>
      <div id="apContent"></div>
    </div>
  </div>

  <div class="prompt-bar">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <label>Architecture Prompt</label>
      <button class="copy-btn" id="copyBtn">Copy</button>
    </div>
    <div class="prompt-output" id="promptOutput"></div>
  </div>
</div>

<script>
const C = { driver:'#34d399', recruiter:'#a78bfa', admin:'#60a5fa', carrier:'#fb923c', shared:'#22d3ee', legacy:'#64748b', approval:'#f87171', flow:'#475569' };
const RISK_COL = { read:'#34d399', suggest:'#fbbf24', execute_low:'#fb923c', execute_high:'#f87171' };

// ═══════════════════════ ROUTER DATA ═══════════════════════
const ROUTERS = [
  // Driver 7 routers
  { id:'dr_cockpit', label:'driver_cockpit', surface:'driver', actions:23, approvalActions:3, desc:'Jobs, applications, messaging, profile, matches, dashboard, notifications, documents',
    actionList:[
      {n:'search_jobs',r:'read'},{n:'get_job_details',r:'read'},{n:'quick_apply',r:'execute_high',ap:1},{n:'save_job',r:'execute_low'},{n:'get_saved_jobs',r:'read'},
      {n:'withdraw_application',r:'execute_high',ap:1},{n:'check_application_status',r:'read'},{n:'get_application_history',r:'read'},
      {n:'send_message',r:'execute_low'},{n:'get_messages',r:'read'},{n:'get_conversation',r:'read'},{n:'mark_read',r:'execute_low'},{n:'get_unread_count',r:'read'},
      {n:'update_profile',r:'execute_low'},{n:'get_profile_strength',r:'read'},{n:'get_profile_suggestions',r:'suggest'},{n:'upload_document',r:'execute_high',ap:1},
      {n:'get_matches',r:'read'},{n:'get_match_details',r:'read'},{n:'express_interest',r:'execute_low'},{n:'dismiss_match',r:'execute_low'},
      {n:'get_dashboard_summary',r:'read'},{n:'get_notifications',r:'read'}
    ], x:100, y:160 },
  { id:'dr_road', label:'driver_road', surface:'driver', actions:15, approvalActions:0, desc:'Parking, fuel prices, weigh stations, rest stops, weather, road conditions, hazard reports',
    actionList:[
      {n:'find_parking',r:'read'},{n:'get_parking_details',r:'read'},{n:'report_parking_availability',r:'execute_low'},{n:'save_favorite_parking',r:'execute_low'},
      {n:'find_fuel_prices',r:'read'},{n:'get_fuel_price_trends',r:'read'},{n:'calculate_fuel_cost',r:'suggest'},
      {n:'get_weigh_station_status',r:'read'},{n:'get_weigh_stations_on_route',r:'read'},{n:'find_rest_stops',r:'read'},{n:'rate_rest_stop',r:'execute_low'},
      {n:'get_weather_forecast',r:'read'},{n:'get_weather_alerts',r:'read'},{n:'get_road_conditions',r:'read'},{n:'report_road_hazard',r:'execute_low'}
    ], x:100, y:240 },
  { id:'dr_community', label:'driver_community', surface:'driver', actions:14, approvalActions:0, desc:'Forums, mentorship, pet-friendly locations, health resources',
    actionList:[
      {n:'get_forum_posts',r:'read'},{n:'create_forum_post',r:'execute_low'},{n:'reply_to_post',r:'execute_low'},{n:'like_post',r:'execute_low'},{n:'report_post',r:'execute_low'},{n:'search_forums',r:'read'},
      {n:'find_mentors',r:'read'},{n:'request_mentorship',r:'execute_low'},{n:'get_mentorship_status',r:'read'},{n:'rate_mentor',r:'execute_low'},
      {n:'search_pet_friendly_locations',r:'read'},{n:'submit_pet_friendly_location',r:'execute_low'},{n:'get_health_resources',r:'read'},{n:'submit_health_tip',r:'execute_low'}
    ], x:100, y:320 },
  { id:'dr_compliance', label:'driver_compliance', surface:'driver', actions:12, approvalActions:1, desc:'Document wallet, HOS, ELD, training, certifications',
    actionList:[
      {n:'upload_compliance_doc',r:'execute_high',ap:1},{n:'get_compliance_docs',r:'read'},{n:'check_doc_expiry',r:'read'},{n:'get_expiring_docs',r:'read'},
      {n:'get_hos_summary',r:'read'},{n:'log_hos_entry',r:'execute_low'},{n:'get_hos_violations',r:'read'},{n:'sync_eld_data',r:'execute_low'},
      {n:'get_training_courses',r:'read'},{n:'start_training',r:'execute_low'},{n:'get_training_progress',r:'read'},{n:'get_certifications',r:'read'}
    ], x:100, y:400 },
  { id:'dr_financial', label:'driver_financial', surface:'driver', actions:10, approvalActions:1, desc:'Expenses, settlements, trip costs, tax, deductions, per diem',
    actionList:[
      {n:'log_expense',r:'execute_low'},{n:'get_expenses',r:'read'},{n:'get_expense_summary',r:'read'},{n:'export_expenses',r:'read'},
      {n:'get_settlement_history',r:'read'},{n:'dispute_settlement',r:'execute_high',ap:1},{n:'calculate_trip_cost',r:'suggest'},
      {n:'get_tax_summary',r:'read'},{n:'get_deduction_suggestions',r:'suggest'},{n:'get_per_diem_rates',r:'read'}
    ], x:100, y:480 },
  { id:'dr_lifecycle', label:'driver_lifecycle', surface:'driver', actions:5, approvalActions:0, desc:'Timeline, disposition, surveys, feedback',
    actionList:[
      {n:'get_driver_timeline',r:'read'},{n:'update_disposition',r:'execute_low'},{n:'get_pending_surveys',r:'read'},{n:'submit_survey_response',r:'execute_low'},{n:'submit_match_feedback',r:'execute_low'}
    ], x:250, y:440 },
  { id:'dr_utility', label:'driver_utility', surface:'driver', actions:4, approvalActions:0, desc:'Profile strength, quick responses, reverse alerts, market insights',
    actionList:[
      {n:'get_profile_strength_score',r:'read'},{n:'send_quick_response',r:'execute_low'},{n:'set_reverse_alert',r:'execute_low'},{n:'get_market_insights',r:'read'}
    ], x:250, y:520 },

  // Recruiter 6 routers
  { id:'rc_outreach', label:'recruiter_outreach', surface:'recruiter', actions:14, approvalActions:4, desc:'Campaigns (SMS, email, voice), job boards, social, templates',
    actionList:[
      {n:'create_campaign',r:'execute_low'},{n:'send_sms',r:'execute_high',ap:1},{n:'send_email',r:'execute_high',ap:1},{n:'schedule_campaign',r:'execute_low'},{n:'get_campaign_status',r:'read'},
      {n:'pause_campaign',r:'execute_low'},{n:'get_campaign_analytics',r:'read'},{n:'create_email_template',r:'execute_low'},{n:'get_templates',r:'read'},
      {n:'syndicate_to_job_boards',r:'execute_high',ap:1},{n:'get_syndication_status',r:'read'},{n:'update_job_posting',r:'execute_low'},{n:'create_social_post',r:'execute_high',ap:1},{n:'get_social_analytics',r:'read'}
    ], x:380, y:60 },
  { id:'rc_analytics', label:'recruiter_analytics', surface:'recruiter', actions:13, approvalActions:0, desc:'Attribution, CPH, funnels, competitors, forecasts',
    actionList:[
      {n:'get_source_attribution',r:'read'},{n:'get_channel_performance',r:'read'},{n:'compare_sources',r:'suggest'},{n:'calculate_cost_per_hire',r:'read'},
      {n:'get_cph_trend',r:'read'},{n:'get_cph_breakdown',r:'read'},{n:'get_funnel_metrics',r:'read'},{n:'get_stage_conversion',r:'read'},
      {n:'get_bottleneck_analysis',r:'suggest'},{n:'get_competitor_analysis',r:'read'},{n:'track_competitor',r:'execute_low'},{n:'get_hiring_forecast',r:'suggest'},{n:'get_attrition_forecast',r:'suggest'}
    ], x:540, y:60 },
  { id:'rc_onboarding', label:'recruiter_onboarding', surface:'recruiter', actions:12, approvalActions:5, desc:'Workflows, documents, BGC, drug test, e-sign, orientation',
    actionList:[
      {n:'create_onboarding_workflow',r:'execute_low'},{n:'get_workflow_status',r:'read'},{n:'advance_workflow_step',r:'execute_low'},{n:'get_pending_tasks',r:'read'},
      {n:'request_document',r:'execute_high',ap:1},{n:'get_document_status',r:'read'},{n:'verify_document',r:'execute_low'},
      {n:'initiate_background_check',r:'execute_high',ap:1},{n:'get_bgc_status',r:'read'},{n:'initiate_drug_test',r:'execute_high',ap:1},
      {n:'send_for_signature',r:'execute_high',ap:1},{n:'schedule_orientation',r:'execute_high',ap:1}
    ], x:700, y:60 },
  { id:'rc_pipeline', label:'recruiter_pipeline', surface:'recruiter', actions:10, approvalActions:1, desc:'Saved searches, automation rules, interventions, call outcomes',
    actionList:[
      {n:'save_search',r:'execute_low'},{n:'get_saved_searches',r:'read'},{n:'run_saved_search',r:'read'},{n:'create_pipeline_rule',r:'execute_low'},
      {n:'get_pipeline_rules',r:'read'},{n:'enable_rule',r:'execute_low'},{n:'create_intervention',r:'execute_high',ap:1},{n:'get_intervention_templates',r:'read'},
      {n:'log_call_outcome',r:'execute_low'},{n:'get_call_analytics',r:'read'}
    ], x:460, y:140 },
  { id:'rc_retention', label:'recruiter_retention', surface:'recruiter', actions:8, approvalActions:1, desc:'Risk scores, watchlist, interventions, metrics',
    actionList:[
      {n:'get_driver_risk_score',r:'read'},{n:'get_at_risk_drivers',r:'read'},{n:'get_risk_factors',r:'read'},{n:'add_to_watchlist',r:'execute_low'},
      {n:'get_watchlist',r:'read'},{n:'create_retention_intervention',r:'execute_high',ap:1},{n:'get_intervention_status',r:'read'},{n:'get_retention_metrics',r:'read'}
    ], x:620, y:140 },
  { id:'rc_reverse', label:'recruiter_reverse_match', surface:'recruiter', actions:8, approvalActions:2, desc:'Driver search, scoring, subscriptions, payments',
    actionList:[
      {n:'search_drivers',r:'read'},{n:'get_driver_profile_for_recruiter',r:'read'},{n:'get_match_score',r:'read'},{n:'get_score_breakdown',r:'read'},
      {n:'compare_candidates',r:'suggest'},{n:'create_subscription',r:'execute_high',ap:1},{n:'get_subscription_status',r:'read'},{n:'process_payment',r:'execute_high',ap:1}
    ], x:780, y:140 },

  // Carrier/B2B 7 routers
  { id:'cr_fleet', label:'carrier_fleet', surface:'carrier', actions:22, approvalActions:0, desc:'Roster, equipment, maintenance, scorecards, capacity, ELD, HOS',
    actionList:[
      {n:'get_fleet_roster',r:'read'},{n:'get_driver_detail',r:'read'},{n:'update_driver_status',r:'execute_low'},{n:'get_driver_performance',r:'read'},{n:'get_roster_summary',r:'read'},{n:'export_roster',r:'read'},
      {n:'get_equipment_list',r:'read'},{n:'add_equipment',r:'execute_low'},{n:'update_equipment',r:'execute_low'},{n:'get_maintenance_schedule',r:'read'},{n:'log_maintenance',r:'execute_low'},{n:'get_equipment_utilization',r:'read'},
      {n:'get_safety_scorecard',r:'read'},{n:'get_performance_scorecard',r:'read'},{n:'get_compliance_scorecard',r:'read'},{n:'compare_to_industry',r:'read'},{n:'get_scorecard_trends',r:'read'},
      {n:'get_capacity_overview',r:'read'},{n:'update_capacity',r:'execute_low'},{n:'get_capacity_forecast',r:'read'},{n:'set_hiring_targets',r:'execute_low'},{n:'get_hiring_progress',r:'read'}
    ], x:350, y:560 },
  { id:'cr_eld', label:'carrier_eld_compliance', surface:'carrier', actions:16, approvalActions:0, desc:'ELD, HOS, compliance calendar, document vault, DQ files',
    actionList:[
      {n:'get_eld_summary',r:'read'},{n:'get_eld_violations',r:'read'},{n:'get_hos_compliance_rate',r:'read'},{n:'get_drive_time_utilization',r:'read'},
      {n:'get_compliance_calendar',r:'read'},{n:'add_compliance_event',r:'execute_low'},{n:'get_upcoming_deadlines',r:'read'},{n:'set_reminder',r:'execute_low'},{n:'get_overdue_items',r:'read'},
      {n:'upload_carrier_document',r:'execute_low'},{n:'get_carrier_documents',r:'read'},{n:'get_document_by_type',r:'read'},{n:'check_document_validity',r:'read'},{n:'archive_document',r:'execute_low'},
      {n:'get_dq_file_status',r:'read'},{n:'get_missing_dq_items',r:'read'}
    ], x:500, y:560 },
  { id:'cr_safety', label:'carrier_safety', surface:'carrier', actions:12, approvalActions:0, desc:'DQ reminders, CSA scores and trends, incidents',
    actionList:[
      {n:'send_dq_reminder',r:'execute_low'},{n:'update_dq_item',r:'execute_low'},{n:'get_dq_compliance_rate',r:'read'},
      {n:'get_csa_scores',r:'read'},{n:'get_csa_trend',r:'read'},{n:'get_csa_alerts',r:'read'},{n:'get_basic_violations',r:'read'},{n:'compare_csa_to_peers',r:'read'},
      {n:'report_incident',r:'execute_low'},{n:'get_incidents',r:'read'},{n:'get_incident_detail',r:'read'},{n:'update_incident_status',r:'execute_low'}
    ], x:650, y:560 },
  { id:'cr_comms', label:'carrier_comms', surface:'carrier', actions:20, approvalActions:2, desc:'Announcements, policies, recognition, feedback surveys',
    actionList:[
      {n:'create_announcement',r:'execute_high',ap:1},{n:'get_announcements',r:'read'},{n:'update_announcement',r:'execute_low'},{n:'delete_announcement',r:'execute_low'},{n:'get_announcement_reach',r:'read'},
      {n:'create_policy',r:'execute_high',ap:1},{n:'get_policies',r:'read'},{n:'update_policy',r:'execute_low'},{n:'acknowledge_policy',r:'execute_low'},{n:'get_policy_acknowledgments',r:'read'},
      {n:'create_recognition',r:'execute_low'},{n:'get_recognitions',r:'read'},{n:'nominate_driver',r:'execute_low'},{n:'get_recognition_leaderboard',r:'read'},{n:'get_recognition_history',r:'read'},
      {n:'create_feedback_survey',r:'execute_low'},{n:'get_survey_responses',r:'read'},{n:'get_feedback_summary',r:'read'},{n:'get_sentiment_analysis',r:'read'},{n:'close_survey',r:'execute_low'}
    ], x:800, y:560 },
  { id:'cr_setup', label:'carrier_setup', surface:'carrier', actions:16, approvalActions:0, desc:'Onboarding, branding, navigation, subscriptions',
    actionList:[
      {n:'get_onboarding_status',r:'read'},{n:'start_onboarding_step',r:'execute_low'},{n:'complete_onboarding_step',r:'execute_low'},{n:'skip_onboarding_step',r:'execute_low'},{n:'get_onboarding_checklist',r:'read'},
      {n:'update_carrier_profile',r:'execute_low'},{n:'upload_carrier_logo',r:'execute_low'},{n:'set_carrier_branding',r:'execute_low'},{n:'get_carrier_public_profile',r:'read'},{n:'update_about_section',r:'execute_low'},
      {n:'get_carrier_menu',r:'read'},{n:'set_default_view',r:'execute_low'},{n:'get_quick_actions',r:'read'},{n:'customize_dashboard',r:'execute_low'},{n:'get_feature_tour',r:'read'},{n:'create_subscription_checkout',r:'execute_low'}
    ], x:425, y:640 },
  { id:'cr_billing', label:'carrier_billing', surface:'carrier', actions:12, approvalActions:0, desc:'Subscription management, deposits, pricing plans',
    actionList:[
      {n:'get_subscription_status',r:'read'},{n:'update_subscription',r:'execute_low'},{n:'cancel_subscription',r:'execute_low'},{n:'get_billing_history',r:'read'},
      {n:'create_deposit_session',r:'execute_low'},{n:'verify_deposit',r:'read'},{n:'get_deposit_status',r:'read'},{n:'refund_deposit',r:'execute_low'},
      {n:'get_pricing_plans',r:'read'},{n:'compare_plans',r:'read'},{n:'get_plan_features',r:'read'},{n:'get_upgrade_options',r:'read'}
    ], x:575, y:640 },
  { id:'cr_b2b', label:'b2b_ops', surface:'carrier', actions:33, approvalActions:2, desc:'Match intelligence, pipeline, outreach, events, research, analytics',
    actionList:[
      {n:'save_search_preset',r:'execute_low'},{n:'get_presets',r:'read'},{n:'apply_preset',r:'read'},{n:'delete_preset',r:'execute_low'},
      {n:'get_application_statuses',r:'read'},{n:'update_application_status',r:'execute_low'},{n:'get_status_history',r:'read'},{n:'bulk_update_status',r:'execute_low'},
      {n:'preview_match_results',r:'read'},{n:'get_match_criteria',r:'read'},{n:'update_match_preferences',r:'execute_low'},{n:'get_match_quality_score',r:'read'},
      {n:'get_b2b_match_signals',r:'read'},{n:'get_carrier_intent_data',r:'read'},{n:'score_lead',r:'read'},{n:'get_lead_recommendations',r:'suggest'},
      {n:'get_b2b_pipeline',r:'read'},{n:'create_opportunity',r:'execute_low'},{n:'update_opportunity_stage',r:'execute_low'},{n:'get_pipeline_analytics',r:'read'},
      {n:'create_b2b_outreach',r:'execute_high',ap:1},{n:'send_b2b_email',r:'execute_high',ap:1},{n:'log_b2b_activity',r:'execute_low'},{n:'get_outreach_analytics',r:'read'},
      {n:'create_b2b_event',r:'execute_low'},{n:'get_b2b_events',r:'read'},{n:'register_for_event',r:'execute_low'},
      {n:'research_carrier',r:'execute_low'},{n:'get_carrier_intelligence',r:'read'},{n:'generate_carrier_brief',r:'read'},
      {n:'get_b2b_dashboard',r:'read'},{n:'get_b2b_kpis',r:'read'},{n:'export_b2b_report',r:'read'}
    ], x:725, y:640 },

  // Admin 9 routers
  { id:'ad_business', label:'admin_business', surface:'admin', actions:17, approvalActions:2, desc:'Revenue, billing, invoices, commissions',
    actionList:[
      {n:'get_revenue_dashboard',r:'read'},{n:'get_revenue_by_source',r:'read'},{n:'get_mrr_trend',r:'read'},{n:'get_arpu',r:'read'},{n:'get_revenue_forecast',r:'read'},{n:'export_revenue_report',r:'read'},
      {n:'get_billing_overview',r:'read'},{n:'create_invoice',r:'execute_high',ap:1},{n:'send_invoice',r:'execute_high'},{n:'get_invoice_status',r:'read'},{n:'mark_invoice_paid',r:'execute_low'},{n:'get_overdue_invoices',r:'read'},
      {n:'calculate_commissions',r:'read'},{n:'get_commission_report',r:'read'},{n:'approve_commission',r:'execute_high',ap:1},{n:'get_commission_rules',r:'read'},{n:'update_commission_rule',r:'execute_low'}
    ], x:1020, y:120 },
  { id:'ad_config', label:'admin_config', surface:'admin', actions:20, approvalActions:4, desc:'Feature flags, A/B tests, email templates, notification rules',
    actionList:[
      {n:'get_feature_flags',r:'read'},{n:'toggle_feature_flag',r:'execute_high',ap:1},{n:'create_feature_flag',r:'execute_high',ap:1},{n:'update_feature_flag_rules',r:'execute_low'},{n:'get_flag_audit_log',r:'read'},{n:'get_flag_impact',r:'read'},
      {n:'create_ab_test',r:'execute_high',ap:1},{n:'get_ab_tests',r:'read'},{n:'get_ab_test_results',r:'read'},{n:'conclude_ab_test',r:'execute_low'},{n:'get_winning_variant',r:'read'},
      {n:'get_email_templates',r:'read'},{n:'create_email_template',r:'execute_low'},{n:'update_email_template',r:'execute_high',ap:1},{n:'preview_email_template',r:'read'},{n:'send_test_email',r:'execute_low'},{n:'get_template_performance',r:'read'},
      {n:'get_notification_rules',r:'read'},{n:'create_notification_rule',r:'execute_low'},{n:'update_notification_rule',r:'execute_low'}
    ], x:1020, y:200 },
  { id:'ad_portal', label:'admin_portal', surface:'admin', actions:20, approvalActions:3, desc:'Dashboard, users, moderation, AI dashboard, compliance',
    actionList:[
      {n:'get_admin_dashboard',r:'read'},{n:'get_system_health',r:'read'},{n:'get_key_metrics',r:'read'},{n:'get_alert_summary',r:'read'},{n:'get_recent_activity',r:'read'},
      {n:'get_users',r:'read'},{n:'get_user_detail',r:'read'},{n:'update_user_role',r:'execute_high'},{n:'suspend_user',r:'execute_high',ap:1},{n:'reactivate_user',r:'execute_high',ap:1},{n:'get_user_activity_log',r:'read'},{n:'impersonate_user',r:'execute_high',ap:1},
      {n:'get_moderation_queue',r:'read'},{n:'approve_content',r:'execute_low'},{n:'reject_content',r:'execute_low'},{n:'flag_content',r:'execute_low'},{n:'get_moderation_history',r:'read'},
      {n:'get_ai_usage_summary',r:'read'},{n:'get_ai_costs',r:'read'},{n:'get_compliance_dashboard',r:'read'}
    ], x:1020, y:280 },
  { id:'ad_support', label:'admin_support', surface:'admin', actions:22, approvalActions:0, desc:'Tickets, knowledge base, chat, NPS',
    actionList:[
      {n:'create_ticket',r:'execute_low'},{n:'get_tickets',r:'read'},{n:'get_ticket_detail',r:'read'},{n:'update_ticket_status',r:'execute_low'},{n:'assign_ticket',r:'execute_low'},{n:'escalate_ticket',r:'execute_low'},{n:'get_ticket_analytics',r:'read'},
      {n:'search_knowledge_base',r:'read'},{n:'create_kb_article',r:'execute_low'},{n:'update_kb_article',r:'execute_low'},{n:'get_kb_categories',r:'read'},{n:'get_kb_analytics',r:'read'},{n:'suggest_kb_article',r:'read'},
      {n:'get_chat_sessions',r:'read'},{n:'get_chat_history',r:'read'},{n:'get_chat_analytics',r:'read'},{n:'get_response_times',r:'read'},{n:'get_satisfaction_scores',r:'read'},
      {n:'send_nps_survey',r:'execute_low'},{n:'get_nps_scores',r:'read'},{n:'get_nps_trend',r:'read'},{n:'get_nps_by_segment',r:'read'}
    ], x:1020, y:360 },
  { id:'ad_gamification', label:'admin_gamification', surface:'admin', actions:20, approvalActions:0, desc:'XP, streaks, achievements, challenges, leaderboards',
    actionList:[
      {n:'get_user_xp',r:'read'},{n:'award_xp',r:'execute_low'},{n:'get_level_progress',r:'read'},{n:'get_level_requirements',r:'read'},{n:'get_xp_history',r:'read'},{n:'get_level_leaderboard',r:'read'},
      {n:'get_user_streaks',r:'read'},{n:'get_active_streaks',r:'read'},{n:'reset_streak',r:'execute_low'},{n:'get_streak_leaderboard',r:'read'},
      {n:'get_achievements',r:'read'},{n:'get_user_achievements',r:'read'},{n:'award_achievement',r:'execute_low'},{n:'get_achievement_progress',r:'read'},{n:'create_achievement_definition',r:'execute_low'},
      {n:'create_challenge',r:'execute_low'},{n:'get_active_challenges',r:'read'},{n:'get_challenge_progress',r:'read'},{n:'get_challenge_leaderboard',r:'read'},{n:'get_leaderboard',r:'read'}
    ], x:1020, y:440 },
  { id:'ad_adoption', label:'admin_adoption', surface:'admin', actions:8, approvalActions:0, desc:'Feature interaction logging, usage, funnels, health scores',
    actionList:[
      {n:'log_feature_interaction',r:'execute_low'},{n:'get_feature_usage',r:'read'},{n:'get_feature_adoption_rate',r:'read'},{n:'get_feature_funnel',r:'read'},
      {n:'get_feature_health_score',r:'read'},{n:'get_underused_features',r:'read'},{n:'get_feature_engagement_trend',r:'read'},{n:'get_feature_recommendations',r:'read'}
    ], x:1160, y:200 },
  { id:'ad_crossrole', label:'admin_cross_role', surface:'admin', actions:12, approvalActions:0, desc:'Mutual interests, carrier retention, match explanations',
    actionList:[
      {n:'get_mutual_interests',r:'read'},{n:'send_interest_signal',r:'execute_low'},{n:'get_interest_matches',r:'read'},{n:'withdraw_interest',r:'execute_low'},
      {n:'get_carrier_retention_score',r:'read'},{n:'get_retention_risk_factors',r:'read'},{n:'get_retention_recommendations',r:'read'},
      {n:'get_match_explanation',r:'read'},{n:'get_match_factors',r:'read'},{n:'get_match_confidence',r:'read'},{n:'compare_matches',r:'read'},{n:'get_system_health_status',r:'read'}
    ], x:1160, y:300 },
  { id:'ad_observability', label:'admin_observability', surface:'admin', actions:16, approvalActions:0, desc:'Health, tracing, metrics, errors',
    actionList:[
      {n:'get_service_availability',r:'read'},{n:'get_degraded_services',r:'read'},{n:'get_health_history',r:'read'},
      {n:'get_traces',r:'read'},{n:'search_traces',r:'read'},{n:'get_trace_detail',r:'read'},{n:'get_trace_timeline',r:'read'},{n:'get_slow_traces',r:'read'},
      {n:'get_system_metrics',r:'read'},{n:'get_metric_trend',r:'read'},{n:'get_metric_alerts',r:'read'},{n:'create_metric_alert',r:'execute_low'},
      {n:'get_dashboard_metrics',r:'read'},{n:'get_error_log',r:'read'},{n:'get_error_trends',r:'read'},{n:'get_top_errors',r:'read'}
    ], x:1160, y:400 },
  { id:'ad_api', label:'admin_api_platform', surface:'admin', actions:18, approvalActions:1, desc:'API keys, usage, rate limits, external safety/intel/ops/match data',
    actionList:[
      {n:'get_api_keys',r:'read'},{n:'create_api_key',r:'execute_high',ap:1},{n:'revoke_api_key',r:'execute_low'},{n:'get_api_usage',r:'read'},{n:'get_rate_limit_status',r:'read'},
      {n:'get_safety_data',r:'read'},{n:'get_inspection_history',r:'read'},{n:'get_crash_data',r:'read'},{n:'get_violations',r:'read'},
      {n:'get_carrier_intel',r:'read'},{n:'get_market_data',r:'read'},{n:'get_industry_benchmarks',r:'read'},
      {n:'get_operational_metrics',r:'read'},{n:'get_fleet_utilization',r:'read'},{n:'get_route_analytics',r:'read'},
      {n:'get_external_matches',r:'read'},{n:'submit_match_request',r:'execute_low'},{n:'verify_document_external',r:'read'}
    ], x:1160, y:500 },
];

// ─── Surface Hubs + Core Services ───
const SERVICES = [
  { id:'hub_driver', label:'Driver Surface', type:'hub', surface:'driver', desc:'LMDR-branded chat + voice. 7 routers, 83 actions. Max 10k tokens/run.', x:260, y:320 },
  { id:'hub_recruiter', label:'Recruiter Surface', type:'hub', surface:'recruiter', desc:'VelocityMatch recruiter console. 6 routers, 65 actions + voice campaigns. Max 15k tokens/run.', x:580, y:220 },
  { id:'hub_admin', label:'Admin Surface', type:'hub', surface:'admin', desc:'VelocityMatch admin with self-healing. 9 routers, 147 actions. Max 20k tokens/run.', x:920, y:320 },
  { id:'hub_carrier', label:'Carrier / B2B', type:'hub', surface:'carrier', desc:'B2B portal for carriers. 7 routers, 93 actions. Max 10k tokens/run.', x:580, y:480 },

  { id:'orchestrator', label:'Agent Orchestrator', type:'core', surface:'shared', desc:'handleAgentTurn() — builds router list per role (6-9 routers not 65-147 flat tools). Dual dispatch: ACTION_REGISTRY for routers, TOOL_DEFINITIONS for legacy.', x:580, y:350 },
  { id:'ai_router', label:'AI Router', type:'core', surface:'shared', desc:'Routes to Claude (pinned for agent_orchestration). Cost optimizer. AI sees ~28 router defs not 388 flat schemas.', x:440, y:420 },
  { id:'conversation', label:'Conversation Store', type:'core', surface:'shared', desc:'Persists conversations + turns to Airtable. Max 20 recent turns per context. Stores router name + action in toolCalls.', x:720, y:420 },
  { id:'run_ledger', label:'Run Ledger', type:'core', surface:'shared', desc:'Tracks runs, approval gates, cost/run. Logs router_name + action_name per step.', x:580, y:420 },
  { id:'outcomes', label:'Outcome Evaluator', type:'core', surface:'shared', desc:'Quality scores, cost tracking, approval stats by role. Feeds KPI dashboard + Knowledge Curator.', x:510, y:480 },
  { id:'compendium', label:'Knowledge Curator', type:'core', surface:'shared', desc:'Analyzes outcomes, updates Compendium knowledge base. Admin-triggered.', x:650, y:480 },

  { id:'v_service', label:'VAPI Service', type:'voice', surface:'shared', desc:'VAPI REST API — createAssistant, initiateOutboundCall, getTranscript. 13 voice templates.', x:340, y:720 },
  { id:'v_campaign', label:'Voice Campaigns', type:'voice', surface:'shared', desc:'Bulk outbound calling. Chunked 10/batch, 200ms rate limit.', x:500, y:720 },
  { id:'v_webhook', label:'VAPI Webhooks', type:'voice', surface:'shared', desc:'end-of-call-report, function-call, assistant-request handlers.', x:660, y:720 },
  { id:'v_ui', label:'Voice Orb UI', type:'voice', surface:'shared', desc:'Floating orb + transcript panel. VAPI Web SDK. All surfaces.', x:340, y:780 },

  { id:'pipeline', label:'Pipeline Engine', type:'core', surface:'shared', desc:'Rules-based (no AI). 5-min SLA. stage_change → escalation chain.', x:820, y:720 },
  { id:'event_bus', label:'Event Bus', type:'core', surface:'shared', desc:'Central event dispatch. Triggers pipeline rules.', x:920, y:680 },
  { id:'selfheal', label:'Self-Healing', type:'core', surface:'shared', desc:'Detect → Triage → Propose → Execute. 5 anomaly types, 8 remediation strategies.', x:920, y:760 },
];

const EDGES = [
  // Hubs → Orchestrator
  {f:'hub_driver',t:'orchestrator',label:'postMessage',type:'flow'},
  {f:'hub_recruiter',t:'orchestrator',label:'postMessage',type:'flow'},
  {f:'hub_admin',t:'orchestrator',label:'postMessage',type:'flow'},
  {f:'hub_carrier',t:'orchestrator',label:'postMessage',type:'flow'},
  // Orchestrator → Core
  {f:'orchestrator',t:'ai_router',label:'AI call',type:'flow'},
  {f:'orchestrator',t:'conversation',label:'store turns',type:'flow'},
  {f:'orchestrator',t:'run_ledger',label:'track run',type:'flow'},
  {f:'orchestrator',t:'outcomes',label:'evaluate',type:'flow'},
  {f:'outcomes',t:'compendium',label:'feed curator',type:'flow'},
  // Hubs → Routers (dispatch lines)
  {f:'hub_driver',t:'dr_cockpit',label:'',type:'dispatch'},{f:'hub_driver',t:'dr_road',label:'',type:'dispatch'},{f:'hub_driver',t:'dr_community',label:'',type:'dispatch'},
  {f:'hub_driver',t:'dr_compliance',label:'',type:'dispatch'},{f:'hub_driver',t:'dr_financial',label:'',type:'dispatch'},{f:'hub_driver',t:'dr_lifecycle',label:'',type:'dispatch'},{f:'hub_driver',t:'dr_utility',label:'',type:'dispatch'},
  {f:'hub_recruiter',t:'rc_outreach',label:'',type:'dispatch'},{f:'hub_recruiter',t:'rc_analytics',label:'',type:'dispatch'},{f:'hub_recruiter',t:'rc_onboarding',label:'',type:'dispatch'},
  {f:'hub_recruiter',t:'rc_pipeline',label:'',type:'dispatch'},{f:'hub_recruiter',t:'rc_retention',label:'',type:'dispatch'},{f:'hub_recruiter',t:'rc_reverse',label:'',type:'dispatch'},
  {f:'hub_carrier',t:'cr_fleet',label:'',type:'dispatch'},{f:'hub_carrier',t:'cr_eld',label:'',type:'dispatch'},{f:'hub_carrier',t:'cr_safety',label:'',type:'dispatch'},
  {f:'hub_carrier',t:'cr_comms',label:'',type:'dispatch'},{f:'hub_carrier',t:'cr_setup',label:'',type:'dispatch'},{f:'hub_carrier',t:'cr_billing',label:'',type:'dispatch'},{f:'hub_carrier',t:'cr_b2b',label:'',type:'dispatch'},
  {f:'hub_admin',t:'ad_business',label:'',type:'dispatch'},{f:'hub_admin',t:'ad_config',label:'',type:'dispatch'},{f:'hub_admin',t:'ad_portal',label:'',type:'dispatch'},
  {f:'hub_admin',t:'ad_support',label:'',type:'dispatch'},{f:'hub_admin',t:'ad_gamification',label:'',type:'dispatch'},{f:'hub_admin',t:'ad_adoption',label:'',type:'dispatch'},
  {f:'hub_admin',t:'ad_crossrole',label:'',type:'dispatch'},{f:'hub_admin',t:'ad_observability',label:'',type:'dispatch'},{f:'hub_admin',t:'ad_api',label:'',type:'dispatch'},
  // Voice
  {f:'rc_outreach',t:'v_service',label:'voice campaigns',type:'flow'},{f:'v_service',t:'v_campaign',label:'bulk calls',type:'flow'},
  {f:'v_service',t:'v_ui',label:'Web SDK',type:'flow'},{f:'v_webhook',t:'orchestrator',label:'function-call',type:'flow'},
  // Pipeline
  {f:'rc_pipeline',t:'event_bus',label:'emit event',type:'flow'},{f:'event_bus',t:'pipeline',label:'trigger rules',type:'flow'},{f:'pipeline',t:'v_service',label:'escalate',type:'flow'},
  // Self-healing
  {f:'ad_observability',t:'selfheal',label:'detect',type:'flow'},{f:'ad_portal',t:'selfheal',label:'execute fix',type:'approval'},
];

// ═══════════════════════ STATE ═══════════════════════
const state = {
  preset:'full', surfaces:{driver:true,recruiter:true,admin:true,carrier:true,shared:true,legacy:true},
  showEdges:true, showLabels:true, showActions:false, search:'',
  drag:null, pan:{x:0,y:0}, panStart:null, hover:null, scale:.85, highlighted:new Set(), selectedRouter:null
};

// ═══════════════════════ CANVAS ═══════════════════════
const canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d'), wrap=document.getElementById('canvasWrap'), tooltip=document.getElementById('tooltip');
function resize(){const r=wrap.getBoundingClientRect();canvas.width=r.width*devicePixelRatio;canvas.height=r.height*devicePixelRatio;canvas.style.width=r.width+'px';canvas.style.height=r.height+'px';ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);draw();}
window.addEventListener('resize',resize);
function sx(x){return x*state.scale+state.pan.x;}
function sy(y){return y*state.scale+state.pan.y;}

function allNodes(){return [...SERVICES,...ROUTERS];}

function isVisible(n){
  if(n.surface && !state.surfaces[n.surface]) return false;
  if(state.search){
    const q=state.search.toLowerCase();
    const searchable = n.label+' '+n.desc+(n.actionList?n.actionList.map(a=>a.n).join(' '):'');
    if(!searchable.toLowerCase().includes(q)) return false;
  }
  return true;
}

function getNodeRadius(n){
  if(n.type==='hub') return 30;
  if(n.type==='core'||n.type==='voice') return 20;
  return 24; // routers
}

function drawEdge(e){
  const from=allNodes().find(n=>n.id===e.f), to=allNodes().find(n=>n.id===e.t);
  if(!from||!to||!isVisible(from)||!isVisible(to)||!state.showEdges) return;
  const x1=sx(from.x),y1=sy(from.y),x2=sx(to.x),y2=sy(to.y);
  ctx.beginPath();
  if(e.type==='approval'){ctx.setLineDash([5,4]);ctx.strokeStyle=C.approval+'70';ctx.lineWidth=1.5;}
  else if(e.type==='dispatch'){ctx.setLineDash([3,3]);ctx.strokeStyle=(C[to.surface]||C.flow)+'40';ctx.lineWidth=1;}
  else{ctx.setLineDash([]);ctx.strokeStyle=C.flow;ctx.lineWidth=1.5;}
  ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.setLineDash([]);
  // Arrow
  const angle=Math.atan2(y2-y1,x2-x1), r=getNodeRadius(to)*state.scale;
  const ax=x2-Math.cos(angle)*r, ay=y2-Math.sin(angle)*r;
  ctx.beginPath();ctx.moveTo(ax,ay);
  ctx.lineTo(ax-7*Math.cos(angle-.4),ay-7*Math.sin(angle-.4));
  ctx.lineTo(ax-7*Math.cos(angle+.4),ay-7*Math.sin(angle+.4));
  ctx.closePath();ctx.fillStyle=ctx.strokeStyle;ctx.fill();
  if(state.showLabels&&e.label){
    const mx=(x1+x2)/2,my=(y1+y2)/2;
    ctx.font=`${9*state.scale}px Inter,system-ui`;ctx.fillStyle='#8892b0';ctx.textAlign='center';ctx.fillText(e.label,mx,my-4*state.scale);
  }
}

function drawRouter(n){
  if(!isVisible(n)) return;
  const x=sx(n.x),y=sy(n.y), col=C[n.surface]||C.shared;
  const isH=state.hover===n.id, isHL=state.highlighted.has(n.id), dim=state.highlighted.size>0&&!isHL;
  const w=110*state.scale, h=36*state.scale, r=6*state.scale;
  // Glow
  if(isH||isHL){ctx.fillStyle=col+'15';ctx.beginPath();ctx.roundRect(x-w/2-4,y-h/2-4,w+8,h+8,r+2);ctx.fill();}
  // Box
  ctx.beginPath();ctx.roundRect(x-w/2,y-h/2,w,h,r);
  ctx.fillStyle=dim?'#13151d':col+'12';ctx.fill();
  ctx.strokeStyle=dim?'#1e2030':(isH?'#fff':(n.approvalActions>0?C.approval:col));
  ctx.lineWidth=isH?2:1.5;ctx.stroke();
  // Label
  ctx.font=`600 ${10*state.scale}px Inter,system-ui`;ctx.fillStyle=dim?'#334155':col;ctx.textAlign='center';ctx.textBaseline='middle';
  const lbl=n.label.replace('driver_','d:').replace('recruiter_','r:').replace('carrier_','c:').replace('admin_','a:').replace('b2b_','b2b:');
  ctx.fillText(lbl,x,y-4*state.scale);
  // Action count badge
  ctx.font=`${8*state.scale}px Inter,system-ui`;ctx.fillStyle=dim?'#1e293b':'#8892b0';
  let badge=`${n.actions} actions`;
  if(n.approvalActions>0) badge+=` · ${n.approvalActions} approval`;
  ctx.fillText(badge,x,y+8*state.scale);
  // Red dot for approvals
  if(n.approvalActions>0&&!dim){
    ctx.beginPath();ctx.arc(x+w/2-3,y-h/2+3,4*state.scale,0,Math.PI*2);ctx.fillStyle=C.approval;ctx.fill();
  }
}

function drawService(n){
  if(!isVisible(n)) return;
  const x=sx(n.x),y=sy(n.y), col=C[n.surface]||C.shared;
  const isH=state.hover===n.id, isHL=state.highlighted.has(n.id), dim=state.highlighted.size>0&&!isHL;
  const radius=(n.type==='hub'?30:20)*state.scale;
  if(isH||isHL){ctx.beginPath();ctx.arc(x,y,radius+5,0,Math.PI*2);ctx.fillStyle=col+'18';ctx.fill();}
  ctx.beginPath();ctx.arc(x,y,radius,0,Math.PI*2);
  ctx.fillStyle=dim?'#13151d':(n.type==='hub'?col+'25':'#1a1d27');ctx.fill();
  ctx.strokeStyle=dim?'#1e2030':(isH?'#fff':col);ctx.lineWidth=isH?2.5:(n.type==='hub'?2:1.5);ctx.stroke();
  ctx.font=`${n.type==='hub'?'700':'500'} ${(n.type==='hub'?11:9)*state.scale}px Inter,system-ui`;
  ctx.fillStyle=dim?'#334155':(isH?'#fff':'#e2e8f0');ctx.textAlign='center';ctx.textBaseline='middle';
  const lbl=n.label.length>16?n.label.slice(0,15)+'…':n.label;
  ctx.fillText(lbl,x,y);
}

function draw(){
  const r=wrap.getBoundingClientRect();ctx.clearRect(0,0,r.width,r.height);
  // Surface zones
  const zones=[
    {l:'DRIVER',x:50,y:130,w:260,h:430,c:C.driver,s:'driver'},
    {l:'RECRUITER',x:340,y:30,w:500,h:170,c:C.recruiter,s:'recruiter'},
    {l:'ADMIN',x:970,y:90,w:240,h:440,c:C.admin,s:'admin'},
    {l:'CARRIER / B2B',x:310,y:530,w:530,h:150,c:C.carrier,s:'carrier'},
    {l:'CORE SERVICES',x:400,y:310,w:380,h:200,c:C.shared,s:'shared'},
    {l:'VOICE',x:300,y:690,w:400,h:110,c:'#f472b6',s:'shared'},
  ];
  zones.forEach(z=>{
    if(!state.surfaces[z.s]) return;
    const zx=sx(z.x),zy=sy(z.y),zw=z.w*state.scale,zh=z.h*state.scale;
    ctx.fillStyle=z.c+'06';ctx.strokeStyle=z.c+'12';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(zx-8,zy-8,zw+16,zh+16,10);ctx.fill();ctx.stroke();
    ctx.font=`700 ${8*state.scale}px Inter,system-ui`;ctx.fillStyle=z.c+'35';ctx.textAlign='left';ctx.fillText(z.l,zx,zy-2);
  });
  EDGES.forEach(drawEdge);
  SERVICES.forEach(drawService);
  ROUTERS.forEach(drawRouter);
  updateStats();
}

// ═══════════════════════ INTERACTION ═══════════════════════
function hitTest(mx,my){
  // Routers first (rectangles)
  for(let i=ROUTERS.length-1;i>=0;i--){
    const n=ROUTERS[i]; if(!isVisible(n)) continue;
    const x=sx(n.x),y=sy(n.y),w=110*state.scale,h=36*state.scale;
    if(mx>=x-w/2&&mx<=x+w/2&&my>=y-h/2&&my<=y+h/2) return n;
  }
  // Services (circles)
  for(let i=SERVICES.length-1;i>=0;i--){
    const n=SERVICES[i]; if(!isVisible(n)) continue;
    const x=sx(n.x),y=sy(n.y),r=getNodeRadius(n)*state.scale;
    if((mx-x)**2+(my-y)**2<=r*r) return n;
  }
  return null;
}

canvas.addEventListener('mousedown',e=>{
  const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const hit=hitTest(mx,my);
  if(hit){
    state.drag={node:hit,ox:sx(hit.x)-mx,oy:sy(hit.y)-my};
    state.highlighted.clear();state.highlighted.add(hit.id);
    EDGES.forEach(edge=>{if(edge.f===hit.id)state.highlighted.add(edge.t);if(edge.t===hit.id)state.highlighted.add(edge.f);});
    if(hit.actionList) openActionPanel(hit); else closeActionPanel();
    draw();updatePrompt();
  } else { state.panStart={x:e.clientX-state.pan.x,y:e.clientY-state.pan.y}; }
});
canvas.addEventListener('mousemove',e=>{
  const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
  if(state.drag){state.drag.node.x=(mx+state.drag.ox-state.pan.x)/state.scale;state.drag.node.y=(my+state.drag.oy-state.pan.y)/state.scale;draw();return;}
  if(state.panStart){state.pan.x=e.clientX-state.panStart.x;state.pan.y=e.clientY-state.panStart.y;draw();return;}
  const hit=hitTest(mx,my);
  if(hit){state.hover=hit.id;canvas.style.cursor='pointer';showTooltip(hit,e.clientX,e.clientY);}
  else{state.hover=null;canvas.style.cursor='grab';tooltip.style.display='none';}
  draw();
});
canvas.addEventListener('mouseup',()=>{state.drag=null;state.panStart=null;});
canvas.addEventListener('mouseleave',()=>{tooltip.style.display='none';state.hover=null;state.drag=null;state.panStart=null;});
canvas.addEventListener('dblclick',()=>{state.highlighted.clear();closeActionPanel();draw();updatePrompt();});
canvas.addEventListener('wheel',e=>{
  e.preventDefault();const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const prev=state.scale;state.scale*=e.deltaY<0?1.1:0.9;state.scale=Math.max(.25,Math.min(3,state.scale));
  state.pan.x=mx-(mx-state.pan.x)*(state.scale/prev);state.pan.y=my-(my-state.pan.y)*(state.scale/prev);draw();
},{passive:false});

function showTooltip(n,cx,cy){
  let html=`<div class="tt-title">${n.label}</div><div class="tt-type">${n.actionList?'router':'service'} · ${n.surface}</div><div class="tt-desc">${n.desc}</div>`;
  if(n.actions) html+=`<div class="tt-actions">${n.actions} actions${n.approvalActions?' · '+n.approvalActions+' require approval':''} — click to expand</div>`;
  tooltip.innerHTML=html;tooltip.style.display='block';
  const wr=wrap.getBoundingClientRect();let tx=cx-wr.left+16,ty=cy-wr.top-10;
  if(tx+340>wr.width)tx=cx-wr.left-356;if(ty+180>wr.height)ty=wr.height-190;
  tooltip.style.left=tx+'px';tooltip.style.top=Math.max(0,ty)+'px';
}

// ═══════════════════════ ACTION PANEL ═══════════════════════
function openActionPanel(router){
  state.selectedRouter=router;
  const col=C[router.surface];
  const reads=router.actionList.filter(a=>a.r==='read').length;
  const execs=router.actionList.filter(a=>a.r.startsWith('execute')).length;
  const suggests=router.actionList.filter(a=>a.r==='suggest').length;
  let html=`<div class="ap-title" style="color:${col}">${router.label}</div>`;
  html+=`<div class="ap-subtitle">${router.surface} router · ${router.actions} actions</div>`;
  html+=`<div class="ap-desc">${router.desc}</div>`;
  html+=`<div class="ap-stats"><span class="ap-stat" style="color:${RISK_COL.read}"><b>${reads}</b> read</span>`;
  if(execs)html+=`<span class="ap-stat" style="color:${RISK_COL.execute_low}"><b>${execs}</b> execute</span>`;
  if(suggests)html+=`<span class="ap-stat" style="color:${RISK_COL.suggest}"><b>${suggests}</b> suggest</span>`;
  if(router.approvalActions)html+=`<span class="ap-stat" style="color:${RISK_COL.execute_high}"><b>${router.approvalActions}</b> approval</span>`;
  html+=`</div><ul class="action-list">`;
  router.actionList.forEach(a=>{
    html+=`<li><span class="risk-dot" style="background:${RISK_COL[a.r]}"></span>${a.n}`;
    if(a.ap)html+=`<span class="approval-tag">APPROVAL</span>`;
    html+=`</li>`;
  });
  html+=`</ul>`;
  document.getElementById('apContent').innerHTML=html;
  document.getElementById('actionPanel').classList.add('open');
}
function closeActionPanel(){state.selectedRouter=null;document.getElementById('actionPanel').classList.remove('open');}
document.getElementById('apClose').addEventListener('click',closeActionPanel);

// ═══════════════════════ PRESETS ═══════════════════════
const PRESETS={
  full(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=true);state.search='';state.scale=.85;state.pan={x:0,y:0};state.highlighted.clear();closeActionPanel();},
  driver(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=k==='driver'||k==='shared');state.search='';state.scale=1.3;state.pan={x:30,y:-80};state.highlighted.clear();closeActionPanel();},
  recruiter(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=k==='recruiter'||k==='shared');state.search='';state.scale=1.1;state.pan={x:-180,y:40};state.highlighted.clear();closeActionPanel();},
  admin(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=k==='admin'||k==='shared');state.search='';state.scale=1.1;state.pan={x:-700,y:-20};state.highlighted.clear();closeActionPanel();},
  carrier(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=k==='carrier'||k==='shared');state.search='';state.scale=1.1;state.pan={x:-150,y:-380};state.highlighted.clear();closeActionPanel();},
  workflow(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=true);state.search='';state.scale=1.3;state.pan={x:-250,y:-250};state.highlighted.clear();
    ['hub_driver','hub_recruiter','hub_admin','hub_carrier','orchestrator','ai_router','conversation','run_ledger','outcomes','compendium'].forEach(id=>state.highlighted.add(id));closeActionPanel();},
  voice(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=true);state.search='';state.scale=1.2;state.pan={x:-100,y:-550};state.highlighted.clear();
    ['v_service','v_campaign','v_webhook','v_ui','rc_outreach','pipeline','event_bus'].forEach(id=>state.highlighted.add(id));closeActionPanel();},
  selfheal(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=k==='admin'||k==='shared');state.search='';state.scale=1.2;state.pan={x:-600,y:-500};state.highlighted.clear();
    ['ad_observability','ad_portal','selfheal','hub_admin','orchestrator'].forEach(id=>state.highlighted.add(id));closeActionPanel();},
  legacy(){Object.keys(state.surfaces).forEach(k=>state.surfaces[k]=true);state.search='';state.scale=1;state.pan={x:0,y:0};state.highlighted.clear();
    ['orchestrator','ai_router','hub_driver','hub_recruiter','hub_admin','hub_carrier'].forEach(id=>state.highlighted.add(id));closeActionPanel();}
};

// ═══════════════════════ CONTROLS ═══════════════════════
document.querySelectorAll('.preset-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
    state.preset=btn.dataset.preset;PRESETS[state.preset]();syncControls();draw();updatePrompt();
  });
});
document.querySelectorAll('[data-surface]').forEach(cb=>{cb.addEventListener('change',()=>{state.surfaces[cb.dataset.surface]=cb.checked;draw();updatePrompt();});});
document.getElementById('showEdges').addEventListener('change',e=>{state.showEdges=e.target.checked;draw();});
document.getElementById('showLabels').addEventListener('change',e=>{state.showLabels=e.target.checked;draw();});
document.getElementById('showActions').addEventListener('change',e=>{state.showActions=e.target.checked;draw();});
document.getElementById('search').addEventListener('input',e=>{state.search=e.target.value;draw();updatePrompt();});
function syncControls(){document.querySelectorAll('[data-surface]').forEach(cb=>cb.checked=state.surfaces[cb.dataset.surface]);document.getElementById('search').value=state.search;}

// ═══════════════════════ STATS & PROMPT ═══════════════════════
function updateStats(){
  const vr=ROUTERS.filter(isVisible), vs=SERVICES.filter(isVisible);
  const totalActions=vr.reduce((s,r)=>s+r.actions,0);
  const totalApproval=vr.reduce((s,r)=>s+r.approvalActions,0);
  document.getElementById('stats').innerHTML=`<b>${vr.length}</b> routers · <b>${totalActions}</b> actions · <b>${vs.length}</b> services · <b>${totalApproval}</b> approval-gated`;
}

function updatePrompt(){
  const el=document.getElementById('promptOutput');
  if(state.selectedRouter){
    const r=state.selectedRouter, col=r.surface;
    const approvalActions=r.actionList.filter(a=>a.ap).map(a=>a.n);
    let p=`Router: ${r.label} (${r.surface} surface)\n`;
    p+=`${r.actions} actions — ${r.desc}\n\n`;
    p+=`AI sees ONE tool definition with action enum:\n`;
    p+=`  { name: '${r.label}', input: { action: '<enum>', params: {...} } }\n\n`;
    p+=`Actions: ${r.actionList.map(a=>a.n).join(', ')}\n`;
    if(approvalActions.length) p+=`\nApproval-gated: ${approvalActions.join(', ')}`;
    p+=`\n\nDispatch: executeTool('${r.label}', { action, params }) → ACTION_REGISTRY['${r.label}'][action] → serviceModule.serviceFunction(...args)`;
    el.textContent=p;
  } else if(state.highlighted.size>0){
    const nodes=allNodes().filter(n=>state.highlighted.has(n.id));
    const center=nodes.find(n=>n.type==='hub'||n.type==='core')||nodes[0];
    const routers=nodes.filter(n=>n.actionList);
    const totalActions=routers.reduce((s,r)=>s+r.actions,0);
    let p=`"${center.label}" — ${nodes.length} connected nodes\n`;
    if(routers.length) p+=`Routers: ${routers.map(r=>`${r.label}(${r.actions})`).join(', ')}\n`;
    p+=`Total actions reachable: ${totalActions}\n\n`;
    p+=`Data flow: HTML iframe → postMessage → Page Code → agentService.handleAgentTurn(role, userId, msg)\n`;
    p+=`  → buildToolList(role) returns ${routers.length} ROUTER_DEFINITIONS (not ${totalActions} flat schemas)\n`;
    p+=`  → AI picks router + action → executeTool dispatches via ACTION_REGISTRY\n`;
    p+=`  → Result → agentConversationService → agentOutcomeService → response`;
    el.textContent=p;
  } else {
    const vr=ROUTERS.filter(isVisible), totalActions=vr.reduce((s,r)=>s+r.actions,0);
    const bySurface={};vr.forEach(r=>{if(!bySurface[r.surface])bySurface[r.surface]={routers:0,actions:0};bySurface[r.surface].routers++;bySurface[r.surface].actions+=r.actions;});
    let p=`LMDR/VelocityMatch Agentic Architecture — Domain Router Pattern\n`;
    p+=`388 operations collapsed into ${vr.length} domain routers (82-88% token savings)\n\n`;
    Object.entries(bySurface).forEach(([s,d])=>{p+=`  ${s}: ${d.routers} routers → ${d.actions} actions\n`;});
    p+=`\nPattern: AI sees { name: 'router_name', action: '<enum>', params } — NOT 388 flat tool schemas\n`;
    p+=`Dispatch: executeTool → ACTION_REGISTRY[router][action] → per-action policy check → service call\n`;
    p+=`Legacy: 36 existing flat tools coexist via TOOL_DEFINITIONS fallback path\n\n`;
    p+=`Click a router to see its actions. Double-click to clear. Scroll to zoom, drag to pan.`;
    el.textContent=p;
  }
}

document.getElementById('copyBtn').addEventListener('click',()=>{
  navigator.clipboard.writeText(document.getElementById('promptOutput').textContent).then(()=>{
    const b=document.getElementById('copyBtn');b.textContent='Copied!';setTimeout(()=>b.textContent='Copy',1500);
  });
});

resize();updatePrompt();
</script>
</body>
</html>
