<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LMDR Agentic Orchestration Explorer</title>
<style>
  :root {
    --bg: #0f172a; --surface: #1e293b; --surface2: #334155;
    --border: #475569; --text: #e2e8f0; --text-dim: #94a3b8;
    --blue: #3b82f6; --green: #10b981; --red: #ef4444;
    --amber: #f59e0b; --purple: #a78bfa; --pink: #f472b6;
    --cyan: #22d3ee;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

  .layout { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 1fr 200px; height: 100vh; }
  .sidebar { grid-row: 1 / 3; background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 16px; }
  .canvas-area { position: relative; overflow: hidden; background: var(--bg); }
  .prompt-area { background: var(--surface); border-top: 1px solid var(--border); padding: 12px 16px; overflow-y: auto; }

  h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 8px; }
  h1 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }

  .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 16px; }
  .preset-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; text-align: center; transition: all 0.15s; }
  .preset-btn:hover { border-color: var(--blue); color: var(--blue); }
  .preset-btn.active { background: var(--blue); border-color: var(--blue); color: white; }

  .section { margin-bottom: 16px; }
  .layer-toggle { display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; font-size: 12px; }
  .layer-toggle input { accent-color: var(--blue); }
  .layer-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  .conn-toggle { display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; font-size: 12px; }
  .conn-toggle input { accent-color: var(--blue); }
  .conn-line { width: 18px; height: 2px; flex-shrink: 0; }

  .maturity-legend { margin-bottom: 16px; }
  .mat-item { display: flex; align-items: center; gap: 6px; font-size: 11px; padding: 2px 0; color: var(--text-dim); }
  .mat-badge { padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; }

  .comment-list { font-size: 12px; }
  .comment-item { background: var(--surface2); border-radius: 6px; padding: 8px; margin-bottom: 6px; position: relative; }
  .comment-item .target { font-weight: 600; color: var(--blue); font-size: 11px; }
  .comment-item .text { color: var(--text-dim); margin-top: 2px; }
  .comment-item .del { position: absolute; top: 6px; right: 6px; background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 14px; }
  .comment-item .del:hover { color: var(--red); }

  svg { width: 100%; height: 100%; }
  .node-group { cursor: pointer; }
  .node-group:hover rect.node-bg { stroke-width: 2; filter: brightness(1.2); }
  .node-label { font-family: system-ui; font-size: 11px; font-weight: 600; fill: var(--text); pointer-events: none; }
  .node-sublabel { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 8.5px; fill: var(--text-dim); pointer-events: none; }
  .node-maturity { font-family: system-ui; font-size: 8px; font-weight: 700; pointer-events: none; }
  .node-tools { font-family: system-ui; font-size: 8px; fill: var(--text-dim); pointer-events: none; }
  .commented rect.node-bg { stroke: var(--amber) !important; stroke-width: 2.5 !important; }

  .zoom-controls { position: absolute; top: 12px; right: 12px; display: flex; gap: 4px; }
  .zoom-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text); width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
  .zoom-btn:hover { border-color: var(--blue); }

  .prompt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .copy-btn { background: var(--blue); border: none; color: white; padding: 4px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; }
  .copy-btn:hover { opacity: 0.9; }
  .copy-btn.copied { background: var(--green); }
  #prompt-output { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px; color: var(--text-dim); line-height: 1.5; white-space: pre-wrap; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 100; }
  .modal-overlay.show { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; width: 360px; }
  .modal h3 { font-size: 14px; margin-bottom: 4px; }
  .modal .subtitle { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; font-family: monospace; }
  .modal textarea { width: 100%; height: 80px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 8px; font-size: 12px; resize: none; }
  .modal-actions { display: flex; gap: 8px; margin-top: 8px; justify-content: flex-end; }
  .modal-actions button { padding: 4px 14px; border-radius: 4px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 12px; cursor: pointer; }
  .modal-actions .save { background: var(--blue); border-color: var(--blue); }

  .stat-bar { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
  .stat { text-align: center; }
  .stat .num { font-size: 18px; font-weight: 800; color: var(--blue); }
  .stat .lbl { font-size: 9px; color: var(--text-dim); text-transform: uppercase; }

  .detail-panel { position: absolute; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 10px 14px; font-size: 11px; display: none; max-height: 160px; overflow-y: auto; z-index: 10; }
  .detail-panel.show { display: block; }
  .detail-panel h3 { font-size: 13px; margin-bottom: 4px; }
  .detail-panel .close-detail { float: right; background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; }
  .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px; margin-top: 6px; }
  .tool-chip { background: var(--surface2); padding: 3px 8px; border-radius: 4px; font-size: 10px; display: flex; justify-content: space-between; }
  .tool-chip .risk { font-weight: 600; }
  .risk-read { color: var(--green); } .risk-suggest { color: var(--cyan); }
  .risk-execute_low { color: var(--amber); } .risk-execute_high { color: var(--red); }
</style>
</head>
<body>
<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h1>Agentic Orchestration Explorer</h1>

    <div class="stat-bar">
      <div class="stat"><div class="num" id="stat-agents">4</div><div class="lbl">Live Agents</div></div>
      <div class="stat"><div class="num" id="stat-tools">36</div><div class="lbl">Tools</div></div>
      <div class="stat"><div class="num" id="stat-services">18</div><div class="lbl">Services</div></div>
      <div class="stat"><div class="num" id="stat-planned">11</div><div class="lbl">Planned</div></div>
    </div>

    <div class="section">
      <h2>View Presets</h2>
      <div class="preset-grid" id="presets"></div>
    </div>

    <div class="section">
      <h2>Layers</h2>
      <div id="layer-toggles"></div>
    </div>

    <div class="section">
      <h2>Connections</h2>
      <div id="conn-toggles"></div>
    </div>

    <div class="section">
      <h2>Maturity</h2>
      <div class="maturity-legend">
        <div class="mat-item"><span class="mat-badge" style="background:#10b981;color:#000">PROD</span> Production-ready</div>
        <div class="mat-item"><span class="mat-badge" style="background:#3b82f6;color:#fff">IMPL</span> Implemented, minor gaps</div>
        <div class="mat-item"><span class="mat-badge" style="background:#f59e0b;color:#000">PARTIAL</span> Scaffolded, not complete</div>
        <div class="mat-item"><span class="mat-badge" style="background:#ef4444;color:#fff">STUB</span> Console.log / placeholder</div>
        <div class="mat-item"><span class="mat-badge" style="background:#6b7280;color:#fff">PLANNED</span> Blueprint only</div>
      </div>
    </div>

    <div class="section">
      <h2>Comments (<span id="comment-count">0</span>)</h2>
      <div class="comment-list" id="comments"></div>
    </div>
  </div>

  <!-- CANVAS -->
  <div class="canvas-area">
    <svg id="canvas" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoom(1.2)">+</button>
      <button class="zoom-btn" onclick="zoom(1/1.2)">−</button>
      <button class="zoom-btn" onclick="resetZoom()">⌂</button>
    </div>
    <div class="detail-panel" id="detail-panel">
      <button class="close-detail" onclick="closeDetail()">×</button>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- PROMPT -->
  <div class="prompt-area">
    <div class="prompt-header">
      <h2>Generated Prompt</h2>
      <button class="copy-btn" id="copy-btn" onclick="copyPrompt()">Copy</button>
    </div>
    <div id="prompt-output"></div>
  </div>
</div>

<!-- COMMENT MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <div class="subtitle" id="modal-subtitle"></div>
    <textarea id="modal-text" placeholder="Add feedback, questions, or instructions for this component..."></textarea>
    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="save" onclick="saveComment()">Save</button>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════════
const MATURITY = { PROD: 'PROD', IMPL: 'IMPL', PARTIAL: 'PARTIAL', STUB: 'STUB', PLANNED: 'PLANNED' };
const MAT_COLORS = { PROD: '#10b981', IMPL: '#3b82f6', PARTIAL: '#f59e0b', STUB: '#ef4444', PLANNED: '#6b7280' };

const LAYERS = {
  ui:       { label: 'UI Overlays (HTML/JS)',   color: '#dbeafe' },
  page:     { label: 'Page Code (Wix Velo)',    color: '#fef3c7' },
  orch:     { label: 'Orchestration Engine',    color: '#dcfce7' },
  services: { label: 'Backend Services',        color: '#f3e8ff' },
  data:     { label: 'Data & Persistence',      color: '#fce7f3' },
  infra:    { label: 'Infrastructure (AI/Voice)',color: '#e0f2fe' },
  planned:  { label: 'Planned Agents (Blueprint)', color: '#374151' },
};

const CONN_TYPES = {
  postmsg:  { label: 'postMessage',   color: '#3b82f6', dash: '' },
  toolcall: { label: 'Tool Dispatch', color: '#10b981', dash: '6,3' },
  data:     { label: 'Data Flow',     color: '#a78bfa', dash: '4,4' },
  voice:    { label: 'Voice/VAPI',    color: '#f472b6', dash: '8,4' },
  planned:  { label: 'Planned Link',  color: '#6b7280', dash: '2,2' },
};

// ── NODES ──
const nodes = [
  // UI Layer (y: 20-60)
  { id: 'driver-ui', label: 'Driver Agent UI', subtitle: 'driver/js/ai-matching-agent.js', x: 60, y: 30, w: 160, h: 50, layer: 'ui', maturity: MATURITY.IMPL, role: 'driver',
    detail: 'LMDR-branded floating chat FAB + sliding panel. Sends agentMessage, handles agentResponse and agentApprovalRequired. Voice orb integration. Missing: agentToolResult display.' },
  { id: 'recruiter-ui', label: 'Recruiter Chat (ROS)', subtitle: 'recruiter/os/js/ros-chat.js', x: 260, y: 30, w: 160, h: 50, layer: 'ui', maturity: MATURITY.IMPL, role: 'recruiter',
    detail: 'Dual-mode: local keyword routing (INTENT_MAP) when NLU_ENABLED=false, agent orchestration when true. Uses {type: "recruiterOS"} envelope.' },
  { id: 'admin-ui', label: 'Admin Agent UI', subtitle: 'admin/js/admin-agent.js', x: 460, y: 30, w: 160, h: 50, layer: 'ui', maturity: MATURITY.PROD, role: 'admin',
    detail: 'VelocityMatch-branded. Origin validation on messages. Approval gate cards wired. decidedBy: "admin".' },
  { id: 'b2b-ui', label: 'B2B Agent UI', subtitle: 'admin/js/b2b-agent.js', x: 660, y: 30, w: 160, h: 50, layer: 'ui', maturity: MATURITY.PROD, role: 'carrier',
    detail: 'VelocityMatch-branded. Near-copy of admin-agent with different IDs. Minor: gateId not displayed in approval card.' },
  { id: 'voice-ui', label: 'Voice Orb (shared)', subtitle: 'js/voice-agent-ui.js', x: 860, y: 30, w: 150, h: 50, layer: 'ui', maturity: MATURITY.PROD, role: 'shared',
    detail: 'Reusable VAPI Web SDK component. State machine: idle→connecting→active→ending. Transcript panel, duration timer. Loaded into any surface.' },
  { id: 'kpis-ui', label: 'Agent KPI Card', subtitle: 'admin/js/admin-agent-kpis.js', x: 460, y: 90, w: 140, h: 40, layer: 'ui', maturity: MATURITY.PROD, role: 'admin',
    detail: 'Display-only KPI card: total runs, success rate, quality score, partial rate, failure rate. Color-coded thresholds.' },

  // Page Code Layer (y: 150-190)
  { id: 'driver-page', label: 'AI Matching Page', subtitle: 'pages/AI - Matching.rof4w.js', x: 60, y: 160, w: 160, h: 50, layer: 'page', maturity: MATURITY.PROD, role: 'driver',
    detail: '19 inbound + 21 outbound message types. userId from driver profile. MESSAGE_REGISTRY validated at runtime. Voice config wired.' },
  { id: 'recruiter-page', label: 'Recruiter Console', subtitle: 'pages/Recruiter Console.zriuj.js', x: 260, y: 160, w: 160, h: 50, layer: 'page', maturity: MATURITY.PROD, role: 'recruiter',
    detail: '50+ message types each direction. Uses {type,data,timestamp} envelope. Full campaign management wired. carrierDot in agent context.' },
  { id: 'admin-page', label: 'Admin Dashboard', subtitle: 'pages/ADMIN_DASHBOARD.svo6l.js', x: 460, y: 160, w: 160, h: 50, layer: 'page', maturity: MATURITY.IMPL, role: 'admin',
    detail: 'Hardcoded userId "admin-user" — no per-user identity. safeSend() wrapper. Multi-component discovery (html1-html5).' },
  { id: 'b2b-page', label: 'B2B Dashboard', subtitle: 'pages/B2B_DASHBOARD.i5csc.js', x: 660, y: 160, w: 160, h: 50, layer: 'page', maturity: MATURITY.IMPL, role: 'carrier',
    detail: 'Hardcoded userId "b2b-user". Direct component.postMessage (no safeSend). All other actions route through handleB2BAction bridge.' },

  // Orchestration Layer (y: 280-340)
  { id: 'agent-svc', label: 'Agent Orchestration', subtitle: 'backend/agentService.jsw', x: 300, y: 290, w: 200, h: 60, layer: 'orch', maturity: MATURITY.PROD, role: 'core',
    detail: '1,133 lines. 4 roles, 36 tools. 5-iteration loop, 30s timeout, 100 runs/user/day. Approval gating on execute_high tools. BUG: Object.values() positional arg spread is fragile. costAlertThreshold not wired.',
    tools: [
      { name: 'find_matches', role: 'driver', risk: 'read' }, { name: 'get_carrier_details', role: 'driver', risk: 'read' },
      { name: 'explain_match', role: 'driver', risk: 'suggest' }, { name: 'get_fmcsa_data', role: 'driver', risk: 'read' },
      { name: 'road_conditions', role: 'driver', risk: 'read' }, { name: 'find_parking', role: 'driver', risk: 'read' },
      { name: 'search_drivers', role: 'recruiter', risk: 'read' }, { name: 'get_pipeline', role: 'recruiter', risk: 'read' },
      { name: 'update_candidate_status', role: 'recruiter', risk: 'execute_low' }, { name: 'send_message', role: 'recruiter', risk: 'execute_high' },
      { name: 'schedule_interview', role: 'recruiter', risk: 'execute_high' }, { name: 'log_call', role: 'recruiter', risk: 'execute_low' },
      { name: 'get_recruiter_analytics', role: 'recruiter', risk: 'read' }, { name: 'start_autopilot', role: 'recruiter', risk: 'execute_high' },
      { name: 'get_autopilot_status', role: 'recruiter', risk: 'read' },
      { name: 'get_system_health', role: 'admin', risk: 'read' }, { name: 'get_driver_stats', role: 'admin', risk: 'read' },
      { name: 'manage_prompts', role: 'admin', risk: 'execute_high' }, { name: 'get_agent_kpis', role: 'admin', risk: 'read' },
      { name: 'run_curator', role: 'admin', risk: 'execute_low' }, { name: 'detect_anomalies', role: 'admin', risk: 'read' },
      { name: 'propose_fix', role: 'admin', risk: 'execute_low' }, { name: 'execute_fix', role: 'admin', risk: 'execute_high' },
      { name: 'get_account', role: 'carrier', risk: 'read' }, { name: 'get_signals', role: 'carrier', risk: 'read' },
      { name: 'get_opportunities', role: 'carrier', risk: 'read' }, { name: 'get_hiring_benchmarks', role: 'carrier', risk: 'read' },
      { name: 'get_conversion_insights', role: 'carrier', risk: 'read' },
      { name: 'get_market_intel', role: 'recruiter', risk: 'read' }, { name: 'get_lane_demand', role: 'recruiter', risk: 'read' },
      { name: 'get_compensation_benchmarks', role: 'recruiter', risk: 'read' },
      { name: 'get_hiring_benchmarks_r', role: 'recruiter', risk: 'read' }, { name: 'get_conversion_insights_r', role: 'recruiter', risk: 'read' },
    ] },
  { id: 'conv-svc', label: 'Conversation Service', subtitle: 'backend/agentConversationService.jsw', x: 100, y: 310, w: 170, h: 45, layer: 'orch', maturity: MATURITY.IMPL, role: 'core',
    detail: 'Persists conversations + turns to Airtable. Max 20 turns context window. BUG: turnCount never incremented after create.' },
  { id: 'ledger-svc', label: 'Run Ledger', subtitle: 'backend/agentRunLedgerService.jsw', x: 550, y: 290, w: 160, h: 45, layer: 'orch', maturity: MATURITY.IMPL, role: 'core',
    detail: 'Immutable append-only log: agentRuns, agentSteps, approvalGates, runOutcomes. BUG: total_cost_usd always 0. Missing export: logAgentAction (called by autopilot, silently fails).' },
  { id: 'outcome-svc', label: 'Outcome Evaluator', subtitle: 'backend/agentOutcomeService.jsw', x: 550, y: 345, w: 160, h: 45, layer: 'orch', maturity: MATURITY.IMPL, role: 'core',
    detail: 'Heuristic scoring: base 50, +/- for errors, engagement, gates, productive steps. BUG: checkFollowUpMessage queries conversation_id (snake) but field is conversationId (camel) — bonus always false.' },

  // Backend Services (y: 440-520)
  { id: 'ai-router', label: 'AI Router', subtitle: 'backend/aiRouterService.jsw', x: 300, y: 440, w: 180, h: 50, layer: 'infra', maturity: MATURITY.PROD, role: 'core',
    detail: '7 providers (Anthropic, OpenAI, Groq, Perplexity, Google, Mistral, Cohere). 12 function categories. Cost optimizer (disabled by default). RISK: Only Anthropic returns contentBlocks/stopReason — other providers break tool_use silently.' },
  { id: 'autopilot', label: 'Recruiter Autopilot', subtitle: 'backend/autopilotService.jsw', x: 60, y: 450, w: 170, h: 50, layer: 'services', maturity: MATURITY.PARTIAL, role: 'recruiter',
    detail: 'Campaign creation + step execution + approval gates for SEND_MESSAGE. BUG: start_autopilot tool passes (carrier_dot, objective) but service expects (recruiterId, config). VOICE_CALL steps scaffolded but never created.' },
  { id: 'self-heal', label: 'Self-Healing Engine', subtitle: 'backend/selfHealingService.jsw', x: 540, y: 450, w: 170, h: 50, layer: 'services', maturity: MATURITY.STUB, role: 'admin',
    detail: 'Detection + triage + proposal + verification pipeline is real. BUT: _executeAction is 7/8 console.log stubs. Only clear_cache actually calls a service. Remediation is a no-op.' },
  { id: 'cross-intel', label: 'Cross-Role Intelligence', subtitle: 'backend/crossRoleIntelService.jsw', x: 300, y: 510, w: 180, h: 45, layer: 'services', maturity: MATURITY.IMPL, role: 'shared',
    detail: '5 functions: getMarketIntel, getLaneDemand, getCompensationBenchmarks, getHiringBenchmarks, getConversionInsights. Real aggregation with percentile math. Depends on populated Airtable data.' },
  { id: 'compendium', label: 'Compendium / Curator', subtitle: 'backend/compendiumService.jsw', x: 740, y: 450, w: 160, h: 50, layer: 'services', maturity: MATURITY.IMPL, role: 'admin',
    detail: 'Knowledge curator: mines run outcomes for patterns, detects regressions, records tool combos. Sharding detection only (no split). No scheduled job in jobs.config.' },
  { id: 'voice-svc', label: 'Voice Service (VAPI)', subtitle: 'backend/voiceService.jsw', x: 860, y: 290, w: 150, h: 45, layer: 'infra', maturity: MATURITY.PROD, role: 'shared',
    detail: 'VAPI REST wrapper: createAssistant, initiateOutboundCall, getCallTranscript, listCalls. Webhooks at /api/vapi-webhook.' },
  { id: 'voice-campaign', label: 'Voice Campaigns', subtitle: 'backend/voiceCampaignService.jsw', x: 860, y: 350, w: 150, h: 45, layer: 'infra', maturity: MATURITY.IMPL, role: 'recruiter',
    detail: 'Campaign CRUD + contact management. createCampaign, startCampaign, getCampaignStatus. Wired to Recruiter Console page code.' },

  // Data Layer (y: 600-640)
  { id: 'airtable', label: 'Airtable (65+ tables)', subtitle: 'Last Mile Driver recruiting base', x: 200, y: 600, w: 200, h: 45, layer: 'data', maturity: MATURITY.PROD, role: 'core',
    detail: 'Agent tables: agentConversations, agentTurns, agentRuns, agentSteps, approvalGates, runOutcomes, voiceCallLogs, voiceAssistants, voiceCampaigns, voiceCampaignContacts.' },
  { id: 'wix-data', label: 'Wix Collections', subtitle: 'AdminUsers, MemberNotifications', x: 500, y: 600, w: 180, h: 45, layer: 'data', maturity: MATURITY.PROD, role: 'core',
    detail: 'Auth-only data stays in Wix. AdminUsers, MemberNotifications, memberBadges, memberPrivateData. Everything else routes to Airtable.' },
  { id: 'compendium-files', label: 'Compendium Files', subtitle: 'Compendium/{role}/INDEX.md', x: 740, y: 600, w: 170, h: 45, layer: 'data', maturity: MATURITY.IMPL, role: 'admin',
    detail: 'Git-backed knowledge: recruiter, carrier, driver, admin, dev folders. Playbooks, patterns, postmortems. Curator writes here.' },

  // Planned Agents (y: 700-780)
  { id: 'p-intake', label: '1. Intake & Qualification', subtitle: 'PLANNED — Blueprint', x: 30, y: 700, w: 155, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Triage applicants, normalize profiles, classify qualification. Target: 95% intake completeness, <15 min to qualified.' },
  { id: 'p-match', label: '2. Match Strategy', subtitle: 'PLANNED — Blueprint', x: 195, y: 700, w: 140, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Optimal carrier/job selection per driver. Ranked matches with confidence + rationale. Continuous reranking.' },
  { id: 'p-pipeline', label: '3. Pipeline Execution', subtitle: 'PLANNED — Priority #1', x: 345, y: 700, w: 150, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Full outreach cadence + stage progression. Contact SLA <5 min. Multi-channel sequences. PRIORITY #1 in blueprint.' },
  { id: 'p-offer', label: '4. Offer Guardrail', subtitle: 'PLANNED — Blueprint', x: 505, y: 700, w: 140, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Compensation guardrails, policy compliance. Offer turnaround <30 min. Mandatory human approval for final offers.' },
  { id: 'p-onboard', label: '5. Onboarding Orchestration', subtitle: 'PLANNED — Blueprint', x: 655, y: 700, w: 170, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Post-acceptance to day-1 readiness. Docs, background checks, drug tests, orientation. 40% cycle time reduction target.' },
  { id: 'p-retention', label: '6. Retention Risk', subtitle: 'PLANNED — Blueprint', x: 835, y: 700, w: 140, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Churn risk detection from engagement, safety, pay, home-time, sentiment. Trigger intervention plays.' },
  { id: 'p-intervention', label: '7. Intervention Exec', subtitle: 'PLANNED — Blueprint', x: 30, y: 750, w: 155, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Deploy personalized save actions. Template selection, multi-channel send, outcome tracking. SLA <10 min.' },
  { id: 'p-coach', label: '8. Recruiter Coach', subtitle: 'PLANNED — Blueprint', x: 195, y: 750, w: 140, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Proactive recruiter recommendations: daily priorities, message rewrites, cadence changes, cohort benchmarking.' },
  { id: 'p-carrier', label: '9. Carrier Success', subtitle: 'PLANNED — Blueprint', x: 345, y: 750, w: 150, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Carrier-side staffing outcomes. Fill rates, account churn risk, capacity gap forecasting, next-best-actions.' },
  { id: 'p-compliance', label: '10. Compliance Sentinel', subtitle: 'PLANNED — Blueprint', x: 505, y: 750, w: 160, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Preflight-check all agent actions. Block non-compliant actions. Machine-readable audit entries. Near-zero violations.' },
  { id: 'p-curator', label: '11. Knowledge Curator v2', subtitle: 'PLANNED — Blueprint', x: 680, y: 750, w: 165, h: 40, layer: 'planned', maturity: MATURITY.PLANNED, role: 'planned',
    detail: 'Mine outcomes for patterns. Propose prompt/rule/workflow updates. Confidence-tiered rollouts. Extends existing compendiumService.' },
];

// ── CONNECTIONS ──
const connections = [
  // UI -> Page (postMessage)
  { from: 'driver-ui', to: 'driver-page', type: 'postmsg', label: 'agentMessage' },
  { from: 'recruiter-ui', to: 'recruiter-page', type: 'postmsg', label: 'agentMessage' },
  { from: 'admin-ui', to: 'admin-page', type: 'postmsg', label: 'agentMessage' },
  { from: 'b2b-ui', to: 'b2b-page', type: 'postmsg', label: 'agentMessage' },
  { from: 'voice-ui', to: 'driver-page', type: 'voice', label: 'voiceCallStarted' },
  { from: 'voice-ui', to: 'recruiter-page', type: 'voice', label: 'voiceCallStarted' },
  { from: 'kpis-ui', to: 'admin-page', type: 'postmsg', label: 'getAgentKpis' },

  // Page -> Orchestration
  { from: 'driver-page', to: 'agent-svc', type: 'toolcall', label: 'handleAgentTurn("driver")' },
  { from: 'recruiter-page', to: 'agent-svc', type: 'toolcall', label: 'handleAgentTurn("recruiter")' },
  { from: 'admin-page', to: 'agent-svc', type: 'toolcall', label: 'handleAgentTurn("admin")' },
  { from: 'b2b-page', to: 'agent-svc', type: 'toolcall', label: 'handleAgentTurn("carrier")' },

  // Orchestration internal
  { from: 'agent-svc', to: 'conv-svc', type: 'data', label: 'createConversation / addTurn' },
  { from: 'agent-svc', to: 'ledger-svc', type: 'data', label: 'startRun / logStep' },
  { from: 'agent-svc', to: 'outcome-svc', type: 'data', label: 'evaluateRun' },
  { from: 'agent-svc', to: 'ai-router', type: 'toolcall', label: 'routeAIRequest("agent_orchestration")' },

  // Orchestration -> Services (tool dispatch)
  { from: 'agent-svc', to: 'autopilot', type: 'toolcall', label: 'start_autopilot' },
  { from: 'agent-svc', to: 'self-heal', type: 'toolcall', label: 'detect_anomalies / execute_fix' },
  { from: 'agent-svc', to: 'cross-intel', type: 'toolcall', label: 'get_market_intel / get_lane_demand' },
  { from: 'agent-svc', to: 'compendium', type: 'toolcall', label: 'run_curator' },

  // Services -> Data
  { from: 'conv-svc', to: 'airtable', type: 'data', label: 'agentConversations / agentTurns' },
  { from: 'ledger-svc', to: 'airtable', type: 'data', label: 'agentRuns / agentSteps / approvalGates' },
  { from: 'outcome-svc', to: 'airtable', type: 'data', label: 'runOutcomes' },
  { from: 'autopilot', to: 'airtable', type: 'data', label: 'autopilotCampaigns' },
  { from: 'cross-intel', to: 'airtable', type: 'data', label: 'b2bMatchSignals / competitorIntel' },
  { from: 'compendium', to: 'compendium-files', type: 'data', label: 'git write' },
  { from: 'voice-svc', to: 'airtable', type: 'data', label: 'voiceCallLogs' },
  { from: 'voice-campaign', to: 'airtable', type: 'data', label: 'voiceCampaigns' },
  { from: 'agent-svc', to: 'wix-data', type: 'data', label: 'AdminUsers (auth)' },

  // Voice
  { from: 'recruiter-page', to: 'voice-campaign', type: 'voice', label: 'createCampaign / startCampaign' },
  { from: 'voice-svc', to: 'ai-router', type: 'toolcall', label: 'voice assistant config' },

  // Planned links
  { from: 'p-pipeline', to: 'agent-svc', type: 'planned', label: 'future tool registry' },
  { from: 'p-retention', to: 'agent-svc', type: 'planned', label: 'future tool registry' },
  { from: 'p-compliance', to: 'ledger-svc', type: 'planned', label: 'preflight gate' },
  { from: 'p-curator', to: 'compendium', type: 'planned', label: 'extends curator' },
];

const state = {
  preset: 'full',
  layers: Object.fromEntries(Object.keys(LAYERS).map(k => [k, true])),
  conns: Object.fromEntries(Object.keys(CONN_TYPES).map(k => [k, true])),
  comments: [],
  zoom: 1,
  pan: { x: 0, y: 0 },
  modalNode: null,
  selectedNode: null,
};

const PRESETS = {
  full:     { label: 'Full System', layers: Object.fromEntries(Object.keys(LAYERS).map(k => [k, true])), conns: Object.fromEntries(Object.keys(CONN_TYPES).map(k => [k, true])) },
  live:     { label: 'Live Agents Only', layers: { ui: true, page: true, orch: true, services: true, data: true, infra: true, planned: false }, conns: { postmsg: true, toolcall: true, data: true, voice: true, planned: false } },
  driver:   { label: 'Driver Flow', layers: { ui: true, page: true, orch: true, services: false, data: true, infra: true, planned: false }, conns: { postmsg: true, toolcall: true, data: true, voice: true, planned: false } },
  recruiter:{ label: 'Recruiter Flow', layers: { ui: true, page: true, orch: true, services: true, data: true, infra: true, planned: false }, conns: { postmsg: true, toolcall: true, data: true, voice: true, planned: false } },
  blueprint:{ label: 'Blueprint (Planned)', layers: { ui: false, page: false, orch: true, services: true, data: false, infra: false, planned: true }, conns: { postmsg: false, toolcall: true, data: false, voice: false, planned: true } },
  bugs:     { label: 'Known Bugs', layers: { ui: true, page: true, orch: true, services: true, data: false, infra: true, planned: false }, conns: { postmsg: false, toolcall: true, data: false, voice: false, planned: false } },
};

// Role filtering for presets
function shouldShowNode(n) {
  if (!state.layers[n.layer]) return false;
  if (state.preset === 'driver' && !['driver', 'core', 'shared'].includes(n.role)) return false;
  if (state.preset === 'recruiter' && !['recruiter', 'core', 'shared'].includes(n.role)) return false;
  if (state.preset === 'bugs') {
    return n.detail && (n.detail.includes('BUG') || n.detail.includes('STUB') || n.detail.includes('Missing') || n.detail.includes('Hardcoded'));
  }
  return true;
}

// ══════════════════════════════════════════════════════════════
// RENDER
// ══════════════════════════════════════════════════════════════
function renderControls() {
  // Presets
  const pg = document.getElementById('presets');
  pg.innerHTML = Object.entries(PRESETS).map(([k, v]) =>
    `<button class="preset-btn ${state.preset === k ? 'active' : ''}" onclick="applyPreset('${k}')">${v.label}</button>`
  ).join('');

  // Layers
  const lt = document.getElementById('layer-toggles');
  lt.innerHTML = Object.entries(LAYERS).map(([k, v]) =>
    `<label class="layer-toggle"><input type="checkbox" ${state.layers[k] ? 'checked' : ''} onchange="toggleLayer('${k}', this.checked)"/><span class="layer-dot" style="background:${v.color}"></span>${v.label}</label>`
  ).join('');

  // Connections
  const ct = document.getElementById('conn-toggles');
  ct.innerHTML = Object.entries(CONN_TYPES).map(([k, v]) =>
    `<label class="conn-toggle"><input type="checkbox" ${state.conns[k] ? 'checked' : ''} onchange="toggleConn('${k}', this.checked)"/><span class="conn-line" style="background:${v.color}"></span>${v.label}</label>`
  ).join('');
}

function renderDiagram() {
  const svg = document.getElementById('canvas');
  const visibleNodes = nodes.filter(shouldShowNode);
  const visibleIds = new Set(visibleNodes.map(n => n.id));
  const visibleConns = connections.filter(c =>
    state.conns[c.type] && visibleIds.has(c.from) && visibleIds.has(c.to)
  );

  // Markers
  let html = '<defs>';
  Object.entries(CONN_TYPES).forEach(([k, v]) => {
    html += `<marker id="arr-${k}" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="${v.color}"/></marker>`;
  });
  html += '</defs>';

  // Transform group
  html += `<g transform="translate(${state.pan.x},${state.pan.y}) scale(${state.zoom})">`;

  // Layer bands
  const bands = [
    { y: 10, h: 120, label: 'UI Overlays', color: LAYERS.ui.color },
    { y: 140, h: 100, label: 'Page Code (Wix Velo)', color: LAYERS.page.color },
    { y: 260, h: 140, label: 'Orchestration Engine', color: LAYERS.orch.color },
    { y: 420, h: 150, label: 'Backend Services & Infra', color: LAYERS.services.color },
    { y: 580, h: 80, label: 'Data & Persistence', color: LAYERS.data.color },
    { y: 680, h: 130, label: 'Planned Agents (Blueprint)', color: LAYERS.planned.color },
  ];
  bands.forEach(b => {
    html += `<rect x="10" y="${b.y}" width="1020" height="${b.h}" rx="6" fill="${b.color}" opacity="0.04" stroke="${b.color}" stroke-opacity="0.12"/>`;
    html += `<text x="20" y="${b.y + 14}" font-size="9" fill="${b.color}" opacity="0.5" font-family="system-ui">${b.label}</text>`;
  });

  // Connections
  visibleConns.forEach(c => {
    const from = nodes.find(n => n.id === c.from);
    const to = nodes.find(n => n.id === c.to);
    const x1 = from.x + from.w / 2, y1 = from.y + from.h;
    const x2 = to.x + to.w / 2, y2 = to.y;
    const ct = CONN_TYPES[c.type];
    const mid = (y1 + y2) / 2;
    html += `<path d="M${x1},${y1} C${x1},${mid} ${x2},${mid} ${x2},${y2}" fill="none" stroke="${ct.color}" stroke-width="1.5" stroke-dasharray="${ct.dash}" marker-end="url(#arr-${c.type})" opacity="0.7"/>`;
    if (c.label) {
      const lx = (x1 + x2) / 2 + (x1 === x2 ? 0 : (x2 > x1 ? 8 : -8));
      const ly = mid - 3;
      html += `<text x="${lx}" y="${ly}" font-size="7.5" fill="${ct.color}" opacity="0.7" font-family="SF Mono,Fira Code,monospace" text-anchor="middle">${c.label}</text>`;
    }
  });

  // Nodes
  visibleNodes.forEach(n => {
    const hasComment = state.comments.some(c => c.target === n.id);
    const mc = MAT_COLORS[n.maturity];
    html += `<g class="node-group ${hasComment ? 'commented' : ''}" onclick="nodeClick('${n.id}')">`;
    html += `<rect class="node-bg" x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="6" fill="${LAYERS[n.layer].color}" fill-opacity="0.15" stroke="${mc}" stroke-width="1.5"/>`;
    html += `<text class="node-label" x="${n.x + 8}" y="${n.y + 16}">${n.label}</text>`;
    html += `<text class="node-sublabel" x="${n.x + 8}" y="${n.y + 28}">${n.subtitle}</text>`;
    // Maturity badge
    html += `<rect x="${n.x + n.w - 38}" y="${n.y + 4}" width="34" height="13" rx="3" fill="${mc}"/>`;
    html += `<text class="node-maturity" x="${n.x + n.w - 21}" y="${n.y + 13}" text-anchor="middle" fill="${n.maturity === 'PARTIAL' || n.maturity === 'PROD' ? '#000' : '#fff'}">${n.maturity}</text>`;
    // Tool count for orch nodes
    if (n.tools) {
      html += `<text class="node-tools" x="${n.x + 8}" y="${n.y + n.h - 6}">${n.tools.length} tools registered</text>`;
    }
    html += '</g>';
  });

  html += '</g>';
  svg.innerHTML = html;
}

function renderComments() {
  const el = document.getElementById('comments');
  document.getElementById('comment-count').textContent = state.comments.length;
  if (!state.comments.length) { el.innerHTML = '<div style="font-size:11px;color:var(--text-dim)">Click any node to add a comment.</div>'; return; }
  el.innerHTML = state.comments.map((c, i) =>
    `<div class="comment-item"><span class="target">${c.targetLabel}</span><button class="del" onclick="deleteComment(${i})">×</button><div class="text">${c.text}</div></div>`
  ).join('');
}

function updatePrompt() {
  const parts = [];
  const visibleNodes = nodes.filter(shouldShowNode);
  const liveCount = visibleNodes.filter(n => n.maturity !== MATURITY.PLANNED).length;
  const plannedCount = visibleNodes.filter(n => n.maturity === MATURITY.PLANNED).length;
  const stubCount = visibleNodes.filter(n => n.maturity === MATURITY.STUB || n.maturity === MATURITY.PARTIAL).length;

  parts.push(`I'm reviewing the LMDR/VelocityMatch agentic orchestration layer.`);
  if (state.preset !== 'full') parts.push(`Currently viewing: ${PRESETS[state.preset].label}.`);
  parts.push(`Visible: ${liveCount} live components, ${plannedCount} planned agents, ${stubCount} with gaps.`);
  parts.push('');

  // Maturity summary
  const byMat = {};
  visibleNodes.forEach(n => { byMat[n.maturity] = byMat[n.maturity] || []; byMat[n.maturity].push(n.label); });
  Object.entries(byMat).forEach(([m, items]) => {
    parts.push(`**${m}:** ${items.join(', ')}`);
  });

  // Known bugs for visible nodes
  const bugNodes = visibleNodes.filter(n => n.detail && (n.detail.includes('BUG') || n.detail.includes('Missing export') || n.detail.includes('Hardcoded')));
  if (bugNodes.length) {
    parts.push('');
    parts.push('**Known issues in visible components:**');
    bugNodes.forEach(n => {
      const bugs = n.detail.match(/BUG:[^.]+\.|Missing[^.]+\.|Hardcoded[^.]+\./g) || [n.detail.substring(n.detail.indexOf('BUG'), n.detail.indexOf('BUG') + 80)];
      bugs.forEach(b => parts.push(`- ${n.label}: ${b.trim()}`));
    });
  }

  // User comments
  if (state.comments.length) {
    parts.push('');
    parts.push('**My feedback on specific components:**');
    state.comments.forEach(c => {
      parts.push(`\n**${c.targetLabel}** (${c.targetFile}):\n${c.text}`);
    });
  }

  document.getElementById('prompt-output').textContent = parts.join('\n');
}

function updateAll() { renderControls(); renderDiagram(); renderComments(); updatePrompt(); }

// ══════════════════════════════════════════════════════════════
// INTERACTIONS
// ══════════════════════════════════════════════════════════════
function applyPreset(key) {
  state.preset = key;
  const p = PRESETS[key];
  Object.assign(state.layers, p.layers);
  Object.assign(state.conns, p.conns);
  closeDetail();
  updateAll();
}

function toggleLayer(key, val) { state.layers[key] = val; state.preset = 'full'; updateAll(); }
function toggleConn(key, val) { state.conns[key] = val; updateAll(); }

function zoom(factor) {
  state.zoom = Math.max(0.3, Math.min(3, state.zoom * factor));
  renderDiagram();
}
function resetZoom() { state.zoom = 1; state.pan = { x: 0, y: 0 }; renderDiagram(); }

function nodeClick(id) {
  const n = nodes.find(x => x.id === id);
  if (!n) return;
  state.selectedNode = id;
  showDetail(n);
}

function showDetail(n) {
  const panel = document.getElementById('detail-panel');
  const content = document.getElementById('detail-content');
  let html = `<h3>${n.label} <span style="font-size:11px;color:${MAT_COLORS[n.maturity]}">[${n.maturity}]</span></h3>`;
  html += `<div style="color:var(--text-dim);margin-bottom:6px;font-family:monospace;font-size:10px">${n.subtitle}</div>`;
  html += `<div style="margin-bottom:8px">${n.detail || 'No details available.'}</div>`;

  if (n.tools && n.tools.length) {
    html += '<div class="tool-grid">';
    n.tools.forEach(t => {
      html += `<div class="tool-chip"><span>${t.name}</span><span class="risk risk-${t.risk}">${t.risk}</span></div>`;
    });
    html += '</div>';
  }

  html += `<button style="margin-top:8px;padding:3px 10px;border-radius:4px;border:1px solid var(--amber);background:transparent;color:var(--amber);font-size:11px;cursor:pointer" onclick="openModal('${n.id}')">Add Comment</button>`;
  content.innerHTML = html;
  panel.classList.add('show');
}

function closeDetail() { document.getElementById('detail-panel').classList.remove('show'); }

function openModal(id) {
  const n = nodes.find(x => x.id === id);
  state.modalNode = n;
  document.getElementById('modal-title').textContent = n.label;
  document.getElementById('modal-subtitle').textContent = n.subtitle;
  document.getElementById('modal-text').value = '';
  document.getElementById('modal').classList.add('show');
  setTimeout(() => document.getElementById('modal-text').focus(), 100);
}

function closeModal() { document.getElementById('modal').classList.remove('show'); state.modalNode = null; }

function saveComment() {
  const text = document.getElementById('modal-text').value.trim();
  if (!text || !state.modalNode) return;
  state.comments.push({ id: Date.now(), target: state.modalNode.id, targetLabel: state.modalNode.label, targetFile: state.modalNode.subtitle, text });
  closeModal();
  updateAll();
}

function deleteComment(i) { state.comments.splice(i, 1); updateAll(); }

function copyPrompt() {
  const text = document.getElementById('prompt-output').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
  });
}

// Pan support
let isPanning = false, panStart = {};
const canvas = document.querySelector('.canvas-area');
canvas.addEventListener('mousedown', e => { if (e.target.closest('.node-group') || e.target.closest('.zoom-controls') || e.target.closest('.detail-panel')) return; isPanning = true; panStart = { x: e.clientX - state.pan.x, y: e.clientY - state.pan.y }; canvas.style.cursor = 'grabbing'; });
window.addEventListener('mousemove', e => { if (!isPanning) return; state.pan.x = e.clientX - panStart.x; state.pan.y = e.clientY - panStart.y; renderDiagram(); });
window.addEventListener('mouseup', () => { isPanning = false; canvas.style.cursor = ''; });
canvas.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY < 0 ? 1.08 : 1/1.08); }, { passive: false });

// Init
updateAll();
</script>
</body>
</html>
